{"version":3,"sources":["Math/Vector4.ts","GpuUtil/Computation.ts","GpuUtil/Glsl.ts","GpuUtil/index.ts","SteamApp/Test/GlUnitTests.tsx","GpuUtil/TextureReader.ts","GpuUtil/Image.ts","GpuUtil/RenderTarget.ts","GpuUtil/Texture.ts","GpuUtil/ShaderModule.ts","GpuUtil/Mesh.ts","Result.ts","GpuUtil/ShaderCache.ts","GpuUtil/Program.ts","GpuUtil/Computations/Copy.ts","GpuUtil/GlState.ts","GpuUtil/ECS/GpuBuffer.ts","GpuUtil/Reduce.ts","GpuUtil/SM2Utils.ts","GpuUtil/ECS/GpuComponentSM.ts","GpuUtil/ECS/Update.ts","GpuUtil/ECS/Query.ts","GpuUtil/GLSLTypes.ts","GpuUtil/ECS/index.ts","Math/Mat4.ts","GpuUtil/ECS/ComponentModules.ts","Time.ts","GpuWorld/ECS/Components.ts","GpuWorld/ECS/Transform.ts","GpuWorld/StateLayout.ts","GpuWorld/ECS/UnitComponents.ts","GpuWorld/ECS/Visibility.ts","GpuWorld/Renderer/ModelRenderer.ts","GpuWorld/Renderer/OverheadBarsRenderer.ts","GpuWorld/Renderer/Util.ts","GpuWorld/Renderer/Visualization.ts","GpuWorld/ECS/AnimationTrack.ts","GpuWorld/ECS/Animation.ts","GpuWorld/Buffs/Bubbles.ts","GpuWorld/Buffs/Daze.ts","Images/Buffs.png","GpuWorld/ECS/Camera.ts","GpuUtil/Model.ts","Models/Impact.glb","GpuWorld/ECS/ArenaStats.ts","GpuWorld/ECS/DamageCalc.ts","GpuWorld/Audio.ts","Models/Bullet.glb","Models/Dart.glb","GpuWorld/Projectiles/Projectiles.ts","GpuWorld/Abilities/Abilities.ts","GpuWorld/Brain/SensesDef.ts","GpuWorld/Abilities/HealingGland.ts","GpuWorld/Abilities/Bubblegums.ts","GpuWorld/Abilities/VampireGland.ts","GpuWorld/Brain/Components.ts","GpuWorld/Tools/BrainHistograms.ts","GpuWorld/Renderer/DecisionsViz.ts","GpuWorld/Renderer/AICrowdLogo.ts","Images/AICrowdLogo.png","GpuWorld/Renderer/index.ts","GpuWorld/ECS/Ground.ts","GpuWorld/Buffs/Cripple.ts","GpuWorld/Brain/UnitFocusables.ts","GpuWorld/Brain/Senses.ts","GpuWorld/Brain/NeuralNetwork.ts","GpuWorld/Brain/Decisions.ts","GpuWorld/ECS/Focus.ts","GpuWorld/Abilities/CastingAbility.ts","GpuWorld/Buffs/Buffs.ts","GpuWorld/ECS/UnitMovement.ts","GpuWorld/ECS/UnitPhysics.ts","GpuWorld/ECS/UnitAnimationAndSound.ts","GpuWorld/Tools/CopyAndMutate.ts","GpuWorld/Tools/Breeding.ts","GpuWorld/Tools/RoundStats.ts","Math/Vector2.ts","GpuWorld/Tools/ArenaInfos.ts","GpuWorld/ECS/UnitStats.ts","GpuWorld/Abilities/Talons.ts","GpuWorld/Tools/Replay.ts","GpuWorld/Abilities/Darts.ts","GpuWorld/Abilities/Leap.ts","GpuWorld/Tools/BattleScore.ts","GpuWorld/ECS/DuckAI.ts","GpuWorld/ECS/CrabAI.ts","GpuWorld/ECS/Gold.ts","GpuWorld/ECS/Unit.ts","GpuWorld/Abilities/Trombone.ts","GpuWorld/index.ts","Components/MeasureSize.tsx","Components/WonkyPanel/index.tsx","Components/Routing.tsx","Components/Button/index.tsx","Components/CodeMirror/index.tsx","Components/Panel/index.tsx","Components/Popup/index.tsx","Components/Layout/index.tsx","Components/WorldCanvas/ShaderDebugger.tsx","Components/WorldCanvas/index.tsx","Components/Store.tsx","GameComponents/WorldDataConsumer.tsx","Components/ECSInspector/index.tsx","Components/Hotkeys.ts","Math/SphericalCoordinate.ts","Math/Animatable.ts","GpuUtil/Camera.ts","SteamApp/WorldPage/RTSCamera.tsx","Components/Editors/EditorTypedefs.tsx","GpuWorld/Renderer/Configuration.ts","GpuWorld/StateData.ts","GpuWorld/StateInit.ts","GpuWorld/GameLoop.ts","GpuWorld/StateDerived.ts","Models/ArenaHeightmap/Image0000.exr","Models/ArenaNormals/Image0000.exr","Models/ArenaMap.glb","GpuWorld/Map.ts","GpuWorld/State.ts","JobQueue.ts","Models/UnitMarker.glb","GpuWorld/CreateUnit.ts","Models/PlayerUnit.glb","Models/Scarecrow.glb","Models/Duck.glb","Models/Crab.glb","Models/Turtle.glb","Models/Statue.glb","GpuWorld/CreateUnitModel.ts","GpuWorld/Renderer/PortraitRenderer.ts","GpuWorld/Renderer/DefaultPortraitRenderer.ts","SteamApp/CreaturePortrait/index.tsx","Images/LoadingPortrait.png","SteamApp/WorldPage/ArenaMinimaps/index.tsx","GameComponents/BattleScore/index.tsx","Components/ProgressBar/index.tsx","Components/Interval.tsx","GameComponents/RoundClock/index.tsx","Components/Firebase.tsx","Components/Popdown/index.tsx","Components/Menu/index.tsx","Components/Checkbox/index.tsx","Components/Editors/PrimitiveEditors.tsx","Components/Editors/WithDefaultValue.tsx","Components/Editors/LineListLayout.tsx","Components/DragAndDropList/index.tsx","Components/Editors/ListEditor.tsx","Components/Editors/StructEditor.tsx","Components/Editors/EnumStructEditor.tsx","Components/Editors/ObnumEditor.tsx","Components/Editors/TupleEditor.tsx","Components/Editors/StringEditor.tsx","Components/Editors/KeyValueEditor.tsx","Components/Editors/ColorEditor.tsx","Components/Editors/FileEditor.tsx","Components/Editors/NumberEditor.tsx","Components/Editors/TableEditor.tsx","Components/Editors/PixlingTimespanDefEditor.tsx","Components/Editors/AnyEditor.tsx","Components/Editors/EditorTypedefConvertible.ts","SteamApp/Admin.tsx","Changelog.md","Images/EnergyModel05.png","Images/EnergyModel052.png","Images/Logo.png","Components/Tabs/index.tsx","SteamApp/AppState.tsx","Images/Items.png","SteamApp/WorldPage/GameUI/Training.md","Components/BundledMarkdown.tsx","Images/Gold.png","SteamApp/WorldPage/UnitsLayover/index.tsx","Images/BountyPoster.svg","SteamApp/WorldPage/GameUI/index.tsx","Components/ErrorBoundary.tsx","SteamApp/SessionRecorder.ts","Math/GlMatrixHelpers.ts","SteamApp/Electron.ts","SteamApp/UserSettings/index.tsx","SteamApp/MainMenu/index.tsx","Images/MountRoukeLogo.svg","SteamApp/App.tsx","SteamApp/CreateSpecies/index.tsx","GymApp/GymApi.ts","GymApp/WebSocketAsync.ts","GymApp/index.tsx","Util.ts","Math/Math.ts","Math/Vector3.ts"],"names":["xy","v","x","y","toGlVec4","z","w","vec4","fromValues","fromGlVec4","vec","createBatches","outputsLength","outputBatchSize","l","count","InterpolateTGLSL","xt","yt","InterpolateClampedTGLSL","shaderHeader","CellPosDefinesGLSL","join","computationShaderHeader","glslFloat","value","_","Math","floor","glslVec2","glslVec3","getGlConstantName","gl","constant","k","handleGlError","context","glGetError","getError","err","apply","NO_ERROR","console","error","initGlExtensions","missing","getExtension","push","loadImage","url","Promise","resolve","image","Image","src","addEventListener","loadArrayBuffer","xhr","XMLHttpRequest","open","responseType","onload","response","send","GlUnitTests","resolveReadRectForTexture","texture","readRect","undefined","width","size","height","TextureReadPollOptions","checkPeriod","maxNPeriods","TextureReader","textureSlicing","config","this","gls","batches","fbs","format","type","packAlignment","img","imgOutBuffer","slices","layers","internalFormat","R32F","RGBA","FLOAT","RGBA32F","R32I","RGBA_INTEGER","INT","RGBA32I","R8UI","RED_INTEGER","UNSIGNED_BYTE","RGBA8UI","Error","Array","from","length","maxColorAttachements","map","createFramebuffer","framebuffer","batch","i","is2dArray","layer","depth","framebufferTextureLayer","READ_FRAMEBUFFER","COLOR_ATTACHMENT0","framebufferTexture2D","FRAMEBUFFER","TEXTURE_2D","fb","deleteFramebuffer","r","zeroesF32","zeroesI32","zeroesU8","mode","asyncOpts","read","then","res","destroy","pollOpts","reuseBuffer","createImgBuffer","buff","createBuffer","bindBuffer","PIXEL_PACK_BUFFER","bufferData","sizeInBytes","STREAM_READ","pixelStorei","PACK_ALIGNMENT","syncObject","layerSize","readBuffer","readPixels","data","channelSize","fenceSync","SYNC_GPU_COMMANDS_COMPLETE","textureFormat","resolveImage","check","timeout","s","clientWaitSync","ALREADY_SIGNALED","CONDITION_SATISFIED","getBufferSubData","deleteSync","reject","checksCounter","n","checker","window","setInterval","isMaxPeriods","warn","name","contextLost","clearInterval","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","textureReaderTest","original","async","a","tex","toGl","testName","log","slice","sliceRange","readTextureAsync","readTextureSync","downloaded","lodash","isEqual","dump","channels","asyncr","test","randomize","imageIndex","channel","imagePosition","index","args","Vector4","fill","min","max","random","RandomSeedable","as2dArray","Texture","defaultTextureFormat","init","DoubleBufferedTexture","Float32Array","Int32Array","Uint8Array","RG32F","RG32I","RG8UI","RGB32F","RGB32I","RGB8UI","position","mod","safeIndex","pos","readPixel","write","reduce","initialValue","zeroes","DataConstructor","to","rect","ImageSlice","startLayer","row","table","canvas","document","createElement","getContext","style","clearRect","fillStyle","fillRect","dataUrl","toDataURL","constructor","arrayConstructor","buffer","exr","exrLoader","parse","pixelFormat","THREE","threePixelFormatChannels","fromEXRBuffer","readAndDestroy","EXRLoader","target","offset","chunkSize","set","subarray","toArray","RenderTarget","destroyed","cachedTexture","cachedLayers","cachedOutputCount","drawBuffers","bind","inited","setOutputCount","color","enable","SCISSOR_TEST","scissor","formatType","clearBufferfv","COLOR","clearBufferiv","clearBufferuiv","Uint32Array","disable","defaultFormat","RGB","RED","RG","RG_INTEGER","RGB_INTEGER","R8I","RG8I","RGB8I","RGBA8I","defaultType","BYTE","defaultUnpackAlignment","defaultPixelBytes","textureFormatType","isDoubleBuffered","unpackAlignment","pixelBytes","validateSize","createTexture","nAliveTextures","deleteTexture","validData","activeTexture","TEXTURE31","bindTexture","TEXTURE_2D_ARRAY","UNPACK_ALIGNMENT","texImage3D","texImage2D","generateMipmap","Number","isInteger","maxTextureSize","TextureSlicing","rt","doLayers","clear","sliceAll","pixelSizeInBytes","defaultChannels","mipmap","t","texture0","texture1","swapped","selfName","front","back","DoubleBufferedTextureSlicing","readSync","readAsync","PIXEL_UNPACK_BUFFER","STREAM_DRAW","JSON","stringify","texSubImage3D","texSubImage2D","deleteBuffer","upload","destroyTextures","textures","isArray","uniformDef","required","def","uniformArrayDef","inDef","flat","outDef","constDef","structDef","members","funcDef","returnType","body","overloadedFuncDef","funcs","shaderModule","sm","dependencies","toString","modlPrefix","split","Object","keys","flattenModules","self","assign","d","CompiledShaderModule","uniforms","source","defToGlsl","getValue","state","uniform","program","setUniform","arg","Buffer","STATIC_DRAW","ARRAY_BUFFER","ELEMENT_ARRAY_BUFFER","Vertex","normal","texcoord","skinWeight","skinIndex","Mesh","attributes","buffers","attrib","vertexAttribPointer","itemSize","normalized","stride","getAttribute","enabledVertexAttribArray","filter","bindAttrib","attrs","attribs","geometry","attr","arrayBuffer","setData","array","find","b","bytesPerElement","BYTES_PER_ELEMENT","typeFromArrayBuffer","elementArrayBuffer","Uint16Array","UNSIGNED_SHORT","Int16Array","SHORT","UNSIGNED_INT","Int8Array","createBoxMesh","positions","indices","create3dIndexed","ok","result","isOk","isErr","addLineNumbersToSource","shaderFromSource","sourceCode","shader","createShader","VERTEX_SHADER","FRAGMENT_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","message","getShaderInfoLog","shaderType","ShaderCache","shaderCache","errors","c","compiled","deleteShader","cached","vertexSource","fragmentSource","opts","vs","getShader","fs","shaders","shaderSources","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","logErrors","stack","Sentry","handleShaderErrorHandler","quadVertexShader","Sampler","filtering","CachingUniformWriter","renderer","glSet","values","key","throwIfNotPresent","ul","getUniform","vecArrayEquals","numberArrayEquals","Program","fragmentShaderSource","vertexShaderSource","writers","vec2","uniform2f","ivec2","uniform2i","vec3","uniform3f","ivec3","uniform3i","uniform4f","ivec4","uniform4i","uniform2fv","flatMap","uniform2iv","uniform3fv","uniform3iv","uniform4fv","uniform4iv","mat4","uniformMatrix4fv","int","uniform1i","uint","uniform1ui","float","uniform1f","bool","uniform1fv","uniform1iv","textureUnitOffset","nAlivePrograms","deleteProgram","getUniformLocation","loc","getAttribLocation","expect2dArray","sampler","setActiveTexture","TextureFiltering","Nearest","setSampler","inputTextures","isArraySampler","isNormalMultiSampler","isArrayMultiSampler","setTexture","setTextureArray","uniformValues","uniformIgnoreIfNotPresent","indexOf","CopyTextureForFormat","renderTarget","pre","nLayers","multi","single","copyType","prepareForComputation","BlendMode","Sum","sourceOffset","setUniforms","drawQuad","copy","CopyTexture","formats","copyBackToFront","GpuStateCurrent","maxCombinedTextureImageUnits","getParameter","MAX_COMBINED_TEXTURE_IMAGE_UNITS","activeTextures","samplers","viewport","caps","GlState","current","commonSamplers","CommonSamplers","meshes","box","quad","createSimple3dTriangleStrip","sphere","fromThree","tmpTextures","stats","drawCalls","MAX_COLOR_ATTACHMENTS","MAX_TEXTURE_SIZE","copyTexture","e","BLEND","TEXTURE0","nonTarget","bindSampler","getSampler","cap","setCap","sfactor","dfactor","blendFunc","srcRGB","dstRGB","srcAlpha","dstAlpha","blendFuncSeparate","blendEquation","func","depthFunc","cullFace","factor","units","polygonOffset","flag","depthMask","mesh","instanceCount","drawElementsInstanced","TRIANGLES","drawElements","nVertices","drawArraysInstanced","TRIANGLE_STRIP","drawArrays","draw","id","m","MeshLoaders","minSize","minDepth","newSize","newDepth","getTmpTexture","selectAbsolute","outputRect","blendMode","equation","CULL_FACE","DEPTH_TEST","bindFramebuffer","useProgram","disableVertexAttribArray","enableVertexAttribArray","GL","ONE","FUNC_ADD","Alpha","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","nearestSampler","createSampler","linearSampler","mipmapSampler","linearMipmapSampler","samplerParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","REPEAT","TEXTURE_WRAP_T","LINEAR","NEAREST_MIPMAP_LINEAR","LINEAR_MIPMAP_LINEAR","deleteSampler","MipMap","LinearMipMap","unit","texParameteri","Linear","componentBufferDepth","component","componentFormatChannels","GpuBufferData","dataRowToArchetype","archetypeToDataRowOffset","ECSConsts","ChunkSize","create","getGpuBufferInternalFormat","components","archetypes","getCopyTexture","oldDepth","layerOffset","texOldDepth","tmp","getTmpTextureSlice","archetype","chunks","arch","archetypeIndex","dataRowOffset","heightChange","oldHeight","newHeight","sourceTop","destTop","sourceBottom","destBottom","arch2","entityCell","chunkAddressFromEntityCell","chunkIndex","entityIndex","archIndex","buffArch","p","entities","getArchetypeComponentDataSlice","chunk","select","imageToComponentData","toImage","range","start","startIndex","end","selectRelative","getRangeComponentDataSlices","EntitiesRange","dataCell","dataRect","comp","entity","setComponentData","setRangeComponentData","dataSlice","getEntityComponentDataSlice","raw","finalize","GpuReduce","reduceGlsl","reduceJs","computation","glReduceUntil","inputLayers","swap","reduceGl","MathConstsSM","PI","RandomSM","rand","RandomUtilSM","choiceBool","randomSeed","entityStaticRandom","entityRandom","RandomBoxMullerSM","sample","InterpolateTSMFunc","InterpolateClampedTSMFunc","InterpolateSM","interpolate","interpolateClamped","MatrixSM","translate","scale","translateScale","rotateTranslateScale","rotateX","rotateY","rotateZ","forwardRightUp","toBillboard","transformPoint","ArrowTransformSM","rectSpaceToClipSpace","cellArrowTransform","WithoutNaNInfSM","isnanPolyfill","withoutNaNInf","ArrayMaxSM","SpatialSM","forward","isInFront","angleBetweenVec3s","angleBetweenVec2s","angleToPosition","relativeRotationTo","facingUs","Vector2SM","perpendicular","AngleLerpSM","shortestAngleDist","angleLerp","vec4To","gpuComponentReadSM","archetypeDataRowOffset","MaxArchetypes","ecs","gpuBuffers","get","sizeVec2","dataArrow","gpuBufferReadSM","gpuComponentInfo","hasComponentSM","componentId","archetypeHasComponentTexture","gpuComponentBufferWriterSM","ceil","vec4Pad","MapGpuComponent","reader","writer","isReading","updateMulti","UpdateGpuComponents","update","run","updateType","arrows","componentDepths","componentOffsets","componentsTotalDepth","outDepth","writeShaderPrep","outValues","outArchetype","outYOffset","main","copyArrows","CopyArrows","updateUniformValues","archetypesChunkHeights","heightOffset","prepare","writeUniforms","info","tmpSlice","tmpComponentSlice","nextArch","nextWidth","valuesDepth","vertexShader","targetArchetypeDataRowOffset","targetDataCell","targetSize","sourceDataCell","fragmentShader","sourceLayerOffset","sourceCount","targetGpuBuffer","CacheByDeps","disposeValue","deps","dispose","ArchetypesQuery","requiredComponents","cache","getMatchingArchetypes","ArchetypesToEntityBlocks","ArchetypesToGpuComponentBlocks","ArchetypeIndexQuery","ArchetypesToEntities","EntitiesBlock","formVersion","GpuComponentBlock","fromComponent","GpuComponentUploadFrom","blocks","alwaysUpload","contentVersions","prevBlocks","block","cpuComp","cpuComponent","chunkKey","contentVersion","EntitiesQuery","filters","cachedArchetypes","cachedEntities","cacheKeys","f","getEntityRefsForArchetypes","objComponent","nextEntities","obj","getComponentData","dependencyKeys","UpdateCpu","transform","Transform","EntitiesToGpu","LookupTableQuery","props","RenderEntities","maxEntities","getMesh","chunkWidth","entityList","entityListTexture","output","MapEntitiesGpu","MapEntitiesToTempGpu","outValue","queueCashKey","QueuingEntityValueTextureReader","SyncEntityValueTextureReader","ReduceSum","ss","parseInt","glslTypeArraySize","query","resultReader","resultQueue","tryRead","shift","reduceSum","sizeClosestPow2","reduceSync","indexWidth","rows","column","LookupTableToGpu","GpuLookupTableSM","indexQuery","indexData","cpuComponentItemSize","EntityInit","entityInit","setComponent","entityCellFromChunkAddress","Archetype","GpuBufferArchetypeBlock","outArchetypeDataRowOffset","entitiesCount","SM","getOutEntityCell","getIndex","EntityComponentSystem","gpuComponentInfos","Proxy","prop","archetypeHasComponent","archetypesByKey","registeredGpuBuffers","gpuBuffer","entityData","getOrCreateArchetype","allocateEntities","totalCount","firstEntity","lastChunk","leftCount","roomLeft","take","newChunks","createArchetypeChunks","archKey","createArchetype","GpuComponentInfo","enuserComponentAllocated","createArchetypeHasComponentTexture","setArchetypeChunks","incContentVersion","arr","d2","normalizeGpuComponentData","view","getCpuComponentDataView","all","archetypeMatches","getEntityRefsForArchetype","blockCell","compKeys","removeAllEntities","buffs","sort","worldState","getArchetypeComponentData","bufferComponent","fromArray","m00","m01","m02","m03","m10","m11","m12","m13","m20","m21","m22","m23","m30","m31","m32","m33","identity","mat","j","toRows","mul","transformMat4","clone","rotationZ","radians","Month","GpuBufferModule","registerGpuBuffer","TokenComponentModule","GpuComponentModule","DualComponentModule","gpuComponent","CommonBuffer","NameComponent","registerComponent","ArenaInstance","ArenaMemberIndex","ArenaBuffer","Arena","VisibleComponent","VisibilityFromComponent","TransformBuffer","Position","Quaternion","Scale","RotationZ","CpuBoneOffsetComponent","BoneOffset","BoneMatrix","TransformParent","LocalToParentOrderComponents","LocalToWorld","LocalToParent","OffsetLocalToWorld","InvLocalToWorld","TransformHelpers","worldPosition","UpdateTransform","positionRotation","mapGpu","localToWorld","ltpo","boneMatrix","offsetLocalToWorld","cpuPositionToGpu","gpuComponentBlocks","uploadFrom","cpuQuaternionToGpu","cpuScaleToGpu","localToParentFromPosQatScaleQuery","boneMatrixFromCpuQuery","localToWorldFromCpuQuery","localToWorldFromCpuPosQuatScaleQuery","invLocalToWorldFromCpuQuery","Mat4","quaternion","fromRotationTranslationScale","invLocalToWorld","invert","runPosRot","runLocalToParentFromCpuPosQatScale","runOffset","runLocalToWorld","runBoneMatrixFromCpu","runBoneMatrix","runLocalToWorldFromCpu","runLocalToWorldFromCpuPosQuatScale","runInvLocalToWorldFromCpu","PixlingTimespanDefUnits","DaysInMonth","StepsPerSecond","SecondsPerStep","DaysInYear","MonthsInYear","PixlingTimespan","steps","timeInSecondsFractional","timeInMinutesFractional","timeInHoursFractional","timeInDaysFractional","timeInMonthsFractional","timeInYearsFractional","timeInSeconds","timeInMinutes","timeInHours","timeInDays","timeInMonths","timeInYears","secondOfMinute","minuteOfHour","hourOfDay","dayOfYear","monthOfYear","years","dayOfMonth","short","padded","valuePadded","padStart","stringifyComp","unshift","Steps","Minutes","Hours","Days","Years","pixlingTimespanDefToStepsFloat","pixlingTimespanDefToSteps","Teams","NeighborCounters","StepsInBattle","CastingState","keysOfEnum","UnitAnimations","SoundEffect","BrainOutputs","GroundLayers","BrainOutputsKeys","SideSize","db","ArenaMembersSize","TeamPoints","StatuePoints","StatuePosition","BaseSpawnHeight","SpawnPositions","Solo","Duo","Team","mirrorPosition","worldSize","ReplayCameraClipKey","GpuWorldStateLayout","brain2","hiddenLayerOutputSlices","arenas","arenaCount","arenasSize","maxWidth","arenaSizeFromCount","arenasRect","arenasSizeVec2","vec2FromSize","arenasWorldSize","arenasWorldSizeVec2","heatmapSize","heatmapSizeVec2","UnitCategories","HomeHealthColor","AwayHealthColor","ManaColor","UnitBuffer","MaxHitpoints","Hitpoints","MaxMana","Mana","CpuTeamComponent","GymIndex","UnitCategory","category","FriendStatue","EnemyStatue","Friend","Enemy","CpuPlayerUnitComponent","Unit","PlayerUnit","Creature","WorthPoints","ModelCreatedComponent","TailAttachment","BackAttachment","HeadAttachment","HandLeftAttachment","HandRightAttachment","ProjectileAttachment","UnitCenterSM","center","HitpointsTrailing","HitpointsRegenComponent","ManaRegenComponent","Gold","PreviousGold","PreviousHitpoints","DiedStep","ImpactOwner","LastPushedBy","IsTakingFallDamage","CrabAI","DuckAI","Focuser","Focusable","AnimatableUnitComponent","UnitSoundMaterialComponent","UnitSoundsComponent","UnitMovement","UnitMovementSpeed","UnitRotationSpeed","WalkingSpeed","Velocity","Force","IsOnGround","Stuck","UnitStats","AliveTime","CumulativeHitpoints","MinDistEnemyStatue","BountyComponents","BountyDefs","bountyDef","visibleCacheKeys","renderArena","renderAllArenas","CullFace","UpdateVisible","visibleQuery","updateCpu","arenaInstance","visibleFromQuery","visible","PixlingOverheadBarBaseRenderer","conf","maxInstanceCount","filterValue","render","offsetY","derived","cameraView","projection","cameraProjection","barEntityCell","barColor","outColor","padding","getBarColor","OverheadBarsRenderer","health","homeHealthColor","awayHealthColor","HomeTeam","mana","manaColor","rendererConfig","overheadBars","appState","hideUI","LightSM2","lightDirection","renderLightDirection","light","FogSM2","fogFactorExp2","QuadLineSM","vertexPosition01","fromPoints","fromLineWithDeltas","fromLineWithDelta","fromLineWithWidths","fromLineWithWidth","NONE","FRONT","BACK","FRONT_AND_BACK","ModelRendererBuffer","MaterialColor","MaterialUseLighting","RenderableComponent","SkinmeshBuffer","SkinmeshBones","SkinmeshBindMatrix","SM2Program","ModelRenderer","createVertexShader","worldTransform","entityCells","viewPosition","materialColor","materialUseLighting","viewMatrix","projectionMatrix","getWorldTransform","staticVertexShader","skinmeshVertexShader","materialIsUnit","fogColor","rgba255ToVec401","fogDensity","fogOffset","programs","static","skinmesh","renderTree","opaque","transparent","renderable","programNode","skinning","renderableKey","LEQUAL","POLYGON_OFFSET_FILL","blendKey","blendNode","programKey","group","None","GazeRenderer","viewProjection","cameraProjectionView","renderGazes","track","AnimationTrackInterpolator","results","interpolant","times","time","evaluate","AnimationControllerComponent","AnimationBinderComponent","animationClipFromThree","clip","duration","tracks","animationTrackFromThree","property","targetName","componentName","getAnimationInterpolator","clipName","trackIndex","interpolator","animationInterpolators","UpdateAnimations","currentTime","stepCounter","substep","controller","binder","outputs","actions","action","clipNames","animationClips","animTime","positionType","positionValue","looping","o","weight","mix","slerpFlat","ec","entityLookup","getComponentByName","compData","IronBubbable","HeliumBubbable","UpdateIronBubbable","UpdateHeliumBubbable","velocity","BubbleShader","vertex","BubbleRenderer","Back","IronBubbleColor","HeliumBubbleColor","BubblesRenderer","bubbles","Dazeable","UpdateDazeBuff","dazed","BuffsImage","DazeableRenderer","fromImage","Camera","Fovy","Near","Far","Projection","ProjectionView","InvProjectionView","createCamera","createEntities","quat","UpdateCameraMatrices","fovy","near","far","aspect","canvasRect","perspective","projectionView","invProjectionView","DefaultUp","ThreeModel","model","scene","updateMatrixWorld","animations","globalName","traverse","geom","roots","rootEntities","rootEntityInit","skinMeshes","children","createRecursive","localToParentStartOrder","boneEntityCells","skeleton","bones","bone","boneCount","lookup","object","parentEntities","order","matrix","elements","matrixWorld","setComponents","offsetMatrix","getInverse","material","side","Front","beforeEntityCreated","hasComponent","onMaterial","emissiveIntensity","threeColorToVec4","emissive","afterEntityCreated","cameraName","writeCamera","camera","getObjectByName","fov","lookAtVector","applyQuaternion","full","eye","lookAt","Vector3","up","screenOffset","aspectRatio","path","GLTFLoader","load","gltf","g","ArenaWinner","UnitsInArena","unitsInArenaGpu","TeamStats","Stats","alive","unitsAlive","pointsLoss","hitpoints","aliveTime","cumulativeHitpoints","minDistEnemyStatue","gold","AwayTeam","ArenaStats","home","away","homePoints","awayPoints","winner","homeCount","teams","unitCount","awayCount","Tie","Home","Away","ImpactModel","fromPath","ImpactGlb","createImpactEffects","owners","createInstances","owner","DamageCalcHelpers","CastingAbilityHelpers","shellArmorBonus","abilitiesData","Abilities","Shell","activeArmor","ironBubbleArmorBonus","IronBubblegum","armor","isPerforming","UpdateDestructible","damageTakenBounty","updateGpu","damageTaken","statueDamageTaken","UpdateImpactEffect","GlobalAudioContext","DamageBounties","damageEnemyStatue","damageEnemyUnit","friendlyFire","KillBounties","killEnemyStatue","killEnemyUnit","HealBounties","healFriendlyStatue","healTeammate1","healTeammate2","healEnemy","SingleTargetDamage","fromComponents","getTarget","baseDamage","originator","damage","SingleTargetHeal","heal","Sounds","AudioContext","loadMp3AudioBuffer","sounds","sound","decodeAudioData","singleEffect","slicesEffect","randomLowpassEffect","minFreq","maxFreq","effect","gainEffect","minGain","maxGain","SoundEffectDefs","Dart","DartThud","Knife","KnifeHit","FleshHit","effects","StoneHit","WoodHit","Wimper","randomMixOfEffect","Snore","HealBuzz","Resurrect","BubbleWobble","Balloon","Jump","randomSelectEffect","Footstep","CountIn","Gunshot","HeavyDoorClose","Victory","ApplyItem","Bite","PlanksFalling","Explosion","Brass","StoneTick","Coins","loadEffectBuffers","MiscBuffers","wind1","MusicBuffers","music1","music2","music3","music4","SoundEffectController","audioContext","sources","gain","sourcesEnded","ended","loop","when","stop","setValueAtTime","linearRampToValueAtTime","AudioPlayerInstance","musicStarted","musicGain","createGain","effectsGain","environmentGain","masterGain","masterCompressor","createDynamicsCompressor","windSource","windGain","musicSource","musicHighass","createBiquadFilter","musicInnerGain","playingSoundEffects","prevCameraView","connect","destination","frequency","createBufferSource","playNextMusic","prevTrack","onended","startTime","highpassMusic","restoreMusic","startDelay","createEffectSource","eff","lowpass","sub","subSources","flatten","weights","totalWeights","subGain","volume","subEff","effectName","node","effectGain","panner","createPanner","distanceModel","maxDistance","refDistance","rolloffFactor","setPosition","splice","playing","fadeOut","equals","invView","getTranslation","rotation","getRotation","transformQuat","listener","vec3IsNanOrInf","setOrientation","isNaN","isFinite","ProjectileType","BulletModel","BulletGlb","DartModel","DartGlb","ProjectileBuffer","CpuProjectileTypeComponent","ProjectileOriginator","SeekingProjectileTarget","ProjectileSpeed","DamageProjectile","DazeProjectile","KnockbackProjectile","ProjectilePreviousPosition","createBulletProjectile","KnockbackBullet","SleepingDart","AbilityRange","AbilitySlot","ProjectileHelpers","ProjectileState","targetPosition","speed","delta","hitting","getProjectileState","UpdateProjectiles","applyDamage","applyDaze","applyKnockback","applyLastPushedBy","updateProjectiles","toGpu","mapToTemp","toCpuQueuing","round","readResults","queueRead","playSoundEffect","ValidTarget","straightAnimationUpdater","anim","startOnPerform","previousActions","nextActions","castingState","castingSteps","castingAbility","Performing","WindDown","active","duoAnimationUpdater","animationCastFrames","animationWindDownFrames","Casting","castTime","windDown","EmptySoundEffectUpdater","straightSoundUpdater","soundEffect","castingTarget","updaters","animationPerformFrames","AbilitiesConsts","TalonsSoundUpdater","AttackAnimationUpdater","Attack1","FireAnimationUpdater","Fire1","MuzzleFlash1","updater","TailAttackAnimationUpdater","TailAttack1","AbilitiesData","columns","Any","Anything","Talons","Close","BloodClaws","Cleavers","Cripplers","HealingGland","Ranged","healing","VampireGland","Leap","Jump1","Pistol","onGunCreate","Magnum","onMagnumCreate","Blaster","SleepDart","onSleepDartCreate","sleepDuration","BreathAttack1","HeliumBubblegum","ShellHide1","Trombone","targetRange","validTargets","cooldown","doesDamage","heals","castAnimation","castSound","onCreate","ability","AbilitiesBuffer","UnitRef","GunProjectileRef","SleepDartProjectileRef","createAbility","unitRef","onUnitCreated","abilityInit","Bullet","projectile","attach","Sense","GymExtraSense","AbilitySM","AbilitiesCount","abilities","UnitAbilities","Ability","StateStartStep","Target","State","Cooldowns","isCasting","isWindDown","stateSteps","castingProgress","performingProgress","UpdateHealingGland","singleTargetHeal","hps","HealingGlandRenderer","UpdateIronBubblegum","UpdateHeliumBubblegum","BubblegumRenderer","abilityComponent","BubblegumsRenderer","bubblegums","UpdateVampireGland","singleTargetDamage","dps","VampireGlandRenderer","createLayerComponents","weightsBuffer","biasesBuffer","resBuffer","weightsSlices","biases","biasesSlices","outputSlices","SensesSlices","HiddenAndMemoryInputSlices","HiddenLayerLayout","inputSlices","MemoryLayerLayout","OutputLayerLayout","MemoryLayer","HiddenLayer","OutputLayer","SensesBuffer","Senses","GymExtraSensesSlices","GymExtraSenses","UpdateBrainHistogram","nArenas","layout","UpdateBrainHistograms","senses","decisions","showSensesHistogram","sensesHistogram","showDecisionsHistogram","decisionsHistogram","BrainHistogramRenderer","corners","histogram","histogramSize","left","top","BrainHistogramsRenderer","decisionHistogramView","sensesHistogramView","UpdateDecisionsViz","decisionsViz","showDecisionsViz","getCopyLayers","DecisionsVizRenderer","gridSize","DecisionsVizHistory","grid","Logo","AICrowdLogoRenderer","logoTexture","logoSampler","projectionViewMatrix","logo","aiCrowdLogo","AbilityEffectsRenderer","GpuWorldRenderer","systems","renderers","canvasSize","clearColor","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","setCanvasSizeToElementSize","getBoundingClientRect","right","bottom","GroundHeightSM","heightmap","heightmapSize","atCoord","atPosition","GroundNormalSM","normalmap","normalmapSize","Crippleable","UpdateCrippleBuff","UnitFocusables","UpdateSenses","mapCenter","Ability0Ready","Ability1Ready","Ability2Ready","HasFocus","FriendStatueDistance","FriendStatueAngle","FocusRelativeRotation","FocusFacingUs","FocusFocusingBack","FocusHitpoints","FocusDazed","FocusCrippled","HeightFront1","HeightFront5","HeightBack2","PositionUpDown","PositionLeftRight","sense","UpdateGymExtraSenses","gameInstance","DenseLayerSM2","nInputSlices","nOutputSlices","activation","calcNeuron","runLayer","outputSlice","BrainRunningSM2","running","UpdateHiddenLayer","dense","UpdateMemoryLayer","UpdateOutputLayer","UpdateNeuralNetwork","gymExtraSenses","hiddenLayer","memoryLayer","outputLayer","stepsSinceRoundStart","battleStartStep","Decisions","MoveX","Rotate","ChaseFocus","CastingSlot","ChangeFocus","DecisionsCMs","SampleCastSlotSM","SampleFocusSM","UpdateDecisionsFromBrain","brainOutput","CastSlot0","CastSlot1","CastSlot2","FocusFriendStatue","FocusFriend1","FocusFriend2","FocusEnemyStatue","FocusEmemy1","FocusEnemy2","FocusEnemy3","UpdateUserControlledDecisions","userControlEntity","userControlSet","UpdateBrainFocusers","unitsInArena","UpdateCastingAbility","isValidTarget","targetInRange","Inactive","UpdateBuffs","UpdateUnitMovement","UpdateUnitPhysics","fallDamageTaken","timestep","physicsTimestep","clampPositions","fallDamageKillBounty","resetLastPushedBy","UpdateUnitAnimationAndSound","updateCamera","walkSpeed","castStateSteps","castAbility","castState","heliumBubble","deadSteps","previousHitpoints","incomingDamage","au","ac","us","dead","Dazed","HeliumBubble","Death1","Dazed1","Run1","prevPerc","perc","stepLength","abs","prevAnimFrame","nextAnimFrame","Idle1","CopyMutateParent","MutationRate","CopyAndMutateBrains","matrices","WeightComponents","BiasComponents","CopyAndMutateMatrix","weightsComponent","weightsSM","randomSeeds","weightsOffset","renormalization","trainingConfig","weightsRenormalizationRate","TrainingStats","winPercs","tiePercs","lossPercs","homeDistanceClosestEnemy","win5Percs","tie5Percs","losses5Percs","homeGold","awayGold","TeamTrainingStats","points","UpdateBreeding","creatures","toCpuSync","arenaStats","copyAndMutate","creaturesGold","arenaIndex","arenaMemberIndex","fitness","breed","train","unitsSorted","pow","totalFitness","selectParent","elitismCount","culm","parent","updateArenaStats","validation","trainingStats","homeTrainingStats","awayTrainingStats","win5s","tie5s","losses5s","total5s","updateTeam","getToSaveBrains","team","elitism","toSaveArenaIndex","toSaveUnits","serializeCreatureBrain","toSaveCreatureBrains","numberArrayToFirebaseBlob","firebase","firestore","Blob","fromUint8Array","hiddenLayerWeightsP","hiddenLayerBiasesP","memoryLayerWeightsP","memoryLayerBiasesP","outputLayerWeightsP","outputLayerBiasesP","playerUnit","loggedInUserId","generation","brain","creatureId","ownerId","hiddenLayerWeights","hiddenLayerBiases","memoryLayerWeights","memoryLayerBiases","outputLayerWeights","outputLayerBiases","RoundStats","wins","losses","ties","homeAlive","awayAlive","UpdateRoundStats","roundStats","Vector2Typedef","metatype","properties","zero","random2","minX","minY","maxX","maxY","randomSeedable","randomSeedable2","fromPolarCoordinates","angle","radius","cos","sin","length2","sqrt","distance","cross","dot","normalize","fract","Math2","add","inv","div","atan2","modulo","clamp","lerp","x0","x1","y0","y1","toGlVec2","fromGlVec2","rotate2d","mat2","transformMat2","rotate45deg","ArenaInfo","Undecided","homeUnits","awayUnits","UpdateArenaInfos","unitDatas","arenaInfos","unitData","last","playUnit","unitD","arenaUnitInfo","Vector2","turboMode","updateArenaInfos","UpdateUnitStats","UnitReplayChannels","UpdateTalons","damageSetting","UpdateCleavers","UpdateBloodClaws","UpdateCripplers","ProjectileOffset","TailAttackOffset","UpdateSleepDart","UpdatePistol","UpdateBlaster","UpdateMagnum","UpdateLeap","forces","UpdateBattleScore","battlePoints","battleUnitsAlive","UpdateDuckAI","Seeds","UpdateCrabAI","UnitReplayChannelsCount","UnitReplayChannelsSlices","CaptureReplay","PositionX","PositionY","PositionZ","unitsReplay","PlaybackReplayDecisions","replay","PlaybackReplayPositionHitpoints","common","UnitFieldPosition","statuePosition","UnitFieldPositions","AwayBase","AwayTerritory","HomeBase","HomeTerritory","UpdateTerritoryBounty","timeSpentHomeBase","timeSpentHomeTerritory","timeSpentAwayBase","timeSpentAwayTerritory","UpdateTeamSpirit","teamSpirit","UpdateGoldTimeScaling","timeScaling","UpdatePreviousGold","UpdateVictoryLossBounty","victory","tie","loss","UpdateHitpointsTrailing","UpdateHitpointsRegen","UpdateTrombone","UpdateAbilities","GpuWorldProgram","copyLayers","breeding","battleScore","victoryLossBounty","updateNeuralNetwork","stepSystems","updateMouseover","throttledUpdateMouseover","throttle","simulationEnded","endRound","fadeOutAllLoopingSoundEffects","runSelection","events","roundEnd","dispatch","autoStartNextTrainingRound","breedAndRestartTraining","resetForNextRound","restoreHitpoints","battleground","spawnPositions","ResizeObserver","require","default","MeasureSize","onSize","ref","handleRef","resizeObserver","unobserve","__measureSizeOnSize","handleOnSize","observe","entries","observer","requestAnimationFrame","entry","React","evenPadding","DefaultWonkyPanelBorder","DefaultWonkyPanelPadding","DefaultWonkyPanelBackgroundMargin","WonkyPanelSvg","borderPx","marginPx","topLeft","topRight","bottomRight","bottomLeft","shadowPx","stroke","strokeWidth","str","renderToString","className","xmlns","btoa","WonkyPanel","measure","setState","wonkyPanelSvg","backgroundMarginPx","prevProps","handleUnmount","paddingPx","onClick","paddingLeft","paddingTop","paddingRight","paddingBottom","background","renderToDataUrl","onChange","EventDispatcher","history","pushState","replaceState","Button","onPerform","disabled","toggled","primary","large","purpose","materialIcon","fontAwesomeIcon","rest","working","setWorking","handleClick","stopPropagation","wait","inner","MaterialIconButton","icon","FontAwesomeButton","iconStyle","PanelMode","CodeMirror","handleChange","cm","handleKeyDown","event","onKeyDown","container","codeMirror","CodeMirrorInstance","options","on","nextProps","val","setValue","FloatingPanelColor","Popup","showCloseButton","popupContainer","getElementById","ReactDOM","fullscreen","onClose","setTimeout","forceUpdate","createLayoutClass","layoutClass","Row","Column","Block","BlockSection","ScrollableColumn","ItemsRow","ItemsColumn","ScrollVertical","ShaderDebugger","compileError","shaderErrors","setError","setSource","theme","lineNumbers","WorldCanvasContext","WorldProgramContext","Store","change","useStore","store","sel","selection","setSelection","eventListener","newData","newSelection","detach","useStoreSelect","WorldStateContext","useWorldData","newProps","didPropsChange","dataChanged","useWorldDataSelect","ECSInspector","setArchetypes","selectedArchetype","setSelectedArchetype","setEntities","selectedEntity","setSelectedEntity","setEntityData","componentFilter","setComponentFilter","updateEntityData","getAllEntityData","updateArchetypes","compFilter","trim","toLowerCase","overflow","flexShrink","navigator","clipboard","writeText","componentInFilter","hotkeyIgnoreElement","el","tagName","contentEditable","theta","phi","animateEaseToWithDefaults","stopAnimateDistance","createAnimator","animate","nextValue","dt","easeTo","animatable","Vec2Anim","Vec3Anim","NumberAnim","SphericalCoordinate","cameraDistance","eyeOfCamera","defaultRTSCameraConf","zrot","keyboardPanSpeed","panningFriction","panningStopSpeed","rotationSpeed","RTSCameraController","worldProgram","worldCanvas","previousMousePosition","mousePosition","previousDocumentMouseMoveEvent","WorldCenter","CameraMinPosition","CameraMaxPosition","navigationModeTilt","zoom","cameraState","isPanning","elevation","eyeMeasuredHeight","positionMeasuredHeight","slideVelocity","slideTargetPosition","startPan","originalInvViewProjection","cameraInvProjectionView","originalMouseWorldPlaneIntersection","intersectScreenRayWorldPlane","originalCameraPosition","panning","stopPan","handleDocumentMouseMove","clientX","clientY","ctrlKey","mouseWorldPlanePosition","ensureRendered","handleWorldMouseDown","button","panStart","onMouseUp","removeEventListener","handleWorldMouseWheel","preventDefault","stopImmediatePropagation","platform","deltaY","userSettingsOrFallback","mouseWheelSensitivity","updateCameraFrame","nextState","deltaTime","gameCamera","newCamera","objectSetKeys","tilt","minEyeHeight","updateFrame","tmpMat","getScaling","stepPanCamera","step","slide","lookat","vertical","horizontal","handleKeydown","code","screenPosition","planeZ","invViewProjection","canvasClientRect","ray","screenRay","rayPlaneIntersection","editorStructTypedef","defaultRenderOptions","skyboxFogHeight","horizon","TeamSettings","dbTeam","maxPossiblePoints","GpuWorldStateData","initConfig","DbBattleground","battleId","battleResult","BattleWinner","completeBattleRes","battlePostUpdateDone","trainingRounds","worldNCells","groundResolution","groundSize","simulationStartTime","Date","roundResults","simulationPaused","simulationSpeed","creaturesById","ensureRenderNextLoop","renderWorld","mouseoverGround","cameraMode","gameLoopStats","stepsPerSecond","msPerFrame","runningTime","movement","crippledSlowdown","uphillPunish","showAbilitiesList","unitBountiesEmpty","showArenaList","showBrainMemberIndex","rgb255ToVec3","rgbFromHex","debugAudioEffectsPlaying","defaultGpuWorldStateData","GpuWorldStateDerived","maxGroundHeight","userSettings","status","defaultDbUserSettings","Timestamp","now","setupIndex","trainingSetups","emptyTrainingSetup","MapModel","MapGlb","GameMap","mapModel","removeComponent","MapInstance","Heightmap","fromEXRUrl","HeightmapExr","Normalmap","NormalmapExr","GpuWorldState","gameMap","handleAppStateChange","appData","updateUnitBounties","currentData","gameLoop","worldPow2Size","linear","lookupTable","destroyEcs","listeners","oldData","before","after","simulationRunning","nextStep","part","newLog","arrayReplaceIndex","empty","bounties","JobQueue","queue","nextJob","processNextJob","job","UnitMarkerModel","UnitMarkerGlb","CreatePlayerUnitOptions","createAbilities","createBrain","profiler","emptyBounties","emptyValue","getAbilityForItem","item","it","Items","getWeights","toUint8Array","createPlayerUnits","unitType","enter","decision","onUnitsCreated","brainComps","creature","uploadBrain","slots","slotIndex","exit","gymIndex","setComponentsData","sideUnitCount","unitMarker","unitMarkers","primaryColor","PlayerUnitModel","Lazy","PlayerUnitGlb","ScarecrowModel","ScarecrowGlb","DuckModel","DuckGlb","CrabModel","CrabGlb","TurtleModel","TurtleGlb","StatueModel","StatueGlb","createUnitModelsForArena","createUnitModel","getUnitModel","fromEntity","attachmentPoints","ears","eyes","backSpikes","rgb255ToVec401","secondaryColor","PortraitRenderer","loopRunning","renderLoop","jobQueue","dataUrlCache","skybox","runJob","setUnit","renderOnce","finish","resolve2","toBlob","blob","ctx","drawImage","desynchronized","DefaultPortraitRenderer","CreaturePortrait","imgRef","createRef","renderPortrait","renderToDataURL","alt","fallbackPortrait","Component","ArenaMinimaps","setAll","renderMax","ArenaMinimap","arenaInfo","title","backgroundColor","BattleScoreChangeFlash","useState","text","setText","useEffect","rgbToHex","vec301ToRgba255","BattleScore","ProgressBar","progress","useInterval","callback","delay","savedCallback","RoundClock","setStepCounter","clockString","Popdown","root","fader","popupPopdown","popupStyle","popdown","onClickFader","portal","showPopdown","documentElement","onMouseOver","onMouseOut","onContextMenu","attachment","bounding","innerWidth","innerHeight","maxHeight","Menu","MenuItem","onMouseDown","checked","highlighted","Checkbox","readOnly","CheckboxEditor","WrappedComponent","EnumEditor","variants","searchable","setShowPopdown","setFilter","vars","displayName","description","normalizeEnumVariants","filterLower","displayValue","placeholder","defaultValue","LineListLayoutItem","isLast","isFirst","LineListLayout","globalIsCopy","DragAndDropItemContext","DragAndDropList","over","queuedUpdates","queuedInsert","queuedRemove","performChange","keyFromItem","queuedUpdate","findIndex","onItemRemoved","onItemInserted","itemRenderer","onDrop","drop","acceptItem","pendingValue","dropItem","onDragRemove","newItem","isCopy","altKey","metaKey","DragAndDropArea","handleDragEnter","dataTransfer","dropEffect","handleDragOver","bound","handleDrop","getData","alert","onDragEnter","onDragLeave","onDragOver","DragAndDropItem","dragging","Provider","onDragChange","ReverseListEditor","selected","onSelect","reverse","newValue","ListEditor","handleItemRemoved","handleItemInserted","renderReverse","showInsertTop","showInsertBottom","list","itemFactory","insertItems","acceptItemDrop","onItemChange","selectNew","items","newList","verticalEditors","StructEditor","typedefResolver","editor","AnyEditor","typedef","label","EnumStructEditor","typeVariants","typeName","ObnumEditor","newKey","itemType","TupleEditor","itemTypes","tuple","newTuple","getSizeOfInput","innerHTML","replace","appendChild","removeChild","ValidationErrorPopdown","validationError","StringEditor","input","multiline","widthMode","validate","spellCheck","editValue","setEditValue","setValidationError","committed","setCommitted","tryCommit","onBlur","useStringValidation","cn","KeyValueLayout","KeyValueLayoutRow","keyName","keyElement","KeyValueEditor","valueType","valueDefault","entryValue","oldKey","ColorEditor","showColorEditor","onChangeComplete","col","rgb","NumberEditorType","FileEditor","files","TableEditor","itemProperties","itemPropertiesLabels","arrayRemoveIndex","NumberEditor","inputRef","activeElement","focused","handleFocus","handleBlur","validity","badInput","onErrorChange","handleSlider","valueAsNumber","parseFloat","formatter","slider","inp","onFocus","suffix","PercentageEditor","SliderEditor","PixlingTimespanDefEditor","editorTypedefConvertibleToTypedef","asDropDown","true","false","propertyKey","propertyType","mappedType","PeriodType","TrainStatsScatterPlotKind","TrainStatsBattleground","Tabs","TitleComponent","titleComponent","BodyComponent","bodyComponent","selectedTab","tab","capitalizeFirstLetter","orientation","showTabBar","isActive","onTabChange","TabBody","defaultProps","expandedIndex","titleIndex","counter","grouped","groupName","handleClickTitle","aria-hidden","AppState","draggingUrl","scheduledTrainingIndex","scheduledEnd","changelog","BundledMarkdown","loadSource","fetch","linkTarget","leading","SessionRecorder","user","base62uuid","doc","collection","Db","sessions","clicksLastMinute","season","CurrentSeason","userId","uid","started","lastActive","minutesInteracting","appVersion","version","build","browser","getBrowser","screenSize","screen","isMobile","battles","trainings","FieldValue","increment","isDevelopment","auth","onAuthStateChanged","Current","onDocumentClick","onMinuteTicker","glMatrix","fromSphericalCoordinates","out","Cookies","cookie","IsInElectron","setPersistence","Auth","Persistence","SESSION","musicVolume","environmentVolume","soundEffectsVolume","advancedTrainingSettings","SeasonEndTime","Seasons","newRandomCreature","created","deleted","tags","randomRGB","createDefStyleFromBase","base","GymTeamStats","WebSocketAsync","host","readyState","WebSocket","CONNECTING","worker","Worker","URL","createObjectURL","OPEN","dispatchEvent","Event","CLOSED","CloseEvent","MessageEvent","postMessage","ArrayBuffer","EventTarget","DecisionKeys","RemoteClosedError","RemoteHost","regions","totalNArenas","runInWebWorker","agentRects","teamRects","nTeams","socket","connected","handle","messageQueue","waiting","sides","start_arena","n_arenas","binaryType","CLOSING","close","getRectsData","rects","padSenses","padKey","RemoteConnectionState","AllObservationKeys","GymTools","readRewards","ReadRewards","readSenses","ReadSenses","readTeamStats","ReadTeamStats","writeActions","WriteActions","DerkSession","tools","destroyedResolve","lastReward","pendingStep","creaturesTexture","teamStatsTexture","actionsTexture","SimpleProfiler","remoteHosts","rewardFunction","agentHosts","substeps","interleaved","debugNoObservations","debugNoActionsWrite","webWorkerSocket","gameState","disconnectAllRemotes","destroyWorldState","reward","uri","Connected","remoteHost","race","createNewWorldState","readTotalReward","getObservations","observations","stepInternal","randomCreatureItems","createWithMap","homeUnitCount","awayUnitCount","toCreate","normalizeUnit","handler","playPromise","prevStep","readStepActions","done","writeActionsToTexture","waitAnimationFrame","rewardDiff","teamStats","dumpJSON","arrayBufferToBase64","DerkGymAPI","session","getLatestVersion","json","latestVersion","semver","gt","newVersion","observationKeys","teamStatsKeys","dbgRenderInfo","UNMASKED_RENDERER_WEBGL","vendor","UNMASKED_VENDOR_WEBGL","CopyEntityComponents","outSlices","Reward","OpponentReward","acts","ArmItems","ItemKeys","slot","TailItems","MiscItems","GymState","GymStateContext","useGymState","useGymStateSelect","StatusBar","GymUI","showECS","setShowECS","GymAppInner","setWorldProgram","loaded","setLoaded","derk","GymApp","gymStateStore","MassUnits","EnergyUnits","HealthUnits","base62","basex","encode","uuid","hashCode","h","imul","charCodeAt","stringToRGBHex","toUpperCase","substring","intToRGBHex","stringToHSL","string","saturation","a2","shouldUpdate","formatNumberPrecision","precision","sign","log10","toLocaleString","unitFromMass","kg","massToUnit","mg","unitFromEnergy","MJ","energyToUnit","kJ","J","unitFromHealth","HP","healthToUnit","kHP","mHP","nHP","hex","dispatcher","EnumType","seed","generator","arbit","ms","charAt","userAgent","opera","substr","isNullOrUndefined","notNullOrUndefined","notFalsy","binary","bytes","len","byteLength","String","fromCharCode","performance","childrenTime","pop","total","childrenPerc","msToString","log2","gaussianBlurKernel3x3","sigma","kernel","euler","exp","sum","screenToWorld","point","clipSpaceToWorld","p1","p2","origin","direction","plane","denom","triangleWave","Vector3Typedef","toSphericalCoordinates","acos","toGlVec3","fromGlVec3","q","isNaNorInf","boxVolume","boxSurfaceArea"],"mappings":"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","file":"static/js/3.f86b0217.chunk.js","sourcesContent":["import { EditorTypedef } from \"../Components/Editors/EditorTypedefs\";\nimport * as Vector3 from \"./Vector3\";\nimport * as Vector2 from \"./Vector2\";\nimport { vec4, quat } from 'gl-matrix';\nimport * as Math2 from './Math';\n\nexport interface Vector4 {\n  x: number;\n  y: number;\n  z: number;\n  w: number;\n}\n\nexport const Vector4Typedef: EditorTypedef = {\n  metatype: 'struct',\n  properties: {\n    x: { metatype: 'float' },\n    y: { metatype: 'float' },\n    z: { metatype: 'float' },\n    w: { metatype: 'float' },\n  }\n}\n\nexport function create(xyzw: Vector4): Vector4;\nexport function create(xyzw: number): Vector4;\n\nexport function create(xyz: Vector3.Vector3, w: number): Vector4;\nexport function create(xy: Vector2.Vector2, zw: Vector2.Vector2): Vector4;\n// tslint:disable-next-line: unified-signatures\nexport function create(x: number, yzw: Vector3.Vector3): Vector4;\n\nexport function create(xy: Vector2.Vector2, z: number, w: number): Vector4;\nexport function create(x: number, yz: Vector2.Vector2, w: number): Vector4;\nexport function create(x: number, y: number, zw: Vector2.Vector2): Vector4;\n\nexport function create(x: number, y: number, z: number, w: number): Vector4;\nexport function create(...args: any[]): Vector4 {\n  if (args.length === 1) {\n    if (typeof args[0] === 'number') {\n      return { x: args[0], y: args[0], z: args[0], w: args[0] };\n    } else {\n      return {...args[0]};\n    }\n  } else if (args.length === 2) {\n    if (typeof args[0] === 'number') {\n      return { x: args[0], y: args[1].x, z: args[1].y, w: args[1].z };\n    } else if (typeof args[1] === 'number') {\n      return {...args[0], w: args[1] };\n    } else {\n      return {...args[0], z: args[1].x, w: args[1].y };\n    }\n  } else if (args.length === 3) {\n    if (typeof args[0] === 'object') {\n      return { x: args[0].x, y: args[0].y, z: args[1], w: args[2] };\n    } else if (args[1] === 'object') {\n      return { x: args[0], y: args[1].x, z: args[1].y, w: args[2] };\n    } else {\n      return { x: args[0], y: args[1], z: args[2].x, w: args[2].y };\n    }\n  } else {\n    return { x: args[0], y: args[1], z: args[2], w: args[3] };\n  }\n}\n\nexport function xy(v: Vector4): Vector2.Vector2 {\n  return { x: v.x, y: v.y };\n}\nexport function yz(v: Vector4): Vector2.Vector2 {\n  return { x: v.y, y: v.z };\n}\nexport function zw(v: Vector4): Vector2.Vector2 {\n  return { x: v.z, y: v.w };\n}\nexport function xyz(v: Vector4): Vector3.Vector3 {\n  return { x: v.x, y: v.y, z: v.z };\n}\nexport function yzw(v: Vector4): Vector3.Vector3 {\n  return { x: v.y, y: v.z, z: v.w };\n}\n\nexport function fromNumbers(numbers: number[] | Float32Array): Vector4 {\n  return { x: numbers[0], y: numbers[1], z: numbers[2], w: numbers[3] };\n}\n\nexport function toGlVec4({ x, y, z, w }: Vector4): vec4 {\n  return vec4.fromValues(x, y, z, w);\n}\nexport function fromGlVec4(vec: vec4): Vector4 {\n  return { x: vec[0], y: vec[1], z: vec[2], w: vec[3] };\n}\nexport function toArray({ x, y, z, w }: Vector4): [number, number, number, number] {\n  return [x, y, z, w];\n}\nexport function toGlQuat({ x, y, z, w }: Vector4): quat {\n  return quat.fromValues(x, y, z, w);\n}\n\n\nexport function add(a: Vector4, b: Vector4): Vector4 {\n  return { x: a.x + b.x, y: a.y + b.y, z: a.z + b.z, w: a.w + b.w };\n}\n\nexport function sub(a: Vector4, b: Vector4): Vector4 {\n  return { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z, w: a.w - b.w };\n}\n\nexport function scale(vec: Vector4, f: number): Vector4 {\n  return { x: vec.x * f, y: vec.y * f, z: vec.z * f, w: vec.w * f };\n}\n\nexport function mul(a: Vector4, b: Vector4): Vector4 {\n  return { x: a.x * b.x, y: a.y * b.y, z: a.z * b.z, w: a.w * b.w };\n}\nexport function div(a: Vector4, b: Vector4): Vector4 {\n  return { x: a.x / b.x, y: a.y / b.y, z: a.z / b.z, w: a.w / b.w };\n}\n\nexport function interpolate(value: Vector4, min: Vector4, max: Vector4, valueMin: Vector4, valueMax: Vector4): Vector4 {\n  const p = div(sub(value, min), sub(max, min));\n  return add(valueMin, mul(p, sub(valueMax, valueMin)));\n}\n\nexport function withoutNaNInf(v: Vector4): Vector4 {\n  return {\n    x: Math2.withoutNaNInf(v.x),\n    y: Math2.withoutNaNInf(v.y),\n    z: Math2.withoutNaNInf(v.z),\n    w: Math2.withoutNaNInf(v.w),\n  }\n}\n","export interface OutputRect {\n  x?: number;\n  y?: number;\n  width: number;\n  height: number;\n}\n\nexport function* createBatches(outputsLength: number, outputBatchSize: number) {\n  for (let l = 0; l < outputsLength; l += outputBatchSize) {\n    const count = l + outputBatchSize > outputsLength ? (outputsLength - l) : outputBatchSize;\n    yield { l, count };\n  }\n}\n","import { gaussianBlurKernel3x3 } from \"../Math/Math\";\nimport { glslFloat } from \".\";\n\nexport const PIGlsl = `\n#define PI 3.1415926535897932384626433832795\n`;\n\nexport const SimplexNoise2dGLSL = `\n// Simplex 2D noise, from: https://gist.github.com/patriciogonzalezvivo/670c22f3966e662d2f83\n//\nvec3 permute3d(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }\n\nfloat snoise2d(vec2 v){\n  const vec4 C = vec4(0.211324865405187, 0.366025403784439,\n          -0.577350269189626, 0.024390243902439);\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod(i, 289.0);\n  vec3 p = permute3d( permute3d( i.y + vec3(0.0, i1.y, 1.0 ))\n  + i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),\n    dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n`;\n\nexport const SimplexNoise3dGLSL = `\n//\tSimplex 3D Noise, from: https://gist.github.com/patriciogonzalezvivo/670c22f3966e662d2f83\n//\tby Ian McEwan, Ashima Arts\n//\nvec4 permute4d(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise3d(vec3 v){\n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C\n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 );\n  vec4 p = permute4d( permute4d( permute4d(\n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))\n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),\n                                dot(p2,x2), dot(p3,x3) ) );\n}\n`;\n\n// From https://stackoverflow.com/questions/4200224/random-noise-functions-for-glsl\nexport const RandomGLSL = `\nfloat rand(vec2 co){\n  return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\nfloat rands(vec2 co, float seed){\n  return rand(mod(co.xy + seed, 1.0));\n}\nfloat randss(vec2 co, float seed, float baseRand) {\n  return fract(rands(co, seed) + baseRand);\n}\n`;\n\nexport const RandomDeltaGLSL = `\nvec2 randomDelta(vec2 texcoord, float noiseSeed) {\n  float a = rands(texcoord, noiseSeed) * 2.0 * PI;\n  float dx = cos(a);\n  float dy = sin(a);\n  return round(vec2(dx, dy));\n}\n`;\n\n// /\\/\\/\\...\nexport const TriangleWaveGLSL = `\nfloat triangleWave(float v) {\n  return 1.0 - abs(mod(v, 2.0) - 1.0);\n}\nfloat triangleWave(float v, float m) {\n  return m - abs(mod(v, 2.0 * m) - m);\n}\nvec3 triangleWave(vec3 v) {\n  return 1.0 - abs(mod(v, 2.0) - 1.0);\n}\n`\n\n// https://math.stackexchange.com/questions/1671132/equation-for-a-smooth-staircase-function\nexport const SmoothStaircaseGLSL = `\nfloat smoothStaircase(float h, float w, float a, float x) {\n  return h * (0.5 * tanh(a*((x/w-floor(x/w))-0.5)) / tanh(a/2.0) + 0.5 + floor(x/w));\n}\n`\n\nexport const Rotate2DGLSL = `\nvec2 rotate2d(vec2 v, float a) {\n\tfloat s = sin(a);\n\tfloat c = cos(a);\n  mat2 m = mat2(c, s, -s, c);\n\treturn m * v;\n}\n`\n\n// Inverse rotation\nexport const Unrotate2DGLSL = `\nvec2 unrotate2d(vec2 v, float a) {\n\tfloat s = sin(a);\n\tfloat c = cos(a);\n  mat2 m = mat2(c, -s, s, c);\n\treturn m * v;\n}\n`\n\nconst InterpolateTGLSL = (xt: string, yt: string) => `\n${yt} interpolate(${xt} x, ${xt} x0, ${xt} x1, ${yt} y0, ${yt} y1) {\n  ${xt} p = (x - x0) / (x1 - x0);\n  return mix(y0, y1, p);\n}\n`;\nconst InterpolateClampedTGLSL = (xt: string, yt: string) => `\n${yt} interpolateClamped(${xt} x, ${xt} x0, ${xt} x1, ${yt} y0, ${yt} y1) {\n  ${xt} p = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return mix(y0, y1, p);\n}\n`;\nexport const InterpolateGLSL = `\n${InterpolateTGLSL('float', 'float')}\n${InterpolateTGLSL('float', 'vec3')}\n${InterpolateTGLSL('vec2', 'vec2')}\n${InterpolateTGLSL('vec3', 'vec3')}\n${InterpolateTGLSL('vec4', 'vec4')}\n\n${InterpolateClampedTGLSL('float', 'float')}\n${InterpolateClampedTGLSL('float', 'vec2')}\n${InterpolateClampedTGLSL('float', 'vec3')}\n${InterpolateClampedTGLSL('vec2', 'vec2')}\n${InterpolateClampedTGLSL('vec3', 'vec3')}\n${InterpolateClampedTGLSL('vec4', 'vec4')}\n`;\n\nexport const ColorLayer = `\nvec4 colorLayer3(vec4 c0, vec4 c1, vec4 c2) {\n  return vec4(mix(mix(c0.rgb, c1.rgb, c1.a), c2.rgb, c2.a), max(max(c0.a, c1.a), c2.a));\n}\nvec4 colorLayer4(vec4 c0, vec4 c1, vec4 c2, vec4 c3) {\n  return vec4(mix(mix(mix(c0.rgb, c1.rgb, c1.a), c2.rgb, c2.a), c3.rgb, c3.a), max(max(c0.a, c1.a), max(c2.a, c3.a)));\n}\n`;\n\nexport const SpritemapGLSL = `\nvec2 spritemapTexcoord(vec2 texcoord, uint index, uvec2 spritemapSize) {\n  vec2 offset = vec2(\n    float(index % spritemapSize.x),\n    float(index / spritemapSize.x)\n  );\n  return (texcoord + offset) / vec2(spritemapSize);\n}\nvec4 spritemap(sampler2D spritemapTexture, vec2 texcoord, uint index, uvec2 spritemapSize) {\n  return texture(spritemapTexture, spritemapTexcoord(texcoord, index, spritemapSize));\n}\n`;\n\nexport const MatrixGLSL = `\nmat4 translateMat4(vec3 position) {\n  return mat4(\n    1, 0, 0, 0,\n    0, 1, 0, 0,\n    0, 0, 1, 0,\n    position.x, position.y, position.z, 1\n  );\n}\nmat4 translateMat4(vec2 position) {\n  return mat4(\n    1, 0, 0, 0,\n    0, 1, 0, 0,\n    0, 0, 1, 0,\n    position.x, position.y, 0, 1\n  );\n}\nmat4 scaleMat4(vec3 scale) {\n  return mat4(\n    scale.x, 0, 0, 0,\n    0, scale.y, 0, 0,\n    0, 0, scale.z, 0,\n    0, 0, 0, 1\n  );\n}\nmat4 translateScaleMat4(vec3 position, vec3 scale) {\n  return mat4(\n    scale.x, 0, 0, 0,\n    0, scale.y, 0, 0,\n    0, 0, scale.z, 0,\n    position.x, position.y, position.z, 1\n  );\n}\nmat4 translateScaleMat4(vec2 position, vec2 scale) {\n  return mat4(\n    scale.x, 0, 0, 0,\n    0, scale.y, 0, 0,\n    0, 0, 1, 0,\n    position.x, position.y, 0, 1\n  );\n}\nmat4 rotateTranslateScaleMat4(vec4 quaternion, vec3 position, vec3 scale) {\n  // Quaternion math\n  float x = quaternion[0];\n  float y = quaternion[1];\n  float z = quaternion[2];\n  float w = quaternion[3];\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = scale[0];\n  float sy = scale[1];\n  float sz = scale[2];\n\n  return mat4(\n    (1.0 - (yy + zz)) * sx,\n    (xy + wz) * sx,\n    (xz - wy) * sx,\n    0.0,\n    (xy - wz) * sy,\n    (1.0 - (xx + zz)) * sy,\n    (yz + wx) * sy,\n    0.0,\n    (xz + wy) * sz,\n    (yz - wx) * sz,\n    (1.0 - (xx + yy)) * sz,\n    0.0,\n    position[0],\n    position[1],\n    position[2],\n    1.0\n  );\n}\nmat4 rotateX(float rad) {\n  float c = cos(rad);\n  float s = sin(rad);\n  return mat4(\n      1, 0, 0, 0,\n      0, c, s, 0,\n      0, -s, c, 0,\n      0, 0, 0, 1\n  );\n}\nmat4 rotateY(float rad) {\n  float c = cos(rad);\n  float s = sin(rad);\n  return mat4(\n      c, 0, -s, 0,\n      0, 1, 0, 0,\n      s, 0, c, 0,\n      0, 0, 0, 1\n  );\n}\nmat4 rotateZ(float rad) {\n  float c = cos(rad);\n  float s = sin(rad);\n  return mat4(\n      c, s, 0, 0,\n      -s, c, 0, 0,\n      0, 0, 1, 0,\n      0, 0, 0, 1\n  );\n}\n// From: https://www.geeks3d.com/20140807/billboarding-vertex-shader-glsl/\nmat4 toBillboard(mat4 modelView) {\n  modelView[0][0] = 1.0;\n  modelView[0][1] = 0.0;\n  modelView[0][2] = 0.0;\n\n  modelView[1][0] = 0.0;\n  modelView[1][1] = 1.0;\n  modelView[1][2] = 0.0;\n\n  modelView[2][0] = 0.0;\n  modelView[2][1] = 0.0;\n  modelView[2][2] = 1.0;\n  return modelView;\n}\n`\n\nexport const WithoutNaNInfGLSL = `\n// Seems like isnan isn't always working in WebGL: https://stackoverflow.com/questions/9446888/best-way-to-detect-nans-in-opengl-shaders\nbool isnanPolyfill( float val ) {\n  return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n}\nfloat withoutNaNInf(float v) {\n  return (isnanPolyfill(v) || isinf(v) || isnan(v)) ? 0.0 : v;\n}\nvec2 withoutNaNInf(vec2 v) {\n  return vec2(withoutNaNInf(v.x), withoutNaNInf(v.y));\n}\nvec3 withoutNaNInf(vec3 v) {\n  return vec3(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z));\n}\nvec4 withoutNaNInf(vec4 v) {\n  return vec4(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z), withoutNaNInf(v.w));\n}\n`\n\nexport const WorldPositionFromWorldTexcoordGLSL = `\nvec2 worldPositionFromWorldTexcoord(vec2 worldTexcoord, vec2 worldSize) {\n  return floor(worldTexcoord * worldSize);\n}\n`\n\nexport const WorldPositionFromCellIndexGLSL = `\nvec2 worldPositionFromCellIndex(int cellIndex, vec2 worldSize) {\n  return vec2(\n    cellIndex % int(worldSize.x),\n    cellIndex / int(worldSize.x)\n  );\n}\n`\n\nexport const CellIndexFromWorldTexcoordGLSL = `\nint cellIndexFromWorldTexcoord(vec2 worldTexcoord, vec2 worldSize) {\n  return int(floor(worldTexcoord.y * worldSize.y) * worldSize.x + floor(worldTexcoord.x * worldSize.x));\n}\n`\n\nexport function GaussianBlurGLSL(sigma: number, functionName = 'gaussianBlur') {\n  const kernel = gaussianBlurKernel3x3(sigma);\n  return `\nfloat ${functionName}(sampler2DArray source, ivec2 position, int sourceLayer, vec2 worldSize) {\n  vec2 pos = vec2(position);\n  float v0 = texelFetch(source, ivec3(mod(pos + vec2(-1, -1) + worldSize, worldSize), sourceLayer), 0).r;\n  float v1 = texelFetch(source, ivec3(mod(pos + vec2(0, -1) + worldSize, worldSize), sourceLayer), 0).r;\n  float v2 = texelFetch(source, ivec3(mod(pos + vec2(1, -1) + worldSize, worldSize), sourceLayer), 0).r;\n  float v3 = texelFetch(source, ivec3(mod(pos + vec2(-1, 0) + worldSize, worldSize), sourceLayer), 0).r;\n  float v4 = texelFetch(source, ivec3(mod(pos + vec2(0, 0), worldSize), sourceLayer), 0).r;\n  float v5 = texelFetch(source, ivec3(mod(pos + vec2(1, 0), worldSize), sourceLayer), 0).r;\n  float v6 = texelFetch(source, ivec3(mod(pos + vec2(-1, 1) + worldSize, worldSize), sourceLayer), 0).r;\n  float v7 = texelFetch(source, ivec3(mod(pos + vec2(0, 1), worldSize), sourceLayer), 0).r;\n  float v8 = texelFetch(source, ivec3(mod(pos + vec2(1, 1), worldSize), sourceLayer), 0).r;\n  return\n    v0 * ${glslFloat(kernel[0])} +\n    v1 * ${glslFloat(kernel[1])} +\n    v2 * ${glslFloat(kernel[2])} +\n    v3 * ${glslFloat(kernel[3])} +\n    v4 * ${glslFloat(kernel[4])} +\n    v5 * ${glslFloat(kernel[5])} +\n    v6 * ${glslFloat(kernel[6])} +\n    v7 * ${glslFloat(kernel[7])} +\n    v8 * ${glslFloat(kernel[8])};\n}\n`;\n}\n\nexport const BoxVolumeGLSL = `\nfloat boxVolume(vec3 box) {\n  return box.x * box.y * box.z;\n}\n`;\nexport const BoxSurfaceAreaGLSL = `\nfloat boxSurfaceArea(vec3 box) {\n  return 2.0 * box.x * box.y + 2.0 * box.y * box.z + 2.0 * box.z * box.x;\n}\nfloat boxSurfaceArea(vec4 box) {\n  return boxSurfaceArea(box.xyz);\n}\n`;\nexport const MaxdimGLSL = `\nfloat maxdim(vec3 val) {\n  return max(max(val.x, val.y), val.z);\n}\n`;\n\nexport const NormalFromHeightmapGLSL = `\nvec3 normalFromHeightmap(sampler2DArray heightmap, int layer, float scale, ivec2 samplePosition, ivec2 size) {\n  float heightUp = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, -1), ivec2(0), size), layer), 0).r;\n  float heightDown = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, 1), ivec2(0), size), layer), 0).r;\n  float heightLeft = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(-1, 0), ivec2(0), size), layer), 0).r;\n  float heightRight = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(1, 0), ivec2(0), size), layer), 0).r;\n  vec3 tangent = normalize(vec3(2.0, 0.0, (heightRight - heightLeft) * scale));\n  vec3 bitangent = normalize(vec3(0.0, 2.0, (heightDown - heightUp) * scale));\n  return normalize(cross(tangent, bitangent));\n}\n`\n\nexport const NormalFromHeightmap2GLSL = `\nvec3 normalFromHeightmap2(sampler2DArray heightmap, int layer1, int layer2, float scale, ivec2 samplePosition, ivec2 size) {\n  float height1Up = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, -1), ivec2(0), size), layer1), 0).r;\n  float height1Down = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, 1), ivec2(0), size), layer1), 0).r;\n  float height1Left = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(-1, 0), ivec2(0), size), layer1), 0).r;\n  float height1Right = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(1, 0), ivec2(0), size), layer1), 0).r;\n\n  float height2Up = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, -1), ivec2(0), size), layer2), 0).r;\n  float height2Down = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(0, 1), ivec2(0), size), layer2), 0).r;\n  float height2Left = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(-1, 0), ivec2(0), size), layer2), 0).r;\n  float height2Right = texelFetch(heightmap, ivec3(clamp(samplePosition + ivec2(1, 0), ivec2(0), size), layer2), 0).r;\n\n  float heightUp = height1Up + height2Up;\n  float heightDown = height1Down + height2Down;\n  float heightLeft = height1Left + height2Left;\n  float heightRight = height1Right + height2Right;\n\n  vec3 tangent = normalize(vec3(2.0, 0.0, (heightRight - heightLeft) * scale));\n  vec3 bitangent = normalize(vec3(0.0, 2.0, (heightDown - heightUp) * scale));\n  return normalize(cross(tangent, bitangent));\n}\n`\n\nexport const CubicPulseGLSL = `\nfloat cubicPulse( float c, float w, float x )\n{\n    x = abs(x - c);\n    if( x>w ) return 0.0;\n    x /= w;\n    return 1.0 - x*x*(3.0-2.0*x);\n}\n`;\n\nexport const IsZeroVecGLSL = `\nbool isZeroVec(ivec2 v) {\n  return v.x == 0 && v.y == 0;\n}\n`\n\nexport const GradientGLSL = (steps: number) => `\nvec3 gradient${steps}(float p, ${new Array(steps).fill(0).map((x, i) => `float x${i}, vec3 y${i}`).join(', ')}) {\n  if (p <= x0) {\n    return y0;\n  }\n  ${new Array(steps - 1).fill(0).map((x, i) => `\n  if (p <= x${i + 1}) {\n    return interpolate(p, x${i}, x${i + 1}, y${i}, y${i + 1});\n  }\n  `).join('\\n')}\n  return y${steps - 1};\n}\n`\n\nexport const LiterToCubicMeterGLSL = `\nfloat literToCubicMeter(float value) {\n  return value / 1000.0;\n}\nfloat cubicMeterToLiter(float value) {\n  return value * 1000.0;\n}\n`\n\nexport const InstancingCellPositionGLSL = (outputSizeVariable, offset?: string) => `\ncellPos = ivec2(\n  gl_InstanceID % ${outputSizeVariable}.x,\n  ${outputSizeVariable}.y - 1 - gl_InstanceID / ${outputSizeVariable}.x\n)${offset ? ` + ${offset}` : ''};\n`;\n\nexport const LandscapeGLSL = `\n\nfloat landscapeN11(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale) {\n  return\n    snoise2d((worldPos + noiseOffset + noiseOffsets[0]) * scale) / 2.0 +\n    snoise2d((worldPos + noiseOffset + noiseOffsets[1]) * scale * 2.0) / 4.0 +\n    snoise2d((worldPos + noiseOffset + noiseOffsets[2]) * scale * 4.0) / 8.0 +\n    snoise2d((worldPos + noiseOffset + noiseOffsets[3]) * scale * 8.0) / 16.0;\n}\nfloat landscape01(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale) {\n  return 0.5 + 0.5 * landscapeN11(worldPos, noiseOffsets, noiseOffset, scale);\n}\nfloat landscape(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale, float minHeight, float maxHeight) {\n  return mix(minHeight, maxHeight, landscape01(worldPos, noiseOffsets, noiseOffset, scale));\n}\nfloat ridgedLandscape01(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale) {\n  return 1.0 - abs(landscapeN11(worldPos, noiseOffsets, noiseOffset, scale));\n}\nfloat ridgedLandscape(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale, float minHeight, float maxHeight) {\n  return mix(minHeight, maxHeight, ridgedLandscape01(worldPos, noiseOffsets, noiseOffset, scale));\n}\n\nfloat ridgedLandscape2(vec2 worldPos, vec2 noiseOffsets[4], float noiseOffset, vec2 scale, float minHeight, float maxHeight) {\n  float p =\n    (1.0 - abs(snoise2d((worldPos + noiseOffset + noiseOffsets[0]) * scale))) / 2.0 +\n    (1.0 - abs(snoise2d((worldPos + noiseOffset + noiseOffsets[1]) * scale * 2.0))) / 4.0 +\n    (1.0 - abs(snoise2d((worldPos + noiseOffset + noiseOffsets[2]) * scale * 4.0))) / 8.0 +\n    (1.0 - abs(snoise2d((worldPos + noiseOffset + noiseOffsets[3]) * scale * 8.0))) / 16.0;\n  return mix(minHeight, maxHeight, p);\n}\n\n`\n\n// From: https://gist.github.com/shaunlebron/8832585\nexport const AngleLerpGLSL = `\nfloat shortestAngleDist(float a0, float a1) {\n  float max = PI * 2.0;\n  float da = mod((a1 - a0), max);\n  return mod(2.0 * da, max) - da;\n}\n\nfloat angleLerp(float a0, float a1, float t) {\n  return a0 + shortestAngleDist(a0, a1) * t;\n}\n`\n\n// From: https://gamedev.stackexchange.com/questions/59797/glsl-shader-change-hue-saturation-brightness\nexport const HSLToRGBGLSL = `\nvec3 hsl2rgb(vec3 c)\n{\n    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\n`\n\nexport const FromSphericalCoordinatesGLSL = `\nvec3 fromSphericalCoordinates(float theta, float phi, float radius) {\n  return vec3(\n    sin(theta) * cos(phi) * radius,\n    sin(theta) * sin(phi) * radius,\n    cos(theta) * radius\n  );\n}\n`\n\nexport const BitCheckedUInt32GLSL = `\nbool bitCheckedUInt32(uint value, uint bitIndex) {\n  return bool(value & (1u << bitIndex));\n}\n`;\n\nexport const FlipBitUInt32GLSL = `\nuint flipBitUInt32(uint value, uint bitIndex) {\n  return value ^ (1u << bitIndex);\n}\n`;\n\nexport const SampleSoftmaxGLSL = (count: number) => `\nint sampleSoftmax${count}(float p, ${new Array(count).fill(0).map((_, i) => `float value${i}`).join(', ')}) {\n\n  float sum = 0.0;\n  ${new Array(count).fill(0).map((_, i) => `\n  float valueExp${i} = exp(value${i});\n  sum += valueExp${i};\n  `).join('\\n')}\n\n  float cumulative = 0.0;\n  ${new Array(count).fill(0).map((_, i) => `\n  cumulative += valueExp${i} / sum;\n  if (p < cumulative) {\n    return ${i};\n  }\n  `).join('\\n')}\n  return 0;\n}\n`;\n\n// Sorted by .w component. Highest w goes first\nexport const InsertSortedGLSL = (nValues: number) => `\nvoid insertSorted(inout vec4 values[${nValues}], vec4 newValue) {\n  for (int i = 0; i < ${nValues}; i++) {\n    // It's already in the array\n    if (newValue.xyz == values[i].xyz) {\n      return;\n    }\n    // Insert sorted\n    if (newValue.w > values[i].w) {\n      for (int l = ${nValues - 1}; l > i; l--) {\n        values[l] = values[l - 1];\n      }\n      values[i] = newValue;\n      return;\n    }\n  }\n}\n`\n\nexport const CellToIndexGLSL = `\nivec2 indexToCell(ivec2 size, int index) {\n  return index < 0 ? ivec2(-1) : ivec2(index % size.x, index / size.x );\n}\nint cellToIndex(ivec2 size, ivec2 cell) {\n  return cell.y * size.width + cell.x;\n}\n`","import * as _ from 'lodash';\nimport { Vector2 } from \"../Math/Vector2\";\nimport { PIGlsl } from './Glsl';\nimport { Vector4 } from '../Math/Vector4';\nimport { Vector3 } from '../Math/Vector3';\n\nexport const shaderHeader = `#version 300 es\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler2DArray;\nprecision highp isampler2D;\nprecision highp isampler2DArray;\nprecision highp usampler2D;\nprecision highp usampler2DArray;\n`;\n\nconst CellPosDefines = [\n  `#define cellPos ivec2(gl_FragCoord.xy)`,\n  `#define cellPos3(l) ivec3(gl_FragCoord.xy, l)`,\n];\nexport const CellPosDefinesGLSL = CellPosDefines.join('\\n');\nexport const computationShaderHeader = shaderHeader + `\n${PIGlsl}\n${CellPosDefinesGLSL}\n`;\n\nexport function glslFloat(value: number): string {\n  if (_.isNaN(value)) {\n    return '0.0';\n  } else if (value === Math.floor(value)) {\n    return value + '.0';\n  } else {\n    return '' + value;\n  }\n}\nexport function glslInt(value: number): string {\n  if (_.isNaN(value)) {\n    return '0';\n  } else {\n    return '' + Math.floor(value);\n  }\n}\nexport function glslUInt(value: number): string {\n  if (_.isNaN(value)) {\n    return '0';\n  } else {\n    return '' + Math.abs(Math.floor(value)) + 'u';\n  }\n}\nexport function glslBool(value: number | boolean): string {\n  if (_.isNaN(value)) {\n    return 'false';\n  } else {\n    return value ? 'true' : 'false';\n  }\n}\nexport function glslVec2(value: Vector2): string {\n  return `vec2(${glslFloat(value.x)}, ${glslFloat(value.y)})`;\n}\nexport function glslVec3(value: Vector3): string {\n  return `vec3(${glslFloat(value.x)}, ${glslFloat(value.y)}, ${glslFloat(value.z)})`;\n}\nexport function glslVec4(value: Vector4): string {\n  return `vec4(${glslFloat(value.x)}, ${glslFloat(value.y)}, ${glslFloat(value.z)}, ${glslFloat(value.w)})`;\n}\nexport function glslUVec2(value: Vector2): string {\n  return `uvec2(${glslInt(value.x)}, ${glslInt(value.y)})`;\n}\nexport function glslIVec2(value: Vector2): string {\n  return `ivec2(${glslInt(value.x)}, ${glslInt(value.y)})`;\n}\n\nexport function temporaryWrapGlForErrors(gl: WebGL2RenderingContext, ms: number = 2000) {\n  wrapGlForErrors(gl);\n  setTimeout(() => unwrapGlForErrors(gl), ms);\n}\nexport function wrapGlForErrors(gl: WebGL2RenderingContext) {\n  gl = gl as any;\n  (gl as any).errorWraps = (gl as any).errorWraps !== undefined ? ((gl as any).errorWraps + 1) : 1;\n  if ((gl as any).errorWraps > 1) {\n    return;\n  }\n  const glGetError = gl.getError;\n  // tslint:disable-next-line:forin\n  for (const k in gl) {\n    const f = gl[k];\n    if (_.isFunction(f)) {\n      gl[k] = (...args) => {\n        handleGlError(gl, `before ${k}`, glGetError);\n        const res = f.apply(gl, args);\n        handleGlError(gl, `after ${k}`, glGetError);\n        return res;\n      }\n      gl[k].originalFunction = f;\n    }\n  }\n}\nexport function unwrapGlForErrors(gl: WebGL2RenderingContext) {\n  gl = gl as any;\n  (gl as any).errorWraps = (gl as any).errorWraps !== undefined ? ((gl as any).errorWraps - 1) : 0;\n  if ((gl as any).errorWraps > 0) {\n    return;\n  }\n  // tslint:disable-next-line:forin\n  for (const k in gl) {\n    const f = gl[k];\n    if (f.originalFunction) {\n      gl[k] = f.originalFunction;\n    }\n  }\n}\nexport function getGlConstantName(gl: WebGL2RenderingContext, constant: number) {\n  gl = gl as any;\n  // tslint:disable-next-line:forin\n  for (const k in gl) {\n    if (gl[k] === constant) {\n      return k;\n    }\n  }\n  return `Unknown constant: ${constant}`;\n}\nexport function handleGlError(gl: WebGL2RenderingContext, context: string = '', glGetError = gl.getError) {\n  const err = glGetError.apply(gl);\n  if (err !== gl.NO_ERROR) {\n    // tslint:disable-next-line:no-console\n    console.error(`Gl error ${context}: ${err} ${getGlConstantName(gl, err)}`);\n  }\n}\n\n\nexport function cleanVarName(name: string): string {\n  return name.replace(/\\W+/g, '');\n}\n\nexport function initGlExtensions(gl: WebGL2RenderingContext): string[] {\n  const missing: string[] = [];\n  if (!gl.getExtension(\"EXT_color_buffer_float\")) {\n    missing.push('EXT_color_buffer_float');\n  }\n  if (!gl.getExtension('OES_texture_float_linear')) {\n    missing.push('OES_texture_float_linear');\n  }\n  return missing;\n}\n\nexport function loadImage(url: string) {\n  return new Promise<HTMLImageElement>((resolve) => {\n    const image = new Image();\n    image.src = url;\n    image.addEventListener('load', () => resolve(image))\n  })\n}\n\nexport function loadArrayBuffer(url: string): Promise<ArrayBuffer> {\n  return new Promise((resolve) => {\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', url, true);\n    xhr.responseType = 'arraybuffer';\n    xhr.onload = () => {\n      resolve(xhr.response);\n    };\n    xhr.send();\n  });\n}\n","import * as React from 'react';\nimport { GlState } from \"../../GpuUtil/GlState\";\n\ninterface GlUnitTest {\n  name: string;\n  test: (gls: GlState) => void | Promise<void>;\n}\n\nexport const GlUnitTests: GlUnitTest[] = [];\n\nexport function RunGlUnitTests() {\n  const [results, setResults] = React.useState<{ [name: string]: string }>({});\n  const canvas = React.useRef<HTMLCanvasElement | null>(null);\n  React.useEffect(() => {\n    if (canvas.current) {\n      (async () => {\n        const gl = canvas.current!.getContext('webgl2')!;\n        const gls = new GlState(canvas.current!, gl);\n        let res = {};\n        for (const test of GlUnitTests) {\n          res = {...res, [test.name]: 'running...' };\n          setResults(res);\n          try {\n            let r = test.test(gls);\n            if (r instanceof Promise) {\n              r = await r;\n            }\n            res = {...res, [test.name]: 'ok' };\n            setResults(res);\n          } catch (err) {\n            res = {...res, [test.name]: err.toString() };\n            setResults(res);\n          }\n        }\n      })();\n    }\n  }, []);\n  return <div>\n    <canvas width={1} height={1} ref={canvas} />\n    {Object.keys(results).map((k) => <div key={k}>{k}: {results[k]}</div>)}\n  </div>\n}","import { Image, ImageDataType } from './Image';\nimport { Texture, DoubleBufferedTexture, TextureSlicing, DoubleBufferedTextureSlicing } from './Texture';\nimport lodash from 'lodash';\nimport { GlState, Destructible } from './GlState';\nimport { createBatches } from './Computation';\nimport { getGlConstantName } from '.';\nimport { GlUnitTests } from '../SteamApp/Test/GlUnitTests';\n\nexport interface ResolvedReadRect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\nexport type ReadRect = Partial<ResolvedReadRect>;\nfunction resolveReadRectForTexture(texture: Texture | DoubleBufferedTexture, readRect: ReadRect): ResolvedReadRect {\n  return {\n    x: readRect.x !== undefined ? readRect.x : 0,\n    y: readRect.y !== undefined ? readRect.y : 0,\n    width: readRect.width !== undefined ? readRect.width : texture.size!.width,\n    height: readRect.height !== undefined ? readRect.height : texture.size!.height,\n  };\n}\n\nexport class TextureReadPollOptions {\n  checkPeriod = 16;\n  maxNPeriods = 4000; // After this it will just try to wait for the read\n}\n\ninterface TextureReaderConfig {\n  reuseBuffer?: boolean;\n}\n\ninterface ITextureReader {\n  destroy(): void;\n  read<T extends ImageDataType = Float32Array>(mode: 'poll', readRect: ReadRect, pollOpts?: TextureReadPollOptions): Promise<Image<T>>;\n  read<T extends ImageDataType = Float32Array>(mode: 'block', readRect: ReadRect): Image<T>;\n  read<T extends ImageDataType = Float32Array>(mode: 'background', readRect: ReadRect): () => Image<T>;\n}\n\nexport type TextureReadMode = 'block' | 'poll' | 'background';\n\n// A buffered texture reader; can be used multiple times, but the same image buffer is reused\nexport class TextureReader implements ITextureReader, Destructible {\n  constructor(private textureSlicing: TextureSlicing, private config: TextureReaderConfig = {}) {\n    const texture = textureSlicing.texture;\n    const slices = textureSlicing.layers || [0];\n    const gl = texture.gls.gl;\n    if (texture.internalFormat === gl.R32F) {\n      // For some reason RED/FLOAT doesn't work, so we have to read it to a larger image first and then downsample that image\n      this.format = gl.RGBA;\n      this.type = gl.FLOAT;\n      this.packAlignment = 4;\n    } else if (texture.internalFormat === gl.RGBA32F) {\n      this.format = gl.RGBA;\n      this.type = gl.FLOAT;\n      this.packAlignment = 4;\n    } else if (texture.internalFormat === gl.R32I) {\n      // Same problem as R32F, but only on ubuntu\n      this.format = gl.RGBA_INTEGER;\n      this.type = gl.INT;\n      this.packAlignment = 4;\n    } else if (texture.internalFormat === gl.RGBA32I) {\n      this.format = gl.RGBA_INTEGER;\n      this.type = gl.INT;\n      this.packAlignment = 4;\n    } else if (texture.internalFormat === gl.R8UI) {\n      this.format = gl.RED_INTEGER;\n      this.type = gl.UNSIGNED_BYTE;\n      this.packAlignment = 1;\n    } else if (texture.internalFormat === gl.RGBA8UI) {\n      this.format = gl.RGBA_INTEGER;\n      this.type = gl.UNSIGNED_BYTE;\n      this.packAlignment = 4;\n    } else {\n      throw new Error('Not implemented yet');\n    }\n\n    this.batches = Array.from(createBatches(slices.length, this.gls.maxColorAttachements));\n    this.fbs = this.batches.map(() => this.gls.gl.createFramebuffer());\n\n    for (let l = 0; l < this.fbs.length; l++) {\n      this.texture.gls.framebuffer = this.fbs[l];\n      const batch = this.batches[l];\n      for (let i=0; i < batch.count; i++) {\n        if (this.texture.is2dArray) {\n          const layer = slices[batch.l + i];\n          if (layer < 0 || layer >= this.texture.depth!) {\n            throw new Error(`Layer out of range`);\n          }\n          gl.framebufferTextureLayer(gl.READ_FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + i, this.texture.texture, 0, layer);\n        } else {\n          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + i, gl.TEXTURE_2D, this.texture.texture, 0);\n        }\n      }\n    }\n\n  }\n  destroy() {\n    for (const fb of this.fbs) {\n      this.gls.gl.deleteFramebuffer(fb);\n    }\n  }\n  private texture = this.textureSlicing.texture;\n  private gls = this.texture.gls;\n  private batches: Array<{ l: number, count: number }>;\n  private fbs: Array<WebGLFramebuffer | null>;\n  private format: number;\n  private type: number;\n  private packAlignment: number;\n  private img?: Image<Float32Array> | Image<Int32Array> | Image<Uint8Array>;\n  private imgOutBuffer?: Image<Float32Array> | Image<Int32Array> | Image<Uint8Array>;\n\n  private createImgBuffer(r: ResolvedReadRect) {\n    const gl = this.gls.gl;\n    if (this.texture.internalFormat === gl.R32F) {\n      // For some reason RED/FLOAT doesn't work, so we have to read it to a larger image first and then downsample that image\n      this.img = Image.zeroesF32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 4);\n      this.imgOutBuffer = Image.zeroesF32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 1);\n    } else if (this.texture.internalFormat === gl.RGBA32F) {\n      this.img = Image.zeroesF32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 4);\n    } else if (this.texture.internalFormat === gl.R32I) {\n      // Same problem as R32F, but only on ubuntu\n      this.img = Image.zeroesI32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 4);\n      this.imgOutBuffer = Image.zeroesI32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 1);\n    } else if (this.texture.internalFormat === gl.RGBA32I) {\n      this.img = Image.zeroesI32({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 4);\n    } else if (this.texture.internalFormat === gl.R8UI) {\n      this.img = Image.zeroesU8({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 1);\n    } else if (this.texture.internalFormat === gl.RGBA8UI) {\n      this.img = Image.zeroesU8({ width: r.width, height: r.height, depth: this.textureSlicing.count }, 4);\n    } else {\n      throw new Error('Not implemented yet');\n    }\n  }\n\n  readAndDestroy<T extends ImageDataType = Float32Array>(mode: 'poll', readRect: ReadRect, pollOpts?: TextureReadPollOptions): Promise<Image<T>>;\n  readAndDestroy<T extends ImageDataType = Float32Array>(mode: 'block', readRect: ReadRect): Image<T>;\n  readAndDestroy<T extends ImageDataType = Float32Array>(mode: 'background', readRect: ReadRect): () => Image<T>;\n  readAndDestroy(mode: TextureReadMode, readRect: ReadRect, asyncOpts?: TextureReadPollOptions): any {\n    if (mode === 'poll') {\n      return this.read('poll', readRect, asyncOpts).then(res => {\n        this.destroy();\n        return res;\n      });\n    } else if (mode === 'background') {\n      const r = this.read('background', readRect);\n      return () => {\n        const img = r();\n        this.destroy();\n        return img;\n      }\n    } else {\n      const res = this.read('block', readRect);\n      this.destroy();\n      return res;\n    }\n  }\n\n  read<T extends ImageDataType = Float32Array>(mode: 'poll', readRect: ReadRect, pollOpts?: TextureReadPollOptions): Promise<Image<T>>;\n  read<T extends ImageDataType = Float32Array>(mode: 'block', readRect: ReadRect): Image<T>;\n  read<T extends ImageDataType = Float32Array>(mode: 'background', readRect: ReadRect): () => Image<T>;\n  read(mode: TextureReadMode, readRect: ReadRect, pollOpts: TextureReadPollOptions = new TextureReadPollOptions()): any {\n    const gl = this.texture.gls.gl;\n    const r = resolveReadRectForTexture(this.texture, readRect);\n    if (!this.config.reuseBuffer || !this.img || this.img.size.width !== r.width || this.img.size.height !== r.height) {\n      this.createImgBuffer(r);\n    }\n    const img = this.img!;\n    const imgOutBuffer = this.imgOutBuffer;\n\n    let buff;\n    if (mode !== 'block') {\n      buff = gl.createBuffer();\n      gl.bindBuffer(gl.PIXEL_PACK_BUFFER, buff);\n      gl.bufferData(gl.PIXEL_PACK_BUFFER, img.sizeInBytes, gl.STREAM_READ);\n    }\n\n    gl.pixelStorei(gl.PACK_ALIGNMENT, this.packAlignment);\n\n    const layerSize = img.sizeInBytes / img.size.depth;\n\n    for (let l=0; l < this.batches.length; l++) {\n      this.texture.gls.framebuffer = this.fbs[l];\n      const batch = this.batches[l];\n      for (let x=0; x < batch.count; x++) {\n        gl.readBuffer(gl.COLOR_ATTACHMENT0 + x);\n        const i = batch.l + x;\n        if (mode !== 'block') {\n          gl.readPixels(r.x, r.y, r.width, r.height, this.format, this.type, i * layerSize);\n        } else {\n          gl.readPixels(r.x, r.y, r.width, r.height, this.format, this.type, img.data, i * layerSize / img.channelSize);\n        }\n      }\n    }\n\n    let syncObject;\n    if (mode !== 'block') {\n      syncObject = gl.fenceSync(gl.SYNC_GPU_COMMANDS_COMPLETE, 0);\n    }\n\n    const textureFormat = this.texture.internalFormat;\n\n    const resolveImage = () => {\n      const gl = this.gls.gl;\n      if (textureFormat === gl.R32F || textureFormat === gl.R32I) {\n        // Because we can't use gl.RED above..\n        const res = imgOutBuffer!;\n        for (let i=0; i < res.data.length; i++) {\n          res.data[i] = img.data[i * 4];\n        }\n        return res;\n      } else {\n        return img;\n      }\n    }\n\n    if (mode === 'poll' || mode === 'background') {\n      gl.bindBuffer(gl.PIXEL_PACK_BUFFER, null);\n\n      const check = (timeout = 0) => {\n        const s = gl.clientWaitSync(syncObject, 0, timeout);\n        if (s === gl.ALREADY_SIGNALED || s === gl.CONDITION_SATISFIED) {\n          gl.bindBuffer(gl.PIXEL_PACK_BUFFER, buff);\n          gl.getBufferSubData(gl.PIXEL_PACK_BUFFER, 0, img.data);\n          gl.bindBuffer(gl.PIXEL_PACK_BUFFER, null);\n          gl.deleteSync(syncObject);\n          return resolveImage();\n        } else {\n          return null;\n        }\n      }\n\n      if (mode === 'background') {\n        return check;\n      } else {\n        return new Promise((resolve, reject) => {\n          const checksCounter = { n: 0 };\n          const checker = window.setInterval(() => {\n            checksCounter.n++;\n            const isMaxPeriods = checksCounter.n >= pollOpts.maxNPeriods;\n            if (isMaxPeriods) {\n              console.warn(`Reached max check periods (${pollOpts.maxNPeriods}) while trying to read texture (${this.texture.name})`);\n            }\n            if (this.gls.contextLost) {\n              console.warn(`Silently failing texture read due to context lost`);\n              window.clearInterval(checker);\n              return;\n            }\n            const img = check(isMaxPeriods ? gl.MAX_CLIENT_WAIT_TIMEOUT_WEBGL : 0);\n            if (img) {\n              resolve(img);\n              window.clearInterval(checker);\n            } else if (isMaxPeriods) {\n              window.clearInterval(checker);\n              reject('Texture read timeout');\n            }\n          }, pollOpts.checkPeriod);\n        });\n      }\n    } else {\n      return resolveImage();\n    }\n  }\n}\n\nexport class DoubleBufferedTextureReader implements ITextureReader {\n  constructor(private textureSlice: DoubleBufferedTextureSlicing, private config?: TextureReaderConfig) {\n  }\n  destroy() {\n    this.read0.destroy();\n    this.read1.destroy();\n  }\n  private read0 = new TextureReader(this.textureSlice.texture0, this.config);\n  private read1 = new TextureReader(this.textureSlice.texture1, this.config);\n\n  read<T extends ImageDataType = Float32Array>(mode: 'poll', readRect: ReadRect, pollOpts?: TextureReadPollOptions): Promise<Image<T>>;\n  read<T extends ImageDataType = Float32Array>(mode: 'block', readRect: ReadRect): Image<T>;\n  read<T extends ImageDataType = Float32Array>(mode: 'background', readRect: ReadRect): () => Image<T>;\n  read(mode: TextureReadMode, readRect: ReadRect, pollOpts?: TextureReadPollOptions): any {\n    if (this.textureSlice.texture.swapped) {\n      return this.read0.read(mode as any, readRect, pollOpts);\n    } else {\n      return this.read1.read(mode as any, readRect, pollOpts);\n    }\n  }\n}\n\nexport class LazyTextureReader implements ITextureReader {\n  constructor(private createReader: () => ITextureReader) {\n  }\n  destroy() {\n    if (this.reader) {\n      this.reader.destroy();\n    }\n  }\n  private reader?: ITextureReader;\n\n  read<T extends ImageDataType = Float32Array>(mode: 'poll', readRect: ReadRect, pollOpts?: TextureReadPollOptions): Promise<Image<T>>;\n  read<T extends ImageDataType = Float32Array>(mode: 'block', readRect: ReadRect): Image<T>;\n  read<T extends ImageDataType = Float32Array>(mode: 'background', readRect: ReadRect): () => Image<T>;\n  read(mode: TextureReadMode, readRect: ReadRect, pollOpts?: TextureReadPollOptions): any {\n    if (!this.reader) {\n      this.reader = this.createReader();\n    }\n    return this.reader.read(mode as any, readRect, pollOpts);\n  }\n}\n\nconst textureReaderTest = async (gls: GlState, original: Image<Float32Array> | Image<Int32Array> | Image<Uint8Array>, async: boolean) => {\n  const tex = original.toGl(gls);\n  const testName = `${async ? 'async' : 'sync'} ${getGlConstantName(gls.gl, tex.internalFormat)} ${tex.is2dArray ? '2darray' : '2d'} depth=${original.size.depth}`;\n  // tslint:disable-next-line:no-console\n  console.log(`Testing image read: ${testName}...`);\n  const slice = tex.sliceRange(0, original.size.depth);\n  const downloaded = async ? await Image.readTextureAsync(slice) : Image.readTextureSync(slice);\n  if (!lodash.isEqual(original.data, downloaded.data)) {\n    // tslint:disable-next-line:no-console\n    console.log('Original');\n    original.dump();\n    // tslint:disable-next-line:no-console\n    console.log('Downloaded');\n    downloaded.dump();\n    throw new Error(`Image reads differ for ${testName}`);\n  }\n}\n\nfor (const depth of [1, 3, 11]) {\n  for (const channels of [1, 4]) {\n    const size = { width: 3, height: 3, depth };\n    for (const asyncr of [true, false]) {\n      GlUnitTests.push({\n        name: `TextureReader depth=${depth} channels=${channels} async=${asyncr} f32`,\n        test: gls => textureReaderTest(gls, Image.zeroesF32(size, channels).randomize(), asyncr)\n      });\n      GlUnitTests.push({\n        name: `TextureReader depth=${depth} channels=${channels} async=${asyncr} i32`,\n        test: gls => textureReaderTest(gls, Image.zeroesI32(size, channels).randomize(0, 6000), asyncr)\n      });\n      GlUnitTests.push({\n        name: `TextureReader depth=${depth} channels=${channels} async=${asyncr} u8`,\n        test: gls => textureReaderTest(gls, Image.zeroesU8(size, channels).randomize(0, 255), asyncr)\n      });\n    }\n  }\n}\n","import { mod, Size, Size3, Rect } from '../Math/Math';\nimport * as Vector2 from '../Math/Vector2';\nimport * as Vector3 from '../Math/Vector3';\nimport { RandomSeedable } from '../Util';\nimport { Texture, DoubleBufferedTexture, TextureSlicing } from './Texture';\nimport * as Vector4 from '../Math/Vector4';\nimport { ReadRect, TextureReader, TextureReadPollOptions } from './TextureReader';\nimport { GlState } from './GlState';\nimport { EXRLoader } from 'three/examples/jsm/loaders/EXRLoader';\nimport * as THREE from 'three';\nimport { loadArrayBuffer } from '.';\n\nexport function mapLayerInplace(data: Float32Array, layer: number, size: Size, map: (value: number) => number) {\n  for (let y=0; y < size.height; y++) {\n    for (let x=0; x < size.width; x++) {\n      const index = imageIndex3dr(size, x, y, layer);\n      data[index] = map(data[index]);\n    }\n  }\n}\n\nexport function copyLayer(source: Float32Array, sourceLayer: number, target: Float32Array, targetLayer: number, size: Size) {\n  for (let y=0; y < size.height; y++) {\n    for (let x=0; x < size.width; x++) {\n      target[imageIndex3dr(size, x, y, targetLayer)] = source[imageIndex3dr(size, x, y, sourceLayer)];\n    }\n  }\n}\n\nexport function insertLayer(data: Float32Array, originalSize: Size3, newLayerIndex: number, value: number = 0) {\n  const newData = new Float32Array(originalSize.width * originalSize.height * (originalSize.depth + 1));\n  newData.fill(value);\n  for (let z = 0; z < originalSize.depth; z++) {\n    copyLayer(data, z, newData, z + (z >= newLayerIndex ? 1 : 0), originalSize);\n  }\n  return newData;\n}\n\nfunction imageIndex3dr(size: Size, x: number, y: number, z: number): number {\n  return imageIndex(size, 1, x, y, z, 0);\n}\n\nfunction imageIndex(size: Size, channels: number, x: number, y: number, z: number, channel: number): number {\n  return ((z * size.height + y) * size.width + x) * channels + channel;\n}\nfunction imagePosition(size: Size, channels: number, index: number): Vector4.Vector4 {\n  const channel = index % channels;\n  index = Math.floor(index / channels);\n  const x = index % size.width;\n  index = Math.floor(index / size.width);\n  const y = index % size.height;\n  index = Math.floor(index / size.height);\n  const z = index;\n  return Vector4.create(x, y, z, channel);\n}\n\nfunction threePixelFormatChannels(pixelFormat: THREE.PixelFormat) {\n  switch (pixelFormat) {\n    case THREE.AlphaFormat: return 1;\n    case THREE.RGBFormat: return 3;\n    case THREE.RGBAFormat: return 4;\n    case THREE.LuminanceFormat: return 1;\n    case THREE.LuminanceAlphaFormat: return 2;\n    case THREE.RGBEFormat: return 4;\n    case THREE.DepthFormat: return 1;\n    case THREE.DepthStencilFormat: return 2;\n    case THREE.RedFormat: return 1;\n    case THREE.RedIntegerFormat: return 1;\n    case THREE.RGFormat: return 2;\n    case THREE.RGIntegerFormat: return 2;\n    case THREE.RGBIntegerFormat: return 3;\n    case THREE.RGBAIntegerFormat: return 4;\n    default: throw new Error(`Unrecognized THREE pixel format: ${pixelFormat}`);\n  }\n}\n\nexport type ImageDataType = Float32Array | Int32Array | Uint8Array;\n\nexport class Image<T extends ImageDataType = Float32Array> {\n  constructor(public data: T, public size: Size3, public channels: number) {}\n  get channelSize() {\n    if (this.data instanceof Float32Array || this.data instanceof Int32Array) {\n      return 4;\n    } else {\n      return 1;\n    }\n  }\n  get sizeInBytes() {\n    return this.data.length * this.channelSize;\n  }\n  static zeroes<T extends ImageDataType = Float32Array>(arrayConstructor: new (length: number) => T, size: Size3, channels: number) {\n    const data = new arrayConstructor(size.width * size.height * size.depth * channels);\n    return new Image(data, size, channels);\n  }\n  static zeroesF32(size: Size3, channels: number) {\n    return Image.zeroes(Float32Array, size, channels);\n  }\n  static zeroesI32(size: Size3, channels: number) {\n    return Image.zeroes(Int32Array, size, channels);\n  }\n  static zeroesU8(size: Size3, channels: number) {\n    return Image.zeroes(Uint8Array, size, channels);\n  }\n  static exrLoader = new EXRLoader();\n  static fromEXRBuffer(buffer: ArrayBuffer) {\n    const exr = Image.exrLoader.parse(buffer);\n    return new Image(exr.data, { width: exr.width, height: exr.height, depth: 1 }, threePixelFormatChannels(exr.format));\n  }\n  static async fromEXRUrl(url: string) {\n    return Image.fromEXRBuffer(await loadArrayBuffer(url));\n  }\n  fill(value: number) {\n    this.data.fill(value);\n    return this;\n  }\n  randomize(min: number = 0, max: number = 1, random: RandomSeedable = new RandomSeedable()) {\n    for (let i=0; i < this.data.length; i++) {\n      this.data[i] = min + random.random() * (max - min);\n    }\n    return this;\n  }\n  // waitUntilRead: \"two frames\" is a recommended amount of time to wait until reading\n  static async readTextureAsync<T extends ImageDataType = Float32Array>(texture: TextureSlicing, readRect: ReadRect = {}, asyncOpts = new TextureReadPollOptions()): Promise<Image<T>> {\n    return new TextureReader(texture).readAndDestroy('poll', readRect, asyncOpts);\n  }\n  static readTextureSync<T extends ImageDataType = Float32Array>(texture: TextureSlicing, readRect: ReadRect = {}): Image<T> {\n    return new TextureReader(texture).readAndDestroy('block', readRect);\n  }\n  toGl(gls: GlState, as2dArray?: boolean): Texture {\n    let tex;\n    if (as2dArray === true || (as2dArray === undefined && this.size.depth > 1)) {\n      tex = new Texture(gls, this.defaultTextureFormat(gls), this.size, this.size.depth);\n    } else {\n      tex = new Texture(gls, this.defaultTextureFormat(gls), this.size);\n    }\n    if (!tex) {\n      throw new Error('Failed to create texture');\n    }\n    tex.init(this.data);\n    return tex;\n  }\n  toGlDoubleBuffered(gls: GlState, as2dArray?: boolean): DoubleBufferedTexture {\n    return new DoubleBufferedTexture(this.toGl(gls, as2dArray), this.toGl(gls, as2dArray));\n  }\n  defaultTextureFormat(gls: GlState) {\n    if (this.channels === 1) {\n      if (this.data instanceof Float32Array) {\n        return gls.gl.R32F;\n      } else if (this.data instanceof Int32Array) {\n        return gls.gl.R32I;\n      } else if (this.data instanceof Uint8Array) {\n        return gls.gl.R8UI;\n      }\n    } else if (this.channels === 2) {\n      if (this.data instanceof Float32Array) {\n        return gls.gl.RG32F;\n      } else if (this.data instanceof Int32Array) {\n        return gls.gl.RG32I;\n      } else if (this.data instanceof Uint8Array) {\n        return gls.gl.RG8UI;\n      }\n    } else if (this.channels === 3) {\n      if (this.data instanceof Float32Array) {\n        return gls.gl.RGB32F;\n      } else if (this.data instanceof Int32Array) {\n        return gls.gl.RGB32I;\n      } else if (this.data instanceof Uint8Array) {\n        return gls.gl.RGB8UI;\n      }\n    } else if (this.channels === 4) {\n      if (this.data instanceof Float32Array) {\n        return gls.gl.RGBA32F;\n      } else if (this.data instanceof Int32Array) {\n        return gls.gl.RGBA32I;\n      } else if (this.data instanceof Uint8Array) {\n        return gls.gl.RGBA8UI;\n      }\n    }\n    throw new Error('Not implemented yet');\n  }\n  safeIndex(position: Vector3.Vector3, channel = 0): number {\n    const x = mod(position.x, this.size.width);\n    const y = mod(position.y, this.size.height);\n    return this.index(x, y, position.z, channel);\n  }\n  index(x: number, y: number, z: number, channel = 0): number {\n    return imageIndex(this.size, this.channels, x, y, z, channel);\n  }\n  safeRead(position: Vector3.Vector3, channel = 0): number {\n    return this.data[this.safeIndex(position, channel)];\n  }\n  read(x: number, y: number, z = 0, channel = 0): number {\n    return this.data[this.index(x, y, z, channel)];\n  }\n  write(value: number, x: number, y: number, z = 0, channel = 0) {\n    this.data[this.index(x, y, z, channel)] = value;\n  }\n  readPixel({ x, y, z = 0}: { x: number, y: number, z?: number }): Vector4.Vector4 {\n    const index = this.index(x, y, z, 0);\n    if (this.channels === 1) {\n      return { x: this.data[index], y: 0, z: 0, w: 0 };\n    } else if (this.channels === 2) {\n      return { x: this.data[index], y: this.data[index + 1], z: 0, w: 0 };\n    } else if (this.channels === 3) {\n      return { x: this.data[index], y: this.data[index + 1], z: this.data[index + 2], w: 0 };\n    } else {\n      return { x: this.data[index], y: this.data[index + 1], z: this.data[index + 2], w: this.data[index + 3] };\n    }\n  }\n  readPixelAsArray(pos: { x: number, y: number, z?: number }): [number, number, number, number] {\n    return Vector4.toArray(this.readPixel(pos));\n  }\n  fillLayer(layer: number, value: number) {\n    for (let y=0; y < this.size.height; y++) {\n      for (let x=0; x < this.size.width; x++) {\n        this.write(value, x, y, layer);\n      }\n    }\n  }\n  readLayer(layer: number) {\n    return this.data.slice(layer * this.size.width * this.size.height, (layer + 1) * this.size.width * this.size.height);\n  }\n  reduceLayer(layer: number, channel: number, reduce: (p: number, x: number) => number, initialValue?: number): number {\n    let value = initialValue !== undefined ? initialValue : this.read(0, 0, layer);\n    for (let y=0; y < this.size.height; y++) {\n      for (let x=0; x < this.size.width; x++) {\n        if (initialValue === undefined && x === 0 && y === 0) {\n          continue;\n        }\n        value = reduce(value, this.read(x, y, layer, channel));\n      }\n    }\n    return value;\n  }\n  get DataConstructor(): new (length: number) => T {\n    return this.data.constructor as  (new (length: number) => T);\n  }\n  reduce(reduce: (p: number, x: number) => number, initialValue?: number) {\n    const res = Image.zeroes(this.DataConstructor, { width: 1, height: 1, depth: this.size.depth }, this.channels);\n    for (let z=0; z < this.size.depth; z++) {\n      for (let channel=0; channel < this.channels; channel++) {\n        let v = initialValue ?? 0;\n        for (let y=0; y < this.size.height; y++) {\n          for (let x=0; x < this.size.height; x++) {\n            v = reduce(v, this.read(x, y, z, channel));\n          }\n        }\n        res.write(v, 0, 0, z, channel);\n      }\n    }\n    return res;\n  }\n  map(map: (value: number, position: Vector4.Vector4) => number): Image<T> {\n    const d = this.data.map((value, i) => {\n      return map(value, imagePosition(this.size, this.channels, i));\n    });\n    return new Image<T>(d as T, {...this.size}, this.channels);\n  }\n  copyXY(from: Vector2.Vector2, to: Vector2.Vector2) {\n    for (let l=0; l < this.size.depth; l++) {\n      this.data[this.safeIndex({ x: to.x, y: to.y, z: l })] =\n        this.data[this.safeIndex({ x: from.x, y: from.y, z: l })];\n    }\n  }\n  *positionsXY() {\n    for (let y=0; y < this.size.height; y++) {\n      for (let x=0; x < this.size.width; x++) {\n        yield { x, y };\n      }\n    }\n  }\n  select(rect: Rect): ImageSlice<T> {\n    return new ImageSlice(this, rect, new Array(this.size.depth).fill(0).map((_, i) => i));\n  }\n  slice(layers: number[]): ImageSlice<T> {\n    return new ImageSlice(this, { x: 0, y: 0, width: this.size.width, height: this.size.height }, layers);\n  }\n  sliceRange(startLayer: number, count: number): ImageSlice<T> {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n  sliceAll(): ImageSlice<T> {\n    return this.sliceRange(0, this.size.depth);\n  }\n  dump() {\n    for (let z = 0; z < this.size.depth; z++) {\n      for (let w = 0; w < this.channels; w++) {\n        // tslint:disable-next-line:no-console\n        console.log(`Layer: ${z}, Channel: ${w}`);\n        const data: number[][] = [];\n        for (let y = 0; y < this.size.height; y++) {\n          const row: number[] = [];\n          for (let x = 0; x < this.size.width; x++) {\n            row.push(this.read(x, y, z, w));\n          }\n          data.push(row);\n        }\n        // tslint:disable-next-line:no-console\n        console.table(data);\n      }\n    }\n  }\n  dumpImage() {\n    const canvas = document.createElement('canvas');\n    canvas.width = this.size.width;\n    canvas.height = this.size.height;\n    const context = canvas.getContext('2d')!;\n    const style = \"font-size: 1px; padding: \" + Math.floor(canvas.height/2) + \"px \" + Math.floor(canvas.width/2) + \"px; line-height: 0px;\";\n    for (let z = 0; z < this.size.depth; z++) {\n      for (let w = 0; w < this.channels; w++) {\n        // tslint:disable-next-line:no-console\n        console.log(`Layer: ${z}, Channel: ${w}`);\n        context.clearRect(0, 0, canvas.width, canvas.height);\n        for (let y = 0; y < this.size.height; y++) {\n          for (let x = 0; x < this.size.width; x++) {\n            context.fillStyle = `hsl(0, 0%, ${100 * this.read(x, y, z, w)}%)`;\n            context.fillRect(x, y, 1, 1);\n          }\n        }\n        const dataUrl = canvas.toDataURL();\n        console.log('%c+', `${style} background:url(${dataUrl}) no-repeat; background-size: ${canvas.width}px ${canvas.height}px`);\n      }\n    }\n  }\n}\n\nexport class ImageSlice<T extends ImageDataType> {\n  constructor(public image: Image<T>, public rect: Rect, public layers: number[]) {}\n  select(rect: Rect) {\n    return new ImageSlice(this.image, rect, this.layers);\n  }\n  slice(layers: number[]) {\n    return new ImageSlice(this.image, this.rect, layers.map(i => this.layers[i]));\n  }\n  sliceRange(startLayer: number, count: number) {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n  index(x: number, y: number, z = 0, channel = 0) {\n    return this.image.index(this.rect.x + x, this.rect.y + y, this.layers[z], channel);\n  }\n  read(x: number, y: number, z = 0, channel = 0) {\n    return this.image.read(this.rect.x + x, this.rect.y + y, this.layers[z], channel);\n  }\n  write(value: number, x: number, y: number, z = 0, channel = 0) {\n    this.image.write(value, this.rect.x + x, this.rect.y + y, this.layers[z], channel);\n  }\n  toArray(target = new this.image.DataConstructor(this.rect.width * this.rect.height * this.layers.length * this.image.channels)) {\n    let offset = 0;\n    const chunkSize = this.rect.width * this.image.channels;\n    for (let z = 0; z < this.layers.length; z++) {\n      for (let y = 0; y < this.rect.height; y++) {\n        const index = this.index(0, y, z, 0);\n        target.set(this.image.data.subarray(index, index + chunkSize), offset);\n        offset += chunkSize;\n      }\n    }\n    return target;\n  }\n  toImage() {\n    return new Image(this.toArray(), { width: this.rect.width, height: this.rect.height, depth: this.layers.length }, this.image.channels);\n  }\n}\n","import { TextureSlicing, Texture } from \"./Texture\";\nimport { GlState, Destructible } from \"./GlState\";\nimport { Rect } from \"../Math/Math\";\n\nexport class RenderTarget implements Destructible {\n  constructor(private gls: GlState) {}\n  destroy() {\n    this.gls.gl.deleteFramebuffer(this.buffer);\n    this.buffer = null;\n    this.destroyed = true;\n  }\n  destroyed = false;\n  private buffer = this.gls.gl.createFramebuffer();\n  private cachedTexture: Texture | null = null;\n  private cachedLayers: number[] = [];\n  private cachedOutputCount = 0;\n\n  bind() {\n    if (this.destroyed) {\n      throw new Error(`Trying to bind destroyed buffer`);\n    }\n    this.gls.framebuffer = this.buffer;\n  }\n\n  private setOutputCount(value: number) {\n    if (value === this.cachedOutputCount) {\n      return;\n    }\n    if (value > this.gls.maxColorAttachements) {\n      throw new Error(`Outputs can't be larger than maxColorAttachements (${this.gls.maxColorAttachements})`);\n    }\n    const gl = this.gls.gl;\n    gl.drawBuffers(new Array(value).fill(0).map((_, i) => gl.COLOR_ATTACHMENT0 + i));\n    if (this.cachedOutputCount > value) {\n      for (let i=value; i < this.cachedOutputCount; i++) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + i, gl.TEXTURE_2D, null, 0);\n      }\n    }\n    this.cachedOutputCount = value;\n  }\n\n  set({ texture, layers }: TextureSlicing) {\n    this.bind();\n    const gl = this.gls.gl;\n    if (texture.destroyed || !texture.inited) {\n      throw new Error(`Trying to bind destroyed or uninited texture`);\n    }\n    if (!texture.is2dArray) {\n      this.setOutputCount(1);\n      if (this.cachedTexture !== texture) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture.texture, 0);\n        this.cachedTexture = texture;\n      }\n    } else {\n      if (layers === undefined) {\n        throw new Error(`Trying to set array texture but no layer defined`);\n      }\n      this.setOutputCount(layers.length);\n      for (let index = 0; index < layers.length; index++) {\n        const layer = layers[index];\n        if (this.cachedTexture !== texture || this.cachedLayers[index] !== layer) {\n          if (layer < 0 || layer >= texture.depth!) {\n            throw new Error(`Layer out of range`);\n          }\n          gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + index, texture.texture, 0, layer);\n        }\n      }\n      this.cachedTexture = texture;\n      this.cachedLayers = layers;\n    }\n\n    // const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    // if (status !== gl.FRAMEBUFFER_COMPLETE) {\n    //   throw new Error(`Framebuffer failed to create: ${status} ${getGlConstantName(gl, status)}`);\n    // }\n  }\n\n  clear(color: number[] | Float32Array, index: number = 0, rect?: Rect) {\n    this.bind();\n    if (!this.cachedTexture) {\n      throw new Error(`No texture bound to render target`);\n    }\n    const gl = this.gls.gl;\n    if (rect) {\n      this.gls.enable(gl.SCISSOR_TEST);\n      gl.scissor(rect.x, rect.y, rect.width, rect.height);\n    }\n    if (this.cachedTexture.formatType === 'float') {\n      gl.clearBufferfv(gl.COLOR, index, new Float32Array(color));\n    } else if (this.cachedTexture.formatType === 'int') {\n      gl.clearBufferiv(gl.COLOR, index, new Int32Array(color));\n    } else if (this.cachedTexture.formatType === 'uint') {\n      gl.clearBufferuiv(gl.COLOR, index, new Uint32Array(color));\n    } else {\n      throw new Error('Not implemented yet');\n    }\n    if (rect) {\n      this.gls.disable(gl.SCISSOR_TEST);\n    }\n  }\n}\n","import { Size, Rect } from \"../Math/Math\";\nimport * as _ from \"lodash\";\nimport { Image, ImageDataType } from \"./Image\";\nimport { ReadRect, TextureReadPollOptions } from \"./TextureReader\";\nimport { GlState, Destructible } from \"./GlState\";\nimport { getGlConstantName } from \".\";\nimport { RenderTarget } from \"./RenderTarget\";\n\nfunction defaultFormat(gl: WebGL2RenderingContext, internalFormat: number) {\n  switch (internalFormat) {\n    // From https://www.khronos.org/registry/webgl/specs/latest/2.0/#TEXTURE_TYPES_FORMATS_FROM_DOM_ELEMENTS_TABLE\n    case gl.RGB: return gl.RGB;\n    case gl.RGBA: return gl.RGBA;\n\n    case gl.R32F: return gl.RED;\n    case gl.RG32F: return gl.RG;\n    case gl.RGB32F: return gl.RGB;\n    case gl.RGBA32F: return gl.RGBA;\n\n    case gl.R8UI: return gl.RED_INTEGER;\n    case gl.RG8UI: return gl.RG_INTEGER;\n    case gl.RGB8UI: return gl.RGB_INTEGER;\n    case gl.RGBA8UI: return gl.RGBA_INTEGER;\n\n    // These I'm just guessing because I didn't see them in the spec above\n    case gl.R8I: return gl.RED_INTEGER;\n    case gl.RG8I: return gl.RG_INTEGER;\n    case gl.RGB8I: return gl.RGB_INTEGER;\n    case gl.RGBA8I: return gl.RGBA_INTEGER;\n\n    case gl.R32I: return gl.RED_INTEGER;\n    case gl.RG32I: return gl.RG_INTEGER;\n    case gl.RGB32I: return gl.RGB_INTEGER;\n    case gl.RGBA32I: return gl.RGBA_INTEGER;\n\n    default: throw new Error(`Not implemeted yet`);\n  }\n}\nfunction defaultType(gl: WebGL2RenderingContext, internalFormat: number) {\n  switch (internalFormat) {\n    // From https://www.khronos.org/registry/webgl/specs/latest/2.0/#TEXTURE_TYPES_FORMATS_FROM_DOM_ELEMENTS_TABLE\n    case gl.RGB: return gl.UNSIGNED_BYTE;\n    case gl.RGBA: return gl.UNSIGNED_BYTE;\n\n    case gl.R32F: return gl.FLOAT;\n    case gl.RG32F: return gl.FLOAT;\n    case gl.RGB32F: return gl.FLOAT;\n    case gl.RGBA32F: return gl.FLOAT;\n\n    case gl.R8UI: return gl.UNSIGNED_BYTE;\n    case gl.RG8UI: return gl.UNSIGNED_BYTE;\n    case gl.RGB8UI: return gl.UNSIGNED_BYTE;\n    case gl.RGBA8UI: return gl.UNSIGNED_BYTE;\n\n    // These I'm just guessing because I didn't see them in the spec above\n    case gl.R8I: return gl.BYTE;\n    case gl.RG8I: return gl.BYTE;\n    case gl.RGB8I: return gl.BYTE;\n    case gl.RGBA8I: return gl.BYTE;\n\n    case gl.R32I: return gl.INT;\n    case gl.RG32I: return gl.INT;\n    case gl.RGB32I: return gl.INT;\n    case gl.RGBA32I: return gl.INT;\n\n    default: throw new Error(`Not implemeted yet`);\n  }\n}\n\nfunction defaultUnpackAlignment(gl: WebGL2RenderingContext, internalFormat: number) {\n  switch (internalFormat) {\n    case gl.R8UI: return 1;\n    case gl.R8I: return 1;\n    default: return 4;\n  }\n}\nfunction defaultPixelBytes(gl: WebGL2RenderingContext, internalFormat: number) {\n  switch (internalFormat) {\n    case gl.RGB: return 3;\n    case gl.RGBA: return 4;\n\n    case gl.R32F: return 4;\n    case gl.RG32F: return 8;\n    case gl.RGB32F: return 16;\n    case gl.RGBA32F: return 32;\n\n    case gl.R8UI: return 1;\n    case gl.RG8UI: return 2;\n    case gl.RGB8UI: return 3;\n    case gl.RGBA8UI: return 4;\n\n    case gl.R8I: return 1;\n    case gl.RG8I: return 2;\n    case gl.RGB8I: return 3;\n    case gl.RGBA8I: return 4;\n\n    case gl.R32I: return 4;\n    case gl.RG32I: return 8;\n    case gl.RGB32I: return 12;\n    case gl.RGBA32I: return 16;\n\n    default: throw new Error(`Not implemeted yet`);\n  }\n}\nfunction defaultChannels(gl: WebGL2RenderingContext, internalFormat: number) {\n  switch (internalFormat) {\n    case gl.RGB: return 3;\n    case gl.RGBA: return 4;\n\n    case gl.R32F: return 1;\n    case gl.RG32F: return 2;\n    case gl.RGB32F: return 3;\n    case gl.RGBA32F: return 4;\n\n    case gl.R8UI: return 1;\n    case gl.RG8UI: return 2;\n    case gl.RGB8UI: return 3;\n    case gl.RGBA8UI: return 4;\n\n    case gl.R8I: return 1;\n    case gl.RG8I: return 2;\n    case gl.RGB8I: return 3;\n    case gl.RGBA8I: return 4;\n\n    case gl.R32I: return 1;\n    case gl.RG32I: return 2;\n    case gl.RGB32I: return 3;\n    case gl.RGBA32I: return 4;\n\n    default: throw new Error(`Not implemeted yet`);\n  }\n}\nexport type TextureFormatType = 'float' | 'int' | 'uint';\nfunction textureFormatType(gl: WebGL2RenderingContext, internalFormat: number): TextureFormatType {\n  switch (internalFormat) {\n    case gl.RGB:\n    case gl.RGBA: return 'float';\n\n    case gl.R32F:\n    case gl.RG32F:\n    case gl.RGB32F:\n    case gl.RGBA32F: return 'float';\n\n    case gl.R8UI:\n    case gl.RG8UI:\n    case gl.RGB8UI:\n    case gl.RGBA8UI: return 'uint';\n\n    case gl.R8I:\n    case gl.RG8I:\n    case gl.RGB8I:\n    case gl.RGBA8I: return 'int';\n\n    case gl.R32I:\n    case gl.RG32I:\n    case gl.RGB32I:\n    case gl.RGBA32I: return 'int';\n\n    default: throw new Error(`Not implemeted yet`);\n  }\n}\n\n// function getStack() {\n//   try {\n//       throw new Error();\n//   } catch(e) {\n//       return e.stack;\n//   }\n// }\n\nexport class Texture implements Destructible {\n  constructor(public gls: GlState,\n      public internalFormat: number = gls.gl.RGBA,\n      public size: Size = { width: 1, height: 1 },\n      public depth?: number,\n      public format = defaultFormat(gls.gl, internalFormat),\n      public type = defaultType(gls.gl, internalFormat)) {\n    this.validateSize();\n    const tex = gls.gl.createTexture();\n    if (!tex) {\n      throw new Error('Failed to create texture');\n    }\n    this.texture = tex;\n    Texture.nAliveTextures++;\n    // Texture.aliveTextures.push(this.stackTrace);\n    // console.log('Texture.nAliveTextures', Texture.nAliveTextures);\n  }\n  static create(gls: GlState, internalFormat: number, size: Size, depth?: number, format?: number, type?: number) {\n    return new Texture(gls, internalFormat, size, depth, format, type);\n  }\n  destroyed = false;\n  inited = false;\n  destroy() {\n    if (this.destroyed) {\n      throw new Error(\"Already destroyed\");\n    }\n    this.gl.deleteTexture(this.texture);\n    this.destroyed = true;\n    Texture.nAliveTextures--;\n    // const index = Texture.aliveTextures.indexOf(this.stackTrace);\n    // if (index < 0) {\n    //   throw new Error(\"Not among textures\");\n    // }\n    // Texture.aliveTextures.splice(index, 1);\n  }\n  public texture: WebGLTexture;\n  public name = '';\n  public isDoubleBuffered: false = false;\n  get gl() {\n    return this.gls.gl;\n  }\n  public static nAliveTextures = 0;\n  // stackTrace = getStack();\n  // static aliveTextures: string[] = [];\n\n  get internalFormatName() {\n    return getGlConstantName(this.gl, this.internalFormat);\n  }\n  get formatName() {\n    return getGlConstantName(this.gl, this.format);\n  }\n  get typeName() {\n    return getGlConstantName(this.gl, this.type);\n  }\n  get is2dArray() {\n    return this.depth !== undefined;\n  }\n  unpackAlignment = defaultUnpackAlignment(this.gl, this.internalFormat);\n  formatType = textureFormatType(this.gl, this.internalFormat);\n  pixelBytes = defaultPixelBytes(this.gl, this.internalFormat);\n  get pixelSizeInBytes() {\n    return (this.depth !== undefined ? this.depth : 1) * this.pixelBytes;\n  }\n  get sizeInBytes() {\n    return this.size.width * this.size.height * this.pixelSizeInBytes;\n  }\n  get size3() { return {...this.size, depth: this.depth || 1 } }\n  get pixelSizeOnGPU() { return this.pixelSizeInBytes; }\n  get sizeOnGPU() { return this.sizeInBytes; }\n  get channels() { return defaultChannels(this.gl, this.internalFormat); }\n\n  init(data: ArrayBufferView | null = null) {\n    const gl = this.gl;\n    if (data !== null) {\n      const validData = (this.formatType === 'float' && data instanceof Float32Array) ||\n        (this.formatType === 'int' && data instanceof Int32Array) ||\n        (this.formatType === 'uint' && data instanceof Uint32Array) ||\n        (this.formatType === 'uint' && data instanceof Uint8Array);\n      if (!validData) {\n        throw new Error(`Texture format ${this.formatType} but data is ${data.constructor.name}`);\n      }\n    }\n    gl.activeTexture(gl.TEXTURE31);\n    if (this.depth !== undefined) {\n      gl.bindTexture(gl.TEXTURE_2D_ARRAY, this.texture);\n      gl.pixelStorei(gl.UNPACK_ALIGNMENT, this.unpackAlignment);\n      gl.texImage3D(gl.TEXTURE_2D_ARRAY, 0, this.internalFormat, this.size.width, this.size.height, this.depth, 0, this.format, this.type, data);\n    } else {\n      gl.bindTexture(gl.TEXTURE_2D, this.texture);\n      gl.pixelStorei(gl.UNPACK_ALIGNMENT, this.unpackAlignment);\n      gl.texImage2D(gl.TEXTURE_2D, 0, this.internalFormat, this.size.width, this.size.height, 0, this.format, this.type, data);\n    }\n    this.inited = true;\n    // const err = gl.getError();\n    // if (err !== gl.NO_ERROR) {\n    //   throw new Error(`[Texture.init] Failed to init texture. Error=${getGlConstantName(gl, err)}. Size=${JSON.stringify(this.size)} Depth=${this.depth} SizeInBytes=${this.sizeInBytes}`);\n    // }\n    return this;\n  }\n  loadImage(image: ImageData | HTMLImageElement | HTMLCanvasElement | HTMLVideoElement | Image) {\n    if (image instanceof Image) {\n      this.size = {...image.size};\n      this.init(image.data);\n    } else {\n      const gl = this.gls.gl;\n      gl.activeTexture(gl.TEXTURE31);\n      gl.bindTexture(gl.TEXTURE_2D, this.texture);\n\n      gl.pixelStorei(gl.UNPACK_ALIGNMENT, this.unpackAlignment);\n      gl.texImage2D(gl.TEXTURE_2D, 0, this.internalFormat, this.format, this.type, image);\n      this.size = {\n        width: image.width,\n        height: image.height\n      };\n      this.inited = true;\n    }\n  }\n  generateMipmap() {\n    const gl = this.gls.gl;\n    gl.activeTexture(gl.TEXTURE31);\n    gl.bindTexture(gl.TEXTURE_2D, this.texture);\n    gl.generateMipmap(gl.TEXTURE_2D);\n  }\n  static fromImage(gls: GlState, image: ImageData | HTMLImageElement | HTMLCanvasElement | HTMLVideoElement, mipmap = true) {\n    const t = new Texture(gls);\n    t.loadImage(image);\n    if (mipmap) {\n      t.generateMipmap();\n    }\n    return t;\n  }\n  private validateSize() {\n    if (this.size.width < 0 || this.size.height < 0 ||\n      !Number.isInteger(this.size.width) || !Number.isInteger(this.size.height)) {\n      throw new Error(`Invalid texture size (${this.size.width}, ${this.size.height})`);\n    }\n    if (this.depth !== undefined) {\n      if (this.depth < 1 || !Number.isInteger(this.depth)) {\n        throw new Error(`Invalid texture depth (${this.depth})`);\n      }\n    }\n    if (this.size.width > this.gls.maxTextureSize || this.size.height > this.gls.maxTextureSize) {\n      throw new Error(`Texture (${this.size.width}x${this.size.height}) larger than max texture size (${this.gls.maxTextureSize})`);\n    }\n    if (this.size.width === 0 || this.size.height === 0) {\n      console.warn(`Texture with 0 size created: ${this.size.width} x ${this.size.height}`);\n    }\n  }\n\n  slice(layers: number[]) {\n    return new TextureSlicing(this, { x: 0, y: 0, width: this.size.width, height: this.size.height }, layers);\n  }\n  sliceRange(startLayer: number, count: number) {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n  sliceAll() {\n    return this.sliceRange(0, this.depth || 1);\n  }\n\n  clear(color: [number, number, number, number] | Float32Array = [0, 0, 0, 0], layers?: number[], rect?: Rect) {\n\n    if (this.depth === undefined && layers) {\n      throw new Error(`This is not a multilayer texture`);\n    }\n\n    const rt = new RenderTarget(this.gls);\n\n    const doLayers = this.depth === undefined ? [0]\n      : layers !== undefined ? layers\n      : new Array(this.depth).fill(0).map((_, i) => i);\n\n    for (const layer of doLayers) {\n      rt.set(this.slice([layer]));\n      rt.clear(color, 0, rect);\n    }\n\n    rt.destroy();\n  }\n\n  readSync<T extends ImageDataType = Float32Array>(readRect?: ReadRect) {\n    return Image.readTextureSync<T>(this.sliceAll(), readRect);\n  }\n  readAsync<T extends ImageDataType = Float32Array>(readRect?: ReadRect, asyncOpts?: TextureReadPollOptions) {\n    return Image.readTextureAsync<T>(this.sliceAll(), readRect, asyncOpts);\n  }\n}\n\nexport class DoubleBufferedTexture implements Destructible {\n  constructor(public texture0: Texture, public texture1: Texture) {}\n  static create(gls: GlState, internalFormat: number, size: Size, depth?: number, format?: number, type?: number) {\n    return new DoubleBufferedTexture(\n      new Texture(gls, internalFormat, size, depth, format, type),\n      new Texture(gls, internalFormat, size, depth, format, type)\n    );\n  }\n  destroy() {\n    this.front.destroy();\n    this.back.destroy();\n  }\n  get destroyed() { return this.front.destroyed; }\n  get inited() { return this.front.inited; }\n  public swapped = false;\n  public isDoubleBuffered: true = true;\n\n  // Back is the one we write to\n  get back() { return this.swapped ? this.texture1 : this.texture0 }\n  get write() { return this.back; }\n\n  // Front is the one we read from. It's the \"currently active\" buffer.\n  get front() { return this.swapped ? this.texture0 : this.texture1 }\n  get read() { return this.front; }\n\n  swap() {\n    this.swapped = !this.swapped;\n  }\n  resetSwap() {\n    this.swapped = false;\n  }\n  get texture() {\n    return this.front.texture;\n  }\n  get gls() {\n    return this.texture0.gls;\n  }\n  get gl() {\n    return this.texture0.gl;\n  }\n  private selfName;\n  get name() {\n    return this.selfName;\n  }\n  set name(value: string) {\n    this.selfName = value;\n    this.texture0.name = value + '_0';\n    this.texture1.name = value + '_1';\n  }\n\n  get internalFormat() { return this.front.internalFormat; }\n  get size() { return this.front.size; }\n  get depth() { return this.front.depth; }\n  get channels() { return this.front.channels; }\n  get is2dArray() { return this.front.is2dArray; }\n  get formatType() { return this.front.formatType; }\n  get pixelSizeInBytes() { return this.front.pixelSizeInBytes; }\n  get sizeInBytes() { return this.front.sizeInBytes; }\n  get pixelSizeOnGPU() { return this.front.pixelSizeInBytes * 2; }\n  get sizeOnGPU() { return this.sizeInBytes * 2; }\n\n  init(data: ArrayBufferView | null = null) {\n    this.front.init(data);\n    this.back.init(data);\n    return this;\n  }\n\n  slice(layers: number[]) {\n    return new DoubleBufferedTextureSlicing(this, { x: 0, y: 0, width: this.size.width, height: this.size.height }, layers);\n  }\n  sliceRange(startLayer: number, count: number) {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n  sliceAll() {\n    return this.sliceRange(0, this.depth || 1);\n  }\n  clear(color: [number, number, number, number] | Float32Array = [0, 0, 0, 0], layers?: number[]) {\n    this.front.clear(color, layers);\n    this.back.clear(color, layers);\n  }\n  readSync<T extends ImageDataType = Float32Array>(readRect?: ReadRect) {\n    return this.front.readSync<T>(readRect);\n  }\n  readAsync<T extends ImageDataType = Float32Array>(readRect?: ReadRect, asyncOpts?: TextureReadPollOptions) {\n    return this.front.readAsync<T>(readRect, asyncOpts);\n  }\n}\n\nexport type ITexture = Texture | DoubleBufferedTexture;\n\nexport class TextureSlicing {\n  constructor(public texture: Texture, public rect: Rect, public layers: number[]) {\n    if (texture.is2dArray && layers === undefined) {\n      throw new Error(`2d array must have layers`);\n    } else if (!texture.is2dArray && layers.length !== 1) {\n      throw new Error(`2d textures must have one layer`);\n    }\n  }\n  get count() {\n    return this.layers.length;\n  }\n  readSync<T extends ImageDataType = Float32Array>() {\n    return Image.readTextureSync<T>(this, this.rect);\n  }\n  readAsync<T extends ImageDataType = Float32Array>(asyncOpts?: TextureReadPollOptions) {\n    return Image.readTextureAsync<T>(this, this.rect, asyncOpts);\n  }\n  clear(color: [number, number, number, number] | Float32Array = [0, 0, 0, 0]) {\n    this.texture.clear(color, this.layers, this.rect);\n  }\n  upload(data: ArrayBufferView) {\n    const gl = this.texture.gl;\n    gl.activeTexture(gl.TEXTURE31);\n\n    const buff = gl.createBuffer();\n    gl.bindBuffer(gl.PIXEL_UNPACK_BUFFER, buff);\n    gl.bufferData(gl.PIXEL_UNPACK_BUFFER, data, gl.STREAM_DRAW);\n\n    if (this.texture.is2dArray) {\n      if (this.layers[0] + this.layers.length - 1 !== this.layers[this.layers.length - 1]) {\n        throw new Error(`Can only upload to a continuous range of layers (3, 4, 5, 6 for instance). Found: ${JSON.stringify(this.layers)}`);\n      }\n      gl.bindTexture(gl.TEXTURE_2D_ARRAY, this.texture.texture);\n      gl.texSubImage3D(gl.TEXTURE_2D_ARRAY, 0, this.rect.x, this.rect.y, this.layers[0],\n        this.rect.width, this.rect.height, this.layers.length, this.texture.format, this.texture.type, 0);\n    } else {\n      gl.bindTexture(gl.TEXTURE_2D, this.texture.texture);\n\n      gl.texSubImage2D(gl.TEXTURE_2D, 0, this.rect.x, this.rect.y, this.rect.width, this.rect.height, this.texture.format, this.texture.type, 0);\n    }\n    gl.bindBuffer(gl.PIXEL_UNPACK_BUFFER, null);\n    gl.deleteBuffer(buff);\n    // const status = gl.getError();\n    // if (status !== gl.NO_ERROR) {\n    //   throw new Error(`Gl error: ${status} ${getGlConstantName(gl, status)}`);\n    // }\n  }\n  selectAbsolute(rect: Rect) {\n    return new TextureSlicing(this.texture, rect, this.layers);\n  }\n  selectRelative(rect: Rect) {\n    return new TextureSlicing(this.texture, {...rect, x: this.rect.x + rect.x, y: this.rect.y + rect.y }, this.layers);\n  }\n  selectAll() {\n    return new TextureSlicing(this.texture, { x: 0, y: 0, ...this.texture.size }, this.layers);\n  }\n  slice(layers: number[]) {\n    return new TextureSlicing(this.texture, this.rect, layers.map(i => this.layers[i]));\n  }\n  sliceRange(startLayer: number, count: number) {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n}\n\nexport class DoubleBufferedTextureSlicing {\n  constructor(public texture: DoubleBufferedTexture, public rect: Rect, public layers: number[]) {\n    if (texture.is2dArray && layers === undefined) {\n      throw new Error(`2d array must have layers`);\n    } else if (!texture.is2dArray && layers.length !== 1) {\n      throw new Error(`2d texture must have one slice`);\n    }\n  }\n  get count() {\n    return this.layers.length;\n  }\n  readSync<T extends ImageDataType = Float32Array>() {\n    return this.front.readSync<T>();\n  }\n  readAsync<T extends ImageDataType = Float32Array>(asyncOpts?: TextureReadPollOptions) {\n    return this.front.readAsync<T>(asyncOpts);\n  }\n  get back() {\n    return new TextureSlicing(this.texture.back, this.rect, this.layers);\n  }\n  get front() {\n    return new TextureSlicing(this.texture.front, this.rect, this.layers);\n  }\n  get texture0() {\n    return new TextureSlicing(this.texture.texture0, this.rect, this.layers);\n  }\n  get texture1() {\n    return new TextureSlicing(this.texture.texture1, this.rect, this.layers);\n  }\n  clear(color: [number, number, number, number] | Float32Array = [0, 0, 0, 0]) {\n    this.front.clear(color);\n    this.back.clear(color);\n  }\n  upload(data: ArrayBufferView) {\n    this.front.upload(data);\n    this.back.upload(data);\n  }\n  selectAbsolute(rect: Rect) {\n    return new DoubleBufferedTextureSlicing(this.texture, rect, this.layers);\n  }\n  selectRelative(rect: Rect) {\n    return new DoubleBufferedTextureSlicing(this.texture, {...rect, x: this.rect.x + rect.x, y: this.rect.y + rect.y }, this.layers);\n  }\n  selectAll() {\n    return new DoubleBufferedTextureSlicing(this.texture, { x: 0, y: 0, ...this.texture.size }, this.layers);\n  }\n  slice(layers: number[]) {\n    return new DoubleBufferedTextureSlicing(this.texture, this.rect, layers.map(i => this.layers[i]));\n  }\n  sliceRange(startLayer: number, count: number) {\n    return this.slice(new Array(count).fill(0).map((_, i) => startLayer + i));\n  }\n}\n\n\nexport function destroyTextures(textures: { [key: string]: Texture | Texture[] | DoubleBufferedTexture | undefined }) {\n  for (const tex of _.values(textures)) {\n    if (Array.isArray(tex)) {\n      for (const t of tex) {\n        t.destroy();\n      }\n    } else {\n      if (tex) {\n        tex.destroy();\n      }\n    }\n  }\n}\n","import { GLSLBaseType, GLSLType, GLSLTypeMappings, GLSLArrayType } from \"./GLSLTypes\";\nimport { GpuWorldState } from \"../GpuWorld/State\";\nimport { Program } from \"./Program\";\nimport { shaderHeader } from \".\";\n\nexport interface UniformDef<T extends GLSLBaseType = GLSLBaseType> {\n  def: 'uniform';\n  type: T;\n  value?: (state: GpuWorldState) => GLSLTypeMappings[T];\n  required: boolean;\n}\nexport function uniformDef<T extends GLSLBaseType>(type: T, value?: (state: GpuWorldState) => GLSLTypeMappings[T], required = false): UniformDef<T> {\n  return { def: 'uniform', type, value, required };\n}\nexport interface UniformArrayDef<T extends GLSLArrayType = GLSLArrayType> {\n  def: 'uniformArray';\n  type: T;\n  size: number;\n  value?: (state: GpuWorldState) => GLSLTypeMappings[T];\n  required: boolean;\n}\nexport function uniformArrayDef<T extends GLSLArrayType>(type: T, size: number, value?: (state: GpuWorldState) => GLSLTypeMappings[T], required = false): UniformArrayDef<T> {\n  return { def: 'uniformArray', type, size, value, required };\n}\nexport interface InDef<T extends string = string> {\n  def: 'in';\n  type: T;\n  flat: boolean;\n}\nexport function inDef<T extends string>(type: T, flat = false): InDef<T> {\n  return { def: 'in', type, flat };\n}\nexport interface OutDef<T extends string = string> {\n  def: 'out';\n  type: T;\n  flat: boolean;\n}\nexport function outDef<T extends string>(type: T, flat = false): OutDef<T> {\n  return { def: 'out', type, flat };\n}\nexport interface ConstDef<T extends string = string> {\n  def: 'const';\n  type: T;\n  value: string;\n}\nexport function constDef<T extends string>(type: T, value: string): ConstDef<T> {\n  return { def: 'const', type, value };\n}\nexport interface StructDef<M extends { [key: string]: string } = { [key: string]: string }> {\n  def: 'struct';\n  members: M;\n}\nexport function structDef<M extends { [key: string]: string }>(members: M): StructDef<M> {\n  return { def: 'struct', members };\n}\ntype FuncArg = [string, string] | ['out' | 'in' | 'inout', string, string];\nexport interface FunctionDef<R extends string, As extends Array<FuncArg>> {\n  def: 'func';\n  returnType: R;\n  args: As;\n  body: string;\n}\nexport function funcDef<R extends string, As extends Array<FuncArg>>(\n  returnType: R, args: As, body: string): FunctionDef<R, As> {\n  return {\n    def: 'func',\n    returnType,\n    args,\n    body\n  }\n}\n\nexport interface OverloadedFunctionDef {\n  def: 'overloadedfunc';\n  funcs: FunctionDef<string, Array<FuncArg>>[];\n}\n\nexport function overloadedFuncDef(funcs: FunctionDef<string, Array<FuncArg>>[]): OverloadedFunctionDef {\n  return {\n    def: 'overloadedfunc',\n    funcs\n  }\n}\n\n\ntype RawDef = UniformDef | UniformArrayDef | InDef | OutDef | ConstDef |\n  StructDef | FunctionDef<string, Array<FuncArg>> | OverloadedFunctionDef;\ntype Def<T extends RawDef> = T & { name: string, toString: () => string };\n\ntype ShaderModuleDef = { [key: string]: RawDef };\nexport type ShaderModule<M extends ShaderModuleDef = ShaderModuleDef> = { [K in keyof M]: Def<M[K]> };\nexport function shaderModule<M extends ShaderModuleDef>(dependencies: ShaderModule[], sm: M): ShaderModule<M>;\nexport function shaderModule<M extends ShaderModuleDef>(name: string, dependencies: ShaderModule[], sm: M): ShaderModule<M>;\nexport function shaderModule(...args: any[]) {\n  let sm: { [key: string]: Def<RawDef> };\n  let dependencies: ShaderModule[];\n  let name: string = '';\n  if (args.length === 2) {\n    dependencies = args[0];\n    sm = args[1];\n  } else {\n    name = args[0];\n    dependencies = args[1];\n    sm = args[2];\n  }\n  const res = { dependencies };\n  for (const k of Object.keys(sm)) {\n    const def = sm[k];\n    def.name = name ? `${name}_${k}` : k;\n    def.toString = () => def.name;\n    if (def.def === 'func') {\n      // Replace all Self_something with the actual module name\n      const modlPrefix = name ? (name + '_') : '';\n      def.body = def.body.split('Self.').join(modlPrefix);\n      def.returnType = def.returnType.split('Self.').join(modlPrefix);\n    }\n    res[k] = def;\n  }\n  return res;\n}\n\nfunction flattenModules(sm: ShaderModule): { [key: string]: Def<RawDef> } {\n  const self = {};\n  for (const k of Object.keys(sm)) {\n    if (k !== 'dependencies') {\n      self[sm[k].name] = sm[k];\n    }\n  }\n  return Object.assign({}, ...[...(sm as any).dependencies.map(d => flattenModules(d)), self])\n}\n\nexport class CompiledShaderModule {\n  constructor(public shaderModule: ShaderModule) {\n    this.source = shaderHeader + '\\n';\n    const mod = flattenModules(shaderModule);\n    for (const k of Object.keys(mod)) {\n      const def = mod[k];\n      this.source += defToGlsl(def.name, def) + '\\n\\n';\n      if (def.def === 'uniform' || def.def === 'uniformArray') {\n        if (def.value) {\n          this.uniforms.push({\n            name: def.name,\n            type: def.type,\n            getValue: def.value,\n            value: null,\n            required: def.required\n          });\n        }\n      }\n    }\n  }\n  uniforms: Array<{\n    name: string,\n    type: GLSLType,\n    getValue: (state: GpuWorldState) => any,\n    value: any,\n    required: boolean\n  }> = [];\n  source: string;\n  updateUniformValues(state: GpuWorldState) {\n    for (const uniform of this.uniforms) {\n      uniform.value = uniform.getValue(state);\n    }\n  }\n  writeUniforms(program: Program) {\n    for (const uniform of this.uniforms) {\n      program.setUniform(uniform.name, uniform.type, uniform.value, uniform.required ?? false);\n    }\n  }\n}\n\nfunction defToGlsl(name: string, def: RawDef) {\n  switch (def.def) {\n    case 'in':\n    case 'out':  return `${def.flat ? 'flat' : ''} ${def.def} ${def.type} ${name};`;\n    case 'uniform': return `${def.def} ${def.type} ${name};`;\n    case 'uniformArray': return `uniform ${def.type.slice(0, def.type.length - 2)} ${name}[${def.size}];`;\n    case 'const': return `const ${def.type} ${name} = ${def.value};`;\n    case 'struct': return `struct ${name} {\\n${Object.keys(def.members).map(k => `  ${def.members[k]} ${k};`).join('\\n')}\\n};`;\n    case 'func': return `${def.returnType} ${name}(${(def.args as any).map(arg => arg.join(' ')).join(', ')}) {${def.body}}`;\n    case 'overloadedfunc': return def.funcs.map(d => defToGlsl(name, d)).join('\\n')\n  }\n}\n","import { Size } from \"../Math/Math\";\nimport { GlState, Destructible } from \"./GlState\";\nimport { Program } from \"./Program\";\nimport * as THREE from 'three';\nimport { shaderModule, inDef } from \"./ShaderModule\";\n\nclass Buffer implements Destructible {\n  constructor(private gls: GlState, private target: number) {}\n  destroy() {\n    this.gls.gl.deleteBuffer(this.buffer);\n    this.buffer = null;\n  }\n  buffer = this.gls.gl.createBuffer();\n  size = 0;\n  setData(data: Float32Array | Int32Array | Uint16Array) {\n    this.gls.gl.bindBuffer(this.target, this.buffer);\n    this.gls.gl.bufferData(this.target, data, this.gls.gl.STATIC_DRAW);\n    this.size = data.length;\n    return this;\n  }\n  static arrayBuffer(gls: GlState) {\n    return new Buffer(gls, gls.gl.ARRAY_BUFFER);\n  }\n  static elementArrayBuffer(gls: GlState) {\n    return new Buffer(gls, gls.gl.ELEMENT_ARRAY_BUFFER);\n  }\n  bind() {\n    const gl = this.gls.gl;\n    gl.bindBuffer(this.target, this.buffer);\n  }\n}\n\nexport const Vertex = shaderModule('Vertex', [], {\n  position: inDef('vec3'),\n  normal: inDef('vec3'),\n  texcoord: inDef('vec2'),\n  skinWeight: inDef('vec4'),\n  skinIndex: inDef('vec4'),\n});\n\ninterface Attribute {\n  buffer: Buffer;\n  itemSize: number;\n  type: number;\n  normalized: boolean;\n  stride: number;\n  offset: number;\n}\n\nexport class Mesh implements Destructible {\n  constructor(private gls: GlState,\n    public attributes: { [key: string]: Attribute },\n    private buffers: Buffer[],\n    public index?: Buffer) {}\n  destroy() {\n    for (const buff of this.buffers) {\n      buff.destroy();\n    }\n    if (this.index) {\n      this.index.destroy();\n    }\n  }\n\n  static createSimple3dTriangleStrip(gls: GlState, attrs: { position: Buffer, normal?: Buffer, texcoord?: Buffer }) {\n    const attribs: { [key: string]: Attribute } = {};\n    attribs.position = {\n      buffer: attrs.position,\n      itemSize: 3,\n      type: gls.gl.FLOAT,\n      normalized: false,\n      stride: 0,\n      offset: 0\n    };\n    if (attrs.normal) {\n      attribs.normal = {\n        buffer: attrs.normal,\n        itemSize: 3,\n        type: gls.gl.FLOAT,\n        normalized: false,\n        stride: 0,\n        offset: 0\n      };\n    }\n    if (attrs.texcoord) {\n      attribs.texcoord = {\n        buffer: attrs.texcoord,\n        itemSize: 2,\n        type: gls.gl.FLOAT,\n        normalized: false,\n        stride: 0,\n        offset: 0\n      };\n    }\n    return new Mesh(gls, attribs, [attrs.position]);\n  }\n\n  static create3dIndexed(gls: GlState, attrs: { position: Buffer, normal: Buffer, texcoord: Buffer }, index: Buffer) {\n    return new Mesh(gls, {\n      position: {\n        buffer: attrs.position,\n        itemSize: 3,\n        type: gls.gl.FLOAT,\n        normalized: false,\n        stride: 0,\n        offset: 0\n      },\n      normal: {\n        buffer: attrs.normal,\n        itemSize: 3,\n        type: gls.gl.FLOAT,\n        normalized: false,\n        stride: 0,\n        offset: 0\n      },\n      texcoord: {\n        buffer: attrs.texcoord,\n        itemSize: 2,\n        type: gls.gl.FLOAT,\n        normalized: false,\n        stride: 0,\n        offset: 0\n      },\n    }, [attrs.position, attrs.normal, attrs.texcoord], index);\n  }\n\n  private bindAttrib(index: number, attrib: Attribute) {\n    attrib.buffer.bind();\n    this.gls.gl.vertexAttribPointer(index, attrib.itemSize, attrib.type, attrib.normalized, attrib.stride, attrib.offset);\n  }\n\n  bind(program: Program) {\n    if (this.index) {\n      this.index.bind();\n    }\n    const position = program.getAttribute('' + Vertex.position);\n    const normal = program.getAttribute('' + Vertex.normal);\n    const texcoord = program.getAttribute('' + Vertex.texcoord);\n    const skinWeight = program.getAttribute('' + Vertex.skinWeight);\n    const skinIndex = program.getAttribute('' + Vertex.skinIndex);\n    this.gls.enabledVertexAttribArray = [position, normal, texcoord, skinWeight, skinIndex].filter(x => x !== -1);\n    if (position >= 0) {\n      this.bindAttrib(position, this.attributes.position);\n    }\n    if (normal >= 0) {\n      this.bindAttrib(normal, this.attributes.normal);\n    }\n    if (texcoord >= 0) {\n      this.bindAttrib(texcoord, this.attributes.texcoord);\n    }\n    if (skinWeight >= 0) {\n      this.bindAttrib(skinWeight, this.attributes.skinWeight);\n    }\n    if (skinIndex >= 0) {\n      this.bindAttrib(skinIndex, this.attributes.skinIndex);\n    }\n  }\n\n  static fromThree(gls: GlState, geometry: THREE.BufferGeometry) {\n    const attributes: { [key: string]: Attribute } = {};\n    const buffers: Array<[ArrayLike<number>, Buffer]> = [];\n    for (const k of Object.keys(geometry.attributes)) {\n      const attr = geometry.attributes[k];\n      if (attr instanceof THREE.BufferAttribute) {\n        const buff = Buffer.arrayBuffer(gls).setData(attr.array as Float32Array);\n        buffers.push([attr.array, buff]);\n        attributes[k] = {\n          buffer: buff,\n          itemSize: attr.itemSize,\n          type: gls.gl.FLOAT,\n          normalized: false,\n          stride: 0,\n          offset: 0\n        }\n      } else if (attr instanceof THREE.InterleavedBufferAttribute) {\n        let buff = buffers.find(x => x[0] === attr.data.array);\n        if (!buff) {\n          const b = Buffer.arrayBuffer(gls).setData(attr.data.array as Float32Array);\n          buff = [attr.data.array, b];\n          buffers.push(buff);\n        }\n        const bytesPerElement = (attr.data.array as any).BYTES_PER_ELEMENT;\n        attributes[k] = {\n          buffer: buff[1],\n          itemSize: attr.itemSize,\n          type: typeFromArrayBuffer(gls.gl, attr.data.array as any),\n          normalized: attr.normalized,\n          stride: attr.data.stride * bytesPerElement,\n          offset: attr.offset * bytesPerElement\n        }\n      }\n    }\n    return new Mesh(\n      gls,\n      attributes,\n      buffers.map(x => x[1]),\n      geometry.index ? Buffer.elementArrayBuffer(gls).setData(geometry.index.array as Int32Array) : undefined\n    );\n  }\n}\n\nfunction typeFromArrayBuffer(gl: WebGL2RenderingContext, array: Float32Array | Int32Array | Int8Array | Uint8Array) {\n  if ( array instanceof Float32Array ) {\n    return gl.FLOAT;\n  } else if ( array instanceof Uint16Array ) {\n    return gl.UNSIGNED_SHORT;\n  } else if ( array instanceof Int16Array ) {\n    return gl.SHORT;\n  } else if ( array instanceof Uint32Array ) {\n    return gl.UNSIGNED_INT;\n  } else if ( array instanceof Int32Array ) {\n    return gl.INT;\n  } else if ( array instanceof Int8Array ) {\n    return gl.BYTE;\n  } else if ( array instanceof Uint8Array ) {\n    return gl.UNSIGNED_BYTE;\n  } else {\n    throw new Error(`Unsupported buffer type`);\n  }\n}\n\n\nexport function createQuadMesh(gls: GlState) {\n  return Mesh.createSimple3dTriangleStrip(gls, {\n    position: Buffer.arrayBuffer(gls).setData(new Float32Array([\n      -1, -1, 0,\n      -1, 1, 0,\n      1, -1, 0,\n      1, 1, 0,\n    ])),\n    normal: Buffer.arrayBuffer(gls).setData(new Float32Array([\n      0, 0, 1,\n      0, 0, 1,\n      0, 0, 1,\n      0, 0, 1,\n    ])),\n    texcoord: Buffer.arrayBuffer(gls).setData(new Float32Array([\n      0, 0,\n      0, 1,\n      1, 0,\n      1, 1,\n    ])),\n  });\n}\n\nexport function createGridMesh(gls: GlState, { width, height }: Size) {\n  const positions = new Float32Array((((width + 1) * 2 ) * height + height * 2) * 2);\n  let i = 0;\n  for (let y = 0; y < height; y++) {\n    positions[i++] = y; positions[i++] = 0; positions[i++] = 0;\n    for (let x = 0; x <= width; x++) {\n      positions[i++] = y; positions[i++] = x; positions[i++] = 0;\n      positions[i++] = y + 1; positions[i++] = x; positions[i++] = 0;\n    }\n    positions[i++] = y + 1; positions[i++] = width; positions[i++] = 0;\n  }\n  return Mesh.createSimple3dTriangleStrip(gls, { position: Buffer.arrayBuffer(gls).setData(new Float32Array(positions)) });\n}\n\nexport function createBoxMesh(gls: GlState) {\n  const min = { x: -1, y: -1, z: -1 };\n  const max = { x: 1, y: 1, z: 1 };\n  const positions = [\n    //-Z\n    min.x, min.y, min.z,\n    max.x, min.y, min.z,\n    min.x, max.y, min.z,\n    max.x, max.y, min.z,\n\n    //+Z\n    min.x, min.y, max.z,\n    min.x, max.y, max.z,\n    max.x, min.y, max.z,\n    max.x, max.y, max.z,\n\n    //-X\n    min.x, min.y, min.z,\n    min.x, max.y, min.z,\n    min.x, min.y, max.z,\n    min.x, max.y, max.z,\n\n    //+X\n    max.x, max.y, min.z,\n    max.x, min.y, min.z,\n    max.x, max.y, max.z,\n    max.x, min.y, max.z,\n\n    //-Y\n    max.x, min.y, min.z,\n    min.x, min.y, min.z,\n    max.x, min.y, max.z,\n    min.x, min.y, max.z,\n\n    //+Y\n    min.x, max.y, min.z,\n    max.x, max.y, min.z,\n    min.x, max.y, max.z,\n    max.x, max.y, max.z,\n  ];\n  const normals = [\n    //-Z\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n\n    //+Z\n    0.0, 0.0, 1.0,\n    0.0, 0.0, 1.0,\n    0.0, 0.0, 1.0,\n    0.0, 0.0, 1.0,\n\n    //-X\n    -1.0, 0.0, 0.0,\n    -1.0, 0.0, 0.0,\n    -1.0, 0.0, 0.0,\n    -1.0, 0.0, 0.0,\n\n    //+X\n    1.0, 0.0, 0.0,\n    1.0, 0.0, 0.0,\n    1.0, 0.0, 0.0,\n    1.0, 0.0, 0.0,\n\n    //-Y\n    0.0, -1.0, 0.0,\n    0.0, -1.0, 0.0,\n    0.0, -1.0, 0.0,\n    0.0, -1.0, 0.0,\n\n    //+Y\n    0.0, 1.0, 0.0,\n    0.0, 1.0, 0.0,\n    0.0, 1.0, 0.0,\n    0.0, 1.0, 0.0,\n  ];\n  const texcoords = [\n     //-Z\n     0.0, 0.0,\n     0.0, 1.0,\n     1.0, 0.0,\n     1.0, 1.0,\n\n     //+Z\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n     1.0, 0.0,\n\n     //-X\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n     1.0, 0.0,\n\n     //+X\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n     1.0, 0.0,\n\n     //-Y\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n     1.0, 0.0,\n\n     //+Y\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n     1.0, 0.0,\n  ];\n  const indices: number[] = [];\n  for (let i=0; i < 6; i++) {\n    indices.push(i * 4 + 0);\n    indices.push(i * 4 + 2);\n    indices.push(i * 4 + 1);\n\n    indices.push(i * 4 + 1);\n    indices.push(i * 4 + 2);\n    indices.push(i * 4 + 3);\n  }\n  return Mesh.create3dIndexed(gls, {\n    position: Buffer.arrayBuffer(gls).setData(new Float32Array(positions)),\n    normal: Buffer.arrayBuffer(gls).setData(new Float32Array(normals)),\n    texcoord: Buffer.arrayBuffer(gls).setData(new Float32Array(texcoords))\n  }, Buffer.elementArrayBuffer(gls).setData(new Uint16Array(indices)));\n}\n\nexport function createPyramidMesh(gls: GlState) {\n  const min = { x: -1, y: -1, z: -1 };\n  const max = { x: 1, y: 1, z: 1 };\n  const top = { x: 0, y: 0, z: 1 };\n  const positions = [\n    //-Z\n    min.x, min.y, min.z,\n    max.x, min.y, min.z,\n    min.x, max.y, min.z,\n    max.x, max.y, min.z,\n\n    //-X\n    min.x, min.y, min.z,\n    min.x, max.y, min.z,\n    top.x, top.y, top.z,\n\n    //+X\n    max.x, max.y, min.z,\n    max.x, min.y, min.z,\n    top.x, top.y, top.z,\n\n    //-Y\n    max.x, min.y, min.z,\n    min.x, min.y, min.z,\n    top.x, top.y, top.z,\n\n    //+Y\n    min.x, max.y, min.z,\n    max.x, max.y, min.z,\n    top.x, top.y, top.z,\n  ];\n  const normals = [\n    //-Z\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n    0.0, 0.0, -1.0,\n\n    //-X\n    -1.0, 0.0, 0.0,\n    -1.0, 0.0, 0.0,\n    -1.0, 0.0, 0.0,\n\n    //+X\n    1.0, 0.0, 0.0,\n    1.0, 0.0, 0.0,\n    1.0, 0.0, 0.0,\n\n    //-Y\n    0.0, -1.0, 0.0,\n    0.0, -1.0, 0.0,\n    0.0, -1.0, 0.0,\n\n    //+Y\n    0.0, 1.0, 0.0,\n    0.0, 1.0, 0.0,\n    0.0, 1.0, 0.0,\n  ];\n  const texcoords = [\n     //-Z\n     0.0, 0.0,\n     0.0, 1.0,\n     1.0, 0.0,\n     1.0, 1.0,\n\n     //-X\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n\n     //+X\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n\n     //-Y\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n\n     //+Y\n     0.0, 1.0,\n     1.0, 1.0,\n     0.0, 0.0,\n  ];\n  const indices: number[] = [];\n  // -Z\n  indices.push(0);\n  indices.push(2);\n  indices.push(1);\n\n  indices.push(1);\n  indices.push(2);\n  indices.push(3);\n  let offset = 4;\n  for (let i=0; i < 4; i++) {\n    indices.push(offset + i * 3 + 0);\n    indices.push(offset + i * 3 + 2);\n    indices.push(offset + i * 3 + 1);\n  }\n  return Mesh.create3dIndexed(gls, {\n    position: Buffer.arrayBuffer(gls).setData(new Float32Array(positions)),\n    normal: Buffer.arrayBuffer(gls).setData(new Float32Array(normals)),\n    texcoord: Buffer.arrayBuffer(gls).setData(new Float32Array(texcoords))\n  }, Buffer.elementArrayBuffer(gls).setData(new Uint16Array(indices)));\n}","import lodash from 'lodash'\n\nexport interface ResultOk<T> {\n  result: 'ok';\n  value: T;\n}\nexport function ok<T>(value: T): ResultOk<T> {\n  return {\n    result: 'ok',\n    value\n  }\n}\nexport function isOk<T, E>(result: Result<T, E>): result is ResultOk<T> {\n  return result.result === 'ok';\n}\nexport interface ResultErr<E> {\n  result: 'err';\n  error: E;\n}\nexport function err<E>(error: E): ResultErr<E> {\n  return {\n    result: 'err',\n    error\n  }\n}\nexport function isErr<T, E>(result: Result<T, E>): result is ResultErr<E> {\n  return result.result === 'err';\n}\nexport type Result<T, E = string> = ResultOk<T> | ResultErr<E>;\n\nexport function isResult<T, E>(value: Result<T, E> | T): value is Result<T, E> {\n  return lodash.isObject(value) && (isOk(value as Result<T, E>) || isErr(value as Result<T, E>));\n}\n\nclass UnwrapError<E> extends Error {\n  constructor(public error: E) {\n    super(`UnwrapError: ${JSON.stringify(error)}`);\n  }\n}\n\nexport function unwrap<T, E>(result: Result<T, E>): T {\n  if (isOk(result)) {\n    return result.value;\n  } else {\n    throw new UnwrapError(result.error);\n  }\n}\n\nexport function unwrapOr<T, E>(result: Result<T, E>, or: T): T {\n  if (isOk(result)) {\n    return result.value;\n  } else {\n    return or;\n  }\n}\n\nexport function unwrapError<T, E>(result: Result<T, E>): E {\n  if (isErr(result)) {\n    return result.error;\n  } else {\n    throw new Error('Result was ok');\n  }\n}\n\nexport function ifThen<T1, T2, E1, E2=E1>(a: Result<T1, E1>, b: (value: T1) => (Result<T2, E2> | T2)): Result<T2, E1 | E2> {\n  if (isErr(a)) {\n    return a;\n  } else {\n    const r = b(a.value);\n    if (isResult(r)) {\n      return r;\n    } else {\n      return ok(r);\n    }\n  }\n}\n\ntype ResolvableObject<T, E> = {\n  [P in keyof T]: Result<T[P], E>;\n};\n\nexport function resolveObject<T extends { [key: string]: any }, E>(\n    args: ResolvableObject<T, E>,\n    errType?: E\n  ): Result<T, E> {\n  const resolvedArgs = {} as any;\n  for (const key of Object.keys(args)) {\n    const res = args[key];\n    if (isErr(res)) {\n      return res;\n    } else {\n      resolvedArgs[key] = res.value;\n    }\n  }\n  return ok(resolvedArgs as T);\n}\n\nexport function resolveArray<T, E>(\n    array: Array<Result<T, E>>\n  ): Result<T[], E> {\n  const resolvedArray: T[] = [];\n  for (const res of array) {\n    if (isErr(res)) {\n      return res;\n    } else {\n      resolvedArray.push(res.value);\n    }\n  }\n  return ok(resolvedArray);\n}\n\nexport function mapError<T, E1, E2>(result: Result<T, E1>, map: (error: E1) => E2): Result<T, E2> {\n  if (isErr(result)) {\n    return err(map(result.error));\n  } else {\n    return result;\n  }\n}\n\nexport function mapOk<T1, T2, E>(result: Result<T1, E>, map: (ok: T1) => T2): Result<T2, E> {\n  if (isErr(result)) {\n    return result;\n  } else {\n    return ok(map(result.value));\n  }\n}\n","import { handleGlError } from \".\";\nimport * as Sentry from '@sentry/browser';\nimport { Result, err, ok, isErr, isOk } from \"../Result\";\n\nexport function addLineNumbersToSource(source: string): string {\n  return source.split('\\n').map((x, i) => (i + 1) + ': ' + x).join('\\n');\n}\n\nexport interface ShaderErrorCompile {\n  type: 'FailedToCompileShader';\n  message: string;\n  shaderType: 'vertex' | 'fragment';\n  shaderSource: string;\n}\nexport type ShaderError =\n  { type: 'FailedToCreateShader' } |\n  ShaderErrorCompile |\n  { type: 'FailedToLinkProgram', message: string, shaderSources: string[] } |\n  { type: 'FailedToCreateProgram' };\n\nexport function handleShaderErrorHandler(error: ShaderError) {\n  // tslint:disable-next-line:no-console\n  console.error(new Error().stack);\n  switch (error.type) {\n    case 'FailedToCompileShader':\n      // tslint:disable-next-line:no-console\n      console.error(addLineNumbersToSource(error.shaderSource));\n      // tslint:disable-next-line:no-console\n      console.error(error.message);\n      Sentry.captureException(new Error('Could not compile shader. \\n\\n' + error.message));\n      break;\n    case 'FailedToLinkProgram':\n      console.error(addLineNumbersToSource(error.shaderSources[0]));\n      console.error(addLineNumbersToSource(error.shaderSources[1]));\n      // tslint:disable-next-line:no-console\n      console.error(error.message);\n      Sentry.captureException(new Error('Could not compile WebGL program. \\n\\n' + error.message));\n      break;\n    default:\n      Sentry.captureException(new Error(error.type));\n  }\n}\n\nexport function shaderFromSource(gl: WebGL2RenderingContext, type: 'vertex' | 'fragment', sourceCode: string): Result<WebGLShader, ShaderError> {\n  // // tslint:disable-next-line:no-console\n  // console.log(sourceCode);\n  const shader = gl.createShader(type === 'vertex' ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\n  if (!shader) {\n    handleGlError(gl, 'Failed to create shader');\n    return err({ type: 'FailedToCreateShader' });\n  }\n  gl.shaderSource(shader, sourceCode);\n  gl.compileShader(shader);\n\n  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n    return err({\n      type: 'FailedToCompileShader',\n      message: gl.getShaderInfoLog(shader) || 'Unknown error',\n      shaderType: type,\n      shaderSource: sourceCode\n    });\n  }\n  return ok(shader);\n}\n\nexport function createProgram(gl: WebGL2RenderingContext, shaders: WebGLShader[], shaderSources: string[]): Result<WebGLProgram, ShaderError> {\n  const program = gl.createProgram();\n  if (!program) {\n    return err({ type: 'FailedToCreateProgram' });\n  }\n  for (const shader of shaders) {\n    gl.attachShader(program, shader);\n  }\n  gl.linkProgram(program);\n\n  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n    return err({ type: 'FailedToLinkProgram', message: gl.getProgramInfoLog(program) || 'Unknown error', shaderSources });\n  }\n  return ok(program);\n}\n\nexport class ShaderCache {\n  constructor(private gl: WebGL2RenderingContext) {}\n  destroy() {\n    for (const k of Object.keys(this.shaderCache)) {\n      const c = this.shaderCache[k].compiled;\n      if (isOk(c)) {\n        this.gl.deleteShader(c.value);\n      }\n    }\n  }\n\n  shaderCache: { [key: string]: { source: string, compiled: Result<WebGLShader, ShaderError> } } = {};\n\n  getShader(type: 'vertex' | 'fragment', source: string): Result<WebGLShader, ShaderError> {\n    let cached = this.shaderCache[source];\n    if (cached) {\n      return cached.compiled;\n    } else {\n      cached = this.shaderCache[source] = { source, compiled: shaderFromSource(this.gl, type, source) };\n      if (isErr(cached.compiled)) {\n        this.errors.push(cached.compiled.error);\n      }\n      return cached.compiled;\n    }\n  }\n  createProgram(vertexSource: string, fragmentSource: string, opts: { logErrors: boolean }): Result<WebGLProgram, ShaderError> {\n    const vs = this.getShader('vertex', vertexSource);\n    const fs = this.getShader('fragment', fragmentSource);\n    let compiled: Result<WebGLProgram, ShaderError>;\n    if (isErr(vs)) {\n      compiled = vs;\n    } else if (isErr(fs)) {\n      compiled = fs;\n    } else {\n      compiled = createProgram(this.gl, [vs.value, fs.value], [vertexSource, fragmentSource]);\n    }\n    if (isErr(compiled) && opts.logErrors) {\n      this.errors.push(compiled.error);\n      handleShaderErrorHandler(compiled.error);\n    }\n    return compiled;\n  }\n  errors: ShaderError[] = [];\n  getErrors(): ShaderError[] {\n    return this.errors;\n  }\n}\n","import * as Vector2 from '../Math/Vector2';\nimport * as Vector3 from '../Math/Vector3';\nimport * as Vector4 from '../Math/Vector4';\nimport { addLineNumbersToSource, ShaderError } from './ShaderCache';\nimport lodash from 'lodash';\nimport { mat4 } from 'gl-matrix';\nimport { isErr } from '../Result';\nimport { ITexture } from './Texture';\nimport { GlState, TextureFiltering, Destructible } from './GlState';\nimport { GLSLType, TextureRef } from './GLSLTypes';\nimport * as Mat4 from '../Math/Mat4';\n\nexport const quadVertexShader = `#version 300 es\nin vec3 Vertex_position;\nout vec2 texcoord;\n\nvoid main() {\n  texcoord = (Vertex_position.xy + 1.0) / 2.0;\n  gl_Position = vec4(Vertex_position, 1.0);\n}\n`;\n\nexport class Sampler {\n  constructor(public texture: ITexture, public filtering: TextureFiltering) {}\n  get is2dArray() { return this.texture.is2dArray; }\n}\n\nexport interface UniformTypeMappings {\n  'float': number,\n  'int': number,\n  'uint': number,\n  'bool': boolean,\n\n  'float[]': number[] | Float32Array,\n  'int[]': number[] | Int32Array,\n  'uint[]': number[] | Uint32Array,\n  'bool[]': boolean[] | Int32Array,\n\n  'vec2': Vector2.Vector2 | Float32Array,\n  'ivec2': Vector2.Vector2 | Int32Array,\n  'vec3': Vector3.Vector3 | Float32Array,\n  'ivec3': Vector3.Vector3 | Int32Array,\n  'vec4': Vector4.Vector4 | Float32Array,\n  'ivec4': Vector4.Vector4 | Int32Array,\n  'mat4': Mat4.Mat4 | Float32Array,\n\n  'vec2[]': Vector2.Vector2[] | Float32Array,\n  'ivec2[]': Vector2.Vector2[] | Int32Array,\n  'vec3[]': Vector3.Vector3[] | Float32Array,\n  'ivec3[]': Vector3.Vector3[] | Int32Array,\n  'vec4[]': Vector4.Vector4[] | Float32Array,\n  'ivec4[]': Vector4.Vector4[] | Int32Array,\n  'mat4[]': Mat4.Mat4[] | Float32Array,\n\n  'sampler2D': TextureRef,\n  'isampler2D': TextureRef,\n  'usampler2D': TextureRef,\n  'sampler2DArray': TextureRef,\n  'isampler2DArray': TextureRef,\n  'usampler2DArray': TextureRef,\n\n  'sampler2D[]': TextureRef[],\n  'isampler2D[]': TextureRef[],\n  'usampler2D[]': TextureRef[],\n  'sampler2DArray[]': TextureRef[],\n  'isampler2DArray[]': TextureRef[],\n  'usampler2DArray[]': TextureRef[],\n}\n\nexport interface UniformValue<T extends GLSLType = GLSLType> {\n  value: UniformTypeMappings[T];\n  type: GLSLType;\n}\nexport interface UniformValues {\n  [key: string]: UniformValue\n}\n\nexport function mergeUniformValues(...values: UniformValues[]): UniformValues {\n  return Object.assign({}, ...values);\n}\n\nclass CachingUniformWriter<T> {\n  constructor(private renderer: Program,\n    private glSet: (ul: WebGLUniformLocation, value: T) => void,\n    private isEqual: (a: T, b: T) => boolean) {}\n\n  values: { [key: string]: T } = {};\n\n  write(key: string, value: T, throwIfNotPresent: boolean = true) {\n    if (this.isEqual(this.values[key], value)) {\n      return;\n    }\n    this.values[key] = value;\n    const ul = this.renderer.getUniform(key, throwIfNotPresent);\n    if (ul) {\n      this.glSet(ul, value);\n    }\n  }\n}\n\nfunction vecArrayEquals<T>(a: T[] | Float32Array | Int32Array, b: T[] | Float32Array | Int32Array) {\n  return a === b;\n}\n\nfunction numberArrayEquals<T>(a: T[] | Float32Array | Int32Array, b: T[] | Float32Array | Int32Array) {\n  return a === b;\n}\n\nexport class Program implements Destructible {\n  constructor(public gls: GlState, public fragmentShaderSource: string,\n      public vertexShaderSource = quadVertexShader, { logErrors = true }: { logErrors?: boolean } = {}) {\n    const program = gls.shaderCache.createProgram(vertexShaderSource, fragmentShaderSource, { logErrors });\n    if (isErr(program)) {\n      this.error = program.error;\n    } else {\n      this.program = program.value;\n    }\n    Program.nAlivePrograms++;\n  }\n  destroy() {\n    this.gl.deleteProgram(this.program);\n    Program.nAlivePrograms--;\n  }\n  get gl() {\n    return this.gls.gl;\n  }\n  shader?: WebGLShader;\n  program: WebGLProgram | null = null;\n  error?: ShaderError;\n  public static nAlivePrograms = 0;\n\n  private uniforms: { [key: string]: WebGLUniformLocation | null } = {};\n  getUniform(key: string, required: boolean): WebGLUniformLocation | null {\n    if (!this.program) {\n      return null;\n    }\n    const gl = this.gl;\n    let uniform: WebGLUniformLocation | null = this.uniforms[key];\n    if (!uniform) {\n      uniform = gl.getUniformLocation(this.program, key);\n      if (!uniform && required) {\n        // tslint:disable-next-line:no-console\n        console.error('Vertex shader:');\n        // tslint:disable-next-line:no-console\n        console.error(addLineNumbersToSource(this.vertexShaderSource));\n        // tslint:disable-next-line:no-console\n        console.error('Fragment shader:');\n        // tslint:disable-next-line:no-console\n        console.error(addLineNumbersToSource(this.fragmentShaderSource));\n        throw new Error('No such uniform: ' + key);\n      }\n      this.uniforms[key] = uniform;\n    }\n    return uniform;\n  }\n  private attributes: { [name: string]: number } = {};\n  getAttribute(name: string) {\n    if (!this.program) {\n      return -1;\n    }\n    let loc = this.attributes[name];\n    if (loc !== undefined) {\n      return loc;\n    } else {\n      return this.attributes[name] = this.gl.getAttribLocation(this.program, name);\n    }\n  }\n\n  private writers = {\n    vec2:  new CachingUniformWriter<Vector2.Vector2>(this, (ul, value) => this.gl.uniform2f(ul, value.x, value.y), lodash.isEqual),\n    ivec2: new CachingUniformWriter<Vector2.Vector2>(this, (ul, value) => this.gl.uniform2i(ul, value.x, value.y), lodash.isEqual),\n    vec3:  new CachingUniformWriter<Vector3.Vector3>(this, (ul, value) => this.gl.uniform3f(ul, value.x, value.y, value.z), lodash.isEqual),\n    ivec3: new CachingUniformWriter<Vector3.Vector3>(this, (ul, value) => this.gl.uniform3i(ul, value.x, value.y, value.z), lodash.isEqual),\n    vec4:  new CachingUniformWriter<Vector4.Vector4>(this, (ul, value) => this.gl.uniform4f(ul, value.x, value.y, value.z, value.w), lodash.isEqual),\n    ivec4: new CachingUniformWriter<Vector4.Vector4>(this, (ul, value) => this.gl.uniform4i(ul, value.x, value.y, value.z, value.w), lodash.isEqual),\n    'vec2[]':  new CachingUniformWriter<Vector2.Vector2[] | Float32Array>(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform2fv(ul, value instanceof Float32Array ? value : lodash.flatMap(value, v => [v.x, v.y])); }, vecArrayEquals),\n    'ivec2[]': new CachingUniformWriter<Vector2.Vector2[] | Int32Array  >(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform2iv(ul, value instanceof Int32Array   ? value : lodash.flatMap(value, v => [v.x, v.y])); }, vecArrayEquals),\n    'vec3[]':  new CachingUniformWriter<Vector3.Vector3[] | Float32Array>(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform3fv(ul, value instanceof Float32Array ? value : lodash.flatMap(value, v => [v.x, v.y, v.z])); }, vecArrayEquals),\n    'ivec3[]': new CachingUniformWriter<Vector3.Vector3[] | Int32Array  >(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform3iv(ul, value instanceof Int32Array   ? value : lodash.flatMap(value, v => [v.x, v.y, v.z])); }, vecArrayEquals),\n    'vec4[]':  new CachingUniformWriter<Vector4.Vector4[] | Float32Array>(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform4fv(ul, value instanceof Float32Array ? value : lodash.flatMap(value, v => [v.x, v.y, v.z, v.w])); }, vecArrayEquals),\n    'ivec4[]': new CachingUniformWriter<Vector4.Vector4[] | Int32Array  >(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform4iv(ul, value instanceof Int32Array   ? value : lodash.flatMap(value, v => [v.x, v.y, v.z, v.w])); }, vecArrayEquals),\n\n    mat4: new CachingUniformWriter<mat4>(this, (ul, value) => this.gl.uniformMatrix4fv(ul, false, value), (a, b) => a === b),\n    int: new CachingUniformWriter<number>(this, (ul, value) => this.gl.uniform1i(ul, value), (a, b) => a === b),\n    uint: new CachingUniformWriter<number>(this, (ul, value) => this.gl.uniform1ui(ul, value), (a, b) => a === b),\n    float: new CachingUniformWriter<number>(this, (ul, value) => this.gl.uniform1f(ul, value), (a, b) => a === b),\n    bool: new CachingUniformWriter<boolean>(this, (ul, value) => this.gl.uniform1i(ul, value ? 1 : 0), (a, b) => a === b),\n\n    'float[]': new CachingUniformWriter<number[] | Float32Array>(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform1fv(ul, value); }, numberArrayEquals),\n    'int[]': new CachingUniformWriter<number[] | Int32Array  >(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform1iv(ul, value); }, numberArrayEquals),\n    'bool[]': new CachingUniformWriter<boolean[] >(this, (ul, value) => { if (value.length === 0) { return; } this.gl.uniform1iv(ul, value.map(x => x ? 1 : 0)); }, numberArrayEquals),\n  }\n\n  private textureUnitOffset = 0;\n  prepare() {\n    this.textureUnitOffset = 0;\n    this.gls.program = this.program;\n  }\n\n  private setTexture(key: string, value: ITexture | Sampler | undefined, expect2dArray: boolean, required?: boolean) {\n    if (!value) {\n      this.writers.int.write(key, -1, required);\n      return;\n    }\n\n    const sampler = value;\n    const tex = sampler instanceof Sampler ? sampler.texture : sampler;\n    if (sampler.is2dArray !== expect2dArray) {\n      throw new Error(`Expected texture \"${key}\" ${expect2dArray ? 'to be' : 'to not be'} 2d array, but it ${sampler.is2dArray ? 'is' : 'is not'} 2d array`);\n    }\n    if (!tex.inited) {\n      throw new Error(`Texture has not been initialized`);\n    }\n    const index = this.textureUnitOffset++;\n    this.gls.setActiveTexture(index, tex.isDoubleBuffered ? tex.front : tex);\n    const filtering = sampler instanceof Sampler ? sampler.filtering : TextureFiltering.Nearest;\n    this.gls.setSampler(index, filtering);\n\n    this.writers.int.write(key, index, required);\n  }\n\n  private setTextureArray(key: string, values: Array<ITexture | Sampler>, expect2dArray: boolean, required?: boolean) {\n    const inputTextures: number[] = [];\n    for (const sampler of values) {\n      const tex = sampler instanceof Sampler ? sampler.texture : sampler;\n      if (sampler.is2dArray !== expect2dArray) {\n        throw new Error(`Expected texture \"${key}\" to ${expect2dArray ? '' : 'not'} be 2d array, but it ${expect2dArray ? 'is' : 'is not'}`);\n      }\n      if (!tex.inited) {\n        throw new Error(`Texture has not been initialized`);\n      }\n      // const index = this.common.activeTextures.bind(target, sampler);\n      const index = this.textureUnitOffset++;\n      this.gls.setActiveTexture(index, tex.isDoubleBuffered ? tex.front : tex);\n      const filtering = sampler instanceof Sampler ? sampler.filtering : TextureFiltering.Nearest;\n      this.gls.setSampler(index, filtering);\n      inputTextures.push(index);\n    }\n\n    this.writers['int[]'].write(key, inputTextures, required);\n  }\n\n  setUniform<T extends GLSLType>(key: string, type: T, value: UniformTypeMappings[T], required?: boolean) {\n    this.gls.program = this.program;\n    const isNormalSampler = type === 'isampler2D' || type === 'usampler2D' || type === 'sampler2D';\n    const isArraySampler = type === 'isampler2DArray' || type === 'usampler2DArray' || type === 'sampler2DArray';\n\n    const isNormalMultiSampler = type === 'isampler2D[]' || type === 'usampler2D[]' || type === 'sampler2D[]';\n    const isArrayMultiSampler = type === 'isampler2DArray[]' || type === 'usampler2DArray[]' || type === 'sampler2DArray[]';\n\n    if (isNormalSampler || isArraySampler) {\n      this.setTexture(key, value as (Sampler | undefined), isArraySampler, required);\n    } else if (isNormalMultiSampler || isArrayMultiSampler) {\n      this.setTextureArray(key, value as Sampler[], isArrayMultiSampler, required);\n    } else {\n      this.writers[type as any].write(key, value, required);\n    }\n  }\n\n  setUniforms(uniformValues: UniformValues, uniformIgnoreIfNotPresent: string[] = [], textureUnitOffset = 0) {\n    this.textureUnitOffset = textureUnitOffset;\n    this.gls.program = this.program;\n    for (const key of Object.keys(uniformValues)) {\n      const v = uniformValues[key];\n      this.setUniform(key, v.type, v.value, uniformIgnoreIfNotPresent.indexOf(key) === -1);\n    }\n    return this.textureUnitOffset;\n  }\n\n}\n","import { computationShaderHeader } from \"..\";\nimport { Program } from \"../Program\";\nimport { createBatches } from \"../Computation\";\nimport { TextureSlicing, DoubleBufferedTextureSlicing } from \"../Texture\";\nimport { GlState, BlendMode } from \"../GlState\";\nimport { RenderTarget } from \"../RenderTarget\";\n\nexport type CopyType = 'set' | 'sum';\n\nclass CopyTextureForFormat {\n  constructor(private gls: GlState, private format: 'float' | 'int' | 'uint') {}\n  private renderTarget = new RenderTarget(this.gls);\n  private pre = this.format === 'int' ? 'i' : this.format === 'uint' ? 'u' : '';\n  private nLayers = this.gls.maxColorAttachements;\n  private multi = new Program(this.gls, computationShaderHeader + `\n    out ${this.pre}vec4 out_values[${this.nLayers}];\n\n    uniform int layers[${this.nLayers}];\n    uniform ${this.pre}sampler2DArray source;\n    uniform ivec2 sourceOffset;\n\n    void main() {\n      ${\n        new Array(this.nLayers).fill(0).map((x, i) => `\n          out_values[${i}] = texelFetch(source, ivec3(cellPos + sourceOffset, layers[${i}]), 0);\n        `).join('\\n')\n      }\n    }\n  `);\n  private single = new Program(this.gls, computationShaderHeader + `\n    out ${this.pre}vec4 out_value;\n\n    uniform ${this.pre}sampler2D source;\n    uniform ivec2 sourceOffset;\n\n    void main() {\n      out_value = texelFetch(source, cellPos + sourceOffset, 0);\n    }\n  `);\n  copy(target: TextureSlicing, source: TextureSlicing, copyType: CopyType = 'set') {\n    this.gls.prepareForComputation(target.rect, copyType === 'set' ? undefined : BlendMode.Sum);\n    const sourceOffset = {\n      x: source.rect.x - target.rect.x,\n      y: source.rect.y - target.rect.y,\n    }\n    if (source.texture.is2dArray) {\n      for (const { l, count } of createBatches(target.layers.length, this.nLayers)) {\n        this.renderTarget.set(target.sliceRange(l, count));\n        this.multi.setUniforms({\n          source: {\n            type: this.format === 'int' ? 'isampler2DArray' : this.format === 'uint' ? 'usampler2DArray' : 'sampler2DArray',\n            value: source.texture\n          },\n          layers: {\n            type: 'int[]',\n            value: source.layers.slice(l, l + count)\n          },\n          sourceOffset: {\n            type: 'ivec2',\n            value: sourceOffset\n          }\n        });\n        this.gls.drawQuad(this.multi);\n      }\n    } else {\n      this.renderTarget.set(target);\n      this.single.setUniforms({\n        source: {\n          type: this.format === 'int' ? 'isampler2D' : this.format === 'uint' ? 'usampler2D' : 'sampler2D',\n          value: source.texture\n        },\n        sourceOffset: {\n          type: 'ivec2',\n          value: sourceOffset\n        }\n      });\n      this.gls.drawQuad(this.single);\n    }\n  }\n  copyBackToFront(texture: DoubleBufferedTextureSlicing) {\n    this.copy(texture.front, texture.back);\n  }\n}\nexport class CopyTexture {\n  constructor(private gls: GlState) {}\n  formats = {\n    float: new CopyTextureForFormat(this.gls, 'float'),\n    int: new CopyTextureForFormat(this.gls, 'int'),\n    uint: new CopyTextureForFormat(this.gls, 'uint')\n  }\n  copy(target: TextureSlicing, source: TextureSlicing, copyType?: CopyType) {\n    this.formats[target.texture.formatType].copy(target, source, copyType);\n  }\n  copyBackToFront(texture: DoubleBufferedTextureSlicing) {\n    this.formats[texture.texture.formatType].copyBackToFront(texture);\n  }\n}\n","import { Texture } from \"./Texture\";\nimport { Mesh, createQuadMesh, createBoxMesh } from \"./Mesh\";\nimport { ShaderCache } from \"./ShaderCache\";\nimport { OutputRect } from \"./Computation\";\nimport { Program } from \"./Program\";\nimport { CopyTexture } from \"./Computations/Copy\";\nimport { initGlExtensions } from \".\";\nimport * as THREE from \"three\";\nimport { Size } from \"../Math/Math\";\n\nexport interface Destructible {\n  destroy(): void;\n}\n\nclass GpuStateCurrent {\n  constructor(private gl: WebGL2RenderingContext) {}\n\n  maxCombinedTextureImageUnits = this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS);\n\n  framebuffer: WebGLFramebuffer | null | undefined = undefined;\n  program: WebGLProgram | null | undefined = undefined;\n  // mesh: Mesh | null | undefined = undefined;\n  activeTextures: Array<Texture | null | undefined> = new Array(this.maxCombinedTextureImageUnits).fill(undefined);\n  samplers: Array<TextureFiltering | null | undefined> = new Array(this.maxCombinedTextureImageUnits).fill(undefined);\n  viewport: OutputRect = { width: 0, height: 0 };\n  caps = {};\n  enabledVertexAttribArray: number[] = [];\n}\n\n// Because it's expensive to update state in GL all states need to be cached and only updated when actually changed\nexport class GlState {\n  constructor(public canvas: HTMLCanvasElement, public gl: WebGL2RenderingContext) {\n    for (const e of initGlExtensions(gl)) {\n      console.warn(`Missing GL extension:`, e);\n    }\n    gl.disable(gl.BLEND);\n    canvas.addEventListener(\"webglcontextlost\", () => this.contextLost = true);\n  }\n  destroy() {\n    for (const k of Object.keys(this.meshes)) {\n      this.meshes[k].destroy();\n    }\n  }\n\n  private current = new GpuStateCurrent(this.gl);\n  // eslint-disable-next-line no-use-before-define\n  private commonSamplers = new CommonSamplers(this.gl);\n\n  public contextLost = false;\n  public shaderCache = new ShaderCache(this.gl);\n\n  public reset() {\n    this.current = new GpuStateCurrent(this.gl);\n  }\n\n  get framebuffer() { return this.current.framebuffer || null; }\n  set framebuffer(value: WebGLFramebuffer | null) {\n    if (this.current.framebuffer !== value) {\n      this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, value);\n      this.current.framebuffer = value;\n    }\n  }\n\n  get program() { return this.current.program || null; }\n  set program(value: WebGLProgram | null) {\n    if (this.current.program !== value) {\n      this.gl.useProgram(value);\n      this.current.program = value;\n    }\n  }\n\n  // private get mesh() { return this.current.mesh || null; }\n  // private set mesh(value: Mesh | null) {\n  //   if (this.current.mesh !== value) {\n  //     if (value) {\n  //       value.bind();\n  //     }\n  //     this.current.mesh = value;\n  //   }\n  // }\n\n  getActiveTexture(index: number) {\n    return this.current.activeTextures[index];\n  }\n  setActiveTexture(index: number, value: Texture | null) {\n    if (this.current.activeTextures[index] !== value) {\n      const gl = this.gl;\n      gl.activeTexture(gl.TEXTURE0 + index);\n      const target = value && value.is2dArray ? gl.TEXTURE_2D_ARRAY : gl.TEXTURE_2D;\n      const nonTarget = value && value.is2dArray ? gl.TEXTURE_2D : gl.TEXTURE_2D_ARRAY;\n      gl.bindTexture(target, value ? value.texture : null);\n      gl.bindTexture(nonTarget, null);\n\n      this.current.activeTextures[index] = value;\n    }\n  }\n  get enabledVertexAttribArray() { return this.current.enabledVertexAttribArray; }\n  set enabledVertexAttribArray(value: number[]) {\n    for (const i of this.current.enabledVertexAttribArray) {\n      if (value.indexOf(i) === -1) {\n        this.gl.disableVertexAttribArray(i);\n      }\n    }\n    for (const i of value) {\n      if (this.current.enabledVertexAttribArray.indexOf(i) === -1) {\n        this.gl.enableVertexAttribArray(i);\n      }\n    }\n    this.current.enabledVertexAttribArray = value;\n  }\n\n  getSampler(index: number) {\n    return this.current.samplers[index];\n  }\n  setSampler(index: number, value: TextureFiltering) {\n    if (this.current.samplers[index] !== value) {\n      this.gl.bindSampler(index, this.commonSamplers.getSampler(value));\n      this.current.samplers[index] = value;\n    }\n  }\n\n  get viewport() { return this.current.viewport; }\n  set viewport(value: OutputRect) {\n    this.gl.viewport(value.x !== undefined ? value.x : 0, value.y !== undefined ? value.y : 0,\n      value.width, value.height);\n    this.current.viewport = value;\n  }\n\n  getCap(cap: number) { return !!this.current.caps[cap]; }\n  setCap(cap: number, value: boolean) {\n    if (this.current.caps[cap] !== value) {\n      if (value) {\n        this.gl.enable(cap);\n      } else {\n        this.gl.disable(cap);\n      }\n      this.current.caps[cap] = value;\n    }\n  }\n  enable(cap: number) { this.setCap(cap, true); }\n  disable(cap: number) { this.setCap(cap, false); }\n\n  blendFunc(sfactor: number, dfactor: number) {\n    this.gl.blendFunc(sfactor, dfactor);\n  }\n  blendFuncSeparate(srcRGB: number, dstRGB: number, srcAlpha: number, dstAlpha: number) {\n    this.gl.blendFuncSeparate(srcRGB, dstRGB, srcAlpha, dstAlpha);\n  }\n  blendEquation(mode: number) {\n    this.gl.blendEquation(mode);\n  }\n  depthFunc(func: number) {\n    this.gl.depthFunc(func);\n  }\n  cullFace(mode: number) {\n    this.gl.cullFace(mode);\n  }\n  polygonOffset(factor: number, units: number) {\n    this.gl.polygonOffset(factor, units);\n  }\n  depthMask(flag: boolean) {\n    this.gl.depthMask(flag);\n  }\n\n  draw(program: Program, mesh: Mesh, instanceCount?: number) {\n    this.program = program.program;\n    // this.mesh = mesh;\n    mesh.bind(program);\n\n    const gl = this.gl;\n    if (mesh.index) {\n      if (instanceCount !== undefined) {\n        gl.drawElementsInstanced(gl.TRIANGLES, mesh.index.size, gl.UNSIGNED_SHORT, 0, instanceCount);\n      } else {\n        gl.drawElements(gl.TRIANGLES, mesh.index.size, gl.UNSIGNED_SHORT, 0);\n      }\n    } else {\n      const nVertices = mesh.attributes.position.buffer.size / mesh.attributes.position.itemSize;\n      if (instanceCount !== undefined) {\n        gl.drawArraysInstanced(gl.TRIANGLE_STRIP, 0, nVertices, instanceCount);\n      } else {\n        gl.drawArrays(gl.TRIANGLE_STRIP, 0, nVertices);\n      }\n    }\n    this.stats.drawCalls++;\n\n    // const status = this.gl.getError();\n    // if (status !== this.gl.NO_ERROR) {\n    //   throw new Error(`Gl error: ${status} ${getGlConstantName(this.gl, status)}`);\n    // }\n  }\n  drawQuad(program: Program, instanceCount?: number) {\n    this.draw(program, this.meshes.quad, instanceCount);\n  }\n\n  // Some generally usefull stuff\n  private meshes: { [key: string]: Mesh } = {\n    box: createBoxMesh(this),\n    quad: createQuadMesh(this),\n    sphere: Mesh.fromThree(this, new THREE.SphereBufferGeometry(1, 0))\n  };\n  public textures: { [key: string]: Texture } = {\n  }\n  public samplers: { [key: string]: Texture } = {\n  }\n  getMesh(id: string) {\n    if (this.meshes[id]) {\n      return this.meshes[id];\n    } else {\n      const m = MeshLoaders[id];\n      if (m) {\n        return this.meshes[id] = m(this);\n      } else {\n        return undefined;\n      }\n    }\n  }\n  private tmpTextures: { [key: string]: Texture } = {};\n  getTmpTexture(internalFormat: number, minSize: Size, minDepth: number) {\n    let t = this.tmpTextures[internalFormat];\n    if (!t || t.size.width < minSize.width || t.size.height < minSize.height || t.depth! < minDepth) {\n      if (t) {\n        t.destroy();\n      }\n      const newSize = t ? { width: t.size.width, height: t.size.height } : { width: 1, height: 1 };\n      let newDepth = t ? t.depth! : 1;\n      while (newSize.width < minSize.width) {\n        newSize.width *= 2;\n      }\n      while (newSize.height < minSize.height) {\n        newSize.height *= 2;\n      }\n      while (newDepth < minDepth) {\n        newDepth *= 2;\n      }\n      this.tmpTextures[internalFormat] = t = new Texture(this, internalFormat, newSize, newDepth).init();\n      // console.log(`[getTmpTexture] Resizing ${internalFormat} ${JSON.stringify(t.size)} ${t.depth}`);\n    }\n    return t;\n  }\n  getTmpTextureSlice(internalFormat: number, size: Size, depth: number) {\n    return this.getTmpTexture(internalFormat, size, depth)\n      .sliceRange(0, depth)\n      .selectAbsolute({ x: 0, y: 0, width: size.width, height: size.height });\n  }\n  stats = {\n    drawCalls: 0\n  }\n  maxColorAttachements = this.gl.getParameter(this.gl.MAX_COLOR_ATTACHMENTS);\n  maxCombinedTextureImageUnits = this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS);\n  maxTextureSize = this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE);\n  private copyTexture = new CopyTexture(this);\n  getCopyLayers() {\n    return this.copyTexture;\n  }\n  getCopyTexture() {\n    return this.copyTexture;\n  }\n  prepareForComputation(outputRect: OutputRect, blendMode?: BlendMode) {\n    this.viewport = outputRect;\n    if (blendMode) {\n      this.enable(this.gl.BLEND);\n      this.blendEquation(blendMode.equation);\n      this.blendFunc(blendMode.sfactor, blendMode.dfactor);\n    } else {\n      this.disable(this.gl.BLEND);\n    }\n    this.disable(this.gl.CULL_FACE);\n    this.disable(this.gl.DEPTH_TEST);\n  }\n}\n\nfunction createDummyGL() {\n  const canvas = document.createElement('canvas');\n  return canvas.getContext('webgl2') || {} as any as WebGL2RenderingContext;\n}\nexport const GL = createDummyGL();\n\nexport class BlendMode {\n  constructor(public sfactor: number, public dfactor: number, public equation: number) {}\n  static Sum = new BlendMode(GL.ONE, GL.ONE, GL.FUNC_ADD);\n  static Alpha = new BlendMode(GL.SRC_ALPHA, GL.ONE_MINUS_SRC_ALPHA, GL.FUNC_ADD);\n}\nexport const MeshLoaders: {\n  [id: string]: (gls: GlState) => Mesh\n} = {\n};\n\n\nexport enum TextureFiltering {\n  Nearest,\n  Linear,\n  MipMap,\n  LinearMipMap,\n}\n\nexport class CommonSamplers {\n  constructor(private gl: WebGL2RenderingContext) {\n    if (!this.nearestSampler || !this.linearSampler || !this.mipmapSampler || !this.linearMipmapSampler) {\n      throw new Error('Failed to create sampler');\n    }\n    gl.samplerParameteri(this.nearestSampler, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n    gl.samplerParameteri(this.nearestSampler, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n    gl.samplerParameteri(this.nearestSampler, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.samplerParameteri(this.nearestSampler, gl.TEXTURE_WRAP_T, gl.REPEAT);\n\n    gl.samplerParameteri(this.linearSampler, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.samplerParameteri(this.linearSampler, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n    gl.samplerParameteri(this.linearSampler, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.samplerParameteri(this.linearSampler, gl.TEXTURE_WRAP_T, gl.REPEAT);\n\n    gl.samplerParameteri(this.mipmapSampler, gl.TEXTURE_MIN_FILTER, gl.NEAREST_MIPMAP_LINEAR);\n    gl.samplerParameteri(this.mipmapSampler, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n    gl.samplerParameteri(this.mipmapSampler, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.samplerParameteri(this.mipmapSampler, gl.TEXTURE_WRAP_T, gl.REPEAT);\n\n    gl.samplerParameteri(this.linearMipmapSampler, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n    gl.samplerParameteri(this.linearMipmapSampler, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n    gl.samplerParameteri(this.linearMipmapSampler, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.samplerParameteri(this.linearMipmapSampler, gl.TEXTURE_WRAP_T, gl.REPEAT);\n  }\n  destroy() {\n    this.gl.deleteSampler(this.nearestSampler);\n    this.gl.deleteSampler(this.linearSampler);\n    this.gl.deleteSampler(this.mipmapSampler);\n    this.gl.deleteSampler(this.linearMipmapSampler);\n  }\n  nearestSampler = this.gl.createSampler();\n  linearSampler = this.gl.createSampler();\n  mipmapSampler = this.gl.createSampler();\n  linearMipmapSampler = this.gl.createSampler();\n\n  getSampler(sampler: TextureFiltering) {\n    return sampler === TextureFiltering.Nearest ? this.nearestSampler :\n      sampler === TextureFiltering.MipMap ? this.mipmapSampler :\n      sampler === TextureFiltering.LinearMipMap ? this.linearMipmapSampler :\n      this.linearSampler;\n  }\n\n  setupTextureFiltering(unit: number, target: number, filtering: TextureFiltering) {\n    const gl = this.gl;\n\n    // For some reason on windows the sampler object isn't respected, so need to make sure the texture is set up right here\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER,\n      filtering === TextureFiltering.Linear ? gl.LINEAR :\n      filtering === TextureFiltering.MipMap ? gl.NEAREST_MIPMAP_LINEAR :\n      filtering === TextureFiltering.LinearMipMap ? gl.LINEAR_MIPMAP_LINEAR :\n      gl.NEAREST);\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER,\n      filtering === TextureFiltering.Linear ? gl.LINEAR :\n      filtering === TextureFiltering.MipMap ? gl.LINEAR :\n      gl.NEAREST);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.REPEAT);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.REPEAT);\n    gl.bindSampler(unit, this.getSampler(filtering));\n  }\n\n}\n","import { GlState, GL } from \"../GlState\";\nimport { GpuBuffer, ECSConsts, GpuComponent, Archetype, chunkAddressFromEntityCell, componentFormatChannels, EntitiesRange } from \".\";\nimport { Texture, TextureSlicing } from \"../Texture\";\nimport { Vector2 } from \"../../Math/Vector2\";\nimport { Vector4 } from \"../../Math/Vector4\";\nimport { EntityRef } from \"../../GpuWorld/StateData\";\nimport { Image } from \"../Image\";\nimport { flatMap } from \"lodash\";\n\nexport function componentBufferDepth(component: GpuComponent) {\n  if (component.buffer.format === 'float') {\n    return componentFormatChannels(component.format) * (component.depth ?? 1);\n  } else {\n    if (component.format === 'mat4') {\n      return 4 * (component.depth ?? 1);\n    } else {\n      return component.depth ?? 1;\n    }\n  }\n}\n\ninterface GpuBufferArchetype {\n  archetypeIndex: number;\n  dataRowOffset: number;\n  chunks: number;\n}\nexport class GpuBufferData {\n  constructor(private gls: GlState,\n    public def: GpuBuffer) {\n  }\n  destroy() {\n    this.texture.destroy();\n  }\n\n  dataRowToArchetype: Int32Array = new Int32Array(0);\n  archetypeToDataRowOffset: Int32Array = new Int32Array(0);\n\n  size = { width: ECSConsts.ChunkSize, height: 1, depth: 1 };\n  texture = Texture.create(this.gls,\n    getGpuBufferInternalFormat(this.def.format),\n    this.size, this.size.depth).init();\n\n  public components: {\n    [key: string]: {\n      layerOffset: number;\n    };\n  } = {};\n\n  public archetypes: Array<GpuBufferArchetype | undefined> = [];\n\n  public get sizeVec2() { return { x: this.size.width, y: this.size.height }; }\n\n  private copy = this.gls.getCopyTexture();\n\n  removeAllEntities() {\n    this.dataRowToArchetype = new Int32Array(0);\n    this.archetypeToDataRowOffset = new Int32Array(0);\n    this.size = { width: ECSConsts.ChunkSize, height: 1, depth: 1 };\n  }\n\n  enuserComponentAllocated(component: GpuComponent) {\n    const c = this.components[component.name];\n    if (!c) {\n      const oldDepth = Object.keys(this.components).length === 0 ? 0 : this.size.depth;\n      this.components[component.name] = {\n        layerOffset: oldDepth\n      };\n      const newDepth = oldDepth + componentBufferDepth(component);\n      this.size.depth = newDepth;\n      if (this.texture.depth! < newDepth) {\n        const texOldDepth = this.texture.depth!;\n        const tmp = this.gls.getTmpTextureSlice(\n          getGpuBufferInternalFormat(this.def.format),\n          this.texture.size, newDepth\n        );\n        tmp.clear([0, 0, 0, 0]);\n        this.copy.copy(tmp.sliceRange(0, texOldDepth), this.texture.sliceAll());\n        this.texture.destroy();\n        this.texture = Texture.create(this.gls,\n          getGpuBufferInternalFormat(this.def.format),\n          this.texture.size, newDepth).init();\n        this.copy.copy(this.texture.sliceAll(), tmp);\n      }\n    }\n  }\n\n  setArchetypeChunks(archetype: Archetype, chunks: number) {\n    const arch: GpuBufferArchetype = this.archetypes[archetype.index] || {\n      archetypeIndex: archetype.index,\n      dataRowOffset: -1000,\n      chunks: 0\n    };\n    if (arch.chunks === chunks) {\n      return;\n    }\n    this.archetypes[archetype.index] = arch;\n\n    const heightChange = chunks - arch.chunks;\n    const oldHeight = this.dataRowToArchetype.length;\n    const newHeight = oldHeight + heightChange;\n    const tmp = this.gls.getTmpTextureSlice(\n      getGpuBufferInternalFormat(this.def.format),\n      { width: this.size.width, height: newHeight }, this.size.depth);\n    tmp.clear([0, 0, 0, 0]);\n\n    if (arch.dataRowOffset < 0) {\n      arch.dataRowOffset = oldHeight;\n    }\n\n    const sourceTop = this.texture.sliceAll().selectAbsolute({\n      x: 0,\n      y: 0,\n      width: this.size.width,\n      height: arch.dataRowOffset + arch.chunks\n    });\n    const destTop = tmp.selectAbsolute({\n      x: 0,\n      y: 0,\n      width: this.size.width,\n      height: arch.dataRowOffset + arch.chunks\n    });\n\n    const sourceBottom = this.texture.sliceAll().selectAbsolute({\n      x: 0,\n      y: arch.dataRowOffset + arch.chunks,\n      width: this.size.width,\n      height: oldHeight - (arch.dataRowOffset + arch.chunks)\n    });\n    const destBottom = tmp.selectAbsolute({\n      x: 0,\n      y: arch.dataRowOffset + chunks,\n      width: this.size.width,\n      height: sourceBottom.rect.height\n    });\n    this.copy.copy(destTop, sourceTop);\n    if (sourceBottom.rect.height > 0) {\n      this.copy.copy(destBottom, sourceBottom);\n    }\n    if (this.texture.size.height < tmp.rect.height) {\n      this.texture.destroy();\n      this.texture = Texture.create(this.gls,\n        getGpuBufferInternalFormat(this.def.format),\n        { width: tmp.rect.width, height: tmp.rect.height }, this.texture.depth).init();\n    }\n    this.copy.copy(this.texture.sliceAll(), tmp);\n    this.size.height = tmp.rect.height;\n\n    arch.chunks = chunks;\n    for (let i=arch.archetypeIndex + 1; i < this.archetypes.length; i++) {\n      const a = this.archetypes[i];\n      if (a && a.dataRowOffset >= 0) {\n        a.dataRowOffset += heightChange;\n      }\n    }\n\n    this.dataRowToArchetype = new Int32Array(this.size.height).fill(-1);\n    for (const arch2 of this.archetypes) {\n      if (arch2 && arch2.dataRowOffset >= 0) {\n        for (let r=0; r < arch2.chunks; r++) {\n          this.dataRowToArchetype[arch2.dataRowOffset + r] = arch2.archetypeIndex;\n        }\n      }\n    }\n\n    this.archetypeToDataRowOffset = new Int32Array(this.archetypes.map(a => a ? a.dataRowOffset : -1000));\n  }\n\n  dataCell(entityCell: Vector2) {\n    const { chunkIndex, entityIndex, archIndex } = chunkAddressFromEntityCell(entityCell);\n    const arch = this.archetypes[archIndex];\n    if (!arch) {\n      return undefined;\n    }\n    return {\n      x: entityIndex,\n      y: chunkIndex + arch.dataRowOffset\n    }\n  }\n\n  getArchetypeComponentDataSlice(component: GpuComponent, arch: Archetype) {\n    const buffArch = this.archetypes[arch.index]!;\n    return this.texture\n      .sliceRange(this.components[component.name].layerOffset, componentBufferDepth(component))\n      .selectAbsolute({\n        x: 0,\n        y: buffArch.dataRowOffset,\n        width: arch.chunks.reduce((p, x) => Math.max(p, x.entities), 0),\n        height: arch.chunks.length\n      })\n  }\n  getArchetypeComponentData(component: GpuComponent, arch: Archetype) {\n    const img = this.getArchetypeComponentDataSlice(component, arch).readSync();\n    return flatMap(arch.chunks, (chunk, i) => {\n      const data = img.select({\n        x: 0,\n        y: i,\n        width: chunk.entities,\n        height: 1\n      });\n      return imageToComponentData(component, data.toImage());\n    })\n  }\n  *getRangeComponentDataSlices(component: GpuComponent, range: EntitiesRange): Generator<TextureSlicing> {\n    if (range.count === 0) {\n      return;\n    }\n    const buffArch = this.archetypes[range.archetypeIndex]!;\n    const slice = this.texture\n      .sliceRange(this.components[component.name].layerOffset, componentBufferDepth(component))\n      .selectAbsolute({\n        x: 0,\n        y: buffArch.dataRowOffset,\n        width: ECSConsts.ChunkSize,\n        height: 1\n      });\n    let start = chunkAddressFromEntityCell({ x: range.startIndex, y: range.archetypeIndex });\n    if (start.entityIndex !== 0) {\n      const end = Math.min(ECSConsts.ChunkSize, start.entityIndex + range.count);\n      const count = end - start.entityIndex;\n      yield slice.selectRelative({\n        x: start.entityIndex,\n        y: 0,\n        width: count,\n        height: 1\n      });\n      for (const res of this.getRangeComponentDataSlices(component, new EntitiesRange(range.archetypeIndex,\n          range.startIndex + count,\n          range.count - count\n        ))) {\n        yield res;\n      }\n    } else {\n      const end = chunkAddressFromEntityCell({ x: range.startIndex + range.count - 1, y: range.archetypeIndex });\n      if (end.entityIndex !== 0) {\n        for (const res of this.getRangeComponentDataSlices(component, new EntitiesRange(range.archetypeIndex,\n            range.startIndex,\n            range.count - (end.entityIndex + 1)\n          ))) {\n          yield res;\n        }\n        yield slice.selectRelative({\n          x: 0,\n          y: end.chunkIndex,\n          width: end.entityIndex + 1,\n          height: 1\n        });\n      } else {\n        yield slice.selectRelative({\n          x: 0,\n          y: start.chunkIndex,\n          width: ECSConsts.ChunkSize,\n          height: end.chunkIndex - start.chunkIndex\n        });\n      }\n    }\n  }\n\n  getEntityComponentDataSlice(component: GpuComponent, entityCell: Vector2) {\n    const dataCell = this.dataCell(entityCell);\n    if (!dataCell) {\n      return undefined;\n    }\n    const dataRect = {...dataCell, width: 1, height: 1};\n    const comp = this.components[component.name];\n    return this.texture.sliceRange(comp.layerOffset, componentBufferDepth(component)).selectAbsolute(dataRect);\n  }\n  setComponentData(component: GpuComponent, entity: EntityRef | EntitiesRange, data: Float32Array[]) {\n    if (entity instanceof EntitiesRange) {\n      if (entity.count === 1) {\n        this.setComponentData(component, { x: entity.startIndex, y: entity.archetypeIndex }, data);\n      } else {\n        this.setRangeComponentData(component, entity, data);\n      }\n    } else {\n      const dataSlice = this.getEntityComponentDataSlice(component, entity);\n      if (!dataSlice) {\n        throw new Error(`No data cell for entity ${JSON.stringify(entity)}`);\n      }\n      if (data.length > dataSlice.layers.length) {\n        console.warn(`GpuBuffer.setComponentData: More data provided (${data.length}) than fits the target component \"${component.name}\" (${dataSlice.layers.length}). The data uploaded will be truncated.`)\n      }\n      for (let l=0; l < data.length && l < dataSlice.layers.length; l++) {\n        dataSlice.slice([l]).upload(data[l]);\n      }\n    }\n  }\n  setRangeComponentData(component: GpuComponent, entities: EntitiesRange, data: Float32Array[]) {\n    for (const dataSlice of this.getRangeComponentDataSlices(component, entities)) {\n      if (!dataSlice) {\n        throw new Error(`No data for range ${JSON.stringify(entities)}`);\n      }\n      if (data.length > dataSlice.layers.length) {\n        console.warn(`GpuBuffer.setChunksComponentData: More data provided (${data.length}) than fits the target component \"${component.name}\" (${dataSlice.layers.length}). The data uploaded will be truncated.`)\n      }\n      for (let l=0; l < dataSlice.layers.length; l++) {\n        let d: Float32Array | [number, number, number, number] = data[l];\n        if (d.length === 1) {\n          d = [d[0], d[0], d[0], d[0]];\n        }\n        dataSlice.slice([l]).clear(d);\n      }\n    }\n  }\n  getComponentData(component: GpuComponent, entityCell: Vector2, asyncr: boolean, raw: boolean) {\n    const slice = this.getEntityComponentDataSlice(component, entityCell);\n    if (!slice) {\n      if (asyncr) {\n        return Promise.resolve(undefined);\n      } else {\n        return undefined;\n      }\n    }\n    const finalize = img => imageToComponentData(component, img);\n    if (asyncr) {\n      const p = slice.readAsync();\n      return raw ? p : p.then(finalize);\n    } else {\n      const v = slice.readSync();\n      return raw ? v : finalize(v);\n    }\n  }\n}\nfunction imageToComponentData(component: GpuComponent, img: Image) {\n  if (component.buffer.format === 'float') {\n    return Array.from(img.data);\n  } else {\n    const v: Vector4[] = [];\n    for (let i=0; i < componentBufferDepth(component); i++) {\n      v.push(img.readPixel({ x: 0, y: 0, z: i }));\n    }\n    return v;\n  }\n}\n\nfunction getGpuBufferInternalFormat(format: GpuBuffer['format']) {\n  switch (format) {\n    case 'float': return GL.R32F;\n    case 'vec4': return GL.RGBA32F;\n  }\n}\n","import { Program } from \"./Program\";\nimport { computationShaderHeader } from \".\";\nimport { DoubleBufferedTextureSlicing } from \"./Texture\";\nimport { TextureReadPollOptions } from \"./TextureReader\";\nimport { GlState } from \"./GlState\";\nimport { RenderTarget } from \"./RenderTarget\";\n\nexport class GpuReduce {\n  public constructor(private gls: GlState,\n    private reduceGlsl: (a: string, b: string) =>  string,\n    private reduceJs: (a: number, b: number) => number) {\n  }\n  destroy() {\n    this.renderTarget.destroy();\n    this.computation.destroy();\n  }\n\n  static reduceSum(gls: GlState) {\n    return new GpuReduce(gls, (a, b) => `${a} + ${b}`, (p, x) => p + x);\n  }\n  static reduceMax(gls: GlState) {\n    return new GpuReduce(gls, (a, b) => `max(${a}, ${b})`, (p, x) => Math.max(p, x));\n  }\n  static reduceMin(gls: GlState) {\n    return new GpuReduce(gls, (a, b) => `min(${a}, ${b})`, (p, x) => Math.min(p, x));\n  }\n\n  private renderTarget = new RenderTarget(this.gls);\n  private computation = new Program(this.gls, computationShaderHeader + `\n    in vec2 texcoord;\n    out vec4 out_values[${this.gls.maxColorAttachements}];\n    uniform sampler2DArray source;\n\n    uniform int inputLayers[${this.gls.maxColorAttachements}];\n\n    void main() {\n      ${new Array(this.gls.maxColorAttachements).fill(0).map((x, i) => `{\n        int inputLayer = inputLayers[${i}];\n        vec4 a = texelFetch(source, ivec3(cellPos * 2 + ivec2(0, 0), inputLayer), 0);\n        vec4 b = texelFetch(source, ivec3(cellPos * 2 + ivec2(1, 0), inputLayer), 0);\n        vec4 c = texelFetch(source, ivec3(cellPos * 2 + ivec2(0, 1), inputLayer), 0);\n        vec4 d = texelFetch(source, ivec3(cellPos * 2 + ivec2(1, 1), inputLayer), 0);\n        out_values[${i}] = ${this.reduceGlsl(this.reduceGlsl('a', 'b'), this.reduceGlsl('c', 'd'))};\n      }`).join('\\n')}\n    }\n  `);\n\n  reduceGl(slice: DoubleBufferedTextureSlicing, glReduceUntil = 8) {\n    let s = Math.max(slice.rect.width, slice.rect.height);\n\n    this.gls.disable(this.gls.gl.BLEND);\n    this.gls.disable(this.gls.gl.CULL_FACE);\n    this.gls.disable(this.gls.gl.DEPTH_TEST);\n    // const layers = new Array(layersCount).fill(0).map((x, i) => startLayer + i);\n    while (s > glReduceUntil) {\n      s = s / 2;\n      if (slice.rect.width < s || slice.rect.height < s) {\n        throw new Error(`Texture too small. Expected at least (${s}, ${s}), but is (${slice.rect.width}, ${slice.rect.height})`);\n      }\n      this.renderTarget.set(slice.back);\n      this.gls.viewport = { x: 0, y: 0, width: s, height: s };\n      this.computation.setUniforms({\n        inputLayers: {\n          type: 'int[]',\n          value: slice.layers\n        },\n        source: {\n          type: 'sampler2DArray',\n          value: slice.front.texture\n        }\n      });\n      this.gls.drawQuad(this.computation);\n      slice.texture.swap();\n    }\n  }\n\n  reduceSync(slice: DoubleBufferedTextureSlicing, glReduceUntil = 8) {\n    this.reduceGl(slice, glReduceUntil);\n    return slice.front\n      .selectAbsolute({ x: 0, y: 0, width: glReduceUntil, height: glReduceUntil })\n      .readSync()\n      .reduce(this.reduceJs);\n  }\n\n  async reduceAsync(slice: DoubleBufferedTextureSlicing, glReduceUntil = 8, asyncOpts?: TextureReadPollOptions) {\n    this.reduceGl(slice, glReduceUntil);\n    return (await slice.front\n      .selectAbsolute({ x: 0, y: 0, width: glReduceUntil, height: glReduceUntil })\n      .readAsync(asyncOpts))\n      .reduce(this.reduceJs);\n  }\n}\n","import { shaderModule, funcDef, overloadedFuncDef, uniformDef, constDef } from \"./ShaderModule\"\nimport { glslFloat } from \".\";\n\nexport const MathConstsSM = shaderModule([], {\n  PI: constDef('float', glslFloat(Math.PI))\n});\n\nexport const RandomSM = shaderModule([], {\n  rand: funcDef('float', [['vec2', 'co']], `\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n  `),\n});\n\nexport const RandomUtilSM = shaderModule('RandomUtil', [RandomSM], {\n  // Returns true or false, depending on 'random'. If distribution is 0 it always returns false, if it's 1 it always returns 1, if it's 0.5 it's 50% chance for either\n  choiceBool: funcDef('bool', [['float', 'distribution'], ['float', 'random']], `\n    return random < distribution;\n  `),\n  randomSeed: uniformDef('float', d => d.data.randomSeed),\n  // Same as above but doesn't vary with time\n  entityStaticRandom: funcDef('float', [['ivec2', 'entityCell'], ['float', 'seed1'], ['float', 'seed2']], `\n    return ${RandomSM.rand}(vec2(seed1, seed2) + vec2(entityCell) / vec2(1024) );\n  `),\n  // This gives a pseudo-random number that is always the same for: [entityCell, seed1, seed2, randomSeed]\n  entityRandom: funcDef('float', [['ivec2', 'entityCell'], ['float', 'seed1'], ['float', 'seed2']], `\n    return Self.entityStaticRandom(entityCell, seed1, seed2 + Self.randomSeed);\n  `),\n});\nexport const RandomBoxMullerSM = shaderModule('RandomBoxMuller', [RandomSM, MathConstsSM], {\n  sample: funcDef('float', [['vec2', 'seed1'], ['vec2', 'seed2']], `\n    float u;\n    float v;\n    while ((u = ${RandomSM.rand}(seed1)) == 0.) {\n      seed1 += 0.01;\n    }\n    while ((v = ${RandomSM.rand}(seed2)) == 0.) {\n      seed2 += 0.01;\n    }\n    return sqrt(-2.0 * log(u)) * cos(2.0 * ${MathConstsSM.PI} * v);\n  `)\n});\n\nfunction InterpolateTSMFunc(xt: string, yt: string) {\n  return funcDef(yt, [[xt, 'x'], [xt, 'x0'], [xt, 'x1'], [yt, 'y0'], [yt, 'y1']], `\n    ${xt} p = (x - x0) / (x1 - x0);\n    return mix(y0, y1, p);\n  `)\n}\nfunction InterpolateClampedTSMFunc(xt: string, yt: string) {\n  return funcDef(yt, [[xt, 'x'], [xt, 'x0'], [xt, 'x1'], [yt, 'y0'], [yt, 'y1']], `\n    ${xt} p = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n    return mix(y0, y1, p);\n  `)\n}\nexport const InterpolateSM = shaderModule([], {\n  interpolate: overloadedFuncDef([\n    InterpolateTSMFunc('float', 'float'),\n    InterpolateTSMFunc('float', 'vec3'),\n    InterpolateTSMFunc('vec2', 'vec2'),\n    InterpolateTSMFunc('vec3', 'vec3'),\n    InterpolateTSMFunc('vec4', 'vec4'),\n  ]),\n  interpolateClamped: overloadedFuncDef([\n    InterpolateClampedTSMFunc('float', 'float'),\n    InterpolateClampedTSMFunc('float', 'vec3'),\n    InterpolateClampedTSMFunc('vec2', 'vec2'),\n    InterpolateClampedTSMFunc('vec3', 'vec3'),\n    InterpolateClampedTSMFunc('vec4', 'vec4'),\n  ]),\n})\n\nexport const MatrixSM = shaderModule('Matrix', [], {\n  translate: overloadedFuncDef([\n    funcDef('mat4', [['vec3', 'position']], `\n      return mat4(\n        1, 0, 0, 0,\n        0, 1, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, position.z, 1\n      );\n    `),\n    funcDef('mat4', [['vec2', 'position']], `\n      return mat4(\n        1, 0, 0, 0,\n        0, 1, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, 0, 1\n      );\n    `)\n  ]),\n  scale: overloadedFuncDef([\n    funcDef('mat4', [['vec3', 'scale']], `\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, scale.z, 0,\n        0, 0, 0, 1\n      );\n    `)\n  ]),\n  translateScale: overloadedFuncDef([\n    funcDef('mat4', [['vec3', 'position'], ['vec3', 'scale']], `\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, scale.z, 0,\n        position.x, position.y, position.z, 1\n      );\n    `),\n    funcDef('mat4', [['vec2', 'position'], ['vec3', 'scale']], `\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, 0, 1\n      );\n    `)\n  ]),\n  rotateTranslateScale: funcDef('mat4', [['vec4', 'quaternion'], ['vec3', 'position'], ['vec3', 'scale']], `\n    // Quaternion math\n    float x = quaternion[0];\n    float y = quaternion[1];\n    float z = quaternion[2];\n    float w = quaternion[3];\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = scale[0];\n    float sy = scale[1];\n    float sz = scale[2];\n\n    return mat4(\n      (1.0 - (yy + zz)) * sx,\n      (xy + wz) * sx,\n      (xz - wy) * sx,\n      0.0,\n      (xy - wz) * sy,\n      (1.0 - (xx + zz)) * sy,\n      (yz + wx) * sy,\n      0.0,\n      (xz + wy) * sz,\n      (yz - wx) * sz,\n      (1.0 - (xx + yy)) * sz,\n      0.0,\n      position[0],\n      position[1],\n      position[2],\n      1.0\n    );\n  `),\n  rotateX: funcDef('mat4', [['float', 'rad']], `\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        1, 0, 0, 0,\n        0, c, s, 0,\n        0, -s, c, 0,\n        0, 0, 0, 1\n    );\n  `),\n  rotateY: funcDef('mat4', [['float', 'rad']], `\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        c, 0, -s, 0,\n        0, 1, 0, 0,\n        s, 0, c, 0,\n        0, 0, 0, 1\n    );\n  `),\n  rotateZ: funcDef('mat4', [['float', 'rad']], `\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        c, s, 0, 0,\n        -s, c, 0, 0,\n        0, 0, 1, 0,\n        0, 0, 0, 1\n    );\n  `),\n  forwardRightUp: overloadedFuncDef([\n    funcDef('mat4', [['vec3', 'forward'], ['vec3', 'right'], ['vec3', 'up']], `\n      return mat4(\n        forward.x, forward.y, forward.z, 0,\n        right.x, right.y, right.z, 0,\n        up.x, up.y, up.z, 0,\n        0, 0, 0, 1\n      );\n    `)\n  ]),\n  // From: https://www.geeks3d.com/20140807/billboarding-vertex-shader-glsl/\n  toBillboard: funcDef('mat4', [['mat4', 'modelView']], `\n    modelView[0][0] = 1.0;\n    modelView[0][1] = 0.0;\n    modelView[0][2] = 0.0;\n\n    modelView[1][0] = 0.0;\n    modelView[1][1] = 1.0;\n    modelView[1][2] = 0.0;\n\n    modelView[2][0] = 0.0;\n    modelView[2][1] = 0.0;\n    modelView[2][2] = 1.0;\n    return modelView;\n  `),\n  transformPoint: funcDef('vec3', [['mat4', 'transform'], ['vec3', 'point']], `\n    vec4 p = transform * vec4(point, 1);\n    return p.xyz / p.w;\n  `),\n});\n\nexport const ArrowTransformSM = shaderModule([MatrixSM], {\n  rectSpaceToClipSpace: funcDef('mat4', [['ivec2', 'rectSize']], `\n    return ${MatrixSM.translateScale}(\n      vec3(-1, -1, 0),\n      vec3(2) / vec3(rectSize, 1)\n    );\n  `),\n  cellArrowTransform: funcDef('mat4', [['ivec2', 'rectSize'], ['ivec2', 'cell']], `\n    return Self.rectSpaceToClipSpace(rectSize) *\n      ${MatrixSM.translateScale}(\n        vec3(cell, 0) + vec3(0.5, 0.5, 0),\n        vec3(0.5, 0.5, 1)\n      );\n  `)\n});\n\nexport const WithoutNaNInfSM = shaderModule([], {\n  // Seems like isnan isn't always working in WebGL: https://stackoverflow.com/questions/9446888/best-way-to-detect-nans-in-opengl-shaders\n  isnanPolyfill: funcDef('bool', [['float', 'val']], `\n    return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n  `),\n  withoutNaNInf: overloadedFuncDef([\n    funcDef('float', [['float', 'v']], `\n      return (isnanPolyfill(v) || isinf(v) || isnan(v)) ? 0.0 : v;\n    `),\n    funcDef('vec2', [['vec2', 'v']], `\n      return vec2(withoutNaNInf(v.x), withoutNaNInf(v.y));\n    `),\n    funcDef('vec3', [['vec3', 'v']], `\n      return vec3(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z));\n    `),\n    funcDef('vec4', [['vec4', 'v']], `\n      return vec4(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z), withoutNaNInf(v.w));\n    `),\n  ])\n});\n\n\nexport const SampleSoftmaxSM = (count: number) => shaderModule(`SampleSoftmax${count}`, [], {\n  sampleSoftmax: funcDef('int', [['float', 'p'], [`float[${count}]`, 'values']], `\n\n    float sum = 0.0;\n    ${new Array(count).fill(0).map((_, i) => `\n    float valueExp${i} = exp(values[${i}]);\n    sum += valueExp${i};\n    `).join('\\n')}\n\n    float cumulative = 0.0;\n    ${new Array(count).fill(0).map((_, i) => `\n    cumulative += valueExp${i} / sum;\n    if (p < cumulative) {\n      return ${i};\n    }\n    `).join('\\n')}\n    return 0;\n  `)\n});\n\nexport const SampleCDFSM = (count: number) => shaderModule(`SampleCDF${count}`, [], {\n  sample: funcDef('int', [['float', 'p'], [`float[${count}]`, 'values']], `\n\n    float sum = 0.0;\n    ${new Array(count).fill(0).map((_, i) => `\n    sum += values[${i}];\n    `).join('\\n')}\n\n    float cumulative = 0.0;\n    ${new Array(count).fill(0).map((_, i) => `\n    cumulative += values[${i}] / sum;\n    if (p < cumulative) {\n      return ${i};\n    }\n    `).join('\\n')}\n    return 0;\n  `)\n});\n\nexport const ArrayMaxSM = (count: number) => shaderModule(`ArrayMax${count}`, [], {\n  max: funcDef('int', [[`float[${count}]`, 'values']], `\n    float maxV = values[0];\n    int maxI = 0;\n    for (int i=1; i < ${count}; i++) {\n      if (values[i] > maxV) {\n        maxV = values[i];\n        maxI = i;\n      }\n    }\n    return maxI;\n  `)\n});\n\nexport const SpatialSM = shaderModule('Spatial', [], {\n  forward: funcDef('vec2', [['float', 'angle']], `\n    return vec2(cos(angle), sin(angle));\n  `),\n\n  isInFront: funcDef('bool', [['vec2', 'selfPosition'], ['vec2', 'selfForward'], ['vec2', 'otherPosition']], `\n    vec2 delta = otherPosition - selfPosition;\n    return dot(selfForward, delta) > 0.0;\n  `),\n\n  angleBetweenVec3s: funcDef('float', [['vec3', 'a'], ['vec3', 'b'], ['vec3', 'planeNormal']], `\n    // From: https://stackoverflow.com/questions/5188561/signed-angle-between-two-3d-vectors-with-same-origin-within-the-same-plane\n    // Assumes a, b and planeNormal are normalized\n    if (dot(planeNormal, cross(a, b)) < 0.0) {\n      return -acos(dot(a, b));\n    } else {\n      return acos(dot(a, b));\n    }\n  `),\n  angleBetweenVec2s: funcDef('float', [['vec2', 'a'], ['vec2', 'b']], `\n    return Self.angleBetweenVec3s(vec3(a, 0), vec3(b, 0), vec3(0, 0, 1));\n  `),\n\n  angleToPosition: funcDef('float', [['vec2', 'selfPosition'], ['vec2', 'selfForward'], ['vec2', 'otherPosition']], `\n    vec2 delta = otherPosition - selfPosition;\n    if (length(delta) == 0.0) {\n      return 0.0;\n    } else {\n      return Self.angleBetweenVec2s(\n        selfForward,\n        normalize(delta)\n      );\n    }\n  `),\n\n  relativeRotationTo: funcDef('float', [['vec2', 'selfForward'], ['vec2', 'otherForward']], `\n    return Self.angleBetweenVec2s(selfForward, otherForward);\n  `),\n  facingUs: funcDef('float', [['vec2', 'selfPosition'], ['vec2', 'otherPosition'], ['vec2', 'otherForward']], `\n    vec2 delta = otherPosition - selfPosition;\n    return -dot(\n      otherForward,\n      normalize(delta)\n    );\n  `),\n\n});\n\nexport const Vector2SM = shaderModule([], {\n  perpendicular: funcDef('vec2', [['vec2', 'v']], `\n    return vec2(v.y, -v.x);\n  `)\n});\n\n// From: https://gist.github.com/shaunlebron/8832585\nexport const AngleLerpSM = shaderModule([MathConstsSM], {\n  shortestAngleDist: funcDef('float', [['float', 'a0'], ['float', 'a1']], `\n    float max = ${MathConstsSM.PI} * 2.0;\n    float da = mod((a1 - a0), max);\n    return mod(2.0 * da, max) - da;\n  `),\n  angleLerp: funcDef('float', [['float', 'a0'], ['float', 'a1'], ['float', 't']], `\n    return a0 + shortestAngleDist(a0, a1) * t;\n  `)\n});\n","import { GpuBuffer, ECSConsts, GpuComponent, Component, componentFormatChannels } from \".\";\nimport { shaderModule, uniformArrayDef, uniformDef, funcDef } from \"../ShaderModule\";\nimport { ArrowTransformSM } from \"../SM2Utils\";\n\nfunction gpuBufferReadSM(buffer: GpuBuffer) {\n  return shaderModule(buffer.name, [ArrowTransformSM], {\n    archetypeDataRowOffset: uniformArrayDef('int[]', ECSConsts.MaxArchetypes, d => d.ecs.gpuBuffers[buffer.name].archetypeToDataRowOffset, false),\n    sampler: uniformDef('sampler2DArray', d => d.ecs.gpuBuffers[buffer.name].texture),\n    dataCell: funcDef('ivec2', [['ivec2', 'entityCell']], `\n      const int chunkSize = ${ECSConsts.ChunkSize};\n      return ivec2(\n        entityCell.x % chunkSize,\n        entityCell.x / chunkSize + Self.archetypeDataRowOffset[entityCell.y]\n      );\n    `),\n    get: funcDef(buffer.format, [['ivec2', 'entityCell'], ['int', 'componentLayer']], `\n      return texelFetch(Self.sampler, ivec3(\n        Self.dataCell(entityCell),\n        componentLayer\n      ), 0)${buffer.format === 'float' ? '.x' : ''};\n    `),\n    size: uniformDef('ivec2', d => d.ecs.gpuBuffers[buffer.name].sizeVec2),\n    dataArrow: funcDef('mat4', [['ivec2', 'entityCell']], `\n      return ${ArrowTransformSM.cellArrowTransform}(Self.size, Self.dataCell(entityCell));\n    `)\n  });\n}\n\nfunction vec4To(format: GpuComponent['format']) {\n  switch (format) {\n    case 'float': return '.x';\n    case 'int': return '.x';\n    case 'bool': return '.x';\n    case 'ivec2': return '.xy';\n    case 'vec2': return '.xy';\n    case 'vec3': return '.xyz';\n    case 'ivec3': return '.xyz';\n    case 'vec4': return '';\n    case 'ivec4': return '';\n    case 'mat4': return '';\n  }\n}\n\nexport function gpuComponentReadSM(component: GpuComponent) {\n  const buffer = gpuBufferReadSM(component.buffer);\n  const layerOffset = uniformDef('int', d => d.ecs.gpuComponentInfo(component)?.layerOffset ?? 10000);\n\n  let args: Array<[string, string]> = [['ivec2', 'entityCell']];\n  if (component.depth !== undefined) {\n    args = [...args, ['int', 'layer']];\n  }\n  const dataArrow = funcDef('mat4', [['ivec2', 'entityCell']], `\n    return ${buffer.dataArrow}(entityCell);\n  `)\n  switch (component.buffer.format) {\n    case 'float': return shaderModule(component.name, [buffer], {\n      layerOffset,\n      value: funcDef(component.format, args, `\n        return ${component.format}(\n          ${new Array(componentFormatChannels(component.format)).fill(0).map((_, i) =>\n            `${buffer.get}(entityCell, Self.layerOffset ${component.depth === undefined ? '' : `+ layer * ${componentFormatChannels(component.format)}`} + ${i})`\n          ).join(',\\n')}\n        );\n      `),\n      dataArrow\n    });\n    case 'vec4': {\n      if (component.format === 'mat4') {\n        return shaderModule(component.name, [buffer], {\n          layerOffset,\n          value: funcDef(component.format, args, `\n            return mat4(\n              ${new Array(4).fill(0).map((_, i) =>\n                `${buffer.get}(entityCell, Self.layerOffset ${component.depth === undefined ? '' : `+ layer * 4`} + ${i})`\n              ).join(',\\n')}\n            );\n          `),\n          dataArrow\n        });\n      } else {\n        return shaderModule(component.name, [buffer], {\n          layerOffset,\n          value: funcDef(component.format, args, `\n            return ${component.format}(${buffer.get}(entityCell, Self.layerOffset ${component.depth === undefined ? '' : `+ layer`})${vec4To(component.format)});\n          `),\n          dataArrow\n        });\n      }\n    }\n  }\n}\nexport type GpuComponentReader = ReturnType<typeof gpuComponentReadSM>;\n\nexport function hasComponentSM(component: Component) {\n  return shaderModule(component.name + 'HasComponent', [], {\n    componentId: uniformDef('int', d => d.ecs.components[component.name].index),\n    archetypeHasComponentTexture: uniformDef('usampler2D', d => d.ecs.archetypeHasComponentTexture),\n    value: funcDef('bool', [['ivec2', 'entityCell']], `\n      return bool(texelFetch(Self.archetypeHasComponentTexture, ivec2(Self.componentId, entityCell.y), 0).x);\n    `)\n  })\n}\n\n\nfunction vec4Pad(format: GpuComponent['format'], data: string, slice: number) {\n  switch (format) {\n    case 'float': return `vec4(${data})`;\n    case 'int': return `vec4(${data})`;\n    case 'bool': return `vec4(${data})`;\n    case 'ivec2': return `vec4(${data}, 0, 0)`;\n    case 'vec2': return `vec4(${data}, 0, 0)`;\n    case 'vec3': return `vec4(${data}, 0)`;\n    case 'ivec3': return `vec4(${data}, 0)`;\n    case 'vec4': return data;\n    case 'ivec4': return data;\n    case 'mat4': return `data[${slice}]`;\n  }\n}\n\n\n// This expects `const int ComponentName_outOffset;` to be defined, as well as `out XX outValues;`\nexport function gpuComponentBufferWriterSM(component: GpuComponent) {\n  const channels = componentFormatChannels(component.format);\n  const depth = component.depth ?? 1;\n  const args: Array<[string, string]> = [[`${component.format}${component.depth === undefined ? '' : `[${component.depth}]`}`, 'data']];\n  switch (component.buffer.format) {\n    case 'float': return shaderModule(component.name + 'Writer', [], {\n      write: funcDef('void', args, `\n        ${new Array(depth).fill(0).map((_, i) =>\n          new Array(channels).fill(0).map((_, l) =>\n            `outValues[${component.name}_outOffset + ${i * channels} + ${l}] = vec4(data${component.depth === undefined ? '' : `[${i}]`}${channels === 1 ? '' : `[${l}]`});`\n          ).join('\\n')\n        ).join('\\n')}\n      `)\n    })\n    case 'vec4': {\n      const slices = Math.ceil(channels / 4);\n      return shaderModule(component.name + 'Writer', [], {\n        write: funcDef('void', args, `\n          ${new Array(depth).fill(0).map((_, i) =>\n            new Array(slices).fill(0).map((_, l) =>\n              `outValues[${component.name}_outOffset + ${i * slices} + ${l}] = ${vec4Pad(component.format, 'data' + (component.depth === undefined ? '' : `[${i}]`), l)};`\n            ).join('\\n')\n          ).join('\\n')}\n        `)\n      })\n    }\n  }\n}\n","import { ShaderModule, FunctionDef, CompiledShaderModule, shaderModule, outDef, funcDef, inDef, constDef, uniformDef, uniformArrayDef } from \"../ShaderModule\";\nimport { GpuComponent, Archetype, ECSConsts } from \".\";\nimport { GlState, BlendMode, GL } from \"../GlState\";\nimport { RenderTarget } from \"../RenderTarget\";\nimport { gpuComponentBufferWriterSM, gpuComponentReadSM } from \"./GpuComponentSM\";\nimport { Program } from \"../Program\";\nimport { GpuWorldState } from \"../../GpuWorld/State\";\nimport { Query } from \"./Query\";\nimport { componentBufferDepth, GpuBufferData } from \"./GpuBuffer\";\nimport { Vertex } from \"../Mesh\";\nimport { TextureSlicing } from \"../Texture\";\nimport { ArrowTransformSM } from \"../SM2Utils\";\nimport { GLSLType } from \"../GLSLTypes\";\n\n\nexport class MapGpuComponent<T extends string> {\n  constructor(\n    protected gls: GlState,\n    private archetypes: Query<Archetype[]>,\n    private component: GpuComponent,\n    private map: ShaderModule<{ map: FunctionDef<T, [['ivec2', 'entityCell'], [T, 'value']] | [['ivec2', 'entityCell']]> }>) {\n  }\n  private reader = gpuComponentReadSM(this.component);\n  private writer = gpuComponentBufferWriterSM(this.component);\n  private isReading = this.map.map.args.length === 2;\n  private updateMulti = new UpdateGpuComponents(this.gls, this.archetypes, [this.component], shaderModule([\n    this.map, this.writer, ...(this.isReading ? [this.reader] : [])\n  ], {\n    update: funcDef('void', [['ivec2', 'entityCell']], `\n      ${this.writer.write}(${this.map.map}(entityCell${this.isReading ? `, ${this.reader.value}(entityCell)` : ''}));\n    `)\n  }), 'set');\n  run(state: GpuWorldState) {\n    this.updateMulti.run(state);\n  }\n}\n\nexport type UpdateGpuType = 'set' | 'sum';\n\nexport class UpdateGpuComponents {\n  constructor(\n    protected gls: GlState,\n    private archetypes: Query<Archetype[]>,\n    private components: Array<GpuComponent>,\n    private update: ShaderModule<{ update: FunctionDef<'void' | 'ivec2', [['ivec2', 'entityCell']]> }>,\n    private updateType: UpdateGpuType) {}\n\n  private arrows = this.update.update.returnType === 'ivec2';\n  private renderTarget = new RenderTarget(this.gls);\n  // private output = new ComponentsBufferOutput(this.components);\n\n  public componentDepths = this.components.map((c) => componentBufferDepth(c));\n  public componentOffsets = this.components.reduce((p, c) => [...p, p[p.length - 1] + componentBufferDepth(c)], [0]);\n  private componentsTotalDepth = this.componentOffsets[this.componentOffsets.length - 1];\n  public outDepth = this.componentsTotalDepth + (this.arrows ? 1 : 0);\n  public writeShaderPrep = shaderModule([], {\n    outValues: outDef(`vec4[${this.outDepth}]`),\n    ...this.components.reduce((p, c, i) => ({...p, [`${c.name}_outOffset`]: constDef('int', '' + this.componentOffsets[i]) }), {}),\n  });\n\n  private shader = new CompiledShaderModule(shaderModule([this.writeShaderPrep, this.update], {\n    outArchetype: uniformDef('int'),\n    outYOffset: uniformDef('int'),\n    main: funcDef('void', [], `\n      ivec2 outDataCell = ivec2(gl_FragCoord) - ivec2(0, outYOffset);\n      ivec2 outEntityCell = ivec2(\n        outDataCell.y * ${ECSConsts.ChunkSize} + outDataCell.x,\n        outArchetype\n      );\n      ${!this.arrows ? `\n        ${this.update.update}(outEntityCell);\n      ` : `\n        ivec2 targetEntityCell = ${this.update.update}(outEntityCell);\n        outValues[${this.outDepth - 1}] = vec4(targetEntityCell, 0, 0);\n      `}\n    `)\n  }))\n  private program = new Program(this.gls, this.shader.source);\n  private copyArrows = this.arrows ? new CopyArrows(this.gls, this.componentsTotalDepth, this.updateType === 'sum' ? BlendMode.Sum : undefined) : undefined;\n\n  run(state: GpuWorldState, uniforms: Array<{ name: string, type: GLSLType, value: any }> = []) {\n    // This must be called before we start setting up for this draw call, because\n    // getting the values may involve renderings and state changes\n    this.shader.updateUniformValues(state);\n\n    const archetypes = this.archetypes.get(state);\n    const archetypesChunkHeights = archetypes.reduce((p, x) => p + x.chunks.length, 0);\n    const tmp = this.gls.getTmpTexture(GL.RGBA32F, { width: ECSConsts.ChunkSize, height: archetypesChunkHeights }, this.outDepth);\n    let heightOffset = 0;\n    // It's important that we first compute all values and _then_ copy them back, so that the operation is atomic\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    for (const arch of archetypes) {\n      const width = arch.chunks.reduce((p, x) => Math.max(p, x.entities), 0);\n\n      const slice = tmp.sliceRange(0, this.outDepth).selectAbsolute({\n        x: 0, y: heightOffset, width, height: arch.chunks.length });\n      this.program.setUniform('outArchetype', 'int', arch.index);\n      this.program.setUniform('outYOffset', 'int', heightOffset);\n      for (const uniform of uniforms) {\n        this.program.setUniform(uniform.name, uniform.type, uniform.value);\n      }\n      this.renderTarget.set(slice);\n      this.gls.prepareForComputation(slice.rect);\n      this.gls.drawQuad(this.program);\n\n      heightOffset += arch.chunks.length;\n    }\n\n    for (let i=0; i < this.components.length; i++) {\n      const info = state.ecs.gpuComponentInfo(this.components[i]);\n      if (info) {\n\n        heightOffset = 0;\n        for (let a=0; a < archetypes.length; a++) {\n          const arch = archetypes[a];\n          const width = arch.chunks.reduce((p, x) => Math.max(p, x.entities), 0);\n          const tmpSlice = tmp.sliceRange(0, this.outDepth).selectAbsolute({\n            x: 0, y: heightOffset, width, height: arch.chunks.length });\n          heightOffset += arch.chunks.length;\n\n          const tmpComponentSlice = tmpSlice.sliceRange(this.componentOffsets[i], this.componentDepths[i]);\n          if (this.copyArrows) {\n            this.copyArrows.run(tmpComponentSlice, info.slice, info.buffer);\n          } else {\n            const target = info.slice.selectAbsolute({\n              x: 0,\n              y: info.buffer.archetypes[arch.index]!.dataRowOffset,\n              width,\n              height: arch.chunks.length\n            });\n\n            // This while loop is an optimization; it looks ahead and tries to group copies together\n            while ((a + 1) < archetypes.length) {\n              const nextArch = archetypes[a + 1];\n              if (target.rect.y + target.rect.height === info.buffer.archetypes[nextArch.index]!.dataRowOffset) {\n                target.rect.height += nextArch.chunks.length;\n                tmpSlice.rect.height += nextArch.chunks.length;\n                const nextWidth = nextArch.chunks.reduce((p, x) => Math.max(p, x.entities), 0);\n                target.rect.width = Math.max(target.rect.width, nextWidth);\n                a++;\n                heightOffset += nextArch.chunks.length;\n              } else {\n                break;\n              }\n            }\n\n            this.gls.getCopyTexture().copy(target, tmpComponentSlice, this.updateType);\n          }\n\n        }\n\n      }\n    }\n  }\n}\n\nclass CopyArrows {\n  constructor(private gls: GlState, private valuesDepth: number, private blendMode: BlendMode | undefined) {}\n\n  private vertexShader = new CompiledShaderModule(shaderModule([Vertex, ArrowTransformSM], {\n    targetArchetypeDataRowOffset: uniformArrayDef('int[]', ECSConsts.MaxArchetypes),\n    targetDataCell: funcDef('ivec2', [['ivec2', 'entityCell']], `\n      const int chunkSize = ${ECSConsts.ChunkSize};\n      return ivec2(\n        entityCell.x % chunkSize,\n        entityCell.x / chunkSize + Self.targetArchetypeDataRowOffset[entityCell.y]\n      );\n    `),\n    targetSize: uniformDef('ivec2'),\n\n    sourceDataCell: outDef('ivec2', true),\n    source: uniformDef('sampler2DArray'),\n    sourceOffset: uniformDef('ivec2'),\n    main: funcDef('void', [], `\n      sourceDataCell = ivec2(\n        gl_InstanceID % ${ECSConsts.ChunkSize},\n        gl_InstanceID / ${ECSConsts.ChunkSize}\n      ) + sourceOffset;\n      ivec2 targetEntityCell = ivec2(texelFetch(source, ivec3(sourceDataCell, ${this.valuesDepth}), 0).xy);\n      if (targetEntityCell.x < 0) {\n        gl_Position = vec4(-1);\n        return;\n      }\n      mat4 arrow = ${ArrowTransformSM.cellArrowTransform}(Self.targetSize, Self.targetDataCell(targetEntityCell));\n      gl_Position = arrow * vec4(${Vertex.position}, 1);\n    `)\n  }));\n  private fragmentShader = new CompiledShaderModule(shaderModule([], {\n    source: uniformDef('sampler2DArray'),\n    sourceDataCell: inDef('ivec2', true),\n    outValues: outDef('vec4[8]'),\n    sourceLayerOffset: uniformDef('int'),\n    sourceCount: uniformDef('int'),\n    main: funcDef('void', [], `\n      vec4 values[8];\n      for (int i=0; i < sourceCount; i++) {\n        values[i] = texelFetch(source, ivec3(sourceDataCell, sourceLayerOffset + i), 0);\n      }\n      outValues = values;\n    `)\n  }));\n  private program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n  private renderTarget = new RenderTarget(this.gls);\n\n  run(source: TextureSlicing, target: TextureSlicing, targetGpuBuffer: GpuBufferData) {\n    this.program.prepare();\n    this.program.setUniform('targetArchetypeDataRowOffset', 'int[]', targetGpuBuffer.archetypeToDataRowOffset);\n    this.program.setUniform('targetSize', 'ivec2', targetGpuBuffer.sizeVec2);\n    this.program.setUniform('source', 'sampler2DArray', source.texture);\n    this.program.setUniform('sourceOffset', 'ivec2', source.rect);\n    this.program.setUniform('sourceLayerOffset', 'int', source.layers[0]);\n    this.program.setUniform('sourceCount', 'int', source.layers.length);\n    this.renderTarget.set(target);\n    this.gls.prepareForComputation(target.rect, this.blendMode);\n    this.gls.drawQuad(this.program, source.rect.width * source.rect.height);\n  }\n}","import { EntityRef } from \"../../GpuWorld/StateData\";\nimport { Component, Archetype, EntitiesBlock, GpuComponentBlock, GpuComponent, CpuComponent, ObjComponent, ComponentFormats } from \".\";\nimport { GpuWorldState } from \"../../GpuWorld/State\";\nimport { Texture, TextureSlicing, DoubleBufferedTextureSlicing, DoubleBufferedTexture } from \"../Texture\";\nimport { GlState, GL } from \"../GlState\";\nimport { Image } from '../Image';\nimport { RenderTarget } from \"../RenderTarget\";\nimport { Program } from \"../Program\";\nimport { TextureReader } from \"../TextureReader\";\nimport { Vector4 } from \"../../Math/Vector4\";\nimport { Size, sizeClosestPow2 } from \"../../Math/Math\";\nimport { FunctionDef, shaderModule, funcDef, uniformDef, outDef, ShaderModule, CompiledShaderModule, uniformArrayDef } from \"../ShaderModule\";\nimport { GpuReduce } from \"../Reduce\";\nimport { glslTypeArraySize } from \"../GLSLTypes\";\nimport { MapGpuComponent, UpdateGpuComponents, UpdateGpuType } from \"./Update\";\n\nexport interface Query<T> {\n  get(state: GpuWorldState): T;\n  destroy(): void;\n}\n\nexport class CacheByDeps<T> {\n  private value?: T;\n  private disposeValue?: (value: T) => void;\n  private deps: any[] = [];\n  get(getValue: () => T, deps: any[], dispose?: (value: T) => void): T {\n    if (this.value === undefined) {\n      return this.value = getValue();\n    }\n    for (let i=0; i < deps.length; i++) {\n      if (this.deps[i] !== deps[i]) {\n        this.deps = deps;\n        if (this.disposeValue) {\n          this.disposeValue(this.value);\n        }\n        this.disposeValue = dispose;\n        return this.value = getValue();\n      }\n    }\n    return this.value;\n  }\n  destroy() {\n    if (this.disposeValue && this.value !== undefined) {\n      this.disposeValue(this.value);\n    }\n    this.value = undefined;\n  }\n}\n\nexport class ArchetypesQuery {\n  constructor(private requiredComponents: Component[]) {\n  }\n  destroy() {}\n  private cache = new CacheByDeps<Archetype[]>();\n  get(state: GpuWorldState) {\n    return this.cache.get(() => {\n      return state.ecs.getMatchingArchetypes(this.requiredComponents);\n    }, [state.ecs.archetypes]);\n  }\n  entityBlocks() {\n    return new ArchetypesToEntityBlocks(this);\n  }\n  gpuComponentBlocks(component: GpuComponent) {\n    return new ArchetypesToGpuComponentBlocks(this, component);\n  }\n  updateGpu(gls: GlState, components: Array<GpuComponent>, update: ShaderModule<{ update: FunctionDef<'void' | 'ivec2', [['ivec2', 'entityCell']]> }>, updateType: UpdateGpuType = 'set') {\n    return new UpdateGpuComponents(gls, this, components, update, updateType);\n  }\n  mapGpu<T extends string>(gls: GlState, component: GpuComponent, map: ShaderModule<{ map: FunctionDef<T, [['ivec2', 'entityCell'], [T, 'value']] | [['ivec2', 'entityCell']]> }>) {\n    return new MapGpuComponent<T>(gls, this, component, map);\n  }\n}\n\nexport class ArchetypeIndexQuery {\n  constructor(private archetypeIndex: number) {\n  }\n  destroy() {}\n  get(state: GpuWorldState) {\n    const arch = state.ecs.archetypes[this.archetypeIndex];\n    return arch ? [arch] : [];\n  }\n  entities() {\n    return new ArchetypesToEntities(this);\n  }\n  entityBlocks() {\n    return new ArchetypesToEntityBlocks(this);\n  }\n  gpuComponentBlocks(component: GpuComponent) {\n    return new ArchetypesToGpuComponentBlocks(this, component);\n  }\n}\n\nclass ArchetypesToEntityBlocks {\n  constructor(private archetypes: Query<Archetype[]>) {}\n  destroy() {\n    this.archetypes.destroy();\n  }\n  private cache = new CacheByDeps<EntitiesBlock[]>();\n  get(state: GpuWorldState) {\n    const archetypes = this.archetypes.get(state);\n    return this.cache.get(() => {\n      const res: EntitiesBlock[] = [];\n      for (const arch of archetypes) {\n        res.push(new EntitiesBlock(arch.index, arch.chunks.reduce((p, x) => p + x.entities, 0)));\n      }\n      return res;\n    }, [archetypes, state.ecs.formVersion]);\n  }\n}\n\nclass ArchetypesToGpuComponentBlocks {\n  constructor(private archetypes: Query<Archetype[]>, public component: GpuComponent) {}\n  destroy() {\n    this.archetypes.destroy();\n  }\n  private cache = new CacheByDeps<GpuComponentBlock[]>();\n  get(state: GpuWorldState) {\n    const archetypes = this.archetypes.get(state);\n    return this.cache.get(() => {\n      const buffer = state.ecs.gpuBuffers[this.component.buffer.name];\n      const res: GpuComponentBlock[] = [];\n      for (const arch of archetypes) {\n        const buffArch = buffer.archetypes[arch.index]!;\n        res.push(new GpuComponentBlock(\n          buffer.getArchetypeComponentDataSlice(this.component, arch),\n          arch,\n          buffArch.dataRowOffset\n        ));\n      }\n      return res;\n    }, [archetypes, state.ecs.formVersion]);\n  }\n  uploadFrom(fromComponent: CpuComponent) {\n    return new GpuComponentUploadFrom(this, fromComponent);\n  }\n}\n\n\nclass GpuComponentUploadFrom {\n  constructor(private blocks: Query<GpuComponentBlock[]>, private fromComponent: CpuComponent, private alwaysUpload = false) {}\n  destroy() {\n    this.blocks.destroy();\n  }\n  private contentVersions: { [key: string]: number } = {};\n  private prevBlocks: GpuComponentBlock[] = [];\n  run(state: GpuWorldState) {\n    const blocks = this.blocks.get(state);\n    if (this.prevBlocks !== blocks) {\n      this.prevBlocks = blocks;\n      this.contentVersions = {};\n    }\n    for (const block of blocks) {\n      for (let c=0; c < block.archetype.chunks.length; c++) {\n        const chunk = block.archetype.chunks[c];\n        const cpuComp = chunk.cpuComponent[this.fromComponent.name];\n        const chunkKey = block.archetype.index + '_' + c;\n        if (cpuComp.contentVersion === this.contentVersions[chunkKey] && !this.alwaysUpload) {\n          continue;\n        }\n        this.contentVersions[chunkKey] = cpuComp.contentVersion;\n        block.slices.selectRelative({\n          x: 0,\n          y: c,\n          width: block.slices.rect.width,\n          height: 1\n        }).upload(cpuComp.data);\n      }\n    }\n  }\n}\n\nexport class EntitiesQuery {\n  constructor(public requiredComponents: Component[] = []) {}\n  destroy() {\n  }\n  private filters: Array<{\n    component: ObjComponent<any> | CpuComponent,\n    filter: (value: any, state: GpuWorldState) => boolean,\n    cacheKeys: (state: GpuWorldState) => any[],\n    entities: CacheByDeps<EntityRef[]>\n  }> = [];\n  filterValue<T>(component: ObjComponent<T>, filter: (value: T | undefined, state: GpuWorldState) => boolean, cacheKeys: (state: GpuWorldState) => any[]): EntitiesQuery;\n  filterValue<T extends ComponentFormats>(component: CpuComponent<T>, filter: (value: Float32Array, state: GpuWorldState) => boolean, cacheKeys: (state: GpuWorldState) => any[]): EntitiesQuery;\n  filterValue(component: ObjComponent<any> | CpuComponent, filter: (value: any, state: GpuWorldState) => boolean, cacheKeys: (state: GpuWorldState) => any[]) {\n    this.filters.push({\n      component,\n      filter,\n      cacheKeys,\n      entities: new CacheByDeps<EntityRef[]>()\n    });\n    return this;\n  }\n  private cachedArchetypes = new CacheByDeps<Archetype[]>();\n  private cachedEntities = new CacheByDeps<EntityRef[]>();\n  get(state: GpuWorldState) {\n    const archetypes = this.cachedArchetypes.get(\n      () => state.ecs.getMatchingArchetypes([...this.requiredComponents, ...this.filters.map(f => f.component)]),\n      [state.ecs.archetypes, ...this.requiredComponents]\n    );\n    let entities = this.cachedEntities.get(\n      () => state.ecs.getEntityRefsForArchetypes(archetypes),\n      [archetypes, state.ecs.formVersion]\n    );\n    for (const filter of this.filters) {\n      const cacheKeys: any[] = [\n        entities,\n        ...filter.cacheKeys(state)\n      ];\n      for (const arch of archetypes) {\n        for (let c=0; c < arch.chunks.length; c++) {\n          const chunk = arch.chunks[c];\n          const comp = filter.component.type === 'cpu' ?\n            chunk.cpuComponent[filter.component.name]\n            : chunk.objComponent[filter.component.name];\n          cacheKeys.push(comp.contentVersion);\n        }\n      }\n      const nextEntities = filter.entities.get(\n        // eslint-disable-next-line\n        () => entities.filter(entity => {\n          const obj = state.ecs.getComponentData(filter.component, entity);\n          return filter.filter(obj, state);\n        }),\n        cacheKeys\n      );\n      entities = nextEntities;\n    }\n    return entities;\n  }\n  updateCpu(update: (state: GpuWorldState, entities: EntityRef[]) => void, dependencyKeys: (state: GpuWorldState) => any) {\n    return new UpdateCpu(this, update, dependencyKeys);\n  }\n  transform<T>(transform: TransformFunc<T>) {\n    return new Transform(this, transform);\n  }\n  toGpu(gls: GlState) {\n    return new EntitiesToGpu(this, gls);\n  }\n  lookupTable(width: number, index: LookupFunc) {\n    return new LookupTableQuery(this, width, index);\n  }\n  render(gls: GlState, props: RenderEntitiesProps) {\n    return new RenderEntities(this, gls, props);\n  }\n}\n\nclass UpdateCpu {\n  constructor(\n    private entities: Query<EntityRef[]>,\n    private update: (state: GpuWorldState, entities: EntityRef[]) => void,\n    private dependencyKeys: (state: GpuWorldState) => any[]\n  ) {\n  }\n  destroy() {\n    this.entities.destroy();\n  }\n  private deps: any[] = [];\n  run(state: GpuWorldState) {\n    const entities = this.entities.get(state);\n    const deps = [entities, ...this.dependencyKeys(state)];\n    for (let i=0; i < deps.length; i++) {\n      if (this.deps[i] !== deps[i]) {\n        this.deps = deps;\n        this.update(state, entities);\n        return;\n      }\n    }\n  }\n}\n\ninterface RenderEntitiesProps {\n  mesh: string;\n  vertexShader: ShaderModule<{ shader: FunctionDef<'void', [['ivec2', 'entityCell']]> }>;\n  fragmentShader: ShaderModule<{ main: FunctionDef<'void', []> }>;\n}\n\nclass RenderEntities {\n  constructor(\n    protected entities: Query<EntityRef[]>,\n    protected gls: GlState,\n    protected props: RenderEntitiesProps) {}\n  destroy() {\n    this.entities.destroy();\n    this.program.destroy();\n  }\n\n  private maxEntities = 128;\n  private vertexShader = new CompiledShaderModule(shaderModule([this.props.vertexShader], {\n    entities: uniformArrayDef('ivec2[]', this.maxEntities),\n    main: funcDef('void', [], `\n      ${this.props.vertexShader.shader}(Self.entities[gl_InstanceID]);\n    `)\n  }));\n  private fragmentShader = new CompiledShaderModule(this.props.fragmentShader);\n  private program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n\n  run(state: GpuWorldState) {\n    const entities = this.entities.get(state);\n    if (entities.length === 0) {\n      return;\n    }\n    if (entities.length >= this.maxEntities) {\n      throw new Error(`Max entities reached`);\n    }\n    // This must be called before we start setting up for this draw call, because\n    // getting the values may involve renderings and state changes\n    this.vertexShader.updateUniformValues(state);\n    this.fragmentShader.updateUniformValues(state);\n    this.program.prepare();\n    this.vertexShader.writeUniforms(this.program);\n    this.fragmentShader.writeUniforms(this.program);\n    this.program.setUniform('entities', 'ivec2[]', entities);\n    const mesh = this.gls.getMesh(this.props.mesh);\n    if (!mesh) {\n      throw new Error(`No such mesh: ${this.props.mesh}`);\n    }\n    this.gls.draw(this.program, mesh, entities.length);\n  }\n}\n\nclass ArchetypesToEntities extends EntitiesQuery {\n  constructor(private archetypes: Query<Archetype[]>) {\n    super();\n  }\n  destroy() {\n    this.archetypes.destroy();\n  }\n  private cache = new CacheByDeps<EntityRef[]>();\n  get(state: GpuWorldState) {\n    const archetypes = this.archetypes.get(state);\n    return this.cache.get(\n        () => state.ecs.getEntityRefsForArchetypes(archetypes),\n        [archetypes, state.ecs.formVersion]\n    );\n  }\n}\n\ntype TransformFunc<T> = (state: GpuWorldState, entityCells: EntityRef[]) => T;\nclass Transform<T> {\n  constructor(private entities: Query<EntityRef[]>,\n    private transform: TransformFunc<T>) {}\n  destroy() {\n    this.entities.destroy();\n  }\n  private cache = new CacheByDeps<T>();\n  get(state: GpuWorldState) {\n    const entities = this.entities.get(state);\n    return this.cache.get(() => this.transform(state, entities), [entities]);\n  }\n}\n\nclass EntitiesToGpu {\n  constructor(private entities: Query<EntityRef[]>, private gls: GlState) {}\n  destroy() {\n    this.entities.destroy();\n    this.cache.destroy();\n  }\n  private cache = new CacheByDeps<{ entityListTexture: Texture, entityList: EntityRef[] }>();\n  private chunkWidth = 128;\n  get(state: GpuWorldState) {\n    const entityList = this.entities.get(state);\n    return this.cache.get(() => {\n      let entityListTexture: Texture;\n      if (entityList.length !== 0) {\n        const data = Image.zeroesI32({\n          width: Math.min(entityList.length, this.chunkWidth),\n          height: Math.ceil(entityList.length / this.chunkWidth),\n          depth: 1\n        }, 2);\n        for (let i=0; i < entityList.length; i++) {\n          data.write(entityList[i].x, i % this.chunkWidth, Math.floor(i / this.chunkWidth), 0, 0);\n          data.write(entityList[i].y, i % this.chunkWidth, Math.floor(i / this.chunkWidth), 0, 1);\n        }\n        entityListTexture = new Texture(this.gls, this.gls.gl.RG32I, data.size, undefined).init(data.data);\n      } else {\n        entityListTexture = new Texture(this.gls, this.gls.gl.RG32I, { width: 1, height: 1}).init();\n      }\n      return { entityList, entityListTexture };\n    }, [entityList], t => t.entityListTexture.destroy());\n  }\n  map(map: ShaderModule<{ map: FunctionDef<string, [['ivec2', 'entityCell']]> }>, output: (state: GpuWorldState, size: Size) => TextureSlicing | DoubleBufferedTextureSlicing) {\n    return new MapEntitiesGpu(this, this.gls, map, output);\n  }\n  mapToTemp(map: ShaderModule<{ map: FunctionDef<string, [['ivec2', 'entityCell']]> }>) {\n    return new MapEntitiesToTempGpu(this, this.gls, map);\n  }\n}\n\n\nclass MapEntitiesGpu {\n  constructor(\n    protected entities: Query<{ entityList: EntityRef[], entityListTexture: Texture }>,\n    protected gls: GlState,\n    private map: ShaderModule<{ map: FunctionDef<string, [['ivec2', 'entityCell']]> }>,\n    private output: (state: GpuWorldState, size: Size) => TextureSlicing | DoubleBufferedTextureSlicing) {}\n  destroy() {\n    this.entities.destroy();\n    this.renderTarget.destroy();\n    this.program.destroy();\n  }\n\n  private renderTarget = new RenderTarget(this.gls);\n  private shader = new CompiledShaderModule(shaderModule([this.map], {\n    entityList: uniformDef('isampler2D'),\n    outValue: outDef(this.map.map.returnType),\n    main: funcDef('void', [], `\n      ivec2 outEntityCell = texelFetch(entityList, ivec2(gl_FragCoord), 0).xy;\n      outValue = ${this.map.map}(outEntityCell);\n    `)\n  }))\n  private program = new Program(this.gls, this.shader.source);\n\n  get(state: GpuWorldState) {\n    const { entityList, entityListTexture } = this.entities.get(state);\n    const output = this.output(state, entityListTexture.size);\n    // This must be called before we start setting up for this draw call, because\n    // getting the values may involve renderings and state changes\n    this.shader.updateUniformValues(state);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.renderTarget.set(output instanceof TextureSlicing ? output : output.back);\n    this.gls.prepareForComputation(output.rect);\n    this.program.setUniform('entityList', 'isampler2D', entityListTexture);\n    this.gls.drawQuad(this.program);\n    if (output instanceof DoubleBufferedTextureSlicing) {\n      this.gls.getCopyTexture().copyBackToFront(output);\n    }\n    return { entityList, values: output instanceof DoubleBufferedTextureSlicing ? output.front : output };\n  }\n  toCpuQueuing(queueCashKey: (state: GpuWorldState) => any) {\n    return new QueuingEntityValueTextureReader(this, queueCashKey);\n  }\n  toCpuSync() {\n    return new SyncEntityValueTextureReader(this);\n  }\n  reduceSum() {\n    return new ReduceSum(this, this.gls);\n  }\n}\n\nclass MapEntitiesToTempGpu extends MapEntitiesGpu {\n  constructor(entities: Query<{ entityList: EntityRef[], entityListTexture: Texture }>,\n    gls: GlState,\n    map: ShaderModule<{ map: FunctionDef<string, [['ivec2', 'entityCell']]> }>) {\n    super(entities, gls, map, (state, size) => {\n      const depth = glslTypeArraySize(map.map.returnType) ?? 1;\n      if (this.tmp.size.width < size.width || this.tmp.size.height < size.height || this.tmp.depth! < depth) {\n        this.tmp.destroy();\n        this.tmp = Texture.create(this.gls, this.gls.gl.RGBA32F, size, depth).init();\n      }\n      this.tmp.sliceAll().clear();\n      return this.tmp.sliceRange(0, depth);\n    })\n  }\n  destroy() {\n    this.entities.destroy();\n    this.tmp.destroy();\n  }\n  private tmp = Texture.create(this.gls, this.gls.gl.RGBA32F, { width: 1, height: 1 }, 1).init();\n}\n\nclass SyncEntityValueTextureReader {\n  constructor(private query: Query<{ entityList: EntityRef[], values: TextureSlicing }>) {}\n  destroy() {\n    this.query.destroy();\n  }\n\n  get(state: GpuWorldState) {\n    const value = this.query.get(state);\n    const img = value.values.readSync();\n    return value.entityList.map((entityCell, i) => {\n      return {\n        entityCell,\n        value: new Array(img.size.depth).fill(0).map((_, z) =>\n          img.readPixel({ x: i % value.values.rect.width, y: Math.floor(i / value.values.rect.width), z })\n        )\n      }\n    });\n  }\n}\n\ntype QueuingEntityResult = Array<{ entityCell: EntityRef, value: Vector4[] }>;\nclass QueuingEntityValueTextureReader {\n  constructor(\n    private query: Query<{ entityList: EntityRef[], values: TextureSlicing }>,\n    private queueCashKey: (state: GpuWorldState) => any\n  ) {}\n  destroy() {\n    this.query.destroy();\n    this.resultReader.destroy();\n  }\n\n  private resultReader = new CacheByDeps<TextureReader>();\n  private resultQueue = new CacheByDeps<Array<() => QueuingEntityResult | undefined>>();\n  queueRead(state: GpuWorldState) {\n    const value = this.query.get(state);\n    const resultReader = this.resultReader.get(() => new TextureReader(value.values), [value.values], t => t.destroy());\n    const tryRead = resultReader.read('background', value.values.rect);\n    const resultQueue = this.resultQueue.get(() => [], [state, value.entityList, this.queueCashKey(state)]);\n    resultQueue.push(() => {\n      const img = tryRead();\n      if (!img) {\n        return undefined;\n      }\n      return value.entityList.map((entityCell, i) => {\n        return {\n          entityCell,\n          value: new Array(img.size.depth).fill(0).map((_, z) =>\n            img.readPixel({ x: i % value.values.rect.width, y: Math.floor(i / value.values.rect.width), z })\n          )\n        }\n      });\n    });\n    return function readResults(): QueuingEntityResult[] {\n      const res: QueuingEntityResult[] = [];\n      while (resultQueue.length > 0) {\n        const result = resultQueue[0]();\n        if (!result) {\n          return res;\n        } else {\n          resultQueue.shift();\n          res.push(result);\n        }\n      }\n      return res;\n    }\n  }\n}\n\nclass ReduceSum {\n  constructor(private query: Query<{ values: TextureSlicing }>, protected gls: GlState) {}\n  destroy() {\n    this.query.destroy();\n    this.reduce.destroy();\n    this.tmp.destroy();\n  }\n\n  reduce = GpuReduce.reduceSum(this.gls);\n  tmp = DoubleBufferedTexture.create(this.gls, GL.RGBA32F, { width: 1, height: 1 }, 1).init();\n\n  get(state: GpuWorldState) {\n    const value = this.query.get(state);\n    const size = sizeClosestPow2(value.values.rect);\n    if (this.tmp.size.width < size.width || this.tmp.size.height < size.height || this.tmp.depth! < value.values.layers.length) {\n      this.tmp.destroy();\n      this.tmp = DoubleBufferedTexture.create(this.gls, GL.RGBA32F, size, value.values.layers.length).init();\n    }\n    this.tmp.clear();\n    const tmpSlice = this.tmp.sliceAll().selectAbsolute({ x: 0, y: 0, ...size });\n    this.gls.getCopyTexture().copy(tmpSlice.selectAbsolute(value.values.rect).front, value.values);\n    return this.reduce.reduceSync(tmpSlice);\n  }\n}\n\ntype LookupFunc = (state: GpuWorldState, entityCell: EntityRef) => { row: number, column: number };\ninterface LookupTable {\n  width: number;\n  rows: Array<{\n    entities: EntityRef[];\n  }>\n}\n\nclass LookupTableQuery {\n  constructor(private entities: Query<EntityRef[]>, private indexWidth: number, private index: LookupFunc) {}\n  destroy() {\n    this.entities.destroy();\n  }\n  private cache = new CacheByDeps<LookupTable>();\n  public get(state: GpuWorldState) {\n    const entities = this.entities.get(state);\n    return this.cache.get(() => {\n      const index: LookupTable = {\n        width: this.indexWidth,\n        rows: []\n      };\n      for (const entityCell of entities) {\n        const { row, column } = this.index(state, entityCell);\n        if (!index.rows[row]) {\n          index.rows[row] = {\n            entities: new Array(this.indexWidth).fill(0).map(() => ({ x: -1, y: -1 }))\n          };\n        }\n        index.rows[row].entities[column] = entityCell;\n      }\n      return index;\n    }, [entities])\n  }\n  toGpu(gls: GlState) {\n    return new LookupTableToGpu(this, gls);\n  }\n}\n\nexport const GpuLookupTableSM = shaderModule('GpuIndex', [], {\n  entityCell: funcDef('ivec2', [['isampler2D', 'index'], ['int', 'row'], ['int', 'i']], `\n    return texelFetch(index, ivec2(i, row), 0).xy;\n  `)\n})\n\nclass LookupTableToGpu {\n  constructor(private indexQuery: Query<LookupTable>, private gls: GlState) {}\n  destroy() {\n    this.indexQuery.destroy();\n    this.buffer.destroy();\n    this.cache.destroy();\n  }\n\n  private buffer = new Texture(this.gls, GL.RG32I, { width: 1, height: 1 }).init();\n  private cache = new CacheByDeps<Texture>();\n  public get(state: GpuWorldState) {\n    const index = this.indexQuery.get(state);\n    return this.cache.get(() => {\n      const indexData = Image.zeroesI32({ width: index.width, height: Math.max(1, index.rows.length), depth: 1 }, 2);\n      indexData.fill(-1);\n      for (let i=0; i < index.rows.length; i++) {\n        if (index.rows[i]) {\n          for (let l=0; l < index.rows[i].entities.length; l++) {\n            const entity = index.rows[i].entities[l];\n            indexData.write(entity.x, l, i, 0, 0);\n            indexData.write(entity.y, l, i, 0, 1);\n          }\n        }\n      }\n      if (this.buffer.size.width < indexData.size.width || this.buffer.size.height < indexData.size.height) {\n        this.buffer.destroy();\n        this.buffer = new Texture(this.gls, GL.RG32I, indexData.size).init();\n      }\n      this.buffer.init(indexData.data);\n      return this.buffer;\n    }, [index]);\n  }\n}\n","import { Texture, DoubleBufferedTexture } from \"./Texture\";\nimport { Sampler } from \"./Program\";\nimport { Image } from \"./Image\";\nimport * as Vector2 from '../Math/Vector2';\nimport * as Vector3 from '../Math/Vector3';\nimport * as Vector4 from '../Math/Vector4';\nimport * as Mat4 from '../Math/Mat4';\n\nexport type TextureRef = Texture | DoubleBufferedTexture | Sampler | Image;\nexport type GLSLBaseType = 'float' | 'int' | 'uint' | 'bool' |\n  'vec2' | 'ivec2' | 'vec3' | 'ivec3' | 'vec4' | 'ivec4' | 'mat4' |\n  'sampler2D' | 'isampler2D' | 'usampler2D' | 'sampler2DArray' | 'isampler2DArray' | 'usampler2DArray';\nexport type GLSLArrayType = 'float[]' | 'int[]' | 'uint[]' | 'bool[]' |\n'vec2[]' | 'ivec2[]' | 'vec3[]' | 'ivec3[]' | 'vec4[]' | 'ivec4[]' | 'mat4[]' |\n'sampler2D[]' | 'isampler2D[]' | 'usampler2D[]' | 'sampler2DArray[]' | 'isampler2DArray[]' | 'usampler2DArray[]';\nexport type GLSLType = GLSLBaseType | GLSLArrayType;\nexport function toGLSLArrayType(baseType: GLSLBaseType): GLSLArrayType {\n  return (baseType + '[]') as GLSLArrayType;\n}\nexport type GLSLTsType = number | boolean | number[] | boolean[] |\n  Float32Array | Int32Array |\n  Vector2.Vector2 | Vector3.Vector3 | Vector4.Vector4 | Mat4.Mat4 |\n  Vector2.Vector2[] | Vector3.Vector3[] | Vector4.Vector4[] | Mat4.Mat4[] |\n  TextureRef | TextureRef[];\nexport interface GLSLTypeMappings {\n  'float': number,\n  'int': number,\n  'uint': number,\n  'bool': boolean,\n\n  'float[]': number[] | Float32Array,\n  'int[]': number[] | Int32Array,\n  'uint[]': number[],\n  'bool[]': boolean[],\n\n  'vec2': Vector2.Vector2,\n  'ivec2': Vector2.Vector2,\n  'vec3': Vector3.Vector3,\n  'ivec3': Vector3.Vector3,\n  'vec4': Vector4.Vector4,\n  'ivec4': Vector4.Vector4,\n  'mat4': Mat4.Mat4,\n\n  'vec2[]': Vector2.Vector2[],\n  'ivec2[]': Vector2.Vector2[],\n  'vec3[]': Vector3.Vector3[],\n  'ivec3[]': Vector3.Vector3[],\n  'vec4[]': Vector4.Vector4[],\n  'ivec4[]': Vector4.Vector4[],\n  'mat4[]': Mat4.Mat4[],\n\n  'sampler2D': TextureRef,\n  'isampler2D': TextureRef,\n  'usampler2D': TextureRef,\n  'sampler2DArray': TextureRef,\n  'isampler2DArray': TextureRef,\n  'usampler2DArray': TextureRef,\n\n  'sampler2D[]': TextureRef[],\n  'isampler2D[]': TextureRef[],\n  'usampler2D[]': TextureRef[],\n  'sampler2DArray[]': TextureRef[],\n  'isampler2DArray[]': TextureRef[],\n  'usampler2DArray[]': TextureRef[],\n}\n\nexport function glslTypeArraySize(type: string) {\n  const ss = type.indexOf('[');\n  if (ss === -1) {\n    return undefined;\n  }\n  return Number.parseInt(type.slice(ss + 1, type.length - 1));\n}","import { Texture, TextureSlicing } from \"../Texture\";\nimport { GlState } from \"../GlState\";\nimport { Image } from \"../Image\";\nimport { Vector2 } from \"../../Math/Vector2\";\nimport { GLSLTypeMappings } from \"../GLSLTypes\";\nimport { Vector4 } from \"../../Math/Vector4\";\nimport { EntityRef } from \"../../GpuWorld/StateData\";\nimport { shaderModule, uniformDef, funcDef } from \"../ShaderModule\";\nimport { Program, UniformValues } from \"../Program\";\nimport { GpuBufferData, componentBufferDepth } from \"./GpuBuffer\";\nimport lodash from 'lodash';\nimport { ArchetypeIndexQuery } from \"./Query\";\nimport { GpuWorldState } from \"../../GpuWorld/State\";\n\nexport type GpuBufferFormats = 'float' | 'vec4';\nexport interface GpuBuffer<F extends GpuBufferFormats = GpuBufferFormats> {\n  name: string;\n  format: F;\n}\n\nexport type ComponentFormats = 'float' | 'int' | 'bool' | 'vec2' | 'ivec2' | 'vec3' | 'ivec3' | 'vec4' | 'ivec4' | 'mat4';\nexport function componentFormatChannels(format: ComponentFormats) {\n  switch (format) {\n    case 'float': return 1;\n    case 'int': return 1;\n    case 'bool': return 1;\n    case 'vec2': return 2;\n    case 'ivec2': return 2;\n    case 'vec3': return 3;\n    case 'ivec3': return 3;\n    case 'vec4': return 4;\n    case 'ivec4': return 4;\n    case 'mat4': return 16;\n  }\n}\nfunction cpuComponentItemSize(component: CpuComponent) {\n  const itemSize = componentFormatChannels(component.format);\n  if (component.stride !== undefined) {\n    return Math.ceil(itemSize / component.stride) * component.stride;\n  } else {\n    return itemSize;\n  }\n}\n\nexport interface GpuComponent<F extends GpuBufferFormats = GpuBufferFormats, B extends GpuBuffer<F> = GpuBuffer<F>> {\n  type: 'gpu';\n  name: string;\n  buffer: B;\n  format: ComponentFormats;\n  depth?: number;\n}\nexport interface CpuComponent<F extends ComponentFormats = ComponentFormats> {\n  type: 'cpu';\n  name: string;\n  format: F;\n  stride?: number;\n}\nexport interface ObjComponent<T> {\n  type: 'obj';\n  name: string;\n}\nexport interface TokenComponent {\n  type: 'token';\n  name: string;\n}\n\nexport type Component = GpuComponent | CpuComponent | ObjComponent<any> | TokenComponent;\n\nexport class EntityInit {\n  constructor(public readonly data: { [name: string]: { component: Component, data: any } } = {}) {}\n  setComponent(component: TokenComponent): EntityInit;\n  setComponent<T>(component: ObjComponent<T>, data: T): EntityInit;\n  setComponent<F extends GpuBufferFormats>(component: GpuComponent<F>, data?: Array<GLSLTypeMappings[F] | Float32Array>): EntityInit;\n  setComponent(component: GpuComponent, data?: Float32Array): EntityInit;\n  setComponent(component: CpuComponent, data?: Float32Array): EntityInit;\n  setComponent(component: Component, data: any = null): EntityInit {\n    return new EntityInit({...this.data, [component.name]: { component, data } });\n  }\n  setComponents(components: Array<GpuComponent | CpuComponent>, data?: Float32Array): EntityInit {\n    let entityInit: EntityInit = this;\n    for (const component of components) {\n      if (component.type === 'cpu') {\n        entityInit = entityInit.setComponent(component, data);\n      } else {\n        entityInit = entityInit.setComponent(component, data);\n      }\n    }\n    return entityInit;\n  }\n  removeComponent(component: Component) {\n    const d = {...this.data};\n    delete d[component.name];\n    return new EntityInit(d);\n  }\n  hasComponent(component: Component) {\n    return !!this.data[component.name];\n  }\n}\n\nexport enum ECSConsts {\n  MaxArchetypes = 64,\n  ChunkSize = 128\n}\n\n\nfunction normalizeGpuComponentData(format: GpuBufferFormats, data: Array<number | Vector4 | Float32Array> | Float32Array): Float32Array[] {\n  const channels = (format === 'vec4') ? 4 : 1;\n  if (data instanceof Float32Array) {\n    const res: Float32Array[] = [];\n    for (let i=0; i < data.length / channels; i++) {\n      res.push(data.subarray(i * channels, (i + 1) * channels));\n    }\n    return res;\n  } else {\n    return data.map((d): Float32Array => {\n      if (d instanceof Float32Array) {\n        if (d.length < channels) {\n          const d2 = new Float32Array(channels).fill(0);\n          d2.set(d);\n          return d2;\n        } else {\n          return d;\n        }\n      } else if (typeof d === 'number') {\n        return new Float32Array([d]);\n      } else {\n        return new Float32Array([d.x, d.y, d.z, d.w]);\n      }\n    });\n  }\n}\n\nexport function chunkAddressFromEntityCell(entityCell: Vector2) {\n  const entityIndex = entityCell.x % ECSConsts.ChunkSize;\n  const chunkIndex = Math.floor(entityCell.x / ECSConsts.ChunkSize);\n  return { chunkIndex, entityIndex, archIndex: entityCell.y };\n}\nexport function entityCellFromChunkAddress(archIndex: number, chunkIndex: number, entityIndex: number) {\n  return {\n    x: chunkIndex * ECSConsts.ChunkSize + entityIndex,\n    y: archIndex\n  }\n}\n\n\ninterface ArchetypeChunk {\n  arch: Archetype;\n  index: number;\n  entities: number;\n  objComponent: {\n    [componentName: string]: {\n      data: any[];\n      contentVersion: number\n    }\n  };\n  cpuComponent: {\n    [componentName: string]: {\n      data: Float32Array;\n      contentVersion: number;\n    }\n  };\n}\nexport class Archetype {\n  constructor(\n    public index: number,\n    public components: Component[],\n  ) {}\n  chunks: ArchetypeChunk[] = [];\n\n  get entitiesCount() {\n    return this.chunks.reduce((p, x) => p + x.entities, 0);\n  }\n}\n\n\nexport class GpuBufferArchetypeBlock {\n  constructor(\n    public archetype: Archetype,\n    public archetypeDataRowOffset: number\n  ) {}\n  get uniforms(): UniformValues {\n    return {\n      outArchetype: {\n        type: 'int',\n        value: this.archetype.index\n      },\n      outArchetypeDataRowOffset: {\n        type: 'int',\n        value: this.archetypeDataRowOffset\n      }\n    }\n  }\n  get entitiesCount() {\n    return this.archetype.entitiesCount;\n  }\n  writeUniforms(program: Program) {\n    program.setUniform('outArchetype', 'int', this.archetype.index);\n    program.setUniform('outArchetypeDataRowOffset', 'int', this.archetypeDataRowOffset);\n  }\n  static SM = shaderModule([], {\n    outArchetype: uniformDef('int'),\n    outArchetypeDataRowOffset: uniformDef('int'),\n    getOutEntityCell: funcDef('ivec2', [], `\n      ivec2 outDataCell = ivec2(gl_FragCoord);\n      return ivec2(\n        (outDataCell.y - outArchetypeDataRowOffset) * ${ECSConsts.ChunkSize} + outDataCell.x,\n        outArchetype\n      );\n    `)\n  });\n}\n\nexport class GpuComponentBlock extends GpuBufferArchetypeBlock {\n  constructor(\n    public slices: TextureSlicing,\n    archetype: Archetype,\n    archetypeDataRowOffset: number\n  ) {\n    super(archetype, archetypeDataRowOffset)\n  }\n}\n\nexport class EntitiesRange {\n  constructor(public archetypeIndex: number, public startIndex: number, public count: number) {}\n  static fromEntity(entityCell: EntityRef) {\n    return new EntitiesRange(entityCell.y, entityCell.x, 1);\n  }\n  getIndex(index: number) {\n    return { x: this.startIndex + index, y: this.archetypeIndex };\n  }\n  *entities() {\n    for (let i=0; i < this.count; i++) {\n      yield this.getIndex(i);\n    }\n  }\n}\n\n\nexport class EntitiesBlock {\n  constructor(public archetype: number, public count: number) {\n\n  }\n  get uniforms(): UniformValues {\n    return {\n      outArchetype: {\n        type: 'int',\n        value: this.archetype\n      },\n    };\n  }\n  writeUniforms(program: Program) {\n    program.setUniform('outArchetype', 'int', this.archetype);\n  }\n  get firstEntityCell() {\n    return {\n      x: 0,\n      y: this.archetype,\n    }\n  }\n  static SM = shaderModule([], {\n    outArchetype: uniformDef('int'),\n    getOutEntityCell: funcDef('ivec2', [], `\n      return ivec2(\n        gl_InstanceID,\n        outArchetype\n      );\n    `)\n  });\n}\n\n\nexport class EntityComponentSystem {\n  constructor(private gls: GlState) {\n    for (const k of Object.keys(EntityComponentSystem.registeredGpuBuffers)) {\n      const gpuBuffer = EntityComponentSystem.registeredGpuBuffers[k];\n      this.gpuBuffers[gpuBuffer.name] = new GpuBufferData(this.gls, gpuBuffer);\n    }\n  }\n  destroy() {\n    for (const k of Object.keys(this.gpuBuffers)) {\n      this.gpuBuffers[k].destroy();\n    }\n    this.archetypeHasComponentTexture.destroy();\n  }\n  reset() {\n    throw new Error(`This is not working yet`);\n    // for (const k of Object.keys(this.gpuBuffers)) {\n    //   this.gpuBuffers[k].removeAllEntities();\n    // }\n    // this.gpuComponentInfos = {};\n    // this.formVersion++;\n    // this.archetypeHasComponentTexture.clear();\n    // this.archetypes = [];\n    // this.archetypesByKey = {};\n  }\n\n  createEntities(entity: EntityInit, count: number = 1) {\n    const entityData = Object.keys(entity.data).map(k => entity.data[k]);\n    const components = entityData.map(d => d.component);\n    const arch = this.getOrCreateArchetype(components);\n    const range = this.allocateEntities(arch, count);\n    for (const { component, data } of entityData) {\n      if (component.type === 'obj') {\n        this.setComponentData(component, range, data);\n      } else if (component.type === 'gpu' && data !== undefined && data !== null) {\n        this.setComponentData(component, range, data);\n      } else if (component.type === 'cpu' && data !== undefined && data !== null) {\n        this.setComponentData(component, range, data);\n      }\n    }\n    this.formVersion++;\n    return range;\n  }\n\n  private allocateEntities(arch: Archetype, totalCount: number) {\n    let lastChunk = arch.chunks[arch.chunks.length - 1];\n    let leftCount = totalCount;\n    let firstEntity;\n    if (lastChunk && lastChunk.entities < this.chunkSize) {\n      firstEntity = entityCellFromChunkAddress(arch.index, lastChunk.index, lastChunk.entities);\n      let roomLeft = this.chunkSize - lastChunk.entities;\n      let take = Math.min(totalCount, roomLeft);\n      lastChunk.entities += take;\n      leftCount -= take;\n    }\n    if (leftCount > 0) {\n      const newChunks = Math.ceil(leftCount / this.chunkSize);\n      const chunks = this.createArchetypeChunks(arch, newChunks);\n      if (!firstEntity) {\n        firstEntity = entityCellFromChunkAddress(arch.index, chunks[0].index, 0);\n      }\n      for (let i=0; i < chunks.length - 1; i++) {\n        chunks[i].entities = this.chunkSize;\n        leftCount -= this.chunkSize;\n      }\n      chunks[chunks.length - 1].entities = leftCount;\n    }\n    return new EntitiesRange(arch.index, firstEntity.x, totalCount);\n  }\n\n  private getOrCreateArchetype(components: Component[]) {\n    const archKey = components.map(x => x.name).join('_');\n    const arch = this.archetypesByKey[archKey];\n    if (arch) {\n      return arch;\n    }\n    return this.createArchetype(archKey, components);\n  }\n  private createArchetype(key: string, components: Component[]) {\n    if (this.archetypes.length >= ECSConsts.MaxArchetypes) {\n      console.warn(`[ECS] Exceeded max number of archetypes!`);\n    }\n    const index = this.archetypes.length;\n    const arch = new Archetype(index, components);\n    this.archetypes = [...this.archetypes, arch];\n    this.archetypesByKey[key] = arch;\n\n    for (const component of arch.components) {\n      if (!(component.name in this.components)) {\n        this.components[component.name] = {\n          archetypeHasComponent: [],\n          component,\n          index: Object.keys(this.components).length\n        }\n      }\n      this.components[component.name].archetypeHasComponent[arch.index] = true;\n      if (component.type === 'gpu') {\n        this.gpuComponentInfos[component.name] = new GpuComponentInfo(this, component);\n        this.gpuBuffers[component.buffer.name].enuserComponentAllocated(component);\n      }\n    }\n    this.createArchetypeHasComponentTexture();\n\n    return arch;\n  }\n\n  private createArchetypeChunks(arch: Archetype, count: number) {\n    const chunks: ArchetypeChunk[] = [];\n    for (let i=0; i < count; i++) {\n      const chunkId = arch.chunks.length;\n      const chunk: ArchetypeChunk = {\n        arch,\n        index: chunkId,\n        entities: 0,\n        objComponent: {},\n        cpuComponent: {}\n      };\n      arch.chunks.push(chunk);\n      chunks.push(chunk);\n      for (const component of arch.components) {\n        if (component.type === 'obj') {\n          chunk.objComponent[component.name] = { data: [], contentVersion: 0 };\n        }\n        if (component.type === 'cpu') {\n          const itemSize = cpuComponentItemSize(component);\n          chunk.cpuComponent[component.name] = {\n            data: new Float32Array(itemSize * this.chunkSize),\n            contentVersion: 0\n          };\n        }\n      }\n    }\n    for (const component of arch.components) {\n      if (component.type === 'gpu') {\n        this.gpuBuffers[component.buffer.name].setArchetypeChunks(arch, arch.chunks.length);\n      }\n    }\n    return chunks;\n  }\n\n  getCpuComponentDataView(component: CpuComponent, entityCell: Vector2, incContentVersion = true) {\n    const { chunkIndex, entityIndex, archIndex } = chunkAddressFromEntityCell(entityCell);\n    const chunk = this.archetypes[archIndex].chunks[chunkIndex];\n    const itemSize = cpuComponentItemSize(component);\n    const comp = chunk.cpuComponent[component.name];\n    const arr = comp.data;\n    if (!arr) {\n      return null;\n    }\n    if (incContentVersion) {\n      comp.contentVersion++;\n    }\n    const offset = entityIndex * itemSize;\n    return arr.subarray(offset, offset + itemSize);\n  }\n\n  setComponentData<F extends GpuBufferFormats>(component: GpuComponent<F>, entity: EntityRef | EntitiesRange, data: Array<GLSLTypeMappings[F] | Float32Array> | Float32Array): void;\n  setComponentData<F extends ComponentFormats>(component: CpuComponent<F>, entity: EntityRef | EntitiesRange, data: Float32Array): void;\n  setComponentData<T>(component: ObjComponent<T>, entity: EntityRef | EntitiesRange, data: T): void;\n  setComponentData(component: GpuComponent | CpuComponent | ObjComponent<any>, entity: EntityRef | EntitiesRange, data: any) {\n    if (component.type === 'gpu') {\n      this.gpuBuffers[component.buffer.name].setComponentData(component, entity,\n        normalizeGpuComponentData(component.buffer.format, data));\n    }\n    if (component.type === 'cpu') {\n      if (entity instanceof EntitiesRange) {\n        for (let i=0; i < entity.count; i++) {\n          this.setComponentData(component, { x: entity.startIndex + i, y: entity.archetypeIndex }, data);\n        }\n      } else {\n        const view = this.getCpuComponentDataView(component, entity);\n        if (!view) {\n          throw new Error(`[ECS.setComponentData] Entity (${JSON.stringify(entity)}) doesn't have component ${component.name}.`);\n        }\n        view.set(data);\n      }\n    }\n    if (component.type === 'obj') {\n      if (entity instanceof EntitiesRange) {\n        for (let i=0; i < entity.count; i++) {\n          this.setComponentData(component, { x: entity.startIndex + i, y: entity.archetypeIndex }, data);\n        }\n      } else {\n        const { chunkIndex, entityIndex, archIndex } = chunkAddressFromEntityCell(entity);\n        const comp = this.archetypes[archIndex].chunks[chunkIndex].objComponent[component.name];\n        comp.data[entityIndex] = data;\n        comp.contentVersion++;\n      }\n    }\n  }\n  setComponentsData(components: Array<CpuComponent | GpuComponent>, entityCell: Vector2, data: Float32Array): void {\n    for (const component of components) {\n      if (component.type === 'cpu') {\n        this.setComponentData(component, entityCell, data);\n      } else {\n        this.setComponentData(component, entityCell, data);\n      }\n    }\n  }\n  getComponentData<T>(component: ObjComponent<T>, entityCell: Vector2): T | undefined;\n  getComponentData<F extends GpuBufferFormats>(component: GpuComponent<F>, entityCell: EntityRef, asyncr?: true): Promise<Array<GLSLTypeMappings[F]>>;\n  getComponentData<F extends GpuBufferFormats>(component: GpuComponent<F>, entityCell: EntityRef, asyncr: false): Array<GLSLTypeMappings[F]>;\n  getComponentData<F extends ComponentFormats>(component: CpuComponent<F>, entityCell: EntityRef): Float32Array;\n  getComponentData(component: GpuComponent | CpuComponent | ObjComponent<any> | string, entityCell: Vector2, asyncr?: boolean): any;\n  getComponentData(component: GpuComponent | CpuComponent | ObjComponent<any> | string, entityCell: Vector2, asyncr = true): any {\n    if (typeof component === 'string') {\n      const c = this.components[component].component;\n      if (!c) {\n        throw new Error(`Component doesn't exist in this ecs`);\n      }\n      if (c.type === 'token') {\n        throw new Error(`Cannot get component data for token component`);\n      }\n      component = c;\n    }\n    if (component.type === 'obj') {\n      const { archIndex, chunkIndex, entityIndex } = chunkAddressFromEntityCell(entityCell);\n      const arch = this.archetypes[archIndex];\n      return arch.chunks[chunkIndex].objComponent[component.name]?.data[entityIndex];\n    } else if (component.type === 'cpu') {\n      return this.getCpuComponentDataView(component, entityCell, false);\n    } else {\n      return this.gpuBuffers[component.buffer.name].getComponentData(component, entityCell, asyncr, false);\n    }\n  }\n  getComponentDataRaw<F extends GpuBufferFormats>(component: GpuComponent<F>, entityCell: EntityRef, asyncr?: true): Promise<Image>;\n  getComponentDataRaw<F extends GpuBufferFormats>(component: GpuComponent<F>, entityCell: EntityRef, asyncr: false): Image;\n  getComponentDataRaw(component: GpuComponent, entityCell: Vector2, asyncr = true): any {\n    return this.gpuBuffers[component.buffer.name].getComponentData(component, entityCell, asyncr, true);\n  }\n  getEntityGpuComponentBlock(component: GpuComponent, entityCell: EntityRef): GpuComponentBlock {\n    const arch = this.archetypes[entityCell.y];\n    const buff = this.gpuBuffers[component.buffer.name];\n    const buffArch = buff.archetypes[entityCell.y]!;\n    return new GpuComponentBlock(\n      buff.getEntityComponentDataSlice(component, entityCell)!,\n      arch,\n      buffArch.dataRowOffset\n    );\n  }\n  getComponentByName(name: string) {\n    return this.components[name].component;\n  }\n\n\n  hasComponent<T>(component: ObjComponent<T>, entityCell: Vector2): boolean;\n  hasComponent<F extends GpuBufferFormats>(component: GpuComponent<F>, entityCell: EntityRef): boolean;\n  hasComponent<F extends ComponentFormats>(component: CpuComponent<F>, entityCell: EntityRef): boolean;\n  hasComponent(component: GpuComponent | CpuComponent | ObjComponent<any> | TokenComponent | string, entityCell: Vector2): boolean;\n  hasComponent(component: GpuComponent | CpuComponent | ObjComponent<any> | TokenComponent | string, entityCell: Vector2, asyncr = true): boolean {\n    if (typeof component === 'string') {\n      const c = this.components[component].component;\n      if (!c) {\n        throw new Error(`Component doesn't exist in this ecs`);\n      }\n      component = c;\n    }\n    const { archIndex } = chunkAddressFromEntityCell(entityCell);\n    return this.components[component.name].archetypeHasComponent[archIndex];\n  }\n\n\n  getAllEntityData(entityCell: EntityRef, asyncr: false): Array<{ component: Component, data: any }>;\n  getAllEntityData(entityCell: EntityRef, asyncr?: true): Promise<Array<{ component: Component, data: any }>>;\n  getAllEntityData(entityCell: EntityRef, asyncr = true) {\n    const components = this.archetypes[entityCell.y].components;\n    if (asyncr) {\n      return Promise.all(components.map(async component => {\n        let data: any = null;\n        if (component.type === 'gpu') {\n          data = await this.getComponentData(component, entityCell);\n        } else if (component.type === 'obj') {\n          data = this.getComponentData(component, entityCell);\n        } else if (component.type === 'cpu') {\n          data = this.getComponentData(component, entityCell);\n        }\n        return {\n          component,\n          data\n        }\n      }));\n    } else {\n      return components.map(component => ({\n        component,\n        data: component.type === 'obj' ? this.getComponentData(component, entityCell)\n          : component.type === 'cpu' ? this.getComponentData(component, entityCell)\n          : component.type === 'gpu' ? this.getComponentData(component, entityCell, false)\n          : null\n      }))\n    }\n  }\n\n  public getMatchingArchetypes(requiredComponents: Component[]) {\n    const archetypes: Archetype[] = [];\n    for (const arch of this.archetypes) {\n      if (this.archetypeMatches(arch, requiredComponents)) {\n        archetypes.push(arch);\n      }\n    }\n    return archetypes;\n  }\n  private archetypeMatches(arch: Archetype, requiredComponents: Component[]) {\n    for (let i=0; i < requiredComponents.length; i++) {\n      const c = arch.components.find(x => x.name === requiredComponents[i].name);\n      if (!c) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  public getEntityRefsForArchetypes(archetypes: Archetype[]) {\n    return lodash.flatMap(archetypes, arch => this.getEntityRefsForArchetype(arch));\n  }\n  public getEntityRefsForArchetype(arch: Archetype) {\n    const res: EntityRef[] = [];\n    for (let c=0; c < arch.chunks.length; c++) {\n      for (let i=0; i < arch.chunks[c].entities; i++) {\n        res.push(entityCellFromChunkAddress(arch.index, c, i));\n      }\n    }\n    return res;\n  }\n\n  public *getEntitiesForGpuComponentBlock(block: GpuComponentBlock) {\n    const arch = block.archetype;\n    for (let c=0; c < arch.chunks.length; c++) {\n      for (let i=0; i < arch.chunks[c].entities; i++) {\n        const entityCell = entityCellFromChunkAddress(arch.index, c, i);\n        yield {\n          entityCell,\n          blockCell: { x: i, y: c }\n        }\n      }\n    }\n  }\n\n  private createArchetypeHasComponentTexture() {\n    const compKeys = Object.keys(this.components);\n    const data = Image.zeroesU8({\n      width: compKeys.length,\n      height: this.archetypes.length,\n      depth: 1,\n    }, 1);\n    for (let y=0; y < this.archetypes.length; y++) {\n      const arch = this.archetypes[y];\n      for (const c of arch.components) {\n        const x = compKeys.indexOf(c.name);\n        data.write(1, x, y);\n      }\n    }\n    this.archetypeHasComponentTexture.size = data.size;\n    this.archetypeHasComponentTexture.init(data.data);\n  }\n\n  public removeAllEntities() {\n    for (const arch of this.archetypes) {\n      for (const chunk of arch.chunks) {\n        chunk.entities = 0;\n      }\n    }\n    for (const k of Object.keys(this.gpuBuffers)) {\n      this.gpuBuffers[k].removeAllEntities();\n    }\n    this.formVersion++;\n  }\n\n  public dump() {\n    // console.log(`ECS Archetypes:`);\n    // for (const arch of this.archetypes) {\n    //   console.log(`${arch.index}: ${arch.components.map(x => x.name).join(', ')}`);\n    // }\n    console.log(`ECS GpuBuffers:`);\n    const buffs = Object.keys(this.gpuBuffers).map(key => ({\n      key,\n      size: this.gpuBuffers[key].texture.sizeInBytes / (1024*1024)\n    }));\n    buffs.sort((a, b) => a.size - b.size);\n    for (const buff of buffs) {\n      console.log(`${buff.key}: ${buff.size}mb`);\n    }\n  }\n  public dumpJSON(worldState: GpuWorldState) {\n    return this.archetypes.map(a => {\n      let entities = new ArchetypeIndexQuery(a.index).entities().get(worldState);\n      return {\n        archetypeIndex: a.index,\n        components: a.components.map(c => {\n          return {\n            name: c.name,\n            type: c.type,\n            data: c.type === 'gpu' ? this.gpuBuffers[c.buffer.name].getArchetypeComponentData(c, a) :\n              c.type === 'token' ? undefined :\n              entities.map(e => this.getComponentData(c, e))\n          }\n        }),\n      }\n    });\n  }\n\n  public static registerComponent(component: TokenComponent): TokenComponent;\n  public static registerComponent<C extends GpuComponent>(component: C): C;\n  public static registerComponent<C extends CpuComponent>(component: C): C;\n  public static registerComponent<T>(component: ObjComponent<T>): ObjComponent<T>;\n  public static registerComponent(component: Component) {\n    return component;\n  }\n\n\n  public static registerGpuBuffer<F extends GpuBufferFormats>(buffer: GpuBuffer<F>): GpuBuffer<F> {\n    this.registeredGpuBuffers[buffer.name] = buffer;\n    return buffer;\n  }\n  private static registeredGpuBuffers: { [key: string]: GpuBuffer } = {};\n\n  public gpuBuffers: { [key: string]: GpuBufferData } = {};\n  public gpuBuffer(buffer: GpuBuffer) {\n    return this.gpuBuffers[buffer.name];\n  }\n\n  private gpuComponentInfos: { [key: string]: GpuComponentInfo } = {};\n  public gpuComponentInfo(component: GpuComponent): GpuComponentInfo | undefined {\n    return this.gpuComponentInfos[component.name];\n  }\n  public components: { [key: string]: ComponentInfo } = new Proxy({}, {\n    get: (obj, prop): ComponentInfo => {\n      if (prop in obj) {\n        return obj[prop];\n      } else {\n        return { archetypeHasComponent: [], index: -1 };\n      }\n    }\n  });\n\n  /// This increases every time an entity is added or removed, but not when their data is changed\n  public formVersion = 0;\n  public chunkSize: number = ECSConsts.ChunkSize;\n  public archetypeHasComponentTexture = Texture.create(this.gls, this.gls.gl.R8UI, { width: 1, height: 1 }).init();\n\n  public archetypes: Archetype[] = [];\n  private archetypesByKey: { [key: string]: Archetype } = {};\n}\n\nclass GpuComponentInfo {\n  constructor(private ecs: EntityComponentSystem, private component: GpuComponent) {}\n  get buffer() { return this.ecs.gpuBuffers[this.component.buffer.name]; }\n  get bufferComponent() { return this.buffer.components[this.component.name]; }\n  get layerOffset() { return this.bufferComponent.layerOffset; }\n  get slice() { return this.buffer.texture.sliceRange(this.bufferComponent.layerOffset, componentBufferDepth(this.component)) }\n}\n\ninterface ComponentInfo {\n  index: number;\n  archetypeHasComponent: boolean[];\n  component?: Component;\n}\n","import { mat4, vec4 } from 'gl-matrix';\nimport * as Vector4 from './Vector4';\nimport * as Vector3 from './Vector3';\nimport { ImageSlice, Image } from '../GpuUtil/Image';\n\nexport type Mat4 = mat4;\n\nexport function create(v0: number): Mat4;\nexport function create(\n  r0: Vector4.Vector4,\n  r1: Vector4.Vector4,\n  r2: Vector4.Vector4,\n  r3: Vector4.Vector4): Mat4;\nexport function create(\n  m00: number, m01: number, m02: number, m03: number,\n  m10: number, m11: number, m12: number, m13: number,\n  m20: number, m21: number, m22: number, m23: number,\n  m30: number, m31: number, m32: number, m33: number): Mat4;\nexport function create(...args: any[]): Mat4 {\n  if (args.length === 1) {\n    const v0 = args[0];\n    return mat4.fromValues(\n      v0, 0, 0, 0,\n      0, v0, 0, 0,\n      0, 0, v0, 0,\n      0, 0, 0, v0);\n  } else if (args.length === 4) {\n    const [r0, r1, r2, r3] = args;\n    return mat4.fromValues(\n      r0.x, r0.y, r0.z, r0.w,\n      r1.x, r1.y, r1.z, r1.w,\n      r2.x, r2.y, r2.z, r2.w,\n      r3.x, r3.y, r3.z, r3.w);\n  } else {\n    return fromArray(args);\n  }\n}\nexport function fromArray(values: number[]) {\n  const [m00, m01, m02, m03, m10, m11, m12, m13, m20, m21, m22, m23, m30, m31, m32, m33] = values;\n  return mat4.fromValues(m00, m01, m02, m03, m10, m11, m12, m13, m20, m21, m22, m23, m30, m31, m32, m33);\n}\nexport function identity() {\n  return mat4.identity(mat4.create());\n}\n\nexport function get(mat: Mat4, i: number, j: number): number {\n  return mat[i * 4 + j];\n}\nexport function row(mat: Mat4, i: number): Vector4.Vector4 {\n  return { x: get(mat, i, 0), y: get(mat, i, 1), z: get(mat, i , 2), w: get(mat, i, 3) };\n}\nexport function toRows(mat: Mat4) {\n  const rows: Vector4.Vector4[] = [];\n  for (let i=0; i < 4; i++) {\n    rows.push(row(mat, i));\n  }\n  return rows;\n}\nexport function writeToImageSlice(mat: Mat4, slice: ImageSlice<Float32Array>) {\n  for (let i=0; i < 4; i++) {\n    for (let j=0; j < 4; j++) {\n      slice.write(get(mat, i, j), 0, 0, i, j);\n    }\n  }\n}\nexport function writeToImage(mat: Mat4, image: Image<Float32Array>, x: number, y: number) {\n  for (let i=0; i < 4; i++) {\n    for (let j=0; j < 4; j++) {\n      image.write(get(mat, i, j), x, y, i, j);\n    }\n  }\n}\n\nexport function mul(...mats: Mat4[]): Mat4;\nexport function mul(a: Mat4, b: Vector4.Vector4): Vector4.Vector4;\nexport function mul(...args: any[]): Mat4 | Vector4.Vector4 {\n  if (args.length === 2) {\n    const [a, b] = args;\n    if (typeof b === 'object' && (b as any).x !== undefined) {\n      return Vector4.fromGlVec4(vec4.transformMat4(vec4.create(), Vector4.toGlVec4(b as Vector4.Vector4), a));\n    }\n  }\n  const res = mat4.clone(args[0]);\n  for (let i=1; i < args.length; i++) {\n    mat4.mul(res, res, args[i]);\n  }\n  return res;\n}\n\nexport function inverse(mat: Mat4): Mat4 | null {\n  return mat4.invert(mat4.create(), mat);\n}\n\nexport function transpose(mat: Mat4): Mat4 {\n  return mat4.transpose(mat4.create(), mat);\n}\n\nexport function translation(position: Vector3.Vector3): Mat4 {\n  const m = mat4.create();\n  return mat4.translate(m, m, [position.x, position.y, position.z]);\n}\nexport function scaling(scale: Vector3.Vector3): Mat4 {\n  const m = mat4.create();\n  return mat4.scale(m, m, [scale.x, scale.y, scale.z]);\n}\n\nexport function rotationX(radians: number): Mat4 {\n  const m = mat4.create();\n  return mat4.rotateX(m, m, radians);\n}\nexport function rotationY(radians: number): Mat4 {\n  const m = mat4.create();\n  return mat4.rotateY(m, m, radians);\n}\nexport function rotationZ(radians: number): Mat4 {\n  const m = mat4.create();\n  return mat4.rotateZ(m, m, radians);\n}\nexport function fromRotationTranslationScale(rotation: Vector4.Vector4, position: Vector3.Vector3, scale: Vector3.Vector3) {\n  return mat4.fromRotationTranslationScale(mat4.create(),\n    Vector4.toGlQuat(rotation),\n    Vector3.toGlVec3(position),\n    Vector3.toGlVec3(scale),\n  );\n}","import { GpuBuffer, EntityComponentSystem, GpuBufferFormats, GpuComponent, TokenComponent, CpuComponent, ComponentFormats } from \".\";\nimport { gpuComponentReadSM, gpuComponentBufferWriterSM, hasComponentSM } from \"./GpuComponentSM\";\n\nexport class GpuBufferModule<F extends GpuBufferFormats> {\n  constructor(public buffer: GpuBuffer<F>) {\n    EntityComponentSystem.registerGpuBuffer(this.buffer);\n  }\n}\n\nexport class TokenComponentModule {\n  constructor(private name: string) {\n  }\n  component: TokenComponent = { type: 'token', name: this.name };\n  hasComponentSM = hasComponentSM(this.component);\n}\n\nexport class GpuComponentModule<F extends GpuBufferFormats> {\n  constructor(private name: string, private buffer: GpuBuffer<F> | GpuBufferModule<F>, private format: GpuComponent['format'], private depth?: number) {\n  }\n  component: GpuComponent<F> = {\n    type: 'gpu',\n    name: this.name,\n    buffer: this.buffer instanceof GpuBufferModule ? this.buffer.buffer : this.buffer,\n    format: this.format,\n    depth: this.depth\n  };\n  sm = gpuComponentReadSM(this.component);\n  writer = gpuComponentBufferWriterSM(this.component);\n  hasComponentSM = hasComponentSM(this.component);\n}\n\nexport class DualComponentModule<F extends GpuBufferFormats, C extends ComponentFormats> {\n  constructor(private name: string, private buffer: GpuBuffer<F> | GpuBufferModule<F>, private format: C) {\n  }\n  gpuComponent: GpuComponent<F> = {\n    type: 'gpu',\n    name: this.name + 'Gpu',\n    buffer: this.buffer instanceof GpuBufferModule ? this.buffer.buffer : this.buffer,\n    format: this.format\n  };\n  cpuComponent: CpuComponent<C> = {\n    type: 'cpu',\n    name: this.name + 'Cpu',\n    format: this.format,\n    stride: this.gpuComponent.buffer.format === 'vec4' ? 4 : undefined\n  };\n  components = [this.gpuComponent, this.cpuComponent];\n  sm = gpuComponentReadSM(this.gpuComponent);\n  writer = gpuComponentBufferWriterSM(this.gpuComponent);\n  hasComponentSM = hasComponentSM(this.gpuComponent);\n}\n","import * as Math2 from './Math/Math';\n\nenum Month {\n  Jan,\n  Feb,\n  Mar,\n  Apr,\n  May,\n  Jun,\n  Jul,\n  Aug,\n  Sep,\n  Oct,\n  Nov,\n  Dec,\n}\n\nexport const DaysInMonth = 10;\nexport const StepsPerSecond = 60;\nexport const SecondsPerStep = 1/StepsPerSecond;\nexport const MonthsInYear = 12;\nexport const DaysInYear = MonthsInYear * DaysInMonth; // 120\nexport const SecondsInMinute = 60;\nexport const SecondsInHour = 60 * SecondsInMinute;\nexport const SecondsInDay = SecondsInHour * 24;\nexport const StepsInMinute = SecondsInMinute * StepsPerSecond;\nexport const StepsInHour = SecondsInHour * StepsPerSecond;\nexport const StepsInDay = SecondsInDay * StepsPerSecond;\nexport const StepsInMonth = DaysInMonth * StepsInDay;\nexport const StepsInYear = DaysInYear * StepsInDay;\n\nexport class PixlingDate {\n  constructor(public steps: number) {\n  }\n  private secondsOffset = 60 * 60 * 8; // Start time at 8am instead of midnight, so we get sunlight\n  timeInSeconds = this.steps * SecondsPerStep + this.secondsOffset;\n  timeInMinutesFractional = this.timeInSeconds / 60;\n  timeInHoursFractional = this.timeInSeconds / (60 * 60);\n  timeInDaysFractional = this.timeInSeconds / (60 * 60 * 24);\n  timeInMonthsFractional = this.timeInSeconds / (60 * 60 * 24 * DaysInMonth);\n  timeInYearsFractional = this.timeInSeconds / (60 * 60 * 24 * DaysInYear);\n  timeInMinutes = Math.floor(this.timeInMinutesFractional);\n  timeInHours = Math.floor(this.timeInHoursFractional);\n  timeInDays = Math.floor(this.timeInDaysFractional);\n  timeInMonths = Math.floor(this.timeInMonthsFractional);\n  timeInYears = Math.floor(this.timeInYearsFractional);\n  secondOfMinute = this.timeInSeconds % 60;\n  minuteOfHour = this.timeInMinutes % 60;\n  hourOfDay = this.timeInHours % 24;\n  dayOfYear = this.timeInDays % DaysInYear;\n  monthOfYear = this.timeInMonths % MonthsInYear;\n  year = this.timeInYears;\n  dayOfMonth = this.timeInDays - this.timeInMonths * DaysInMonth + 1; // 1 index\n  timeOfDayPercentage = Math2.fract(this.timeInDaysFractional);\n  timeOfYearPercentage = Math2.fract(this.timeInYearsFractional);\n  toString() {\n    return `${this.year} ${Month[this.monthOfYear]} ${this.dayOfMonth} - ${this.hourOfDay.toString().padStart(2, '0')}:${this.minuteOfHour.toString().padStart(2, '0')}`\n  }\n}\n\ninterface PixlingTimespanOpts {\n  short?: boolean;\n  padded?: boolean;\n}\n\nexport class PixlingTimespan {\n  constructor(public steps: number) { }\n  static fromDef(def: PixlingTimespanDef) { return new PixlingTimespan(pixlingTimespanDefToSteps(def)); }\n  timeInSecondsFractional = this.steps * SecondsPerStep;\n  timeInMinutesFractional = this.timeInSecondsFractional / 60;\n  timeInHoursFractional = this.timeInSecondsFractional / (60 * 60);\n  timeInDaysFractional = this.timeInSecondsFractional / (60 * 60 * 24);\n  timeInMonthsFractional = this.timeInSecondsFractional / (60 * 60 * 24 * DaysInMonth);\n  timeInYearsFractional = this.timeInSecondsFractional / (60 * 60 * 24 * DaysInYear);\n  timeInSeconds = Math.floor(this.timeInSecondsFractional);\n  timeInMinutes = Math.floor(this.timeInMinutesFractional);\n  timeInHours = Math.floor(this.timeInHoursFractional);\n  timeInDays = Math.floor(this.timeInDaysFractional);\n  timeInMonths = Math.floor(this.timeInMonthsFractional);\n  timeInYears = Math.floor(this.timeInYearsFractional);\n  secondOfMinute = this.timeInSeconds % 60;\n  minuteOfHour = this.timeInMinutes % 60;\n  hourOfDay = this.timeInHours % 24;\n  dayOfYear = this.timeInDays % DaysInYear;\n  monthOfYear = this.timeInMonths % MonthsInYear;\n  years = this.timeInYears;\n  dayOfMonth = this.timeInDays - this.timeInMonths * DaysInMonth;\n  private stringifyComp(value: number, name: string, { short = true, padded = true }: PixlingTimespanOpts = {}) {\n    const valuePadded = padded ? (value + '').padStart(2, ' ') : value;\n    if (short) {\n      return valuePadded + name.slice(0, 1);\n    } else {\n      if (value === 1) {\n        return valuePadded + ' ' + name + (padded ? ' ' : '');\n      } else {\n        return valuePadded + ' ' + name + 's';\n      }\n    }\n  }\n  toString(opts?: PixlingTimespanOpts) {\n    const c = [this.stringifyComp(this.secondOfMinute, 'second', opts)];\n    if (this.timeInMinutes > 0) {\n      c.unshift(this.stringifyComp(this.minuteOfHour, 'minute', opts));\n    }\n    if (this.timeInHours > 0) {\n      c.unshift(this.stringifyComp(this.hourOfDay, 'hour', opts));\n    }\n    if (this.timeInDays > 0) {\n      c.unshift(this.stringifyComp(this.dayOfMonth, 'day', opts));\n    }\n    if (this.timeInMonths > 0) {\n      c.unshift(this.stringifyComp(this.monthOfYear, 'month', opts));\n    }\n    if (this.timeInYears > 0) {\n      c.unshift(this.stringifyComp(this.years, 'year', opts));\n    }\n    return c.join(' ');\n  }\n  toStringMinimal(opts?: PixlingTimespanOpts) {\n    if (this.years > 0) {\n      return this.stringifyComp(this.years, 'year', opts);\n    } else if (this.dayOfYear > 0) {\n      return this.stringifyComp(this.dayOfYear, 'day', opts);\n    } else if (this.hourOfDay > 0) {\n      return this.stringifyComp(this.hourOfDay, 'hour', opts);\n    } else if (this.minuteOfHour > 0) {\n      return this.stringifyComp(this.minuteOfHour, 'minute', opts);\n    } else {\n      return this.stringifyComp(this.secondOfMinute, 'second', opts);\n    }\n  }\n}\n\nexport enum PixlingTimespanDefUnits {\n  Steps,\n  Minutes,\n  Hours,\n  Days,\n  Years\n}\n\nexport interface PixlingTimespanDef {\n  value: number;\n  unit: PixlingTimespanDefUnits;\n}\n\nexport function pixlingTimespanDefToSteps(def: PixlingTimespanDef) {\n  return Math.floor(pixlingTimespanDefToStepsFloat(def));\n}\n\nexport function pixlingTimespanDefToStepsFloat(def: PixlingTimespanDef) {\n  switch (def.unit) {\n    case PixlingTimespanDefUnits.Steps: return def.value;\n    case PixlingTimespanDefUnits.Minutes: return (def.value * 60) / SecondsPerStep;\n    case PixlingTimespanDefUnits.Hours: return (def.value * 60 * 60) / SecondsPerStep;\n    case PixlingTimespanDefUnits.Days: return (def.value * 60 * 60 * 24) / SecondsPerStep;\n    case PixlingTimespanDefUnits.Years: return (def.value * 60 * 60 * 24 * DaysInYear) / SecondsPerStep;\n  }\n}","import { EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { GpuBufferModule, GpuComponentModule, DualComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { EntityRef } from \"../StateData\";\n\nexport const CommonBuffer = new GpuBufferModule({\n  name: 'CommonBuffer',\n  format: 'float'\n});\n\nexport const NameComponent = EntityComponentSystem.registerComponent<{ value: string }>({\n  name: 'Name',\n  type: 'obj',\n});\n\nexport const Exists = new GpuComponentModule('Exists', CommonBuffer.buffer, 'bool');\n\nexport const ArenaInstance = new DualComponentModule('ArenaInstance', CommonBuffer, 'int');\nexport const ArenaMemberIndex = new DualComponentModule('ArenaMemberIndex', CommonBuffer, 'int');\n\nexport const ArenaBuffer = new GpuBufferModule({\n  name: 'ArenaBuffer',\n  format: 'float'\n});\nexport const Arena = new DualComponentModule('Arena', ArenaBuffer, 'int');\n\nexport const VisibleComponent = EntityComponentSystem.registerComponent<boolean>({\n  name: 'Visible',\n  type: 'obj',\n});\n\nexport const VisibilityFromComponent = EntityComponentSystem.registerComponent<{ value: EntityRef }>({\n  name: 'VisibilityFrom',\n  type: 'obj',\n});\n","import { EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport * as Mat4 from '../../Math/Mat4';\nimport { GpuWorldState } from \"../State\";\nimport { CommonBuffer } from \"./Components\";\nimport { GpuBufferModule, GpuComponentModule, DualComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { MatrixSM } from \"../../GpuUtil/SM2Utils\";\nimport { mat4 } from \"gl-matrix\";\n\nexport const TransformBuffer = new GpuBufferModule({\n  name: 'TransformBuffer',\n  format: 'vec4'\n});\n\nexport const Position = new DualComponentModule('Position', TransformBuffer, 'vec3');\nexport const Quaternion = new DualComponentModule('Quaternion', TransformBuffer.buffer, 'vec4');\nexport const Scale = new DualComponentModule('Scale', TransformBuffer.buffer, 'vec3');\n\nexport const RotationZ = new GpuComponentModule('RotationZ', CommonBuffer, 'float');\n\nexport const CpuBoneOffsetComponent = EntityComponentSystem.registerComponent<{\n  value: Mat4.Mat4\n}>({\n  name: 'CpuBoneOffset',\n  type: 'obj'\n});\n\nexport const BoneOffset = new GpuComponentModule('BoneOffset', TransformBuffer.buffer, 'mat4');\nexport const BoneMatrix = new GpuComponentModule('BoneMatrix', TransformBuffer.buffer, 'mat4');\n\nexport const TransformParent = new GpuComponentModule('TransformParent', TransformBuffer.buffer, 'ivec2');\n\nexport const LocalToParentOrderComponents = new Array(20).fill(0).map((_, i) => EntityComponentSystem.registerComponent({\n  name: 'LocalToParentOrder' + i,\n  type: 'token',\n}));\n\nexport const LocalToWorld = new DualComponentModule('LocalToWorld', TransformBuffer.buffer, 'mat4');\nexport const LocalToParent = new GpuComponentModule('LocalToParent', TransformBuffer.buffer, 'mat4');\nexport const OffsetLocalToWorld = new GpuComponentModule('OffsetLocalToWorld', TransformBuffer.buffer, 'mat4');\nexport const InvLocalToWorld = new DualComponentModule('LocalToWorld', TransformBuffer.buffer, 'mat4');\n\n\nexport const TransformHelpers = shaderModule('TransformHelpers', [MatrixSM, LocalToWorld.sm], {\n  worldPosition: funcDef('vec3', [['ivec2', 'entityCell']], `\n    return ${MatrixSM.transformPoint}(${LocalToWorld.sm.value}(entityCell), vec3(0));\n  `)\n});\n\nexport class UpdateTransform {\n  constructor(private gls: GlState) {}\n\n  positionRotation = new ArchetypesQuery([LocalToWorld.gpuComponent, Position.gpuComponent, RotationZ.component])\n    .mapGpu(this.gls, LocalToWorld.gpuComponent, shaderModule([MatrixSM, Position.sm, RotationZ.sm], {\n      map: funcDef('mat4', [['ivec2', 'entityCell']], `\n        return ${MatrixSM.translate}(${Position.sm.value}(entityCell)) *\n          ${MatrixSM.rotateZ}(${RotationZ.sm.value}(entityCell));\n      `)\n    }));\n  runPosRot(state: GpuWorldState) {\n    this.positionRotation.run(state);\n  }\n\n  localToWorld = LocalToParentOrderComponents.map(ltpo =>\n    new ArchetypesQuery([LocalToWorld.gpuComponent, LocalToParent.component, TransformParent.component, ltpo])\n      .mapGpu(this.gls, LocalToWorld.gpuComponent, shaderModule([LocalToParent.sm, TransformParent.sm, LocalToWorld.sm], {\n        map: funcDef('mat4', [['ivec2', 'entityCell']], `\n          mat4 localToParent = ${LocalToParent.sm.value}(entityCell);\n          ivec2 parent = ${TransformParent.sm.value}(entityCell);\n          mat4 parentWorld = ${LocalToWorld.sm.value}(parent);\n          return parentWorld * localToParent;\n        `)\n      }))\n    );\n  runLocalToWorld(state: GpuWorldState) {\n    for (const w of this.localToWorld) {\n      w.run(state);\n    }\n  }\n\n  boneMatrix = new ArchetypesQuery([BoneMatrix.component, BoneOffset.component, LocalToWorld.gpuComponent])\n    .mapGpu(this.gls, BoneMatrix.component, shaderModule([LocalToWorld.sm, BoneOffset.sm], {\n      map: funcDef('mat4', [['ivec2', 'entityCell']], `\n        mat4 localToWorld = ${LocalToWorld.sm.value}(entityCell);\n        mat4 boneOffset = ${BoneOffset.sm.value}(entityCell);\n        return localToWorld * boneOffset;\n      `)\n    }));\n  runBoneMatrix(state: GpuWorldState) {\n    this.boneMatrix.run(state);\n  }\n\n  offsetLocalToWorld = new ArchetypesQuery([LocalToWorld.gpuComponent, OffsetLocalToWorld.component])\n    .mapGpu(this.gls, LocalToWorld.gpuComponent, shaderModule([LocalToWorld.sm, OffsetLocalToWorld.sm], {\n      map: funcDef('mat4', [['ivec2', 'entityCell']], `\n        mat4 localToWorld = ${LocalToWorld.sm.value}(entityCell);\n        mat4 offset = ${OffsetLocalToWorld.sm.value}(entityCell);\n        return localToWorld * offset;\n      `)\n    }));\n  runOffset(state: GpuWorldState) {\n    this.offsetLocalToWorld.run(state);\n  }\n\n  cpuPositionToGpu = new ArchetypesQuery([Position.cpuComponent, Position.gpuComponent])\n    .gpuComponentBlocks(Position.gpuComponent)\n    .uploadFrom(Position.cpuComponent);\n  cpuQuaternionToGpu = new ArchetypesQuery([Quaternion.cpuComponent, Quaternion.gpuComponent])\n    .gpuComponentBlocks(Quaternion.gpuComponent)\n    .uploadFrom(Quaternion.cpuComponent);\n  cpuScaleToGpu = new ArchetypesQuery([Scale.cpuComponent, Scale.gpuComponent])\n    .gpuComponentBlocks(Scale.gpuComponent)\n    .uploadFrom(Scale.cpuComponent);\n  localToParentFromPosQatScaleQuery = new ArchetypesQuery([LocalToParent.component,\n    Position.gpuComponent, Quaternion.gpuComponent, Scale.gpuComponent])\n    .mapGpu(this.gls, LocalToParent.component, shaderModule([Position.sm, Quaternion.sm, Scale.sm, MatrixSM], {\n      map: funcDef('mat4', [['ivec2', 'entityCell']], `\n        vec3 position = ${Position.sm.value}(entityCell);\n        vec4 rotation = ${Quaternion.sm.value}(entityCell);\n        vec3 scale = ${Scale.sm.value}(entityCell);\n        return ${MatrixSM.rotateTranslateScale}(rotation, position, scale);\n      `)\n    }));\n  runLocalToParentFromCpuPosQatScale(state: GpuWorldState) {\n    this.cpuPositionToGpu.run(state);\n    this.cpuQuaternionToGpu.run(state);\n    this.cpuScaleToGpu.run(state);\n    this.localToParentFromPosQatScaleQuery.run(state);\n  }\n\n  boneMatrixFromCpuQuery = new EntitiesQuery([BoneMatrix.component, CpuBoneOffsetComponent, LocalToWorld.cpuComponent]);\n  runBoneMatrixFromCpu(state: GpuWorldState) {\n    for (const entityCell of this.boneMatrixFromCpuQuery.get(state)) {\n      const localToWorld = state.ecs.getComponentData(LocalToWorld.cpuComponent, entityCell);\n      const bone = state.ecs.getComponentData(CpuBoneOffsetComponent, entityCell)!;\n      const res = Mat4.mul(localToWorld, bone.value);\n      state.ecs.setComponentData(BoneMatrix.component, entityCell, Mat4.toRows(res));\n    }\n  }\n\n  localToWorldFromCpuQuery = new EntitiesQuery([LocalToWorld.gpuComponent, LocalToWorld.cpuComponent]);\n  runLocalToWorldFromCpu(state: GpuWorldState) {\n    for (const entityCell of this.localToWorldFromCpuQuery.get(state)) {\n      const localToWorld = state.ecs.getComponentData(LocalToWorld.cpuComponent, entityCell);\n      state.ecs.setComponentData(LocalToWorld.gpuComponent, entityCell, Mat4.toRows(localToWorld));\n    }\n  }\n\n  localToWorldFromCpuPosQuatScaleQuery = new EntitiesQuery([LocalToWorld.cpuComponent, Position.cpuComponent, Quaternion.cpuComponent, Scale.cpuComponent]);\n  runLocalToWorldFromCpuPosQuatScale(state: GpuWorldState) {\n    for (const entityCell of this.localToWorldFromCpuPosQuatScaleQuery.get(state)) {\n      const position = state.ecs.getComponentData(Position.cpuComponent, entityCell);\n      const quaternion = state.ecs.getComponentData(Quaternion.cpuComponent, entityCell);\n      const scale = state.ecs.getComponentData(Scale.cpuComponent, entityCell);\n      const localToWorld = state.ecs.getCpuComponentDataView(LocalToWorld.cpuComponent, entityCell);\n      if (localToWorld) {\n        mat4.fromRotationTranslationScale(localToWorld, quaternion, position, scale);\n      }\n    }\n  }\n\n  invLocalToWorldFromCpuQuery = new EntitiesQuery([LocalToWorld.cpuComponent, InvLocalToWorld.cpuComponent]);\n  runInvLocalToWorldFromCpu(state: GpuWorldState) {\n    for (const entityCell of this.invLocalToWorldFromCpuQuery.get(state)) {\n      const localToWorld = state.ecs.getCpuComponentDataView(LocalToWorld.cpuComponent, entityCell);\n      const invLocalToWorld = state.ecs.getCpuComponentDataView(InvLocalToWorld.cpuComponent, entityCell);\n      if (localToWorld && invLocalToWorld) {\n        mat4.invert(invLocalToWorld, localToWorld);\n      }\n    }\n  }\n\n  run(state: GpuWorldState) {\n    this.runPosRot(state);\n    this.runLocalToParentFromCpuPosQatScale(state);\n    this.runOffset(state);\n    this.runLocalToWorld(state);\n    this.runBoneMatrixFromCpu(state);\n    this.runBoneMatrix(state);\n    this.runLocalToWorldFromCpu(state);\n    this.runLocalToWorldFromCpuPosQuatScale(state);\n    this.runInvLocalToWorldFromCpu(state);\n  }\n}","import { keysOfEnum } from \"../Util\";\nimport { InitWorldStateConfig } from \"./StateInit\";\nimport { vec2FromSize, Size } from \"../Math/Math\";\nimport { StepsPerSecond } from \"../Time\";\nimport * as db from 'db';\nimport * as Vector3 from '../Math/Vector3';\n\nexport const Experiment = null;\n\nexport const StepsInBattle = 20 * StepsPerSecond;\n\nexport enum Teams {\n  None,\n  HomeTeam,\n  AwayTeam,\n  Both\n}\n\nexport enum NeighborCounters {\n  NearbyHome,\n  NearbyAway,\n  VicinityHome,\n  VicinityAway,\n  VicinityHomeMinerals,\n  VicinityAwayMinerals,\n}\nexport const NeighborCountersKeys = keysOfEnum(NeighborCounters);\n\nexport enum CastingState {\n  Inactive,\n  Casting,\n  Performing,\n  WindDown\n}\nexport const CastingStateKeys = keysOfEnum(CastingState);\n\nexport enum UnitAnimations {\n  None,\n  Idle1,\n  Run1,\n  Attack1,\n  Attack2,\n  TailAttack1,\n  Fire1,\n  Death1,\n  Jump1,\n  Dazed1,\n  BreathAttack1,\n  ShellHide1,\n  MuzzleFlash1\n}\n\nexport enum SoundEffect {\n  None,\n  KnifeHit,\n  FleshHit,\n  StoneHit,\n  // BulletImpactFlesh,\n  Dart,\n  DartThud,\n  Knife,\n  // KnifeLowpitch,\n  // KnifeLowestpitch,\n  Wimper,\n  Snore,\n  HealBuzz,\n  Resurrect,\n  BubbleWobble,\n  Balloon,\n  Jump,\n  CountIn,\n  Gunshot,\n  HeavyDoorClose,\n  Footstep,\n  Victory,\n  ApplyItem,\n  Bite,\n  PlanksFalling,\n  WoodHit,\n  Explosion,\n  Brass,\n  StoneTick,\n  Coins\n}\n\nexport enum BrainOutputs {\n  MoveX,\n  Rotate,\n  ChaseFocus,\n\n  CastSlot0,\n  CastSlot1,\n  CastSlot2,\n\n  FocusFriendStatue,\n  FocusFriend1,\n  FocusFriend2,\n  FocusEnemyStatue,\n  FocusEmemy1,\n  FocusEnemy2,\n  FocusEnemy3,\n}\nexport const BrainOutputsKeys = keysOfEnum(BrainOutputs);\n\nexport enum GroundLayers {\n  Elevation,\n}\nexport const GroundLayerKeys = keysOfEnum(GroundLayers);\n\nexport const SideSize = db.MaxTeamSize + 1; // team + statue\nexport const ArenaMembersSize = SideSize * 2;\nexport const TeamPoints = 12;\nexport const StatuePoints = 13;\n\nexport const StatuePosition = { x: 51, y: 51, z: 3.31552 };\nexport const BaseSpawnHeight = 2.23807;\nexport const SpawnPositions = {\n  [db.DbBattleground.Solo]: [StatuePosition, { x: 57, y: 57, z: BaseSpawnHeight }],\n  [db.DbBattleground.Duo]: [StatuePosition, { x: 57.2, y: 59.2, z: BaseSpawnHeight }, { x: 58.9, y: 56, z: BaseSpawnHeight }],\n  [db.DbBattleground.Team]: [StatuePosition, { x: 52.7, y: 58.4, z: BaseSpawnHeight }, { x: 58.2, y: 58.2, z: BaseSpawnHeight }, { x: 60.4, y: 54.8, z: BaseSpawnHeight }],\n}\nexport function mirrorPosition(p: Vector3.Vector3, worldSize: Size) {\n  return {\n    x: worldSize.width - p.x,\n    y: worldSize.height - p.y,\n    z: p.z\n  }\n}\n\nexport const ReplayCameraClipKey = 'ReplayCamera';\n\nexport class GpuWorldStateLayout {\n\n  constructor(private config: InitWorldStateConfig) {}\n\n  worldSize = { width: 128, height: 128 };\n\n  brain2 = {\n    hiddenLayerOutputSlices: 8,\n  }\n\n  arenas = this.config.arenaCount;\n  arenasSize = arenaSizeFromCount(this.config.arenaCount);\n  arenasRect = {\n    x: 0, y: 0,\n    ...this.arenasSize\n  }\n  arenasSizeVec2 = vec2FromSize(this.arenasSize);\n\n  arenasWorldSize = {\n    width: this.worldSize.width * this.arenasSize.width,\n    height: this.worldSize.height * this.arenasSize.height,\n  };\n  arenasWorldSizeVec2 = vec2FromSize(this.arenasWorldSize);\n\n  heatmapSize = {\n    width: Math.max(1, this.worldSize.width / 32),\n    height: Math.max(1, this.worldSize.height / 32),\n  }\n  heatmapSizeVec2 = vec2FromSize(this.heatmapSize);\n}\nfunction arenaSizeFromCount(count: number) {\n  const maxWidth = 32;\n  return {\n    width: count <= maxWidth ? count : maxWidth,\n    height: Math.ceil(count / maxWidth)\n  }\n}\n\nexport const FeatureColors = {\n  Body: '#d2c129',\n  Foliage: '#18a547',\n  Mouth: '#d2521a',\n  Eyes: '#b587aa',\n  Claw: '#9419d1',\n  LegsLength: '#186ed1',\n  Legs: '#18b8d1',\n}\nexport const HungerColor = '#ff5200';\nexport const HomeHealthColor = '#87c741';\nexport const AwayHealthColor = '#d9613d';\nexport const ManaColor = '#2e92d9';\nexport const CastingColor = '#ff0000';\nexport const GrowthRateColor= '#cc00ff';\n","import { EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { Teams, SideSize } from \"../StateLayout\";\nimport { TokenComponentModule, GpuComponentModule, GpuBufferModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { UnitDef } from \"../../GpuWorld/UnitDef\";\nimport { Position, TransformBuffer } from \"./Transform\";\nimport { ArenaMemberIndex, CommonBuffer } from \"./Components\";\nimport { keysOfEnum } from \"../../Util\";\nimport { SoundEffectController } from \"../Audio\";\nimport { UnitBounties, BountyDefs } from \"db\";\n\nexport const UnitBuffer = new GpuBufferModule({\n  name: 'UnitBuffer',\n  format: 'float'\n});\n\nexport const MaxHitpoints = 100;\nexport const Hitpoints = new GpuComponentModule('Hitpoints', UnitBuffer, 'float');\n\nexport const MaxMana = 100;\nexport const Mana = new GpuComponentModule('Mana', UnitBuffer, 'float');\n\nexport const Team = new GpuComponentModule('Team', UnitBuffer, 'int');\nexport const CpuTeamComponent = EntityComponentSystem.registerComponent<Teams>({\n  type: 'obj',\n  name: 'CpuTeam'\n});\n\nexport const GymIndex = new GpuComponentModule('GymIndex', UnitBuffer, 'ivec2');\n\nexport enum UnitCategories {\n  Friend,\n  Enemy,\n  FriendStatue,\n  EnemyStatue\n}\nexport const NUnitCategories = keysOfEnum(UnitCategories).length;\nexport const UnitCategory = shaderModule([ArenaMemberIndex.sm], {\n  category: funcDef('int', [['ivec2', 'selfEntityCell'], ['ivec2', 'otherEntityCell']], `\n    int selfArenaMemberIndex = ${ArenaMemberIndex.sm.value}(selfEntityCell);\n    int otherArenaMemberIndex = ${ArenaMemberIndex.sm.value}(otherEntityCell);\n    bool isStatue = otherArenaMemberIndex == 0 || otherArenaMemberIndex == ${SideSize};\n    bool selfIsHome = selfArenaMemberIndex < ${SideSize};\n    bool otherIsHome = otherArenaMemberIndex < ${SideSize};\n    bool isFriendly = selfIsHome == otherIsHome;\n    if (isStatue) {\n      return isFriendly ? ${UnitCategories.FriendStatue} : ${UnitCategories.EnemyStatue};\n    } else {\n      return isFriendly ? ${UnitCategories.Friend} : ${UnitCategories.Enemy};\n    }\n  `)\n});\nexport function unitCategoryFromArenaMemberIndex(arenaMemberIndex: number, selfIsHome = true) {\n  const isStatue = arenaMemberIndex === 0 || arenaMemberIndex === SideSize;\n  const otherIsHome = arenaMemberIndex < SideSize;\n  const isFriendly = selfIsHome === otherIsHome;\n  if (isStatue) {\n    return isFriendly ? UnitCategories.FriendStatue : UnitCategories.EnemyStatue;\n  } else {\n    return isFriendly ? UnitCategories.Friend : UnitCategories.Enemy;\n  }\n}\n\nexport const CpuPlayerUnitComponent = EntityComponentSystem.registerComponent<{ unit: UnitDef }>({\n  type: 'obj',\n  name: 'CpuPlayerUnit'\n});\n\nexport const Unit = new TokenComponentModule('Unit');\nexport const PlayerUnit = new TokenComponentModule('PlayerUnit');\nexport const Creature = new TokenComponentModule('Creature');\nexport const Generation = new GpuComponentModule('Generation', UnitBuffer.buffer, 'int');\nexport const TakesGroundDamage = new TokenComponentModule('TakesGroundDamage');\nexport const WorthPoints = new GpuComponentModule('WorthPoints', UnitBuffer.buffer, 'int');\n\nexport const ModelCreatedComponent = EntityComponentSystem.registerComponent<boolean>({\n  type: 'obj',\n  name: 'ModelCreated'\n});\n\nexport const TailAttachment = new GpuComponentModule<'float'>('TailAttachment', UnitBuffer.buffer, 'ivec2');\nexport const BackAttachment = new GpuComponentModule<'float'>('BackAttachment', UnitBuffer.buffer, 'ivec2');\nexport const HeadAttachment = new GpuComponentModule<'float'>('HeadAttachment', UnitBuffer.buffer, 'ivec2');\n\nexport const HandLeftAttachment = new GpuComponentModule<'float'>('HandLeftAttachment', UnitBuffer.buffer, 'ivec2');\nexport const HandRightAttachment = new GpuComponentModule<'float'>('HandRightAttachment', UnitBuffer.buffer, 'ivec2');\n\nexport const ProjectileAttachment = new GpuComponentModule<'float'>('ProjectileAttachment', UnitBuffer.buffer, 'ivec2');\n\nexport const UnitCenterSM = shaderModule([Position.sm], {\n  center: funcDef('vec3', [['ivec2', 'entityCell']], `\n    return ${Position.sm.value}(entityCell) + vec3(0, 0, 1);\n  `)\n})\n\n\n\nexport const HitpointsTrailing = new GpuComponentModule('HitpointsTrailing', UnitBuffer, 'float');\n\nexport const HitpointsRegenComponent = EntityComponentSystem.registerComponent({\n  name: 'HitpointsRegen',\n  type: 'token',\n});\n\nexport const ManaRegenComponent = EntityComponentSystem.registerComponent({\n  name: 'ManaRegen',\n  type: 'token',\n});\n\nexport const Gold = new GpuComponentModule('Gold', UnitBuffer, 'float');\nexport const PreviousGold = new GpuComponentModule('PreviousGold', UnitBuffer, 'float');\n\nexport const PreviousHitpoints = new GpuComponentModule('PreviousHitpoints', UnitBuffer, 'float');\nexport const DiedStep = new GpuComponentModule('DiedStep', UnitBuffer, 'int');\nexport const ImpactOwner = new GpuComponentModule('ImpactOwner', UnitBuffer, 'ivec2');\nexport const LastPushedBy = new GpuComponentModule('LastPushedBy', UnitBuffer, 'ivec2');\nexport const IsTakingFallDamage = new GpuComponentModule('IsTakingFallDamage', UnitBuffer, 'bool');\n\nexport const CrabAI = new TokenComponentModule('CrabAI');\nexport const DuckAI = new TokenComponentModule('DuckAI');\n\nexport const MaxFocusDistance = 30;\nexport const Focuser = new GpuComponentModule('Focuser', UnitBuffer, 'ivec2');\nexport const Focusable = new GpuComponentModule('Focusable', CommonBuffer.buffer, 'bool');\n\nexport const AnimatableUnitComponent = EntityComponentSystem.registerComponent<{ stepLength: number }>({\n  name: 'AnimatableUnit',\n  type: 'obj'\n});\nexport const UnitSoundMaterialComponent = EntityComponentSystem.registerComponent<{ value: 'flesh' | 'wood' | 'statue' }>({\n  name: 'UnitSoundMaterial',\n  type: 'obj'\n});\nexport const UnitSoundsComponent = EntityComponentSystem.registerComponent<{ playing: { [key: string]: SoundEffectController | undefined } }>({\n  name: 'UnitSounds',\n  type: 'obj'\n});\n\nexport const UnitMovement = new TokenComponentModule('UnitMovement');\nexport const UnitMovementSpeed = new GpuComponentModule('UnitMovementSpeed', UnitBuffer, 'float');\nexport const UnitRotationSpeed = new GpuComponentModule('UnitRotationSpeed', UnitBuffer, 'float');\n\nexport const WalkingSpeed = new GpuComponentModule('WalkingSpeed', UnitBuffer.buffer, 'float');\nexport const Velocity = new GpuComponentModule('Velocity', TransformBuffer.buffer, 'vec3');\nexport const Force = new GpuComponentModule('Force', TransformBuffer.buffer, 'vec3');\nexport const IsOnGround = new GpuComponentModule('IsOnGround', TransformBuffer.buffer, 'bool');\n\nexport const Stuck = new GpuComponentModule('Stuck', UnitBuffer, 'bool');\n\nexport const UnitStats = {\n  AliveTime: new GpuComponentModule('UnitStatsAliveTime', UnitBuffer.buffer, 'float'),\n  CumulativeHitpoints: new GpuComponentModule('UnitStatsCumulativeHitpoints', UnitBuffer.buffer, 'float'),\n  MinDistEnemyStatue: new GpuComponentModule('UnitStatsMinDistEnemyStatue', UnitBuffer.buffer, 'float'),\n}\n\nexport const BountyComponents: { [key in keyof UnitBounties]: GpuComponentModule<'float'> } = {} as any;\nfor (const bountyDef of BountyDefs) {\n  BountyComponents[bountyDef.key] = new GpuComponentModule('UnitBounty' + bountyDef.key, UnitBuffer, 'float');\n}","import { GpuWorldState } from \"../State\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { ArenaInstance, VisibleComponent, VisibilityFromComponent } from \"./Components\";\n\nexport function visibleCacheKeys(state: GpuWorldState) {\n  return [state.data.renderArena, state.data.renderAllArenas]\n}\n\nexport class UpdateVisible {\n  visibleQuery = new EntitiesQuery([VisibleComponent, ArenaInstance.cpuComponent])\n    .updateCpu((state, entities) => {\n      for (const entityCell of entities) {\n        const arenaInstance = state.ecs.getComponentData(ArenaInstance.cpuComponent, entityCell)[0];\n        state.ecs.setComponentData(VisibleComponent, entityCell, arenaInstance === state.data.renderArena ||\n          (state.data.renderAllArenas && arenaInstance === -1));\n      }\n    }, visibleCacheKeys);\n\n  visibleFromQuery = new EntitiesQuery([VisibleComponent, VisibilityFromComponent])\n    .updateCpu((state, entities) => {\n      for (const entityCell of entities) {\n        const from = state.ecs.getComponentData(VisibilityFromComponent, entityCell)!;\n        const visible = state.ecs.getComponentData(VisibleComponent, from.value)!;\n        state.ecs.setComponentData(VisibleComponent, entityCell, visible);\n      }\n    }, visibleCacheKeys);\n\n  run(state: GpuWorldState) {\n    this.visibleQuery.run(state);\n    this.visibleFromQuery.run(state);\n  }\n}\n","import { GpuWorldState } from \"../State\";\nimport { EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { rgba255ToVec401 } from \"../../Util\";\nimport { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { LightSM2, FogSM2 } from \"./Util\";\nimport { Program } from \"../../GpuUtil/Program\";\nimport { BoneMatrix, LocalToWorld } from \"../ECS/Transform\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GpuBufferModule, GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { uniformDef, uniformArrayDef, CompiledShaderModule, shaderModule, funcDef, outDef, inDef, ShaderModule, FunctionDef } from \"../../GpuUtil/ShaderModule\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { EntityRef } from \"../StateData\";\nimport { createBatches } from \"../../GpuUtil/Computation\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nexport enum CullFace {\n  None = GL.NONE,\n  Front = GL.FRONT,\n  Back = GL.BACK,\n  FrontAndBack = GL.FRONT_AND_BACK\n}\n\nexport const ModelRendererBuffer = new GpuBufferModule({\n  name: 'ModelRendererBuffer',\n  format: 'vec4'\n});\nexport const MaterialColor = new GpuComponentModule('MaterialColor', ModelRendererBuffer.buffer, 'vec4');\nexport const MaterialUseLighting = new GpuComponentModule('MaterialUseLighting', ModelRendererBuffer.buffer, 'bool');\n\ninterface Renderable {\n  mesh: string;\n  cullFace: CullFace;\n  skinning?: boolean;\n  transparent?: boolean;\n}\nexport const RenderableComponent = EntityComponentSystem.registerComponent<Renderable>({\n  name: 'Renderable',\n  type: 'obj',\n});\n\nexport const MaxBones = 256;\nconst SkinmeshBuffer = new GpuBufferModule({ name: 'SkinmeshBuffer', format: 'vec4' });\nexport const SkinmeshBones = new GpuComponentModule('SkinmeshBones', SkinmeshBuffer, 'ivec2', MaxBones);\nexport const SkinmeshBindMatrix = new GpuComponentModule('SkinmeshBindMatrix', SkinmeshBuffer, 'mat4');\n\nclass SM2Program {\n  constructor(protected gls: GlState, public fragmentShader: CompiledShaderModule, public vertexShader: CompiledShaderModule) {}\n  program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n}\n\nexport class ModelRenderer {\n  constructor(protected gls: GlState) {}\n\n  private maxInstanceCount = 256;\n  private createVertexShader = (worldTransform: ShaderModule<{ getWorldTransform: FunctionDef<'mat4', [['ivec2', 'entityCell']]> }>) =>\n    new CompiledShaderModule(shaderModule([\n    Vertex,\n    worldTransform,\n    MaterialColor.sm,\n    MaterialUseLighting.sm,\n  ], {\n    entityCells: uniformArrayDef('ivec2[]', this.maxInstanceCount),\n    viewPosition: outDef('vec3'),\n    normal: outDef('vec3'),\n    materialColor: outDef('vec4'),\n    materialUseLighting: outDef('int', true),\n    viewMatrix: uniformDef('mat4', d => d.derived.cameraView),\n    projectionMatrix: uniformDef('mat4', d => d.derived.cameraProjection),\n    main: funcDef('void', [], `\n      ivec2 entityCell = entityCells[gl_InstanceID];\n      mat4 worldTransform = ${worldTransform.getWorldTransform}(entityCell);\n\n      vec4 viewPos = viewMatrix * worldTransform * vec4(${Vertex.position}, 1.0 );\n      viewPosition = viewPos.xyz / viewPos.w;\n      gl_Position = projectionMatrix * viewPos;\n\n      mat4 invTranspWorldTransform = transpose(inverse(worldTransform));\n      normal = normalize((invTranspWorldTransform * vec4(${Vertex.normal}, 1)).xyz);\n\n      materialColor = ${MaterialColor.sm.value}(entityCell);\n      materialUseLighting = int(${MaterialUseLighting.sm.value}(entityCell));\n    `)\n  }));\n\n  staticVertexShader = this.createVertexShader(shaderModule([\n    LocalToWorld.sm,\n  ], {\n    getWorldTransform: funcDef('mat4', [['ivec2', 'entityCell']], `\n      return ${LocalToWorld.sm.value}(entityCell);\n    `)\n  }));\n\n  skinmeshVertexShader = this.createVertexShader(shaderModule([\n    BoneMatrix.sm,\n    SkinmeshBones.sm,\n    SkinmeshBindMatrix.sm,\n  ], {\n    getWorldTransform: funcDef('mat4', [['ivec2', 'entityCell']], `\n      ivec2 boneEntity0 = ${SkinmeshBones.sm.value}(entityCell, int(${Vertex.skinIndex}[0]));\n      ivec2 boneEntity1 = ${SkinmeshBones.sm.value}(entityCell, int(${Vertex.skinIndex}[1]));\n      ivec2 boneEntity2 = ${SkinmeshBones.sm.value}(entityCell, int(${Vertex.skinIndex}[2]));\n      ivec2 boneEntity3 = ${SkinmeshBones.sm.value}(entityCell, int(${Vertex.skinIndex}[3]));\n      mat4 bone0 = ${BoneMatrix.sm.value}(boneEntity0);\n      mat4 bone1 = ${BoneMatrix.sm.value}(boneEntity1);\n      mat4 bone2 = ${BoneMatrix.sm.value}(boneEntity2);\n      mat4 bone3 = ${BoneMatrix.sm.value}(boneEntity3);\n      mat4 skinMatrix = mat4(0.0);\n      skinMatrix += ${Vertex.skinWeight}.x * bone0;\n      skinMatrix += ${Vertex.skinWeight}.y * bone1;\n      skinMatrix += ${Vertex.skinWeight}.z * bone2;\n      skinMatrix += ${Vertex.skinWeight}.w * bone3;\n      mat4 bindMatrix = ${SkinmeshBindMatrix.sm.value}(entityCell);\n      return skinMatrix * bindMatrix;\n    `)\n  }));\n\n  private fragmentShader = new CompiledShaderModule(shaderModule([LightSM2, FogSM2], {\n    outColor: outDef('vec4'),\n    materialColor: inDef('vec4'),\n    materialUseLighting: inDef('int', true),\n    materialIsUnit: inDef('int', true),\n    normal: inDef('vec3'),\n    viewPosition: inDef('vec3'),\n    fogColor: uniformDef('vec4', d => rgba255ToVec401(d.data.rendererConfig.fogColor)),\n    fogDensity: uniformDef('float', d => d.data.rendererConfig.fogDensity),\n    fogOffset: uniformDef('float', d => d.data.rendererConfig.fogOffset),\n    main: funcDef('void', [], `\n      outColor = materialColor;\n      if (bool(materialUseLighting)) {\n        float lightAmount = ${LightSM2.light}(normal);\n        outColor.rgb *= mix(0.8, 1., lightAmount);\n      }\n\n      float depthFog = ${FogSM2.fogFactorExp2}(max(0.0, length(viewPosition) - fogOffset), fogDensity);\n      outColor.rgb = mix(outColor.rgb, fogColor.rgb, fogColor.a * depthFog);\n    `)\n  }));\n\n  private programs = {\n    static: new SM2Program(this.gls, this.fragmentShader, this.staticVertexShader),\n    skinmesh: new SM2Program(this.gls, this.fragmentShader, this.skinmeshVertexShader)\n  }\n\n  private query = new EntitiesQuery([RenderableComponent, LocalToWorld.gpuComponent, VisibleComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .transform((state, entityCells) => {\n      const programNode = (): {\n        [renderable: string]: {\n          entities: EntityRef[];\n          renderable: Renderable\n        }\n      } => ({});\n      const renderTree = {\n        opaque: {\n          skinmesh: programNode(),\n          static: programNode()\n        },\n        transparent: {\n          skinmesh: programNode(),\n          static: programNode()\n        }\n      };\n      for (const entityCell of entityCells) {\n        const renderable = state.ecs.getComponentData(RenderableComponent, entityCell)!;\n        const blendNode = renderTree[renderable.transparent ? 'transparent' : 'opaque'];\n        const programNode = blendNode[renderable.skinning ? 'skinmesh' : 'static'];\n        const renderableKey = JSON.stringify(renderable);\n        if (!programNode[renderableKey]) {\n          programNode[renderableKey] = { entities: [], renderable };\n        }\n        programNode[renderableKey].entities.push(entityCell);\n      }\n      return renderTree;\n    });\n\n  run(state: GpuWorldState) {\n    // this.gls.cullFace(gl.BACK);\n    this.gls.enable(GL.DEPTH_TEST);\n    this.gls.depthFunc(GL.LEQUAL);\n    this.gls.disable(GL.POLYGON_OFFSET_FILL);\n    this.gls.polygonOffset(0.0, 0.0);\n    const renderTree = this.query.get(state);\n    for (const blendKey of Object.keys(renderTree)) {\n      if (blendKey === 'opaque') {\n        this.gls.disable(GL.BLEND);\n      } else {\n        this.gls.enable(GL.BLEND);\n        this.gls.blendFuncSeparate(GL.SRC_ALPHA, GL.ONE_MINUS_SRC_ALPHA, GL.ONE, GL.ONE_MINUS_SRC_ALPHA); // https://limnu.com/webgl-blending-youre-probably-wrong/\n      }\n      const blendNode = renderTree[blendKey];\n      for (const programKey of Object.keys(blendNode)) {\n        // This must be called before we start setting up for this draw call, because\n        // getting the values may involve renderings and state changes\n        const program = this.programs[programKey];\n        program.vertexShader.updateUniformValues(state);\n        program.fragmentShader.updateUniformValues(state);\n        program.program.prepare();\n        program.vertexShader.writeUniforms(program.program);\n        program.fragmentShader.writeUniforms(program.program);\n        const programNode = blendNode[programKey];\n        for (const groupKey of Object.keys(programNode)) {\n          const group = programNode[groupKey];\n          if (group.renderable.cullFace === CullFace.None) {\n            this.gls.disable(GL.CULL_FACE);\n          } else {\n            this.gls.enable(GL.CULL_FACE);\n            this.gls.cullFace(group.renderable.cullFace);\n          }\n          const mesh = this.gls.getMesh(group.renderable.mesh);\n          if (!mesh) {\n            throw new Error(`No such mesh: ${group.renderable.mesh}`);\n          }\n          for (const { l, count } of createBatches(group.entities.length, this.maxInstanceCount)) {\n            program.program.setUniform('entityCells', 'ivec2[]', group.entities.slice(l, l + count));\n            this.gls.draw(program.program, mesh, count);\n          }\n        }\n      }\n    }\n  }\n}\n","import { glslFloat, glslVec2 } from \"../../GpuUtil\";\nimport { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { Vector2 } from \"../../Math/Vector2\";\nimport { Position } from \"../ECS/Transform\";\nimport { Hitpoints, Mana, Team, MaxHitpoints, MaxMana, HitpointsTrailing } from \"../ECS/UnitComponents\";\nimport { GpuWorldState } from \"../State\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { shaderModule, funcDef, outDef, uniformDef, inDef, ShaderModule, constDef, FunctionDef } from \"../../GpuUtil/ShaderModule\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { Teams } from \"../StateLayout\";\nimport { MatrixSM } from \"../../GpuUtil/SM2Utils\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nclass PixlingOverheadBarBaseRenderer {\n  constructor(private gls: GlState, private conf: {\n    offsetY: number,\n    size: Vector2,\n    padding: Vector2,\n    barColor: ShaderModule<{ getBarColor: FunctionDef<'vec4', [['ivec2', 'entityCell'], ['float', 'p']]> }>\n  }) {}\n\n  maxInstanceCount = 128;\n  query = new EntitiesQuery([Hitpoints.component, Mana.component])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'quad',\n      vertexShader: shaderModule([Vertex, Hitpoints.sm, MatrixSM, Position.sm], {\n        size: constDef('vec2', glslVec2(this.conf.size)),\n        offsetY: constDef('float', glslFloat(this.conf.offsetY)),\n\n        view: uniformDef('mat4', d => d.derived.cameraView),\n        projection: uniformDef('mat4', d => d.derived.cameraProjection),\n\n        texcoord: outDef('vec2'),\n        barEntityCell: outDef('ivec2', true),\n\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          if (${Hitpoints.sm.value}(entityCell) <= 0.0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          barEntityCell = entityCell;\n          vec3 translation = ${Position.sm.value}(entityCell) + vec3(0, 0, 3.5);\n          mat4 modelView = ${MatrixSM.toBillboard}(view * ${MatrixSM.translate}(translation));\n          gl_Position = projection * modelView * ${MatrixSM.translateScale}(vec3(0, offsetY, 0),\n            vec3(size, 1)) * vec4(${Vertex.position}.xy * 0.1, 0, 1);\n          texcoord = (${Vertex.position}.xy + 1.0) / 2.0;\n        `)\n      }),\n      fragmentShader: shaderModule([this.conf.barColor], {\n        outColor: outDef('vec4'),\n        padding: constDef('vec2', glslVec2(this.conf.padding)),\n        texcoord: inDef('vec2'),\n        barEntityCell: inDef('ivec2', true),\n        main: funcDef('void', [], `\n          outColor = vec4(0.1, 0.1, 0.1, 0.8);\n          vec2 paddedTc = (texcoord - padding) / (1. - padding * 2.);\n          if (paddedTc.x > 0. && paddedTc.y > 0. && paddedTc.x <= 1. && paddedTc.y <= 1.) {\n            vec4 bar = ${this.conf.barColor.getBarColor}(barEntityCell, paddedTc.x);\n            outColor.rgb = mix(outColor.rgb, bar.rgb, bar.a);\n            outColor.a = max(bar.a, outColor.a);\n          }\n        `)\n      })\n    });\n  render(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nexport class OverheadBarsRenderer {\n  constructor(private gls: GlState) {}\n\n  health = new PixlingOverheadBarBaseRenderer(this.gls, {\n    offsetY: 0.3,\n    size: { x: 10, y: 3 },\n    padding: { x: 0.02, y: 0.1 },\n    barColor: shaderModule([Hitpoints.sm, Team.sm, HitpointsTrailing.sm], {\n      homeHealthColor: uniformDef('vec3', d => d.data.homeHealthColor),\n      awayHealthColor: uniformDef('vec3', d => d.data.awayHealthColor),\n      getBarColor: funcDef('vec4', [['ivec2', 'entityCell'], ['float', 'p']], `\n        float perc = ${Hitpoints.sm.value}(entityCell) / ${glslFloat(MaxHitpoints)};\n        float trailingPerc = ${HitpointsTrailing.sm.value}(entityCell) / ${glslFloat(MaxHitpoints)};\n        if (p < perc) {\n          vec3 col = ${Team.sm.value}(entityCell) == ${Teams.HomeTeam} ? homeHealthColor : awayHealthColor;\n          if (p > trailingPerc) {\n            col = vec3(24, 237, 194)/255.;\n          }\n          return vec4(col, 1);\n        } else {\n          if (p < trailingPerc) {\n            return vec4(252, 223, 3, 255)/255.;\n          } else {\n            return vec4(0);\n          }\n        }\n      `)\n    })\n  });\n  mana = new PixlingOverheadBarBaseRenderer(this.gls, {\n    offsetY: 0,\n    size: { x: 10, y: 1 },\n    padding: { x: 0.02, y: 0.2 },\n    barColor: shaderModule([Mana.sm], {\n      manaColor: uniformDef('vec3', d => d.data.manaColor),\n      getBarColor: funcDef('vec4', [['ivec2', 'entityCell'], ['float', 'p']], `\n        float perc = ${Mana.sm.value}(entityCell) / ${glslFloat(MaxMana)};\n        if (p < perc) {\n          return vec4(manaColor, 1);\n        } else {\n          return vec4(0);\n        }\n      `)\n    })\n  });\n  // casting = new PixlingOverheadBarBaseRenderer(this.common, CastingAbility.castingProgress);\n\n  // Debug:\n  // brainOutputs = BrainOutputsKeys.map(key =>\n  //   new PixlingOverheadBarBaseRenderer(this.gls, BrainOutput[`out${key}`], PixlingOverheadBarBaseRenderer.Calcs.manaColor));\n\n  run(state: GpuWorldState) {\n    if (!state.data.rendererConfig.overheadBars || state.appState?.state.hideUI) {\n      return;\n    }\n    this.gls.disable(GL.DEPTH_TEST);\n    this.gls.disable(GL.CULL_FACE)\n    // this.mana.render(state);\n    this.health.render(state);\n    // this.casting.render(rinputs, 0.2, rgbFromHex(CastingColor), rinputs.state.derived.renderPixlingsCount);\n    // for (let i=0; i < this.brainOutputs.length; i++) {\n    //   this.brainOutputs[i].render(state, 0.9 + i / 4, { x: 10, y: 1 }, { x: 0.02, y: 0.2 });\n    // }\n  }\n}","import { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { Vector2SM } from \"../../GpuUtil/SM2Utils\";\n\n\nexport const LightSM2 = shaderModule([], {\n  lightDirection: uniformDef('vec3', d => d.derived.renderLightDirection),\n  light: funcDef('float', [['vec3', 'normal']], `\n    return dot(normal, Self.lightDirection) > 0.0 ? 1.0 : 0.0;\n  `)\n});\n\nexport const FogGLSL = `\nfloat fogFactorExp2(\n  const float dist,\n  const float density\n) {\n  const float LOG2 = -1.442695;\n  float d = density * dist;\n  return 1.0 - clamp(exp2(d * d * LOG2), 0.0, 1.0);\n}\nfloat fogAmount(float fogDensity) {\n  return fogFactorExp2(gl_FragCoord.z / gl_FragCoord.w, fogDensity);\n}\n`\nexport const FogSM2 = shaderModule([], {\n  fogFactorExp2: funcDef('float', [['float', 'dist'], ['float', 'density']], `\n    const float LOG2 = -1.442695;\n    float d = density * dist;\n    return 1.0 - clamp(exp2(d * d * LOG2), 0.0, 1.0);\n  `)\n})\n\nexport const GrayscaleGLSL = `\nvec3 grayscale(vec3 color) {\n  return vec3(dot(color.rgb, vec3(0.299, 0.587, 0.114)));\n}\n`\n\nexport const QuadLineSM = shaderModule('QuadLine', [Vertex, Vector2SM], {\n  vertexPosition01: funcDef('vec2', [], `\n    return (${Vertex.position}.xy + 1.0) / 2.0;\n  `),\n  fromPoints: funcDef('vec3', [['vec3', 'backLeft'], ['vec3', 'backRight'], ['vec3', 'frontLeft'], ['vec3', 'frontRight']], `\n    return mix(\n      mix(backLeft, backRight, Self.vertexPosition01().y),\n      mix(frontLeft, frontRight, Self.vertexPosition01().y),\n      Self.vertexPosition01().x\n    );\n  `),\n  fromLineWithDeltas: funcDef('vec3', [['vec3', 'start'], ['vec3', 'startDelta'], ['vec3', 'end'], ['vec3', 'endDelta']], `\n    return Self.fromPoints(\n      start - startDelta,\n      start + startDelta,\n      end - endDelta,\n      end + endDelta\n    );\n  `),\n  fromLineWithDelta: funcDef('vec3', [['vec3', 'start'], ['vec3', 'end'], ['vec3', 'delta']], `\n    return Self.fromLineWithDeltas(\n      start,\n      delta,\n      end,\n      delta\n    );\n  `),\n  fromLineWithWidths: funcDef('vec3', [['vec3', 'start'], ['float', 'startWidth'], ['vec3', 'end'], ['float', 'endWidth']], `\n    vec2 v = ${Vector2SM.perpendicular}(normalize((end - start).xy));\n    return Self.fromLineWithDeltas(\n      start,\n      vec3(v * startWidth / 2.0, 0),\n      end,\n      vec3(v * endWidth / 2.0, 0)\n    );\n  `),\n  fromLineWithWidth: funcDef('vec3', [['vec3', 'start'], ['vec3', 'end'], ['float', 'width']], `\n    return Self.fromLineWithWidths(\n      start,\n      width,\n      end,\n      width\n    );\n  `),\n});\n\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { Focuser } from \"../ECS/UnitComponents\";\nimport { TransformHelpers } from \"../ECS/Transform\";\nimport { QuadLineSM } from \"./Util\";\nimport { GpuWorldState } from \"../State\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { shaderModule, uniformDef, funcDef, outDef } from \"../../GpuUtil/ShaderModule\";\nimport { BackAttachment, HeadAttachment } from \"../ECS/UnitComponents\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nexport class GazeRenderer {\n  constructor(private gls: GlState) {}\n\n  query = new EntitiesQuery([Focuser.component])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'quad',\n      vertexShader: shaderModule([QuadLineSM, Focuser.sm, TransformHelpers,\n        HeadAttachment.sm, BackAttachment.sm, HeadAttachment.hasComponentSM, BackAttachment.hasComponentSM], {\n        viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          ivec2 focus = ${Focuser.sm.value}(entityCell);\n          if (focus.x < 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          ivec2 head = ${HeadAttachment.hasComponentSM.value}(entityCell) ? ${HeadAttachment.sm.value}(entityCell) : entityCell;\n          ivec2 back = ${BackAttachment.hasComponentSM.value}(focus) ? ${BackAttachment.sm.value}(focus) : focus;\n          vec3 position = ${QuadLineSM.fromLineWithWidths}(\n            ${TransformHelpers.worldPosition}(head),\n            0.2,\n            ${TransformHelpers.worldPosition}(back),\n            0.0\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        main: funcDef('void', [], `\n          outColor = vec4(1);\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    if (state.data.renderGazes) {\n      this.query.run(state);\n    }\n  }\n}\n","import * as THREE from \"three\";\n\nexport interface AnimationTrack {\n  type: 'vec3' | 'quat';\n  targetName?: string;\n  componentName: string;\n  times: number[];\n  values: number[];\n}\n\nexport function stride(track: AnimationTrack) {\n  return track.type === 'vec3' ? 3 : 4;\n}\nexport function keyframeValue(track: AnimationTrack, index: number): number[] {\n  return track.values.slice(index * stride(track), (index + 1) * stride(track));\n}\nexport function keyframeTime(track: AnimationTrack, index: number): number {\n  return track.times[index];\n}\nexport function insertKeyframe(track: AnimationTrack, index: number, time: number, value: number[] | Float32Array) {\n  if (value.length !== stride(track)) {\n    throw new Error(`Invalid value length: ${value.length}. Must be ${stride(track)}`);\n  }\n  return {\n    ...track,\n    times: [...track.times.slice(0, index), time, ...track.times.slice(index)],\n    values: [...track.values.slice(0, index * stride(track)), ...value, ...track.values.slice(index * stride(track))]\n  };\n}\nexport function insertKeyframeAtTime(track: AnimationTrack, time: number, value: number[] | Float32Array) {\n  let index = 0;\n  while (index < track.times.length && track.times[index] < time) {\n    index++;\n  }\n  return insertKeyframe(track, index, time, value);\n}\nexport function moveKeyframe(track: AnimationTrack, index: number, newTime: number) {\n  return insertKeyframeAtTime(deleteKeyframe(track, index), newTime, keyframeValue(track, index));\n}\nexport function copyKeyframe(track: AnimationTrack, index: number, newTime: number) {\n  return insertKeyframeAtTime(track, newTime, keyframeValue(track, index));\n}\nexport function deleteKeyframe(track: AnimationTrack, index: number) {\n  return {\n    ...track,\n    times: [...track.times.slice(0, index), ...track.times.slice(index + 1)],\n    values: [...track.values.slice(0, index * stride(track)), ...track.values.slice((index + 1) * stride(track))]\n  };\n}\n\nexport class AnimationTrackInterpolator {\n  constructor(public track: AnimationTrack) {\n  }\n  private results = new Float32Array(stride(this.track));\n  private interpolant = this.track.type === 'vec3' ?\n    new THREE.LinearInterpolant(new Float32Array(this.track.times), new Float32Array(this.track.values), stride(this.track), this.results)\n    : new THREE.QuaternionLinearInterpolant(new Float32Array(this.track.times), new Float32Array(this.track.values), stride(this.track), this.results);\n  value(time: number): number[] {\n    return this.interpolant!.evaluate(time);\n  }\n}\n","import { EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { GpuWorldState } from \"../State\";\nimport * as THREE from 'three';\nimport { EntityRef } from \"../StateData\";\nimport { PixlingTimespan } from \"../../Time\";\nimport { VisibleComponent } from \"./Components\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { mod } from \"../../Math/Math\";\nimport { Position, Quaternion, Scale } from \"./Transform\";\nimport { AnimationTrack, AnimationTrackInterpolator } from \"./AnimationTrack\";\nimport { visibleCacheKeys } from \"./Visibility\";\n\nexport interface AnimationAction {\n  clip: string;\n  positionType: 'time' | 'startTime' | 'percentage';\n  positionValue: number;\n  looping?: boolean;\n  weight?: number;\n}\ninterface AnimationControllerProps {\n  actions: AnimationAction[];\n}\nexport const AnimationControllerComponent = EntityComponentSystem.registerComponent<AnimationControllerProps>({\n  name: 'AnimationController',\n  type: 'obj'\n});\n\ninterface AnimationBinderProps {\n  entityLookup: {\n    [name: string]: EntityRef\n  },\n  clipNames: {\n    [name: string]: string;\n  }\n}\nexport const AnimationBinderComponent = EntityComponentSystem.registerComponent<AnimationBinderProps>({\n  name: 'AnimationBinder',\n  type: 'obj'\n});\n\nfunction mixTracks(type: AnimationTrack['type'], a: number[], b: number[], p: number) {\n  if (type === 'vec3') {\n    a[0] = a[0] * (1 - p) + b[0] * p;\n    a[1] = a[1] * (1 - p) + b[1] * p;\n    a[2] = a[2] * (1 - p) + b[2] * p;\n  } else {\n    THREE.Quaternion.slerpFlat(a, 0, a, 0, b, 0, p);\n  }\n}\n\nexport interface AnimationClip {\n  duration?: number;\n  tracks: AnimationTrack[];\n}\n\nexport function animationClipFromThree(clip: THREE.AnimationClip): AnimationClip {\n  return {\n    duration: clip.duration,\n    tracks: clip.tracks.map(animationTrackFromThree)\n  }\n}\nexport function animationTrackFromThree(track: THREE.KeyframeTrack): AnimationTrack {\n  const [name, property] = track.name.split('.');\n  if (track instanceof THREE.VectorKeyframeTrack) {\n    let component;\n    if (property === 'position') {\n      component = Position.cpuComponent;\n    } else if (property === 'scale') {\n      component = Scale.cpuComponent;\n    } else {\n      throw new Error(`Unsupported property: ${property}`);\n    }\n    return {\n      type: 'vec3',\n      targetName: name,\n      componentName: component.name,\n      times: Array.from(track.times),\n      values: Array.from(track.values),\n    }\n  } else {\n    let component;\n    if (property === 'quaternion') {\n      component = Quaternion.cpuComponent;\n    } else {\n      throw new Error(`Unsupported property: ${property}`);\n    }\n    return {\n      type: 'quat',\n      targetName: name,\n      componentName: component.name,\n      times: Array.from(track.times),\n      values: Array.from(track.values),\n    }\n  }\n}\n\nfunction getAnimationInterpolator(state: GpuWorldState, clipName: string, trackIndex: number, track: AnimationTrack) {\n  const key = clipName + '_' + trackIndex;\n  const interpolator = state.animationInterpolators[key];\n  if (interpolator && interpolator.track === track) {\n    return interpolator;\n  } else {\n    return state.animationInterpolators[key] = new AnimationTrackInterpolator(track);\n  }\n}\n\nexport class UpdateAnimations {\n  query = new EntitiesQuery([AnimationControllerComponent, VisibleComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys);\n  run(state: GpuWorldState) {\n    const currentTime = new PixlingTimespan(state.data.stepCounter + state.data.substep).timeInSecondsFractional;\n    for (const entityCell of this.query.get(state)) {\n      const controller = state.ecs.getComponentData(AnimationControllerComponent, entityCell)!;\n      const binder = state.ecs.getComponentData(AnimationBinderComponent, entityCell);\n      // Calc\n      const outputs: { [key: string]: { track: AnimationTrack, value: number[], weight: number } } = {};\n      for (const action of controller.actions) {\n        const clipName = binder ? binder.clipNames[action.clip] : action.clip;\n        const clip = state.data.animationClips[clipName];\n        if (!clip) {\n          // console.warn(`No such animation: ${action.clip} (${clipName})`);\n          continue;\n        }\n        let animTime: number;\n        if (action.positionType === 'startTime') {\n          animTime = currentTime - action.positionValue;\n        } else if (action.positionType === 'percentage') {\n          if (clip.duration === undefined) {\n            throw new Error(`'percentage' positionType requires clip.duration to be defined. Clip name=${clipName}`);\n          }\n          animTime = action.positionValue * clip.duration;\n        } else {\n          animTime = action.positionValue;\n        }\n        if (action.looping) {\n          if (clip.duration === undefined) {\n            throw new Error(`Looping clip requires clip.duration to be defined. Clip name=${clipName}`);\n          }\n          animTime = mod(animTime, clip.duration);\n        }\n        for (let i=0; i < clip.tracks.length; i++) {\n          const track = clip.tracks[i];\n          const interpolator = getAnimationInterpolator(state, clipName, i, track);\n          const value = interpolator.value(animTime);\n          const key = track.targetName + track.componentName;\n          const o = outputs[key];\n          const weight = action.weight ?? 1;\n          if (weight === 0) {\n            continue;\n          }\n          if (!o) {\n            outputs[key] = {\n              track,\n              value,\n              weight\n            }\n          } else {\n            o.weight += weight;\n            const mix = weight / o.weight;\n            mixTracks(track.type, o.value, value, mix);\n          }\n        }\n      }\n      // Apply\n      for (const key of Object.keys(outputs)) {\n        const output = outputs[key];\n        const ec = (binder && output.track.targetName) ? binder.entityLookup[output.track.targetName] : entityCell;\n        const comp = state.ecs.getComponentByName(output.track.componentName);\n        if (!comp) {\n          throw new Error(`[UpdateAnimation] No such component: ${output.track.componentName}`);\n        } else if (comp.type !== 'cpu') {\n          throw new Error(`[UpdateAnimation] Not a cpu component: ${output.track.componentName}`);\n        }\n        const compData = state.ecs.getCpuComponentDataView(comp, ec);\n        if (!compData) {\n          throw new Error(`[UpdateAnimation] No data for component: ${output.track.componentName}`);\n        }\n        for (let i=0; i < output.value.length; i++) {\n          compData[i] = output.value[i];\n        }\n      }\n    }\n  }\n}","\n\n\nimport { GpuWorldState } from \"../State\";\nimport { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { shaderModule, funcDef, inDef, outDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { LocalToWorld } from \"../ECS/Transform\";\nimport { CullFace } from \"../Renderer/ModelRenderer\";\nimport { MatrixSM } from \"../../GpuUtil/SM2Utils\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { UnitBuffer, Velocity } from \"../ECS/UnitComponents\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nexport const IronBubbable = new GpuComponentModule<'float'>('IronBubbable', UnitBuffer.buffer, 'int');\nexport const HeliumBubbable = new GpuComponentModule<'float'>('HeliumBubbable', UnitBuffer.buffer, 'int');\n\nexport class UpdateIronBubbable {\n  constructor(private gls: GlState) {}\n\n  private update = new ArchetypesQuery([IronBubbable.component])\n    .mapGpu(this.gls, IronBubbable.component, shaderModule([], {\n      map: funcDef('int', [['ivec2', 'entityCell'], ['int', 'value']], `\n        return max(0, value - 1);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\nexport class UpdateHeliumBubbable {\n  constructor(private gls: GlState) {}\n\n  private update = new ArchetypesQuery([HeliumBubbable.component])\n    .mapGpu(this.gls, HeliumBubbable.component, shaderModule([], {\n      map: funcDef('int', [['ivec2', 'entityCell'], ['int', 'value']], `\n        return max(0, value - 1);\n      `)\n    }));\n  private velocity = new ArchetypesQuery([HeliumBubbable.component, Velocity.component])\n    .mapGpu(this.gls, Velocity.component, shaderModule([HeliumBubbable.sm], {\n      map: funcDef('vec3', [['ivec2', 'entityCell'], ['vec3', 'value']], `\n        if (${HeliumBubbable.sm.value}(entityCell) > 0) {\n          return vec3(0, 0, 1.0);\n        } else {\n          return value;\n        }\n      `)\n    }))\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n    this.velocity.run(state);\n  }\n}\n\nexport const BubbleShader = {\n  vertex: shaderModule([Vertex], {\n    viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n    normal: outDef('vec3'),\n    update: funcDef('void', [['mat4', 'worldTransform']], `\n      mat4 invTranspWorldTransform = transpose(inverse(worldTransform));\n      normal = normalize((invTranspWorldTransform * vec4(${Vertex.normal}, 1)).xyz);\n      normal = (viewProjection * vec4(normal, 0)).xyz;\n\n      gl_Position = viewProjection * worldTransform * vec4(${Vertex.position}, 1);\n    `)\n  }),\n}\n\nclass BubbleRenderer {\n  constructor(private gls: GlState, private buff: GpuComponentModule<'float'>, private color: string) {}\n\n  private query = new EntitiesQuery([this.buff.component])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'sphere',\n      vertexShader: shaderModule([LocalToWorld.sm, MatrixSM, this.buff.sm, BubbleShader.vertex], {\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          if (${this.buff.sm.value}(entityCell) <= 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n\n          mat4 worldTransform = ${MatrixSM.translate}(vec3(0, 0, 1)) *\n            ${LocalToWorld.sm.value}(entityCell) *\n            ${MatrixSM.scale}(vec3(1.5));\n\n          ${BubbleShader.vertex.update}(worldTransform);\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        normal: inDef('vec3'),\n        main: funcDef('void', [], `\n          if (normal.z < -0.3) {\n            discard;\n          }\n          outColor = vec4(${this.color}, 1);\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    this.gls.enable(GL.CULL_FACE);\n    this.gls.cullFace(CullFace.Back);\n    this.query.run(state);\n  }\n}\n\nexport const IronBubbleColor = `vec3(0.5)`;\nexport const HeliumBubbleColor = `vec3(1.0, 0.75, 1.0)`;\n\nexport class BubblesRenderer {\n  constructor(private gls: GlState) {}\n\n  bubbles = [\n    new BubbleRenderer(this.gls, IronBubbable, IronBubbleColor),\n    new BubbleRenderer(this.gls, HeliumBubbable, HeliumBubbleColor),\n  ]\n\n  run(state: GpuWorldState) {\n    for (const b of this.bubbles) {\n      b.run(state);\n    }\n  }\n}\n","\n\n\nimport { GpuWorldState } from \"../State\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { UnitBuffer } from \"../ECS/UnitComponents\";\nimport { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef, outDef, inDef } from \"../../GpuUtil/ShaderModule\";\nimport { loadImage } from \"../../GpuUtil\";\nimport { Texture } from \"../../GpuUtil/Texture\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { TransformHelpers } from \"../ECS/Transform\";\nimport { HeadAttachment } from \"../ECS/UnitComponents\";\nimport { MatrixSM } from \"../../GpuUtil/SM2Utils\";\nimport BuffsPng from '../../Images/Buffs.png';\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nexport const Dazeable = new GpuComponentModule('Dazeable', UnitBuffer, 'int');\n\nexport class UpdateDazeBuff {\n  constructor(private gls: GlState) {}\n\n  dazed = new ArchetypesQuery([Dazeable.component])\n    .mapGpu(this.gls, Dazeable.component, shaderModule([], {\n      map: funcDef('int', [['ivec2', 'entityCell'], ['int', 'value']], `\n        return max(0, value - 1);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.dazed.run(state);\n  }\n}\n\nconst BuffsImage = loadImage(BuffsPng);\n\nexport class DazeableRenderer {\n  constructor(private gls: GlState) {\n    BuffsImage.then(img => gls.textures['buffs'] = Texture.fromImage(gls, img));\n  }\n\n  maxInstanceCount = 128;\n\n  query = new EntitiesQuery([Dazeable.component])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'quad',\n      vertexShader: shaderModule([Vertex, TransformHelpers, HeadAttachment.sm, MatrixSM, Dazeable.sm], {\n        projection: uniformDef('mat4', d => d.derived.cameraProjection),\n        view: uniformDef('mat4', d => d.derived.cameraView),\n        texcoord: outDef('vec2'),\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          if (${Dazeable.sm.value}(entityCell) <= 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          vec3 translation = ${TransformHelpers.worldPosition}(${HeadAttachment.sm.value}(entityCell)) + vec3(0, 0, 0.5);\n          mat4 transform = ${MatrixSM.toBillboard}(view * ${MatrixSM.translate}(translation)) * ${MatrixSM.scale}(vec3(0.2));\n          gl_Position = projection * transform * vec4(${Vertex.position}, 1);\n          texcoord = (${Vertex.position}.xy + 1.0) / 2.0;\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        tex: uniformDef('sampler2D', d => d.gls.textures.buffs),\n        texcoord: inDef('vec2'),\n        main: funcDef('void', [], `\n          outColor = texture(tex, texcoord);\n          if (outColor.a < 2.0/255.0) {\n            discard;\n          }\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n","export default \"data:image/png;base64,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\"","import { EntityComponentSystem, EntityInit } from \"../../GpuUtil/ECS\";\nimport { GpuWorldState } from \"../State\";\nimport { LocalToWorld, Position, Quaternion, Scale, InvLocalToWorld } from \"./Transform\";\nimport { quat, mat4 } from \"gl-matrix\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { AnimationControllerComponent } from \"./Animation\";\nimport { VisibleComponent } from \"./Components\";\n\nexport const Camera = {\n  Fovy: EntityComponentSystem.registerComponent({\n    name: 'CameraFovy',\n    type: 'cpu',\n    format: 'float',\n  }),\n  Near: EntityComponentSystem.registerComponent({\n    name: 'CameraNear',\n    type: 'cpu',\n    format: 'float',\n  }),\n  Far: EntityComponentSystem.registerComponent({\n    name: 'CameraFar',\n    type: 'cpu',\n    format: 'float',\n  }),\n  Projection: EntityComponentSystem.registerComponent({\n    name: 'CameraProjection',\n    type: 'cpu',\n    format: 'mat4',\n  }),\n  ProjectionView: EntityComponentSystem.registerComponent({\n    name: 'CameraProjectionView',\n    type: 'cpu',\n    format: 'mat4',\n  }),\n  InvProjectionView: EntityComponentSystem.registerComponent({\n    name: 'CameraInvProjectionView',\n    type: 'cpu',\n    format: 'mat4',\n  }),\n}\n\nexport function createCamera(state: GpuWorldState) {\n  return state.ecs.createEntities(new EntityInit()\n    .setComponent(Position.cpuComponent)\n    .setComponent(Quaternion.cpuComponent, new Float32Array(quat.identity(quat.create())))\n    .setComponent(Scale.cpuComponent, new Float32Array([1, 1, 1]))\n    .setComponent(LocalToWorld.cpuComponent)\n    .setComponent(InvLocalToWorld.cpuComponent)\n    .setComponent(Camera.Fovy, new Float32Array([(70 / 360) * Math.PI * 2]))\n    .setComponent(Camera.Near, new Float32Array([0.1]))\n    .setComponent(Camera.Far, new Float32Array([850]))\n    .setComponent(Camera.Projection)\n    .setComponent(Camera.ProjectionView)\n    .setComponent(Camera.InvProjectionView)\n    .setComponent(AnimationControllerComponent, { actions: [] })\n    .setComponent(VisibleComponent, true)\n  ).getIndex(0);\n}\n\nexport class UpdateCameraMatrices {\n  query = new EntitiesQuery([Camera.Projection]);\n  run(state: GpuWorldState) {\n    for (const entityCell of this.query.get(state)) {\n      const projection = state.ecs.getCpuComponentDataView(Camera.Projection, entityCell);\n      const fovy = state.ecs.getComponentData(Camera.Fovy, entityCell);\n      const near = state.ecs.getComponentData(Camera.Near, entityCell);\n      const far = state.ecs.getComponentData(Camera.Far, entityCell);\n      const aspect = state.data.canvasRect.width / state.data.canvasRect.height;\n      if (projection) {\n        mat4.perspective(projection, fovy[0], aspect, near[0], far[0]);\n        const view = state.ecs.getCpuComponentDataView(InvLocalToWorld.cpuComponent, entityCell);\n        const projectionView = state.ecs.getCpuComponentDataView(Camera.ProjectionView, entityCell);\n        if (projectionView && view) {\n          mat4.mul(projectionView, projection, view);\n\n          const invProjectionView = state.ecs.getCpuComponentDataView(Camera.InvProjectionView, entityCell);\n          if (invProjectionView) {\n            mat4.invert(invProjectionView, projectionView);\n          }\n        }\n      }\n    }\n  }\n}\n","import { GpuWorldState } from \"../GpuWorld/State\";\nimport { EntityInit, EntitiesRange } from \"./ECS\";\nimport { BoneMatrix, TransformParent, LocalToParent, LocalToParentOrderComponents, BoneOffset, LocalToWorld, Position, Quaternion, Scale } from \"../GpuWorld/ECS/Transform\";\nimport { RenderableComponent, CullFace, MaterialColor, SkinmeshBones, MaxBones, SkinmeshBindMatrix, MaterialUseLighting } from \"../GpuWorld/Renderer/ModelRenderer\";\nimport { GLTFLoader, GLTF } from 'three/examples/jsm/loaders/GLTFLoader';\nimport * as THREE from 'three';\nimport * as Mat4 from '../Math/Mat4';\nimport * as Vector3 from '../Math/Vector3';\nimport * as Vector4 from '../Math/Vector4';\nimport { MeshLoaders } from \"./GlState\";\nimport { Mesh } from \"./Mesh\";\nimport { animationClipFromThree, AnimationControllerComponent, AnimationBinderComponent, AnimationClip } from \"../GpuWorld/ECS/Animation\";\nimport { EntityRef } from \"../GpuWorld/StateData\";\nimport { NameComponent } from \"../GpuWorld/ECS/Components\";\nimport { VisibleComponent, VisibilityFromComponent } from \"../GpuWorld/ECS/Components\";\nimport { full } from \"db\";\nimport { LookatCamera } from \"./Camera\";\nimport { Camera, createCamera } from \"../GpuWorld/ECS/Camera\";\n\nTHREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1);\n\ninterface CreateModelInstanceOptions {\n  count?: number;\n  rootEntities?: EntitiesRange;\n  rootEntityInit?: EntityInit;\n  beforeEntityCreated?: (object: THREE.Object3D, entityInit: EntityInit) => EntityInit | undefined;\n  afterEntityCreated?: (object: THREE.Object3D, entityCell: EntitiesRange) => void;\n  onMaterial?: (material: THREE.MeshStandardMaterial, entityIndex: number) => Vector4.Vector4 | undefined;\n  localToParentStartOrder?: number;\n  visible?: boolean;\n}\n\nexport class ThreeModel {\n  constructor(public name: string, private model: GLTF) {\n    model.scene.updateMatrixWorld();\n    console.log('Model loaded', name, model);\n    for (const clip of model.animations) {\n      const globalName = name + '/' + clip.name;\n      this.clipNames[clip.name] = globalName;\n      this.animationClips[globalName] = animationClipFromThree(clip);\n    }\n    model.scene.traverse(obj => {\n      if (obj.type === 'Mesh' || obj.type === 'SkinnedMesh') {\n        const o = obj as THREE.Mesh;\n        const geom = o.geometry;\n        if (geom instanceof THREE.BufferGeometry) {\n          MeshLoaders[o.geometry.id] = gls => Mesh.fromThree(gls, geom);\n        }\n      }\n    })\n  }\n  animationClips: {\n    [key: string]: AnimationClip\n  } = {};\n  static fromPath(path: string) {\n    return new Promise<ThreeModel>(resolve => {\n      const loader = new GLTFLoader();\n      loader.load(path, gltf => {\n        resolve(new ThreeModel(path, gltf));\n      });\n    });\n  }\n  private clipNames: { [name: string]: string } = {};\n\n  createInstances(state: GpuWorldState, opts: CreateModelInstanceOptions = {}) {\n    const roots = opts.rootEntities ?? state.ecs.createEntities((opts.rootEntityInit ?? new EntityInit())\n      .setComponent(LocalToWorld.gpuComponent)\n      .setComponent(AnimationBinderComponent, { entityLookup: {}, clipNames: {} })\n      .setComponent(AnimationControllerComponent, {\n        actions: []\n      })\n      .setComponent(VisibleComponent, false),\n      opts.count ?? 1\n    )\n    const entityLookup: { [key: string]: EntitiesRange } = {};\n    const skinMeshes: Array<[THREE.SkinnedMesh, EntitiesRange]> = [];\n    for (const c of this.model.scene.children) {\n      this.createRecursive(state, c, roots, roots, entityLookup, skinMeshes, (opts.localToParentStartOrder ?? 0) + 1, opts);\n    }\n    for (const [o, entities] of skinMeshes) {\n      for (let i=0; i < (opts.count ?? 1); i++) {\n        const boneEntityCells = o.skeleton.bones.map(bone => entityLookup[bone.name].getIndex(i));\n        const boneCount = Math.min(MaxBones, boneEntityCells.length);\n        const bones = new Float32Array(boneCount * 4);\n        for (let i=0; i < boneCount; i++) {\n          bones[i * 4 + 0] = boneEntityCells[i].x;\n          bones[i * 4 + 1] = boneEntityCells[i].y;\n        }\n        state.ecs.setComponentData(SkinmeshBones.component, entities.getIndex(i), bones);\n      }\n    }\n    for (let i=0; i < (opts.count ?? 1); i++) {\n      const lookup = {};\n      for (const key of Object.keys(entityLookup)) {\n        lookup[key] = entityLookup[key].getIndex(i);\n      }\n      state.ecs.setComponentData(AnimationBinderComponent, roots.getIndex(i), {\n        entityLookup: lookup,\n        clipNames: this.clipNames\n      });\n    }\n    state.ecs.setComponentData(VisibleComponent, roots, opts.visible ?? true);\n    for (const clip of Object.keys(this.animationClips)) {\n      state.data.animationClips[clip] = this.animationClips[clip];\n    }\n    return { roots, entities: Object.keys(entityLookup).map(k => entityLookup[k]) };\n  }\n  private createRecursive(state: GpuWorldState, object: THREE.Object3D,\n    rootEntities: EntitiesRange,\n    parentEntities: EntitiesRange, entityLookup: { [name: string]: EntitiesRange },\n    skinMeshes: Array<[THREE.SkinnedMesh, EntitiesRange]>,\n    order: number, opts: CreateModelInstanceOptions) {\n    let entityInit: EntityInit | undefined = new EntityInit()\n      .setComponent(LocalToParent.component, Mat4.toRows(Mat4.fromArray(object.matrix.elements)))\n      .setComponent(TransformParent.component)\n      .setComponent(LocalToParentOrderComponents[order])\n      .setComponent(LocalToWorld.gpuComponent, Mat4.toRows(Mat4.fromArray(object.matrixWorld.elements)))\n      .setComponents(Position.components, new Float32Array([object.position.x, object.position.y, object.position.z, 0]))\n      .setComponents(Quaternion.components, new Float32Array([object.quaternion.x, object.quaternion.y, object.quaternion.z, object.quaternion.w]))\n      .setComponents(Scale.components, new Float32Array([object.scale.x, object.scale.y, object.scale.z, 0]))\n      .setComponent(NameComponent, { value: object.name });\n    if (object.type === 'Object3D' || object.type === 'Group') {\n      // Do nothing\n    } else if (object.type === 'Bone') {\n      const offsetMatrix = new THREE.Matrix4();\n      offsetMatrix.getInverse(object.matrixWorld);\n      entityInit = entityInit\n        .setComponent(BoneOffset.component, Mat4.toRows(Mat4.fromArray(offsetMatrix.elements)))\n        .setComponent(BoneMatrix.component);\n    } else if (object.type === 'SkinnedMesh' || object.type === 'Mesh') {\n      const o = object as THREE.Mesh;\n      const geom = o.geometry;\n      if (geom instanceof THREE.BufferGeometry) {\n        const mat = (o.material as THREE.MeshStandardMaterial);\n        const mesh = '' + o.geometry.id;\n        const cullFace = mat.side === THREE.FrontSide ? CullFace.Back\n          : mat.side === THREE.BackSide ? CullFace.Front\n          : CullFace.None;\n        entityInit = entityInit\n          .setComponent(VisibleComponent, true)\n          .setComponent(VisibilityFromComponent, { value: { x: -1, y: -1 } })\n          .setComponent(MaterialColor.component)\n          .setComponent(MaterialUseLighting.component, [new Float32Array([mat.name.indexOf('NoLighting') === -1 ? 1 : 0])]);\n        if (object.type === 'SkinnedMesh') {\n          entityInit = entityInit\n            .setComponent(SkinmeshBones.component)\n            .setComponent(SkinmeshBindMatrix.component, Mat4.fromArray(o.matrixWorld.elements) as Float32Array)\n        }\n        entityInit = entityInit\n          .setComponent(RenderableComponent, {\n            mesh,\n            cullFace,\n            skinning: object.type === 'SkinnedMesh',\n            transparent: false\n          });\n      } else {\n        throw new Error(`Not implemented yet`);\n      }\n    } else if (object.type === 'PerspectiveCamera' || object.type === 'OrthographicCamera') {\n      return; // Ignore\n    } else {\n      throw new Error(`Not implemented yet`);\n    }\n\n    if (opts.beforeEntityCreated) {\n      entityInit = opts.beforeEntityCreated(object, entityInit);\n    }\n\n    let entities: EntitiesRange | undefined;\n    if (entityInit) {\n      entities = state.ecs.createEntities(entityInit, opts.count);\n      if (entityInit.hasComponent(TransformParent.component)) {\n        for (let i=0; i < (opts.count ?? 1); i++) {\n          state.ecs.setComponentData(TransformParent.component, entities.getIndex(i), [{ ...parentEntities.getIndex(i), z: 0, w: 0 }])\n        }\n      }\n      if (object.type === 'SkinnedMesh' || object.type === 'Mesh') {\n        const o = object as THREE.Mesh;\n        const mat = (o.material as THREE.MeshStandardMaterial);\n        for (let i=0; i < (opts.count ?? 1); i++) {\n          state.ecs.setComponentData(VisibilityFromComponent, entities.getIndex(i), { value: rootEntities.getIndex(i) });\n          const color = opts.onMaterial?.(mat, i) ??\n            (mat.emissiveIntensity === 1 ? threeColorToVec4(mat.emissive) : threeColorToVec4(mat.color));\n          state.ecs.setComponentData(MaterialColor.component, entities.getIndex(i), [new Float32Array([color.x, color.y, color.z, color.w])])\n          if (color.w < 1) {\n            const r = state.ecs.getComponentData(RenderableComponent, entities.getIndex(i))!;\n            state.ecs.setComponentData(RenderableComponent, entities.getIndex(i), {\n              ...r,\n              transparent: true\n            });\n          }\n        }\n      }\n      if (object.type === 'SkinnedMesh') {\n        skinMeshes.push([object as THREE.SkinnedMesh, entities]);\n      }\n      if (opts.afterEntityCreated) {\n        opts.afterEntityCreated(object, entities);\n      }\n\n      entityLookup[object.name] = entities;\n\n      for (const c of object.children) {\n        this.createRecursive(state, c, rootEntities, entities, entityLookup, skinMeshes, order + 1, opts);\n      }\n    }\n    return entities;\n  }\n\n  createCamera(state: GpuWorldState, cameraName = 'Camera') {\n    const writeCamera = createCamera(state);\n    this.writeCamera(state, writeCamera, cameraName);\n    return writeCamera;\n  }\n  writeCamera(state: GpuWorldState, writeCamera: EntityRef, cameraName = 'Camera') {\n    const camera = this.model.scene.getObjectByName(cameraName) as THREE.PerspectiveCamera;\n    state.ecs.setComponentData(Position.cpuComponent, writeCamera, new Float32Array([camera.position.x, camera.position.y, camera.position.z]));\n    state.ecs.setComponentData(Quaternion.cpuComponent, writeCamera, new Float32Array([camera.quaternion.x, camera.quaternion.y, camera.quaternion.z, camera.quaternion.w]));\n    state.ecs.setComponentData(Scale.cpuComponent, writeCamera, new Float32Array([-camera.scale.x, -camera.scale.y, camera.scale.z]));\n    state.ecs.setComponentData(Camera.Fovy, writeCamera, new Float32Array([camera.fov]));\n    state.ecs.setComponentData(Camera.Near, writeCamera, new Float32Array([camera.near]));\n    state.ecs.setComponentData(Camera.Far, writeCamera, new Float32Array([camera.far]));\n  }\n\n  getCamera(name = 'Camera') {\n    const camera = this.model.scene.getObjectByName(name) as THREE.PerspectiveCamera;\n    var lookAtVector = new THREE.Vector3(0, 0, -1);\n    lookAtVector.applyQuaternion(camera.quaternion);\n    return full<LookatCamera>({\n      view: {\n        type: 'LookatView',\n        eye: camera.position,\n        lookAt: Vector3.add(camera.position, lookAtVector),\n        up: { x: 0, y: 0, z: 1 },\n        screenOffset: { x: 0, y: 0 }\n      },\n      projection: {\n        type: 'Perspective',\n        fovy: camera.fov,\n        aspectRatio: camera.aspect,\n        near: camera.near,\n        far: camera.far\n      }\n    })\n  }\n\n}\nexport function threeColorToVec3(color: THREE.Color): Vector3.Vector3 {\n  return { x: color.r, y: color.g, z: color.b };\n}\nexport function threeColorToVec4(color: THREE.Color): Vector4.Vector4 {\n  return { x: color.r, y: color.g, z: color.b, w: 1 };\n}\n\n// function threeVec3ToGlMatrix(v: THREE.Vector3) {\n//   return vec3.fromValues(v.x, v.y, v.z);\n// }\n// function threeQuatToGlMatrix(v: THREE.Quaternion) {\n//   return glmatrix.quat.fromValues(v.x, v.y, v.z, v.w);\n// }","export default __webpack_public_path__ + \"static/media/Impact.72b6441b.glb\";","import { shaderModule, uniformDef, structDef, funcDef, constDef } from \"../../GpuUtil/ShaderModule\";\nimport { GpuLookupTableSM } from \"../../GpuUtil/ECS/Query\";\nimport { Hitpoints, Team, WorthPoints, UnitStats, Gold } from \"./UnitComponents\";\nimport { Position } from \"./Transform\";\nimport { Teams, ArenaMembersSize, SideSize } from \"../StateLayout\";\nimport { vec2FromSize } from \"../../Math/Math\";\n\nexport enum ArenaWinner {\n  Undecided,\n  Home,\n  Away,\n  Tie\n}\n\nexport const UnitsInArena = shaderModule('UnitsInArena', [GpuLookupTableSM], {\n  size: constDef('int', '' + ArenaMembersSize),\n  sampler: uniformDef('isampler2D', d => d.unitsInArenaGpu.get(d)),\n  unit: funcDef('ivec2', [['int', 'arenaIndex'], ['int', 'arenaMemberIndex']], `\n    return ${GpuLookupTableSM.entityCell}(Self.sampler, arenaIndex, arenaMemberIndex);\n  `)\n});\n\nexport const DistanceToClosestUnit = shaderModule('DistanceToClosestUnit', [\n  UnitsInArena, Team.sm, Hitpoints.sm, Position.sm\n], {\n  value: funcDef('float', [['int', 'arenaIndex'], ['vec3', 'position'], ['int', 'team']], `\n    float minDist = 999999.;\n    for (int l=0; l < ${UnitsInArena.size}; l++) {\n      ivec2 other = ${UnitsInArena.unit}(arenaIndex, l);\n      if (other.x >= 0 && ${Team.sm.value}(other) == team && ${Hitpoints.sm.value}(other) > 0.) {\n        vec3 otherPosition = ${Position.sm.value}(other);\n        float d = distance(position, otherPosition);\n        if (d < minDist) {\n          minDist = d;\n        }\n      }\n    }\n    return minDist;\n  `)\n})\n\nexport const TeamStats = shaderModule('TeamStats', [\n  Hitpoints.sm, Position.sm, UnitStats.AliveTime.sm, UnitStats.CumulativeHitpoints.sm,\n  WorthPoints.sm, UnitsInArena, UnitStats.MinDistEnemyStatue.sm, Gold.sm\n], {\n  Stats: structDef({\n    alive: 'int',\n    unitsAlive: 'int',\n    pointsLoss: 'int',\n    hitpoints: 'float',\n    aliveTime: 'float',\n    cumulativeHitpoints: 'float',\n    minDistEnemyStatue: 'float',\n    gold: 'float',\n  }),\n  worldSize: uniformDef('vec2', d => vec2FromSize(d.data.worldSize)),\n  stats: funcDef('Self.Stats', [['int', 'arenaIndex'], ['int', 'team']], `\n    Self.Stats stats;\n    stats.minDistEnemyStatue = Self.worldSize.x;\n    ivec2 enemyStatue = ${UnitsInArena.unit}(arenaIndex, team == ${Teams.HomeTeam} ? ${SideSize} : 0);\n    for (int l=0; l < ${SideSize}; l++) {\n      int i = l + (team == ${Teams.AwayTeam} ? ${SideSize} : 0);\n      ivec2 unit = ${UnitsInArena.unit}(arenaIndex, i);\n      if (unit.x < 0) {\n        continue;\n      }\n      float hitpoints = ${Hitpoints.sm.value}(unit);\n\n      if (hitpoints > 0.0) {\n        stats.alive++;\n        if (l != 0) {\n          stats.unitsAlive++;\n        }\n      } else {\n        stats.pointsLoss += ${WorthPoints.sm.value}(unit);\n      }\n      stats.hitpoints += hitpoints;\n      stats.aliveTime += ${UnitStats.AliveTime.sm.value}(unit);\n      stats.cumulativeHitpoints += ${UnitStats.CumulativeHitpoints.sm.value}(unit);\n      vec3 position = ${Position.sm.value}(unit);\n      stats.minDistEnemyStatue = min(stats.minDistEnemyStatue, ${UnitStats.MinDistEnemyStatue.sm.value}(unit));\n      stats.gold += ${Gold.sm.value}(unit);\n    }\n\n    return stats;\n  `)\n});\n\nexport const ArenaStats = shaderModule('ArenaStats', [\n  TeamStats,\n], {\n  Stats: structDef({\n    home: 'TeamStats_Stats',\n    away: 'TeamStats_Stats',\n    homePoints: 'int',\n    awayPoints: 'int',\n    winner: 'int',\n  }),\n  homeCount: uniformDef('int', d => d.data.teams.home.unitCount),\n  awayCount: uniformDef('int', d => d.data.teams.away.unitCount),\n  stats: funcDef('Self.Stats', [['int', 'arenaIndex']], `\n    Self.Stats stats;\n    stats.home = ${TeamStats.stats}(arenaIndex, ${Teams.HomeTeam});\n    stats.away = ${TeamStats.stats}(arenaIndex, ${Teams.AwayTeam});\n    stats.homePoints = stats.away.pointsLoss;\n    stats.awayPoints = stats.home.pointsLoss;\n\n    stats.winner = ${ArenaWinner.Tie};\n    if (stats.homePoints > stats.awayPoints) {\n      stats.winner = ${ArenaWinner.Home};\n    } else if (stats.homePoints < stats.awayPoints) {\n      stats.winner = ${ArenaWinner.Away};\n    }\n    return stats;\n  `)\n});\n","import { shaderModule, funcDef, uniformDef, ShaderModule, FunctionDef } from \"../../GpuUtil/ShaderModule\";\nimport { IronBubbable } from \"../Buffs/Bubbles\";\nimport { Abilities, CastingAbilityHelpers, abilitiesData } from \"../Abilities/Abilities\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { Hitpoints, MaxHitpoints, UnitCategory, ImpactOwner, PreviousHitpoints, DiedStep, Gold, BountyComponents } from \"./UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { ThreeModel } from \"../../GpuUtil/Model\";\nimport ImpactGlb from '../../Models/Impact.glb';\nimport { EntityInit, Component, EntitiesRange } from \"../../GpuUtil/ECS\";\nimport { LocalToWorld, Position } from \"./Transform\";\nimport { MatrixSM, InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { ArenaInstance, ArenaMemberIndex, VisibilityFromComponent } from \"./Components\";\nimport { SideSize } from \"../StateLayout\";\nimport { UnitsInArena } from \"./ArenaStats\";\n\nexport const ImpactModel = ThreeModel.fromPath(ImpactGlb);\n\nexport async function createImpactEffects(state: GpuWorldState, owners: EntitiesRange) {\n  const res = (await ImpactModel).createInstances(state, {\n    count: owners.count,\n    rootEntityInit: new EntityInit()\n      .setComponent(ImpactOwner.component)\n      .setComponent(VisibilityFromComponent, { value: { x: -1, y: -1 } }),\n    visible: true,\n  });\n  for (let i=0; i < owners.count; i++) {\n    const owner = owners.getIndex(i);\n    state.ecs.setComponentData(ImpactOwner.component, res.roots.getIndex(i), [owner.x, owner.y]);\n    state.ecs.setComponentData(VisibilityFromComponent, res.roots.getIndex(i), { value: owner });\n  }\n}\n\nexport const DamageCalcHelpers = () => shaderModule([\n  IronBubbable.sm,\n  CastingAbilityHelpers,\n], {\n  shellArmorBonus: uniformDef('float', () => abilitiesData.get(Abilities.Shell, 'Settings').activeArmor.value),\n  ironBubbleArmorBonus: uniformDef('float', () => abilitiesData.get(Abilities.IronBubblegum, 'Settings').armor.value),\n  armor: funcDef('float', [['ivec2', 'entityCell']], `\n    return 1.0 +\n      (${IronBubbable.sm.value}(entityCell) > 0 ? Self.ironBubbleArmorBonus : 0.0) +\n      (${CastingAbilityHelpers.isPerforming}(entityCell, ${Abilities.Shell}) ? Self.shellArmorBonus : 0.0);\n  `)\n})\n\nexport class UpdateDestructible {\n  constructor(private gls: GlState) {}\n\n  damageTakenBounty = new ArchetypesQuery([Gold.component])\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      PreviousHitpoints.sm, Gold.writer, Gold.sm, Hitpoints.sm, UnitsInArena, ArenaInstance.sm, ArenaMemberIndex.sm,\n      BountyComponents.damageTaken.sm, BountyComponents.statueDamageTaken.sm\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float hitpoints = ${Hitpoints.sm.value}(entityCell);\n        float previousHitpoints = ${PreviousHitpoints.sm.value}(entityCell);\n        float gold = ${Gold.sm.value}(entityCell);\n        hitpoints = clamp(hitpoints, 0.0, ${glslFloat(MaxHitpoints)});\n        int arenaMemberIndex = ${ArenaMemberIndex.sm.value}(entityCell);\n        float hpLoss = max(0., previousHitpoints - hitpoints);\n        gold += ${BountyComponents.damageTaken.sm.value}(entityCell) * hpLoss;\n        int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n        ivec2 statue = ${UnitsInArena.unit}(arenaIndex, int(arenaMemberIndex / ${SideSize}) * ${SideSize});\n        float statueHp = ${Hitpoints.sm.value}(statue);\n        float statuePreviousHp = ${PreviousHitpoints.sm.value}(statue);\n        float statueHpLoss = max(0., statuePreviousHp - statueHp);\n        gold += ${BountyComponents.statueDamageTaken.sm.value}(entityCell) * statueHpLoss;\n        ${Gold.writer.write}(gold);\n      `)\n    }));\n\n  query = new ArchetypesQuery([Hitpoints.component, PreviousHitpoints.component])\n    .updateGpu(this.gls, [Hitpoints.component, PreviousHitpoints.component, DiedStep.component], shaderModule([\n      PreviousHitpoints.sm,\n      Hitpoints.writer,\n      PreviousHitpoints.writer,\n      DiedStep.writer,\n      Hitpoints.sm,\n      DiedStep.sm,\n    ], {\n      time: uniformDef('int', d => d.data.stepCounter),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float hitpoints = ${Hitpoints.sm.value}(entityCell);\n        float previousHitpoints = ${PreviousHitpoints.sm.value}(entityCell);\n        int diedStep = ${DiedStep.sm.value}(entityCell);\n        if (hitpoints <= 0. && previousHitpoints > 0.) {\n          diedStep = time;\n        }\n        hitpoints = clamp(hitpoints, 0.0, ${glslFloat(MaxHitpoints)});\n        ${Hitpoints.writer.write}(hitpoints);\n        ${PreviousHitpoints.writer.write}(hitpoints);\n        ${DiedStep.writer.write}(diedStep);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.damageTakenBounty.run(state);\n    this.query.run(state);\n  }\n}\n\nexport function UpdateImpactEffect(gls: GlState) {\n  return new ArchetypesQuery([ImpactOwner.component])\n    .updateGpu(gls, [LocalToWorld.gpuComponent], shaderModule([\n      ImpactOwner.sm, Hitpoints.sm, PreviousHitpoints.sm, Position.sm, LocalToWorld.writer, LocalToWorld.sm, InterpolateSM\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        ivec2 owner = ${ImpactOwner.sm.value}(entityCell);\n        float hitpoints = ${Hitpoints.sm.value}(owner);\n        float previousHitpoints = ${PreviousHitpoints.sm.value}(owner);\n        float ownerIncomingDamage = max(0., previousHitpoints - hitpoints);\n        if (ownerIncomingDamage > 0.) {\n          vec3 ownerPosition = ${Position.sm.value}(owner);\n          ${LocalToWorld.writer.write}(${MatrixSM.translateScale}(\n            ownerPosition + vec3(0, 0, 1),\n            vec3(${InterpolateSM.interpolateClamped}(ownerIncomingDamage, 0., 100., 1., 7.))\n          ));\n        } else {\n          mat4 localToWorld = ${LocalToWorld.sm.value}(entityCell);\n          localToWorld[0][0] /= 1.4;\n          localToWorld[1][1] /= 1.4;\n          localToWorld[2][2] /= 1.4;\n          ${LocalToWorld.writer.write}(localToWorld);\n        }\n      `)\n    }))\n}\n\nexport const DamageBounties = shaderModule('DamageBounties', [\n  BountyComponents.damageEnemyStatue.sm, BountyComponents.damageEnemyUnit.sm,\n  BountyComponents.friendlyFire.sm,\n], {\n  get: funcDef('float', [['ivec2', 'selfEntityCell'], ['int', 'selfArenaMemberIndex'], ['int', 'targetArenaMemberIndex']], `\n    int selfTeam = selfArenaMemberIndex / ${SideSize};\n    int targetTeam = targetArenaMemberIndex / ${SideSize};\n    if (selfTeam != targetTeam) {\n      bool targetIsStatue = targetArenaMemberIndex == 0 || targetArenaMemberIndex == ${SideSize};\n      if (targetIsStatue) {\n        return ${BountyComponents.damageEnemyStatue.sm.value}(selfEntityCell);\n      } else {\n        return ${BountyComponents.damageEnemyUnit.sm.value}(selfEntityCell);\n      }\n    } else {\n      return ${BountyComponents.friendlyFire.sm.value}(selfEntityCell);\n    }\n  `)\n});\n\nexport const KillBounties = shaderModule('KillBounties', [\n  BountyComponents.killEnemyStatue.sm, BountyComponents.killEnemyUnit.sm\n], {\n  get: funcDef('float', [['ivec2', 'selfEntityCell'], ['int', 'selfArenaMemberIndex'], ['int', 'targetArenaMemberIndex']], `\n    int selfTeam = selfArenaMemberIndex / ${SideSize};\n    int targetTeam = targetArenaMemberIndex / ${SideSize};\n    if (selfTeam != targetTeam) {\n      bool targetIsStatue = targetArenaMemberIndex == 0 || targetArenaMemberIndex == ${SideSize};\n      if (targetIsStatue) {\n        return ${BountyComponents.killEnemyStatue.sm.value}(selfEntityCell);\n      } else {\n        return ${BountyComponents.killEnemyUnit.sm.value}(selfEntityCell);\n      }\n    } else {\n      return 0.;\n    }\n  `)\n});\n\nexport const HealBounties = shaderModule('HealBounties', [\n  BountyComponents.healFriendlyStatue.sm, BountyComponents.healTeammate1.sm, BountyComponents.healTeammate2.sm,\n  BountyComponents.healEnemy.sm,\n], {\n  get: funcDef('float', [['ivec2', 'selfEntityCell'], ['int', 'selfArenaMemberIndex'], ['int', 'targetArenaMemberIndex']], `\n    int selfTeam = selfArenaMemberIndex / ${SideSize};\n    int targetTeam = targetArenaMemberIndex / ${SideSize};\n    if (selfTeam == targetTeam) {\n      int selfIndex = selfTeam == 0 ? selfArenaMemberIndex : (selfArenaMemberIndex - ${SideSize});\n      int targetIndex = targetTeam == 0 ? targetArenaMemberIndex : (targetArenaMemberIndex - ${SideSize});\n      if (targetIndex > selfIndex) {\n        targetIndex--;\n      }\n      return targetIndex == 0 ? ${BountyComponents.healFriendlyStatue.sm.value}(selfEntityCell) :\n        targetIndex == 1 ? ${BountyComponents.healTeammate1.sm.value}(selfEntityCell) :\n        targetIndex == 2 ? ${BountyComponents.healTeammate2.sm.value}(selfEntityCell) :\n        0.;\n    } else {\n      return ${BountyComponents.healEnemy.sm.value}(selfEntityCell);\n    }\n  `)\n})\n\nexport class SingleTargetDamage {\n  constructor(private gls: GlState,\n    private fromComponents: Component[],\n    private sm: ShaderModule<{\n      originator: FunctionDef<'ivec2', [['ivec2', 'entityCell']]>,\n      getTarget: FunctionDef<'ivec2', [['ivec2', 'entityCell']]>,\n      baseDamage: FunctionDef<'float', [['ivec2', 'entityCell']]>,\n    }>) {}\n\n  gold = new ArchetypesQuery(this.fromComponents)\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      this.sm,\n      Gold.writer,\n      DamageCalcHelpers(),\n      Hitpoints.sm,\n      UnitCategory,\n      DamageBounties,\n      KillBounties,\n      ArenaMemberIndex.sm,\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 target = ${this.sm.getTarget}(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float damage = ${this.sm.baseDamage}(entityCell) / ${DamageCalcHelpers().armor}(target);\n        ivec2 originator = ${this.sm.originator}(entityCell);\n        int originatorArenaMemberIndex = ${ArenaMemberIndex.sm.value}(originator);\n        int targetArenaMemberIndex = ${ArenaMemberIndex.sm.value}(target);\n        float damageBounty = ${DamageBounties.get}(originator, originatorArenaMemberIndex, targetArenaMemberIndex) * damage;\n        float targetHitpoints = ${Hitpoints.sm.value}(target);\n        float killBounty = (targetHitpoints - damage < 0.) ?\n          ${KillBounties.get}(originator, originatorArenaMemberIndex, targetArenaMemberIndex) : 0.;\n        ${Gold.writer.write}(damageBounty + killBounty);\n        return originator;\n      `)\n    }), 'sum');\n\n  damage = new ArchetypesQuery(this.fromComponents)\n    .updateGpu(this.gls, [Hitpoints.component], shaderModule([\n      this.sm,\n      Hitpoints.sm,\n      Hitpoints.writer,\n      DamageCalcHelpers(),\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 target = ${this.sm.getTarget}(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float damage = ${this.sm.baseDamage}(entityCell) / ${DamageCalcHelpers().armor}(target);\n        ${Hitpoints.writer.write}(-damage);\n        return target;\n      `)\n    }), 'sum');\n\n  run(state: GpuWorldState) {\n    this.gold.run(state);\n    this.damage.run(state);\n  }\n}\n\nexport class SingleTargetHeal {\n  constructor(private gls: GlState,\n    private fromComponents: Component[],\n    private sm: ShaderModule<{\n      originator: FunctionDef<'ivec2', [['ivec2', 'entityCell']]>,\n      getTarget: FunctionDef<'ivec2', [['ivec2', 'entityCell']]>,\n      hitpoints: FunctionDef<'float', [['ivec2', 'entityCell']]>,\n    }>) {}\n\n  gold = new ArchetypesQuery(this.fromComponents)\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      this.sm,\n      Gold.writer,\n      Hitpoints.sm,\n      UnitCategory,\n      ArenaMemberIndex.sm,\n      HealBounties,\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 target = ${this.sm.getTarget}(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float heal = ${this.sm.hitpoints}(entityCell);\n        float targetHitpoints = ${Hitpoints.sm.value}(target);\n        float newTargetHitpoints = clamp(targetHitpoints + heal, 0., ${glslFloat(MaxHitpoints)});\n        float healClamped = newTargetHitpoints - targetHitpoints;\n        ivec2 originator = ${this.sm.originator}(entityCell);\n        int originatorArenaMemberIndex = ${ArenaMemberIndex.sm.value}(originator);\n        int targetArenaMemberIndex = ${ArenaMemberIndex.sm.value}(target);\n        float bounty = ${HealBounties.get}(originator, originatorArenaMemberIndex, targetArenaMemberIndex) * healClamped;\n        ${Gold.writer.write}(bounty);\n        return originator;\n      `)\n    }), 'sum');\n\n  heal = new ArchetypesQuery(this.fromComponents)\n    .updateGpu(this.gls, [Hitpoints.component], shaderModule([\n      this.sm,\n      Hitpoints.sm,\n      Hitpoints.writer,\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 target = ${this.sm.getTarget}(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float heal = ${this.sm.hitpoints}(entityCell);\n        ${Hitpoints.writer.write}(heal);\n        return target;\n      `)\n    }), 'sum');\n\n  run(state: GpuWorldState) {\n    this.gold.run(state);\n    this.heal.run(state);\n  }\n}","import * as Vector3 from '../Math/Vector3';\nimport { SoundEffect } from './StateLayout';\nimport { mix } from '../Math/Math';\nimport lodash from 'lodash';\nimport { loadArrayBuffer } from '../GpuUtil';\nimport { mat4, vec3, quat } from 'gl-matrix';\n\n// import MediumSwish1 from '../Sound/gore - metal knife swing - 4.ogg';\n// import KnifeLowpitch1 from '../Sound/gore - large metal knife muted ring - 1 lowpitch.ogg';\n// import KnifeLowestpitch1 from '../Sound/gore - large metal knife muted ring - 1 lowestpitch.ogg';\n// import Hit1 from '../Sound/gore - flesh guts gore impact blood squirt wet - medium - 104.ogg';\n// import Hit2 from '../Sound/gore - crunchy flesh impact and blood squirt - hard -  8.ogg';\n// import Whine1 from '../Sound/461526__15gpanskabokstefflova-nicola__dog-whining-2.ogg';\n// import Coins1 from '../Sound/coins2.ogg';\n// import Thud1 from '../Sound/Fred_Thud.ogg';\nconst Sounds = (process.env.REACT_APP_APPLICATION === 'steam' || !process.env.REACT_APP_APPLICATION) ? import('./Sounds') : {};\n\nlet GlobalAudioContext: AudioContext | undefined;\ntry {\n  GlobalAudioContext = new AudioContext();\n} catch(err) {\n  // tslint:disable-next-line:no-console\n  console.error(err);\n}\n\nasync function loadMp3AudioBuffer(path: string) {\n  if (!GlobalAudioContext) { return null; }\n  const sounds = await Sounds;\n  const sound = sounds[path];\n  if (!sound) {\n    return null;\n  }\n  const arrayBuffer = await loadArrayBuffer(sound);\n  return await GlobalAudioContext.decodeAudioData(arrayBuffer);\n}\n\ntype AudioEffect = {\n  type: 'single';\n  path: string;\n  buffer: Promise<AudioBuffer | null>;\n  looping: boolean;\n} | {\n  type: 'random-slice';\n  path: string;\n  buffer: Promise<AudioBuffer | null>;\n  slices: Array<[number, number]>; // [start, duration]\n} | {\n  type: 'mix';\n  effects: AudioEffect[];\n} | {\n  type: 'random-mix-of';\n  effects: AudioEffect[];\n} | {\n  type: 'random-select';\n  effects: AudioEffect[];\n} | {\n  type: 'random-lowpass';\n  effect: AudioEffect;\n  minFreq: number;\n  maxFreq: number;\n} | {\n  type: 'gain';\n  effect: AudioEffect;\n  minGain: number;\n  maxGain: number;\n}\nfunction singleEffect(path: string, looping = false): AudioEffect {\n  return { type: 'single', path, buffer: Promise.resolve(null), looping };\n}\nfunction slicesEffect(path: string, slices: Array<[number, number]>): AudioEffect {\n  return { type: 'random-slice', path, buffer: Promise.resolve(null), slices };\n}\nfunction mixEffect(effects: AudioEffect[]): AudioEffect {\n  return { type: 'mix', effects };\n}\nfunction randomMixOfEffect(effects: AudioEffect[]): AudioEffect {\n  return { type: 'random-mix-of', effects };\n}\nfunction randomSelectEffect(effects: AudioEffect[]): AudioEffect {\n  return { type: 'random-select', effects };\n}\nfunction randomLowpassEffect(minFreq: number, maxFreq: number, effect: AudioEffect): AudioEffect {\n  return { type: 'random-lowpass', effect, minFreq, maxFreq };\n}\nfunction gainEffect(minGain: number, maxGain: number, effect: AudioEffect): AudioEffect {\n  return { type: 'gain', effect, minGain, maxGain };\n}\nconst SoundEffectDefs = {\n  [SoundEffect.Dart]: slicesEffect('Dart1', [[0.11, 0.4], [0.6, 0.37], [1.1, 0.37], [1.58, 0.34], [2.04, 0.23]]),\n  [SoundEffect.DartThud]: singleEffect('DartThud1'),\n  [SoundEffect.Knife]: randomLowpassEffect(600, 8000, slicesEffect('Knife1', [[0, 0.5], [0.73, 0.25]])),\n  [SoundEffect.KnifeHit]: gainEffect(0.3, 1.0, singleEffect('KnifeSlice1')),\n  [SoundEffect.FleshHit]: mixEffect([\n    gainEffect(0.1, 0.5, singleEffect('ImpactBloodSquirt1')),\n    gainEffect(0.1, 0.3, singleEffect('IceHit1'))\n  ]),\n  [SoundEffect.StoneHit]: singleEffect('StoneHit1'),\n  [SoundEffect.WoodHit]: randomLowpassEffect(600, 8000, gainEffect(0.5, 0.5, singleEffect('WoodHit1'))),\n  // [SoundEffect.Wimper]: slicesEffect('Whine1', [[0.6, 0.5], [1.39, 0.5], [2.24, 0.5], [2.9, 0.5], [3.68, 0.6], [4.8, 1], [5.96, 0.6], [7.98, 0.7], [8.99, 0.5], [9.57, 0.5], [10.4, 0.5], [11.08, 0.5], [11.8, 0.47], [12.27, 0.5]]),\n  [SoundEffect.Wimper]: singleEffect('MonsterGroan1'),\n  [SoundEffect.Wimper]: slicesEffect('DogWhine2', [[0, 1], [1.8, 1], [4.0, 1]]),\n  [SoundEffect.Wimper]: randomLowpassEffect(1000, 8000, randomMixOfEffect([singleEffect('DogWhine3'), singleEffect('DogWhine4')])),\n  //   slicesEffect('Whine1', [[0.6, 0.5], [1.39, 0.5], [2.24, 0.5], [2.9, 0.5], [3.68, 0.6], [4.8, 1], [5.96, 0.6], [7.98, 0.7], [8.99, 0.5], [9.57, 0.5], [10.4, 0.5], [11.08, 0.5], [11.8, 0.47], [12.27, 0.5]])\n  // ]),\n  [SoundEffect.Snore]: gainEffect(0.1, 0.1, singleEffect('Snore1', true)),\n  [SoundEffect.HealBuzz]: singleEffect('HealBuzz1', true),\n  [SoundEffect.Resurrect]: singleEffect('Resurrect1', true),\n  [SoundEffect.BubbleWobble]: singleEffect('BubbleWobble1', true),\n  [SoundEffect.Balloon]: singleEffect('Balloon1'),\n  [SoundEffect.Jump]: randomSelectEffect([singleEffect('Jump1'), singleEffect('Jump2')]),\n  [SoundEffect.Footstep]: gainEffect(0.03, 0.03, slicesEffect('Footstep1', [[0, 0.3], [0.43, 0.3], [0.87, 0.34], [1.36, 0.34], [1.75, 0.34], [2.17, 0.34], [2.65, 0.34], [3.07, 0.34]])),\n  [SoundEffect.CountIn]: slicesEffect('CountIn1', [[0.51, 0.7], [1.5, 0.58], [2.48, 0.58], [3.5, 0.6]]),\n  [SoundEffect.Gunshot]: slicesEffect('Gunshot1', [[1.014, 3], [9.24, 3], [16.01, 3], [22.08, 3], [28.95, 3], [34.7, 2]]),\n  [SoundEffect.HeavyDoorClose]: singleEffect('HeavyDoorCloseish1'),\n  [SoundEffect.Victory]: singleEffect('Victory1'),\n  [SoundEffect.ApplyItem]: singleEffect('ApplyItem1'),\n  [SoundEffect.Bite]: singleEffect('Bite1'),\n  [SoundEffect.PlanksFalling]: singleEffect('PlanksFalling1'),\n  [SoundEffect.Explosion]: singleEffect('Explosion1'),\n  [SoundEffect.Brass]: singleEffect('Brass1'),\n  [SoundEffect.StoneTick]: singleEffect('StoneTick1'),\n  [SoundEffect.Coins]: slicesEffect('Coins2', [[1.1, 0.4], [2.3, 0.4], [3.4, 0.4], [4.7, 0.5], [8.2, 0.4], [10, 0.4], [16.7, 0.4], [17.8, 0.4], [18.9, 0.4], [22.8, 0.4]]),\n}\n\nfunction loadEffectBuffers(effect: AudioEffect) {\n  if (effect.type === 'random-mix-of' || effect.type === 'random-select' || effect.type === 'mix') {\n    for (const ef of effect.effects) {\n      loadEffectBuffers(ef);\n    }\n  } else if (effect.type === 'random-lowpass' || effect.type === 'gain') {\n    return loadEffectBuffers(effect.effect);\n  } else {\n    effect.buffer = loadMp3AudioBuffer(effect.path);\n  }\n}\nfor (const key of Object.keys(SoundEffectDefs)) {\n  loadEffectBuffers(SoundEffectDefs[key]);\n}\n\nconst MiscBuffers = {\n  wind1: loadMp3AudioBuffer('Wind1'),\n}\n\nexport const MusicBuffers = {\n  music1: loadMp3AudioBuffer('Music1'),\n  music2: loadMp3AudioBuffer('Music2'),\n  music3: loadMp3AudioBuffer('Music3'),\n  music4: loadMp3AudioBuffer('Music4'),\n}\n\n\nexport class SoundEffectController {\n  constructor(private audioContext: AudioContext, private sources: AudioBufferSourceNode[], private gain: GainNode) {}\n  private sourcesEnded = this.sources.map(source => new Promise(resolve => source.addEventListener('ended', resolve)));\n  ended = Promise.all(this.sourcesEnded);\n  readonly looping = this.sources.reduce((p, x) => p || x.loop, false as boolean);\n  stop(when?: number) {\n    for (const s of this.sources) {\n      s.stop(when);\n    }\n  }\n  fadeOut(duration = 0.3) {\n    this.gain.gain.setValueAtTime(this.gain.gain.value, this.audioContext.currentTime);\n    this.gain.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + duration);\n    this.stop(this.audioContext.currentTime + duration);\n  }\n}\n\nclass AudioPlayer {\n  constructor(public audioContext: AudioContext) {\n    this.masterGain.connect(this.audioContext.destination);\n    this.masterCompressor.connect(this.masterGain);\n    this.effectsGain.connect(this.masterCompressor);\n    this.environmentGain.connect(this.masterCompressor);\n\n    this.musicGain.connect(this.masterCompressor);\n    this.musicInnerGain.connect(this.musicGain);\n    this.musicHighass.connect(this.musicInnerGain);\n    this.musicHighass.type = 'highpass';\n    this.musicHighass.frequency.setValueAtTime(0, this.audioContext.currentTime);\n    this.musicInnerGain.gain.setValueAtTime(0.1, this.audioContext.currentTime);\n\n    this.windGain.connect(this.environmentGain);\n    this.windGain.gain.setValueAtTime(0.1, this.audioContext.currentTime);\n  }\n  musicStarted = false;\n\n  musicGain = this.audioContext.createGain();\n  effectsGain = this.audioContext.createGain();\n  environmentGain = this.audioContext.createGain();\n\n  masterGain = this.audioContext.createGain();\n  masterCompressor = this.audioContext.createDynamicsCompressor();\n\n  windSource?: AudioBufferSourceNode;\n  windGain = this.audioContext.createGain();\n\n  async ensureWindStarted() {\n    if (!this.windSource) {\n      this.windSource = this.audioContext.createBufferSource();\n      this.windSource.buffer = await MiscBuffers.wind1;\n      this.windSource.connect(this.windGain);\n      this.windSource.loop = true;\n      this.windSource.start();\n    }\n  }\n\n  musicSource?: AudioBufferSourceNode;\n  musicHighass = this.audioContext.createBiquadFilter();\n  musicInnerGain = this.audioContext.createGain();\n  async startMusic() {\n    if (!this.musicStarted) {\n      this.musicStarted = true;\n      this.playNextMusic();\n    }\n  }\n  async playNextMusic(prevTrack?: string) {\n    const tracks = Object.keys(MusicBuffers);\n    let track;\n    do {\n      track = tracks[Math.floor(Math.random() * tracks.length)];\n    } while (track === prevTrack);\n    this.musicSource = this.audioContext.createBufferSource();\n    this.musicSource.buffer = await MusicBuffers[track];\n    this.musicSource.connect(this.musicHighass);\n    this.musicSource.loop = false;\n    this.musicSource.start();\n    this.musicSource.onended = () => {\n      this.playNextMusic(track);\n    }\n  }\n  highpassMusic(startTime = this.audioContext.currentTime, duration = 0.5) {\n    console.log('[highpassMusic]');\n    this.musicHighass.frequency.setValueAtTime(this.musicHighass.frequency.value, startTime);\n    this.musicHighass.frequency.linearRampToValueAtTime(1000, startTime + duration);\n    this.musicInnerGain.gain.setValueAtTime(this.musicInnerGain.gain.value, startTime);\n    this.musicInnerGain.gain.linearRampToValueAtTime(0.03, startTime + duration);\n  }\n  restoreMusic(startTime = this.audioContext.currentTime, duration = 3) {\n    console.log('[restoreMusic]');\n    this.musicHighass.frequency.setValueAtTime(this.musicHighass.frequency.value, startTime);\n    this.musicHighass.frequency.linearRampToValueAtTime(0, startTime + duration);\n    this.musicInnerGain.gain.setValueAtTime(this.musicInnerGain.gain.value, startTime);\n    this.musicInnerGain.gain.linearRampToValueAtTime(0.1, startTime + duration);\n  }\n  tempHighpassMusic(duration: number) {\n    this.highpassMusic();\n    this.restoreMusic(this.audioContext.currentTime + duration);\n  }\n\n  createEffectSource(effect: AudioEffect, startDelay: number): [AudioNode, AudioBufferSourceNode[]] {\n    if (effect.type === 'random-lowpass') {\n      const [eff, sources] = this.createEffectSource(effect.effect, startDelay);\n      const lowpass = this.audioContext.createBiquadFilter();\n      lowpass.type = 'lowpass';\n      lowpass.frequency.setValueAtTime(mix(effect.minFreq, effect.maxFreq, Math.random()), this.audioContext.currentTime);\n      eff.connect(lowpass);\n      return [lowpass, sources];\n    }\n    if (effect.type === 'gain') {\n      const [eff, sources] = this.createEffectSource(effect.effect, startDelay);\n      const gain = this.audioContext.createGain();\n      gain.gain.setValueAtTime(mix(effect.minGain, effect.maxGain, Math.random()), this.audioContext.currentTime);\n      eff.connect(gain);\n      return [gain, sources];\n    }\n    if (effect.type === 'mix') {\n      const gain = this.audioContext.createGain();\n      const sources: AudioBufferSourceNode[][] = [];\n      for (let i = 0; i < effect.effects.length; i++) {\n        const [sub, subSources] = this.createEffectSource(effect.effects[i], startDelay);\n        sub.connect(gain);\n        sources.push(subSources);\n      }\n      return [gain, lodash.flatten(sources)];\n    }\n    if (effect.type === 'random-mix-of') {\n      const gain = this.audioContext.createGain();\n      const weights = effect.effects.map(() => Math.random());\n      const totalWeights = weights.reduce((p, x) => p + x, 0);\n      const sources: AudioBufferSourceNode[][] = [];\n      for (let i = 0; i < effect.effects.length; i++) {\n        const [sub, subSources] = this.createEffectSource(effect.effects[i], startDelay);\n        const subGain = this.audioContext.createGain();\n        sub.connect(subGain);\n        const volume = weights[i] / totalWeights;\n        // console.log(i, volume);\n        subGain.gain.setValueAtTime(volume, this.audioContext.currentTime);\n        subGain.connect(gain);\n        sources.push(subSources);\n      }\n      return [gain, lodash.flatten(sources)];\n    }\n    if (effect.type === 'random-select') {\n      const subEff = effect.effects[Math.floor(Math.random() * effect.effects.length)];\n      return this.createEffectSource(subEff, startDelay);\n    }\n    let source = this.audioContext.createBufferSource();\n    effect.buffer.then(buffer => {\n      source.buffer = buffer;\n      if (effect.type === 'random-slice') {\n        const slice = effect.slices[Math.floor(Math.random() * effect.slices.length)];\n        source.start(this.audioContext.currentTime + startDelay, slice[0], slice[1]);\n      } else {\n        source.loop = effect.looping;\n        source.start(this.audioContext.currentTime + startDelay);\n      }\n    });\n    return [source, [source]];\n  }\n\n  playSoundEffect(effectName: SoundEffect, startDelay: number = 0, position?: Vector3.Vector3): SoundEffectController | undefined {\n    if (this.audioContext.state !== 'running') {\n      return undefined;\n    }\n    // console.log('playSoundEffect', SoundEffect[effectName], position);\n    const effect = SoundEffectDefs[effectName];\n    // eslint-disable-next-line\n    let [node, sources] = this.createEffectSource(effect, startDelay);\n    const effectGain = this.audioContext.createGain();\n    node = node.connect(effectGain);\n    if (position) {\n      const panner = this.audioContext.createPanner();\n      panner.distanceModel = 'inverse';\n      panner.maxDistance = 200;\n      panner.refDistance = 32;\n      panner.rolloffFactor = 1;\n      panner.setPosition(position.x, position.y, position.z);\n      node = node.connect(panner);\n    }\n    node = node.connect(this.effectsGain);\n    const controller = new SoundEffectController(this.audioContext, sources, effectGain);\n    this.playingSoundEffects.push(controller);\n    controller.ended.then(() => {\n      const i = this.playingSoundEffects.indexOf(controller);\n      this.playingSoundEffects.splice(i, 1);\n    });\n    return controller;\n  }\n  fadeOutAllLoopingSoundEffects() {\n    const playing = this.playingSoundEffects.slice(0);\n    for (const c of playing) {\n      if (c.looping) {\n        c.fadeOut();\n      }\n    }\n  }\n  private playingSoundEffects: SoundEffectController[] = [];\n\n  prevCameraView?: mat4;\n  updateCamera(cameraView: mat4) {\n    if (this.prevCameraView && mat4.equals(this.prevCameraView, cameraView)) {\n      return;\n    }\n    this.prevCameraView = cameraView;\n    const invView = mat4.invert(mat4.create(), cameraView);\n    if (!invView) {\n      return;\n    }\n    const position = vec3.create();\n    mat4.getTranslation(position, invView);\n    const rotation = quat.create();\n    mat4.getRotation(rotation, invView);\n    const forward = vec3.fromValues(0, 0, -1);\n    vec3.transformQuat(forward, forward, rotation);\n    const up = vec3.fromValues(0, 0, 1);\n    const listener = this.audioContext.listener;\n    if (!vec3IsNanOrInf(position)) {\n      listener.setPosition(position[0], position[1], position[2]);\n    }\n    if (!vec3IsNanOrInf(forward) && !vec3IsNanOrInf(up)) {\n      listener.setOrientation(forward[0], forward[1], forward[2], up[0], up[1], up[2]);\n    }\n  }\n}\nexport const AudioPlayerInstance = GlobalAudioContext ? new AudioPlayer(GlobalAudioContext) : undefined;\n\nfunction vec3IsNanOrInf(v: vec3) {\n  return isNaN(v[0]) || isNaN(v[1]) || isNaN(v[2]) || !isFinite(v[0]) || !isFinite(v[1]) || !isFinite(v[2]);\n}","export default __webpack_public_path__ + \"static/media/Bullet.35b36172.glb\";","export default __webpack_public_path__ + \"static/media/Dart.27a3a7be.glb\";","import { GpuComponentModule, GpuBufferModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, structDef } from \"../../GpuUtil/ShaderModule\";\nimport { Position, RotationZ } from \"../ECS/Transform\";\nimport { GpuWorldState } from \"../State\";\nimport { EntityInit, EntityComponentSystem } from \"../../GpuUtil/ECS\";\nimport { SingleTargetDamage } from \"../ECS/DamageCalc\";\nimport { ArenaInstance } from \"../ECS/Components\";\nimport { Dazeable } from \"../Buffs/Daze\";\nimport { Force, LastPushedBy } from \"../ECS/UnitComponents\";\nimport BulletGlb from '../../Models/Bullet.glb';\nimport DartGlb from '../../Models/Dart.glb';\nimport { ThreeModel } from \"../../GpuUtil/Model\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { AudioPlayerInstance } from \"../Audio\";\nimport { SoundEffect } from \"../StateLayout\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\n\nexport const BulletModel = ThreeModel.fromPath(BulletGlb);\nexport const DartModel = ThreeModel.fromPath(DartGlb);\n\nconst ProjectileBuffer = new GpuBufferModule({ name: 'ProjectileBuffer', format: 'vec4' });\n\nexport enum ProjectileType {\n  Bullet,\n  KnockbackBullet,\n  SleepingDart,\n}\n\nconst CpuProjectileTypeComponent = EntityComponentSystem.registerComponent<ProjectileType>({\n  name: 'CpuProjectileType',\n  type: 'obj',\n});\nexport const ProjectileOriginator = new GpuComponentModule('ProjectileOriginator', ProjectileBuffer, 'ivec2');\nexport const SeekingProjectileTarget = new GpuComponentModule('SeekingProjectileTarget', ProjectileBuffer, 'ivec2');\nexport const ProjectileSpeed = new GpuComponentModule('ProjectileSpeed', ProjectileBuffer, 'float');\nexport const DamageProjectile = new GpuComponentModule('DamageProjectile', ProjectileBuffer, 'float');\nexport const DazeProjectile = new GpuComponentModule('DazeProjectile', ProjectileBuffer, 'float');\nexport const KnockbackProjectile = new GpuComponentModule('KnockbackProjectile', ProjectileBuffer, 'float');\nexport const ProjectilePreviousPosition = new GpuComponentModule('ProjectilePreviousPosition', ProjectileBuffer, 'vec3');\n\nexport async function createBulletProjectile(state: GpuWorldState, arenaInstance: number, type: ProjectileType) {\n  let entityInit = new EntityInit()\n    .setComponent(Position.gpuComponent)\n    .setComponent(RotationZ.component)\n    .setComponent(ProjectileOriginator.component)\n    .setComponent(SeekingProjectileTarget.component)\n    .setComponent(DamageProjectile.component)\n    .setComponent(ProjectileSpeed.component, [new Float32Array([1, 0, 0, 0])])\n    .setComponent(ProjectilePreviousPosition.component)\n    .setComponents(ArenaInstance.components, new Float32Array([arenaInstance]))\n    .setComponent(CpuProjectileTypeComponent, type)\n  if (type === ProjectileType.KnockbackBullet) {\n    entityInit = entityInit.setComponent(KnockbackProjectile.component);\n  } else if (type === ProjectileType.SleepingDart) {\n    entityInit = entityInit.setComponent(DazeProjectile.component);\n  }\n  const res = (type === ProjectileType.SleepingDart ? await DartModel : await BulletModel).createInstances(state, {\n    rootEntityInit: entityInit,\n    visible: false,\n  })\n  return res.roots.getIndex(0);\n}\n\nconst ProjectileHelpers = shaderModule([\n  Position.sm,\n  SeekingProjectileTarget.sm,\n  ProjectileSpeed.sm,\n  ProjectilePreviousPosition.sm,\n], {\n  ProjectileState: structDef({\n    target: 'ivec2',\n    position: 'vec3',\n    targetPosition: 'vec3',\n    speed: 'float',\n    delta: 'vec3',\n    velocity: 'vec3',\n    hitting: 'bool'\n  }),\n  getProjectileState: funcDef('ProjectileState', [['ivec2', 'entityCell']], `\n    ProjectileState state;\n    state.target = ${SeekingProjectileTarget.sm.value}(entityCell);\n    state.position = ${Position.sm.value}(entityCell);\n    state.targetPosition = ${Position.sm.value}(state.target) + vec3(0, 0, 1);\n    state.speed = ${ProjectileSpeed.sm.value}(entityCell);\n    state.delta = state.targetPosition - state.position;\n    state.hitting = length(state.delta) < state.speed;\n    vec3 previousPosition = ${ProjectilePreviousPosition.sm.value}(entityCell);\n    state.velocity = state.position - previousPosition;\n    return state;\n  `),\n})\n\nexport class UpdateProjectiles {\n  constructor(private gls: GlState) {}\n\n  applyDamage = new SingleTargetDamage(this.gls,\n    [DamageProjectile.component],\n    shaderModule([\n      ProjectileHelpers, DamageProjectile.sm, ProjectileOriginator.sm\n    ], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${ProjectileOriginator.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        } else {\n          return state.target;\n        }\n      `),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return ${DamageProjectile.sm.value}(entityCell);\n      `)\n    }));\n\n  applyDaze = new ArchetypesQuery([DazeProjectile.component])\n    .updateGpu(this.gls, [Dazeable.component], shaderModule([\n      ProjectileHelpers,\n      SeekingProjectileTarget.sm,\n      DazeProjectile.sm,\n      Dazeable.writer\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        float duration = ${DazeProjectile.sm.value}(entityCell);\n        ${Dazeable.writer.write}(int(duration));\n        return state.target;\n      `)\n    }), 'sum');\n\n  applyKnockback = new ArchetypesQuery([KnockbackProjectile.component])\n    .updateGpu(this.gls, [Force.component], shaderModule([\n      ProjectileHelpers,\n      SeekingProjectileTarget.sm,\n      KnockbackProjectile.sm,\n      Force.writer\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        float force = ${KnockbackProjectile.sm.value}(entityCell);\n        ${Force.writer.write}(normalize(state.velocity) * force);\n        return state.target;\n      `)\n    }), 'sum');\n\n  applyLastPushedBy = new ArchetypesQuery([KnockbackProjectile.component])\n    .updateGpu(this.gls, [LastPushedBy.component], shaderModule([\n      ProjectileHelpers,\n      SeekingProjectileTarget.sm,\n      KnockbackProjectile.sm,\n      LastPushedBy.writer,\n      ProjectileOriginator.sm,\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        ${LastPushedBy.writer.write}(${ProjectileOriginator.sm.value}(entityCell));\n        return state.target;\n      `)\n    }));\n\n  updateProjectiles = new ArchetypesQuery([SeekingProjectileTarget.component, ProjectileSpeed.component])\n    .updateGpu(this.gls, [Position.gpuComponent, RotationZ.component, SeekingProjectileTarget.component, ProjectilePreviousPosition.component], shaderModule([\n      Position.writer,\n      RotationZ.writer,\n      Position.sm,\n      SeekingProjectileTarget.sm,\n      ProjectileSpeed.sm,\n      SeekingProjectileTarget.writer,\n      ProjectileHelpers,\n      ProjectilePreviousPosition.writer,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        if (!state.hitting) {\n          vec3 delta = normalize(state.delta);\n          ${Position.writer.write}(state.position + delta * state.speed);\n          ${RotationZ.writer.write}(atan(delta.y, delta.x));\n          ${SeekingProjectileTarget.writer.write}(state.target);\n          ${ProjectilePreviousPosition.writer.write}(state.position);\n        } else {\n          ${Position.writer.write}(vec3(-10000));\n          ${RotationZ.writer.write}(0.0);\n          ${SeekingProjectileTarget.writer.write}(ivec2(-1));\n          ${ProjectilePreviousPosition.writer.write}(vec3(0));\n        }\n      `)\n    }));\n\n  sound = new EntitiesQuery([ProjectileSpeed.component])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([\n      ProjectileHelpers,\n    ], {\n      map: funcDef('vec4[1]', [['ivec2', 'entityCell']], `\n        ProjectileState state = ${ProjectileHelpers.getProjectileState}(entityCell);\n        return vec4[](\n          vec4(state.position, state.hitting)\n        );\n      `)\n    }))\n    .toCpuQueuing(state => state.data.round);\n\n  run(state: GpuWorldState) {\n    this.applyDamage.run(state);\n    this.applyDaze.run(state);\n    this.applyKnockback.run(state);\n    this.applyLastPushedBy.run(state);\n    this.updateProjectiles.run(state);\n    const readResults = this.sound.queueRead(state);\n    for (const res of readResults()) {\n      for (const { entityCell, value } of res) {\n        const position = value[0];\n        const hitting = !!value[0].w;\n        if (hitting && AudioPlayerInstance) {\n          const type = state.ecs.getComponentData(CpuProjectileTypeComponent, entityCell);\n          if (type === ProjectileType.SleepingDart) {\n            AudioPlayerInstance.playSoundEffect(SoundEffect.DartThud, 0, position);\n          }\n        }\n      }\n    }\n  }\n}\n","import { keysOfEnum, EventDispatcher } from \"../../Util\";\nimport { GpuComponentModule, DualComponentModule, GpuBufferModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { UnitBuffer } from \"../ECS/UnitComponents\";\nimport { shaderModule, uniformArrayDef, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { UnitAnimations, SoundEffect, CastingState } from \"../StateLayout\";\nimport { GpuWorldState } from \"../State\";\nimport { EntityInit } from \"../../GpuUtil/ECS\";\nimport { createBulletProjectile, ProjectileType, ProjectileOriginator } from \"../Projectiles/Projectiles\";\nimport { InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { AnimationAction } from \"../ECS/Animation\";\nimport { SecondsPerStep } from \"../../Time\";\nimport { AudioPlayerInstance, SoundEffectController } from \"../Audio\";\nimport { Vector3 } from \"../../Math/Vector3\";\nimport { EntityRef } from \"../StateData\";\nimport { VisibleComponent, VisibilityFromComponent } from \"../ECS/Components\";\n\nexport enum AbilityRange {\n  Any,\n  Close,\n  Ranged,\n}\n\nexport enum AbilitySlot {\n  NoSlot = -1,\n  Slot0,\n  Slot1,\n  Slot2,\n}\nexport const AbilitySlotKeys = keysOfEnum(AbilitySlot);\n\nexport enum ValidTarget {\n  Anything,\n  Creature,\n}\n\ntype OnAbilityCreateHandler = (state: GpuWorldState, unitInit: EntityInit, arenaInstance: number, onUnitCreated: EventDispatcher<[EntityRef]>) => Promise<EntityInit>;\n\nexport type AbilityAnimationUpdater = (previousActions: AnimationAction[], nextActions: AnimationAction[], castingState: CastingState, castingSteps: number, castingAbility: Abilities, time: number) => void;\n\nfunction emptyAnimationUpdater(): AbilityAnimationUpdater {\n  return () => {};\n}\nfunction straightAnimationUpdater(anim: UnitAnimations, startOnPerform = false): AbilityAnimationUpdater {\n  return (previousActions: AnimationAction[], nextActions: AnimationAction[], castingState: CastingState, castingSteps: number, castingAbility: Abilities, time: number) => {\n    if (!startOnPerform || (castingState === CastingState.Performing || castingState === CastingState.WindDown)) {\n      const clip = UnitAnimations[anim];\n      const active = previousActions.find(x => x.clip === clip);\n      nextActions.push({\n        positionType: 'startTime',\n        positionValue: active ? active.positionValue : time,\n        clip,\n        looping: false\n      });\n    }\n  }\n}\nfunction duoAnimationUpdater(anim: UnitAnimations, animationCastFrames: number, animationWindDownFrames: number): AbilityAnimationUpdater {\n  return (previousActions: AnimationAction[], nextActions: AnimationAction[], castingState: CastingState, castingSteps: number, castingAbility: Abilities, time: number) => {\n    const positionValue = castingState === CastingState.Casting\n      ? (animationCastFrames * castingSteps / abilitiesData.castTime[castingAbility])\n      : (animationCastFrames + animationWindDownFrames * castingSteps / abilitiesData.windDown[castingAbility]);\n    nextActions.push({\n      positionType: 'time',\n      positionValue: positionValue * SecondsPerStep,\n      clip: UnitAnimations[anim],\n      looping: false\n    });\n  }\n}\nfunction trioAnimationUpdater(anim: UnitAnimations, animationCastFrames: number, animationPerformFrames: number, animationWindDownFrames: number): AbilityAnimationUpdater {\n  return (previousActions: AnimationAction[], nextActions: AnimationAction[], castingState: CastingState, castingSteps: number, castingAbility: Abilities, time: number) => {\n    const positionValue = castingState === CastingState.Casting\n      ? (animationCastFrames * castingSteps / abilitiesData.castTime[castingAbility])\n      : castingState === CastingState.Performing ? (animationCastFrames + animationPerformFrames * castingSteps / abilitiesData.duration[castingAbility])\n      : (animationCastFrames + animationPerformFrames + animationWindDownFrames * castingSteps / abilitiesData.windDown[castingAbility]);\n    nextActions.push({\n      positionType: 'time',\n      positionValue: positionValue * SecondsPerStep,\n      clip: UnitAnimations[anim],\n      looping: false\n    });\n  }\n}\nfunction multiAnimationUpdater(updaters: AbilityAnimationUpdater[]): AbilityAnimationUpdater {\n  return (previousActions: AnimationAction[], nextActions: AnimationAction[], castingState: CastingState, castingSteps: number, castingAbility: Abilities, time: number) => {\n    for (const updater of updaters) {\n      updater(previousActions, nextActions, castingState, castingSteps, castingAbility, time);\n    }\n  }\n}\n\nexport type AbilitySoundUpdater = (state: GpuWorldState, castingState: CastingState, castingSteps: number, castingAbility: Abilities, castingTarget: EntityRef, time: number, position: Vector3) => SoundEffectController | undefined;\nconst EmptySoundEffectUpdater = () => undefined;\nfunction straightSoundUpdater(soundEffect: SoundEffect, startOnPerform = false): AbilitySoundUpdater {\n  return (state: GpuWorldState, castingState: CastingState, castingSteps: number, castingAbility: Abilities, castingTarget: EntityRef, time: number, position: Vector3) => {\n    if ((startOnPerform ? castingState === CastingState.Performing : castingState === CastingState.Casting) && castingSteps === 0) {\n      if (AudioPlayerInstance) {\n        return AudioPlayerInstance.playSoundEffect(soundEffect, undefined, position);\n      }\n    }\n    return undefined;\n  }\n}\nconst TalonsSoundUpdater: AbilitySoundUpdater = (state: GpuWorldState, castingState: CastingState, castingSteps: number, castingAbility: Abilities, castingTarget: EntityRef, time: number, position: Vector3) => {\n  if (AudioPlayerInstance && castingSteps === 0) {\n    if (castingState === CastingState.Casting) {\n      return AudioPlayerInstance.playSoundEffect(SoundEffect.Knife, undefined, position);\n    } else if (castingState === CastingState.Performing) {\n      AudioPlayerInstance?.playSoundEffect(SoundEffect.KnifeHit, 0, position);\n    }\n  }\n  return undefined;\n}\n\nconst AttackAnimationUpdater = duoAnimationUpdater(UnitAnimations.Attack1, 20, 15);\nconst FireAnimationUpdater = multiAnimationUpdater([\n  duoAnimationUpdater(UnitAnimations.Fire1, 13, 17),\n  straightAnimationUpdater(UnitAnimations.MuzzleFlash1, true)\n]);\nconst TailAttackAnimationUpdater = trioAnimationUpdater(UnitAnimations.TailAttack1, 10, 15, 35);\n\nexport class AbilitiesData {\n  columns = [\n    'Name',          'TargetRange',        'ValidTargets',       'CastTime', 'Duration', 'WindDown', 'Cooldown', 'DoesDamage', 'Heals', 'CastAnimation',                                          'CastSound',                                        'OnCreate',         'Settings' ];\n  data = {\n    None:            [AbilityRange.Any,    ValidTarget.Anything, 0,          0,          30,         0,          false,         false,   emptyAnimationUpdater(),                                  EmptySoundEffectUpdater,                           null,                {}],\n\n    Talons:          [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         0,          true,          false,   AttackAnimationUpdater,                                   TalonsSoundUpdater,                                null,                { damage: { value: 30, name: 'Damage', unit: 'hp' } }],\n    BloodClaws:      [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         0,          true,          false,   AttackAnimationUpdater,                                   TalonsSoundUpdater,                                null,                { damage: { value: 20, name: 'Damage', unit: 'hp' } }],\n    Cleavers:        [AbilityRange.Close,  ValidTarget.Creature, 40,         1,          60,         0,          true,          false,   AttackAnimationUpdater,                                   TalonsSoundUpdater,                                null,                { damage: { value: 60, name: 'Damage', unit: 'hp' } }],\n    Cripplers:       [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         0,          true,          false,   AttackAnimationUpdater,                                   TalonsSoundUpdater,                                null,                { damage: { value: 20, name: 'Damage', unit: 'hp' } }],\n    // Banes:           [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         0,          true,          false,   AttackAnimationUpdater,                                   TalonsSoundUpdater,                                null,                { damage: { value: 0, name: 'Damage', unit: 'hp' } }],\n\n    HealingGland:    [AbilityRange.Ranged, ValidTarget.Creature, 5,          2*60,        30,         4*60,      false,         true,    TailAttackAnimationUpdater,                               straightSoundUpdater(SoundEffect.HealBuzz),        null,                { healing: { value: 60, name: 'Healing', unit: 'hp/sec' } }],\n    VampireGland:    [AbilityRange.Ranged, ValidTarget.Creature, 5,          4*60 + 10,   30,         7*60,      false,         true,    TailAttackAnimationUpdater,                               straightSoundUpdater(SoundEffect.HealBuzz),        null,                { damage: { value: 0.4 * 60, name: 'Damage', unit: 'hp/sec' }, healing: { value: 0.3 * 60, name: 'Healing', unit: 'hp/sec' } }],\n\n    Leap:            [AbilityRange.Any,    ValidTarget.Anything, 9,          1,          30,         0,          false,         false,   straightAnimationUpdater(UnitAnimations.Jump1),           straightSoundUpdater(SoundEffect.Jump),            null,                {}],\n\n    Pistol:          [AbilityRange.Ranged, ValidTarget.Creature, 13,         1,          17,         45,         true,          false,   FireAnimationUpdater,                                     straightSoundUpdater(SoundEffect.Gunshot, true),   onGunCreate,         { damage: { value: 20, name: 'Damage', unit: 'hp' } }],\n    Magnum:          [AbilityRange.Ranged, ValidTarget.Creature, 13,         1,          17,         80,         true,          false,   FireAnimationUpdater,                                     straightSoundUpdater(SoundEffect.Gunshot, true),   onMagnumCreate,      { damage: { value: 15, name: 'Damage', unit: 'hp' } }],\n    Blaster:         [AbilityRange.Ranged, ValidTarget.Creature, 26,         1,          34,         90,         true,          false,   FireAnimationUpdater,                                     straightSoundUpdater(SoundEffect.Gunshot, true),   onGunCreate,         { damage: { value: 45, name: 'Damage', unit: 'hp' } }],\n    SleepDart:       [AbilityRange.Ranged, ValidTarget.Creature, 10,         1,          30,         7*60,       true,          false,   TailAttackAnimationUpdater,                               straightSoundUpdater(SoundEffect.Dart),            onSleepDartCreate,   { sleepDuration: { value: 3, name: 'Sleep duration', unit: 'sec' } }],\n\n    IronBubblegum:   [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         5*60,       false,         false,   straightAnimationUpdater(UnitAnimations.BreathAttack1),   straightSoundUpdater(SoundEffect.Balloon),         null,                { armor: { value: 3, name: 'Bubble armor bonus', unit: 'armor' }, duration: { value: 5, name: 'Bubble duration', unit: 'sec' } }],\n    HeliumBubblegum: [AbilityRange.Close,  ValidTarget.Creature, 20,         1,          30,         5*60,       false,         false,   straightAnimationUpdater(UnitAnimations.BreathAttack1),   straightSoundUpdater(SoundEffect.Balloon),         null,                { duration: { value: 5, name: 'Bubble duration', unit: 'sec' } }],\n    Shell:           [AbilityRange.Any,    ValidTarget.Anything, 5,          20,         5,          0,          false,         false,   straightAnimationUpdater(UnitAnimations.ShellHide1),      EmptySoundEffectUpdater,                           null,                { activeArmor: { value: 5, name: 'Armor bonus while active', unit: 'armor' } }],\n    Trombone:        [AbilityRange.Any,    ValidTarget.Anything, 20,         60,         30,         5*60,       false,         false,   straightAnimationUpdater(UnitAnimations.BreathAttack1),   straightSoundUpdater(SoundEffect.Brass, true),     null,                {}],\n\n    // FireTail:        [10,     AbilityRange.Any,    ValidTarget.Anything, 10,         15,         30,         0,        true,          false,   TailAttackAnimationUpdater,                               EmptySoundEffectUpdater,                         null],\n    // Resurrect:       [70,     AbilityRange.Ranged, ValidTarget.Anything, 180,        1,          30,        0,        false,         false,   attackAnimationUpdater([UnitAnimations.TailAttack1]), straightSoundUpdater(SoundEffect.Resurrect),      null],\n    // Stomp:           [10,     AbilityRange.Any,    ValidTarget.Anything, 10,         1,          30,        0,        true,          false,   [],                                                    EmptySoundEffectUpdater,                 0,         null],\n    // Eat:        [AbilitySlot.NoSlot, 0,      AbilityRange.Close,  ValidTarget.EdibleTargets,    10,         1,          30,        false,         false,   UnitAnimations.None,    ``],\n  };\n  table = Object.keys(this.data).reduce((p, k) => ([...p, [k, ...this.data[k]]]), [] as Array<Array<any>>);\n  get(ability: Abilities, column: string) {\n    return this.data[Abilities[ability]][this.columns.indexOf(column) - 1];\n  }\n\n  name = this.table.map(x => x[this.columns.indexOf('Name')] as string);\n  component = this.name.map(name => new DualComponentModule(name + 'Ability', UnitBuffer.buffer, 'int'));\n  targetRange = this.table.map(x => x[this.columns.indexOf('TargetRange')] as AbilityRange);\n  validTargets = this.table.map(x => x[this.columns.indexOf('ValidTargets')] as number);\n  castTime = this.table.map(x => x[this.columns.indexOf('CastTime')] as  number);\n  duration = this.table.map(x => x[this.columns.indexOf('Duration')] as  number);\n  windDown = this.table.map(x => x[this.columns.indexOf('WindDown')] as  number);\n  cooldown = this.table.map(x => x[this.columns.indexOf('Cooldown')] as  number);\n  doesDamage = this.table.map(x => x[this.columns.indexOf('DoesDamage')] as boolean);\n  heals = this.table.map(x => x[this.columns.indexOf('Heals')] as boolean);\n  castAnimation = this.table.map(x => x[this.columns.indexOf('CastAnimation')] as AbilityAnimationUpdater);\n  castSound = this.table.map(x => x[this.columns.indexOf('CastSound')] as AbilitySoundUpdater);\n  onCreate = this.table.map(x => x[this.columns.indexOf('OnCreate')] as null | OnAbilityCreateHandler);\n}\nexport const abilitiesData = new AbilitiesData();\n\nconst AbilitiesBuffer = new GpuBufferModule({ name: 'AbilitiesBuffer', format: 'float' });\nexport const UnitRef = new GpuComponentModule('UnitRef', AbilitiesBuffer, 'ivec2');\nexport const GunProjectileRef = new GpuComponentModule('GunProjectileRef', AbilitiesBuffer, 'ivec2');\nexport const SleepDartProjectileRef = new GpuComponentModule('SleepDartProjectileRef', AbilitiesBuffer, 'ivec2');\n\nexport async function createAbility(state: GpuWorldState, unitRef: EntityRef, arenaInstance: number, ability: Abilities, onUnitCreated: EventDispatcher<[EntityRef]>): Promise<EntityRef> {\n  let abilityInit = new EntityInit()\n    .setComponent(UnitRef.component, [unitRef.x, unitRef.y])\n    .setComponent(VisibleComponent, false)\n    .setComponent(VisibilityFromComponent, { value: unitRef })\n    .setComponents(abilitiesData.component[ability].components, new Float32Array([0]));\n  const onCreate = abilitiesData.onCreate[ability];\n  if (onCreate) {\n    abilityInit = await onCreate(state, abilityInit, arenaInstance, onUnitCreated);\n  }\n  return state.ecs.createEntities(abilityInit).getIndex(0);\n}\n\nasync function onGunCreate(state: GpuWorldState, abilityInit: EntityInit, arenaInstance: number, onUnitCreated: EventDispatcher<[EntityRef]>) {\n  const projectile = await createBulletProjectile(state, arenaInstance, ProjectileType.Bullet);\n  onUnitCreated.attach(unit => state.ecs.setComponentData(ProjectileOriginator.component, projectile, [new Float32Array([unit.x, unit.y, 0, 0])]));\n  return abilityInit\n    .setComponent(GunProjectileRef.component, [projectile.x, projectile.y]);\n}\nasync function onMagnumCreate(state: GpuWorldState, abilityInit: EntityInit, arenaInstance: number, onUnitCreated: EventDispatcher<[EntityRef]>) {\n  const projectile = await createBulletProjectile(state, arenaInstance, ProjectileType.KnockbackBullet);\n  onUnitCreated.attach(unit => state.ecs.setComponentData(ProjectileOriginator.component, projectile, [new Float32Array([unit.x, unit.y, 0, 0])]));\n  return abilityInit\n    .setComponent(GunProjectileRef.component, [projectile.x, projectile.y]);\n}\n\nasync function onSleepDartCreate(state: GpuWorldState, abilityInit: EntityInit, arenaInstance: number, onUnitCreated: EventDispatcher<[EntityRef]>) {\n  const projectile = await createBulletProjectile(state, arenaInstance, ProjectileType.SleepingDart);\n  onUnitCreated.attach(unit => state.ecs.setComponentData(ProjectileOriginator.component, projectile, [new Float32Array([unit.x, unit.y, 0, 0])]));\n  return abilityInit\n    .setComponent(SleepDartProjectileRef.component, [projectile.x, projectile.y]);\n}\n\nexport enum AbilitiesConsts {\n  AbilitiesCount = abilitiesData.table.length,\n}\n\nexport const Abilities =\n  Object.keys(abilitiesData.data).reduce((p, name, i) => ({...p, [name]: i, [i]: name }),\n  {} as { [P in keyof AbilitiesData['data']]: number });\nexport type Abilities = number;\n\nexport const AbilitySM = shaderModule('Ability', [], {\n  targetRange: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.targetRange),\n  validTargets: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.validTargets),\n  castTime: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.castTime),\n  duration: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.duration),\n  windDown: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.windDown),\n  cooldown: uniformArrayDef('int[]', AbilitiesConsts.AbilitiesCount, d => d.data.abilities.cooldown),\n});\n\nexport const UnitAbilities = new GpuComponentModule('UnitAbilities', UnitBuffer, 'int', 3);\n\nexport const Casting = {\n  Ability: new GpuComponentModule('CastingAbility', UnitBuffer, 'int'),\n  StateStartStep: new GpuComponentModule('CastingStateStartStep', UnitBuffer, 'int'),\n  Target: new GpuComponentModule('CastingTarget', UnitBuffer, 'ivec2'),\n  State: new GpuComponentModule('CastingState', UnitBuffer, 'int'),\n  Cooldowns: new GpuComponentModule('CastingCooldown0', UnitBuffer, 'int', 3),\n}\n\nexport const CastingAbilityHelpers = shaderModule('CastingAbilityHelpers', [\n  Casting.Ability.sm, Casting.State.sm, AbilitySM, InterpolateSM, Casting.StateStartStep.sm\n], {\n  isPerforming: funcDef('bool', [['ivec2', 'entityCell'], ['int', 'ability']], `\n    int currentAbility = ${Casting.Ability.sm.value}(entityCell);\n    int state = ${Casting.State.sm.value}(entityCell);\n    return currentAbility == ability && state == ${CastingState.Performing};\n  `),\n  isCasting: funcDef('bool', [['ivec2', 'entityCell'], ['int', 'ability']], `\n    int currentAbility = ${Casting.Ability.sm.value}(entityCell);\n    int state = ${Casting.State.sm.value}(entityCell);\n    return currentAbility == ability && state == ${CastingState.Casting};\n  `),\n  isWindDown: funcDef('bool', [['ivec2', 'entityCell'], ['int', 'ability']], `\n    int currentAbility = ${Casting.Ability.sm.value}(entityCell);\n    int state = ${Casting.State.sm.value}(entityCell);\n    return currentAbility == ability && state == ${CastingState.WindDown};\n  `),\n  time: uniformDef('int', d => d.data.stepCounter),\n  stateSteps: funcDef('int', [['ivec2', 'entityCell']], `\n    int startStep = ${Casting.StateStartStep.sm.value}(entityCell);\n    return Self.time - startStep;\n  `),\n  castingProgress: funcDef('float', [['ivec2', 'entityCell']], `\n    int ability = ${Casting.Ability.sm.value}(entityCell);\n    int state = ${Casting.State.sm.value}(entityCell);\n    if (state != ${CastingState.Casting}) {\n      return 0.0;\n    }\n    return ${InterpolateSM.interpolateClamped}(float(Self.stateSteps(entityCell)),\n      0.0, float(${AbilitySM.castTime}[ability]),\n      0.0, 1.0\n    );\n  `),\n  performingProgress: funcDef('float', [['ivec2', 'entityCell']], `\n    int ability = ${Casting.Ability.sm.value}(entityCell);\n    int state = ${Casting.State.sm.value}(entityCell);\n    if (state != ${CastingState.Performing}) {\n      return 0.0;\n    }\n    return ${InterpolateSM.interpolateClamped}(float(Self.stateSteps(entityCell)),\n      0.0, float(${AbilitySM.duration}[ability]),\n      0.0, 1.0\n    );\n  `)\n})\n","export enum Sense {\n  Hitpoints,\n  Ability0Ready,\n\n  FriendStatueDistance,\n  FriendStatueAngle,\n  Friend1Distance,\n  Friend1Angle,\n  Friend2Distance,\n  Friend2Angle,\n\n  EnemyStatueDistance,\n  EnemyStatueAngle,\n  Enemy1Distance,\n  Enemy1Angle,\n  Enemy2Distance,\n  Enemy2Angle,\n  Enemy3Distance,\n  Enemy3Angle,\n\n  HasFocus,\n  FocusRelativeRotation,\n  FocusFacingUs,\n  FocusFocusingBack,\n  FocusHitpoints,\n  Ability1Ready,\n  Ability2Ready,\n  FocusDazed,\n  FocusCrippled,\n  HeightFront1,\n  HeightFront5,\n  HeightBack2,\n  PositionLeftRight,\n  PositionUpDown,\n  Stuck,\n}\nexport enum GymExtraSense {\n  HasTalons,\n  HasBloodClaws,\n  HasCleavers,\n  HasCripplers,\n  HasHealingGland,\n  HasVampireGland,\n  HasFrogLegs,\n  HasPistol,\n  HasMagnum,\n  HasBlaster,\n  HasParalyzingDart,\n  HasIronBubblegum,\n  HasHeliumBubblegum,\n  HasShell,\n  HasTrombone,\n\n  FocusHasTalons,\n  FocusHasBloodClaws,\n  FocusHasCleavers,\n  FocusHasCripplers,\n  FocusHasHealingGland,\n  FocusHasVampireGland,\n  FocusHasFrogLegs,\n  FocusHasPistol,\n  FocusHasMagnum,\n  FocusHasBlaster,\n  FocusHasParalyzingDart,\n  FocusHasIronBubblegum,\n  FocusHasHeliumBubblegum,\n  FocusHasShell,\n  FocusHasTrombone,\n}","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { CastingAbilityHelpers, Casting, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData } from \"./Abilities\";\nimport { TailAttachment, UnitCenterSM } from \"../ECS/UnitComponents\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, outDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { QuadLineSM } from \"../Renderer/Util\";\nimport { TransformHelpers } from \"../ECS/Transform\";\nimport { SingleTargetHeal } from \"../ECS/DamageCalc\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\nimport { StepsPerSecond } from \"../../Time\";\n\nexport class UpdateHealingGland {\n  constructor(private gls: GlState) {}\n\n  singleTargetHeal = new SingleTargetHeal(this.gls,\n    [abilitiesData.component[Abilities.HealingGland].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.HealingGland})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      hps: uniformDef('float', () => abilitiesData.get(Abilities.HealingGland, 'Settings').healing.value / StepsPerSecond),\n      hitpoints: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.hps;\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetHeal.run(state);\n  }\n}\n\nexport class HealingGlandRenderer {\n  constructor(private gls: GlState) {}\n\n  query = new EntitiesQuery([abilitiesData.component[Abilities.HealingGland].gpuComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'quad',\n      vertexShader: shaderModule([\n        QuadLineSM, CastingAbilityHelpers, Casting.Target.sm, TransformHelpers,\n        TailAttachment.sm, UnitCenterSM, abilitiesData.component[Abilities.HealingGland].sm,\n        UnitRef.sm,\n      ], {\n        viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          ivec2 unit = ${UnitRef.sm.value}(entityCell);\n          if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.HealingGland})) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          float progress = ${CastingAbilityHelpers.performingProgress}(unit);\n          float width = 0.4;\n          vec3 position = ${QuadLineSM.fromLineWithWidths}(\n            ${TransformHelpers.worldPosition}(${TailAttachment.sm.value}(unit)),\n            width + 0.2 * sin(progress * 10.0),\n            ${UnitCenterSM.center}(${Casting.Target.sm.value}(unit)),\n            width + 0.2 * cos(progress * 10.0)\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        main: funcDef('void', [], `\n          outColor = vec4(0, 1, 0, 1);\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n","import { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef, outDef, inDef } from \"../../GpuUtil/ShaderModule\";\nimport { CastingAbilityHelpers, Casting, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData } from \"./Abilities\";\nimport { IronBubbable, BubbleShader, HeliumBubbable, IronBubbleColor, HeliumBubbleColor } from \"../Buffs/Bubbles\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { LocalToWorld } from \"../ECS/Transform\";\nimport { MatrixSM, InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { HeadAttachment } from \"../ECS/UnitComponents\";\nimport { CullFace } from \"../Renderer/ModelRenderer\";\nimport { CastingState } from \"../StateLayout\";\nimport { GpuComponent } from \"../../GpuUtil/ECS\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\nimport { StepsPerSecond } from \"../../Time\";\n\nexport class UpdateIronBubblegum {\n  constructor(private gls: GlState) {}\n\n  arrows = new ArchetypesQuery([abilitiesData.component[Abilities.IronBubblegum].gpuComponent])\n    .updateGpu(this.gls, [IronBubbable.component], shaderModule([\n      CastingAbilityHelpers, Casting.Target.sm, IronBubbable.writer, UnitRef.sm\n    ], {\n      duration: uniformDef('int', () => abilitiesData.get(Abilities.IronBubblegum, 'Settings').duration.value * StepsPerSecond),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.IronBubblegum})) {\n          return ivec2(-1);\n        }\n        ${IronBubbable.writer.write}(Self.duration);\n        return ${Casting.Target.sm.value}(unit);\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.arrows.run(state);\n  }\n}\n\nexport class UpdateHeliumBubblegum {\n  constructor(private gls: GlState) {}\n\n  arrows = new ArchetypesQuery([abilitiesData.component[Abilities.HeliumBubblegum].gpuComponent])\n    .updateGpu(this.gls, [HeliumBubbable.component], shaderModule([\n      CastingAbilityHelpers, Casting.Target.sm, HeliumBubbable.writer, UnitRef.sm\n    ], {\n      duration: uniformDef('int', () => abilitiesData.get(Abilities.HeliumBubblegum, 'Settings').duration.value * StepsPerSecond),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.HeliumBubblegum})) {\n          return ivec2(-1);\n        }\n        ${HeliumBubbable.writer.write}(Self.duration);\n        return ${Casting.Target.sm.value}(unit);\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.arrows.run(state);\n  }\n}\n\nclass BubblegumRenderer {\n  constructor(private gls: GlState, private abilityComponent: GpuComponent, private ability: Abilities, private color: string) {}\n\n  private query = new EntitiesQuery([this.abilityComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'sphere',\n      vertexShader: shaderModule([\n        LocalToWorld.sm, MatrixSM, BubbleShader.vertex, UnitRef.sm,\n        HeadAttachment.sm, InterpolateSM, Casting.Ability.sm, Casting.State.sm, Casting.StateStartStep.sm\n      ], {\n        time: uniformDef('float', d => d.data.stepCounter),\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          ivec2 unit = ${UnitRef.sm.value}(entityCell);\n\n          int ability = ${Casting.Ability.sm.value}(unit);\n          int state = ${Casting.State.sm.value}(unit);\n\n          float scale = 0.5;\n          if (ability == ${this.ability} && state == ${CastingState.Casting}) {\n            float t = time - float(${Casting.StateStartStep.sm.value}(unit));\n            scale = 0.5 + t * 0.05;\n          } else if (ability == ${this.ability} && (state == ${CastingState.Performing} || state == ${CastingState.WindDown})) {\n            scale = 0.0;\n          } else {\n            float scaleMin = 0.5;\n            float scaleMax = 0.55;\n            scale = ${InterpolateSM.interpolate}(sin(time * 0.1), -1.0, 1.0, scaleMin, scaleMax);\n          }\n\n          ivec2 head = ${HeadAttachment.sm.value}(unit);\n          mat4 worldTransform = ${LocalToWorld.sm.value}(head) *\n            ${MatrixSM.translate}(vec3(0, 0.7, 0.8)) *\n            ${MatrixSM.scale}(vec3(scale));\n\n          ${BubbleShader.vertex.update}(worldTransform);\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        normal: inDef('vec3'),\n        main: funcDef('void', [], `\n          if (normal.z < -0.6) {\n            discard;\n          }\n          outColor = vec4(${this.color}, 1);\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    this.gls.enable(GL.CULL_FACE);\n    this.gls.cullFace(CullFace.Back);\n    this.gls.disable(GL.BLEND);\n    this.query.run(state);\n  }\n}\n\nexport class BubblegumsRenderer {\n  constructor(private gls: GlState) {}\n\n  bubblegums = [\n    new BubblegumRenderer(this.gls, abilitiesData.component[Abilities.IronBubblegum].gpuComponent, Abilities.IronBubblegum, IronBubbleColor),\n    new BubblegumRenderer(this.gls, abilitiesData.component[Abilities.HeliumBubblegum].gpuComponent, Abilities.HeliumBubblegum, HeliumBubbleColor),\n  ]\n\n  run(state: GpuWorldState) {\n    for (const r of this.bubblegums) {\n      r.run(state);\n    }\n  }\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { CastingAbilityHelpers, Casting, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData } from \"./Abilities\";\nimport { Hitpoints, MaxHitpoints, TailAttachment, UnitCenterSM } from \"../ECS/UnitComponents\";\nimport { ArchetypesQuery, EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, outDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { VisibleComponent } from \"../ECS/Components\";\nimport { QuadLineSM } from \"../Renderer/Util\";\nimport { TransformHelpers } from \"../ECS/Transform\";\nimport { SingleTargetDamage } from \"../ECS/DamageCalc\";\nimport { visibleCacheKeys } from \"../ECS/Visibility\";\nimport { StepsPerSecond } from \"../../Time\";\n\nexport class UpdateVampireGland {\n  constructor(private gls: GlState) {}\n\n  singleTargetDamage = new SingleTargetDamage(this.gls,\n    [abilitiesData.component[Abilities.VampireGland].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.VampireGland})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      dps: uniformDef('float', () => abilitiesData.get(Abilities.VampireGland, 'Settings').damage.value / StepsPerSecond),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.dps;\n      `)\n    }));\n\n  heal = new ArchetypesQuery([abilitiesData.component[Abilities.VampireGland].gpuComponent])\n    .updateGpu(this.gls, [Hitpoints.component], shaderModule([\n      CastingAbilityHelpers,\n      Hitpoints.writer,\n      Hitpoints.sm,\n      UnitRef.sm,\n    ], {\n      hps: uniformDef('float', () => abilitiesData.get(Abilities.VampireGland, 'Settings').healing.value / StepsPerSecond),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        float hitpoints = ${Hitpoints.sm.value}(unit);\n        if (${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.VampireGland})) {\n          hitpoints = clamp(hitpoints + Self.hps, 0.0, ${glslFloat(MaxHitpoints)});\n        }\n        ${Hitpoints.writer.write}(hitpoints);\n        return unit;\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetDamage.run(state);\n    this.heal.run(state);\n  }\n}\n\nexport class VampireGlandRenderer {\n  constructor(private gls: GlState) {}\n\n  query = new EntitiesQuery([abilitiesData.component[Abilities.VampireGland].gpuComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .render(this.gls, {\n      mesh: 'quad',\n      vertexShader: shaderModule([\n        QuadLineSM, CastingAbilityHelpers, Casting.Target.sm, TransformHelpers,\n        TailAttachment.sm, UnitCenterSM, abilitiesData.component[Abilities.VampireGland].sm,\n        UnitRef.sm,\n      ], {\n        viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n        shader: funcDef('void', [['ivec2', 'entityCell']], `\n          ivec2 unit = ${UnitRef.sm.value}(entityCell);\n          if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.VampireGland})) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          float progress = ${CastingAbilityHelpers.performingProgress}(unit);\n          float width = 0.4;\n          vec3 position = ${QuadLineSM.fromLineWithWidths}(\n            ${TransformHelpers.worldPosition}(${TailAttachment.sm.value}(unit)),\n            width + 0.2 * sin(progress * 10.0),\n            ${UnitCenterSM.center}(${Casting.Target.sm.value}(unit)),\n            width + 0.2 * cos(progress * 10.0)\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        `)\n      }),\n      fragmentShader: shaderModule([], {\n        outColor: outDef('vec4'),\n        main: funcDef('void', [], `\n          outColor = vec4(0, 0, 0, 1);\n        `)\n      })\n    });\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n","import { GpuBufferModule, GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { BrainOutputsKeys } from \"../StateLayout\";\nimport { keysOfEnum } from \"../../Util\";\nimport { Sense, GymExtraSense } from \"./SensesDef\";\n\nfunction createLayerComponents(name: string, conf: { weightsSlices: number, biasesSlices: number, outputSlices: number }) {\n  const weightsBuffer = new GpuBufferModule({\n    name: name + 'LayerWeightsBuffer',\n    format: 'vec4'\n  });\n  const biasesBuffer = new GpuBufferModule({\n    name: name + 'LayerBiasesBuffer',\n    format: 'float'\n  });\n  const resBuffer = new GpuBufferModule({\n    name: name + 'LayerResBuffer',\n    format: 'vec4'\n  });\n  return {\n    weights: new GpuComponentModule(\n      name + 'LayerWeights',\n      weightsBuffer.buffer,\n      'vec4',\n      conf.weightsSlices\n    ),\n    biases: new GpuComponentModule(\n      name + 'LayerBiases',\n      biasesBuffer.buffer,\n      'float',\n      conf.biasesSlices\n    ),\n    res: new GpuComponentModule(\n      name + 'LayerRes',\n      resBuffer.buffer,\n      'vec4',\n      conf.outputSlices\n    )\n  };\n}\n\n\nexport const SensesSlices = Math.ceil(keysOfEnum(Sense).length / 4)\nexport const MemorySlices = 8;\nexport const HiddenAndMemoryInputSlices = SensesSlices + MemorySlices;\n\nexport const HiddenLayerLayout = new class {\n  inputSlices = HiddenAndMemoryInputSlices;\n  outputSlices = 8;\n  outputs = this.outputSlices * 4;\n  weightsSlices = this.inputSlices * this.outputs;\n  weights = this.weightsSlices * 4;\n  biasesSlices = this.outputs;\n}();\n\nexport const MemoryLayerLayout = new class {\n  inputSlices = HiddenAndMemoryInputSlices;\n  outputSlices = MemorySlices;\n  outputs = this.outputSlices * 4;\n  weightsSlices = this.inputSlices * this.outputs;\n  weights = this.weightsSlices * 4;\n  biasesSlices = this.outputs;\n}();\n\nexport const OutputLayerLayout = new class {\n  // Only use half of the hidden state as input (half is in the memory layer)\n  inputSlices = HiddenLayerLayout.outputSlices;\n  outputSlices = Math.ceil(BrainOutputsKeys.length / 4);\n  outputs = this.outputSlices * 4;\n  weightsSlices = this.inputSlices * this.outputs;\n  weights = this.weightsSlices * 4;\n  biasesSlices = this.outputs;\n}();\n\nexport const MemoryLayer = createLayerComponents('Memory', MemoryLayerLayout);\nexport const HiddenLayer = createLayerComponents('Hidden', HiddenLayerLayout);\nexport const OutputLayer = createLayerComponents('Output', OutputLayerLayout);\n\nconst SensesBuffer = new GpuBufferModule({\n  name: 'SensesBuffer',\n  format: 'vec4'\n});\nexport const Senses = new GpuComponentModule(\n  'Senses',\n  SensesBuffer,\n  'vec4',\n  SensesSlices,\n);\nexport const GymExtraSensesSlices = Math.ceil(keysOfEnum(GymExtraSense).length / 4)\nexport const GymExtraSenses = new GpuComponentModule(\n  'GymExtraSenses',\n  SensesBuffer,\n  'vec4',\n  GymExtraSensesSlices,\n);\n","import { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { shaderModule, funcDef, outDef, CompiledShaderModule, uniformDef, inDef } from \"../../GpuUtil/ShaderModule\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { OutputLayer, Senses } from \"../Brain/Components\";\nimport { InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { Program } from \"../../GpuUtil/Program\";\nimport { GpuWorldState } from \"../State\";\nimport { RenderTarget } from \"../../GpuUtil/RenderTarget\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { vec2FromSize, interpolateClamped } from \"../../Math/Math\";\nimport { Hitpoints } from \"../ECS/UnitComponents\";\nimport { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { TextureSlicing, Texture } from \"../../GpuUtil/Texture\";\n\nclass UpdateBrainHistogram {\n  constructor(private gls: GlState, private component: GpuComponentModule<'vec4'>) {}\n\n  shader = new CompiledShaderModule(shaderModule([\n    UnitsInArena, this.component.sm, InterpolateSM, this.component.hasComponentSM, Hitpoints.sm\n  ], {\n    outValues: outDef('vec4[8]'),\n    nArenas: uniformDef('int', d => d.layout.arenas),\n    main: funcDef('void', [], `\n      vec4 values[8];\n      int arenaMemberIndex = int(gl_FragCoord.x);\n      int decision = int(gl_FragCoord.y);\n      float nAlive = 0.;\n      for (int i=0; i < Self.nArenas; i++) {\n        ivec2 unit = ${UnitsInArena.unit}(i, arenaMemberIndex);\n        if (unit.x >= 0 && ${this.component.hasComponentSM.value}(unit) && ${Hitpoints.sm.value}(unit) > 0.) {\n          vec4 outputSlice = ${this.component.sm.value}(unit, decision / 4);\n          float decisionValue = outputSlice[decision % 4];\n          float bucketFloat = ${InterpolateSM.interpolateClamped}(decisionValue, -1., 1., 0., 32.);\n          int bucket = clamp(int(bucketFloat), 0, 31);\n          nAlive++;\n          values[bucket / 4][bucket % 4]++;\n        }\n      }\n      for (int i=0; i < 32; i++) {\n        values[i / 4][i % 4] /= nAlive;\n      }\n      outValues = values;\n    `)\n  }));\n  program = new Program(this.gls, this.shader.source);\n  renderTarget = new RenderTarget(this.gls);\n\n  run(state: GpuWorldState, slice: TextureSlicing) {\n    this.shader.updateUniformValues(state);\n    this.renderTarget.set(slice);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.gls.prepareForComputation(slice.rect);\n    this.gls.drawQuad(this.program);\n  }\n}\n\nexport class UpdateBrainHistograms {\n  constructor(private gls: GlState) {}\n\n  senses = new UpdateBrainHistogram(this.gls, Senses);\n  decisions = new UpdateBrainHistogram(this.gls, OutputLayer.res);\n\n  run(state: GpuWorldState) {\n    if (state.data.showSensesHistogram) {\n      this.senses.run(state, state.textures.sensesHistogram.sliceAll());\n    }\n    if (state.data.showDecisionsHistogram) {\n      this.decisions.run(state, state.textures.decisionsHistogram.sliceAll());\n    }\n  }\n}\n\nclass BrainHistogramRenderer {\n  constructor(private gls: GlState) {}\n\n  vertexShader = new CompiledShaderModule(shaderModule([\n    Vertex, InterpolateSM\n  ], {\n    texcoord: outDef('vec2'),\n    corners: uniformDef('vec4'),\n    main: funcDef('void', [], `\n      gl_Position = vec4(\n        ${InterpolateSM.interpolate}(${Vertex.position}.xy, vec2(-1.), vec2(1.), corners.xy, corners.zw),\n        0.,\n        1.\n      );\n      texcoord = (${Vertex.position}.xy + 1.0) / 2.0;\n    `)\n  }));\n\n  fragmentShader = new CompiledShaderModule(shaderModule([\n    Vertex\n  ], {\n    texcoord: inDef('vec2'),\n    outColor: outDef('vec4'),\n    histogram: uniformDef('sampler2DArray'),\n    histogramSize: uniformDef('vec2'),\n    main: funcDef('void', [], `\n      vec2 histogramCell = texcoord * Self.histogramSize;\n      int arenaMemberIndex = int(histogramCell.x);\n      int decision = int(histogramCell.y);\n      int bucket = int(32. * mod(histogramCell.x, 1.));\n      float y = 1. - mod(histogramCell.y, 1.);\n      vec4 bucketSlice = texelFetch(Self.histogram, ivec3(arenaMemberIndex, decision, bucket / 4), 0);\n      float bucketPerc = bucketSlice[bucket % 4];\n      vec3 background;\n      if (arenaMemberIndex % 2 == 0) {\n        background += 0.1;\n      }\n      if (decision % 2 == 0) {\n        background += 0.1;\n      }\n      outColor = y < bucketPerc ? vec4(1) : vec4(background, 1);\n    `)\n  }));\n\n  program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n\n  run(state: GpuWorldState, histogram: Texture, rect: ClientRect) {\n    const corners = {\n      x: interpolateClamped(rect.left, 0, state.data.canvasRect.width, -1, 1),\n      y: interpolateClamped(rect.top, 0, state.data.canvasRect.height, 1, -1),\n      z: interpolateClamped(rect.left + rect.width, 0, state.data.canvasRect.width, -1, 1),\n      w: interpolateClamped(rect.top + rect.height, 0, state.data.canvasRect.height, 1, -1),\n    }\n\n    this.vertexShader.updateUniformValues(state);\n    this.fragmentShader.updateUniformValues(state);\n    this.program.prepare();\n    this.vertexShader.writeUniforms(this.program);\n    this.fragmentShader.writeUniforms(this.program);\n    this.program.setUniform('histogram', 'sampler2DArray', histogram);\n    this.program.setUniform('histogramSize', 'vec2', vec2FromSize(histogram.size));\n    this.program.setUniform('corners', 'vec4', corners);\n    this.gls.disable(GL.DEPTH_TEST);\n    this.gls.disable(GL.BLEND);\n    this.gls.drawQuad(this.program);\n  }\n}\n\nexport class BrainHistogramsRenderer {\n  constructor(private gls: GlState) {}\n  renderer = new BrainHistogramRenderer(this.gls);\n  run(state: GpuWorldState) {\n    if (state.data.showDecisionsHistogram) {\n      this.renderer.run(state, state.textures.decisionsHistogram, state.data.decisionHistogramView);\n    }\n    if (state.data.showSensesHistogram) {\n      this.renderer.run(state, state.textures.sensesHistogram, state.data.sensesHistogramView);\n    }\n  }\n}","import { GlState, GL } from \"../../GpuUtil/GlState\";\nimport { CompiledShaderModule, shaderModule, outDef, uniformDef, funcDef, inDef } from \"../../GpuUtil/ShaderModule\";\nimport { Vertex, Mesh } from \"../../GpuUtil/Mesh\";\nimport { MatrixSM, InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { Program } from \"../../GpuUtil/Program\";\nimport { GpuWorldState } from \"../State\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { BrainOutputsKeys, ArenaMembersSize } from \"../StateLayout\";\nimport { OutputLayer } from \"../Brain/Components\";\nimport { RenderTarget } from \"../../GpuUtil/RenderTarget\";\nimport * as THREE from 'three';\nimport { glslVec2 } from \"../../GpuUtil\";\nimport { Position } from \"../ECS/Transform\";\n\nexport const DecisionsVizHistory = 24;\n\nexport class UpdateDecisionsViz {\n  constructor(private gls: GlState) {}\n\n  shader = new CompiledShaderModule(shaderModule([\n    UnitsInArena, OutputLayer.res.sm, OutputLayer.res.hasComponentSM\n  ], {\n    outValue: outDef('float'),\n    renderArena: uniformDef('int', d => d.data.renderArena),\n    decisionsViz: uniformDef('sampler2D', d => d.textures.decisionsViz),\n    main: funcDef('void', [], `\n      int history = int(gl_FragCoord.x);\n      int arenaMemberIndex = int(gl_FragCoord.y) / ${BrainOutputsKeys.length};\n      int brainOutput = int(gl_FragCoord.y) % ${BrainOutputsKeys.length};\n      if (history == 0) {\n        ivec2 unit = ${UnitsInArena.unit}(renderArena, arenaMemberIndex);\n        if (${OutputLayer.res.hasComponentSM.value}(unit)) {\n          vec4 outputSlice = ${OutputLayer.res.sm.value}(unit, brainOutput / 4);\n          outValue = outputSlice[brainOutput % 4];\n        } else {\n          outValue = 0.;\n        }\n      } else {\n        outValue = texelFetch(Self.decisionsViz, ivec2(gl_FragCoord) - ivec2(1, 0), 0).x;\n      }\n    `)\n  }));\n  program = new Program(this.gls, this.shader.source);\n  renderTarget = new RenderTarget(this.gls);\n\n  run(state: GpuWorldState) {\n    if (!state.data.showDecisionsViz) {\n      return;\n    }\n    const slice = state.textures.decisionsViz.sliceAll();\n    this.shader.updateUniformValues(state);\n    this.renderTarget.set(slice.back);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.gls.prepareForComputation(slice.rect);\n    this.gls.drawQuad(this.program);\n    this.gls.getCopyLayers().copyBackToFront(slice);\n  }\n}\n\nexport class DecisionsVizRenderer {\n  constructor(private gls: GlState) {}\n\n  gridSize = { x: DecisionsVizHistory - 1, y: BrainOutputsKeys.length - 1 };\n  grid = Mesh.fromThree(this.gls, new THREE.PlaneBufferGeometry(1, 1,\n    this.gridSize.x, this.gridSize.y));\n\n  vertexShader = new CompiledShaderModule(shaderModule([\n    Vertex, MatrixSM, InterpolateSM, UnitsInArena, Position.sm, OutputLayer.res.hasComponentSM\n  ], {\n    decisionsViz: uniformDef('sampler2D', d => d.textures.decisionsViz),\n    viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n    renderArena: uniformDef('int', d => d.data.renderArena),\n    color: outDef('vec4'),\n    main: funcDef('void', [], `\n      int arenaMemberIndex = gl_InstanceID;\n      ivec2 unit = ${UnitsInArena.unit}(renderArena, arenaMemberIndex);\n      if (!${OutputLayer.res.hasComponentSM.value}(unit)) {\n        gl_Position = vec4(-1);\n        return;\n      }\n      ivec2 read = ivec2((vec2(${Vertex.position}.x, -${Vertex.position}.y) + 0.5) * ${glslVec2({ x: DecisionsVizHistory, y: BrainOutputsKeys.length })}) +\n        ivec2(0, arenaMemberIndex * ${BrainOutputsKeys.length});\n      float value = texelFetch(Self.decisionsViz, read, 0).x;\n      vec3 position = ${Position.sm.value}(unit) + vec3(0, -2, 0.2);\n      gl_Position = viewProjection * ${MatrixSM.translateScale}(position, vec3(2, 2, 0.3)) * vec4(${Vertex.position}.xy, value, 1);\n      color = vec4(${InterpolateSM.interpolateClamped}(value, -1., 1., vec3(1., 0.1, 0.2), vec3(0.3, 1., 0.4)), 1);\n    `)\n  }));\n\n  fragmentShader = new CompiledShaderModule(shaderModule([\n  ], {\n    outColor: outDef('vec4'),\n    color: inDef('vec4'),\n    main: funcDef('void', [], `\n      outColor = color;\n    `)\n  }));\n\n  program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n\n  run(state: GpuWorldState) {\n    if (!state.data.showDecisionsViz) {\n      return;\n    }\n\n    this.vertexShader.updateUniformValues(state);\n    this.fragmentShader.updateUniformValues(state);\n    this.program.prepare();\n    this.vertexShader.writeUniforms(this.program);\n    this.fragmentShader.writeUniforms(this.program);\n    this.gls.enable(GL.DEPTH_TEST);\n    this.gls.disable(GL.BLEND);\n    this.gls.draw(this.program, this.grid, ArenaMembersSize);\n  }\n}\n","import { GlState, GL, TextureFiltering } from \"../../GpuUtil/GlState\";\nimport { CompiledShaderModule, shaderModule, funcDef, outDef, uniformDef, inDef } from \"../../GpuUtil/ShaderModule\";\nimport { Program, Sampler } from \"../../GpuUtil/Program\";\nimport { GpuWorldState } from \"../State\";\nimport { Vertex } from \"../../GpuUtil/Mesh\";\nimport { loadImage } from \"../../GpuUtil\";\nimport { Texture } from \"../../GpuUtil/Texture\";\nimport LogoPng from '../../Images/AICrowdLogo.png';\nimport { MathConstsSM, MatrixSM } from \"../../GpuUtil/SM2Utils\";\n\nconst Logo = loadImage(LogoPng);\n\nexport class AICrowdLogoRenderer {\n  constructor(private gls: GlState) {\n    Logo.then(img => {\n      this.logoTexture = Texture.fromImage(gls, img);\n      this.logoTexture.generateMipmap();\n      this.logoSampler = new Sampler(this.logoTexture, TextureFiltering.LinearMipMap);\n    });\n  }\n  destroy() {\n    this.logoTexture?.destroy();\n  }\n\n  logoTexture?: Texture;\n  logoSampler?: Sampler;\n\n  vertexShader = new CompiledShaderModule(shaderModule([\n    Vertex, MatrixSM, MathConstsSM\n  ], {\n    texcoord: outDef('vec2'),\n    worldSize: uniformDef('vec2', d => d.derived.worldSize),\n    projectionViewMatrix: uniformDef('mat4', d => d.derived.cameraProjectionView),\n    main: funcDef('void', [], `\n      texcoord = ${Vertex.texcoord};\n      texcoord.y = 1. - texcoord.y;\n      gl_Position = projectionViewMatrix * ${MatrixSM.translate}(vec3(worldSize / 2. - 0.7, 3.)) * ${MatrixSM.rotateZ}(${MathConstsSM.PI} / 4.) * vec4(${Vertex.position}.x * 2.3, ${Vertex.position}.y * ${2.3 * 24/126}, 0., 1.0);\n    `)\n  }));\n  fragmentShader = new CompiledShaderModule(shaderModule([\n  ], {\n    outColor: outDef('vec4'),\n    texcoord: inDef('vec2'),\n    logo: uniformDef('sampler2D', d => this.logoSampler!),\n    main: funcDef('void', [], `\n      outColor = texture(logo, texcoord);\n      if (outColor.a < 2.0/255.0) {\n        discard;\n      }\n    `)\n  }));\n  program = new Program(this.gls, this.fragmentShader.source, this.vertexShader.source);\n\n  run(state: GpuWorldState) {\n    if (!state.data.aiCrowdLogo) {\n      return;\n    }\n    this.vertexShader.updateUniformValues(state);\n    this.fragmentShader.updateUniformValues(state);\n    this.program.prepare();\n    this.vertexShader.writeUniforms(this.program);\n    this.fragmentShader.writeUniforms(this.program);\n    this.gls.depthMask(false);\n    this.gls.enable(GL.DEPTH_TEST);\n    this.gls.disable(GL.BLEND);\n    this.gls.blendFuncSeparate(GL.SRC_ALPHA, GL.ONE_MINUS_SRC_ALPHA, GL.ONE, GL.ONE_MINUS_SRC_ALPHA); // https://limnu.com/webgl-blending-youre-probably-wrong/\n    this.gls.disable(GL.CULL_FACE);\n    this.gls.drawQuad(this.program);\n  }\n\n}","export default \"data:image/png;base64,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\"","import { GpuWorldState } from \"../../GpuWorld/State\";\nimport { OverheadBarsRenderer } from \"./OverheadBarsRenderer\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ModelRenderer } from \"./ModelRenderer\";\nimport { GazeRenderer } from \"./Visualization\";\nimport { UpdateAnimations } from \"../ECS/Animation\";\nimport { UpdateTransform } from \"../ECS/Transform\";\nimport { UpdateVisible } from \"../ECS/Visibility\";\nimport { BubblesRenderer } from \"../Buffs/Bubbles\";\nimport { DazeableRenderer } from \"../Buffs/Daze\";\nimport { HealingGlandRenderer } from \"../Abilities/HealingGland\";\nimport { BubblegumsRenderer } from \"../Abilities/Bubblegums\";\nimport { VampireGlandRenderer } from \"../Abilities/VampireGland\";\nimport { UpdateBrainHistograms, BrainHistogramsRenderer } from \"../Tools/BrainHistograms\";\nimport { DecisionsVizRenderer } from \"./DecisionsViz\";\nimport { UpdateCameraMatrices } from \"../ECS/Camera\";\nimport { AICrowdLogoRenderer } from \"./AICrowdLogo\";\n// import { SkyRenderer } from \"./Sky\";\n\nclass AbilityEffectsRenderer {\n  constructor(private gls: GlState) {}\n\n  effects = [\n    new HealingGlandRenderer(this.gls),\n    new VampireGlandRenderer(this.gls),\n    new BubblegumsRenderer(this.gls),\n  ]\n\n  run(state: GpuWorldState) {\n    for (const eff of this.effects) {\n      eff.run(state);\n    }\n  }\n}\n\nexport class GpuWorldRenderer {\n  constructor(private gls: GlState) {\n    console.log('Renderer initialized');\n  }\n  destroyed = false;\n  destroy() {\n    console.log('Destroying renderer');\n    this.destroyed = true;\n  }\n\n  systems = [\n    new UpdateVisible(),\n    new UpdateAnimations(),\n    new UpdateTransform(this.gls),\n    new UpdateCameraMatrices(),\n    new UpdateBrainHistograms(this.gls),\n  ]\n\n  renderers = [\n    new ModelRenderer(this.gls),\n    new AICrowdLogoRenderer(this.gls),\n    new DecisionsVizRenderer(this.gls),\n    new DazeableRenderer(this.gls),\n    new BubblesRenderer(this.gls),\n    new AbilityEffectsRenderer(this.gls),\n    new GazeRenderer(this.gls),\n    new OverheadBarsRenderer(this.gls),\n    new BrainHistogramsRenderer(this.gls),\n    // new SkyRenderer(this.gls),\n  ]\n\n  render(state: GpuWorldState) {\n\n    for (const system of this.systems) {\n      system.run(state);\n    }\n\n    const canvasSize = state.data.canvasRect;\n    const opts = state.data.rendererConfig;\n\n    const gl = this.gls.gl;\n\n    this.gls.framebuffer = null;\n\n    this.gls.viewport = { x: 0, y: 0, width: canvasSize.width, height: canvasSize.height };\n\n    this.gls.depthMask(true);\n    gl.clearColor(opts.clearColor.r/255, opts.clearColor.g/255, opts.clearColor.b/255, opts.clearColor.a);\n    // tslint:disable-next-line:no-bitwise\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    for (const renderer of this.renderers) {\n      renderer.run(state);\n    }\n\n  }\n\n}\n\nexport function setCanvasSizeToElementSize(state: GpuWorldState) {\n  const canvasRect = state.gls.canvas.getBoundingClientRect();\n  state.gls.canvas.width = canvasRect.width;\n  state.gls.canvas.height = canvasRect.height;\n  if (state.data.canvasRect.width !== canvasRect.width ||\n    state.data.canvasRect.height !== canvasRect.height ||\n    state.data.canvasRect.left !== canvasRect.left ||\n    state.data.canvasRect.right !== canvasRect.right ||\n    state.data.canvasRect.bottom !== canvasRect.bottom ||\n    state.data.canvasRect.top !== canvasRect.top) {\n    state.setData({ canvasRect });\n  }\n}","import { shaderModule, uniformDef, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { vec2FromSize } from \"../../Math/Math\";\n\nexport const GroundHeightSM = shaderModule('GroundHeight', [], {\n  heightmap: uniformDef('sampler2D', d => d.textures.heightmap),\n  heightmapSize: uniformDef('vec2', d => vec2FromSize(d.textures.heightmap.size)),\n  worldSize: uniformDef('ivec2', d => d.derived.worldSize),\n  atCoord: funcDef('float', [['vec2', 'worldCoord']], `\n    return 59.1 + texelFetch(Self.heightmap, ivec2(worldCoord * Self.heightmapSize), 0).x;\n  `),\n  atPosition: funcDef('float', [['vec2', 'position']], `\n    return Self.atCoord(position / vec2(Self.worldSize));\n  `),\n})\n\nexport const GroundNormalSM = shaderModule('GroundNormal', [], {\n  normalmap: uniformDef('sampler2D', d => d.textures.normalmap),\n  normalmapSize: uniformDef('vec2', d => vec2FromSize(d.textures.normalmap.size)),\n  worldSize: uniformDef('ivec2', d => d.derived.worldSize),\n  atCoord: funcDef('vec3', [['vec2', 'worldCoord']], `\n    return texelFetch(Self.normalmap, ivec2(worldCoord * Self.normalmapSize), 0).xyz;\n  `),\n  atPosition: funcDef('vec3', [['vec2', 'position']], `\n    return Self.atCoord(position / vec2(Self.worldSize));\n  `),\n})\n","import { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { UnitBuffer } from \"../ECS/UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { GpuWorldState } from \"../State\";\n\nexport const Crippleable = new GpuComponentModule('Crippleable', UnitBuffer, 'int');\n\nexport class UpdateCrippleBuff {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([Crippleable.component])\n    .mapGpu(this.gls, Crippleable.component, shaderModule([], {\n      map: funcDef('int', [['ivec2', 'entityCell'], ['int', 'value']], `\n        return max(0, value - 1);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n","import { shaderModule, constDef, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { Teams, SideSize, ArenaMembersSize } from \"../StateLayout\";\n\nexport const UnitFocusables = shaderModule('BrainFocusables', [UnitsInArena], {\n  size: constDef('int', `${ArenaMembersSize - 1}`),\n  get: funcDef(`ivec3[${ArenaMembersSize - 1}]`, [['ivec2', 'entityCell'], ['int', 'selfTeam'], ['int', 'arenaIndex']], `\n    ivec3 res[${ArenaMembersSize - 1}];\n    int r=0;\n    for (int i=0; i < ${UnitsInArena.size}; i++) {\n      int l = selfTeam == ${Teams.HomeTeam} ? i : ((i + ${SideSize}) % ${ArenaMembersSize});\n      ivec2 unit = ${UnitsInArena.unit}(arenaIndex, l);\n      if (unit == entityCell) {\n        continue;\n      }\n      if (unit.x < 0) {\n        unit = ${UnitsInArena.unit}(arenaIndex, (l / ${SideSize}) * ${SideSize});\n      }\n      res[r++] = ivec3(unit, l);\n    }\n    return res;\n  `)\n})\n","import { Focuser, MaxFocusDistance, Stuck } from \"../ECS/UnitComponents\";\nimport { Position, RotationZ } from \"../ECS/Transform\";\nimport { Hitpoints, Team, MaxHitpoints, WorthPoints } from \"../ECS/UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { GpuWorldState } from \"../State\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { SpatialSM, MathConstsSM, WithoutNaNInfSM } from \"../../GpuUtil/SM2Utils\";\nimport { Senses, SensesSlices, GymExtraSenses, GymExtraSensesSlices } from \"./Components\";\nimport { Dazeable } from \"../Buffs/Daze\";\nimport { GroundHeightSM } from \"../ECS/Ground\";\nimport { Crippleable } from \"../Buffs/Cripple\";\nimport { Teams } from \"../StateLayout\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { ArenaInstance } from \"../ECS/Components\";\nimport { Casting, UnitAbilities, Abilities } from \"../Abilities/Abilities\";\nimport { UnitFocusables } from \"./UnitFocusables\";\nimport { Sense } from \"./SensesDef\";\nimport { keysOfEnum } from \"../../Util\";\n\nexport class UpdateSenses {\n  constructor(private gls: GlState) {}\n\n  private get(sense: Sense) {\n    return `values[${Math.floor(sense / 4)}][${sense % 4}]`;\n  }\n  query = new ArchetypesQuery([Senses.component])\n    .updateGpu(this.gls, [Senses.component], shaderModule([\n      Focuser.sm,\n      Hitpoints.sm,\n      Casting.Cooldowns.sm,\n      Senses.writer,\n      Position.sm,\n      SpatialSM,\n      Team.sm,\n      RotationZ.sm,\n      Dazeable.sm,\n      Crippleable.sm,\n      GroundHeightSM,\n      MathConstsSM,\n      WorthPoints.sm,\n      UnitsInArena,\n      ArenaInstance.sm,\n      Stuck.sm,\n      UnitFocusables,\n      WithoutNaNInfSM\n    ], {\n\n      mapCenter: uniformDef('vec2', d => ({ x: d.data.worldSize.width / 2, y: d.data.worldSize.width / 2 })),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        ivec2 focus = ${Focuser.sm.value}(entityCell);\n        vec3 position = ${Position.sm.value}(entityCell);\n        float rotation = ${RotationZ.sm.value}(entityCell);\n        vec2 forward = ${SpatialSM.forward}(rotation);\n        int selfTeam = ${Team.sm.value}(entityCell);\n\n        vec4 values[${SensesSlices}];\n        ${this.get(Sense.Hitpoints)} = clamp(${Hitpoints.sm.value}(entityCell) / ${glslFloat(MaxHitpoints)}, 0.0, 1.0);\n        ${this.get(Sense.Ability0Ready)} = ${Casting.Cooldowns.sm.value}(entityCell, 0) == 0 ? 1. : 0.;\n        ${this.get(Sense.Ability1Ready)} = ${Casting.Cooldowns.sm.value}(entityCell, 1) == 0 ? 1. : 0.;\n        ${this.get(Sense.Ability2Ready)} = ${Casting.Cooldowns.sm.value}(entityCell, 2) == 0 ? 1. : 0.;\n        bool hasFocus = focus.x >= 0;\n        ${this.get(Sense.HasFocus)} = float(hasFocus);\n\n        int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n        ivec3[] brainFocusables = ${UnitFocusables.get}(entityCell, selfTeam, arenaIndex);\n        int distanceI = ${Sense.FriendStatueDistance};\n        int angleI = ${Sense.FriendStatueAngle};\n        for (int i=0; i < ${UnitFocusables.size}; i++) {\n          ivec2 unit = brainFocusables[i].xy;\n          vec3 unitPosition = ${Position.sm.value}(unit);\n          bool isAlive = ${Hitpoints.sm.value}(unit) > 0.;\n          if (isAlive) {\n            values[distanceI / 4][distanceI % 4] = clamp(distance(position, unitPosition) / ${glslFloat(MaxFocusDistance)}, 0.0, 1.0);\n            values[angleI / 4][angleI % 4] = ${WithoutNaNInfSM.withoutNaNInf}(\n              ${SpatialSM.angleToPosition}(position.xy, forward, unitPosition.xy) / ${MathConstsSM.PI}\n            );\n          } else {\n            values[distanceI / 4][distanceI % 4] = 2.;\n            values[angleI / 4][angleI % 4] = 0.;\n          }\n          distanceI += 2;\n          angleI += 2;\n        }\n\n\n        if (hasFocus) {\n          vec3 focusPosition = ${Position.sm.value}(focus);\n          float focusRotation = ${RotationZ.sm.value}(focus);\n          vec2 focusForward = ${SpatialSM.forward}(focusRotation);\n\n          ${this.get(Sense.FocusRelativeRotation)} = ${WithoutNaNInfSM.withoutNaNInf}(\n            ${SpatialSM.relativeRotationTo}(forward, focusForward) / ${MathConstsSM.PI}\n          );\n          ${this.get(Sense.FocusFacingUs)} = ${WithoutNaNInfSM.withoutNaNInf}(\n            ${SpatialSM.facingUs}(position.xy, focusPosition.xy, focusForward)\n          );\n\n          ivec2 focusOfFocus = ${Focuser.sm.value}(focus);\n          ${this.get(Sense.FocusFocusingBack)} = (focusOfFocus == entityCell ? 1.0 : 0.0);\n\n          int focusTeam = ${Team.sm.value}(focus);\n          ${this.get(Sense.FocusHitpoints)} = clamp(${Hitpoints.sm.value}(focus) / ${glslFloat(MaxHitpoints)}, 0.0, 1.0);\n          ${this.get(Sense.FocusDazed)} = ${Dazeable.sm.value}(focus) > 0 ? 1.0 : 0.0;\n          ${this.get(Sense.FocusCrippled)} = ${Crippleable.sm.value}(focus) > 0 ? 1.0 : 0.0;\n        }\n        float heightFront2 = ${GroundHeightSM.atPosition}(position.xy + forward * 1.);\n        ${this.get(Sense.HeightFront1)} = ${WithoutNaNInfSM.withoutNaNInf}(\n          tanh(heightFront2 - position.z)\n        );\n        float heightFront7 = ${GroundHeightSM.atPosition}(position.xy + forward * 5.);\n        ${this.get(Sense.HeightFront5)} = ${WithoutNaNInfSM.withoutNaNInf}(\n          tanh(heightFront7 - position.z)\n        );\n        float heightBack2 = ${GroundHeightSM.atPosition}(position.xy - forward * 2.);\n        ${this.get(Sense.HeightBack2)} = ${WithoutNaNInfSM.withoutNaNInf}(\n          tanh(heightBack2 - position.z)\n        );\n\n        vec2 mapUp = selfTeam == ${Teams.HomeTeam} ? normalize(vec2(1, 1)) : -normalize(vec2(1, 1));\n        vec2 mapRight = selfTeam == ${Teams.HomeTeam} ? normalize(vec2(1, -1)) : normalize(vec2(-1, 1));\n        vec2 positionD = position.xy - mapCenter;\n        ${this.get(Sense.PositionUpDown)} = dot(positionD, mapUp) / length(mapCenter);\n        ${this.get(Sense.PositionLeftRight)} = dot(positionD, mapRight) / length(mapCenter);\n\n        ${this.get(Sense.Stuck)} = ${Stuck.sm.value}(entityCell) ? 1. : 0.;\n\n        ${Senses.writer.write}(values);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nexport class UpdateGymExtraSenses {\n  constructor(private gls: GlState) {}\n\n  query = new ArchetypesQuery([GymExtraSenses.component])\n    .updateGpu(this.gls, [GymExtraSenses.component], shaderModule([\n      Focuser.sm,\n      GymExtraSenses.writer,\n      UnitAbilities.sm\n    ], {\n\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        ivec2 focus = ${Focuser.sm.value}(entityCell);\n\n        int ability0 = ${UnitAbilities.sm.value}(entityCell, 0);\n        int ability1 = ${UnitAbilities.sm.value}(entityCell, 1);\n        int ability2 = ${UnitAbilities.sm.value}(entityCell, 2);\n\n        vec4 values[${GymExtraSensesSlices}];\n        int i=0;\n        ${keysOfEnum(Abilities).slice(1).map(ability => `\n        values[i / 4][i % 4] = float(ability0 == ${Abilities[ability]} ||\n          ability1 == ${Abilities[ability]} ||\n          ability2 == ${Abilities[ability]});\n        i++;\n        `).join('\\n')}\n\n        if (focus.x >= 0) {\n          int focusAbility0 = ${UnitAbilities.sm.value}(focus, 0);\n          int focusAbility1 = ${UnitAbilities.sm.value}(focus, 1);\n          int focusAbility2 = ${UnitAbilities.sm.value}(focus, 2);\n\n          ${keysOfEnum(Abilities).slice(1).map(ability => `\n          values[i / 4][i % 4] = float(focusAbility0 == ${Abilities[ability]} ||\n            focusAbility1 == ${Abilities[ability]} ||\n            focusAbility2 == ${Abilities[ability]});\n          i++;\n          `).join('\\n')}\n        }\n\n        ${GymExtraSenses.writer.write}(values);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    if (state.data.gameInstance.type === 'gym') {\n      this.query.run(state);\n    }\n  }\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { UpdateSenses, UpdateGymExtraSenses } from \"./Senses\";\nimport { Hitpoints } from \"../ECS/UnitComponents\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { WithoutNaNInfSM } from \"../../GpuUtil/SM2Utils\";\nimport { HiddenLayerLayout, HiddenLayer, OutputLayerLayout, OutputLayer, Senses, MemoryLayer, HiddenAndMemoryInputSlices, SensesSlices, MemorySlices, MemoryLayerLayout } from \"./Components\";\nimport { GpuComponentReader } from \"../../GpuUtil/ECS/GpuComponentSM\";\nimport { UpdateDecisionsViz } from \"../Renderer/DecisionsViz\";\n\nfunction DenseLayerSM2(weights: GpuComponentReader, biases: GpuComponentReader, nInputSlices: number, nOutputSlices: number, activation: boolean) {\n  return shaderModule('DenseLayer', [\n    WithoutNaNInfSM,\n    weights,\n    biases\n  ], {\n    calcNeuron: funcDef('float', [['int', 'outputIndex'], ['vec4', `inputs[${nInputSlices}]`], ['ivec2', 'entityCell']], `\n      float v = 0.0;\n      for (int i=0; i < ${nInputSlices}; i++) {\n        vec4 weight = ${weights.value}(entityCell, outputIndex * ${nInputSlices} + i);\n        v += dot(inputs[i], weight);\n      }\n      float bias = ${biases.value}(entityCell, outputIndex);\n      return v + bias;\n    `),\n    runLayer: funcDef(`void`, [[`vec4[${nInputSlices}]`, 'inputs'], ['ivec2', 'entityCell']], `\n      ${new Array(nOutputSlices).fill(0).map((_, outputSlice) => `{\n        for (int l=0; l < 4; l++) {\n          int outputIndex = ${outputSlice * 4} + l;\n          float value = Self.calcNeuron(outputIndex, inputs, entityCell);\n          value = ${activation ? 'tanh(value)' : 'value'};\n          value = clamp(value, -10.0, 10.0);\n          value = ${WithoutNaNInfSM.withoutNaNInf}(value);\n          outValues[${outputSlice}][l] = value;\n        }\n      }`).join('\\n')}\n    `)\n  })\n}\n\nconst BrainRunningSM2 = shaderModule([Hitpoints.sm], {\n  running: funcDef('bool', [['ivec2', 'entityCell']], `\n    return ${Hitpoints.sm.value}(entityCell) > 0.0;\n  `)\n})\n\n\nclass UpdateHiddenLayer {\n  constructor(private gls: GlState) {\n  }\n\n  dense = DenseLayerSM2(\n    HiddenLayer.weights.sm, HiddenLayer.biases.sm,\n    HiddenLayerLayout.inputSlices, HiddenLayerLayout.outputSlices, true);\n  query = new ArchetypesQuery([HiddenLayer.res.component, HiddenLayer.weights.component, HiddenLayer.biases.component])\n    .updateGpu(this.gls, [HiddenLayer.res.component], shaderModule([\n      BrainRunningSM2,\n      this.dense,\n      Senses.sm,\n      MemoryLayer.res.sm,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        if (!${BrainRunningSM2.running}(entityCell)) {\n          return;\n        }\n        vec4 inputs[${HiddenAndMemoryInputSlices}];\n        for (int i=0; i < ${SensesSlices}; i++) {\n          inputs[i] = ${Senses.sm.value}(entityCell, i);\n        }\n        for (int i=0; i < ${MemorySlices}; i++) {\n          inputs[${SensesSlices} + i] = ${MemoryLayer.res.sm.value}(entityCell, i);\n        }\n        ${this.dense.runLayer}(inputs, entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nclass UpdateMemoryLayer {\n  constructor(private gls: GlState) {\n  }\n\n  dense = DenseLayerSM2(\n    MemoryLayer.weights.sm, MemoryLayer.biases.sm,\n    MemoryLayerLayout.inputSlices, MemoryLayerLayout.outputSlices, true);\n  query = new ArchetypesQuery([MemoryLayer.res.component, MemoryLayer.weights.component, MemoryLayer.biases.component])\n    .updateGpu(this.gls, [MemoryLayer.res.component], shaderModule([\n      BrainRunningSM2,\n      this.dense,\n      Senses.sm,\n      MemoryLayer.res.sm,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        if (!${BrainRunningSM2.running}(entityCell)) {\n          return;\n        }\n        vec4 inputs[${HiddenAndMemoryInputSlices}];\n        for (int i=0; i < ${SensesSlices}; i++) {\n          inputs[i] = ${Senses.sm.value}(entityCell, i);\n        }\n        for (int i=0; i < ${MemorySlices}; i++) {\n          inputs[${SensesSlices} + i] = ${MemoryLayer.res.sm.value}(entityCell, i);\n        }\n        ${this.dense.runLayer}(inputs, entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nclass UpdateOutputLayer {\n  constructor(private gls: GlState) {\n  }\n\n\n  dense = DenseLayerSM2(\n    OutputLayer.weights.sm, OutputLayer.biases.sm,\n    OutputLayerLayout.inputSlices, OutputLayerLayout.outputSlices, false);\n  query = new ArchetypesQuery([OutputLayer.res.component, OutputLayer.weights.component, OutputLayer.biases.component])\n    .updateGpu(this.gls, [OutputLayer.res.component], shaderModule([\n      BrainRunningSM2,\n      this.dense,\n      OutputLayer.res.writer,\n      HiddenLayer.res.sm\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        if (!${BrainRunningSM2.running}(entityCell)) {\n          return;\n        }\n        vec4 inputs[${OutputLayerLayout.inputSlices}];\n        for (int i = 0; i < ${OutputLayerLayout.inputSlices}; i++) {\n          inputs[i] = ${HiddenLayer.res.sm.value}(entityCell, i);\n        }\n        ${this.dense.runLayer}(inputs, entityCell);\n      `)\n    }));\n\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nexport class UpdateNeuralNetwork {\n  constructor(private gls: GlState) {\n  }\n  senses = new UpdateSenses(this.gls);\n  gymExtraSenses = new UpdateGymExtraSenses(this.gls);\n  hiddenLayer = new UpdateHiddenLayer(this.gls);\n  memoryLayer = new UpdateMemoryLayer(this.gls);\n  outputLayer = new UpdateOutputLayer(this.gls);\n  decisionsViz = new UpdateDecisionsViz(this.gls);\n  run(state: GpuWorldState) {\n    if (state.data.gameInstance.type !== 'battle' && state.data.gameInstance.type !== 'train') {\n      return;\n    }\n    const stepsSinceRoundStart = state.data.stepCounter - state.data.battleStartStep;\n    if (stepsSinceRoundStart % 8 === 1) {\n      this.senses.run(state);\n    }\n    if (stepsSinceRoundStart % 8 === 2) {\n      this.hiddenLayer.run(state);\n    }\n    if (stepsSinceRoundStart % 8 === 3) {\n      this.memoryLayer.run(state);\n    }\n    if (stepsSinceRoundStart % 8 === 4) {\n      this.outputLayer.run(state);\n      this.decisionsViz.run(state);\n    }\n  }\n}\n","import { BrainOutputs, ArenaMembersSize } from \"../StateLayout\";\nimport { OutputLayer } from \"./Components\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { WithoutNaNInfSM, ArrayMaxSM } from \"../../GpuUtil/SM2Utils\";\nimport { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { UnitBuffer } from \"../ECS/UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GpuWorldState } from \"../State\";\n\nexport const Decisions = {\n  MoveX: new GpuComponentModule('DecisionsMoveX', UnitBuffer, 'float'),\n  Rotate: new GpuComponentModule('DecisionsRotate', UnitBuffer, 'float'),\n  ChaseFocus: new GpuComponentModule('DecisionsChaseFocus', UnitBuffer, 'float'),\n  CastingSlot: new GpuComponentModule('DecisionsCastingSlot', UnitBuffer, 'int'),\n  ChangeFocus: new GpuComponentModule('DecisionsChangeFocus', UnitBuffer, 'int'),\n}\nexport const DecisionsCMs = Object.keys(Decisions).map(key => Decisions[key] as GpuComponentModule<'float'>);\n\nconst SampleCastSlotSM = ArrayMaxSM(3);\nconst SampleFocusSM = ArrayMaxSM(ArenaMembersSize - 1);\n\nexport function UpdateDecisionsFromBrain(gls: GlState) {\n  return new ArchetypesQuery([OutputLayer.res.component])\n    .updateGpu(gls, DecisionsCMs.map(d => d.component), shaderModule([\n      ...DecisionsCMs.map(c => c.writer),\n      SampleCastSlotSM, SampleFocusSM, OutputLayer.res.sm, WithoutNaNInfSM\n    ], {\n      brainOutput: funcDef('float', [['ivec2', 'entityCell'], ['int', 'brainOutput']], `\n        int slice = brainOutput / 4;\n        int channel = brainOutput % 4;\n        return ${WithoutNaNInfSM.withoutNaNInf}(${OutputLayer.res.sm.value}(entityCell, slice)[channel]);\n      `),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        ${Decisions.MoveX.writer.write}(tanh(Self.brainOutput(entityCell, ${BrainOutputs.MoveX})));\n        ${Decisions.Rotate.writer.write}(tanh(Self.brainOutput(entityCell, ${BrainOutputs.Rotate})));\n        ${Decisions.ChaseFocus.writer.write}(clamp(Self.brainOutput(entityCell, ${BrainOutputs.ChaseFocus}), 0.0, 1.0));\n        float[] castSlots = float[](\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.CastSlot0}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.CastSlot1}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.CastSlot2}), 0., 1.)\n        );\n        int maxCastSlotI = ${SampleCastSlotSM.max}(castSlots);\n        float maxCastSlot = castSlots[maxCastSlotI];\n        ${Decisions.CastingSlot.writer.write}(maxCastSlot > 0. ? (maxCastSlotI + 1) : 0);\n        float[] focuses = float[](\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusFriendStatue}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusFriend1}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusFriend2}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusEnemyStatue}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusEmemy1}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusEnemy2}), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ${BrainOutputs.FocusEnemy3}), 0., 1.)\n        );\n        int maxFocusI = ${SampleFocusSM.max}(focuses);\n        float maxFocus = focuses[maxFocusI];\n        if (maxFocus > 0.) {\n          ${Decisions.ChangeFocus.writer.write}(maxFocusI + 1);\n        } else {\n          ${Decisions.ChangeFocus.writer.write}(0);\n        }\n      `)\n    }))\n}\n\nexport class UpdateUserControlledDecisions {\n  run(state: GpuWorldState) {\n    if (state.data.userControlEntity && state.data.userControlSet) {\n      for (const key of Object.keys(state.data.userControlSet)) {\n        const v = state.data.userControlSet[key];\n        state.ecs.setComponentData(v.component, state.data.userControlEntity, v.value);\n      }\n    }\n  }\n}","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { Decisions } from \"../Brain/Decisions\";\nimport { Position, RotationZ } from \"./Transform\";\nimport { ArenaInstance } from \"./Components\";\nimport { ArchetypesQuery, GpuLookupTableSM } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { SpatialSM } from \"../../GpuUtil/SM2Utils\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { Hitpoints, Team, Focuser, MaxFocusDistance } from \"./UnitComponents\";\nimport { UnitFocusables } from \"../Brain/UnitFocusables\";\n\n\nexport class UpdateBrainFocusers {\n  constructor(private gls: GlState) {}\n\n  private writer = new ArchetypesQuery([Focuser.component])\n    .mapGpu(this.gls, Focuser.component, shaderModule([\n      Position.sm, RotationZ.sm, Focuser.sm, Decisions.ChangeFocus.sm,\n      GpuLookupTableSM, ArenaInstance.sm, SpatialSM, Hitpoints.sm,\n      Team.sm, UnitFocusables\n    ], {\n      unitsInArena: uniformDef('isampler2D', d => d.unitsInArenaGpu.get(d)),\n      map: funcDef('ivec2', [['ivec2', 'entityCell'], ['ivec2', 'value']], `\n        if (${Hitpoints.sm.value}(entityCell) <= 0.0) {\n          return ivec2(-1);\n        }\n\n        vec3 position = ${Position.sm.value}(entityCell);\n        float rotation = ${RotationZ.sm.value}(entityCell);\n        vec2 forward = ${SpatialSM.forward}(rotation);\n        ivec2 focus = ${Focuser.sm.value}(entityCell);\n        bool hasFocus = focus.x >= 0;\n        vec3 focusPosition = ${Position.sm.value}(focus);\n\n        bool focusIsInFront = ${SpatialSM.isInFront}(position.xy, forward, focusPosition.xy);\n\n        int changeFocusI = ${Decisions.ChangeFocus.sm.value}(entityCell);\n        bool changeFocus = changeFocusI > 0 ||\n          !hasFocus ||\n          distance(position, focusPosition) > ${glslFloat(MaxFocusDistance)} ||\n          !focusIsInFront ||\n          ${Hitpoints.sm.value}(focus) <= 0.0;\n\n        if (!changeFocus) {\n          return value;\n        }\n\n        int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n        int selfTeam = ${Team.sm.value}(entityCell);\n        ivec3[] brainFocusables = ${UnitFocusables.get}(entityCell, selfTeam, arenaIndex);\n        ivec2 candidate = brainFocusables[changeFocusI - 1].xy;\n\n        // Can't focus on self or nothing\n        if (changeFocusI == 0 || candidate == entityCell || candidate.x < 0) {\n          return ivec2(-1);\n        }\n\n        vec3 candidatePosition = ${Position.sm.value}(candidate);\n\n        bool isInFront = ${SpatialSM.isInFront}(position.xy, forward, candidatePosition.xy);\n        bool isInRange = distance(position, candidatePosition) < ${glslFloat(MaxFocusDistance)};\n        bool focusable = isInFront && isInRange && ${Hitpoints.sm.value}(candidate) > 0.0;\n        if (focusable) {\n          return candidate;\n        } else {\n          return ivec2(-1);\n        }\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.writer.run(state);\n  }\n}\n","import { CastingState } from \"../StateLayout\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { Decisions } from \"../Brain/Decisions\";\nimport { Dazeable } from \"../Buffs/Daze\";\nimport { Abilities, UnitAbilities, AbilitySM, ValidTarget, AbilityRange, Casting } from \"./Abilities\";\nimport { Focuser } from \"../ECS/UnitComponents\";\nimport { Mana, Hitpoints } from \"../ECS/UnitComponents\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { SpatialSM, MathConstsSM } from \"../../GpuUtil/SM2Utils\";\nimport { Position, RotationZ } from \"../ECS/Transform\";\n\nexport class UpdateCastingAbility {\n  constructor(private gls: GlState) {}\n\n  castingAbility = new ArchetypesQuery([Casting.Ability.component])\n    .updateGpu(this.gls, [\n      Casting.Ability.component,\n      Casting.State.component,\n      Casting.StateStartStep.component,\n      Casting.Target.component,\n      Casting.Cooldowns.component,\n    ], shaderModule([\n      Casting.Ability.writer,\n      Casting.State.writer,\n      Casting.StateStartStep.writer,\n      Casting.Target.writer,\n      Casting.Cooldowns.writer,\n      Casting.Ability.sm,\n      Casting.State.sm,\n      Casting.StateStartStep.sm,\n      Casting.Target.sm,\n      Casting.Cooldowns.sm,\n      Hitpoints.sm,\n      AbilitySM,\n      Position.sm,\n      RotationZ.sm,\n      SpatialSM,\n      Dazeable.sm,\n      Mana.sm,\n      Decisions.CastingSlot.sm,\n      UnitAbilities.sm,\n      Focuser.sm,\n      MathConstsSM,\n    ], {\n      time: uniformDef('int', d => d.data.stepCounter),\n\n      isValidTarget: funcDef('bool', [['int', 'ability'], ['ivec2', 'targetCell']], `\n        switch (${AbilitySM.validTargets}[ability]) {\n          case ${ValidTarget.Anything}: return true;\n          case ${ValidTarget.Creature}: return targetCell.x >= 0 && ${Hitpoints.sm.value}(targetCell) > 0.0;\n        }\n      `),\n\n      targetInRange: funcDef('bool', [['ivec2', 'entityCell'], ['int', 'ability'], ['ivec2', 'targetCell']], `\n        int abilityRange = ${AbilitySM.targetRange}[ability];\n        if (abilityRange == ${AbilityRange.Any}) {\n          return true;\n        } else {\n          float maxRange = abilityRange == ${AbilityRange.Close} ? 2.0 : 15.0;\n          float minRange = abilityRange == ${AbilityRange.Close} ? 0.0 : 1.5;\n          vec3 selfPosition = ${Position.sm.value}(entityCell);\n          float selfRotation = ${RotationZ.sm.value}(entityCell);\n          vec2 selfForward = ${SpatialSM.forward}(selfRotation);\n          vec3 targetPosition = ${Position.sm.value}(targetCell);\n          float angle = ${SpatialSM.angleToPosition}(selfPosition.xy, selfForward, targetPosition.xy);\n          bool isInFront = abs(angle) < (${MathConstsSM.PI} / 4.);\n          float dist = distance(selfPosition, targetPosition);\n          return isInFront && dist >= minRange && dist < maxRange;\n        }\n      `),\n\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        int currentAbility = ${Casting.Ability.sm.value}(entityCell);\n        int currentState = ${Casting.State.sm.value}(entityCell);\n        int currentStateStartStep = ${Casting.StateStartStep.sm.value}(entityCell);\n        ivec2 currentTarget = ${Casting.Target.sm.value}(entityCell);\n        int cooldowns[] = int[](\n          ${Casting.Cooldowns.sm.value}(entityCell, 0),\n          ${Casting.Cooldowns.sm.value}(entityCell, 1),\n          ${Casting.Cooldowns.sm.value}(entityCell, 2)\n        );\n\n        bool dazed = ${Dazeable.sm.value}(entityCell) > 0;\n\n        int nextState = currentState;\n        int nextAbility = currentAbility;\n        int nextStateStartStep = currentStateStartStep;\n        ivec2 nextTarget = currentTarget;\n        int nextCooldowns[] = int[](\n          max(0, cooldowns[0] - 1),\n          max(0, cooldowns[1] - 1),\n          max(0, cooldowns[2] - 1)\n        );\n\n        if (currentState != ${CastingState.Inactive}) {\n          int steps = Self.time - nextStateStartStep;\n          int castTime = ${AbilitySM.castTime}[currentAbility];\n          int duration = ${AbilitySM.duration}[currentAbility];\n          int windDown = ${AbilitySM.windDown}[currentAbility];\n\n          bool shouldAbort = dazed ||\n            !Self.isValidTarget(currentAbility, currentTarget) ||\n            !Self.targetInRange(entityCell, currentAbility, currentTarget) ||\n            ${Hitpoints.sm.value}(entityCell) <= 0.0;\n\n          if (currentState != ${CastingState.WindDown} && shouldAbort) {\n            nextState = ${CastingState.WindDown};\n            nextStateStartStep = time;\n          } else if (currentState == ${CastingState.Casting}) {\n            if (steps >= castTime) {\n              nextState = ${CastingState.Performing};\n              nextStateStartStep = time;\n            }\n          } else if (currentState == ${CastingState.Performing}) {\n            if (steps >= duration) {\n              nextState = ${CastingState.WindDown};\n              nextStateStartStep = time;\n            }\n          } else if (currentState == ${CastingState.WindDown}) {\n            if (steps >= windDown) {\n              nextState = ${CastingState.Inactive};\n              nextAbility = ${Abilities.None};\n              nextStateStartStep = -1;\n              nextTarget = ivec2(-1);\n            }\n          }\n\n        } else {\n\n          bool canCastAbility = ${Hitpoints.sm.value}(entityCell) > 0.0 &&\n            currentState == ${CastingState.Inactive} &&\n            !dazed;\n\n          int decisionCastingSlot = ${Decisions.CastingSlot.sm.value}(entityCell);\n          int desiredCastingAbility = ${UnitAbilities.sm.value}(entityCell, decisionCastingSlot - 1);\n\n          ivec2 focus = ${Focuser.sm.value}(entityCell);\n\n          bool isStartingCast = canCastAbility &&\n            decisionCastingSlot > 0 &&\n            cooldowns[decisionCastingSlot - 1] == 0 &&\n            Self.isValidTarget(desiredCastingAbility, focus) &&\n            Self.targetInRange(entityCell, desiredCastingAbility, focus) &&\n            desiredCastingAbility != ${Abilities.None};\n\n          if (isStartingCast) {\n            nextState = ${CastingState.Casting};\n            nextAbility = desiredCastingAbility;\n            nextStateStartStep = Self.time;\n            nextTarget = focus;\n            nextCooldowns[decisionCastingSlot - 1] = ${AbilitySM.cooldown}[nextAbility];\n          }\n        }\n\n        ${Casting.Ability.writer.write}(nextAbility);\n        ${Casting.State.writer.write}(nextState);\n        ${Casting.StateStartStep.writer.write}(nextStateStartStep);\n        ${Casting.Target.writer.write}(nextTarget);\n        ${Casting.Cooldowns.writer.write}(nextCooldowns);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.castingAbility.run(state);\n  }\n}","\n\n\nimport { GpuWorldState } from \"../State\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { UpdateIronBubbable, UpdateHeliumBubbable } from \"./Bubbles\";\nimport { UpdateDazeBuff } from \"./Daze\";\nimport { UpdateCrippleBuff } from \"./Cripple\";\n\nexport class UpdateBuffs {\n  constructor(private gls: GlState) {}\n\n  buffs = [\n    new UpdateDazeBuff(this.gls),\n    new UpdateIronBubbable(this.gls),\n    new UpdateHeliumBubbable(this.gls),\n    new UpdateCrippleBuff(this.gls),\n  ]\n\n  run(state: GpuWorldState) {\n    for (const b of this.buffs) {\n      b.run(state);\n    }\n  }\n}\n","import { Decisions } from \"../Brain/Decisions\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { Dazeable } from \"../Buffs/Daze\";\nimport { Casting } from \"../Abilities/Abilities\";\nimport { RotationZ, Position } from \"./Transform\";\nimport { Hitpoints, UnitMovement, WalkingSpeed, Focuser, IsOnGround, UnitMovementSpeed, UnitRotationSpeed } from \"./UnitComponents\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { CastingState } from \"../StateLayout\";\nimport { SpatialSM, AngleLerpSM } from \"../../GpuUtil/SM2Utils\";\nimport { Abilities } from \"../Abilities/Abilities\";\nimport { Crippleable } from \"../Buffs/Cripple\";\n\nexport class UpdateUnitMovement {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([UnitMovement.component, RotationZ.component])\n    .updateGpu(this.gls, [WalkingSpeed.component, RotationZ.component], shaderModule([\n      WalkingSpeed.writer,\n      RotationZ.writer,\n      Casting.Ability.sm,\n      Casting.State.sm,\n      Focuser.sm,\n      Decisions.MoveX.sm,\n      Decisions.Rotate.sm,\n      Decisions.ChaseFocus.sm,\n      Dazeable.sm,\n      Crippleable.sm,\n      Hitpoints.sm,\n      IsOnGround.sm,\n      AngleLerpSM,\n      RotationZ.sm,\n      Position.sm,\n      SpatialSM,\n      UnitMovementSpeed.sm,\n      UnitRotationSpeed.sm,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n\n        int castingState = ${Casting.State.sm.value}(entityCell);\n        int castingAbility = ${Casting.Ability.sm.value}(entityCell);\n        ivec2 focus = ${Focuser.sm.value}(entityCell);\n\n        vec3 selfPosition = ${Position.sm.value}(entityCell);\n        float selfRotation = ${RotationZ.sm.value}(entityCell);\n        vec2 selfForward = ${SpatialSM.forward}(selfRotation);\n        vec3 focusPosition = ${Position.sm.value}(focus);\n\n        float chaseFocus = focus.x >= 0 ? ${Decisions.ChaseFocus.sm.value}(entityCell) : 0.0;\n\n        bool dazed = ${Dazeable.sm.value}(entityCell) > 0;\n        bool crippled = ${Crippleable.sm.value}(entityCell) > 0;\n        bool canWalk = ${Hitpoints.sm.value}(entityCell) > 0.0 &&\n          !dazed &&\n          ${IsOnGround.sm.value}(entityCell);\n\n        float walkingSpeed = 0.0;\n        float newRotation = 0.0;\n        if (canWalk) {\n          float maximumMovementSpeed = ${UnitMovementSpeed.sm.value}(entityCell);\n          float move = mix(\n            ${Decisions.MoveX.sm.value}(entityCell),\n            1.0,\n            chaseFocus\n            // Scale with max move speed so that 1 from the brain is max\n          ) * maximumMovementSpeed;\n\n          float movementSpeed = maximumMovementSpeed *\n            (castingAbility == ${Abilities.Shell} ? 0.2 : 1.) *\n            (crippled ? 0.1 : 1.) *\n            ((castingState == ${CastingState.Casting} || castingState == ${CastingState.Performing}) ? 0. : 1.);\n\n          // It's important that we clamp like this so that the decision to move is absolute, since\n          // the pixlings doesn't know it's own speed limitations (i.e. \"I want to move forward 5km/h\"\n          // rather than \"I want to move forward at 50% speed, whatever that means since I don't know my max speed\")\n          walkingSpeed = clamp(\n            move,\n            -movementSpeed,\n            movementSpeed\n          );\n\n          float maximumRotationSpeed = ${UnitRotationSpeed.sm.value}(entityCell);\n          float speed = maximumRotationSpeed *\n            (crippled ? 0.2 : 1.) *\n            ((castingState == ${CastingState.Casting} || castingState == ${CastingState.Performing}) ? 0.0 : 1.0);\n          float chaseAngle = ${SpatialSM.angleToPosition}(selfPosition.xy, selfForward, focusPosition.xy);\n\n          // Scale by maximum speed, so that 1 brain output is max\n          float manualRotate = ${Decisions.Rotate.sm.value}(entityCell) * maximumRotationSpeed;\n          // Same here with the clamping as in movement speed\n          manualRotate = selfRotation + clamp(manualRotate, -speed, speed);\n\n          float chaseRotate = selfRotation + clamp(chaseAngle, -speed, speed);\n\n          newRotation = ${AngleLerpSM.angleLerp}(manualRotate, chaseRotate, chaseFocus);\n        }\n\n        ${WalkingSpeed.writer.write}(walkingSpeed);\n        ${RotationZ.writer.write}(newRotation);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n","import { GroundHeightSM, GroundNormalSM } from \"./Ground\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { Position, RotationZ } from \"./Transform\";\nimport { ArchetypesQuery, GpuLookupTableSM } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { Unit, Hitpoints, Velocity, Force, IsOnGround, Gold, WalkingSpeed, Stuck, LastPushedBy, IsTakingFallDamage, BountyComponents } from \"./UnitComponents\";\nimport { ArenaInstance, ArenaMemberIndex } from \"./Components\";\nimport { SpatialSM } from \"../../GpuUtil/SM2Utils\";\nimport { SideSize } from \"../StateLayout\";\n\nexport class UpdateUnitPhysics {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([Velocity.component, Force.component, Position.gpuComponent, IsOnGround.component, Unit.component])\n    .updateGpu(this.gls, [\n      Velocity.component, Force.component, Position.gpuComponent, IsOnGround.component,\n      Hitpoints.component, Gold.component, Stuck.component, IsTakingFallDamage.component\n    ],\n      shaderModule([\n        Velocity.writer, Velocity.sm, IsOnGround.sm, IsOnGround.writer, Force.sm,\n        Force.writer, Position.sm, Position.writer, GroundHeightSM, GroundNormalSM,\n        Hitpoints.sm, Hitpoints.writer, GpuLookupTableSM, ArenaInstance.sm,\n        Hitpoints.sm, RotationZ.sm, SpatialSM, WalkingSpeed.sm, Gold.sm, Gold.writer,\n        Stuck.writer, ArenaMemberIndex.sm, IsTakingFallDamage.writer,\n        BountyComponents.fallDamageTaken.sm\n      ], {\n        timestep: uniformDef('float', d => d.data.physicsTimestep),\n        unitsInArena: uniformDef('isampler2D', d => d.unitsInArenaGpu.get(d)),\n        clampPositions: uniformDef('bool', d => d.data.gameInstance.type === 'gym'),\n        mapCenter: uniformDef('vec2', d => ({ x: d.data.worldSize.width / 2, y: d.data.worldSize.width / 2 })),\n        update: funcDef('void', [['ivec2', 'entityCell']], `\n          // https://gamedev.stackexchange.com/questions/15708/how-can-i-implement-gravity/41917#41917\n          vec3 position = ${Position.sm.value}(entityCell);\n          vec3 velocity = ${Velocity.sm.value}(entityCell);\n          vec3 force = ${Force.sm.value}(entityCell);\n          bool isOnGround = ${IsOnGround.sm.value}(entityCell);\n          float hitpoints = ${Hitpoints.sm.value}(entityCell);\n          float walking = ${WalkingSpeed.sm.value}(entityCell);\n          bool selfAlive = hitpoints > 0.;\n          float gold = ${Gold.sm.value}(entityCell);\n          vec3 prevPosition = position;\n          if (length(force) > 0.01 || velocity.z > 0.1) {\n            isOnGround = false;\n          }\n          if (isOnGround) {\n            float rotation = ${RotationZ.sm.value}(entityCell);\n            vec2 forward = ${SpatialSM.forward}(rotation);\n            velocity = vec3(forward, 0) * walking;\n            vec3 delta = Self.timestep * velocity;\n            position += delta;\n            float height = ${GroundHeightSM.atPosition}(position.xy);\n            float elevation = position.z - height;\n            vec3 normal = ${GroundNormalSM.atPosition}(position.xy);\n            if (elevation > 0.1) {\n              isOnGround = false;\n            } else if (normal.z < 0.7 && height > prevPosition.z) { // sin(pi/4) = 0.7 -> 45deg incline\n              // Prevent hillclimbing\n              position = prevPosition;\n              position.z = ${GroundHeightSM.atPosition}(position.xy);\n            } else {\n              position.z = height;\n            }\n          } else {\n            const float G = 9.82 * 6.0;\n            const float mass = 1.0;\n            vec3 acceleration = force / mass;\n            acceleration += vec3(0, 0, -G);\n            velocity += Self.timestep * acceleration;\n            position += Self.timestep * velocity;\n            float height = ${GroundHeightSM.atPosition}(position.xy);\n            if (position.z <= height) {\n              if (velocity.z < -40.) {\n                // Fall damage\n                if (selfAlive) {\n                  hitpoints -= 10000.;\n                  int arenaMemberIndex = ${ArenaMemberIndex.sm.value}(entityCell);\n                  gold += ${BountyComponents.fallDamageTaken.sm.value}(entityCell);\n                  ${IsTakingFallDamage.writer.write}(true);\n                }\n              }\n              if (prevPosition.z < height && velocity.z < -10.) {\n                // We hit a \"wall\", so start falling straight down instead\n                // to avoid characters \"leaping up from the abyss\"\n                position = prevPosition;\n                velocity.xy = vec2(0);\n              } else {\n                position.z = height;\n                // We're on the ground, but might be sliding\n                velocity -= normalize(velocity) * length(velocity) * 0.1; // Friction\n                if (length(velocity.xy) < 1.) {\n                  velocity = vec3(0);\n                  isOnGround = true;\n                } else {\n                  velocity.z = -0.1;\n                }\n              }\n            }\n          }\n          // Unit-unit collisions\n          if (selfAlive) {\n            int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n            int unitsCount = ${SideSize * 2};\n            vec3 unitCenter = vec3(0, 0, 1);\n            vec3 selfCenter = position + unitCenter;\n            const float unitRadius = 0.5;\n            for (int i=0; i < unitsCount; i++) {\n              ivec2 other = ${GpuLookupTableSM.entityCell}(Self.unitsInArena, arenaIndex, i);\n              if (other == entityCell || other.x < 0) {\n                continue;\n              }\n              bool otherAlive = ${Hitpoints.sm.value}(other) > 0.;\n              if (!otherAlive) {\n                continue;\n              }\n              vec3 otherCenter = ${Position.sm.value}(other) + unitCenter;\n              vec3 delta = selfCenter - otherCenter;\n              if (length(delta) < unitRadius * 2.) {\n                selfCenter = otherCenter + normalize(delta) * unitRadius * 2.;\n              }\n            }\n            position = selfCenter - unitCenter;\n          }\n          if (clampPositions) {\n            vec2 size = vec2(20);\n            position.xy = clamp(position.xy, mapCenter - size, mapCenter + size);\n          }\n          ${Velocity.writer.write}(velocity);\n          ${Position.writer.write}(position);\n          ${IsOnGround.writer.write}(isOnGround);\n          ${Force.writer.write}(vec3(0));\n          ${Hitpoints.writer.write}(hitpoints);\n          ${Gold.writer.write}(gold);\n          ${Stuck.writer.write}(distance(prevPosition, position) < walking * Self.timestep * 0.5 && isOnGround && walking > 0.01);\n        `)\n      }));\n\n  fallDamageKillBounty = new ArchetypesQuery([LastPushedBy.component])\n      .updateGpu(this.gls, [Gold.component], shaderModule([\n        LastPushedBy.sm, Gold.writer, IsTakingFallDamage.sm,\n        BountyComponents.killEnemyUnit.sm\n      ], {\n        update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n          if (${IsTakingFallDamage.sm.value}(entityCell)) {\n            ivec2 lastPushedBy = ${LastPushedBy.sm.value}(entityCell);\n            if (lastPushedBy.x >= 0) {\n              float bounty = ${BountyComponents.killEnemyUnit.sm.value}(lastPushedBy);\n              ${Gold.writer.write}(bounty);\n              return lastPushedBy;\n            }\n          }\n          return ivec2(-1);\n        `)\n      }), 'sum');\n\n  resetLastPushedBy = new ArchetypesQuery([LastPushedBy.component])\n      .mapGpu(this.gls, LastPushedBy.component, shaderModule([\n        IsOnGround.sm\n      ], {\n        map: funcDef('ivec2', [['ivec2', 'entityCell'], ['ivec2', 'value']], `\n          if (${IsOnGround.sm.value}(entityCell)) {\n            return ivec2(-1);\n          } else {\n            return value;\n          }\n        `)\n      }));\n\n  run(state: GpuWorldState) {\n    state.ecs.gpuComponentInfo(IsTakingFallDamage.component)?.slice.clear();\n    this.update.run(state);\n    this.fallDamageKillBounty.run(state);\n    this.resetLastPushedBy.run(state);\n  }\n}\n","import { GpuWorldState } from \"../State\";\nimport { Hitpoints, AnimatableUnitComponent, WalkingSpeed, DiedStep, PreviousHitpoints, UnitSoundMaterialComponent, UnitSoundsComponent } from \"./UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { AnimationControllerComponent, AnimationAction } from \"./Animation\";\nimport { PixlingTimespan, SecondsPerStep } from \"../../Time\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { Casting } from \"../Abilities/Abilities\";\nimport { abilitiesData } from \"../Abilities/Abilities\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { CastingState, UnitAnimations, SoundEffect } from \"../StateLayout\";\nimport { Dazeable } from \"../Buffs/Daze\";\nimport { AudioPlayerInstance } from \"../Audio\";\nimport { Position } from \"./Transform\";\nimport { DamageCalcHelpers } from \"./DamageCalc\";\nimport { mod, interpolateClamped } from \"../../Math/Math\";\nimport { HeliumBubbable } from \"../Buffs/Bubbles\";\nimport { VisibleComponent } from \"./Components\";\nimport { visibleCacheKeys } from \"./Visibility\";\n\nexport class UpdateUnitAnimationAndSound {\n  constructor(private gls: GlState) {}\n\n  query = new EntitiesQuery([AnimatableUnitComponent, VisibleComponent])\n    .filterValue(VisibleComponent, v => !!v, visibleCacheKeys)\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([\n      Hitpoints.sm,\n      Casting.Ability.sm,\n      Casting.StateStartStep.sm,\n      Casting.State.sm,\n      Casting.Target.sm,\n      WalkingSpeed.sm,\n      Dazeable.sm,\n      Position.sm,\n      DiedStep.sm,\n      PreviousHitpoints.sm,\n      HeliumBubbable.sm,\n      DamageCalcHelpers(),\n    ], {\n      time: uniformDef('int', d => d.data.stepCounter),\n      map: funcDef('vec4[4]', [['ivec2', 'entityCell']], `\n        ivec2 castingTarget = ${Casting.Target.sm.value}(entityCell);\n        return vec4[](\n          vec4(\n            ${Position.sm.value}(entityCell),\n            ${WalkingSpeed.sm.value}(entityCell)\n          ),\n          vec4(\n            time - ${Casting.StateStartStep.sm.value}(entityCell),\n            ${Casting.Ability.sm.value}(entityCell),\n            ${Casting.State.sm.value}(entityCell),\n            ${HeliumBubbable.sm.value}(entityCell) > 0\n          ),\n          vec4(\n            ${Hitpoints.sm.value}(entityCell),\n            time - ${DiedStep.sm.value}(entityCell),\n            ${PreviousHitpoints.sm.value}(entityCell),\n            ${Dazeable.sm.value}(entityCell) > 0\n          ),\n          vec4(\n            ${DamageCalcHelpers().armor}(entityCell),\n            castingTarget.x,\n            castingTarget.y,\n            0\n          )\n        );\n      `)\n    }))\n    .toCpuQueuing(state => state.data.round);\n\n  run(state: GpuWorldState) {\n    AudioPlayerInstance?.updateCamera(state.derived.cameraView);\n    const time = new PixlingTimespan(state.data.stepCounter).timeInSecondsFractional;\n    const readResults = this.query.queueRead(state);\n    for (const res of readResults()) {\n      for (const { entityCell, value } of res) {\n        const position = value[0];\n        const walkSpeed = value[0].w; // m/s\n        const castStateSteps = value[1].x;\n        const castAbility = value[1].y;\n        const castState = value[1].z;\n        const heliumBubble = value[1].w;\n        const hitpoints = value[2].x;\n        const deadSteps = value[2].y;\n        const previousHitpoints = value[2].z;\n        const dazed = value[2].w;\n        const armor = value[3].x;\n        const castingTarget = { x: value[3].y, y: value[3].z };\n\n        const incomingDamage = Math.max(0, previousHitpoints - hitpoints);\n\n        const material = state.ecs.getComponentData(UnitSoundMaterialComponent, entityCell)!;\n        const au = state.ecs.getComponentData(AnimatableUnitComponent, entityCell)!;\n        const ac = state.ecs.getComponentData(AnimationControllerComponent, entityCell)!;\n        const us = state.ecs.getComponentData(UnitSoundsComponent, entityCell)!;\n\n        if (incomingDamage > 5) {\n          if (armor > 1) {\n            AudioPlayerInstance?.playSoundEffect(SoundEffect.StoneHit, 0, position);\n          } else if (material.value === 'wood') {\n            AudioPlayerInstance?.playSoundEffect(SoundEffect.WoodHit, 0, position);\n          } else if (material.value === 'statue') {\n            AudioPlayerInstance?.playSoundEffect(SoundEffect.StoneHit, 0, position);\n          } else {\n            AudioPlayerInstance?.playSoundEffect(SoundEffect.FleshHit, 0, position);\n          }\n        }\n\n        let actions: AnimationAction[] = [];\n\n        const dead = hitpoints <= 0;\n\n        if (us.playing.Dazed && (dead || !dazed)) {\n          us.playing.Dazed.fadeOut();\n          delete us.playing.Dazed;\n        }\n        if (us.playing.HeliumBubble && (dead || !heliumBubble)) {\n          us.playing.HeliumBubble.fadeOut();\n          delete us.playing.HeliumBubble;\n        }\n        if (us.playing.Ability && us.playing.Ability.looping && castState === CastingState.WindDown) {\n          us.playing.Ability.fadeOut();\n          delete us.playing.Ability;\n        }\n\n        if (dead) {\n          const clip = UnitAnimations[UnitAnimations.Death1];\n          const active = ac.actions.find(x => x.clip === clip);\n          actions.push({\n            positionType: 'startTime',\n            positionValue: active ? active.positionValue : (time - deadSteps),\n            clip,\n            looping: false\n          });\n\n          if (deadSteps === 0) {\n            if (material.value === 'wood') {\n              AudioPlayerInstance?.playSoundEffect(SoundEffect.PlanksFalling, 0, position);\n            } else if (material.value === 'statue') {\n              AudioPlayerInstance?.playSoundEffect(SoundEffect.Explosion, 0, position);\n            } else {\n              AudioPlayerInstance?.playSoundEffect(SoundEffect.Wimper, 0, position);\n            }\n          }\n        } else {\n\n          if (dazed) {\n            const clip = UnitAnimations[UnitAnimations.Dazed1];\n            const active = ac.actions.find(x => x.clip === clip);\n            actions.push({\n              positionType: 'startTime',\n              positionValue: active ? active.positionValue : time,\n              clip,\n              looping: true\n            });\n            if (!us.playing.Dazed && AudioPlayerInstance) {\n              us.playing.Dazed = AudioPlayerInstance.playSoundEffect(SoundEffect.Snore, 0, position);\n            }\n          }\n          if (heliumBubble) {\n            if (!us.playing.HeliumBubble && AudioPlayerInstance) {\n              us.playing.HeliumBubble = AudioPlayerInstance.playSoundEffect(SoundEffect.BubbleWobble, 0, position);\n            }\n          }\n\n          const walkIdleCuttoff = 0.1;\n          {\n            const clip = UnitAnimations[UnitAnimations.Run1];\n            const active = ac.actions.find(x => x.clip === clip);\n            const prevPerc = (active?.positionValue ?? 0);\n            // p + (s/f) * (m/s) / m\n            const walkDist = walkSpeed * SecondsPerStep;\n            const perc = prevPerc + walkDist / au.stepLength;\n            actions.push({\n              clip,\n              looping: true,\n              positionType: 'percentage',\n              positionValue: perc,\n              weight: interpolateClamped(Math.abs(walkSpeed), 0, walkIdleCuttoff, 0, 1)\n            });\n            const footstepFrame1 = 43;\n            const footstepFrame2 = 18;\n            const totalFrames = 48;\n            const prevAnimFrame = mod(Math.floor(prevPerc * totalFrames), totalFrames);\n            const nextAnimFrame = mod(Math.floor(perc * totalFrames), totalFrames);\n            if ((prevAnimFrame < footstepFrame1 && nextAnimFrame >= footstepFrame1) ||\n              (prevAnimFrame < footstepFrame2 && nextAnimFrame >= footstepFrame2)) {\n              AudioPlayerInstance?.playSoundEffect(SoundEffect.Footstep, 0, position);\n            }\n          }\n          {\n            const clip = UnitAnimations[UnitAnimations.Idle1];\n            const active = ac.actions.find(x => x.clip === clip);\n            actions.push({\n              clip,\n              looping: true,\n              positionType: 'time',\n              positionValue: (active?.positionValue ?? 0) + SecondsPerStep,\n              weight: interpolateClamped(Math.abs(walkSpeed), 0, walkIdleCuttoff, 1, 0) *\n                ((castState === CastingState.Casting || castState === CastingState.Performing) ? 0 : 1)\n            });\n          }\n\n          if (castState !== CastingState.Inactive) {\n            abilitiesData.castAnimation[castAbility]?.(ac.actions, actions, castState, castStateSteps, castAbility, time);\n          }\n          const sound = abilitiesData.castSound[castAbility]?.(state, castState, castStateSteps, castAbility, castingTarget, time, position);\n          if (sound) {\n            us.playing.Ability = sound;\n          }\n        }\n\n        state.ecs.setComponentData(AnimationControllerComponent, entityCell, { actions });\n      }\n    }\n  }\n}","import { GpuComponentModule } from \"../../GpuUtil/ECS/ComponentModules\";\nimport { UnitBuffer } from \"../ECS/UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuComponent, ECSConsts } from \"../../GpuUtil/ECS\";\nimport { gpuComponentReadSM } from \"../../GpuUtil/ECS/GpuComponentSM\";\nimport { CompiledShaderModule, shaderModule, outDef, uniformDef, uniformArrayDef, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { RandomSM, RandomBoxMullerSM } from \"../../GpuUtil/SM2Utils\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { RenderTarget } from \"../../GpuUtil/RenderTarget\";\nimport { Program } from \"../../GpuUtil/Program\";\nimport { GpuWorldState } from \"../State\";\nimport { createBatches } from \"../../GpuUtil/Computation\";\nimport { HiddenLayer, MemoryLayer, OutputLayer } from \"../Brain/Components\";\n\nexport const CopyMutateParent = new GpuComponentModule('CopyMutateParent', UnitBuffer.buffer, 'ivec2');\nexport const MutationRate = new GpuComponentModule('MutationRate', UnitBuffer.buffer, 'float');\n\nexport class CopyAndMutateBrains {\n  constructor(private gls: GlState) {}\n\n  private matrices = [...WeightComponents, ...BiasComponents].map(x =>\n    new CopyAndMutateMatrix(this.gls, x)\n  );\n\n  run(state: GpuWorldState) {\n    for (const m of this.matrices) {\n      m.run(state);\n    }\n  }\n}\n\nconst WeightComponents = [\n  HiddenLayer.weights.component,\n  MemoryLayer.weights.component,\n  OutputLayer.weights.component,\n]\nconst BiasComponents = [\n  HiddenLayer.biases.component,\n  MemoryLayer.biases.component,\n  OutputLayer.biases.component,\n]\n\nclass CopyAndMutateMatrix {\n  constructor(private gls: GlState, private weightsComponent: GpuComponent) {}\n\n  private weightsSM = gpuComponentReadSM(this.weightsComponent);\n  private shader = new CompiledShaderModule(shaderModule([\n    this.weightsSM,\n    RandomSM,\n    RandomBoxMullerSM,\n    CopyMutateParent.sm,\n    MutationRate.sm,\n  ], {\n    outValues: outDef('vec4[8]'),\n    outArchetype: uniformDef('int'),\n    randomSeeds: uniformArrayDef('vec2[]', 8),\n    weightsOffset: uniformDef('int'),\n    renormalization: uniformDef('float', d => d.data.trainingConfig.weightsRenormalizationRate),\n    main: funcDef('void', [], `\n      ivec2 outDataCell = ivec2(gl_FragCoord);\n      ivec2 outEntityCell = ivec2(\n        outDataCell.y * ${ECSConsts.ChunkSize} + outDataCell.x,\n        outArchetype\n      );\n\n      float mutationRate = ${MutationRate.sm.value}(outEntityCell);\n      ivec2 readCell = ${CopyMutateParent.sm.value}(outEntityCell);\n      if (readCell.x < 0) {\n        readCell = outEntityCell;\n      }\n\n      vec4 values[8];\n      for (int i=0; i < 8; i++) {\n        vec4 weight = vec4(${this.weightsSM.value}(readCell, weightsOffset + i));\n\n        if (mutationRate > 0.) {\n          vec2 s = vec2(outEntityCell) / 1024.0 + randomSeeds[i];\n          vec4 r = vec4(\n            ${RandomBoxMullerSM.sample}(s + 0.0, s + 0.1),\n            ${RandomBoxMullerSM.sample}(s + 0.2, s + 0.3),\n            ${RandomBoxMullerSM.sample}(s + 0.4, s + 0.5),\n            ${RandomBoxMullerSM.sample}(s + 0.6, s + 0.7)\n          );\n\n          weight += r * mutationRate;\n          weight *= (1. - mutationRate * renormalization);\n        }\n        values[i] = weight;\n      }\n      outValues = values;\n    `)\n  }));\n  private renderTarget = new RenderTarget(this.gls);\n  private program = new Program(this.gls, this.shader.source);\n  private copy = this.gls.getCopyTexture();\n  run(state: GpuWorldState) {\n    this.shader.updateUniformValues(state);\n    for (const block of new ArchetypesQuery([this.weightsComponent]).gpuComponentBlocks(this.weightsComponent).get(state)) {\n      for (const { l, count } of createBatches(block.slices.layers.length, 8)) {\n        this.program.prepare();\n        this.shader.writeUniforms(this.program);\n        const tmp = this.gls.getTmpTextureSlice(\n          block.slices.texture.internalFormat,\n          block.slices.rect, count);\n        this.renderTarget.set(tmp);\n        this.gls.prepareForComputation(tmp.rect);\n        this.program.setUniform('randomSeeds', 'vec2[]', new Array(8)\n          .fill(0).map(() => ({ x: Math.random(), y: Math.random() })));\n        this.program.setUniform('weightsOffset', 'int', l);\n        this.program.setUniform('outArchetype', 'int', block.archetype.index);\n        this.gls.drawQuad(this.program);\n        this.copy.copy(block.slices.sliceRange(l, count), tmp);\n      }\n    }\n  }\n}\n","import { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GpuWorldState } from \"../State\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { Creature, CpuPlayerUnitComponent, CpuTeamComponent } from \"../ECS/UnitComponents\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { Teams, SideSize, ArenaMembersSize } from \"../StateLayout\";\nimport { EntityRef } from \"../StateData\";\nimport lodash from 'lodash';\nimport firebase from 'firebase/app';\nimport { DbCreatureBrain, partial, DbCreature, Db } from \"db\";\nimport { HiddenLayer, OutputLayer, MemoryLayer } from \"../Brain/Components\";\nimport { ArenaInstance, ArenaMemberIndex, Arena } from \"../ECS/Components\";\n// import { UpdateCuriosity } from \"./Curiosity\";\nimport { CopyMutateParent, MutationRate, CopyAndMutateBrains } from \"./CopyAndMutate\";\nimport { ArenaStats } from \"../ECS/ArenaStats\";\nimport { InterpolateSM } from \"../../GpuUtil/SM2Utils\";\nimport { Gold } from \"../ECS/UnitComponents\";\n\n\nexport interface TrainingConfig {\n  weightsRenormalizationRate: number;\n  elitismCount: number;\n}\n\nexport class TrainingStats {\n  winPercs: number[] = [];\n  tiePercs: number[] = [];\n  lossPercs: number[] = [];\n  homeDistanceClosestEnemy: number[] = [];\n  win5Percs: number[] = [];\n  tie5Percs: number[] = [];\n  losses5Percs: number[] = [];\n  homeGold: number[] = [];\n  awayGold: number[] = [];\n}\nexport class TeamTrainingStats {\n  points: number[] = [];\n  gold: number[] = [];\n}\n// function getLastTrainingStats(stats: TrainingStats) {\n//   const res: { [key: string]: number } = {};\n//   for (const key of Object.keys(stats)) {\n//     res[key] = lodash.last(stats[key] as number[])!;\n//   }\n//   return res;\n// }\n\nexport class UpdateBreeding {\n  constructor(private gls: GlState) {}\n\n  // curiosity = new UpdateCuriosity(this.gls);\n\n  creatures = new EntitiesQuery([Creature.component])\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([Gold.sm], {\n      map: funcDef('vec4', [['ivec2', 'entityCell']], `\n        return vec4(${Gold.sm.value}(entityCell));\n      `)\n    }))\n    .toCpuSync();\n\n  private arenaStats = new EntitiesQuery([Arena.gpuComponent])\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([ArenaStats, InterpolateSM, Arena.sm], {\n      map: funcDef('vec4[2]', [['ivec2', 'entityCell']], `\n        int arenaIndex = ${Arena.sm.value}(entityCell);\n        ${ArenaStats.Stats} stats = ${ArenaStats.stats}(arenaIndex);\n        return vec4[](\n          vec4(arenaIndex, stats.homePoints, stats.awayPoints, 0),\n          vec4(stats.home.gold, stats.away.gold, 0, 0)\n        );\n      `)\n    }))\n    .toCpuSync();\n\n  async runSelection(state: GpuWorldState) {\n    state.ecs.gpuComponentInfo(CopyMutateParent.component)?.slice.clear([-1, -1, -1, -1]);\n    state.ecs.gpuComponentInfo(MutationRate.component)?.slice.clear();\n\n    const creatures = this.creatures.get(state);\n    const creaturesGold: Array<{ units: Array<{ entityCell: EntityRef, gold: number, fitness: number }> }> =\n      new Array(ArenaMembersSize).fill(0).map(() => ({ units: [] }));\n    for (let i=0; i < creatures.length; i++) {\n      const entityCell = creatures[i].entityCell;\n      const arenaIndex = state.ecs.getComponentData(ArenaInstance.cpuComponent, entityCell)[0];\n      const arenaMemberIndex = state.ecs.getComponentData(ArenaMemberIndex.cpuComponent, entityCell)[0];\n      creaturesGold[arenaMemberIndex].units[arenaIndex] = {\n        entityCell,\n        gold: creatures[i].value[0].x,\n        fitness: 0,\n      };\n    }\n    for (let arenaMemberIndex=0; arenaMemberIndex < ArenaMembersSize; arenaMemberIndex++) {\n      const units = creaturesGold[arenaMemberIndex].units;\n      const breed = (arenaMemberIndex < SideSize && state.data.teams.home.train) ||\n        (arenaMemberIndex >= SideSize && state.data.teams.away.train);\n      if (units.length === 0 || !breed) {\n        continue;\n      }\n      const unitsSorted = units.slice().sort((a, b) => b.gold - a.gold);\n      for (let arenaIndex=0; arenaIndex < state.layout.arenas; arenaIndex++) {\n        unitsSorted[arenaIndex].fitness = 32 - 31 * Math.pow(arenaIndex / state.layout.arenas, 1/4);\n      }\n\n      const totalFitness = unitsSorted.reduce((p, x) => p + x.fitness, 0);\n      const selectParent = (arenaIndex: number) => {\n        if (arenaIndex < state.data.trainingConfig.elitismCount) {\n          return unitsSorted[arenaIndex].entityCell;\n        }\n        // CDF sampling\n        const r = Math.random();\n        let culm = 0;\n        for (let i=0; i < unitsSorted.length; i++) {\n          culm += unitsSorted[i].fitness / totalFitness;\n          if (r <= culm) {\n            return unitsSorted[i].entityCell;\n          }\n        }\n        throw new Error('Unreachable');\n      }\n      for (let arenaIndex=0; arenaIndex < state.layout.arenas; arenaIndex++) {\n        const unit = units[arenaIndex].entityCell;\n        const parent = selectParent(arenaIndex);\n        state.ecs.setComponentData(CopyMutateParent.component, unit, [parent.x, parent.y]);\n        if (arenaIndex >= state.data.trainingConfig.elitismCount) {\n          state.ecs.setComponentData(MutationRate.component, unit, [Math.random() > 0.8 ? 0.1 : 0.01]);\n        }\n      }\n    }\n    this.copyAndMutate.run(state);\n\n    await this.updateArenaStats(state);\n  }\n\n\n  async updateArenaStats(state: GpuWorldState) {\n\n    const arenaStats = this.arenaStats.get(state).map(x => {\n      return ({\n        arenaIndex: x.value[0].x,\n        homePoints: x.value[0].y,\n        awayPoints: x.value[0].z,\n        homeGold: x.value[1].x,\n        awayGold: x.value[1].y,\n      })\n    });\n    arenaStats.sort((a, b) => a.arenaIndex - b.arenaIndex);\n    const validation = arenaStats.slice(0, state.data.trainingConfig.elitismCount);\n    const trainingStats = {...state.data.trainingStats};\n    const homeTrainingStats = {...state.data.teams.home.trainingStats};\n    const awayTrainingStats = {...state.data.teams.away.trainingStats};\n    trainingStats.winPercs = [...trainingStats.winPercs, validation.reduce((p, x) => p + (x.homePoints > x.awayPoints ? 1 : 0), 0) / validation.length];\n    trainingStats.lossPercs = [...trainingStats.lossPercs, validation.reduce((p, x) => p + (x.homePoints < x.awayPoints ? 1 : 0), 0) / validation.length];\n    trainingStats.tiePercs = [...trainingStats.tiePercs, validation.reduce((p, x) => p + (x.homePoints === x.awayPoints ? 1 : 0), 0) / validation.length];\n    const win5s = trainingStats.winPercs.slice(-5).reduce((p, x) => p + x, 0);\n    const tie5s = trainingStats.tiePercs.slice(-5).reduce((p, x) => p + x, 0);\n    const losses5s = trainingStats.lossPercs.slice(-5).reduce((p, x) => p + x, 0);\n    const total5s = win5s + tie5s + losses5s;\n    trainingStats.win5Percs = [...trainingStats.win5Percs, win5s / total5s];\n    trainingStats.tie5Percs = [...trainingStats.tie5Percs, tie5s / total5s];\n    trainingStats.losses5Percs = [...trainingStats.losses5Percs, losses5s / total5s];\n    homeTrainingStats.points = [...homeTrainingStats.points, validation.reduce((p, x) => p + x.homePoints, 0) / validation.length];\n    awayTrainingStats.points = [...awayTrainingStats.points, validation.reduce((p, x) => p + x.awayPoints, 0) / validation.length];\n    homeTrainingStats.gold = [...homeTrainingStats.gold, validation.reduce((p, x) => p + x.homeGold, 0) / validation.length];\n    awayTrainingStats.gold = [...awayTrainingStats.gold, validation.reduce((p, x) => p + x.awayGold, 0) / validation.length];\n\n    // console.log('[Breeding]', JSON.stringify(getLastTrainingStats(trainingStats)));\n\n    // const arenaInfos = [...state.data.arenaInfos];\n    // // Update winners\n    // for (let i=0; i < state.layout.arenas; i++) {\n    //   arenaInfos[i] = {\n    //     ...arenaInfos[i],\n    //     winner: arenaStats[i].homePoints > arenaStats[i].awayPoints ? ArenaWinner.Home\n    //       : arenaStats[i].homePoints < arenaStats[i].awayPoints ? ArenaWinner.Away\n    //       : ArenaWinner.Tie\n    //   }\n    // }\n\n    // console.table(arenaSelectionSorted);\n\n    state.setData({\n      trainingStats,\n    });\n    state.updateTeam('home', { trainingStats: homeTrainingStats });\n    state.updateTeam('away', { trainingStats: awayTrainingStats });\n\n    // Save top creatures\n\n    const getToSaveBrains = async (team: Teams) => {\n      const elitism = arenaStats.slice(0, state.data.trainingConfig.elitismCount).map(x => ({\n        ...x,\n        points: team === Teams.HomeTeam ? (x.homeGold - x.awayGold) : (x.awayGold - x.homeGold)\n      }));\n      elitism.sort((a, b) => b.points - a.points);\n      let toSaveArenaIndex = elitism[0].arenaIndex;\n      const toSaveUnits = new EntitiesQuery([Creature.component])\n        .filterValue(ArenaInstance.cpuComponent, o => o[0] === toSaveArenaIndex, d => [])\n        .filterValue(CpuTeamComponent, o => o === team, d => [])\n        .get(state);\n      return await Promise.all(toSaveUnits.map(unit => serializeCreatureBrain(state, unit)));\n    }\n    state.setData({\n      toSaveCreatureBrains: [\n        ...(state.data.teams.home.train ? await getToSaveBrains(Teams.HomeTeam) : []),\n        ...(state.data.teams.away.train ? await getToSaveBrains(Teams.AwayTeam) : []),\n      ]\n    });\n\n    // state.setData({ arenaInfos });\n  }\n\n  copyAndMutate = new CopyAndMutateBrains(this.gls);\n}\n\nfunction numberArrayToFirebaseBlob(values: number[]) {\n  const arr = new Float32Array(values);\n  return firebase.firestore.Blob.fromUint8Array(new Uint8Array(arr.buffer));\n}\nasync function serializeCreatureBrain(state: GpuWorldState, entityCell: EntityRef) {\n  const hiddenLayerWeightsP = state.ecs.getComponentData(HiddenLayer.weights.component, entityCell, true);\n  const hiddenLayerBiasesP = state.ecs.getComponentData(HiddenLayer.biases.component, entityCell, true);\n  const memoryLayerWeightsP = state.ecs.getComponentData(MemoryLayer.weights.component, entityCell, true);\n  const memoryLayerBiasesP = state.ecs.getComponentData(MemoryLayer.biases.component, entityCell, true);\n  const outputLayerWeightsP = state.ecs.getComponentData(OutputLayer.weights.component, entityCell, true);\n  const outputLayerBiasesP = state.ecs.getComponentData(OutputLayer.biases.component, entityCell, true);\n  const playerUnit = state.ecs.getComponentData(CpuPlayerUnitComponent, entityCell)!;\n  if (playerUnit.unit.type !== 'creature') {\n    throw new Error('Not a creature');\n  }\n  const brain: DbCreatureBrain = {\n    creatureId: playerUnit.unit.id ?? '',\n    name: '',\n    ownerId: state.appState?.state.loggedInUserId ?? '',\n    generation: (playerUnit.unit.generation ?? 0) + state.data.round + 1,\n    hiddenLayerWeights: numberArrayToFirebaseBlob(lodash.flatMap(await hiddenLayerWeightsP, v => [v.x, v.y, v.z, v.w])),\n    hiddenLayerBiases: numberArrayToFirebaseBlob(await hiddenLayerBiasesP),\n    memoryLayerWeights: numberArrayToFirebaseBlob(lodash.flatMap(await memoryLayerWeightsP, v => [v.x, v.y, v.z, v.w])),\n    memoryLayerBiases: numberArrayToFirebaseBlob(await memoryLayerBiasesP),\n    outputLayerWeights: numberArrayToFirebaseBlob(lodash.flatMap(await outputLayerWeightsP, v => [v.x, v.y, v.z, v.w])),\n    outputLayerBiases: numberArrayToFirebaseBlob(await outputLayerBiasesP),\n  };\n  return { brain, id: playerUnit.unit.id ?? '' };\n}\n\nexport async function uploadCreatureBrains(state: GpuWorldState) {\n  for (const brain of state.data.toSaveCreatureBrains) {\n    console.log(`Uploading creature ${brain.id} brain (${brain.brain.generation} generation)`);\n    await firebase.firestore().runTransaction(async t => {\n      const doc = firebase.firestore().collection(Db.creatureBrains).doc(brain.id);\n      t.set(doc, brain.brain);\n      t.update(firebase.firestore().collection(Db.creatures).doc(brain.id), partial<DbCreature>({ generation: brain.brain.generation }));\n    });\n  }\n}\n\nexport async function getCreatureBrain(creatureId: string) {\n  const savedSnap = await firebase.firestore().collection(Db.creatureBrains).doc(creatureId).get();\n  return savedSnap.data() as (DbCreatureBrain | undefined);\n}\n","import { GpuWorldState } from \"../State\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { ArenaStats, ArenaWinner } from \"../ECS/ArenaStats\";\nimport { Arena } from \"../ECS/Components\";\n\nexport class RoundStats {\n  wins: number[] = [];\n  losses: number[] = [];\n  ties: number[] = [];\n  homeAlive: number[] = [];\n  awayAlive: number[] = [];\n}\n\nexport class UpdateRoundStats {\n  constructor(private gls: GlState) {}\n\n  arenaStats = new EntitiesQuery([Arena.gpuComponent])\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([ArenaStats, Arena.sm], {\n      homeCount: uniformDef('int', d => d.data.teams.home.unitCount),\n      awayCount: uniformDef('int', d => d.data.teams.away.unitCount),\n      map: funcDef('vec4[2]', [['ivec2', 'entityCell']], `\n        int arenaIndex = ${Arena.sm.value}(entityCell);\n        ${ArenaStats.Stats} stats = ${ArenaStats.stats}(arenaIndex);\n        return vec4[](\n          vec4(\n            float(stats.winner == ${ArenaWinner.Home}),\n            float(stats.winner == ${ArenaWinner.Away}),\n            float(stats.winner == ${ArenaWinner.Tie}),\n            0\n          ),\n          vec4(\n            stats.home.alive,\n            stats.away.alive,\n            0,\n            0\n          )\n        );\n      `)\n    }))\n    .reduceSum();\n\n  run(state: GpuWorldState) {\n    const arenaStats = this.arenaStats.get(state);\n    state.setData({\n      roundStats: {\n        wins: [...state.data.roundStats.wins, arenaStats.data[0]],\n        losses: [...state.data.roundStats.losses, arenaStats.data[1]],\n        ties: [...state.data.roundStats.ties, arenaStats.data[2]],\n        homeAlive: [...state.data.roundStats.homeAlive, arenaStats.data[4] / state.layout.arenas],\n        awayAlive: [...state.data.roundStats.awayAlive, arenaStats.data[5] / state.layout.arenas],\n      }\n    });\n  }\n}\n","import * as Math2 from './Math';\nimport { RandomSeedable } from '../Util';\nimport { EditorTypedef } from '../Components/Editors/EditorTypedefs';\nimport { mat2, vec2 } from 'gl-matrix';\n\nexport interface Vector2 {\n  x: number;\n  y: number;\n}\n\nexport const Vector2Typedef: EditorTypedef = {\n  metatype: 'struct',\n  properties: {\n    x: { metatype: 'float' },\n    y: { metatype: 'float' },\n  }\n}\n\nexport function create(v: Vector2 | number): Vector2;\nexport function create(x: number, y: number): Vector2;\nexport function create(...args: any[]): Vector2 {\n  if (args.length === 1) {\n    if (typeof args[0] === 'number') {\n      return { x: args[0], y: args[0] };\n    } else {\n      return {...args[0]};\n    }\n  } else {\n    return { x: args[0], y: args[1] };\n  }\n}\n\nexport function zero(): Vector2 {\n  return { x: 0, y: 0 };\n}\n\nexport function random(min: number = 0, max: number = 1): Vector2 {\n  return random2(min, min, max, max);\n}\n\nexport function random2(minX: number, minY: number, maxX: number, maxY: number): Vector2 {\n  return { x: minX + Math.random() * (maxX - minX), y: minY + Math.random() * (maxY - minY) };\n}\n\nexport function randomSeedable(rand: RandomSeedable, min: number = 0, max: number = 1): Vector2 {\n  return randomSeedable2(rand, min, min, max, max);\n}\n\nexport function randomSeedable2(rand: RandomSeedable, minX: number, minY: number, maxX: number, maxY: number): Vector2 {\n  return { x: minX + rand.random() * (maxX - minX), y: minY + rand.random() * (maxY - minY) };\n}\n\nexport function fromPolarCoordinates(angle: number, radius: number): Vector2 {\n  return { x: Math.cos(angle) * radius, y: Math.sin(angle) * radius };\n}\n\nexport function length2(vec: Vector2): number {\n  return vec.x * vec.x + vec.y * vec.y;\n}\n\nexport function length(vec: Vector2): number {\n  return Math.sqrt(length2(vec));\n}\nexport function distance(a: Vector2, b: Vector2): number {\n  return length(sub(a, b));\n}\n\nexport function cross(a: Vector2, b: Vector2): number {\n  return (a.x * b.y ) - (a.y * b.x);\n}\nexport function dot(a: Vector2, b: Vector2): number {\n  return a.x * b.x + a.y * b.y;\n}\n\nexport function normalize(vec: Vector2): Vector2 {\n  const l = length(vec);\n  return { x: vec.x / l, y: vec.y / l };\n}\n\nexport function round(vec: Vector2): Vector2 {\n  return { x: Math.round(vec.x), y: Math.round(vec.y) };\n}\n\nexport function floor(vec: Vector2): Vector2 {\n  return { x: Math.floor(vec.x), y: Math.floor(vec.y) };\n}\nexport function ceil(vec: Vector2): Vector2 {\n  return { x: Math.ceil(vec.x), y: Math.ceil(vec.y) };\n}\nexport function fract(vec: Vector2): Vector2 {\n  return { x: Math2.fract(vec.x), y: Math2.fract(vec.y) };\n}\n\nexport function add(...args: Array<Vector2 | number>): Vector2 {\n  const res = create(args[0]);\n  for (let i=1; i < args.length; i++) {\n    const b = args[i];\n    if (typeof b === 'number') {\n      res.x += b;\n      res.y += b;\n    } else {\n      res.x += b.x;\n      res.y += b.y;\n    }\n  }\n  return res;\n}\n\nexport function inv(v: Vector2): Vector2 {\n  return { x: -v.x, y: -v.y };\n}\n\nexport function sub(a: Vector2 | number, b: Vector2 | number): Vector2 {\n  return add(a, typeof b === 'number' ? -b : inv(b));\n}\n\nexport function mul(vec: Vector2, f: number | Vector2): Vector2 {\n  if (typeof f === 'number') {\n    return { x: vec.x * f, y: vec.y * f };\n  } else {\n    return { x: vec.x * f.x, y: vec.y * f.y };\n  }\n}\n\nexport function div(vec: Vector2, f: number | Vector2): Vector2 {\n  if (typeof f === 'number') {\n    return mul(vec, 1 / f);\n  } else {\n    return { x: vec.x / f.x, y: vec.y / f.y };\n  }\n}\n\nexport function atan2(vec: Vector2): number {\n  return Math.atan2(vec.y, vec.x);\n}\n\nexport function mod(vec: Vector2, modulo: Vector2): Vector2 {\n  return { x: Math2.mod(vec.x, modulo.x), y: Math2.mod(vec.y, modulo.y) };\n}\n\nexport function clamp(vec: Vector2, min: number, max: number): Vector2;\nexport function clamp(vec: Vector2, min: Vector2, max: Vector2): Vector2;\nexport function clamp(vec: Vector2, min: any, max: any): Vector2 {\n  if (typeof min === 'number') {\n    min = create(min);\n  }\n  if (typeof max === 'number') {\n    max = create(max);\n  }\n  return {\n    x: Math2.clamp(vec.x, min.x, max.x),\n    y: Math2.clamp(vec.y, min.y, max.y),\n  };\n}\n\n\nexport function mix(a: Vector2, b: Vector2, p: number | Vector2): Vector2 {\n  if (typeof p === 'number') {\n    return {\n      x: Math2.mix(a.x, b.x, p),\n      y: Math2.mix(a.y, b.y, p),\n    }\n  } else {\n    return {\n      x: Math2.mix(a.x, b.x, p.x),\n      y: Math2.mix(a.y, b.y, p.y),\n    }\n  }\n}\n\nexport const lerp = mix;\n\nexport function perpendicular(a: Vector2): Vector2 {\n  return { x: a.y, y: -a.x };\n}\n\nexport function isEqual(a: Vector2, b: Vector2): boolean {\n  return a.x === b.x && a.y === b.y;\n}\n\nexport function interpolate(x: number, x0: number, x1: number, y0: Vector2, y1: Vector2): Vector2;\nexport function interpolate(x: Vector2, x0: Vector2, x1: Vector2, y0: Vector2, y1: Vector2): Vector2;\nexport function interpolate(x: any, x0: any, x1: any, y0: Vector2, y1: Vector2): Vector2 {\n  if (typeof x === 'number') {\n    const p = (x - x0) / (x1 - x0);\n    return mix(y0, y1, p);\n  } else {\n    const p = div(sub(x, x0), sub(x1, x0));\n    return mix(y0, y1, p);\n  }\n}\n\nexport function interpolateClamped(x: number, x0: number, x1: number, y0: Vector2, y1: Vector2): Vector2;\nexport function interpolateClamped(x: Vector2, x0: Vector2, x1: Vector2, y0: Vector2, y1: Vector2): Vector2;\nexport function interpolateClamped(x: any, x0: any, x1: any, y0: Vector2, y1: Vector2): Vector2 {\n  if (typeof x === 'number') {\n    const p = Math2.clamp((x - x0) / (x1 - x0), 0, 1);\n    return mix(y0, y1, p);\n  } else {\n    const p = clamp(div(sub(x, x0), sub(x1, x0)), 0, 1);\n    return mix(y0, y1, p);\n  }\n}\n\nexport function toGlVec2(v: Vector2): vec2 {\n  return vec2.fromValues(v.x, v.y);\n}\nexport function fromGlVec2(v: vec2): Vector2 {\n  return { x: v[0], y: v[1] };\n}\n\nexport function rotate2d(v: Vector2, a: number) {\n\tconst s = Math.sin(a);\n  const c = Math.cos(a);\n  const m = mat2.fromValues(c, s, -s, c);\n\treturn fromGlVec2(vec2.transformMat2(vec2.create(), toGlVec2(v), m));\n}\n\n// From: https://math.stackexchange.com/questions/383321/rotating-x-y-points-45-degrees\nexport function rotate45deg({ x, y }: Vector2): Vector2 {\n  return { x: (x + y) / Math.sqrt(2), y: (y - x) / Math.sqrt(2) };\n}","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { StepsPerSecond } from \"../../Time\";\nimport { CpuPlayerUnitComponent, CpuTeamComponent, Hitpoints, MaxHitpoints, PlayerUnit } from \"../ECS/UnitComponents\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { Position } from \"../ECS/Transform\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport * as Vector4 from '../../Math/Vector4';\nimport * as Vector2 from '../../Math/Vector2';\nimport { Teams, SideSize } from \"../StateLayout\";\nimport { ArenaWinner } from \"../ECS/ArenaStats\";\nimport { ArenaInstance, ArenaMemberIndex } from \"../ECS/Components\";\nimport lodash from 'lodash';\nimport { UnitDef } from \"../UnitDef\";\nimport { Gold } from \"../ECS/UnitComponents\";\n\ninterface ArenaUnitInfo {\n  position: Vector2.Vector2;\n  hitpoints: number;\n  unit: UnitDef;\n  gold: number;\n}\nexport class ArenaInfo {\n  winner = ArenaWinner.Undecided;\n  homeUnits: ArenaUnitInfo[] = [];\n  awayUnits: ArenaUnitInfo[] = [];\n  homeGold = 0;\n  awayGold = 0;\n}\n\nexport const ArenaInfosLimit = 128;\n\nexport class UpdateArenaInfos {\n  constructor(private gls: GlState) {}\n\n  units = new EntitiesQuery([PlayerUnit.component])\n    .filterValue(ArenaInstance.cpuComponent, v => v[0] < ArenaInfosLimit, d => []);\n  unitDatas = this.units\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([Position.sm, Hitpoints.sm, Gold.sm], {\n      map: funcDef('vec4', [['ivec2', 'entityCell']], `\n        return vec4(${Position.sm.value}(entityCell).xy, ${Hitpoints.sm.value}(entityCell), ${Gold.sm.value}(entityCell));\n      `)\n    }))\n    .toCpuQueuing(state => state.data.round);\n\n  updateArenaInfos(state: GpuWorldState) {\n    const arenaInfos = [...state.data.arenaInfos];\n    for (let i=0; i < arenaInfos.length; i++) {\n      arenaInfos[i] = { ...arenaInfos[i], homeUnits: [], awayUnits: []};\n    }\n    const units = this.units.get(state);\n    const readResults = this.unitDatas.queueRead(state);\n    const unitData = lodash.last(readResults());\n\n    for (let i=0; i < units.length; i++) {\n      const entityCell = units[i];\n      const arenaIndex = state.ecs.getComponentData(ArenaInstance.cpuComponent, entityCell)[0];\n      const arenaMemberIndex = state.ecs.getComponentData(ArenaMemberIndex.cpuComponent, entityCell)[0];\n      const team = state.ecs.getComponentData(CpuTeamComponent, entityCell);\n      const playUnit = state.ecs.getComponentData(CpuPlayerUnitComponent, entityCell)!;\n      const unitD = unitData ? unitData[i] : undefined;\n      const arenaUnitInfo: ArenaUnitInfo = {\n        position: unitD ? Vector4.xy(unitD.value[0]) : Vector2.create(0),\n        hitpoints: unitD ? unitD.value[0].z : MaxHitpoints,\n        unit: playUnit.unit,\n        gold: unitD ? unitD.value[0].w : 0,\n      }\n      if (team === Teams.HomeTeam) {\n        arenaInfos[arenaIndex].homeUnits[arenaMemberIndex] = arenaUnitInfo;\n      } else {\n        arenaInfos[arenaIndex].awayUnits[arenaMemberIndex - SideSize] = arenaUnitInfo;\n      }\n    }\n    for (let i=0; i < arenaInfos.length; i++) {\n      arenaInfos[i] = {\n        ...arenaInfos[i],\n        homeGold: arenaInfos[i].homeUnits.reduce((p, x) => p + x.gold, 0),\n        awayGold: arenaInfos[i].awayUnits.reduce((p, x) => p + x.gold, 0)\n      };\n    }\n    state.setData({ arenaInfos });\n  }\n\n  run(state: GpuWorldState) {\n    if (state.data.stepCounter % StepsPerSecond === 0 && !state.data.turboMode) {\n      this.updateArenaInfos(state);\n    }\n  }\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { Hitpoints, MaxHitpoints, Team, UnitStats } from \"./UnitComponents\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { Teams, SideSize } from \"../StateLayout\";\nimport { UnitsInArena } from \"./ArenaStats\";\nimport { Position } from \"./Transform\";\nimport { ArenaInstance } from \"./Components\";\n\nexport function UpdateUnitStats(gls: GlState) {\n  return new ArchetypesQuery([UnitStats.AliveTime.component, UnitStats.CumulativeHitpoints.component, Hitpoints.component])\n    .updateGpu(gls, [UnitStats.AliveTime.component, UnitStats.CumulativeHitpoints.component, UnitStats.MinDistEnemyStatue.component], shaderModule([\n      Hitpoints.sm, UnitStats.AliveTime.sm, UnitStats.CumulativeHitpoints.sm, UnitStats.MinDistEnemyStatue.sm,\n      UnitStats.AliveTime.writer, UnitStats.CumulativeHitpoints.writer, UnitStats.MinDistEnemyStatue.writer,\n      Team.sm, UnitsInArena, Position.sm, ArenaInstance.sm\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float aliveTime = ${UnitStats.AliveTime.sm.value}(entityCell);\n        float cumulativeHitpoints = ${UnitStats.CumulativeHitpoints.sm.value}(entityCell);\n        float minDistEnemyStatue = ${UnitStats.MinDistEnemyStatue.sm.value}(entityCell);\n        float hitpoints = ${Hitpoints.sm.value}(entityCell);\n        if (hitpoints > 0.0) {\n          aliveTime += 1.0;\n\n          int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n          int team = ${Team.sm.value}(entityCell);\n          int enemyStatueIndex = team == ${Teams.HomeTeam} ? ${SideSize} : ${0};\n          ivec2 enemyStatue = ${UnitsInArena.unit}(arenaIndex, enemyStatueIndex);\n          vec3 position = ${Position.sm.value}(entityCell);\n          vec3 statuePosition = ${Position.sm.value}(enemyStatue);\n          minDistEnemyStatue = min(distance(position, statuePosition), minDistEnemyStatue);\n        }\n        cumulativeHitpoints += clamp(hitpoints, 0., ${glslFloat(MaxHitpoints)});\n\n        ${UnitStats.AliveTime.writer.write}(aliveTime);\n        ${UnitStats.CumulativeHitpoints.writer.write}(cumulativeHitpoints);\n        ${UnitStats.MinDistEnemyStatue.writer.write}(minDistEnemyStatue);\n      `)\n    }));\n}\n","import { GpuWorldState } from \"../State\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { CastingAbilityHelpers, Casting, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData } from \"./Abilities\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { SingleTargetDamage } from \"../ECS/DamageCalc\";\nimport { Hitpoints } from \"../ECS/UnitComponents\";\nimport { Crippleable } from \"../Buffs/Cripple\";\n\nexport class UpdateTalons {\n  constructor(private gls: GlState) {}\n\n  singleTargetDamage = new SingleTargetDamage(this.gls,\n    [abilitiesData.component[Abilities.Talons].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Talons})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.Talons, 'Settings').damage.value),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.damageSetting;\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetDamage.run(state);\n  }\n}\n\nexport class UpdateCleavers {\n  constructor(private gls: GlState) {}\n\n  singleTargetDamage = new SingleTargetDamage(this.gls,\n    [abilitiesData.component[Abilities.Cleavers].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Cleavers})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.Cleavers, 'Settings').damage.value),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.damageSetting;\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetDamage.run(state);\n  }\n}\n\nexport class UpdateBloodClaws {\n  constructor(private gls: GlState) {}\n\n  singleTargetDamage = new SingleTargetDamage(this.gls,\n    [abilitiesData.component[Abilities.BloodClaws].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.BloodClaws})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.BloodClaws, 'Settings').damage.value),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.damageSetting;\n      `)\n    }));\n\n  heal = new ArchetypesQuery([abilitiesData.component[Abilities.BloodClaws].gpuComponent])\n    .mapGpu(this.gls, Hitpoints.component, shaderModule([\n      CastingAbilityHelpers,\n      Casting.Target.sm,\n      Hitpoints.sm,\n      Hitpoints.writer,\n      UnitRef.sm,\n    ], {\n      map: funcDef('float', [['ivec2', 'entityCell'], ['float', 'value']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.BloodClaws})) {\n          return value;\n        }\n        float targetHp = ${Hitpoints.sm.value}(${Casting.Target.sm.value}(unit));\n        return value + min(targetHp, 20.);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetDamage.run(state);\n    this.heal.run(state);\n  }\n}\n\nexport class UpdateCripplers {\n  constructor(private gls: GlState) {}\n\n  singleTargetDamage = new SingleTargetDamage(this.gls,\n    [abilitiesData.component[Abilities.Cripplers].gpuComponent],\n    shaderModule([Casting.Target.sm, CastingAbilityHelpers, UnitRef.sm], {\n      originator: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        return ${UnitRef.sm.value}(entityCell);\n      `),\n      getTarget: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Cripplers})) {\n          return ivec2(-1);\n        } else {\n          return ${Casting.Target.sm.value}(unit);\n        }\n      `),\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.BloodClaws, 'Settings').damage.value),\n      baseDamage: funcDef('float', [['ivec2', 'entityCell']], `\n        return Self.damageSetting;\n      `)\n    }));\n\n  buff = new ArchetypesQuery([abilitiesData.component[Abilities.Cripplers].gpuComponent])\n    .updateGpu(this.gls, [Crippleable.component], shaderModule([\n      CastingAbilityHelpers, Casting.Target.sm, Crippleable.writer, UnitRef.sm\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Cripplers})) {\n          return ivec2(-1);\n        }\n        ${Crippleable.writer.write}(60 * 3); // duration\n        return ${Casting.Target.sm.value}(unit);\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.singleTargetDamage.run(state);\n    this.buff.run(state);\n  }\n}\n","import { DecisionsCMs } from \"../Brain/Decisions\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { CompiledShaderModule, shaderModule, funcDef, outDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { Program } from \"../../GpuUtil/Program\";\nimport { RenderTarget } from \"../../GpuUtil/RenderTarget\";\nimport { GpuWorldState } from \"../State\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { keysOfEnum } from \"../../Util\";\nimport { Position } from \"../ECS/Transform\";\nimport { Hitpoints, Unit } from \"../ECS/UnitComponents\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { ArenaMemberIndex } from \"../ECS/Components\";\nimport { Db, full, DbReplay, DbReplayContent } from \"db\";\nimport firebase from 'firebase/app';\n\nenum UnitReplayChannels {\n  PositionX,\n  PositionY,\n  PositionZ,\n  Hitpoints\n}\nconst UnitReplayChannelsCount = keysOfEnum(UnitReplayChannels).length + DecisionsCMs.length;\nexport const UnitReplayChannelsSlices = Math.ceil(UnitReplayChannelsCount / 4);\n\nexport class CaptureReplay {\n  constructor(private gls: GlState) {}\n\n  shader = new CompiledShaderModule(shaderModule([\n    ...DecisionsCMs.map(c => c.sm),\n    UnitsInArena,\n    Position.sm,\n    Hitpoints.sm,\n  ], {\n    outValues: outDef(`vec4[${UnitReplayChannelsSlices}]`),\n    renderArena: uniformDef('int', d => d.data.renderArena),\n    main: funcDef('void', [], `\n      int arenaMemberIndex = int(gl_FragCoord.y);\n      ivec2 entityCell = ${UnitsInArena.unit}(Self.renderArena, arenaMemberIndex);\n      vec3 position = ${Position.sm.value}(entityCell);\n      outValues[${Math.floor(UnitReplayChannels.PositionX / 4)}][${UnitReplayChannels.PositionX % 4}] = position.x;\n      outValues[${Math.floor(UnitReplayChannels.PositionY / 4)}][${UnitReplayChannels.PositionY % 4}] = position.y;\n      outValues[${Math.floor(UnitReplayChannels.PositionZ / 4)}][${UnitReplayChannels.PositionZ % 4}] = position.z;\n      outValues[${Math.floor(UnitReplayChannels.Hitpoints / 4)}][${UnitReplayChannels.Hitpoints % 4}] = ${Hitpoints.sm.value}(entityCell);\n      ${DecisionsCMs.map((c, i) => {\n        const l = i + keysOfEnum(UnitReplayChannels).length;\n        return `outValues[${Math.floor(l / 4)}][${l % 4}] = float(${c.sm.value}(entityCell));`;\n      }).join('\\n')}\n    `)\n  }));\n  program = new Program(this.gls, this.shader.source);\n  renderTarget = new RenderTarget(this.gls);\n\n  run(state: GpuWorldState) {\n    if (state.data.gameInstance.type !== 'battle' && state.data.gameInstance.type !== 'train') {\n      return;\n    }\n    this.shader.updateUniformValues(state);\n\n    const slice = state.textures.unitsReplay.sliceAll().selectAbsolute({\n      x: state.data.stepCounter - state.data.battleStartStep,\n      y: 0,\n      width: 1,\n      height: state.textures.unitsReplay.size.height\n    });\n    this.renderTarget.set(slice.back);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.gls.prepareForComputation(slice.rect);\n    this.gls.drawQuad(this.program);\n  }\n}\n\nexport async function saveReplay(state: GpuWorldState, title: string) {\n  let instance;\n  if (state.data.gameInstance.type === 'battle') {\n    instance = {\n      type: 'battle',\n      battleId: state.data.battleId,\n      homeTeamId: state.data.teams.home.id,\n      awayTeamId: state.data.teams.away.id,\n    };\n  } else if (state.data.gameInstance.type === 'train') {\n    instance = { type: 'train' };\n  } else {\n    throw Error(`Invalid replay instance: ${state.data.gameInstance.type}`);\n  }\n  const replay = await firebase.firestore().collection(Db.replays).add(full<DbReplay>({\n    userId: state.appState?.state.loggedInUserId ?? '',\n    created: firebase.firestore.Timestamp.now(),\n    title,\n    battleground: state.data.battleground,\n    instance,\n  }));\n  const unitsReplay = await state.textures.unitsReplay.readAsync();\n  await firebase.firestore().collection(Db.replayContents).doc(replay.id).set(full<DbReplayContent>({\n    userId: state.appState?.state.loggedInUserId ?? '',\n    homeUnits: JSON.stringify(state.data.teams.home.units.map(x => ({...x, brain: undefined })), null, 2),\n    awayUnits: JSON.stringify(state.data.teams.away.units.map(x => ({...x, brain: undefined })), null, 2),\n    unitsReplay: firebase.firestore.Blob.fromUint8Array(new Uint8Array(unitsReplay.data.buffer))\n  }))\n}\n\nexport class PlaybackReplayDecisions {\n  constructor(private gls: GlState) {}\n\n  decisions = new ArchetypesQuery([Unit.component])\n    .updateGpu(this.gls, [...DecisionsCMs.map(c => c.component)], shaderModule([\n      ArenaMemberIndex.sm, ...DecisionsCMs.map(c => c.writer)\n    ], {\n      stepCounter: uniformDef('int', d => d.data.stepCounter - d.data.battleStartStep),\n      replay: uniformDef('sampler2DArray', d => d.textures.unitsReplay),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        int arenaMemberIndex = ${ArenaMemberIndex.sm.value}(entityCell);\n        ${DecisionsCMs.map((c, i) => {\n            const l = i + keysOfEnum(UnitReplayChannels).length;\n            return `${c.writer.write}(${c.component.format}(texelFetch(Self.replay, ivec3(Self.stepCounter, arenaMemberIndex, ${Math.floor(l / 4)}), 0)[${l % 4}]));`;\n          }).join('\\n')}\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    if (state.data.gameInstance.type !== 'replay') {\n      return;\n    }\n    this.decisions.run(state);\n  }\n}\n\nexport class PlaybackReplayPositionHitpoints {\n  constructor(private gls: GlState) {}\n\n  common = new ArchetypesQuery([Unit.component])\n    .updateGpu(this.gls, [Position.gpuComponent, Hitpoints.component], shaderModule([\n      ArenaMemberIndex.sm, Position.writer, Hitpoints.writer\n    ], {\n      stepCounter: uniformDef('int', d => d.data.stepCounter - d.data.battleStartStep),\n      replay: uniformDef('sampler2DArray', d => d.textures.unitsReplay),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        int arenaMemberIndex = ${ArenaMemberIndex.sm.value}(entityCell);\n        vec4 slice0 = texelFetch(Self.replay, ivec3(Self.stepCounter, arenaMemberIndex, 0), 0);\n        ${Position.writer.write}(slice0.xyz);\n        ${Hitpoints.writer.write}(slice0.w);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    if (state.data.gameInstance.type !== 'replay') {\n      return;\n    }\n    this.common.run(state);\n  }\n}\n","import { GpuWorldState } from \"../State\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { CastingAbilityHelpers, SleepDartProjectileRef, Casting, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData, GunProjectileRef } from \"./Abilities\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { Position, LocalToWorld } from \"../ECS/Transform\";\nimport { SeekingProjectileTarget, DamageProjectile, ProjectileSpeed, DazeProjectile, KnockbackProjectile } from \"../Projectiles/Projectiles\";\nimport { StepsPerSecond } from \"../../Time\";\nimport { MatrixSM } from \"../../GpuUtil/SM2Utils\";\nimport { glslVec3 } from \"../../GpuUtil\";\n\nconst ProjectileOffset = { x: 0, y: 1.237, z: 1.1705 };\nconst TailAttackOffset = { x: 0, y: 0.3068, z: 2.1917 };\n\nexport class UpdateSleepDart {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([abilitiesData.component[Abilities.SleepDart].gpuComponent])\n    .updateGpu(this.gls, [\n      Position.gpuComponent,\n      SeekingProjectileTarget.component,\n      ProjectileSpeed.component,\n      DazeProjectile.component,\n    ], shaderModule([\n      CastingAbilityHelpers,\n      Casting.Target.sm,\n      abilitiesData.component[Abilities.SleepDart].sm,\n      SeekingProjectileTarget.writer,\n      Position.writer,\n      DazeProjectile.writer,\n      SleepDartProjectileRef.sm,\n      Position.sm,\n      ProjectileSpeed.writer,\n      MatrixSM,\n      LocalToWorld.sm,\n      UnitRef.sm,\n    ], {\n      sleepDuration: uniformDef('float', () => abilitiesData.get(Abilities.SleepDart, 'Settings').sleepDuration.value * StepsPerSecond),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.SleepDart})) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ${glslVec3(TailAttackOffset)};\n        vec3 projectileStartPosition = ${MatrixSM.transformPoint}(${LocalToWorld.sm.value}(unit), projectileOffset);\n        ${Position.writer.write}(projectileStartPosition);\n        ${SeekingProjectileTarget.writer.write}(${Casting.Target.sm.value}(unit));\n        ${ProjectileSpeed.writer.write}(1.0);\n        ${DazeProjectile.writer.write}(Self.sleepDuration);\n        return ${SleepDartProjectileRef.sm.value}(entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\nexport class UpdatePistol {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([abilitiesData.component[Abilities.Pistol].gpuComponent])\n    .updateGpu(this.gls, [\n      Position.gpuComponent,\n      SeekingProjectileTarget.component,\n      ProjectileSpeed.component,\n      DamageProjectile.component,\n    ], shaderModule([\n      CastingAbilityHelpers,\n      Casting.Target.sm,\n      SeekingProjectileTarget.writer,\n      Position.writer,\n      DamageProjectile.writer,\n      GunProjectileRef.sm,\n      Position.sm,\n      ProjectileSpeed.writer,\n      MatrixSM,\n      LocalToWorld.sm,\n      UnitRef.sm,\n    ], {\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.Pistol, 'Settings').damage.value),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Pistol})) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ${glslVec3(ProjectileOffset)};\n        vec3 projectileStartPosition = ${MatrixSM.transformPoint}(${LocalToWorld.sm.value}(unit), projectileOffset);\n        ${Position.writer.write}(projectileStartPosition);\n        ${SeekingProjectileTarget.writer.write}(${Casting.Target.sm.value}(unit));\n        ${ProjectileSpeed.writer.write}(0.5);\n        ${DamageProjectile.writer.write}(Self.damageSetting);\n        return ${GunProjectileRef.sm.value}(entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\nexport class UpdateBlaster {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([abilitiesData.component[Abilities.Blaster].gpuComponent])\n    .updateGpu(this.gls, [\n      Position.gpuComponent,\n      SeekingProjectileTarget.component,\n      ProjectileSpeed.component,\n      DamageProjectile.component,\n    ], shaderModule([\n      CastingAbilityHelpers,\n      Casting.Target.sm,\n      SeekingProjectileTarget.writer,\n      Position.writer,\n      DamageProjectile.writer,\n      GunProjectileRef.sm,\n      Position.sm,\n      ProjectileSpeed.writer,\n      MatrixSM,\n      LocalToWorld.sm,\n      UnitRef.sm,\n    ], {\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.Blaster, 'Settings').damage.value),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Blaster})) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ${glslVec3(ProjectileOffset)};\n        vec3 projectileStartPosition = ${MatrixSM.transformPoint}(${LocalToWorld.sm.value}(unit), projectileOffset);\n        ${Position.writer.write}(projectileStartPosition);\n        ${SeekingProjectileTarget.writer.write}(${Casting.Target.sm.value}(unit));\n        ${ProjectileSpeed.writer.write}(0.5);\n        ${DamageProjectile.writer.write}(Self.damageSetting);\n        return ${GunProjectileRef.sm.value}(entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\nexport class UpdateMagnum {\n  constructor(private gls: GlState) {}\n\n  update = new ArchetypesQuery([abilitiesData.component[Abilities.Magnum].gpuComponent])\n    .updateGpu(this.gls, [\n      Position.gpuComponent,\n      SeekingProjectileTarget.component,\n      ProjectileSpeed.component,\n      DamageProjectile.component,\n      KnockbackProjectile.component,\n    ], shaderModule([\n      CastingAbilityHelpers,\n      Casting.Target.sm,\n      SeekingProjectileTarget.writer,\n      Position.writer,\n      DamageProjectile.writer,\n      KnockbackProjectile.writer,\n      GunProjectileRef.sm,\n      Position.sm,\n      ProjectileSpeed.writer,\n      MatrixSM,\n      LocalToWorld.sm,\n      UnitRef.sm,\n    ], {\n      damageSetting: uniformDef('float', () => abilitiesData.get(Abilities.Magnum, 'Settings').damage.value),\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (!${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Magnum})) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ${glslVec3(ProjectileOffset)};\n        vec3 projectileStartPosition = ${MatrixSM.transformPoint}(${LocalToWorld.sm.value}(unit), projectileOffset);\n        ${Position.writer.write}(projectileStartPosition);\n        ${SeekingProjectileTarget.writer.write}(${Casting.Target.sm.value}(unit));\n        ${ProjectileSpeed.writer.write}(0.5);\n        ${DamageProjectile.writer.write}(Self.damageSetting);\n        ${KnockbackProjectile.writer.write}(2000.);\n        return ${GunProjectileRef.sm.value}(entityCell);\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { GpuWorldState } from \"../State\";\nimport { CastingAbilityHelpers, UnitRef } from \"./Abilities\";\nimport { Abilities, abilitiesData } from \"./Abilities\";\nimport { Force } from \"../ECS/UnitComponents\";\nimport { RotationZ } from \"../ECS/Transform\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { SpatialSM } from \"../../GpuUtil/SM2Utils\";\n\nexport class UpdateLeap {\n  constructor(private gls: GlState) {}\n\n  private forces = new ArchetypesQuery([abilitiesData.component[Abilities.Leap].gpuComponent, Force.component])\n    .updateGpu(this.gls, [Force.component], shaderModule([\n      CastingAbilityHelpers, RotationZ.sm, SpatialSM, Force.writer, UnitRef.sm, Force.sm\n    ], {\n      update: funcDef('ivec2', [['ivec2', 'entityCell']], `\n        ivec2 unit = ${UnitRef.sm.value}(entityCell);\n        if (${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Leap})) {\n          float rotation = ${RotationZ.sm.value}(unit);\n          vec2 forward = ${SpatialSM.forward}(rotation);\n          ${Force.writer.write}(vec3(forward, 1.4) * 1000.);\n        } else {\n          ${Force.writer.write}(${Force.sm.value}(unit));\n        }\n        return unit;\n      `)\n    }));\n\n  run(state: GpuWorldState) {\n    this.forces.run(state);\n  }\n}\n","import { GpuWorldState } from \"../State\";\nimport { EntitiesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { ArenaStats } from \"../ECS/ArenaStats\";\nimport { Arena } from \"../ECS/Components\";\nimport lodash from 'lodash';\n\nexport class UpdateBattleScore {\n  constructor(private gls: GlState) {}\n\n  arenaStats = new EntitiesQuery([Arena.gpuComponent])\n    .filterValue(Arena.cpuComponent, (v, d) => v[0] === d.data.renderArena, d => [d.data.renderArena])\n    .toGpu(this.gls)\n    .mapToTemp(shaderModule([ArenaStats, Arena.sm], {\n      map: funcDef('vec4', [['ivec2', 'entityCell']], `\n        int arenaIndex = ${Arena.sm.value}(entityCell);\n        ${ArenaStats.Stats} stats = ${ArenaStats.stats}(arenaIndex);\n        return vec4(stats.homePoints, stats.awayPoints, stats.home.unitsAlive, stats.away.unitsAlive);\n      `)\n    }))\n    .toCpuQueuing(state => state.data.round);\n\n  run(state: GpuWorldState) {\n    const readResults = this.arenaStats.queueRead(state);\n    const arenaStats = lodash.last(readResults());\n    if (arenaStats) {\n      const homePoints = arenaStats[0].value[0].x;\n      const awayPoints = arenaStats[0].value[0].y;\n      const homeAlive = arenaStats[0].value[0].z;\n      const awayAlive = arenaStats[0].value[0].w;\n      if (state.data.teams.home.battlePoints !== homePoints) {\n        state.updateTeam('home', { battlePoints: homePoints });\n      }\n      if (state.data.teams.away.battlePoints !== awayPoints) {\n        state.updateTeam('away', { battlePoints: awayPoints });\n      }\n      if (state.data.teams.home.battleUnitsAlive !== homeAlive) {\n        state.updateTeam('home', { battleUnitsAlive: homeAlive });\n      }\n      if (state.data.teams.away.battleUnitsAlive !== awayAlive) {\n        state.updateTeam('away', { battleUnitsAlive: awayAlive });\n      }\n    }\n  }\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { Position, RotationZ } from \"./Transform\";\nimport { Hitpoints, MaxHitpoints, DuckAI } from \"./UnitComponents\";\nimport { AngleLerpSM, MathConstsSM, RandomUtilSM } from \"../../GpuUtil/SM2Utils\";\nimport { Decisions } from \"../Brain/Decisions\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { Seeds } from \"../../Util\";\n\nexport function UpdateDuckAI(gls: GlState) {\n  return new ArchetypesQuery([DuckAI.component])\n    .updateGpu(gls, [Decisions.MoveX.component, Decisions.Rotate.component], shaderModule([\n      Decisions.MoveX.writer, Decisions.Rotate.writer,\n      Position.sm, Hitpoints.sm, RotationZ.sm, AngleLerpSM, MathConstsSM,\n      RandomUtilSM,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float moveX = 0.;\n        float rotation = ${RotationZ.sm.value}(entityCell);\n        float hitpoints = ${Hitpoints.sm.value}(entityCell);\n        float rotate;\n        if (hitpoints > 0.) {\n          if (hitpoints >= ${glslFloat(MaxHitpoints)}) {\n            // Roaming\n            float mc = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('duckMoveChange1')}, ${Seeds.get('duckMoveChange2')});\n            if (mc > 0.9) {\n              moveX = moveX > 0. ? 0. : 0.1;\n            }\n            float rc = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('duckRotateChange1')}, ${Seeds.get('duckRotateChange2')});\n            if (rc > 0.9) {\n              float rr = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('duckRotate1')}, ${Seeds.get('duckRotate2')});\n              rotate = (rr * 2. - 1.);\n            }\n          } else {\n            // Fleeing\n            vec3 position = ${Position.sm.value}(entityCell);\n            moveX = 1.;\n            float targetRotation = position.x < position.y\n              ? (${MathConstsSM.PI} * 3. / 4.)\n              : (${MathConstsSM.PI} * 7. / 4.);\n            float rot = ${AngleLerpSM.shortestAngleDist}(rotation, targetRotation);\n            rotate = rot < 0. ? -1. : 1.;\n          }\n        }\n        ${Decisions.MoveX.writer.write}(moveX);\n        ${Decisions.Rotate.writer.write}(rotate);\n      `)\n    }))\n}","import { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef, uniformDef } from \"../../GpuUtil/ShaderModule\";\nimport { Decisions } from \"../Brain/Decisions\";\nimport { RandomUtilSM, SpatialSM } from \"../../GpuUtil/SM2Utils\";\nimport { Seeds } from \"../../Util\";\nimport { Team, CrabAI, Focuser } from \"./UnitComponents\";\nimport { Position, RotationZ } from \"./Transform\";\nimport { GroundHeightSM } from \"./Ground\";\nimport { SideSize, Teams } from \"../StateLayout\";\n\nexport function UpdateCrabAI(gls: GlState) {\n  return new ArchetypesQuery([CrabAI.component])\n    .updateGpu(gls, [\n      Decisions.ChaseFocus.component, Decisions.CastingSlot.component, Decisions.MoveX.component,\n      Decisions.Rotate.component, Decisions.ChangeFocus.component\n    ], shaderModule([\n      Decisions.ChaseFocus.writer, Decisions.CastingSlot.writer, Decisions.MoveX.writer,\n      Decisions.Rotate.writer, Decisions.ChangeFocus.writer,\n      Decisions.MoveX.sm, Decisions.Rotate.sm,\n      Focuser.sm, Team.sm, SpatialSM,\n      RandomUtilSM, GroundHeightSM, Position.sm, RotationZ.sm,\n    ], {\n      homeCount: uniformDef('int', d => d.data.teams.home.unitCount),\n      awayCount: uniformDef('int', d => d.data.teams.away.unitCount),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        vec3 position = ${Position.sm.value}(entityCell);\n        float rotation = ${RotationZ.sm.value}(entityCell);\n        vec2 forward = ${SpatialSM.forward}(rotation);\n        int team = ${Team.sm.value}(entityCell);\n        float forwardHeight = ${GroundHeightSM.atPosition}(position.xy + forward * 2.);\n        float forwardElevation = position.z - forwardHeight;\n        bool precipiceInFront = forwardElevation > 1.;\n\n        ivec2 focus = ${Focuser.sm.value}(entityCell);\n        bool hasFocus = focus.x >= 0;\n        float moveX = ${Decisions.MoveX.sm.value}(entityCell);\n        float rotate = ${Decisions.Rotate.sm.value}(entityCell);\n        bool changeFocus = true;\n        if (hasFocus) {\n          int focusTeam = ${Team.sm.value}(focus);\n          if (team != focusTeam) {\n            vec3 focusPosition = ${Position.sm.value}(focus);\n            float focusHeight = ${GroundHeightSM.atPosition}(focusPosition.xy);\n            float focusElevation = focusPosition.z - focusHeight;\n            if (focusElevation > 1. || precipiceInFront) {\n              ${Decisions.ChaseFocus.writer.write}(0.);\n              ${Decisions.CastingSlot.writer.write}(0);\n              changeFocus = true;\n            } else {\n              ${Decisions.ChaseFocus.writer.write}(1.);\n              ${Decisions.CastingSlot.writer.write}(1);\n              changeFocus = false;\n            }\n          }\n          moveX = 0.;\n          rotate = 0.;\n        } else {\n          // Roaming\n          float mc = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('crabMoveChange1')}, ${Seeds.get('crabMoveChange2')});\n          if (mc > 0.9) {\n            moveX = moveX > 0. ? 0. : 0.1;\n          }\n          float rc = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('crabRotateChange1')}, ${Seeds.get('crabRotateChange2')});\n          if (rc > 0.9) {\n            float rr = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('crabRotate1')}, ${Seeds.get('crabRotate2')});\n            rotate = (rr * 2. - 1.);\n          }\n          if (precipiceInFront) {\n            moveX = 0.;\n          }\n          ${Decisions.ChaseFocus.writer.write}(0.);\n          ${Decisions.CastingSlot.writer.write}(0);\n        }\n        ${Decisions.MoveX.writer.write}(moveX);\n        ${Decisions.Rotate.writer.write}(rotate);\n        if (changeFocus) {\n          int enemyCount = team == ${Teams.HomeTeam} ? awayCount : homeCount;\n          int newFocus = ${SideSize} - 1;\n          if (enemyCount > 1) { // If there are any units\n            float r = ${RandomUtilSM.entityRandom}(entityCell, ${Seeds.get('crabAiFocus1')}, ${Seeds.get('crabAiFocus2')});\n            newFocus += 1 + int(r * float(enemyCount - 1));\n          }\n          ${Decisions.ChangeFocus.writer.write}(newFocus + 1);\n        } else {\n          ${Decisions.ChangeFocus.writer.write}(0);\n        }\n      `)\n    }))\n}\n","import { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, uniformDef, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { Position } from \"./Transform\";\nimport { Team, Gold, PreviousGold, BountyComponents } from \"./UnitComponents\";\nimport { Teams, SideSize, StatuePosition, StepsInBattle } from \"../StateLayout\";\nimport { GpuWorldState } from \"../State\";\nimport { UnitsInArena, ArenaStats, ArenaWinner } from \"./ArenaStats\";\nimport { ArenaInstance } from \"./Components\";\nimport { vec2FromSize } from \"../../Math/Math\";\nimport { StepsPerSecond } from \"../../Time\";\nimport { UnitFieldPositions } from \"db\";\n\nconst UnitFieldPosition = shaderModule('UnitFieldPosition', [\n  Team.sm, Position.sm,\n], {\n  worldSize: uniformDef('vec2', d => vec2FromSize(d.data.worldSize)),\n  statuePosition: uniformDef('vec3', d => StatuePosition),\n  get: funcDef('int', [['ivec2', 'entityCell']], `\n    int team = ${Team.sm.value}(entityCell);\n    vec3 position = ${Position.sm.value}(entityCell);\n    vec2 mapUp = team == ${Teams.HomeTeam} ? normalize(vec2(1, 1)) : -normalize(vec2(1, 1));\n    vec2 mapCenter = Self.worldSize / 2.;\n    vec2 positionD = position.xy - mapCenter;\n    float positionUpDown = dot(positionD, mapUp) / length(mapCenter);\n    bool inEnemyTerritory = positionUpDown > 0.;\n    vec3 friendStatuePosition = vec3(Self.worldSize, 0) - Self.statuePosition;\n    vec3 enemyStatuePosition = Self.statuePosition;\n    if (team == ${Teams.HomeTeam}) {\n      enemyStatuePosition = friendStatuePosition;\n      friendStatuePosition = Self.statuePosition;\n    }\n    if (inEnemyTerritory) {\n      bool inEnemyBase = distance(position, enemyStatuePosition) < 5.;\n      if (inEnemyBase) {\n        return ${UnitFieldPositions.AwayBase};\n      } else {\n        return ${UnitFieldPositions.AwayTerritory};\n      }\n    } else {\n      bool inFriendBase = distance(position, friendStatuePosition) < 5.;\n      if (inFriendBase) {\n        return ${UnitFieldPositions.HomeBase};\n      } else {\n        return ${UnitFieldPositions.HomeTerritory};\n      }\n    }\n  `)\n})\n\nexport class UpdateTerritoryBounty {\n  constructor(private gls: GlState) { }\n  query = new ArchetypesQuery([Gold.component])\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      Gold.sm, Gold.writer, UnitFieldPosition,\n      BountyComponents.timeSpentHomeBase.sm, BountyComponents.timeSpentHomeTerritory.sm,\n      BountyComponents.timeSpentAwayBase.sm, BountyComponents.timeSpentAwayTerritory.sm,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float gold = ${Gold.sm.value}(entityCell);\n        int fieldPosition = ${UnitFieldPosition.get}(entityCell);\n        float bounty = fieldPosition == ${UnitFieldPositions.HomeBase} ? ${BountyComponents.timeSpentHomeBase.sm.value}(entityCell) :\n          fieldPosition == ${UnitFieldPositions.HomeTerritory} ? ${BountyComponents.timeSpentHomeTerritory.sm.value}(entityCell) :\n          fieldPosition == ${UnitFieldPositions.AwayTerritory} ? ${BountyComponents.timeSpentAwayTerritory.sm.value}(entityCell) :\n          fieldPosition == ${UnitFieldPositions.AwayBase} ? ${BountyComponents.timeSpentAwayBase.sm.value}(entityCell) :\n          0.;\n        gold += bounty;\n        ${Gold.writer.write}(gold);\n      `)\n    }));\n  run(state: GpuWorldState) {\n    if ((state.data.stepCounter - state.data.battleStartStep) % (StepsPerSecond * 5) === 0) {\n      this.query.run(state);\n    }\n  }\n}\n\nexport class UpdateTeamSpirit {\n  constructor(private gls: GlState) { }\n  query = new ArchetypesQuery([Gold.component, PreviousGold.component])\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      Gold.sm, Gold.writer, PreviousGold.sm,\n      UnitsInArena, ArenaInstance.sm, Team.sm,\n      BountyComponents.teamSpirit.sm\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float gold = ${Gold.sm.value}(entityCell);\n        float previousGold = ${PreviousGold.sm.value}(entityCell);\n        int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n        int team = ${Team.sm.value}(entityCell);\n        int teamOffset = team == ${Teams.HomeTeam} ? 0 : ${SideSize};\n        float teamGoldGain = 0.;\n        int nTeamMates = 0;\n        for (int i=1; i < ${SideSize}; i++) {\n          ivec2 unit = ${UnitsInArena.unit}(arenaIndex, teamOffset + i);\n          if (unit.x >= 0) {\n            float unitGold = ${Gold.sm.value}(unit);\n            float unitPreviousGold = ${PreviousGold.sm.value}(unit);\n            float gain = unitGold - unitPreviousGold;\n            teamGoldGain += gain;\n            nTeamMates++;\n          }\n        }\n        if (nTeamMates > 0) {\n          float gain = gold - previousGold;\n          float avgTeamGain = teamGoldGain / float(nTeamMates);\n          float teamSpirit = ${BountyComponents.teamSpirit.sm.value}(entityCell);\n          gold = previousGold + teamSpirit * avgTeamGain + (1. - teamSpirit) * gain;\n        }\n        ${Gold.writer.write}(gold);\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\n// export class UpdateZeroSumBounty {\n//   constructor(private gls: GlState) { }\n//   query = new ArchetypesQuery([Gold.component, PreviousGold.component])\n//     .updateGpu(this.gls, [Gold.component], shaderModule2([\n//       Gold.sm, Gold.writer, PreviousGold.sm,\n//       UnitsInArena, ArenaInstance.sm, Team.sm\n//     ], {\n//       update: funcDef('void', [['ivec2', 'entityCell']], `\n//         float gold = ${Gold.sm.value}(entityCell);\n//         int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n//         int team = ${Team.sm.value}(entityCell);\n//         int enemiesOffset = team == ${Teams.HomeTeam} ? ${SideSize} : 0;\n//         float enemyGoldGain = 0.;\n//         int nEnemies = 0;\n//         for (int i=1; i < ${SideSize}; i++) {\n//           ivec2 enemy = ${UnitsInArena.unit}(arenaIndex, enemiesOffset + i);\n//           if (enemy.x >= 0) {\n//             float enemyGold = ${Gold.sm.value}(enemy);\n//             float enemyPreviousGold = ${PreviousGold.sm.value}(enemy);\n//             float gain = enemyGold - enemyPreviousGold;\n//             enemyGoldGain += gain;\n//             nEnemies++;\n//           }\n//         }\n//         if (nEnemies > 0) {\n//           gold -= enemyGoldGain / float(nEnemies);\n//         }\n\n//         ${Gold.writer.write}(gold);\n//       `)\n//     }));\n//   run(state: GpuWorldState) {\n//     if (state.derived.bounties.zeroSum) {\n//       this.query.run(state);\n//     }\n//   }\n// }\n\nexport class UpdateGoldTimeScaling {\n  constructor(private gls: GlState) { }\n  query = new ArchetypesQuery([Gold.component])\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      Gold.sm, PreviousGold.sm, Gold.writer,\n      BountyComponents.timeScaling.sm\n    ], {\n      time: uniformDef('float', d => (d.data.stepCounter - d.data.battleStartStep) / StepsInBattle),\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float gold = ${Gold.sm.value}(entityCell);\n        float previousGold = ${PreviousGold.sm.value}(entityCell);\n        float goldGain = gold - previousGold;\n        goldGain = mix(goldGain, goldGain * ${BountyComponents.timeScaling.sm.value}(entityCell), time);\n        gold = previousGold + goldGain;\n        ${Gold.writer.write}(gold);\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nexport class UpdatePreviousGold {\n  constructor(private gls: GlState) { }\n  query = new ArchetypesQuery([PreviousGold.component])\n    .updateGpu(this.gls, [PreviousGold.component], shaderModule([\n      Gold.sm, PreviousGold.writer\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float gold = ${Gold.sm.value}(entityCell);\n        ${PreviousGold.writer.write}(gold);\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}\n\nexport class UpdateVictoryLossBounty {\n  constructor(private gls: GlState) { }\n  query = new ArchetypesQuery([Gold.component])\n    .updateGpu(this.gls, [Gold.component], shaderModule([\n      Gold.sm, Gold.writer, ArenaInstance.sm, Team.sm,\n      ArenaStats, BountyComponents.victory.sm, BountyComponents.tie.sm, BountyComponents.loss.sm,\n    ], {\n      update: funcDef('void', [['ivec2', 'entityCell']], `\n        float gold = ${Gold.sm.value}(entityCell);\n        int arena = ${ArenaInstance.sm.value}(entityCell);\n        int winner = ${ArenaStats.stats}(arena).winner;\n        int team = ${Team.sm.value}(entityCell);\n        if ((team == ${Teams.HomeTeam} && winner == ${ArenaWinner.Home}) || (team == ${Teams.AwayTeam} && winner == ${ArenaWinner.Away})) {\n          gold += ${BountyComponents.victory.sm.value}(entityCell);\n        } else if ((team == ${Teams.HomeTeam} && winner == ${ArenaWinner.Away}) || (team == ${Teams.AwayTeam} && winner == ${ArenaWinner.Home})) {\n          gold += ${BountyComponents.loss.sm.value}(entityCell);\n        } else {\n          gold += ${BountyComponents.tie.sm.value}(entityCell);\n        }\n        ${Gold.writer.write}(gold);\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}","import { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { Hitpoints, HitpointsTrailing, HitpointsRegenComponent, MaxHitpoints, Mana, ManaRegenComponent, MaxMana } from \"./UnitComponents\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { glslFloat } from \"../../GpuUtil\";\nimport { StepsInBattle } from \"../StateLayout\";\nimport { GpuWorldState } from \"../State\";\n\nexport function UpdateHitpointsTrailing(gls: GlState) {\n  return new ArchetypesQuery([Hitpoints.component, HitpointsTrailing.component])\n    .mapGpu(gls, HitpointsTrailing.component, shaderModule([Hitpoints.sm], {\n      map: funcDef('float', [['ivec2', 'entityCell'], ['float', 'value']], `\n        float hp = ${Hitpoints.sm.value}(entityCell);\n        float d = hp - value;\n        d = sign(d) * min(1., abs(d));\n        return value + d;\n      `)\n    }));\n}\n\nexport class UpdateHitpointsRegen {\n  constructor(private gls: GlState) {}\n  private update = new ArchetypesQuery([Hitpoints.component, HitpointsRegenComponent])\n    .mapGpu(this.gls, Hitpoints.component, shaderModule([], {\n      map: funcDef('float', [['ivec2', 'entityCell'], ['float', 'value']], `\n        if (value > 0.) {\n          float hitpointsRegen = 0.25 * ${glslFloat(MaxHitpoints)} / ${glslFloat(StepsInBattle)};\n          return clamp(value + hitpointsRegen, 0., ${glslFloat(MaxHitpoints)});\n        } else {\n          return value;\n        }\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\nexport class UpdateManaRegen {\n  constructor(private gls: GlState) {}\n  private update = new ArchetypesQuery([Mana.component, ManaRegenComponent])\n    .mapGpu(this.gls, Mana.component, shaderModule([], {\n      map: funcDef('float', [['ivec2', 'entityCell'], ['float', 'value']], `\n        if (value > 0.) {\n          float regen = 0.5 * ${glslFloat(MaxMana)} / ${glslFloat(StepsInBattle)};\n          return clamp(value + regen, 0., ${glslFloat(MaxMana)});\n        } else {\n          return value;\n        }\n      `)\n    }));\n  run(state: GpuWorldState) {\n    this.update.run(state);\n  }\n}\n\n// export const TakesGroundDamageCalcs = GlobalCellCalc.registerModule(new class {\n//   moduleMeta = { name: 'TakesGroundDamageCalcs' };\n//   cf = cf.imports(() => [this]);\n\n//   nextHitpoints = this.cf.func('float', ['ivec2'], (c, entityCell) => {\n//     return Hitpoints.value(c, entityCell) -\n//       c.texelFetch(c.uniform(d => d.textures.groundDamage, 'sampler2D'), Position.worldCell(c, entityCell)).x;\n//   })\n// }());\n\n// export class UpdateGroundDamage {\n//   constructor(private gls: GlState) {}\n//   private update = new ArchetypesQuery([Hitpoints.component, TakesGroundDamage.component])\n//     .gpuComponentBlocks(Hitpoints.component)\n//     .write(new ComponentWriter(this.gls, TakesGroundDamageCalcs.nextHitpoints));\n//   run(state: GpuWorldState) {\n//     this.update.run(state);\n//   }\n// }\n","import { Focuser, Team } from \"../ECS/UnitComponents\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { ArchetypesQuery } from \"../../GpuUtil/ECS/Query\";\nimport { shaderModule, funcDef } from \"../../GpuUtil/ShaderModule\";\nimport { CastingAbilityHelpers, Abilities } from \"./Abilities\";\nimport { UnitsInArena } from \"../ECS/ArenaStats\";\nimport { SideSize, Teams } from \"../StateLayout\";\nimport { ArenaInstance } from \"../ECS/Components\";\nimport { GpuWorldState } from \"../State\";\n\nexport class UpdateTrombone {\n  constructor(private gls: GlState) {}\n\n  query = new ArchetypesQuery([Focuser.component])\n    .mapGpu(this.gls, Focuser.component, shaderModule([\n      CastingAbilityHelpers,\n      UnitsInArena,\n      Team.sm,\n      ArenaInstance.sm,\n    ], {\n      map: funcDef('ivec2', [['ivec2', 'entityCell'], ['ivec2', 'value']], `\n        int unitsOffset = ${Team.sm.value}(entityCell) == ${Teams.HomeTeam} ? ${SideSize} : 0;\n        int arenaIndex = ${ArenaInstance.sm.value}(entityCell);\n        for (int i=0; i < ${SideSize}; i++) {\n          ivec2 unit = ${UnitsInArena.unit}(arenaIndex, i + unitsOffset);\n          if (${CastingAbilityHelpers.isPerforming}(unit, ${Abilities.Trombone})) {\n            return unit;\n          }\n        }\n        return value;\n      `),\n    }));\n\n  run(state: GpuWorldState) {\n    this.query.run(state);\n  }\n}","import { GpuWorldState } from \"./State\";\n// import { EntityPicking, GroundPicking } from './Picking';\nimport { GpuWorldRenderer } from './Renderer';\nimport lodash from 'lodash';\nimport { GlState } from '../GpuUtil/GlState';\nimport { Teams, StepsInBattle, SideSize, SpawnPositions, mirrorPosition, ReplayCameraClipKey } from \"./StateLayout\";\nimport { Position, RotationZ } from \"./ECS/Transform\";\nimport { CpuTeamComponent, MaxMana, MaxHitpoints, Mana, Hitpoints, HitpointsTrailing, PreviousHitpoints, DiedStep, Focusable, Focuser, Velocity, Force, IsOnGround, WalkingSpeed, Gold, PreviousGold, UnitStats, Stuck, LastPushedBy } from \"./ECS/UnitComponents\";\nimport { UpdateNeuralNetwork } from \"./Brain/NeuralNetwork\";\nimport { UpdateBrainFocusers } from \"./ECS/Focus\";\nimport { UpdateCastingAbility } from \"./Abilities/CastingAbility\";\nimport { UpdateBuffs } from \"./Buffs/Buffs\";\nimport { UpdateUnitMovement } from \"./ECS/UnitMovement\";\nimport { UpdateUnitPhysics } from \"./ECS/UnitPhysics\";\nimport { EntitiesQuery } from \"../GpuUtil/ECS/Query\";\nimport { UpdateUnitAnimationAndSound } from \"./ECS/UnitAnimationAndSound\";\nimport { UpdateBreeding } from \"./Tools/Breeding\";\nimport { UpdateRoundStats } from \"./Tools/RoundStats\";\nimport { UpdateArenaInfos } from \"./Tools/ArenaInfos\";\nimport { UpdateUnitStats } from \"./ECS/UnitStats\";\nimport { UpdateTalons, UpdateBloodClaws, UpdateCleavers, UpdateCripplers } from \"./Abilities/Talons\";\nimport { UpdateSleepDart, UpdatePistol, UpdateBlaster, UpdateMagnum } from \"./Abilities/Darts\";\nimport { UpdateHealingGland } from \"./Abilities/HealingGland\";\nimport { UpdateLeap } from \"./Abilities/Leap\";\nimport { UpdateIronBubblegum, UpdateHeliumBubblegum } from \"./Abilities/Bubblegums\";\nimport { Dazeable } from \"./Buffs/Daze\";\nimport { IronBubbable, HeliumBubbable } from \"./Buffs/Bubbles\";\nimport { OutputLayer, HiddenLayer, MemoryLayer } from \"./Brain/Components\";\nimport { UpdateBattleScore } from \"./Tools/BattleScore\";\nimport { UpdateDestructible, UpdateImpactEffect } from \"./ECS/DamageCalc\";\nimport { UpdateProjectiles } from \"./Projectiles/Projectiles\";\nimport { Casting } from \"./Abilities/Abilities\";\nimport { AudioPlayerInstance } from \"./Audio\";\nimport { UpdateDuckAI } from \"./ECS/DuckAI\";\nimport { UpdateDecisionsFromBrain, UpdateUserControlledDecisions, Decisions } from \"./Brain/Decisions\";\nimport { UpdateCrabAI } from \"./ECS/CrabAI\";\nimport { UpdateVampireGland } from \"./Abilities/VampireGland\";\nimport { CaptureReplay, PlaybackReplayDecisions, PlaybackReplayPositionHitpoints } from \"./Tools/Replay\";\nimport { ArenaMemberIndex } from \"./ECS/Components\";\nimport { UpdateTerritoryBounty, UpdateTeamSpirit, UpdatePreviousGold, UpdateGoldTimeScaling, UpdateVictoryLossBounty } from \"./ECS/Gold\";\nimport { UpdateHitpointsRegen, UpdateHitpointsTrailing } from \"./ECS/Unit\";\nimport { AnimationControllerComponent } from \"./ECS/Animation\";\nimport * as Vector3 from '../Math/Vector3';\nimport { UpdateTrombone } from \"./Abilities/Trombone\";\n\nclass UpdateAbilities {\n  constructor(private gls: GlState) {}\n  private abilities = [\n    new UpdateTrombone(this.gls),\n    new UpdateTalons(this.gls),\n    new UpdateCleavers(this.gls),\n    new UpdateBloodClaws(this.gls),\n    new UpdateCripplers(this.gls),\n    new UpdateSleepDart(this.gls),\n    new UpdateHealingGland(this.gls),\n    new UpdateVampireGland(this.gls),\n    new UpdateLeap(this.gls),\n    new UpdateIronBubblegum(this.gls),\n    new UpdateHeliumBubblegum(this.gls),\n    new UpdatePistol(this.gls),\n    new UpdateBlaster(this.gls),\n    new UpdateMagnum(this.gls)\n  ]\n  run(state: GpuWorldState) {\n    for (const ability of this.abilities) {\n      ability.run(state);\n    }\n  }\n}\nexport class GpuWorldProgram {\n\n  constructor(public gls: GlState) {\n    // tslint:disable-next-line:no-console\n    console.log('GpuWorldProgram created');\n  }\n  destroy() {\n    this.renderer.destroy();\n    this.gls.destroy();\n    this.gls.shaderCache.destroy();\n  }\n\n  copyLayers = this.gls.getCopyLayers();\n  copyTexture = this.gls.getCopyTexture();\n\n  //#region ----- STEP ----\n\n  // metrics = new MetricCollectors(this.gls);\n  // sampling = new GpuWorldSampling(this.ceval);\n\n  //#endregion ----- STEP ----\n\n  renderer = new GpuWorldRenderer(this.gls);\n\n  breeding = new UpdateBreeding(this.gls);\n  roundStats = new UpdateRoundStats(this.gls);\n  battleScore = new UpdateBattleScore(this.gls);\n  victoryLossBounty = new UpdateVictoryLossBounty(this.gls);\n\n  // entityPicking = new EntityPicking(this.gls);\n  // groundPicking = new GroundPicking(this.gls);\n\n  updateArenaInfos = new UpdateArenaInfos(this.gls);\n  updateNeuralNetwork = new UpdateNeuralNetwork(this.gls);\n\n  stepSystems = [\n    this.updateNeuralNetwork,\n    UpdateDecisionsFromBrain(this.gls),\n    UpdateCrabAI(this.gls),\n    UpdateDuckAI(this.gls),\n    new UpdateUserControlledDecisions(),\n    new PlaybackReplayDecisions(this.gls),\n    new UpdateBrainFocusers(this.gls),\n    new UpdateCastingAbility(this.gls),\n    new UpdateUnitMovement(this.gls),\n    new UpdateAbilities(this.gls),\n    new UpdateBuffs(this.gls),\n    new UpdateProjectiles(this.gls),\n    new UpdateUnitPhysics(this.gls),\n    UpdateImpactEffect(this.gls),\n    new UpdateDestructible(this.gls),\n    new UpdateHitpointsRegen(this.gls),\n    UpdateHitpointsTrailing(this.gls),\n    UpdateUnitStats(this.gls),\n    // new UpdateManaRegen(this.gls),\n    new UpdateTerritoryBounty(this.gls),\n    new UpdateTeamSpirit(this.gls),\n    // new UpdateZeroSumBounty(this.gls),\n    new UpdateGoldTimeScaling(this.gls),\n    new UpdatePreviousGold(this.gls),\n    new UpdateUnitAnimationAndSound(this.gls),\n    this.updateArenaInfos,\n    new PlaybackReplayPositionHitpoints(this.gls),\n    new CaptureReplay(this.gls),\n  ];\n\n  public step(state: GpuWorldState) {\n    this.gls.stats.drawCalls = 0;\n    state.setData({\n      stepCounter: state.data.stepCounter + 1,\n      randomSeed: state.random.random()\n    });\n\n    const battleUnitsAlive = state.data.teams.home.battleUnitsAlive + state.data.teams.away.battleUnitsAlive;\n    if (state.data.gameInstance.type !== 'none' && (\n      state.data.stepCounter >= state.data.battleStartStep + StepsInBattle ||\n      (state.data.gameInstance.type === 'battle' && battleUnitsAlive === 0)\n    )) {\n      if (!state.data.simulationEnded) {\n        return this.endRound(state);\n      }\n      return Promise.resolve();\n    }\n\n    for (const system of this.stepSystems) {\n      system.run(state);\n    }\n    if (state.data.gameInstance.type === 'battle' || state.data.gameInstance.type === 'gym') {\n      this.battleScore.run(state);\n    }\n\n    const promises: Promise<void>[] = [];\n\n    // console.log('step draw calls:', this.gls.stats.drawCalls);\n\n    return Promise.all(promises);\n  }\n\n  render(state: GpuWorldState) {\n    this.gls.stats.drawCalls = 0;\n    this.renderer.render(state);\n    this.throttledUpdateMouseover(state);\n    // console.log('render draw calls:', this.gls.stats.drawCalls);\n  }\n\n  async endRound(state: GpuWorldState) {\n    this.victoryLossBounty.run(state);\n    state.setData({ simulationEnded: true });\n    AudioPlayerInstance?.fadeOutAllLoopingSoundEffects();\n    if (state.data.gameInstance.type === 'train' || state.data.gameInstance.type === 'battle') {\n      state.textures.unitsReplay.swap();\n    }\n    if (state.data.gameInstance.type === 'train') {\n      await this.breeding.runSelection(state);\n      this.updateArenaInfos.run(state);\n    }\n    this.roundStats.run(state);\n    state.events.roundEnd.dispatch({ type: 'RoundEnd', round: state.data.round });\n    if (state.data.gameInstance.type === 'train' && state.data.autoStartNextTrainingRound) {\n      await this.breedAndRestartTraining(state);\n    }\n  }\n\n  async breedAndRestartTraining(state: GpuWorldState) {\n    this.resetForNextRound(state, true);\n    const round = state.data.round + 1;\n    state.setData({\n      simulationEnded: false,\n      battleStartStep: state.data.stepCounter,\n      round,\n    });\n  }\n\n  resetForNextRound(state: GpuWorldState, restoreHitpoints: boolean) {\n    state.ecs.gpuComponentInfo(Mana.component)!.slice.clear([MaxMana, 0, 0, 0]);\n    if (restoreHitpoints) {\n      state.ecs.gpuComponentInfo(Hitpoints.component)!.slice.clear([MaxHitpoints, 0, 0, 0]);\n      state.ecs.gpuComponentInfo(HitpointsTrailing.component)!.slice.clear([MaxHitpoints, 0, 0, 0]);\n      state.ecs.gpuComponentInfo(PreviousHitpoints.component)!.slice.clear([MaxHitpoints, 0, 0, 0]);\n      state.ecs.gpuComponentInfo(DiedStep.component)?.slice.clear([-1, 0, 0, 0]);\n    }\n    state.ecs.gpuComponentInfo(Dazeable.component)!.slice.clear();\n    state.ecs.gpuComponentInfo(IronBubbable.component)!.slice.clear();\n    state.ecs.gpuComponentInfo(HeliumBubbable.component)!.slice.clear();\n    state.ecs.gpuComponentInfo(Focusable.component)!.slice.clear([1, 1, 1, 1]);\n    state.ecs.gpuComponentInfo(Focuser.component)?.slice.clear([-1, -1, -1, -1]);\n    state.ecs.gpuComponentInfo(LastPushedBy.component)?.slice.clear([-1, -1, -1, -1]);\n    state.ecs.gpuComponentInfo(Velocity.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Force.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(IsOnGround.component)?.slice.clear([1, 0, 0, 0]);\n    state.ecs.gpuComponentInfo(Stuck.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(WalkingSpeed.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Gold.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(PreviousGold.component)?.slice.clear();\n\n    state.ecs.gpuComponentInfo(Decisions.MoveX.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Decisions.Rotate.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Decisions.ChaseFocus.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Decisions.CastingSlot.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(Decisions.ChangeFocus.component)?.slice.clear();\n\n    state.ecs.gpuComponentInfo(HiddenLayer.res.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(MemoryLayer.res.component)?.slice.clear();\n    state.ecs.gpuComponentInfo(OutputLayer.res.component)?.slice.clear();\n    for (const key of Object.keys(UnitStats)) {\n      state.ecs.gpuComponentInfo(UnitStats[key].component)?.slice.clear();\n    }\n    state.ecs.gpuComponentInfo(UnitStats.MinDistEnemyStatue.component)?.slice.clear([state.data.worldSize.width, 0, 0, 0]);\n    for (const key of Object.keys(Casting)) {\n      state.ecs.gpuComponentInfo(Casting[key].component)?.slice.clear();\n    }\n    const battleground = state.data.battleground;\n    const spawnPositions = SpawnPositions[battleground];\n\n    const homeUnits = new EntitiesQuery([Position.gpuComponent, CpuTeamComponent])\n      .filterValue(CpuTeamComponent, v => v === Teams.HomeTeam, d => [])\n      .get(state);\n    for (const entityCell of homeUnits) {\n      const arenaMemberIndex = state.ecs.getComponentData(ArenaMemberIndex.cpuComponent, entityCell)[0];\n      let p = spawnPositions[arenaMemberIndex];\n      if (arenaMemberIndex !== 0) {\n        p = Vector3.add(p, { x: state.random.random() * 2 - 1, y: state.random.random() * 2 - 1, z: 0 });\n      }\n      state.ecs.setComponentData(Position.gpuComponent, entityCell, [new Float32Array([p.x, p.y, p.z, 0])]);\n      state.ecs.setComponentData(RotationZ.component, entityCell, [Math.PI / 4]);\n    }\n    const awayUnits = new EntitiesQuery([Position.gpuComponent, CpuTeamComponent])\n      .filterValue(CpuTeamComponent, v => v === Teams.AwayTeam, d => [])\n      .get(state);\n    for (const entityCell of awayUnits) {\n      const arenaMemberIndex = state.ecs.getComponentData(ArenaMemberIndex.cpuComponent, entityCell)[0];\n      let p = mirrorPosition(spawnPositions[arenaMemberIndex - SideSize], state.layout.worldSize);\n      if (arenaMemberIndex !== SideSize) {\n        p = Vector3.add(p, { x: state.random.random() * 2 - 1, y: state.random.random() * 2 - 1, z: 0 });\n      }\n      state.ecs.setComponentData(Position.gpuComponent, entityCell, [new Float32Array([p.x, p.y, p.z, 0])]);\n      state.ecs.setComponentData(RotationZ.component, entityCell, [Math.PI + Math.PI / 4]);\n    }\n\n    this.updateArenaInfos.run(state);\n\n    if (state.data.gameInstance.type === 'replay') {\n      state.ecs.setComponentData(AnimationControllerComponent, state.data.camera!, {\n        actions: [{\n          clip: ReplayCameraClipKey,\n          positionType: 'startTime',\n          positionValue: 0,\n        }]\n      });\n    }\n  }\n\n  private updateMouseover = (state: GpuWorldState) => {\n    // if (state.destroyed) {\n    //   return;\n    // }\n    // this.entityPicking.pick(state, state.data.cameraMatrices, state.data.mousePosition || { x: 0, y: 0}, state.data.canvasRect, state.textures.mouseoverEntity);\n    // state.textures.mouseoverEntity.readAsync().then(img => {\n    //   const mouseoverEntity = img.data[0] >= 0 ?\n    //     { x: img.data[0], y: img.data[1] } : undefined;\n    //   if (!lodash.isEqual(state.data.mouseoverEntity, mouseoverEntity)) {\n    //     state.setData({\n    //       mouseoverEntity\n    //     });\n    //   }\n    // });\n    // this.groundPicking.pickScreenRay(state, state.textures.mouseoverGround,\n    //   state.data.cameraMatrices, state.data.mousePosition || { x: 0, y: 0}, state.data.canvasRect);\n    // state.textures.mouseoverGround.readAsync().then(img => {\n    //   const mouseoverGround = img.data[3] === 1 ? { x: img.data[0], y: img.data[1], z: img.data[1] } : undefined;\n    //   if (!lodash.isEqual(state.data.mouseoverGround, mouseoverGround)) {\n    //     state.setData({\n    //       mouseoverGround\n    //     });\n    //   }\n    // })\n  }\n  private throttledUpdateMouseover = lodash.throttle(this.updateMouseover, 100);\n\n}\n\n","import * as React from \"react\";\n\n// tslint:disable-next-line:no-var-requires\nlet ResizeObserver = require('resize-observer-polyfill');\nif (ResizeObserver.default) {\n  ResizeObserver = ResizeObserver.default;\n}\n\nexport class MeasureSize {\n  static resizeObserver: any = new ResizeObserver((entries: any, observer: any) => {\n    // Wrap in requestAnimationFrame to avoid \"ResizeObserver loop limit exceeded\". See: https://stackoverflow.com/questions/49384120/resizeobserver-loop-limit-exceeded\n    requestAnimationFrame(() => {\n      for (const entry of entries) {\n        entry.target.__measureSizeOnSize(entry.target.getBoundingClientRect());\n      }\n    });\n  });\n\n  constructor(public onSize: (rect: ClientRect) => void) {\n  }\n\n  ref: Element | null = null;\n  public handleRef = (ref: Element | null) => {\n    if (this.ref) {\n      MeasureSize.resizeObserver.unobserve(this.ref);\n    }\n    if (ref) {\n      (ref as any).__measureSizeOnSize = this.handleOnSize;\n      MeasureSize.resizeObserver.observe(ref);\n    }\n    this.ref = ref;\n  }\n  public handleUnmount() {\n    if (this.ref) {\n      MeasureSize.resizeObserver.unobserve(this.ref);\n    }\n  }\n  private handleOnSize = (rect: ClientRect) => {\n    this.onSize(rect);\n  }\n}\n\nexport class MeasuredDiv extends React.Component<React.HTMLProps<HTMLDivElement> & { onSize: (rect: ClientRect) => void }> {\n  measure = new MeasureSize(this.props.onSize);\n  componentDidUpdate() {\n    this.measure.onSize = this.props.onSize;\n  }\n  componentWillUnmount() {\n    this.measure.handleUnmount();\n  }\n  render() {\n    const { onSize, children, ...rest } = this.props;\n    return <div {...rest} ref={this.measure.handleRef}>\n      {children}\n    </div>\n  }\n}","import * as React from 'react';\nimport './index.css';\nimport { renderToString } from 'react-dom/server';\nimport * as _ from 'lodash';\nimport { MeasureSize } from '../MeasureSize';\n\nexport interface Padding { left: number, top: number, bottom: number, right: number }\nexport function evenPadding(padding: number): Padding {\n  return { left: padding, top: padding, bottom: padding, right: padding };\n}\nconst DefaultWonkyPanelBorder: Padding = evenPadding(5);\nconst DefaultWonkyPanelPadding: Padding = evenPadding(5);\nconst DefaultWonkyPanelBackgroundMargin: Padding = evenPadding(0);\n\ninterface WonkyPanelProps {\n  children?: any;\n  className?: string;\n  style?: React.CSSProperties;\n  borderPx?: Padding;\n  paddingPx?: Padding;\n  backgroundMarginPx?: Padding;\n  shadowPx?: number;\n  fill?: string;\n  stroke?: string;\n  strokeWidth?: number;\n  onClick?: (event: React.MouseEvent<HTMLDivElement>) => void;\n}\ninterface WonkyPanelState {\n  size: { width: number, height: number };\n}\n\nclass WonkyPanelSvg {\n  constructor(private borderPx: Padding, private marginPx: Padding) {\n  }\n  topLeft = { x: this.borderPx.left * Math.random(), y: this.borderPx.top * Math.random() };\n  topRight = { x: this.borderPx.right * Math.random(), y: this.borderPx.top * Math.random() };\n  bottomRight = { x: this.borderPx.right * Math.random(), y: this.borderPx.bottom * Math.random() };\n  bottomLeft = { x: this.borderPx.left * Math.random(), y: this.borderPx.bottom * Math.random() };\n  renderToDataUrl(size: { width: number, height: number }, shadowPx: number, fill: string, stroke: string | undefined, strokeWidth: number | undefined) {\n    const { topLeft, topRight, bottomLeft, bottomRight } = this;\n\n    const d = `\n      M${topLeft.x + this.marginPx.left} ${topLeft.y + this.marginPx.top}\n      L ${size.width - topRight.x - shadowPx - this.marginPx.right} ${topRight.y + this.marginPx.top}\n      L ${size.width - bottomRight.x - shadowPx - this.marginPx.right} ${size.height - bottomRight.y - shadowPx - this.marginPx.bottom}\n      L ${bottomLeft.x + this.marginPx.left} ${size.height - bottomLeft.y - shadowPx - this.marginPx.bottom}\n      Z\n    `;\n    const str = renderToString(\n      <svg\n        className=\"WonkyPanelBackground\"\n        xmlns=\"http://www.w3.org/2000/svg\"\n        width={size.width}\n        height={size.height}\n        >\n        {shadowPx !== 0 && (\n          <path d={d} fill=\"rgba(0, 0, 0, 0.3)\" transform={`translate(${shadowPx}, ${shadowPx})`} />\n        )}\n        <path d={d} fill={fill} stroke={stroke} strokeWidth={strokeWidth} />\n      </svg>);\n    return `data:image/svg+xml;base64,${window.btoa(str)}`;\n  }\n}\n\nexport class WonkyPanel extends React.Component<WonkyPanelProps, WonkyPanelState> {\n  constructor(props: WonkyPanelProps) {\n    super(props);\n    this.state = {\n      size: { width: 0, height: 0 },\n    };\n  }\n  componentDidUpdate(prevProps: WonkyPanelProps) {\n    if (!_.isEqual(prevProps.borderPx, this.props.borderPx) || !_.isEqual(prevProps.backgroundMarginPx, this.props.backgroundMarginPx)) {\n      this.wonkyPanelSvg = new WonkyPanelSvg(\n        this.props.borderPx !== undefined ? this.props.borderPx : DefaultWonkyPanelBorder,\n        this.props.backgroundMarginPx !== undefined ? this.props.backgroundMarginPx : DefaultWonkyPanelBackgroundMargin);\n    }\n  }\n  measure = new MeasureSize(size => this.setState({ size }));\n  componentWillUnmount() {\n    this.measure.handleUnmount();\n  }\n  wonkyPanelSvg = new WonkyPanelSvg(\n    this.props.borderPx !== undefined ? this.props.borderPx : DefaultWonkyPanelBorder,\n    this.props.backgroundMarginPx !== undefined ? this.props.backgroundMarginPx : DefaultWonkyPanelBackgroundMargin);\n  render () {\n    const { children, className, shadowPx = 10,\n      borderPx = DefaultWonkyPanelBorder, paddingPx = DefaultWonkyPanelPadding,\n      fill = \"#171717\", onClick, stroke, strokeWidth } = this.props;\n\n    return (\n      <div\n        className={`WonkyPanel ${className !== undefined ? className : ''}`}\n        ref={this.measure.handleRef}\n        style={{\n          paddingLeft: (borderPx.left + paddingPx.left) + 'px',\n          paddingTop: (borderPx.top + paddingPx.top) + 'px',\n          paddingRight: (borderPx.right + paddingPx.right + shadowPx) + 'px',\n          paddingBottom: (borderPx.bottom + paddingPx.bottom + shadowPx) + 'px',\n          background: `url('${this.wonkyPanelSvg.renderToDataUrl(this.state.size, shadowPx, fill, stroke, strokeWidth)}') no-repeat`,\n          ...this.props.style\n        }}\n        onClick={onClick}\n        >\n        {children}\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\nimport Route from 'route-parser';\nimport { EventDispatcher } from '../Util';\n\nfunction getRoute() {\n  return window.location.pathname + window.location.search;\n}\n\nclass RoutingHistoryImpl {\n  onChange = new EventDispatcher();\n  push(url: string) {\n    window.history.pushState(null, '', url);\n    this.onChange.dispatch();\n  }\n  replace(url: string) {\n    window.history.replaceState(null, '', url);\n    this.onChange.dispatch();\n  }\n}\nexport const RoutingHistory = new RoutingHistoryImpl();\n\nexport function useRoute() {\n  const [route, setRoute] = React.useState(getRoute());\n  React.useEffect(() => {\n    const handlePopstate = (e: PopStateEvent) => {\n      e.preventDefault();\n      setTimeout(() => {\n        setRoute(getRoute());\n      }, 0);\n    }\n    const handleChange = () => {\n      setTimeout(() => {\n        setRoute(getRoute());\n      }, 0);\n    }\n    window.addEventListener('popstate', handlePopstate);\n    RoutingHistory.onChange.attach(handleChange);\n    return () => {\n      window.removeEventListener('popstate', handlePopstate);\n      RoutingHistory.onChange.detach(handleChange);\n    }\n  }, []);\n  return route;\n}\nexport function Router({ routes }: { routes: { [path: string]: (match: { [key: string]: string }) => React.ReactElement } }) {\n  const route = useRoute();\n  for (const key of Object.keys(routes)) {\n    const m = new Route(key).match(route);\n    if (m) {\n      console.log(`Router rendering path ${key}`);\n      return routes[key](m);\n    }\n  }\n  return null;\n}\n\nexport function Link({ to, children }: { to: string, children?: any }) {\n  // eslint-disable-next-line\n  return <a href=\"#\" onClick={e => {\n    e.preventDefault();\n    RoutingHistory.push(to);\n  }}>{children}</a>\n}\n","import * as React from 'react';\nimport './index.css';\nimport '@fortawesome/fontawesome-free/css/all.css';\nimport { WonkyPanel, Padding, evenPadding } from '../WonkyPanel';\nimport { wait } from '../../Util';\nimport { RoutingHistory } from '../Routing';\n\ninterface ButtonProps {\n  purpose?: string;\n  className?: string;\n  style?: React.CSSProperties;\n  onClick?: (event: React.MouseEvent<HTMLButtonElement>) => void;\n  onPerform?: (event: React.MouseEvent<HTMLButtonElement>) => Promise<void>;\n  children?: any;\n  disabled?: boolean;\n  autoFocus?: boolean;\n  title?: string;\n  fill?: string;\n  toggled?: boolean;\n  primary?: boolean;\n  flat?: boolean;\n  large?: boolean;\n  borderPx?: Padding;\n  paddingPx?: Padding;\n  materialIcon?: string;\n  fontAwesomeIcon?: string;\n  type?: 'button' | 'submit' | 'reset';\n}\n\nexport function Button(props: ButtonProps) {\n  const { className, style, onClick, onPerform, children, disabled, toggled,\n    fill, primary, large, purpose, flat, borderPx, paddingPx, materialIcon, fontAwesomeIcon, ...rest} = props;\n  const [working, setWorking] = React.useState<boolean>();\n  const handleClick = async (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.stopPropagation();\n    if (onPerform) {\n      setWorking(true);\n      await wait(1);\n      await onPerform(e);\n      setWorking(false);\n    } else if (onClick) {\n      onClick(e);\n    }\n  };\n  let inner = children;\n  if (fontAwesomeIcon) {\n    inner = <span><i className={`fas fa-${fontAwesomeIcon}`} />&nbsp;{inner}</span>;\n  }\n  if (materialIcon) {\n    inner = <span><i className=\"material-icons\">{materialIcon}</i>&nbsp;{inner}</span>;\n  }\n  return (\n    <button\n      {...rest}\n      disabled={disabled || working}\n      onClick={handleClick}\n      className={`Button ${props.className || ''} ${primary ? 'ButtonPrimary' : ''} ${flat ? 'ButtonFlat' : ''} ${toggled ? 'ButtonToggled' : ''} ${large ? 'ButtonLarge' : ''} Purpose${purpose}`}\n      style={style}\n      >\n      {flat ? inner : (\n        <WonkyPanel\n          fill={(disabled || working) ? '#eee' : primary ? '#8ECC95' : (toggled ? '#c6c041' : (fill ? fill : '#fff'))}\n          borderPx={borderPx || evenPadding(2)}\n          paddingPx={paddingPx || { left: 5, right: 5, top: 2, bottom: 2 }}\n          shadowPx={4}>{inner}</WonkyPanel>\n      )}\n    </button>\n  );\n}\n\ninterface MaterialIconButtonProps extends ButtonProps {\n  icon: string;\n}\n\nexport function MaterialIconButton(props: MaterialIconButtonProps) {\n  const { className, icon, children, ...rest} = props;\n  return <Button className={`${className !== undefined ? className : ''} MaterialIconButton`} paddingPx={evenPadding(3)} borderPx={evenPadding(3)} {...rest}>\n    <i className=\"material-icons\">{icon}</i>{children !== undefined ? <span>&nbsp;{children}</span> : null}\n  </Button>;\n}\n\nexport type FontAwesomeStyle = 'regular' | 'solid' | 'brand';\ninterface FontAwesomeButtonProps extends ButtonProps {\n  icon: string;\n  iconStyle?: FontAwesomeStyle;\n}\n\nexport function FontAwesomeButton(props: FontAwesomeButtonProps) {\n  const { className, icon, iconStyle, children, ...rest} = props;\n  return <Button className={`${className !== undefined ? className : ''} MaterialIconButton`} paddingPx={evenPadding(3)} borderPx={evenPadding(3)} {...rest}>\n    <i className={`${iconStyle === 'brand' ? 'fab' : iconStyle === 'regular' ? 'far' : 'fas'} fa-${icon}`} />{children !== undefined ? <span>&nbsp;{children}</span> : null}\n  </Button>;\n}\n\nexport function LinkButton({ to, ...rest }: { to: string } & ButtonProps) {\n  return <Button onClick={() => RoutingHistory.push(to)} {...rest} />;\n}\n","// Tried https://github.com/JedWatson/react-codemirror first, but because of numerous small issues,\n// such as https://github.com/JedWatson/react-codemirror/issues/110 and\n// https://github.com/JedWatson/react-codemirror/issues/47 which is the root cause, which hasn't been\n// addressed in a long time, it was easier to just create this component.\nimport * as React from 'react';\nimport CodeMirrorInstance from 'codemirror';\nimport \"codemirror/lib/codemirror.css\";\nimport 'codemirror-one-dark-theme/one-dark.css';\n// tslint:disable-next-line:no-var-requires\nrequire('codemirror/mode/markdown/markdown');\n// tslint:disable-next-line:no-var-requires\nrequire('codemirror/mode/javascript/javascript');\n// tslint:disable-next-line:no-var-requires\nrequire('codemirror/mode/clike/clike');\nrequire('codemirror/mode/python/python');\n\nexport interface CodeMirrorProps {\n  options?: CodeMirrorInstance.EditorConfiguration;\n  value?: string;\n  onChange?: (newValue: string) => void;\n  onKeyDown?: (event: KeyboardEvent) => void;\n  className?: string;\n}\n\nexport class CodeMirror extends React.Component<CodeMirrorProps, {}> {\n  componentDidMount() {\n    if (!this.container) {\n      return;\n    }\n    const cm = CodeMirrorInstance(this.container, { value: this.props.value || '', ...this.props.options });\n    cm.on('change', this.handleChange);\n    cm.on('keydown', this.handleKeyDown as any);\n    this.codeMirror = cm;\n  }\n  componentWillReceiveProps(nextProps: CodeMirrorProps) {\n    const val = nextProps.value || '';\n    if (this.codeMirror && this.codeMirror.getValue() !== val) {\n      this.codeMirror.setValue(val);\n    }\n  }\n  handleChange = (cm: CodeMirrorInstance.Editor) => {\n    if (this.props.onChange) {\n      this.props.onChange(cm.getValue());\n    }\n  }\n  handleKeyDown = (cm: CodeMirrorInstance.Editor, event: KeyboardEvent) => {\n    if (this.props.onKeyDown) {\n      this.props.onKeyDown(event);\n    }\n  }\n  container: HTMLDivElement | null = null;\n  codeMirror: CodeMirrorInstance.Editor | undefined;\n  shouldComponentUpdate(nextProps: CodeMirrorProps) {\n    return nextProps.className !== this.props.className;\n  }\n  render() {\n    return <div className={this.props.className} ref={e => this.container = e} />;\n  }\n}\n","import * as React from 'react';\nimport './index.css';\nimport { WonkyPanel, evenPadding } from '../WonkyPanel';\nimport { MaterialIconButton } from '../Button';\n\nexport enum PanelMode {\n  Normal,\n  Primary,\n  Floating,\n  Thin\n}\n\ninterface PanelProps {\n  className?: string;\n  style?: React.CSSProperties;\n  mode?: PanelMode;\n  title?: any;\n  onDelete?: () => void;\n  children?: any;\n}\n\nexport const FloatingPanelColor = `rgba(31, 31, 33, 0.9)`;\n\nexport function Panel({ className, style, mode = PanelMode.Normal, title, onDelete, children }: PanelProps) {\n  let header: null | JSX.Element = null;\n  const padding = evenPadding(5);\n  const backgroundMargin = evenPadding(0);\n  const border = evenPadding(15);\n  if (title || onDelete) {\n    backgroundMargin.top = 5;\n    border.top = 10;\n    padding.top = -15;\n    header = <div className=\"PanelHeader\">\n      <WonkyPanel shadowPx={0} paddingPx={{ left: 5, right: 5, top: 3, bottom: 3 }} borderPx={{ left: 2, right: 2, top: 1, bottom: 1 }} fill=\"#53585e\" className=\"PanelTitle\">{title}</WonkyPanel>\n      {onDelete && <MaterialIconButton icon=\"clear\" className=\"PanelDeleteButton\" onClick={onDelete} purpose=\"DeletePanel\" />}\n    </div>;\n  }\n  return <WonkyPanel\n    className={`Panel ${className !== undefined ? className : ''}`}\n    style={style}\n    fill={mode === PanelMode.Primary ? '#4f7c55'\n      : mode === PanelMode.Floating ? FloatingPanelColor\n      : mode === PanelMode.Thin ? 'none'\n      : '#171717'}\n    strokeWidth={mode === PanelMode.Thin ? 1 : undefined}\n    stroke={mode === PanelMode.Thin ? 'rgba(255, 255, 255, 0.3)' : undefined}\n    backgroundMarginPx={backgroundMargin}\n    borderPx={border}\n    paddingPx={padding}\n    shadowPx={(mode === PanelMode.Floating || mode === PanelMode.Thin) ? 0 : 10}\n    >{header}{children}</WonkyPanel>;\n}\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport './index.css';\nimport { MaterialIconButton } from '../Button';\nimport { WonkyPanel } from '../WonkyPanel';\nimport { FloatingPanelColor } from '../Panel';\n\nexport function PopupsContainer() {\n  return <div id=\"PopupsContainer\" />\n}\n\ninterface PopupProps {\n  onClose?: () => void;\n  fullscreen?: boolean;\n  background?: boolean;\n  showCloseButton?: boolean;\n  className?: string;\n}\n\nexport class Popup extends React.Component<PopupProps> {\n  render() {\n    const background = this.props.background !== undefined ? this.props.background : true;\n    const showCloseButton = this.props.showCloseButton !== undefined ? this.props.showCloseButton : true;\n    const popupContainer = document.getElementById(\"PopupsContainer\");\n    if (popupContainer) {\n      return ReactDOM.createPortal(\n          <div className={`Fader ${this.props.fullscreen ? 'FaderPopupFullscreen' : ''}`} onClick={this.props.onClose}>\n            {background ? (\n              <WonkyPanel className={`Popup ${this.props.className || ''}`} fill={FloatingPanelColor} onClick={e => e.stopPropagation()}>\n                {showCloseButton && <MaterialIconButton icon=\"clear\" className=\"ClosePopup\" onClick={this.props.onClose} purpose=\"ClosePopup\" />}\n                {this.props.children}\n              </WonkyPanel>\n            ) : (\n              <div className={`Popup`} onClick={e => e.stopPropagation()}>\n                {showCloseButton && <MaterialIconButton icon=\"clear\" className=\"ClosePopup\" onClick={this.props.onClose} purpose=\"ClosePopup\" />}\n                {this.props.children}\n              </div>\n            )}\n          </div>,\n          popupContainer\n      );\n    } else {\n      setTimeout(() => this.forceUpdate(), 0);\n      return null;\n    }\n  }\n}\n","import * as React from 'react';\nimport './index.css';\n\ninterface LayoutProps { children?: any, className?: string, style?: React.CSSProperties }\n\nfunction createLayoutClass(layoutClass: string) {\n  return ({ children, className = '', style }: LayoutProps) => {\n    return <div className={`${layoutClass} ${className}`} style={style}>{children}</div>;\n  }\n}\n\nexport const Row = createLayoutClass('Row');\nexport const Column = createLayoutClass('Column');\nexport const ColumnCentered = createLayoutClass('Column Centered');\nexport const Block = createLayoutClass('Block');\nexport const ColumnSection = createLayoutClass('Column Section');\nexport const BlockSection = createLayoutClass('Block Section');\nexport const SectionHeading = createLayoutClass('SectionHeading');\nexport const ScrollableColumn = createLayoutClass('Column Scrollable');\nexport const ScrollableRow = createLayoutClass('Row Scrollable');\nexport const ItemsRow = createLayoutClass('Row Items');\nexport const ItemsColumn = createLayoutClass('Column Items');\nexport const FloatList = createLayoutClass('FloatList');\n\nexport function Spreadsheet({ className = '', style, children }: LayoutProps) {\n  return <table className={`Spreadsheet ${className}`} style={style}>{children}</table>;\n}\n\nexport const VerticalLeft = createLayoutClass('VerticalLeft');\nexport const VerticalCentered = createLayoutClass('VerticalCentered');\nexport const VerticalFill = createLayoutClass('VerticalFill');\nexport const HorizontalCentered = createLayoutClass('HorizontalCentered');\nexport const HorizontalLeft = createLayoutClass('HorizontalLeft');\nexport const HorizontalRight = createLayoutClass('HorizontalRight');\nexport const HorizontalFill = createLayoutClass('HorizontalFill');\n\nexport const ScrollVertical = createLayoutClass('ScrollVertical');\nexport const ScrollBoth = createLayoutClass('ScrollBoth');\n\nexport function Section({ children, heading, className = '', style }: LayoutProps & { heading?: string }) {\n  return <div className={`Section ${className}`} style={style}>\n    {heading && <SectionHeading>{heading}</SectionHeading>}\n    {children}\n  </div>;\n}\n","import * as React from 'react';\nimport './ShaderDebugger.css';\nimport { shaderFromSource, ShaderError } from '../../GpuUtil/ShaderCache';\nimport { CodeMirror } from '../CodeMirror';\nimport { Popup } from '../Popup';\nimport { Row, Column } from '../Layout';\nimport { GL } from '../../GpuUtil/GlState';\n\nexport function ShaderDebugger({ shaderErrors }: { shaderErrors: ShaderError[] }) {\n  const compileErrors = shaderErrors.slice().sort((a, b) => {\n    if (a.type === 'FailedToCompileShader' && b.type !== 'FailedToCompileShader') {\n      return -1;\n    } else if (a.type !== 'FailedToCompileShader' && b.type === 'FailedToCompileShader') {\n      return 1;\n    } else {\n      return 0;\n    }\n  })\n  const compileError = compileErrors[0];\n  const [error, setError] = React.useState('');\n  const [source, setSource] = React.useState(compileError.type === 'FailedToCompileShader' ? compileError.shaderSource : '');\n  const shaderType = compileError.type === 'FailedToCompileShader' ? compileError.shaderType : 'vertex';\n  React.useEffect(() => {\n    if (compileError.type === 'FailedToCompileShader') {\n      const res = shaderFromSource(GL, shaderType, source);\n      if (res.result === 'ok') {\n        setError('OK!');\n      } else {\n        if (res.error.type === 'FailedToCompileShader') {\n          setError(res.error.message);\n        } else {\n          setError(res.error.type);\n        }\n      }\n    }\n  }, [source, shaderType, compileError.type]);\n  React.useEffect(() => {\n    setSource(compileError.type === 'FailedToCompileShader' ? compileError.shaderSource : '');\n  }, [compileError]);\n  return <Popup fullscreen={true}>\n    <Row className=\"ShaderDebugger\">\n      <CodeMirror\n        className=\"ShaderDebuggerCode\"\n        value={source}\n        onChange={setSource}\n        options={{\n          theme: 'one-dark',\n          mode: 'clike',\n          lineNumbers: true\n        }}\n        />\n      <Column className=\"ShaderDebuggerError\">\n        <pre>{error}</pre>\n      </Column>\n    </Row>\n  </Popup>\n}\n","import * as React from 'react';\nimport './index.css';\nimport { GpuWorldProgram } from '../../GpuWorld';\nimport { initGlExtensions } from '../../GpuUtil';\nimport { Button } from '../Button';\nimport { GlState } from '../../GpuUtil/GlState';\nimport { ShaderError } from '../../GpuUtil/ShaderCache';\nimport { version } from '../../version';\nimport { ShaderDebugger } from './ShaderDebugger';\n\nexport const WorldCanvasContext = React.createContext<HTMLCanvasElement | null>(null);\nexport const WorldProgramContext = React.createContext<GpuWorldProgram | undefined>(undefined);\n\nexport function WorldCanvas({ children }: { children?: any }) {\n  const [worldProgram, setWorldProgram] = React.useState<GpuWorldProgram | undefined>();\n\n  const [webgl2FailedToCreate, setWebgl2FailedToCreate] = React.useState<boolean>(false);\n  const [webgl2ExtensionErrors, setWebgl2ExtensionErrors] = React.useState<string[]>([]);\n  const [contextLost, setContextLost] = React.useState<boolean>(false);\n  const [shaderErrors, setShaderErrors] = React.useState<ShaderError[]>([]);\n  const [worldCanvas, setWorldCanvas] = React.useState<HTMLCanvasElement | null>(null);\n  const [loading, setLoading] = React.useState(true);\n\n  const handleCanvasRef = React.useCallback((canvas: HTMLCanvasElement | null) => {\n    if (canvas) {\n      canvas.addEventListener(\"webglcontextlost\", () => {\n        // tslint:disable-next-line:no-console\n        console.log('WebGL context lost');\n        setContextLost(true);\n      });\n      const gl = canvas.getContext('webgl2', { alpha: false, desynchronized: false, preserveDrawingBuffer: true }) as any as WebGL2RenderingContext; // Have to do this cast to get storybook to work\n      if (!gl) {\n        setWebgl2FailedToCreate(true);\n        return;\n      }\n      const extensionsErrors = initGlExtensions(gl);\n      if (extensionsErrors.length > 0) {\n        setWebgl2ExtensionErrors(extensionsErrors);\n        return;\n      }\n      setWorldProgram(undefined);\n\n      const gls = new GlState(canvas, gl);\n      const program = new GpuWorldProgram(gls);\n      if (program.gls.shaderCache.getErrors().length > 0) {\n        setShaderErrors(program.gls.shaderCache.getErrors());\n      }\n      setWorldProgram(program);\n      setLoading(false);\n    }\n    setWorldCanvas(canvas);\n  }, []);\n\n  return <WorldProgramContext.Provider value={worldProgram}>\n    <WorldCanvasContext.Provider value={worldCanvas}>\n      <canvas\n        className=\"WorldCanvas\"\n        ref={handleCanvasRef}\n        />\n\n      {(contextLost || webgl2FailedToCreate || webgl2ExtensionErrors.length > 0) && <div className=\"WorldCanvasErrors\">\n        <div className=\"WorldCanvasErrorsInner\">\n          {contextLost && <div>\n            <h2>WebGL context lost</h2>\n            <p>The WebGL context has been lost. This can happen for a number of reasons. The most common\n              reason is running out of GPU memory, or the graphics card drivers crashing.</p>\n          </div>}\n          {webgl2FailedToCreate && <div>\n              <h2>WebGL2 not available</h2>\n              <ul>\n                <li>If the WebGL context was lost, you may have to restart your browser.</li>\n                <li>WebGL2 is currently only supported by latest Chrome and Firefox on desktop computers.</li>\n                <li>WebGL2 may not be available if your graphics drivers have crashed. Restarting your browser/computer may help.</li>\n                <li>Make sure your graphics drivers are up to date, some browsers disallow old drivers to be used.</li>\n                <li>Make sure WebGL2 is enabled. On Chrome you need to make sure \"Hardware Acceleration\" is enabled under advanced settings.</li>\n                <li>Visit <a href=\"http://webglreport.com/?v=2\">WebGL report</a> to see if your browser / device is supported.</li>\n              </ul>\n            </div>}\n          {webgl2ExtensionErrors.length > 0 && <div>\n              <h2>WebGL2 required extensions not available</h2>\n              The following required extensions are not available: {webgl2ExtensionErrors.join(', ')}\n              <ul>\n                <li>Try upgrading your graphics card drives.</li>\n              </ul>\n            </div>}\n          <Button onClick={() => window.location.reload()}>Reload page</Button>\n        </div>\n      </div>}\n\n      <div className=\"WorldCanvasContent\">\n        {loading ? <div className=\"WorldCanvasLoading\">Loading....</div> : children}\n      </div>\n\n      {shaderErrors.length > 0 && <div className=\"ShaderErrors\" title=\"Dr. Derk's Mutant Battlegrounds may not work properly on this device\"><i className=\"fas fa-exclamation-triangle\" /> {shaderErrors.length} shader compilation errors</div>}\n      {shaderErrors.length > 0 && version.isDevelopment && <ShaderDebugger shaderErrors={shaderErrors} />}\n\n    </WorldCanvasContext.Provider>\n  </WorldProgramContext.Provider>\n}\n","import * as React from 'react';\nimport { EventDispatcher } from '../Util';\nimport lodash from 'lodash';\n\nexport class Store<T> {\n  constructor(public state: T) {}\n  update(change: Partial<T>) {\n    this.state = {\n      ...this.state,\n      ...change\n    };\n    this.onChange.dispatch(this.state, change);\n  }\n  onChange = new EventDispatcher<[T, Partial<T>]>();\n}\n\nexport function useStore<State, Selection>(context: React.Context<Store<State>>, map: (data: State) => Selection): Selection {\n  const store = React.useContext(context);\n  const sel = React.useRef(map(store.state));\n  const [selection, setSelection] = React.useState(sel.current);\n\n  React.useEffect(() => {\n    const eventListener = (newData: State) => {\n      const newSelection = map(store.state);\n      if (lodash.isEqual(sel.current, newSelection)) {\n        return;\n      }\n      sel.current = newSelection;\n      setSelection(newSelection);\n    }\n\n    store.onChange.attach(eventListener);\n\n    return () => {\n      store.onChange.detach(eventListener);\n    };\n  }, [store, map]);\n\n  return selection;\n}\n\nexport function useStoreSelect<State>(context: React.Context<Store<State>>, ...keys: Array<keyof State>): State {\n  // eslint-disable-next-line\n  const map = React.useCallback(d => keys.reduce((p, k) => ({...p, [k]: d[k] }), {}), keys);\n  return useStore(context, map) as State;\n}\n","import * as React from 'react';\nimport { GpuWorldStateData } from \"../GpuWorld/StateData\";\nimport { GpuWorldState, GpuWorldStateEventDataChanged } from \"../GpuWorld/State\";\n\nexport const WorldStateContext = React.createContext<GpuWorldState | undefined>(undefined);\n\nfunction didPropsChange<T extends object>(prevProps: T, newProps: T) {\n  for (const k of Object.keys(newProps)) {\n    if (prevProps[k] !== newProps[k]) {\n      return true;\n    }\n  }\n  for (const k of Object.keys(prevProps)) {\n    if (prevProps[k] !== newProps[k]) {\n      return true;\n    }\n  }\n  return false;\n}\n\nexport function useWorldData<Selection extends object>(map: (data: GpuWorldStateData) => Selection): Partial<Selection> {\n  const worldState = React.useContext(WorldStateContext);\n  const [selection, setSelection] = React.useState(worldState ? map(worldState.data) : {});\n\n  React.useEffect(() => {\n    function eventListener(event: GpuWorldStateEventDataChanged) {\n      const newSelection = worldState ? map(worldState.data) : {};\n      if (!didPropsChange(selection, newSelection)) {\n        return;\n      }\n      setSelection(newSelection);\n    }\n\n    if (worldState) {\n      worldState.events.dataChanged.attach(eventListener)\n    }\n\n    return () => {\n      if (worldState) {\n        worldState.events.dataChanged.detach(eventListener)\n      }\n    };\n  });\n\n  return selection;\n}\n\nexport function useWorldDataSingle<T>(map: (data: GpuWorldStateData) => T): T | undefined {\n  return useWorldData(d => ({ value: map(d) })).value;\n}\n\nexport function useWorldDataSelect(...keys: Array<keyof GpuWorldStateData>): Partial<GpuWorldStateData> {\n  return useWorldData(d => keys.reduce((p, k) => ({...p, [k]: d[k] }), {}));\n}\n","import * as React from 'react';\nimport './index.css';\nimport { WorldStateContext } from '../../GameComponents/WorldDataConsumer';\nimport { Column, Row, BlockSection, ScrollableColumn } from '../Layout';\nimport { Button, FontAwesomeButton } from '../Button';\nimport { EntityRef } from '../../GpuWorld/StateData';\nimport { ArchetypeIndexQuery } from '../../GpuUtil/ECS/Query';\nimport { Component } from '../../GpuUtil/ECS';\n\nexport function ECSInspector() {\n  const worldState = React.useContext(WorldStateContext);\n  const [archetypes, setArchetypes] = React.useState<Array<{ components: string[] }>>([]);\n  const [selectedArchetype, setSelectedArchetype] = React.useState(0);\n  const [entities, setEntities] = React.useState<Array<EntityRef>>([]);\n  const [selectedEntity, setSelectedEntity] = React.useState(0);\n  const [entityData, setEntityData] = React.useState<Array<{ component: Component, data: any }>>([]);\n  const [componentFilter, setComponentFilter] = React.useState('');\n  React.useEffect(() => {\n    if (worldState) {\n      setEntities(new ArchetypeIndexQuery(selectedArchetype).entities().get(worldState));\n    }\n  }, [worldState, selectedArchetype]);\n  const updateEntityData = () => {\n    if (worldState) {\n      const entityCell = entities[selectedEntity];\n      if (entityCell) {\n        setEntityData(worldState.ecs.getAllEntityData(entityCell, false));\n      } else {\n        setEntityData([]);\n      }\n    }\n  };\n  React.useEffect(updateEntityData, [worldState, selectedEntity, entities]);\n  const updateArchetypes = () => {\n    if (worldState) {\n      setArchetypes(worldState.ecs.archetypes.map(arch => ({\n        components: arch.components.map(comp => comp.name)\n      })));\n    }\n  }\n  React.useEffect(updateArchetypes, []);\n  if (!worldState) {\n    return null;\n  }\n  const compFilter = componentFilter.split(',').map(x => x.trim().toLowerCase());\n  return <Row className=\"ECSInspector\" style={{ overflow: 'hidden' }}>\n    <Column style={{ maxWidth: 300 }}>\n      <Button onClick={updateArchetypes}>Update archetypes</Button>\n      <ScrollableColumn>\n        <Column>\n          {archetypes.map((arch, i) => <Row key={i}>\n            <BlockSection>\n              <Button toggled={i === selectedArchetype} onClick={() => setSelectedArchetype(i)}>{i}:</Button>\n              {arch.components.join(', ')}\n            </BlockSection>\n          </Row>)}\n        </Column>\n      </ScrollableColumn>\n    </Column>\n    <ScrollableColumn className=\"ECSInspectorEntitiesColumn\">\n      <Column>\n        {entities.map((entityCell, i) => <Row key={i}>\n          <Button toggled={i === selectedEntity} onClick={() => setSelectedEntity(i)}>\n            {JSON.stringify(entityCell)}\n          </Button>\n        </Row>)}\n      </Column>\n    </ScrollableColumn>\n    <Column style={{ overflow: 'hidden' }}>\n      <Row style={{ flexShrink: 0 }}>\n        <input type=\"text\" className=\"ECSInspectorComponentFilter\" value={componentFilter} onChange={e => setComponentFilter(e.target.value)} />\n        <FontAwesomeButton icon=\"sync\" onClick={() => updateEntityData()} />\n        <FontAwesomeButton icon=\"copy\" onClick={() => navigator.clipboard.writeText(JSON.stringify(entityData, null, 2))} />\n      </Row>\n      <ScrollableColumn>\n        <Column>\n          {entityData\n            .filter(x => componentInFilter(x.component.name, compFilter))\n            .map(({ component, data }, i) => <Row key={i}>\n              <Column className=\"ECSInspectorComponentName\">\n                {component.name}\n              </Column>\n              <Column className=\"ECSInspectorComponentValue\">\n                <pre>{JSON.stringify(data, null, 2)}</pre>\n              </Column>\n            </Row>)}\n        </Column>\n      </ScrollableColumn>\n    </Column>\n  </Row>\n}\nfunction componentInFilter(componentName: string, filters: string[]) {\n  if (filters.length === 0) {\n    return true;\n  }\n  for (const filter of filters) {\n    if (componentName.toLowerCase().indexOf(filter) !== -1) {\n      return true;\n    }\n  }\n  return false;\n}\n","import * as React from 'react';\n\nexport function hotkeyIgnoreElement(target: EventTarget | null) {\n  if (!target) {\n    return false;\n  }\n  const el = target as Element;\n  if (['input', 'select', 'textarea'].indexOf(el.tagName.toLowerCase()) !== -1) {\n    return true;\n  }\n  if ((el as HTMLElement).contentEditable === 'true') {\n    return true;\n  }\n  return false;\n}\n\nexport function useHotkeyRaw(onKeydown: (event: KeyboardEvent) => void, onKeyup?: (event: KeyboardEvent) => void) {\n  React.useEffect(() => {\n    const handleKeydown = (event: KeyboardEvent) => {\n      if (hotkeyIgnoreElement(event.target)) {\n        return;\n      }\n      onKeydown(event);\n    };\n    const handleKeyup = (event: KeyboardEvent) => {\n      if (hotkeyIgnoreElement(event.target)) {\n        return;\n      }\n      if (onKeyup) {\n        onKeyup(event);\n      }\n    };\n    document.addEventListener('keydown', handleKeydown);\n    document.addEventListener('keyup', handleKeyup);\n    return () => {\n      document.removeEventListener('keydown', handleKeydown);\n      document.removeEventListener('keyup', handleKeyup);\n    }\n  }, [onKeydown, onKeyup]);\n}\n\nexport function useHotkey(keyCode: string | undefined, onKeydown: () => void, onKeyup?: () => void) {\n  useHotkeyRaw(\n    React.useCallback(event => event.code === keyCode && onKeydown(), [keyCode, onKeydown]),\n    React.useCallback(event => event.code === keyCode && onKeyup && onKeyup(), [keyCode, onKeyup])\n    );\n}\n","import * as Math2 from './Math';\nimport * as Vector3 from './Vector3';\n\nexport interface SphericalCoordinate {\n  theta: number;\n  phi: number; // Around Z axis\n  radius: number;\n}\n\nexport function mix(a: SphericalCoordinate, b: SphericalCoordinate, p: number) {\n  return {\n    theta: Math2.mix(a.theta, b.theta, p),\n    phi: Math2.mix(a.phi, b.phi, p),\n    radius: Math2.mix(a.radius, b.radius, p),\n  }\n}\n\n// This is the cartesian distance\nexport function distance(a: SphericalCoordinate, b: SphericalCoordinate): number {\n  return Vector3.distance(Vector3.fromSphericalCoordinates(a), Vector3.fromSphericalCoordinates(b));\n}\n\nexport function isEqual(a: SphericalCoordinate, b: SphericalCoordinate): boolean {\n  return a.theta === b.theta && a.phi === b.phi && a.radius === b.radius;\n}","import * as Vector2 from '../Math/Vector2';\nimport * as Vector3 from '../Math/Vector3';\nimport * as SphericalCoordinate from './SphericalCoordinate';\nimport * as Math2 from '../Math/Math';\n\ninterface AnimateEaseTo<T> {\n  target: T;\n  speed?: number;\n  stopAnimateDistance?: number;\n}\nexport function isAnimateEaseTo<T>(obj: any): obj is AnimateEaseTo<T> {\n  return typeof obj === 'object' && obj.target !== undefined;\n}\nfunction animateEaseToWithDefaults<T>({ target, speed = 0.1, stopAnimateDistance = 0.001 }: AnimateEaseTo<T>): Required<AnimateEaseTo<T>> {\n  return { target, speed, stopAnimateDistance };\n}\n\nexport interface Animatable<T> {\n  current: T;\n  animate?: AnimateEaseTo<T>;\n}\ninterface AnimatableValueImpl<T> {\n  mix: (a: T, b: T, p: number) => T;\n  distance: (a: T, b: T) => number;\n  isEqual: (a: T, b: T) => boolean;\n}\nexport function createAnimator<T>({ mix, distance, isEqual }: AnimatableValueImpl<T>) {\n  return {\n    create(current: T): Animatable<T> {\n      return { current };\n    },\n    target(value: Animatable<T>) {\n      if (value.animate !== undefined) {\n        return value.animate.target;\n      } else {\n        return value.current;\n      }\n    },\n    nextValue(value: Animatable<T>, dt: number): Animatable<T> {\n      if (value.animate !== undefined) {\n        const { target, stopAnimateDistance, speed } = animateEaseToWithDefaults(value.animate);\n        const d = distance(value.current, target);\n        if (d > stopAnimateDistance) {\n          return {\n            // See https://www.reddit.com/r/gamedev/comments/cayb4f/basic_smooth_spring_movement/\n            current: mix(value.animate.target, value.current, Math.pow(1 - speed, dt * 60 / 1000)),\n            animate: value.animate\n          };\n        } else {\n          return {\n            current: value.animate.target,\n            animate: undefined\n          };\n        }\n      } else {\n        return value;\n      }\n    },\n    easeTo(animatable: Animatable<T>, value: AnimateEaseTo<T> | T): Animatable<T> {\n      if (!isAnimateEaseTo(value)) {\n        value = { target: value };\n      }\n      if (isEqual(animatable.current, value.target)) {\n        if (animatable.animate) {\n          return { current: value.target };\n        } else {\n          return animatable;\n        }\n      } else {\n        const { target, stopAnimateDistance } = animateEaseToWithDefaults(value);\n        if (distance(animatable.current, target) < stopAnimateDistance) {\n          return { current: value.target };\n        } else {\n          return { current: animatable.current, animate: value };\n        }\n      }\n    }\n  }\n}\n\nexport const Vec2Anim = createAnimator(Vector2);\nexport const Vec3Anim = createAnimator(Vector3);\nexport const NumberAnim = createAnimator({ mix: Math2.mix, distance: (a, b) => Math.abs(a - b), isEqual: (a, b) => a === b });\nexport const SphericalCoordinateAnim = createAnimator(SphericalCoordinate);\n\nexport function animatableShouldUpdate<T>(animatable: Animatable<T>) {\n  return animatable.animate !== undefined;\n}\n\nexport function animatablesShouldUpdate(...animatables: Array<Animatable<any>>) {\n  for (const a of animatables) {\n    if (animatableShouldUpdate(a)) {\n      return true;\n    }\n  }\n  return false;\n}\n","import { mat4 } from 'gl-matrix';\nimport { clamp, mod } from '../Math/Math';\nimport * as Vector3 from '../Math/Vector3';\nimport * as Vector2 from '../Math/Vector2';\nimport { SphericalCoordinate } from '../Math/SphericalCoordinate';\n\nexport interface OrthographicProjection {\n  type: 'Ortho',\n  left: number;\n  right: number;\n  bottom: number;\n  top: number;\n  near: number;\n  far: number;\n}\nexport interface PerspectiveProjection {\n  type: 'Perspective',\n  fovy: number;\n  near: number;\n  far: number;\n  aspectRatio: number;\n}\n\nexport type CameraProjection = OrthographicProjection | PerspectiveProjection;\n\nexport interface LookatView {\n  type: 'LookatView';\n  eye: Vector3.Vector3;\n  lookAt: Vector3.Vector3;\n  up: Vector3.Vector3;\n  screenOffset: Vector2.Vector2;\n}\n\nexport function maxDistanceLookatCamera(a: LookatView, b: LookatView) {\n  return Math.max(Vector3.distance(a.eye, b.eye), Vector3.distance(a.lookAt, b.lookAt), Vector3.distance(a.up, b.up));\n}\n\nexport interface SphericalView {\n  type: 'SphericalView';\n  rotation: SphericalCoordinate;\n  lookAt: Vector3.Vector3;\n  up: Vector3.Vector3;\n  screenOffset: Vector2.Vector2;\n}\n\nexport type CameraView = SphericalView | LookatView;\n\nexport interface Camera<View = CameraView, Projection = CameraProjection> {\n  view: View;\n  projection: Projection;\n};\nexport type LookatCamera = Camera<LookatView, CameraProjection>;\n\nexport function lookatViewZoomTowards(view: LookatView, point: Vector3.Vector3, percent: number): CameraView {\n  const lookatDelta = Vector3.mul(Vector3.sub(point, view.lookAt), percent);\n  const positionDelta = Vector3.mul(Vector3.sub(point, view.eye), percent);\n  return {\n    ...view,\n    lookAt: Vector3.add(view.lookAt, lookatDelta),\n    eye: Vector3.add(view.eye, positionDelta),\n  };\n}\nexport function sphericalViewZoomTowards(view: SphericalView, point: Vector3.Vector3, percent: number, minRadius: number, maxRadius: number): SphericalView {\n  const newRadius = clamp(view.rotation.radius - view.rotation.radius * percent, minRadius, maxRadius);\n  percent = (1.0 - newRadius / view.rotation.radius);\n  const lookatDelta = Vector3.mul(Vector3.sub(point, view.lookAt), percent);\n  return {\n    ...view,\n    lookAt: Vector3.add(view.lookAt, lookatDelta),\n    rotation: {\n      ...view.rotation,\n      radius: newRadius\n    }\n  };\n}\nexport function sphericalViewZoom(view: SphericalView, percent: number, minRadius: number, maxRadius: number): SphericalView {\n  const newRadius = clamp(view.rotation.radius - view.rotation.radius * percent, minRadius, maxRadius);\n  return {\n    ...view,\n    rotation: {\n      ...view.rotation,\n      radius: newRadius\n    }\n  };\n}\nexport function cameraDistance(camera: Camera): number {\n  if (camera.view.type === 'LookatView') {\n    return Vector3.length(Vector3.sub(camera.view.eye, camera.view.lookAt));\n  } else {\n    return camera.view.rotation.radius;\n  }\n}\n\nexport function eyeOfCamera(camera: Camera) {\n  if (camera.view.type === 'LookatView') {\n    return camera.view.eye;\n  } else {\n    return Vector3.add(camera.view.lookAt, Vector3.fromSphericalCoordinates(camera.view.rotation));\n  }\n}\n\nexport interface CameraMatrices {\n  view: mat4;\n  projection: mat4;\n  viewProjection: mat4;\n  invViewProjection: mat4 | null;\n}\nexport function cameraMatricesFromCamera(camera: Camera): CameraMatrices {\n  let proj;\n  if (camera.projection.type === 'Ortho') {\n    proj = mat4.ortho(mat4.create(), camera.projection.left, camera.projection.right, camera.projection.bottom, camera.projection.top, camera.projection.near, camera.projection.far);\n  } else {\n    proj = mat4.perspective(mat4.create(), camera.projection.fovy, camera.projection.aspectRatio, camera.projection.near, camera.projection.far);\n  }\n  const position = eyeOfCamera(camera);\n  const view = mat4.lookAt(mat4.create(), Vector3.toGlVec3(position), Vector3.toGlVec3(camera.view.lookAt), Vector3.toGlVec3(camera.view.up));\n  // mat4.mul(proj, mat4.translate(mat4.create(), mat4.identity(mat4.create()), [camera.view.screenOffset.x, camera.view.screenOffset.y, 0]), proj);\n\n  const viewProjection = mat4.multiply(mat4.create(), proj, view);\n  return {\n    view,\n    projection: proj,\n    viewProjection,\n    invViewProjection: mat4.invert(mat4.create(), viewProjection)\n  }\n}\n\nexport function rotateSphericalCoordinates(rotation: SphericalCoordinate, phi: number, theta: number, thetaLimit = 0.1) {\n  return {\n    theta: clamp(rotation.theta + theta, thetaLimit, Math.PI - thetaLimit),\n    phi: mod(rotation.phi + phi, Math.PI * 2),\n    radius: rotation.radius\n  };\n}\n\nexport function rotateSphericalCamera(camera: SphericalView, phi: number, theta: number, thetaLimit?: number) {\n  return {\n    ...camera,\n    rotation: rotateSphericalCoordinates(camera.rotation, phi, theta, thetaLimit)\n  };\n}\n\nexport function rotateLookatCamera(camera: LookatView, phi: number, theta: number, thetaLimit?: number): LookatView {\n  const s = Vector3.toSphericalCoordinates(Vector3.sub(camera.lookAt, camera.eye));\n  const newS = rotateSphericalCoordinates(s, phi, theta, thetaLimit);\n  return {\n    ...camera,\n    eye: Vector3.add(camera.lookAt, Vector3.fromSphericalCoordinates(newS))\n  };\n}\n\nexport function ortographicProjectionFitPoints(camera: LookatView, points: Vector3.Vector3[]): OrthographicProjection {\n  const view = mat4.lookAt(mat4.create(), Vector3.toGlVec3(camera.eye), Vector3.toGlVec3(camera.lookAt), Vector3.toGlVec3(camera.up));\n  let min;\n  let max;\n  for (const point of points) {\n    const p = Vector3.transform(point, view);\n    if (!min && !max) {\n      min = {...p };\n      max = {...p };\n    } else {\n      min.x = Math.min(min.x, p.x);\n      min.y = Math.min(min.y, p.y);\n      min.z = Math.min(min.z, p.z);\n\n      max.x = Math.max(max.x, p.x);\n      max.y = Math.max(max.y, p.y);\n      max.z = Math.max(max.z, p.z);\n    }\n  }\n  return {\n    type: 'Ortho',\n    left: min.x,\n    right: max.x,\n    bottom: min.y,\n    top: max.y,\n    near: -max.z,\n    far: -min.z,\n  }\n}","import * as React from 'react';\nimport { WorldCanvasContext, WorldProgramContext } from '../../Components/WorldCanvas';\nimport { hotkeyIgnoreElement } from '../../Components/Hotkeys';\nimport { WorldStateContext } from '../../GameComponents/WorldDataConsumer';\nimport * as Vector3 from '../../Math/Vector3';\nimport * as Vector2 from '../../Math/Vector2';\nimport { Animatable, Vec2Anim, NumberAnim, Vec3Anim } from '../../Math/Animatable';\nimport { cameraDistance, eyeOfCamera, PerspectiveProjection, LookatView } from '../../GpuUtil/Camera';\nimport { screenRay, rayPlaneIntersection, clamp } from '../../Math/Math';\nimport { objectSetKeys } from '../../Util';\nimport { mat4 } from 'gl-matrix';\nimport { Position, Quaternion, Scale } from '../../GpuWorld/ECS/Transform';\nimport { Camera } from '../../GpuWorld/ECS/Camera';\n\ninterface RTSCameraState {\n  camera: { view: LookatView, projection: PerspectiveProjection };\n  panning?: {\n    originalMouseWorldPlaneIntersection: Vector3.Vector3,\n    originalInvViewProjection: mat4,\n    originalCameraPosition: Vector2.Vector2,\n  };\n  isPanning: boolean;\n  position: Animatable<Vector2.Vector2>;\n  elevation: Animatable<number>;\n  eyeMeasuredHeight: number;\n  positionMeasuredHeight: number;\n  navigationModeTilt: Animatable<Vector3.Vector3>;\n  slideVelocity: Vector2.Vector2;\n  slideTargetPosition: Vector2.Vector2 | null;\n  screenOffset: Animatable<Vector2.Vector2>;\n  zoom: number;\n  selectedEntityTranslation?: Vector3.Vector3;\n}\n\nexport function defaultRTSCameraConf() {\n  return {\n    fovy: (27.8 / 360) * Math.PI * 2,\n    angle: ((90 - 56) / 360) * Math.PI * 2,\n    zrot: -Math.PI / 2,\n    keyboardPanSpeed: 0.001,\n    panningFriction: 0.05,\n    panningStopSpeed: 0.0002,\n    rotationSpeed: 0.01,\n  };\n}\n\nexport function RTSCameraController({ conf = defaultRTSCameraConf() }: { conf?: ReturnType<typeof defaultRTSCameraConf> }) {\n  const worldState = React.useContext(WorldStateContext);\n  const worldProgram = React.useContext(WorldProgramContext);\n  const worldCanvas = React.useContext(WorldCanvasContext);\n\n  React.useEffect(() => {\n    if (!worldState || !worldProgram) {\n      return;\n    }\n    const { worldSize } = worldState.data;\n\n    const DefaultZoom = 70;\n    const WorldCenter = { x: worldSize.width / 2, y: worldSize.height / 2 };\n    const CameraFreedom = 10;\n    const CameraMinPosition = Vector2.sub(WorldCenter, CameraFreedom);\n    const CameraMaxPosition = Vector2.add(WorldCenter, CameraFreedom);\n    const GameCameraNavigationMinGroundHeight = 5;\n\n    const navigationModeTilt = (zoom: number) => {\n      return Vector3.fromSphericalCoordinates({ theta: conf.angle, phi: conf.zrot, radius: zoom });\n    }\n\n    let cameraState: RTSCameraState = {\n      camera: {\n        view: {\n          type: 'LookatView',\n          lookAt: { x: 0, y: 0, z: 0 },\n          eye: { x: 10, y: 10, z: 10 },\n          up: { x: 0, y: 0, z: 1 },\n          screenOffset: { x: 0, y: 0 }\n        },\n        projection: {\n          type: 'Perspective',\n          fovy: 1,\n          near: 0.1,\n          far: 30,\n          aspectRatio: 1,\n        }\n      },\n      isPanning: false,\n      position: Vec2Anim.create({ x: worldSize.width / 2, y: worldSize.height / 2 }),\n      elevation: NumberAnim.create(0),\n      eyeMeasuredHeight: 1,\n      positionMeasuredHeight: 1,\n      navigationModeTilt: Vec3Anim.create(navigationModeTilt(DefaultZoom)),\n      slideVelocity: Vector3.zero(),\n      slideTargetPosition: null,\n      screenOffset: Vec2Anim.create({ x: 0, y: 0 }),\n      zoom: DefaultZoom,\n    }\n\n    let previousMousePosition: Vector2.Vector2;\n    let mousePosition: Vector2.Vector2;\n    let previousDocumentMouseMoveEvent: MouseEvent;\n\n\n    const startPan = () => {\n      if (cameraState.isPanning || !mousePosition) {\n        return;\n      }\n      const originalInvViewProjection = mat4.clone(worldState.derived.cameraInvProjectionView);\n      const originalMouseWorldPlaneIntersection = intersectScreenRayWorldPlane(mousePosition, 0, originalInvViewProjection, worldState.data.canvasRect);\n      const originalCameraPosition = cameraState.position.current;\n\n      if (originalMouseWorldPlaneIntersection) {\n        cameraState = {\n          ...cameraState,\n          panning: {\n            originalInvViewProjection,\n            originalMouseWorldPlaneIntersection,\n            originalCameraPosition\n          },\n          slideTargetPosition: originalCameraPosition,\n        }\n        return true;\n      } else {\n        return false;\n      }\n    }\n\n    const stopPan = () => {\n      cameraState = {\n        ...cameraState,\n        slideTargetPosition: null,\n        panning: undefined,\n      }\n      setTimeout(() => {\n        cameraState = {\n          ...cameraState,\n          isPanning: false\n        }\n      }, 10);\n    }\n\n\n    const handleDocumentMouseMove = (event: MouseEvent) => {\n      if (previousDocumentMouseMoveEvent) {\n        previousMousePosition = mousePosition;\n        mousePosition = { x: event.clientX, y: event.clientY };\n\n        if (!previousDocumentMouseMoveEvent.ctrlKey && event.ctrlKey) {\n          startPan();\n        } else if (previousDocumentMouseMoveEvent.ctrlKey && !event.ctrlKey) {\n          stopPan();\n        }\n        const { panning } = cameraState;\n        if (panning) {\n          const mouseWorldPlanePosition = intersectScreenRayWorldPlane(mousePosition, 0, panning.originalInvViewProjection, worldState.data.canvasRect);\n          const isPanning = cameraState.isPanning || Vector2.length(Vector2.sub(previousMousePosition, mousePosition)) > 3;\n          if (mouseWorldPlanePosition) {\n            cameraState = {\n              ...cameraState,\n              isPanning,\n              slideTargetPosition: Vector2.clamp(Vector2.add(panning.originalCameraPosition,\n                Vector2.sub(panning.originalMouseWorldPlaneIntersection, mouseWorldPlanePosition)),\n                CameraMinPosition, CameraMaxPosition),\n            };\n          }\n        }\n\n        worldState.ensureRendered();\n      }\n      previousDocumentMouseMoveEvent = event;\n    }\n\n    const handleWorldMouseDown = (event: MouseEvent) => {\n      if (event.button !== 0) {\n        return;\n      }\n      const panStart = startPan();\n      const onMouseUp = () => {\n        document.removeEventListener('mouseup', onMouseUp);\n        if (panStart) {\n          stopPan();\n        }\n      };\n      document.addEventListener('mouseup', onMouseUp);\n    }\n\n    const handleWorldMouseWheel = (event: WheelEvent) => {\n      event.preventDefault();\n      event.stopImmediatePropagation();\n      previousMousePosition = mousePosition;\n      mousePosition = { x: event.clientX, y: event.clientY };\n      const delta = -(window.navigator.platform === 'Win32' ? (event.deltaY < 0 ? -1 : 1) * -0.2 : event.deltaY * -0.005) * worldState.derived.userSettingsOrFallback.mouseWheelSensitivity;\n\n      const zoom = clamp(cameraState.zoom * (1 + delta), 30, DefaultZoom);\n\n      cameraState = {\n        ...cameraState,\n        navigationModeTilt: {\n          current: navigationModeTilt(zoom),\n        },\n        zoom,\n      }\n    }\n\n    const updateFrame = (deltaTime: number, gameCamera: RTSCameraState): RTSCameraState => {\n      let newCamera = gameCamera.camera;\n\n      gameCamera = objectSetKeys(gameCamera, {\n        elevation: NumberAnim.easeTo(gameCamera.elevation, { target: gameCamera.positionMeasuredHeight })\n      });\n\n      // Update all animatables\n      gameCamera = objectSetKeys(gameCamera, {\n        position: Vec2Anim.nextValue(gameCamera.position, deltaTime),\n        navigationModeTilt: Vec3Anim.nextValue(gameCamera.navigationModeTilt, deltaTime),\n        screenOffset: Vec2Anim.nextValue(gameCamera.screenOffset, deltaTime),\n        elevation: NumberAnim.nextValue(gameCamera.elevation, deltaTime),\n      });\n\n      if (gameCamera.slideTargetPosition) {\n        // While we are dragging we make the velocity so that it perfectly moves with the cursor\n        const d = Vector2.sub(gameCamera.slideTargetPosition, gameCamera.position.current);\n        gameCamera = {...gameCamera, slideVelocity: Vector2.div(d, deltaTime) };\n      }\n      const sliding = Vector2.length(gameCamera.slideVelocity) > conf.panningStopSpeed;\n      if (sliding) {\n        gameCamera = {\n          ...gameCamera,\n          position: { current: Vector2.add(gameCamera.position.current, Vector2.mul(gameCamera.slideVelocity, deltaTime)) },\n          slideVelocity: Vector2.mul(gameCamera.slideVelocity, 1 - conf.panningFriction)\n        };\n\n        gameCamera = {\n          ...gameCamera,\n          position: { current: Vector2.clamp(gameCamera.position.current,\n            CameraMinPosition,\n            CameraMaxPosition\n          ) }\n        };\n      }\n\n      const tilt = gameCamera.navigationModeTilt.current;\n\n      const lookAt = objectSetKeys(newCamera.view.lookAt, {...gameCamera.position.current, z: gameCamera.elevation.current });\n      const eye = objectSetKeys(newCamera.view.eye, Vector3.add(lookAt, tilt));\n\n      newCamera = objectSetKeys(newCamera, {\n        view: objectSetKeys(newCamera.view, {\n          type: 'LookatView',\n          lookAt,\n          eye,\n          up: objectSetKeys(newCamera.view.up, { x: 0, y: 0, z: 1 }),\n          screenOffset: objectSetKeys(newCamera.view.screenOffset, gameCamera.screenOffset.current)\n        })\n      });\n\n      const minEyeHeight = gameCamera.eyeMeasuredHeight + GameCameraNavigationMinGroundHeight;\n      if (newCamera.view.eye.z < minEyeHeight) {\n        newCamera = objectSetKeys(newCamera, {\n          view: objectSetKeys(newCamera.view, {\n            eye: objectSetKeys(newCamera.view.eye, {\n              z: minEyeHeight\n            })\n          })\n        });\n      }\n\n      newCamera = objectSetKeys(newCamera, {\n        projection: objectSetKeys(newCamera.projection, {\n          type: 'Perspective',\n          fovy: conf.fovy,\n          near: 0.1,\n          far: 450,\n          aspectRatio: worldState.data.canvasRect.width / worldState.data.canvasRect.height\n        })\n      });\n\n      return objectSetKeys(gameCamera, {\n        camera: newCamera\n      });\n    }\n    const updateCameraFrame = (event: { delta: number }) => {\n      let nextState = updateFrame(event.delta, cameraState);\n\n      const cameraChanged = nextState !== cameraState;\n      if (cameraChanged) {\n        const writeCamera = worldState.data.camera!;\n        const pos = worldState.ecs.getCpuComponentDataView(Position.cpuComponent, writeCamera);\n        const quat = worldState.ecs.getCpuComponentDataView(Quaternion.cpuComponent, writeCamera);\n        const scale = worldState.ecs.getCpuComponentDataView(Scale.cpuComponent, writeCamera);\n        const tmpMat = mat4.create();\n        mat4.lookAt(tmpMat, Vector3.toGlVec3(nextState.camera.view.eye), Vector3.toGlVec3(nextState.camera.view.lookAt), Vector3.toGlVec3(nextState.camera.view.up));\n        mat4.invert(tmpMat, tmpMat);\n        mat4.getTranslation(pos!, tmpMat);\n        mat4.getRotation(quat!, tmpMat);\n        mat4.getScaling(scale!, tmpMat);\n        worldState.ecs.setComponentData(Camera.Fovy, writeCamera, new Float32Array([nextState.camera.projection.fovy]));\n        worldState.ecs.setComponentData(Camera.Near, writeCamera, new Float32Array([nextState.camera.projection.near]));\n        worldState.ecs.setComponentData(Camera.Far, writeCamera, new Float32Array([nextState.camera.projection.far]));\n        cameraState = nextState;\n        worldState.ensureRendered();\n        // if (this.audio) {\n        //   this.audio.updateCamera(nextState.camera);\n        // }\n      }\n    }\n\n    const stepPanCamera = (step: Vector2.Vector2, slide = true) => {\n      const zoom = cameraDistance(cameraState.camera);\n      const velocity = conf.keyboardPanSpeed * zoom;\n      const pos = {...eyeOfCamera(cameraState.camera)};\n      pos.z = 0;\n      const lookat = {...cameraState.camera.view.lookAt};\n      lookat.z = 0;\n      const vertical = Vector2.normalize(Vector2.sub(pos, lookat));\n      const horizontal = Vector2.perpendicular(vertical);\n      const delta = Vector2.add(cameraState.slideVelocity, Vector2.add(\n        Vector2.mul(horizontal, velocity * step.x),\n        Vector2.mul(vertical, velocity * step.y))\n      );\n      cameraState = slide ? {\n        ...cameraState,\n        slideVelocity: delta\n      } : {\n        ...cameraState,\n        position: Vec2Anim.create(Vector2.add(cameraState.position.current, delta))\n      };\n    }\n\n    const handleKeydown = (event: KeyboardEvent) => {\n      if (hotkeyIgnoreElement(event.target)) {\n        return;\n      }\n      switch (event.code) {\n        case 'ArrowLeft': { stepPanCamera({ x: 1, y: 0 }); break }\n        case 'ArrowRight': { stepPanCamera({ x: -1, y: 0 }); break }\n        case 'ArrowUp': { stepPanCamera({ x: 0, y: -1 }); break }\n        case 'ArrowDown': { stepPanCamera({ x: 0, y: 1 }); break }\n      }\n    };\n\n    worldState.events.camera.attach(updateCameraFrame);\n    document.addEventListener('mousemove', handleDocumentMouseMove);\n    document.addEventListener('mouseleave', handleDocumentMouseMove);\n    document.addEventListener('keydown', handleKeydown);\n    if (worldCanvas) {\n      worldCanvas.addEventListener('mousedown', handleWorldMouseDown);\n      worldCanvas.addEventListener('wheel', handleWorldMouseWheel);\n    }\n\n    updateCameraFrame({ delta: 0 });\n\n    return () => {\n      worldState.events.camera.detach(updateCameraFrame);\n      document.removeEventListener('mousemove', handleDocumentMouseMove);\n      document.removeEventListener('mouseleave', handleDocumentMouseMove);\n      document.removeEventListener('keydown', handleKeydown);\n      if (worldCanvas) {\n        worldCanvas.removeEventListener('mousedown', handleWorldMouseDown);\n        worldCanvas.removeEventListener('wheel', handleWorldMouseWheel);\n      }\n    }\n  }, [worldState, worldProgram, worldCanvas]);\n\n  return null;\n}\n\nfunction intersectScreenRayWorldPlane(screenPosition: Vector2.Vector2, planeZ: number, invViewProjection: mat4, canvasClientRect: ClientRect): Vector3.Vector3 | null {\n  if (!invViewProjection) {\n    return null;\n  }\n  const position = { x: screenPosition.x - canvasClientRect.left, y: screenPosition.y - canvasClientRect.top };\n  const viewport = { x: 0, y: 0, width: canvasClientRect.width, height: canvasClientRect.height };\n  const ray = screenRay(invViewProjection, viewport, position);\n  return rayPlaneIntersection(ray, { normal: { x: 0, y: 0, z: 1 }, distance: -planeZ });\n}\n","import { Subtract } from \"utility-types\";\nimport { NumberEditorOptions, StructEditorLayout, SliderEditorOptions } from \".\";\n\nexport type EditorTypedefRef = string;\nexport type EditorTypedefUserDefined = EditorStructTypedef | EditorEnumStructTypedef | EditorObnumTypedef | EditorEnumTypedef;\nexport type EditorTypedef = EditorTypedefUserDefined | EditorBooleanTypedef | EditorFloatTypedef | EditorPercentageTypedef |\n  EditorIntTypedef | EditorSliderTypedef | EditorStringTypedef |\n  EditorListTypedef | EditorTableTypedef | EditorTupleTypedef| EditorKeyValueTypedef | EditorSelectTypedef | EditorMapTypedef |\n  EditorColorTypedef | EditorFileTypedef | EditorPixlingTimespanDefTypedef;\n\nexport type EditorTypedefConvertible = EditorTypedefRef | EditorTypedef | (() => EditorTypedef);\n\nexport type EditorStructProperties1<T=any> = {\n  [P in keyof Partial<T>]: EditorTypedefConvertible;\n}\nexport type EditorStructProperties2<T=any> = Array<{\n  name: keyof T;\n  type: EditorTypedefConvertible;\n  label?: string;\n  title?: string;\n  visible?: boolean;\n}>\nexport type EditorStructProperties<T=any> = EditorStructProperties1<T> | EditorStructProperties2<T>;\nexport function editorStructProperties<T>(props: EditorStructProperties<T>): EditorStructProperties<T> {\n  return props;\n}\nexport interface EditorStructTypedef<T=any> {\n  metatype: 'struct';\n  properties: EditorStructProperties<T>;\n  layout?: StructEditorLayout;\n}\nexport function editorStructTypedef<T>(opts: Subtract<EditorStructTypedef<T>, { metatype: 'struct' }>): EditorStructTypedef<T> {\n  return {\n    metatype: 'struct',\n    ...opts\n  };\n}\n\nexport interface EditorEnumStructVariants {\n  [typeName: string]: {\n    displayName?: string;\n    labels?: { [key: string]: string };\n    properties: EditorStructProperties;\n    default: (type: string) => any;\n    description?: string\n  };\n}\nexport interface EditorEnumStructTypedef {\n  metatype: 'enumstruct';\n  variants: EditorEnumStructVariants;\n}\n\nexport type EditorEnumVariants = Array<{ value: any; displayName?: JSX.Element, description?: string, className?: string } | string> | { [displayName: string]: any };\ninterface EditorEnumTypedef {\n  metatype: 'enum';\n  variants: EditorEnumVariants | (() => EditorEnumVariants);\n  default?: any;\n}\n\nexport interface EditorObnumVariants {\n  [name: string]: { itemType: EditorTypedef, default?: any };\n}\nexport interface EditorObnumTypedef {\n  metatype: 'obnum';\n  variants: EditorObnumVariants;\n}\n\nexport interface EditorBooleanTypedef {\n  metatype: 'boolean';\n  asDropDown?: { true: string, false: string };\n  default?: boolean;\n}\n\nexport interface EditorFloatTypedef extends NumberEditorOptions {\n  metatype: 'float';\n}\n\nexport interface EditorIntTypedef extends NumberEditorOptions {\n  metatype: 'int';\n}\n\nexport interface EditorSliderTypedef extends SliderEditorOptions {\n  metatype: 'slider';\n}\n\nexport interface EditorPercentageTypedef {\n  metatype: 'percentage';\n  min?: number;\n  max?: number;\n  step?: number;\n  slider?: boolean;\n}\n\n\nexport interface EditorStringTypedef {\n  metatype: 'string';\n  multiline?: boolean;\n  readOnly?: boolean;\n}\n\nexport interface EditorListTypedef {\n  metatype: 'list';\n  itemType: EditorTypedefConvertible;\n  newItem: () => any;\n  keyFromItem?: (item: any) => any;\n  acceptItemDrop?: (item: any) => boolean;\n  readOnly?: boolean;\n}\n\nexport interface EditorTableTypedef {\n  metatype: 'table';\n  itemProperties: EditorStructProperties;\n  itemPropertiesLabels?: { [key: string]: string };\n  newItem: () => any;\n}\n\nexport interface EditorTupleTypedef {\n  metatype: 'tuple';\n  itemTypes: Array<EditorTypedef | EditorTypedefRef>;\n}\n\nexport interface EditorKeyValueTypedef {\n  metatype: 'keyvalue';\n  valueType: EditorTypedef | EditorTypedefRef;\n  valueDefault?: any;\n}\n\nexport interface EditorSelectTypedef {\n  metatype: 'select';\n  propertyKey: string;\n  propertyType: EditorTypedef;\n}\n\nexport interface EditorMapTypedef {\n  metatype: 'map';\n  map: (value: any) => any;\n  mappedType: EditorTypedef;\n}\n\nexport interface EditorColorTypedef {\n  metatype: 'color';\n}\n\nexport interface EditorFileTypedef {\n  metatype: 'file';\n}\n\n\nexport interface EditorPixlingTimespanDefTypedef {\n  metatype: 'pixlingTimespanDef';\n}\n\nexport type EditorTypedefResolver = (typeName: string) => EditorTypedef | undefined;\n","import { EditorTypedef, editorStructTypedef } from \"../../Components/Editors/EditorTypedefs\";\nimport { RGBA } from \"../../Util\";\nimport * as Vector3 from \"../../Math/Vector3\";\n\nexport interface GpuWorldRendererOptions {\n  lightExponent: number;\n  lightDirection: Vector3.Vector3;\n  diffuseColor: RGBA;\n  diffuseStrength: number;\n  ambientColor: RGBA;\n  ambientStrength: number;\n\n  worldPlaneColor: RGBA;\n  skyColor: RGBA;\n  fogColor: RGBA;\n  sunColor: RGBA;\n  sunFlareColor: RGBA;\n  sunSize: number;\n  sunFlareSize: number;\n  sunFlareExponent: number;\n  sunBorder: number;\n  fogDensity: number;\n  fogOffset: number;\n  skybox: boolean;\n  skyboxFogExponent: number;\n  skyboxFogHeight: number;\n  horizon: number;\n  overheadBars: boolean;\n  clearColor: RGBA;\n}\n\nexport function defaultRenderOptions(): GpuWorldRendererOptions {\n  return {\n    \"lightExponent\": 10,\n    lightDirection: Vector3.normalize({ x: -0.1, y: 1, z: 0.45 }),\n    \"diffuseColor\": {\n      \"r\": 30,\n      \"g\": 101,\n      \"b\": 168,\n      \"a\": 1\n    },\n    \"diffuseStrength\": 1,\n    \"ambientColor\": {\n      \"r\": 105,\n      \"g\": 127,\n      \"b\": 185,\n      \"a\": 1\n    },\n    \"ambientStrength\": 1,\n    \"worldPlaneColor\": {\n      \"r\": 0.701 * 255,\n      \"g\": 0.584 * 255,\n      \"b\": 0.242 * 255,\n      \"a\": 1\n    },\n    \"skyColor\": {\n      \"r\": 68,\n      \"g\": 112,\n      \"b\": 155,\n      \"a\": 1\n    },\n    \"fogColor\": {\n      r: 245,\n      g: 244,\n      b: 235,\n      \"a\": 1\n    },\n    \"sunColor\": {\n      \"r\": 255,\n      \"g\": 255,\n      \"b\": 255,\n      \"a\": 1\n    },\n    \"sunFlareColor\": {\n      \"r\": 255,\n      \"g\": 99,\n      \"b\": 48,\n      \"a\": 1\n    },\n    \"sunSize\": 0.001,\n    \"sunFlareSize\": 0.09,\n    \"sunFlareExponent\": 10,\n    \"sunBorder\": 0.001,\n    \"skybox\": false,\n    \"skyboxFogExponent\": 2,\n    skyboxFogHeight: 1,\n    horizon: 1.45,\n    \"overheadBars\": true,\n    \"clearColor\": {\n      r: 245,\n      g: 244,\n      b: 235,\n      // \"r\": 239,\n      // \"g\": 209,\n      // \"b\": 181,\n      \"a\": 1\n    },\n    \"fogDensity\": 0.003,\n    fogOffset: 80,\n  }\n}\n\nexport const GpuWorldRendererOptionsTypedef = (): EditorTypedef => editorStructTypedef<GpuWorldRendererOptions>({\n  properties: {\n    lightExponent: { metatype: 'float' },\n    lightDirection: Vector3.Vector3Typedef,\n    diffuseColor: { metatype: 'color' },\n    diffuseStrength: { metatype: 'float' },\n    ambientColor: { metatype: 'color' },\n    ambientStrength: { metatype: 'float' },\n    worldPlaneColor: { metatype: 'color' },\n    skyColor: { metatype: 'color' },\n    fogColor: { metatype: 'color' },\n    sunColor: { metatype: 'color' },\n    sunFlareColor: { metatype: 'color' },\n    sunSize: { metatype: 'float' },\n    sunFlareSize: { metatype: 'float' },\n    sunFlareExponent: { metatype: 'float' },\n    sunBorder: { metatype: 'float' },\n    skybox: { metatype: 'boolean' },\n    skyboxFogExponent: { metatype: 'float' },\n    skyboxFogHeight: { metatype: 'float' },\n    horizon: { metatype: 'float' },\n    overheadBars: { metatype: 'boolean' },\n    clearColor: { metatype: 'color' },\n    fogDensity: { metatype: 'float' },\n    fogOffset: { metatype: 'float' },\n  }\n});\n","import { InitWorldStateConfig, newInitWorldStateConfiguration } from \"./StateInit\";\nimport { GpuWorldStateLayout, SideSize } from \"./StateLayout\";\nimport { emptyGameLoopStats } from \"./GameLoop\";\nimport { defaultRenderOptions } from \"./Renderer/Configuration\";\nimport * as Vector2 from '../Math/Vector2';\nimport * as Vector3 from '../Math/Vector3';\nimport { RGBA, rgbFromHex, rgb255ToVec3 } from \"../Util\";\nimport { BattleWinner, BattleResult, DbCreatureBrain, DbBattleground } from \"db\";\nimport { AbilitiesData } from \"./Abilities/Abilities\";\nimport { HomeHealthColor, ManaColor, AwayHealthColor } from \"./StateLayout\";\nimport { RoundStats } from \"./Tools/RoundStats\";\nimport { DbTeam } from 'db';\nimport { ArenaInfo } from \"./Tools/ArenaInfos\";\nimport { TrainingStats, TeamTrainingStats, TrainingConfig } from \"./Tools/Breeding\";\nimport { UnitDef, CreatureDef } from \"./UnitDef\";\nimport { GpuComponent } from \"../GpuUtil/ECS\";\nimport { AnimationClip } from \"./ECS/Animation\";\n\nexport type GameInstance = {\n  type: 'none'\n} | {\n  type: 'battle';\n  battleground: DbBattleground;\n  homeTeam: Array<UnitDef | undefined>;\n} | {\n  type: 'train';\n  battleground: DbBattleground;\n  setupIndex: number;\n  homeTeam: Array<UnitDef | undefined>;\n  awayTeam: Array<UnitDef | undefined>;\n  trainHome: boolean;\n  trainAway: boolean;\n  arenas: number;\n  rounds: number;\n  turbo?: boolean;\n} | {\n  type: 'replay';\n  replayId: string;\n} | {\n  type: 'gym'\n};\n\n\nexport interface DebugAudioEffectPlaying { id: string, position: Vector3.Vector3, color: RGBA }\n\nexport class TeamSettings {\n  id?: string;\n  units: Array<UnitDef | undefined> = new Array(SideSize).fill(undefined);\n  unitCount = 0;\n  dbTeam?: DbTeam;\n  battlePoints = 0;\n  battleUnitsAlive = SideSize;\n  maxPossiblePoints = 0;\n  trainingStats = new TeamTrainingStats();\n  train = true;\n}\nexport class TeamMetrics {\n  alive = 0;\n  generation = 0;\n}\n\nexport type EntityRef = Vector2.Vector2;\nexport const NullEntityRef: EntityRef = { x: -1, y: -1 };\n\ninterface LogEntry {\n  time: Date;\n  step: number;\n  category: string;\n  message: string[];\n}\n\nexport interface RoundResult {\n  victories: number;\n  defeats: number;\n  ties: number;\n}\n\nexport class GpuWorldStateData {\n  constructor(public initConfig: InitWorldStateConfig = newInitWorldStateConfiguration()) {}\n\n  layout = new GpuWorldStateLayout(this.initConfig);\n\n  gameInstance: GameInstance = { type: 'none' };\n  battleground = DbBattleground.Solo;\n\n  battleId = '';\n  battleResult: BattleWinner = BattleWinner.Undecided;\n  completeBattleRes?: BattleResult;\n  battlePostUpdateDone = false;\n\n  trainingRounds = 0;\n\n  worldSize = this.layout.worldSize;\n  worldNCells = this.worldSize.width * this.worldSize.height;\n  groundResolution = 4;\n  groundSize = {\n    width: Math.ceil(this.layout.worldSize.width / this.groundResolution),\n    height: Math.ceil(this.layout.worldSize.height / this.groundResolution),\n  };\n\n\n  simulationStartTime = new Date();\n\n  stepCounter = 0;\n  battleStartStep = 0;\n  roundResults: RoundResult[] = [];\n  round = 0;\n  randomSeed = Math.random();\n  log: Array<LogEntry> = [];\n\n  simulationPaused = true;\n  simulationEnded = false;\n  substep = 0;\n  simulationSpeed = 1;\n  turboMode = false;\n  teams = {\n    home: new TeamSettings(),\n    away: new TeamSettings()\n  };\n  creaturesById: { [id: string]: CreatureDef } = {};\n\n  ensureRenderNextLoop = true;  // Don't modify directly, use state.ensureRenderer(), so breakpoints to figure out why things are rendering work\n  renderWorld = true;\n\n  physicsTimestep = 1/60;\n\n  previousMousePosition?: Vector2.Vector2;\n  mousePosition?: Vector2.Vector2;\n  mouseoverGround?: Vector3.Vector3;\n  canvasRect: ClientRect = { left: 0, top: 0, width: 1, height: 1, right: 0, bottom: 0 };\n  fullscreen = false;\n  camera?: EntityRef;\n  cameraMode: 'rts' | 'free' | 'follow' = 'rts';\n  decisionHistogramView: ClientRect = { left: 0, top: 0, width: 1, height: 1, right: 0, bottom: 0 };\n  sensesHistogramView: ClientRect = { left: 0, top: 0, width: 1, height: 1, right: 0, bottom: 0 };\n  showDecisionsHistogram = false;\n  showSensesHistogram = false;\n  showDecisionsViz = false;\n  renderGazes = false;\n\n  gameLoopStats = emptyGameLoopStats();\n\n  animationClips: {\n    [key: string]: AnimationClip\n  } = {};\n\n  movement = {\n    crippledSlowdown: 0.8,\n    uphillPunish: 3,\n  }\n\n  userControlEntity?: EntityRef;\n  userControlSet: { [key: string]: { component: GpuComponent, value: any } } = {};\n\n  abilities = new AbilitiesData();\n  showAbilitiesList = false;\n\n  rendererConfig = defaultRenderOptions();\n\n  renderArena = 0;\n  renderAllArenas = false;\n  roundStats = new RoundStats();\n\n  trainingConfig: TrainingConfig = {\n    weightsRenormalizationRate: 0,\n    elitismCount: 10,\n  };\n  unitBountiesEmpty = true;\n  arenaInfos: ArenaInfo[] = new Array(this.layout.arenas).fill(0).map(() => new ArenaInfo());\n  toSaveCreatureBrains: Array<{ id: string, brain: DbCreatureBrain }> = [];\n  // parentArenaIndices: number[] = [];\n  autoStartNextTrainingRound = true;\n  trainingStats = new TrainingStats();\n\n  showArenaList = false;\n  showBrainMemberIndex = -1;\n\n  homeHealthColor = rgb255ToVec3(rgbFromHex(HomeHealthColor));\n  awayHealthColor = rgb255ToVec3(rgbFromHex(AwayHealthColor));\n  manaColor = rgb255ToVec3(rgbFromHex(ManaColor));\n  aiCrowdLogo = false;\n\n  debugAudioEffectsPlaying: DebugAudioEffectPlaying[] = [];\n}\nexport function defaultGpuWorldStateData(initConfig?: InitWorldStateConfig): GpuWorldStateData {\n  return new GpuWorldStateData(initConfig);\n}\n","\nexport interface InitWorldStateConfig {\n  arenaCount: number;\n}\nexport function newInitWorldStateConfiguration(): InitWorldStateConfig {\n  return {\n    arenaCount: 1,\n  };\n}\n","import { GpuWorldState } from \"./State\";\nimport { objectSetKeys } from \"../Util\";\nimport { StepsPerSecond } from \"../Time\";\nimport { fract } from \"../Math/Math\";\n\n\nexport interface GameLoopStats {\n  stepsPerSecond: number;\n  msPerFrame: number;\n  runningTime: number;\n}\nexport function emptyGameLoopStats(): GameLoopStats {\n  return {\n    stepsPerSecond: 0,\n    msPerFrame: 0,\n    runningTime: 0\n  }\n}\n\nexport class GameLoop {\n  constructor(private state: GpuWorldState) {\n    state.gameLoop = this;\n    this.loopRunning = true;\n    requestAnimationFrame(this.loop);\n  }\n  public destroy() {\n    this.loopRunning = false;\n    this.state.setData({ simulationPaused: true });\n  }\n\n  private loopRunning = false;\n  private prevTime = window.performance.now();\n\n  private statsNFrames = 0;\n  private statsNSteps = 0;\n  private statsStepsStartTime = window.performance.now();\n  private statsFramesStartTime = window.performance.now();\n  private statsRunningTime = 0;\n\n  private tryDumpStats() {\n    const time = window.performance.now();\n    let stats = this.state.data.gameLoopStats;\n    const stepsDeltaTime = time - this.statsStepsStartTime;\n    if (stepsDeltaTime >= 1000 || this.statsNSteps >= 1000) {\n      stats = objectSetKeys(stats, {\n        stepsPerSecond: this.statsNSteps / (stepsDeltaTime / 1000),\n        runningTime: this.statsRunningTime\n      });\n      this.statsStepsStartTime = time;\n      this.statsNSteps = 0;\n    }\n    const framesDeltaTime = time - this.statsFramesStartTime;\n    if (framesDeltaTime >= 1000 || this.statsNFrames >= 400) {\n      stats = objectSetKeys(stats, {\n        msPerFrame: framesDeltaTime / this.statsNFrames,\n        runningTime: this.statsRunningTime\n      });\n      this.statsFramesStartTime = time;\n      this.statsNFrames = 0;\n    }\n    if (stats !== this.state.data.gameLoopStats) {\n      this.state.setData({\n        gameLoopStats: stats\n      });\n    }\n  }\n\n  private loop = () => {\n    if (!this.loopRunning) {\n      return;\n    }\n    requestAnimationFrame(this.loop);\n    const time = window.performance.now();\n    const delta = time - this.prevTime;\n    this.prevTime = time;\n\n    this.state.events.camera.dispatch({ type: 'Camera', delta });\n    if (this.state.derived.simulationRunning) {\n      const stepsStart = window.performance.now();\n      let substep = this.state.data.turboMode ? 100\n        : (this.state.data.substep + delta * this.state.data.simulationSpeed * StepsPerSecond / 1000);\n      while (substep > 1 && this.state.derived.simulationRunning && (window.performance.now() - stepsStart) < 100) {\n        this.state.events.step.dispatch();\n        this.statsNSteps++;\n        substep--;\n      }\n      if (substep > 1) {\n        substep = fract(substep);\n      }\n\n      this.statsRunningTime += delta;\n\n      this.state.setData({\n        substep,\n        ensureRenderNextLoop: false\n      });\n      if (this.state.data.renderWorld) {\n        this.state.events.render.dispatch();\n        this.statsNFrames++;\n      }\n    } else if (this.state.data.ensureRenderNextLoop) {\n      this.state.setData({\n        ensureRenderNextLoop: false\n      });\n      if (this.state.data.renderWorld) {\n        this.state.events.render.dispatch();\n        this.statsNFrames++;\n      }\n    }\n    this.tryDumpStats();\n  }\n\n  public step() {\n    if (!this.state.derived.simulationRunning) {\n      this.state.events.step.dispatch();\n      this.state.events.render.dispatch();\n    }\n  }\n\n}\n","import { GpuWorldState } from \"./State\";\nimport { vec2FromSize } from \"../Math/Math\";\nimport * as Vector3 from '../Math/Vector3';\nimport { mat4 } from \"gl-matrix\";\nimport { InvLocalToWorld } from \"./ECS/Transform\";\nimport { Camera } from \"./ECS/Camera\";\nimport { emptyTrainingSetup, defaultDbUserSettings } from \"db\";\nimport firebase from 'firebase/app';\n\n\nexport class GpuWorldStateDerived {\n  constructor(private state: GpuWorldState) {}\n  get worldSize() { return vec2FromSize(this.state.data.worldSize); }\n  get groundSize() { return vec2FromSize(this.state.data.groundSize); }\n\n  get cameraView(): mat4 {\n    return this.state.ecs.getComponentData(InvLocalToWorld.cpuComponent, this.state.data.camera!);\n  }\n  get cameraProjection(): mat4 {\n    return this.state.ecs.getComponentData(Camera.Projection, this.state.data.camera!);\n  }\n  get cameraProjectionView(): mat4 {\n    return this.state.ecs.getComponentData(Camera.ProjectionView, this.state.data.camera!);\n  }\n  get cameraInvProjectionView(): mat4 {\n    return this.state.ecs.getComponentData(Camera.InvProjectionView, this.state.data.camera!);\n  }\n\n  maxGroundHeight = 0;\n\n  // groundCell * generateGroundCellScaling gives us a vec2 in the range of KM\n  get generateGroundCellScaling() {\n    // const groundCell = ;\n    // const worldCoord = groundCell * (1 / groundSize);\n    // const worldPosM = worldCoord * worldSize;\n    // const worldPosKM = worldPosM / 1024;\n    // const worldPosKM = (worldCoord * worldSize) / 1024;\n    // const worldPosKM = groundCell * (1 / groundSize) * worldSize / 1024;\n    return (1 / this.groundSize.x) * this.worldSize.x / 1024;\n  }\n\n  get sunlightDirection() {\n    // const sun = this.state.data.modules.sun;\n    // if (!sun.enabled) {\n    //   return Vector3.normalize({ x: -1, y: -1, z: -1 });\n    // }\n    // const r = sunDirectionOnPlanet(sun.latitude, this.timeOfDayPercentage,\n    //   sun.planetAxialTilt, this.timeOfYearPercentage);\n    // return r.sunDirection;\n    // return Vector3.normalize({ x: 1, y: 1, z: 0.5 });\n    return Vector3.normalize(this.state.data.rendererConfig.lightDirection);\n  }\n  get renderLightDirection() {\n    return this.state.data.rendererConfig.lightDirection;\n    // return this.sunlightDirection.z > 0 ? this.sunlightDirection : Vector3.invert(this.sunlightDirection);\n  }\n\n  get simulationRunning() {\n    return !this.state.data.simulationPaused && !this.state.data.simulationEnded;\n  }\n\n  get userSettingsOrFallback() {\n    const userSettings = this.state.appState?.state.userSettings;\n    if (userSettings?.status === 'loaded') {\n      return userSettings.value;\n    } else {\n      return defaultDbUserSettings(firebase.firestore.Timestamp.now());\n    }\n  }\n  get trainingSetup() {\n    const userSettings = this.state.appState?.state.userSettings;\n    if (userSettings?.status === 'loaded') {\n      const index = this.state.data.gameInstance.type === 'train' ? this.state.data.gameInstance.setupIndex : 0;\n      return userSettings.value.trainingSetups[index] ?? emptyTrainingSetup();\n    } else {\n      return emptyTrainingSetup();\n    }\n  }\n}","export default __webpack_public_path__ + \"static/media/Image0000.e25d7315.exr\";","export default __webpack_public_path__ + \"static/media/Image0000.a88ec4c0.exr\";","export default __webpack_public_path__ + \"static/media/ArenaMap.67ee37db.glb\";","\nimport MapGlb from '../Models/ArenaMap.glb';\nimport { TransformParent } from './ECS/Transform';\nimport { ThreeModel } from '../GpuUtil/Model';\nimport { GpuWorldState } from './State';\n\n\nexport const MapModel = ThreeModel.fromPath(MapGlb);\n\nexport class GameMap {\n  constructor(private mapModel: ThreeModel) {\n  }\n\n  createEntities(state: GpuWorldState) {\n    this.mapModel.createInstances(state, {\n      beforeEntityCreated: (o, entityInit) => {\n        if (o.name.indexOf('Mushroom') === 0) {\n          // const p = new THREE.Vector3();\n          // o.getWorldPosition(p);\n          // for (let i=0; i < state.layout.arenas; i++) {\n          //   const ae = entityInit\n          //     .removeComponent(VisibilityFromComponent)\n          //     .removeComponent(TransformParent.component)\n          //     .removeComponent(CpuPositionComponent)\n          //     .setComponent(Rotation.component, [o.rotation.z])\n          //     .setComponent(Edible.component, [EdibleType.HealthEdible])\n          //     // .setComponent(Focusable.component, [1])\n          //     .setComponent(ArenaInstance.component, [i])\n          //     .setComponent(ArenaInstanceCpuComponent, { value: i })\n          //     .setComponent(LocalToWorld.gpuComponent);\n          //   state.ecs.createEntity(ae\n          //     .setComponent(Position.gpuComponent, [new Float32Array([p.x + Math.random() * 2, p.y, p.z, 0])])\n          //   );\n          //   state.ecs.createEntity(ae\n          //     .setComponent(Position.gpuComponent, [new Float32Array([p.y, p.x, p.z, 0])])\n          //   );\n          // }\n          return undefined;\n        } else {\n          return entityInit\n            .removeComponent(TransformParent.component); // Everything is pre-transformed\n        }\n      }\n    });\n  }\n}\n\nexport const MapInstance = MapModel.then(mapModel => new GameMap(mapModel));\n","import { RandomSeedable, EventDispatcher, arrayReplaceIndex, keysOfEnum } from '../Util';\nimport { sizeClosestPow2 } from '../Math/Math';\nimport { Texture, destroyTextures, DoubleBufferedTexture } from '../GpuUtil/Texture';\nimport { GpuWorldStateData, defaultGpuWorldStateData, TeamSettings } from './StateData';\nimport { InitWorldStateConfig } from './StateInit';\nimport { GpuWorldStateDerived } from './StateDerived';\nimport { Sampler } from '../GpuUtil/Program';\nimport { GlState, TextureFiltering } from '../GpuUtil/GlState';\nimport HeightmapExr from '../Models/ArenaHeightmap/Image0000.exr';\nimport NormalmapExr from '../Models/ArenaNormals/Image0000.exr';\nimport { GameMap, MapInstance } from './Map';\nimport { EntityComponentSystem, EntityInit } from '../GpuUtil/ECS';\nimport { EntitiesQuery } from '../GpuUtil/ECS/Query';\nimport { Unit, Creature, BountyComponents } from './ECS/UnitComponents';\nimport { Arena, ArenaInstance, ArenaMemberIndex } from './ECS/Components';\nimport { Image } from '../GpuUtil/Image';\nimport { ArenaMembersSize, BrainOutputsKeys, StepsInBattle, SideSize } from './StateLayout';\nimport { Sense } from './Brain/SensesDef';\nimport { UnitReplayChannelsSlices } from './Tools/Replay';\nimport { DecisionsVizHistory } from './Renderer/DecisionsViz';\nimport { GameLoop } from './GameLoop';\nimport { createCamera } from './ECS/Camera';\nimport { AppState } from '../SteamApp/AppState';\nimport { Store } from '../Components/Store';\nimport { AnimationTrackInterpolator } from './ECS/AnimationTrack';\n\nconst Heightmap = Image.fromEXRUrl(HeightmapExr);\nconst Normalmap = Image.fromEXRUrl(NormalmapExr);\n\nexport interface GpuWorldStateEventDataChanged {\n  type: 'DataChanged';\n  before: GpuWorldStateData;\n  after: GpuWorldStateData;\n  change: Partial<GpuWorldStateData>;\n}\nexport interface GpuWorldStateEventRoundEnd {\n  type: 'RoundEnd';\n  round: number;\n}\nexport interface GpuWorldStateEventCamera {\n  type: 'Camera';\n  delta: number;\n}\n\nexport class GpuWorldState {\n  constructor(public gls: GlState, public initConfig: InitWorldStateConfig, public gameMap?: GameMap,\n      public appState?: Store<AppState>, public ecs = new EntityComponentSystem(gls)) {\n    for (const k of Object.keys(this.textures)) {\n      this.textures[k].name = k;\n    }\n\n    if (this.gameMap) {\n      this.gameMap.createEntities(this);\n    }\n    for (let i=0; i < this.layout.arenas; i++) {\n      this.ecs.createEntities(new EntityInit()\n        .setComponents(Arena.components, new Float32Array([i])))\n    }\n    this.setData({\n      camera: createCamera(this)\n    });\n    if (appState) {\n      appState.onChange.attach(this.handleAppStateChange);\n    }\n\n    console.log(`[GpuWorldState] Map entities created`);\n  }\n  static async createWithMap(gls: GlState, initConfig: InitWorldStateConfig, appState?: Store<AppState>, ecs?: EntityComponentSystem) {\n    const state = new GpuWorldState(gls, initConfig, await MapInstance, appState, ecs);\n    const heightmap = await Heightmap;\n    const normalmap = await Normalmap;\n    state.textures.heightmap.loadImage(heightmap);\n    state.textures.normalmap.loadImage(normalmap);\n    return state;\n  }\n  get gl() { return this.gls.gl; }\n  destroyed = false;\n  destroy(destroyEcs = true) {\n    destroyTextures(this.textures);\n    if (destroyEcs) {\n      this.ecs.destroy();\n    }\n    this.unitsInArenaGpu.destroy();\n    this.textures = undefined as any;\n    for (const key of Object.keys(this.events)) {\n      this.events[key].listeners = [];\n    }\n    if (this.appState) {\n      this.appState.onChange.detach(this.handleAppStateChange);\n    }\n    this.destroyed = true;\n  }\n  handleAppStateChange = (appData: AppState, change: Partial<AppState>) => {\n    if (change.creatures) {\n      updateUnitBounties(this);\n    }\n  }\n\n  random = new RandomSeedable();\n\n  private currentData = defaultGpuWorldStateData(this.initConfig);\n  public get data() { return this.currentData }\n  public setData(newData: Partial<GpuWorldStateData>) {\n    const oldData = this.currentData;\n    this.currentData = {...this.currentData, ...newData};\n    this.events.dataChanged.dispatch({ type: 'DataChanged', before: oldData, after: this.currentData, change: newData });\n  }\n  events = {\n    dataChanged: new EventDispatcher<[GpuWorldStateEventDataChanged]>(),\n    step: new EventDispatcher(),\n    render: new EventDispatcher(),\n    camera: new EventDispatcher<[GpuWorldStateEventCamera]>(),\n    roundEnd: new EventDispatcher<[GpuWorldStateEventRoundEnd]>(),\n  };\n  gameLoop?: GameLoop;\n\n  public nextStep() {\n    return new Promise((resolve) => {\n      const listener = () => {\n        this.events.step.detach(listener);\n        resolve();\n      }\n      this.events.step.attach(listener);\n    })\n  }\n  public async nextStepIfRunning() {\n    if (this.derived.simulationRunning) {\n      await this.nextStep();\n    }\n  }\n\n  updateTeam(team: 'home' | 'away', value: Partial<TeamSettings>) {\n    this.setData({\n      teams: {\n        ...this.data.teams,\n        [team]: {\n          ...this.data.teams[team],\n          ...value\n        }\n      }\n    });\n  }\n  log(category: string, message: string | string[]) {\n    const index = this.data.log.length;\n    this.setData({ log: [...this.data.log, {\n      time: new Date(),\n      step: this.data.stepCounter,\n      category,\n      message: typeof message === 'string' ? [message] : message }\n    ] });\n    return index;\n  }\n  updateLogPart(index: number, part: number, message: string) {\n    const newLog = [...this.data.log];\n    newLog[index] = {\n      time: new Date(),\n      step: newLog[index].step,\n      category: newLog[index].category,\n      message: arrayReplaceIndex(newLog[index].message, part, message)\n    }\n    this.setData({ log: newLog });\n  }\n\n  public get worldSize() {\n    return this.layout.worldSize;\n  }\n  worldPow2Size = sizeClosestPow2(this.layout.worldSize);\n\n  get layout() {\n    return this.data.layout;\n  }\n\n  derived = new GpuWorldStateDerived(this);\n\n  ensureRendered() {\n    if (!this.data.ensureRenderNextLoop) {\n      this.setData({ ensureRenderNextLoop: true });\n    }\n  }\n\n  textures = {\n    heightmap: new Texture(this.gls, this.gl.RGBA32F).init(),\n    normalmap: new Texture(this.gls, this.gl.RGBA32F).init(),\n    // curiosity: DoubleBufferedTexture.create(this.gls, this.gl.RGBA32F, { width: this.layout.arenas, height: CuriosityHistory }, CuriosityDepth).init(),\n    sensesHistogram: new Texture(this.gls, this.gl.RGBA32F, { width: ArenaMembersSize, height: keysOfEnum(Sense).length }, 8).init(),\n    decisionsHistogram: new Texture(this.gls, this.gl.RGBA32F, { width: ArenaMembersSize, height: BrainOutputsKeys.length }, 8).init(),\n    unitsReplay: DoubleBufferedTexture.create(this.gls, this.gl.RGBA32F, { width: StepsInBattle, height: ArenaMembersSize }, UnitReplayChannelsSlices).init(),\n    decisionsViz: DoubleBufferedTexture.create(this.gls, this.gl.R32F, { width: DecisionsVizHistory, height: ArenaMembersSize * BrainOutputsKeys.length }).init(),\n  };\n\n  samplers = {\n    heightmap: {\n      linear: new Sampler(this.textures.heightmap, TextureFiltering.Linear)\n    },\n  };\n\n  // Indices\n  unitsInArena = new EntitiesQuery(\n    [ArenaInstance.cpuComponent, ArenaMemberIndex.cpuComponent, Unit.component])\n    .lookupTable(ArenaMembersSize, (state, entityCell) => {\n      const arenaIndex = state.ecs.getComponentData(ArenaInstance.cpuComponent, entityCell)[0];\n      const arenaMemberIndex = state.ecs.getComponentData(ArenaMemberIndex.cpuComponent, entityCell)[0];\n      return { row: arenaIndex, column: arenaMemberIndex };\n    });\n  unitsInArenaGpu = this.unitsInArena.toGpu(this.gls);\n\n  animationInterpolators: { [key: string]: AnimationTrackInterpolator } = {};\n}\n\nexport function updateUnitBounties(worldState: GpuWorldState) {\n  const creatures = worldState.appState?.state.creatures;\n  let empty = true;\n  for (let i=0; i < SideSize * 2; i++) {\n    const unit = i < SideSize ? worldState.data.teams.home.units[i] : worldState.data.teams.away.units[i - SideSize];\n    const units = new EntitiesQuery([Creature.component])\n      .filterValue(ArenaMemberIndex.cpuComponent, v => v[0] === i, () => [])\n      .get(worldState);\n    if (unit && unit.type === 'creature' && creatures && creatures.status === 'loaded') {\n      const c = creatures.values.find(x => x.id === unit.id);\n      if (c && c.bounties) {\n        for (const key of Object.keys(c.bounties)) {\n          for (const unit of units) {\n            worldState.ecs.setComponentData(BountyComponents[key].component, unit, [c.bounties?.[key] ?? 0]);\n          }\n          empty = false;\n        }\n      }\n    }\n  }\n  worldState.setData({\n    unitBountiesEmpty: empty\n  })\n}\n","\nexport class JobQueue {\n  private queue: Array<() => Promise<void>> = [];\n  private running = false;\n  private async processNextJob() {\n    const nextJob = this.queue.shift();\n    if (!nextJob) {\n      this.running = false;\n      return;\n    }\n    await nextJob();\n    this.processNextJob();\n  }\n  runJob<T>(job: () => Promise<T>): Promise<T> {\n    return new Promise(resolve => {\n      this.queue.push(async () => {\n        const res = await job();\n        resolve(res);\n      });\n      if (!this.running) {\n        this.running = true;\n        this.processNextJob();\n      }\n    });\n  }\n}","export default __webpack_public_path__ + \"static/media/UnitMarker.9ab9cf37.glb\";","import { GpuWorldState } from \"./State\";\nimport { EntityInit, EntitiesRange } from \"../GpuUtil/ECS\";\nimport { RotationZ, OffsetLocalToWorld, LocalToWorld, Position, TransformParent, LocalToParentOrderComponents, LocalToParent } from \"./ECS/Transform\";\nimport { Unit, Hitpoints, Mana, ManaRegenComponent, HitpointsRegenComponent, Creature, Team, TailAttachment, HandLeftAttachment, HandRightAttachment, CpuTeamComponent, CpuPlayerUnitComponent, MaxHitpoints, MaxMana, HeadAttachment, BackAttachment, HitpointsTrailing, ProjectileAttachment, WorthPoints, PlayerUnit, AnimatableUnitComponent, UnitMovement, UnitMovementSpeed, UnitRotationSpeed, UnitSoundMaterialComponent, Focuser, Focusable, UnitSoundsComponent, PreviousHitpoints, DiedStep, Velocity, IsOnGround, Force, WalkingSpeed, Gold, PreviousGold, UnitStats, DuckAI, CrabAI, Stuck, LastPushedBy, IsTakingFallDamage, BountyComponents, ModelCreatedComponent, GymIndex } from \"./ECS/UnitComponents\";\nimport { Dazeable } from \"./Buffs/Daze\";\nimport { IronBubbable, HeliumBubbable } from \"./Buffs/Bubbles\";\nimport { ThreeModel } from \"../GpuUtil/Model\";\nimport * as Mat4 from '../Math/Mat4';\nimport { Teams, UnitAnimations, TeamPoints, StatuePoints } from \"./StateLayout\";\nimport { UnitAbilities, Abilities, createAbility } from \"./Abilities/Abilities\";\nimport { Casting } from \"./Abilities/Abilities\";\nimport { Items, AttachmentItem, BountyDefs, UnitBounties } from \"db\";\nimport { AnimationControllerComponent, AnimationBinderComponent } from \"./ECS/Animation\";\nimport { EventDispatcher, rgba255ToVec401, rgbFromHex, SimpleProfiler } from \"../Util\";\nimport UnitMarkerGlb from '../Models/UnitMarker.glb';\nimport { HiddenLayer, OutputLayer, Senses, MemoryLayer, GymExtraSenses } from \"./Brain/Components\";\nimport { ArenaInstance, ArenaMemberIndex, VisibleComponent } from \"./ECS/Components\";\nimport firebase from 'firebase/app';\nimport { UnitDef } from \"./UnitDef\";\nimport { DecisionsCMs } from \"./Brain/Decisions\";\nimport { Crippleable } from \"./Buffs/Cripple\";\nimport { MutationRate, CopyMutateParent } from \"./Tools/CopyAndMutate\";\n\nconst UnitMarkerModel = ThreeModel.fromPath(UnitMarkerGlb);\n\nexport class CreatePlayerUnitOptions {\n  createAbilities = true;\n  createBrain = false;\n  bounties?: Partial<UnitBounties>;\n  profiler?: SimpleProfiler;\n}\n\nconst emptyBounties = BountyDefs.reduce((p, x) => ({...p, [x.key]: x.emptyValue}), {});\n\nfunction getAbilityForItem(item: string | undefined): Abilities {\n  if (item) {\n    const it = Items[item] as AttachmentItem;\n    return Abilities[it.ability] ?? Abilities.None;\n  }\n  return Abilities.None;\n}\nfunction getWeights(weights: number[] | firebase.firestore.Blob) {\n  if (!Array.isArray(weights)) {\n    return new Float32Array(weights.toUint8Array().buffer);\n  } else {\n    return new Float32Array(weights);\n  }\n}\n\nexport interface CreateUnitDef<U extends UnitDef = UnitDef> {\n  unit: U;\n  arenaIndex?: number;\n  arenaMemberIndex?: number;\n  team?: Teams;\n  gymIndex?: [number, number];\n  uploadBrain?: boolean;\n}\n\nexport async function createPlayerUnits(state: GpuWorldState, units: CreateUnitDef[], opts: CreatePlayerUnitOptions = new CreatePlayerUnitOptions()) {\n  const unitType = units[0].unit.type;\n  opts.profiler?.enter(`createUnits(${unitType}, ${units.length})`);\n  const count = units.length;\n\n  let entityInit = new EntityInit()\n    // Static\n    .setComponent(CpuPlayerUnitComponent, { unit: units[0].unit })\n    .setComponent(Unit.component)\n    .setComponents(ArenaInstance.components)\n    .setComponents(ArenaMemberIndex.components)\n    .setComponent(AnimatableUnitComponent, { stepLength: 2.1 })\n    .setComponent(ManaRegenComponent)\n    .setComponent(HitpointsRegenComponent)\n    .setComponent(Team.component)\n    .setComponent(CpuTeamComponent, Teams.HomeTeam)\n    .setComponent(UnitMovement.component)\n    .setComponent(UnitMovementSpeed.component, [12])\n    .setComponent(UnitRotationSpeed.component, [0.15])\n    .setComponent(UnitSoundMaterialComponent, { value: 'flesh' })\n    .setComponent(WorthPoints.component)\n\n    // Model stuff. These are \"filled in\" in CreateUnitModel.ts\n    .setComponent(LocalToWorld.gpuComponent)\n    .setComponent(AnimationBinderComponent, { entityLookup: {}, clipNames: {} })\n    .setComponent(AnimationControllerComponent, {\n      actions: [{\n        clip: UnitAnimations[UnitAnimations.Idle1],\n        positionType: 'startTime',\n        positionValue: 0,\n        looping: true\n      }]\n    })\n    .setComponent(VisibleComponent, false)\n    .setComponent(ModelCreatedComponent, false)\n\n    // Reset every round\n    .setComponent(Position.gpuComponent, [new Float32Array([0, 0, 0, 0])])\n    .setComponent(RotationZ.component, [0])\n    .setComponent(Focuser.component, [-1, -1])\n    .setComponent(Focusable.component, [1])\n    .setComponent(UnitSoundsComponent, { playing: {} })\n    .setComponent(Hitpoints.component, [MaxHitpoints])\n    .setComponent(Mana.component, [MaxMana])\n    .setComponent(HitpointsTrailing.component, [MaxHitpoints])\n    .setComponent(PreviousHitpoints.component, [MaxHitpoints])\n    .setComponent(DiedStep.component, [-1])\n    .setComponent(LastPushedBy.component, [-1, -1])\n    .setComponent(IsTakingFallDamage.component)\n    .setComponent(Dazeable.component)\n    .setComponent(IronBubbable.component)\n    .setComponent(HeliumBubbable.component)\n    .setComponent(Crippleable.component)\n    .setComponent(Velocity.component, [new Float32Array([0, 0, 0, 0])])\n    .setComponent(IsOnGround.component, [new Float32Array([1, 0, 0, 0])])\n    .setComponent(Force.component, [new Float32Array([0, 0, 0, 0])])\n    .setComponent(Stuck.component)\n    .setComponent(WalkingSpeed.component)\n    .setComponent(Gold.component)\n    .setComponent(PreviousGold.component)\n\n  for (const decision of DecisionsCMs) {\n    entityInit = entityInit.setComponent(decision.component);\n  }\n  for (const key of Object.keys(UnitStats)) {\n    entityInit = entityInit.setComponent(UnitStats[key].component);\n  }\n  for (const key of Object.keys(Casting)) {\n    entityInit = entityInit.setComponent(Casting[key].component);\n  }\n\n  const onUnitsCreated = new EventDispatcher<[EntitiesRange]>();\n  let entities: EntitiesRange;\n\n  switch (unitType) {\n    case 'creature': {\n\n      entityInit = entityInit\n        // Static\n        .setComponent(Creature.component)\n        .setComponent(PlayerUnit.component)\n        .setComponent(GymIndex.component)\n\n        .setComponent(UnitAbilities.component)\n        .setComponent(WalkingSpeed.component)\n        .setComponent(Senses.component)\n\n      if (state.data.gameInstance.type === 'gym') {\n        entityInit = entityInit.setComponent(GymExtraSenses.component);\n      }\n\n      if (opts.createBrain) {\n        // Weights & brain\n        entityInit = entityInit.setComponent(CopyMutateParent.component)\n          .setComponent(MutationRate.component)\n          .setComponent(HiddenLayer.weights.component)\n          .setComponent(HiddenLayer.biases.component)\n          .setComponent(HiddenLayer.res.component)\n          .setComponent(MemoryLayer.weights.component)\n          .setComponent(MemoryLayer.biases.component)\n          .setComponent(MemoryLayer.res.component)\n          .setComponent(OutputLayer.weights.component)\n          .setComponent(OutputLayer.biases.component)\n          .setComponent(OutputLayer.res.component);\n      }\n\n      for (const key of Object.keys(BountyComponents)) {\n        entityInit = entityInit.setComponent(BountyComponents[key].component, [opts.bounties?.[key] ?? emptyBounties[key]]);\n      }\n\n      entities = state.ecs.createEntities(entityInit\n        .setComponent(OffsetLocalToWorld.component, Mat4.toRows(Mat4.mul(\n          Mat4.rotationZ(Math.PI / 2)\n        )))\n        .setComponent(TailAttachment.component)\n        .setComponent(BackAttachment.component)\n        .setComponent(HeadAttachment.component)\n        .setComponent(HandLeftAttachment.component)\n        .setComponent(HandRightAttachment.component)\n        .setComponent(ProjectileAttachment.component),\n        count);\n\n\n      const brainComps = [\n        HiddenLayer.weights.component,\n        HiddenLayer.biases.component,\n        MemoryLayer.weights.component,\n        MemoryLayer.biases.component,\n        OutputLayer.weights.component,\n        OutputLayer.biases.component,\n      ]\n      for (let i=0; i < units.length; i++) {\n        const creature = units[i].unit;\n        if (creature.type !== 'creature') {\n          throw new Error('All units in batch need to be of the same type');\n        }\n        if (units[i].uploadBrain) {\n          const weights = [\n            creature.brain?.hiddenLayerWeights,\n            creature.brain?.hiddenLayerBiases,\n            creature.brain?.memoryLayerWeights,\n            creature.brain?.memoryLayerBiases,\n            creature.brain?.outputLayerWeights,\n            creature.brain?.outputLayerBiases,\n          ]\n          for (let l = 0; l < brainComps.length; l++) {\n            if (weights[l]) {\n              state.ecs.setComponentData(brainComps[l], entities.getIndex(i), getWeights(weights[l]));\n            }\n          }\n        }\n      }\n\n      if (opts.createAbilities) {\n        opts.profiler?.enter('createAbilities');\n        for (let i=0; i < units.length; i++) {\n          const creature = units[i].unit;\n          if (creature.type !== 'creature') {\n            throw new Error('All units in batch need to be of the same type');\n          }\n          const abilities = new Array(3).fill(0).map((_, i) => getAbilityForItem(creature.slots![i]));\n          state.ecs.setComponentData(UnitAbilities.component, entities.getIndex(i), abilities);\n          for (let slotIndex=0; slotIndex < 3; slotIndex++) {\n            if (creature.slots![slotIndex] && abilities[slotIndex] !== Abilities.None) {\n              const item = Items[creature.slots![slotIndex]];\n              if (item) {\n                await createAbility(state, entities.getIndex(i), units[i].arenaIndex ?? 0, abilities[slotIndex],\n                  onUnitsCreated.transform(entities => [entities.getIndex(i)]));\n              }\n            }\n          }\n        }\n        opts.profiler?.exit();\n      }\n      opts.profiler?.enter('setBounties');\n      for (let i=0; i < units.length; i++) {\n        state.ecs.setComponentData(GymIndex.component, entities.getIndex(i), units[i].gymIndex ?? [-1, -1]);\n        const creature = units[i].unit;\n        if (creature.type !== 'creature') {\n          throw new Error('All units in batch need to be of the same type');\n        }\n        const bounties = creature.bounties;\n        if (bounties) {\n          for (const key of Object.keys(bounties)) {\n            state.ecs.setComponentData(BountyComponents[key].component, entities.getIndex(i), [bounties[key]]);\n          }\n        }\n      }\n      opts.profiler?.exit();\n\n      break;\n    }\n    case 'statue': {\n      entityInit = entityInit\n        .setComponent(OffsetLocalToWorld.component, Mat4.toRows(Mat4.mul(\n          Mat4.rotationZ(Math.PI / 2)\n        )))\n        .removeComponent(WalkingSpeed.component)\n        .removeComponent(Focuser.component)\n        .removeComponent(Velocity.component)\n        .removeComponent(UnitMovement.component)\n        .removeComponent(Gold.component)\n        .removeComponent(PreviousGold.component)\n        .setComponent(UnitSoundMaterialComponent, { value: 'statue' });\n\n      for (const key of Object.keys(Casting)) {\n        entityInit = entityInit.removeComponent(Casting[key].component);\n      }\n      entities = state.ecs.createEntities(entityInit, count);\n      break;\n    }\n    default: {\n      entityInit = entityInit\n        .setComponent(PlayerUnit.component);\n\n      if (unitType === 'scarecrow') {\n        entityInit = entityInit\n          .removeComponent(WalkingSpeed.component)\n          .removeComponent(Focuser.component)\n          .removeComponent(Velocity.component)\n          .removeComponent(UnitMovement.component)\n          .setComponent(UnitSoundMaterialComponent, { value: 'wood' });\n\n        for (const key of Object.keys(Casting)) {\n          entityInit = entityInit.removeComponent(Casting[key].component);\n        }\n      } else {\n        entityInit = entityInit\n          .setComponent(OffsetLocalToWorld.component, Mat4.toRows(Mat4.mul(\n            Mat4.rotationZ(Math.PI / 2)\n          )));\n        if (unitType === 'duck') {\n          entityInit = entityInit.setComponent(DuckAI.component);\n        } else if (unitType === 'turtle') {\n          entityInit = entityInit\n            .setComponent(CrabAI.component)\n            .setComponent(UnitAbilities.component, [Abilities.Pistol, Abilities.None, Abilities.None])\n            .setComponent(AnimatableUnitComponent, { stepLength: 0.7 })\n            .setComponent(UnitMovementSpeed.component, [1.5])\n            .setComponent(UnitRotationSpeed.component, [0.03]);\n        } else {\n          entityInit = entityInit\n            .setComponent(CrabAI.component)\n            .setComponent(UnitAbilities.component, [Abilities.Talons, Abilities.None, Abilities.None])\n            .setComponent(UnitRotationSpeed.component, [0.07]);\n        }\n      }\n      entities = state.ecs.createEntities(entityInit\n        .setComponent(ProjectileAttachment.component), count);\n      if (unitType === 'turtle') {\n        for (let i=0; i < units.length; i++) {\n          await createAbility(state, entities.getIndex(i), units[i].arenaIndex ?? 0, Abilities.Pistol, onUnitsCreated.transform(entities => [entities.getIndex(i)]));\n        }\n      } else if (unitType === 'crab') {\n        for (let i=0; i < units.length; i++) {\n          await createAbility(state, entities.getIndex(i), units[i].arenaIndex ?? 0, Abilities.Talons, onUnitsCreated.transform(entities => [entities.getIndex(i)]));\n        }\n      }\n    }\n  }\n  opts.profiler?.enter('setProps');\n  for (let i=0; i < count; i++) {\n    state.ecs.setComponentData(CpuPlayerUnitComponent, entities.getIndex(i), { unit: units[i].unit });\n    state.ecs.setComponentsData(ArenaInstance.components, entities.getIndex(i), new Float32Array([units[i].arenaIndex ?? 0]));\n    state.ecs.setComponentsData(ArenaMemberIndex.components, entities.getIndex(i), new Float32Array([units[i].arenaMemberIndex ?? 0]));\n    const team = units[i].team ?? Teams.HomeTeam;\n    state.ecs.setComponentData(Team.component, entities.getIndex(i), [team]);\n    state.ecs.setComponentData(CpuTeamComponent, entities.getIndex(i), team);\n    const sideUnitCount = team === Teams.HomeTeam ? state.data.teams.home.unitCount : state.data.teams.away.unitCount;\n    state.ecs.setComponentData(WorthPoints.component, entities.getIndex(i), [unitType === 'statue' ? StatuePoints : (TeamPoints / (sideUnitCount - 1))])\n  }\n  opts.profiler?.exit();\n\n  opts.profiler?.enter('createUnitMarker');\n  const unitMarker = await UnitMarkerModel;\n  opts.profiler?.enter('createModels');\n  const unitMarkers = unitMarker.createInstances(state, {\n    count,\n    rootEntityInit: new EntityInit()\n      .setComponent(LocalToParent.component, Mat4.toRows(Mat4.identity()))\n      .setComponent(TransformParent.component)\n      .setComponent(LocalToParentOrderComponents[0])\n      .setComponents(ArenaInstance.components, new Float32Array([-1])),\n    localToParentStartOrder: 1,\n    onMaterial: (mat, index) => {\n      const a = 0.4;\n      const unit = units[index].unit;\n      if (mat.name === 'UnitMaterial') {\n        return rgba255ToVec401(unit.type === 'creature' ?\n          {...rgbFromHex(unit.primaryColor!), a }\n          : unit.type === 'duck' ? { r: 255, g: 255, b: 255, a }\n          : unit.type === 'crab' ? { r: 255, g: 0, b: 0, a }\n          : unit.type === 'turtle' ? { r: 0, g: 255, b: 0, a }\n          : unit.type === 'scarecrow' ? { r: 217, g: 203, b: 98, a }\n          : unit.type === 'statue' ? { r: 200, g: 200, b: 200, a }\n          : { r: 0, g: 0, b: 0, a })\n      } else {\n        return units[index].team === Teams.HomeTeam ? { x: 90/255, y: 110/255, z: 83/255, w: a }\n          : { x: 163/255, y: 84/255, z: 73/255, w: a };\n      }\n    }\n  });\n  opts.profiler?.exit();\n  opts.profiler?.enter('setTransformParent');\n  for (let i=0; i < count; i++) {\n    const entityCell = entities.getIndex(i);\n    state.ecs.setComponentData(TransformParent.component, unitMarkers.roots.getIndex(i), [{ ...entityCell, z: 0, w: 0 }]);\n  }\n  opts.profiler?.exit();\n  opts.profiler?.exit();\n\n  onUnitsCreated.dispatch(entities);\n  opts.profiler?.exit();\n  return entities;\n}\n","export default __webpack_public_path__ + \"static/media/PlayerUnit.7dc5de54.glb\";","export default __webpack_public_path__ + \"static/media/Scarecrow.32a50840.glb\";","export default __webpack_public_path__ + \"static/media/Duck.1df0709b.glb\";","export default __webpack_public_path__ + \"static/media/Crab.5939a931.glb\";","export default __webpack_public_path__ + \"static/media/Turtle.445eabc4.glb\";","export default __webpack_public_path__ + \"static/media/Statue.69f42e25.glb\";","\nimport PlayerUnitGlb from '../Models/PlayerUnit.glb';\nimport ScarecrowGlb from '../Models/Scarecrow.glb';\nimport DuckGlb from '../Models/Duck.glb';\nimport CrabGlb from '../Models/Crab.glb';\nimport TurtleGlb from '../Models/Turtle.glb';\nimport StatueGlb from '../Models/Statue.glb';\nimport { ThreeModel } from '../GpuUtil/Model';\nimport { EntityRef } from './StateData';\nimport { GpuWorldState } from './State';\nimport { CpuPlayerUnitComponent, TailAttachment, BackAttachment, HeadAttachment, HandLeftAttachment, HandRightAttachment, ProjectileAttachment, ModelCreatedComponent } from './ECS/UnitComponents';\nimport { GpuComponent, EntitiesRange } from '../GpuUtil/ECS';\nimport { rgb255ToVec401, Lazy, rgbFromHex } from '../Util';\nimport { UnitDef } from './UnitDef';\nimport { createImpactEffects } from './ECS/DamageCalc';\n\nconst PlayerUnitModel = new Lazy(() => ThreeModel.fromPath(PlayerUnitGlb));\nconst ScarecrowModel = new Lazy(() => ThreeModel.fromPath(ScarecrowGlb));\nconst DuckModel = new Lazy(() => ThreeModel.fromPath(DuckGlb));\nconst CrabModel = new Lazy(() => ThreeModel.fromPath(CrabGlb));\nconst TurtleModel = new Lazy(() => ThreeModel.fromPath(TurtleGlb));\nconst StatueModel = new Lazy(() => ThreeModel.fromPath(StatueGlb));\n\nexport async function createUnitModelsForArena(state: GpuWorldState, arenaIndex: number) {\n  const unitsInArena = state.unitsInArena.get(state);\n  for (const unit of unitsInArena.rows[arenaIndex].entities) {\n    if (unit.x >= 0) {\n      await createUnitModel(state, unit);\n    }\n  }\n}\n\nasync function getUnitModel(unit: UnitDef) {\n  switch (unit.type) {\n    case 'creature': return await PlayerUnitModel.value;\n    case 'statue': return await StatueModel.value;\n    case 'scarecrow': return await ScarecrowModel.value;\n    case 'crab': return await CrabModel.value;\n    case 'duck': return await DuckModel.value;\n    case 'turtle': return await TurtleModel.value;\n  }\n}\n\nexport async function createUnitModel(state: GpuWorldState, entityCell: EntityRef) {\n\n  const unit = state.ecs.getComponentData(CpuPlayerUnitComponent, entityCell)!.unit;\n  const model = await getUnitModel(unit);\n  const modelCreated = state.ecs.getComponentData(ModelCreatedComponent, entityCell);\n  if (modelCreated) {\n    return model;\n  }\n  state.ecs.setComponentData(ModelCreatedComponent, entityCell, true);\n  await createImpactEffects(state, EntitiesRange.fromEntity(entityCell));\n  if (unit.type === 'creature') {\n    const attachmentPoints: [GpuComponent<'float'>, number[]][] = [];\n    model.createInstances(state, {\n      rootEntities: EntitiesRange.fromEntity(entityCell),\n      beforeEntityCreated: (o, entityInit) => {\n        if (o.name.indexOf('Item') === 0) {\n          if (o.name.indexOf(`Item${unit.slots![0]}`) === 0 ||\n            o.name.indexOf(`Item${unit.slots![1]}`) === 0 ||\n            o.name.indexOf(`Item${unit.slots![2]}`) === 0) {\n            return entityInit;\n          } else {\n            return undefined;\n          }\n        } else if (o.name.indexOf('StyleEars') === 0) {\n          if (o.name.indexOf(`StyleEars00${unit.ears}`) === 0) {\n            return entityInit;\n          } else {\n            return undefined;\n          }\n        } else if (o.name.indexOf('StyleEyes') === 0) {\n          if (o.name.indexOf(`StyleEyes00${unit.eyes}`) === 0) {\n            return entityInit;\n          } else {\n            return undefined;\n          }\n        } else if (o.name.indexOf('StyleBackSpikes') === 0) {\n          if (o.name.indexOf(`StyleBackSpikes00${unit.backSpikes}`) === 0) {\n            return entityInit;\n          } else {\n            return undefined;\n          }\n        } else {\n          return entityInit;\n        }\n      },\n      afterEntityCreated: (o, entities) => {\n        const entityCell = entities.getIndex(0);\n        if (o.name === 'TailEnd') {\n          attachmentPoints.push([TailAttachment.component, [entityCell.x, entityCell.y]]);\n        } else if (o.name === 'Back') {\n          attachmentPoints.push([BackAttachment.component, [entityCell.x, entityCell.y]]);\n        } else if (o.name === 'Head') {\n          attachmentPoints.push([HeadAttachment.component, [entityCell.x, entityCell.y]]);\n        } else if (o.name === 'HandL') {\n          attachmentPoints.push([HandLeftAttachment.component, [entityCell.x, entityCell.y]]);\n        } else if (o.name === 'HandR') {\n          attachmentPoints.push([HandRightAttachment.component, [entityCell.x, entityCell.y]]);\n        } else if (o.name === 'ProjectileAttachment') {\n          attachmentPoints.push([ProjectileAttachment.component, [entityCell.x, entityCell.y]]);\n        }\n      },\n      onMaterial: mat => {\n        if (mat.name === 'Primary') {\n          return rgb255ToVec401(rgbFromHex(unit.primaryColor!));\n        } else if (mat.name === 'Secondary') {\n          return rgb255ToVec401(rgbFromHex(unit.secondaryColor!));\n        } else {\n          return undefined;\n        }\n      },\n      visible: false,\n    });\n    for (const [comp, val] of attachmentPoints) {\n      state.ecs.setComponentData(comp, entityCell, val);\n    }\n    return model;\n  } else if (unit.type === 'statue') {\n    model.createInstances(state, { rootEntities: EntitiesRange.fromEntity(entityCell), visible: false });\n    return model;\n  } else {\n    const attachmentPoints: [GpuComponent<'float'>, number[]][] = [];\n    model.createInstances(state, {\n      rootEntities: EntitiesRange.fromEntity(entityCell),\n      afterEntityCreated: (o, entities) => {\n        const entityCell = entities.getIndex(0);\n        if (o.name === 'ProjectileAttachment') {\n          attachmentPoints.push([ProjectileAttachment.component, [entityCell.x, entityCell.y]]);\n        }\n      },\n      visible: false,\n    });\n    for (const [comp, val] of attachmentPoints) {\n      state.ecs.setComponentData(comp, entityCell, val);\n    }\n    return model;\n  }\n}","import { GpuWorldState } from \"../State\";\nimport { GpuWorldRenderer, setCanvasSizeToElementSize } from \".\";\nimport { initGlExtensions } from \"../../GpuUtil\";\nimport { JobQueue } from \"../../JobQueue\";\nimport { defaultRenderOptions } from \"./Configuration\";\nimport { Size } from \"../../Math/Math\";\nimport { GlState } from \"../../GpuUtil/GlState\";\nimport { createPlayerUnits, CreatePlayerUnitOptions } from \"../CreateUnit\";\nimport { UnitDef } from \"../UnitDef\";\nimport { createUnitModel } from \"../CreateUnitModel\";\n\nexport class PortraitRenderer {\n  private constructor(public canvas: HTMLCanvasElement, private gl: WebGL2RenderingContext) {\n    this.state.setData({\n      rendererConfig: {\n        ...defaultRenderOptions(),\n        skybox: false,\n        overheadBars: false,\n        clearColor: { r: 0, g: 0, b: 0, a: 0 },\n      },\n      renderArena: 0,\n    });\n  }\n  static create(canvas = document.createElement('canvas'), options: WebGLContextAttributes = { desynchronized: true }) {\n    const gl = canvas.getContext('webgl2', options) as any as WebGL2RenderingContext;\n    if (gl) {\n      if (initGlExtensions(gl).length === 0) {\n        return new PortraitRenderer(canvas, gl);\n      }\n    }\n    return undefined;\n  }\n  private loopRunning = false;\n  startRenderLoop() {\n    this.loopRunning = true;\n    this.renderLoop();\n  }\n  stopRenderLoop() {\n    this.loopRunning = false;\n    this.renderLoop();\n  }\n  private renderLoop = () => {\n    if (!this.loopRunning) {\n      return;\n    }\n    window.requestAnimationFrame(this.renderLoop);\n    this.state.setData({ stepCounter: this.state.data.stepCounter + 1 });\n    setCanvasSizeToElementSize(this.state);\n    this.renderer.render(this.state);\n  }\n\n  private gls = new GlState(this.canvas, this.gl);\n  state = new GpuWorldState(this.gls, { arenaCount: 1, });\n\n  private renderer = new GpuWorldRenderer(this.gls);\n\n  private async renderOnce(canvasSize: Size = { width: 480, height: 480 }) {\n    this.canvas.width = canvasSize.width;\n    this.canvas.height = canvasSize.height;\n    this.state.setData({\n      canvasRect: {\n        left: 0,\n        top: 0,\n        bottom: 0,\n        right: 0,\n        width: this.canvas.width,\n        height: this.canvas.height\n      }\n    });\n    this.renderer.render(this.state);\n  }\n\n  async setUnit(unit: UnitDef) {\n    this.state.ecs.removeAllEntities();\n    const res = await createPlayerUnits(this.state, [{ unit }], {...new CreatePlayerUnitOptions(), createAbilities: false});\n    const model = await createUnitModel(this.state, res.getIndex(0));\n    this.state.setData({ camera: model.createCamera(this.state) });\n    return res.getIndex(0);\n  }\n\n  private jobQueue = new JobQueue();\n  private dataUrlCache: { [key: string]: Promise<string> } = {};\n\n  renderToDataURL(unit: UnitDef, canvasSize?: Size) {\n    const key = JSON.stringify({ unit, canvasSize });\n    if (this.dataUrlCache[key]) {\n      return this.dataUrlCache[key];\n    }\n    return this.dataUrlCache[key] = this.jobQueue.runJob(async () => {\n      await this.setUnit(unit);\n      await this.renderOnce(canvasSize);\n      this.gl.finish();\n      return this.canvas.toDataURL();\n    });\n  }\n  renderToBlob(unit: UnitDef, canvasSize?: Size) {\n    return this.jobQueue.runJob(async () => {\n      await this.setUnit(unit);\n      await this.renderOnce(canvasSize);\n      this.gl.finish();\n      return await new Promise<Blob>(resolve2 => this.canvas.toBlob(blob => resolve2(blob!)));\n    });\n  }\n  async renderToCanvas(canvas: HTMLCanvasElement, unit: UnitDef, canvasSize?: Size) {\n    await this.setUnit(unit);\n    await this.renderOnce(canvasSize);\n    this.gl.finish();\n    const ctx = canvas.getContext('2d')!;\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.drawImage(this.canvas, 0, 0);\n  }\n}\n","import { PortraitRenderer } from \"./PortraitRenderer\";\n\nexport const DefaultPortraitRenderer = PortraitRenderer.create();\n","import React from \"react\";\nimport './index.css';\nimport { PortraitRenderer } from \"../../GpuWorld/Renderer/PortraitRenderer\";\nimport { DefaultPortraitRenderer } from \"../../GpuWorld/Renderer/DefaultPortraitRenderer\";\nimport LoadingPortraitPNG from '../../Images/LoadingPortrait.png';\nimport { UnitDef } from \"../../GpuWorld/UnitDef\";\n\ninterface CreaturePortraitProps {\n  unit: UnitDef;\n  fallbackPortrait?: string;\n  renderer?: PortraitRenderer;\n}\nexport class CreaturePortrait extends React.Component<CreaturePortraitProps> {\n  state: { img?: string } = {};\n  imgRef = React.createRef<HTMLImageElement>();\n  componentDidMount() {\n    this.renderPortrait();\n  }\n  componentDidUpdate(prevProps: CreaturePortraitProps) {\n    if (this.props.unit !== prevProps.unit) {\n      this.renderPortrait();\n    }\n  }\n  renderPortrait() {\n    const { renderer = DefaultPortraitRenderer, unit } = this.props;\n    if (renderer) {\n      renderer.renderToDataURL(unit).then(img => this.setState({ img }));\n    }\n  }\n  render() {\n    return <img className=\"PixlingPortrait\" alt=\"Portrait\"\n      src={this.state.img || this.props.fallbackPortrait || LoadingPortraitPNG} ref={this.imgRef} />;\n  }\n}\n\nconst PortraitRendererPool: { free: PortraitRenderer[], taken: PortraitRenderer[] } = { free: [], taken: [] };\nexport function LiveCreaturePortrait({ unit, playing = true }: { unit: UnitDef, playing?: boolean }) {\n  const div = React.useRef<HTMLDivElement>(null);\n  const [renderer, setRenderer] = React.useState<PortraitRenderer>();\n  React.useEffect(() => {\n    const currentDiv = div.current;\n    if (!currentDiv) {\n      return;\n    }\n    if (PortraitRendererPool.free.length === 0 && PortraitRendererPool.taken.length >= 10) {\n      return;\n    }\n    let pooledRenderer = PortraitRendererPool.free.pop();\n    if (!pooledRenderer) {\n      const canvas = document.createElement('canvas');\n      pooledRenderer = PortraitRenderer.create(canvas, { preserveDrawingBuffer: true });\n      if (pooledRenderer) {\n        pooledRenderer.state.setData({ stepCounter: Math.floor(Math.random() * 10000) });\n        PortraitRendererPool.taken.push(pooledRenderer);\n      }\n    }\n    if (pooledRenderer) {\n      currentDiv.appendChild(pooledRenderer.canvas);\n      setRenderer(pooledRenderer);\n      return () => {\n        currentDiv.removeChild(pooledRenderer!.canvas);\n        PortraitRendererPool.taken.splice(PortraitRendererPool.taken.indexOf(pooledRenderer!), 1);\n        PortraitRendererPool.free.push(pooledRenderer!);\n      }\n    } else {\n      return;\n    }\n  }, [div]);\n  React.useEffect(() => {\n    renderer?.setUnit(unit);\n  }, [renderer, unit]);\n  React.useEffect(() => {\n    if (renderer && playing) {\n      renderer.startRenderLoop();\n      return () => renderer.stopRenderLoop();\n    } else {\n      return () => {};\n    }\n  }, [renderer, playing]);\n  return <div className=\"LivePixlingPortrait\" ref={div} />;\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAtSSURBVHgB7d3dVVVJGsfhgjYAMxg7A0Ng0ADsCMQI6I6gJYKRCEYiGO8VZ4dgCE4G3ss5TG3n4CjNx+E9+6N21fOsxYK1uq/6g5/sP7sqJQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIq1l4BRPH/+/CB/+vPy8vLzarU66bruc4KKCAgM6ODg4PGjR4+O9vb2jnM4nlz7y28uLi5OhYRaCAgMYBOO4/zl7/nj8W1/Xw7Lt59GPn78+DbBwgkI7CCH40kOx8t0Tziu60OSP/32/v37TwkWSkAg4GrfyB8HaQf5Mddb+whLJSDwAEOF4wavP3z4cJJgQQQE7tHvG/v7+y/yR/+o6iCNxD7C0ggI3GLbYXwE3cXFxSuPtSidgMA1M4bjJ/YRSicgsNHvG/mb9sv8KOkoFcJjLUomIDRvxGF8MH1I1uv1H+fn5+8SFEJAaNbh4eHR2MP40DzWoiQCQlNK2TcG8HpzLMqXBDMREJpQUTi+s48wNwGhajkcTzdHjRylSsJxXR+Sr1+//t1jLaYmIFRpCcP40OwjTE1AqEqL4fhR/9NIHxLHojAFAWHx7rmDo0n2EaYgICxWjcP40DzWYkwCwuJs7uDow3GUhGNbbkNkcALCYrS+b+zKYy2GJiAUTziG5TZEhiIgFOlqGM9f9u9wPE0Mzj7CrgSEohjGZ+E2REIEhCIIx7zsI0QICLPa3MFxnL+BvUiUwG2IbE1AmIVhvGz2EbYhIExqiXdwtMpjLe4jIIzOvrFsbkPkNgLCaISjLh5rcZ2AMLjNMP4y/8n1KFEjtyHyjYAwGMN4O+wj9ASEnQlHu9yG2DYBIeRq3+gfU7mDA/tImwSEBzGMc4d+E3njWJR2CAhbcQcH27KPtENAuJN9gx28u7i4+MNjrXoJCDcSDgbkNsRKCQjfXd3BkR9BHBvGGZLHWnUSEAzjTMZtiHURkIZthvH+YEPhYFJ+7bcOAtIg+wYFcRvigglIQ4SDEtlHlktAKtfvG/v7+y/cwUHpckg+ff369TePtZZDQCplGGep7CPLISCVEQ5q0D/WyiE5zfvIm0SxBKQS7uCgRvaRsgnIwhnGaYHHWmUSkIU6PDw8MozToP42xDMhKYOALIh9AzzWKomALIBwwF+5DXF+AlKwHI6nm6NGjpJwwI3sI/MRkAIZxuHB3IY4AwEpiHDAbuwj0xKQmbmDA0bhNsQJCMhMDOMwPvvIuARkYps7OPpwHCXhgNF5rDUeAZmIfQPmtTlf61Ue2rvEIARkZMIBZfFYazgCMoKrYTx/2b/D8TQBJXIb4o4EZECGcVgW+8huBGQAwgHL5jbEGAHZweYOjuP8H9+LBCyefeRhBCTAMA71chvi9gTkAdzBAe2wj9xPQO5h34C2eax1OwG5hXAA17gN8RoBuWYzjL/MP74eJYAfeKz1MwHZMIwD23Ib4v80HxDhAKJa30eaDMjVvtE/pnIHB7CjZm9DbCoghnFgLC3uI00ExB0cwISauQ2x6oDYN4C5tLCPPEp1+3cCmEG/seYnH//JX75OldpPABAgIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQEjVAbm8vPycAGaQv/98yR+fUsWqDsj5+fmv6/X6lZAAU+nDkT+drFarX/P3oHepYnupEYeHh7/v7e0d548nCWBg/R9U8/eXs4uLizdd131JDWgmIL2Dg4Mnv/zyy+v8L/llAhhAH478cfLx48e3qTFNBeSKkAAD6PLHyYcPH7rUqCYDciWH5GkOyb881gIeoEuNh+NK0wG5kveRoxyRP4UEuEOXhOMnAvIDQztwgy4Jx40E5Br7CNDLw/jb/reqhON2AnILIYH2bN7hOFutVv2v4n5O3ElA7mFoh/r14cj/j5+29A7HEARkS4Z2qI9w7EZAHsjQDssnHMMQkAD7CCyTcAxLQHYgJLAMV8eNrNfrd8IxHAEZgKEditXlaJy1eE7VFARkQIZ2KEaXvPw3OgEZgaEdZtMl4ZiMgIzEPgKT6pJwTE5ARiYkMKouCcdsBGQiz58/P7i8vPynx1qwu/6cqtVqdeK4kXkJyMQM7RDjHY7yCMhM8k8kr/P/EC+FBO4mHOUSkBnZR+B2wlE+ASmAkMD/CcdyCEhBDO20rD9upL/ASTiWQ0AKZGinJVfnVDluZHkEpGCGdirXJe9wLJqAFM4+QoW6JBxVEJCFEBIq0CXhqIqALIyhnQXqknBUSUAWytBO6frjRvrfqhKOegnIwhnaKUn/Dkf+dLZard44p6p+AlIB+whz8/JfmwSkIkLC1ISjbQJSIUM7YxMOegJSMUM7QxMOfiQgDTC0syvHjXATAWmEfYSgbr1enwkHNxGQxggJW+qSl/+4h4A0ytDOLbokHGxJQBpnaGejS8LBAwkI3xjam9Ul4SBIQPjOPtKO/pyq1Wp14rgRdiEg/IWQ1Mk7HAxNQLiVob0OwsFYBIR7GdqXSTgYm4CwNUP7MggHUxEQHsQ+Uq7+uJFNON4KB1MQEEKEpCif1uv1qeNGmJqAsBND+6y65B0OZiQgDMLQPqkuCQcFEBAGZWgfVZeEg4IICIOzjwyuS8JBgQSE0QjJbvrjRvI/uzPhoFQCwugM7dvr3+HIn85Wq9Ub51RROgFhMob223n5jyUSECa3GdqP8zfMx6lxwsGSCQizaH0fEQ5qICDMqrWQCAc1ERCK8OzZsxf50z9q3Uf6c6ryx4njRqiJgFCUCof2Lofj9Pz8/F2CyggIRapgaO+Sl/+onIBQrIXuI10SDhohIBRvISHpknDQGAFhMQod2vtt41Q4aJGAsDglDO39OVWr1erEcSO0TEBYrKmHdu9wwM8EhEWbYh8RDriZgFCFMUIiHHA3AaEqQwztwgHbERCqFBna++NGNuF4KxxwPwGhalsO7Z/W6/Wpc6rgYQSE6t2xj3TJy38QJiA044eQ/C0JBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwjf8CKOgPWSE7070AAAAASUVORK5CYII=\"","import * as React from 'react';\nimport './index.css';\nimport { useWorldDataSelect, WorldStateContext } from \"../../../GameComponents/WorldDataConsumer\";\nimport { ScrollableColumn, ItemsColumn } from \"../../../Components/Layout\";\nimport { CreaturePortrait } from '../../CreaturePortrait';\nimport { WonkyPanel, evenPadding } from '../../../Components/WonkyPanel';\nimport { ArenaInfo, ArenaInfosLimit } from '../../../GpuWorld/Tools/ArenaInfos';\nimport { MaxHitpoints } from '../../../GpuWorld/ECS/UnitComponents';\nimport { HomeHealthColor, AwayHealthColor } from '../../../GpuWorld/StateLayout';\nimport { interpolate } from '../../../Math/Math';\nimport { Button } from '../../../Components/Button';\nimport { createUnitModelsForArena } from '../../../GpuWorld/CreateUnitModel';\n\nexport function ArenaMinimaps() {\n  const { layout, arenaInfos } = useWorldDataSelect('layout', 'arenaInfos');\n  const [all, setAll] = React.useState(false);\n  if (!layout || !arenaInfos) {\n    return null;\n  }\n  const renderMax = all ? ArenaInfosLimit : 10;\n  return <ScrollableColumn className=\"ArenaMinimaps\">\n    <ItemsColumn>\n      {/* <AllArenasMinimap /> */}\n      {new Array(Math.min(layout.arenas, renderMax)).fill(0).map((_, i) =>\n        <ArenaMinimap key={i} arenaIndex={i} arenaInfo={arenaInfos[i]} />)}\n      {layout.arenas > renderMax && <span><i>({layout.arenas - renderMax} arenas hidden)</i></span>}\n      <Button flat={true} onClick={() => setAll(!all)}>Show {all ? 'less' : 'more'}</Button>\n    </ItemsColumn>\n  </ScrollableColumn>\n}\n\n// function AllArenasMinimap() {\n//   const worldState = React.useContext(WorldStateContext);\n//   const { renderArena } = useWorldDataSelect('renderArena');\n//   if (!worldState) {\n//     return null;\n//   }\n//   return <WonkyPanel shadowPx={0} fill={'rgba(0, 0, 0, 0.5)'} borderPx={evenPadding(5)} paddingPx={evenPadding(0)}\n//     strokeWidth={3} stroke={renderArena === -1 ? '#fff' : 'transparent'}>\n//     <div\n//       className=\"AllArenasMinimap\"\n//       title=\"All arenas\"\n//       onClick={e => {\n//         if (e.shiftKey) {\n//           worldState.setData({ renderAllArenas: !worldState.data.renderAllArenas });\n//         } else {\n//           worldState.setData({ renderArena: -1 });\n//         }\n//         worldState.ensureRendered();\n//       }}\n//       >\n//       <i className=\"fas fa-location-arrow\" />\n//     </div>\n//   </WonkyPanel>\n// }\n\nexport function ArenaMinimap({ arenaIndex, arenaInfo }: { arenaIndex: number, arenaInfo: ArenaInfo }) {\n  const worldState = React.useContext(WorldStateContext);\n  const { renderArena } = useWorldDataSelect('renderArena');\n  if (!worldState) {\n    return null;\n  }\n  let title = `Arena #${arenaIndex}\\nHome gold: ${arenaInfo.homeGold}\\nAway gold: ${arenaInfo.awayGold}`;\n  return <WonkyPanel shadowPx={0} fill={'rgba(0, 0, 0, 0.5)'} borderPx={evenPadding(5)} paddingPx={evenPadding(0)}\n    strokeWidth={3} stroke={renderArena === arenaIndex ? '#fff' : 'transparent'}>\n    <div\n      className=\"ArenaMinimap\"\n      title={title}\n      onClick={() => {\n        worldState.setData({ renderArena: arenaIndex });\n        createUnitModelsForArena(worldState, arenaIndex);\n        worldState.ensureRendered();\n      }}>\n      {[...arenaInfo.homeUnits, ...arenaInfo.awayUnits].filter(x => x).map((unit, i) => <div\n        key={i}\n        className=\"ArenaMinimapUnit\"\n        style={{\n          left: interpolate(unit.position.x, 50, 78, 0, 100) + '%',\n          top: interpolate(unit.position.y, 50, 78, 100, 0) + '%',\n        }}\n        >\n        <CreaturePortrait unit={unit.unit} />\n      </div>)}\n      <div className=\"ArenaMinimapHpsContainer\">\n        <div className=\"ArenaMinimapHps ArenaMinimapHpsHome\">\n          {arenaInfo.homeUnits.filter(x => x).map((unit, i) => <div key={i} className=\"ArenaMinimapHpBar\">\n            <div\n              className=\"ArenaMinimapHp\"\n              style={{ width: (100 * unit.hitpoints / MaxHitpoints) + '%', backgroundColor: HomeHealthColor }} />\n          </div>)}\n        </div>\n        <div className=\"ArenaMinimapHps ArenaMinimapHpsAway\">\n          {arenaInfo.awayUnits.filter(x => x).map((unit, i) => <div key={i} className=\"ArenaMinimapHpBar\">\n            <div\n              className=\"ArenaMinimapHp\"\n              style={{ width: (100 * unit.hitpoints / MaxHitpoints) + '%', backgroundColor: AwayHealthColor }} />\n          </div>)}\n        </div>\n      </div>\n      <div className=\"ArenaMinimapHomeGold\">{Math.round(arenaInfo.homeGold)}</div>\n      {worldState.data.teams.away.train && <div className=\"ArenaMinimapAwayGold\">{Math.round(arenaInfo.awayGold)}</div>}\n    </div>\n  </WonkyPanel>\n}\n","import React from 'react';\nimport './index.css';\nimport { useWorldDataSelect } from \"../WorldDataConsumer\";\nimport { Block } from \"../../Components/Layout\";\nimport { wait, rgbToHex, vec301ToRgba255 } from '../../Util';\n\nexport function BattleScoreChangeFlash() {\n  const { teams, homeHealthColor, awayHealthColor } = useWorldDataSelect('teams', 'homeHealthColor', 'awayHealthColor');\n  const [text, setText] = React.useState('');\n  const homePoints = teams?.home.battlePoints;\n  const awayPoints = teams?.away.battlePoints;\n  React.useEffect(() => {\n    (async () => {\n      setText(`${homePoints} - ${awayPoints}`);\n      await wait(1000);\n      setText('');\n    })();\n  }, [homePoints, awayPoints]);\n  if (!text || !teams || !homeHealthColor || !awayHealthColor) {\n    return null;\n  }\n  const color = teams.home.battlePoints > teams.away.battlePoints ? rgbToHex(vec301ToRgba255(homeHealthColor))\n    : teams.home.battlePoints < teams.away.battlePoints ? rgbToHex(vec301ToRgba255(awayHealthColor))\n    : 'rgb(133, 133, 133)';\n  return <div className={`BattleScoreChangeFlash`} style={{ color }}>\n    <div className=\"zoomIn animated\">{text}</div>\n  </div>;\n}\n\nexport function BattleScore() {\n  const { teams, homeHealthColor, awayHealthColor } = useWorldDataSelect('teams', 'homeHealthColor', 'awayHealthColor');\n  if (!teams || !homeHealthColor || !awayHealthColor) {\n    return null;\n  }\n  const color = teams.home.battlePoints > teams.away.battlePoints ? rgbToHex(vec301ToRgba255(homeHealthColor))\n    : teams.home.battlePoints < teams.away.battlePoints ? rgbToHex(vec301ToRgba255(awayHealthColor))\n    : 'rgb(133, 133, 133)';\n  return <Block className={`BattleHUDScore`} style={{ color }}>\n    {teams.home.battlePoints}\n    &nbsp;-&nbsp;\n    {teams.away.battlePoints}\n  </Block>\n}\n","import * as React from 'react';\nimport './index.css';\n\ninterface ProgressBarProps {\n  children?: any;\n  progress: number;\n  color?: string;\n  className?: string;\n  title?: string;\n}\n\nexport function ProgressBar({ progress, color = '#757415', className, title, children }: ProgressBarProps) {\n  return <div className={`ProgressBar ${className || ''}`} title={title}>\n    <div className=\"ProgressBarProgress\" style={{ width: Math.max(0, Math.round(100 * progress)) + '%', background: color }} />\n    <div className=\"ProgressBarContent\">\n      {children}\n    </div>\n  </div>\n}\n","import * as React from 'react';\n\nexport function useInterval(callback: () => void, delay: number | undefined) {\n  const savedCallback = React.useRef<() => void>();\n  React.useEffect(() => {\n    savedCallback.current = callback;\n  }, [callback]);\n  React.useEffect(() => {\n    function tick() {\n      if (savedCallback.current) {\n        savedCallback.current();\n      }\n    }\n    if (delay !== undefined) {\n      let id = setInterval(tick, delay);\n      return () => clearInterval(id);\n    } else {\n      return undefined;\n    }\n  }, [delay]);\n}\n","import * as React from 'react';\nimport './index.css';\nimport { WorldStateContext } from '../WorldDataConsumer';\nimport { ProgressBar } from '../../Components/ProgressBar';\nimport { useInterval } from \"../../Components/Interval\";\nimport { PixlingTimespan } from '../../Time';\nimport { StepsInBattle } from '../../GpuWorld/StateLayout';\n\n\nexport function RoundClock() {\n  const worldState = React.useContext(WorldStateContext);\n  const [stepCounter, setStepCounter] = React.useState<number>(0);\n  useInterval(() => {\n    if (worldState) {\n      setStepCounter(worldState.data.stepCounter - worldState.data.battleStartStep);\n    }\n  }, 1000);\n  if (!worldState) {\n    return null;\n  }\n  const p = stepCounter / StepsInBattle;\n  let clockString = new PixlingTimespan(StepsInBattle - stepCounter).toString();\n  return <ProgressBar progress={p} color=\"#e6e699\" className={`RoundClock`}>\n    {clockString}\n  </ProgressBar>;\n}\n","import * as React from 'react';\nimport firebase from 'firebase/app';\nimport { Db, DbId } from 'db';\n\n// https://github.com/microsoft/TypeScript/issues/20707\nexport function notNullOrUndefined<T>(x: T | undefined | null): x is T {\n  return x !== undefined && x !== null;\n}\n\nconst db = firebase.firestore();\n\nexport interface FbQueryDesc<T extends object> {\n  collection: Db;\n  where: Array<[keyof T, firebase.firestore.WhereFilterOp, any] | null>;\n  orderBy?: Array<{ field: keyof T, desc?: boolean }>;\n  limit?: number;\n  disabled?: boolean;\n}\n\nfunction fbQueryFromDesc<T extends object>(desc: FbQueryDesc<T>) {\n  let q: firebase.firestore.CollectionReference | firebase.firestore.Query = db.collection(desc.collection);\n  for (const w of desc.where.filter(notNullOrUndefined)) {\n    q = q.where(w[0] as string, w[1], w[2]);\n  }\n  if (desc.orderBy) {\n    for (const orderBy of desc.orderBy) {\n      q = q.orderBy(orderBy.field as string, orderBy.desc ? 'desc' : 'asc');\n    }\n  }\n  if (desc.limit !== undefined) {\n    q = q.limit(desc.limit);\n  }\n  return q;\n}\n\nexport function useFirebaseStreamQueryTo<T extends object>(query: FbQueryDesc<T>, onSnapshot: (docs: firebase.firestore.QuerySnapshot) => void ) {\n  const queryString = JSON.stringify(query);\n  React.useEffect(() => {\n    const desc = JSON.parse(queryString) as FbQueryDesc<T>;\n    if (desc.disabled) {\n      return;\n    }\n    const q = fbQueryFromDesc(desc);\n    const unsub = q.onSnapshot(snapshot => {\n      onSnapshot(snapshot);\n    });\n    return unsub;\n  }, [queryString, onSnapshot]);\n}\n\nexport type FirebaseStreamQueryResult<T> = { status: 'loading' } | { status: 'loaded', values: Array<T & DbId> };\n\nexport function useFirebaseStreamQuery<T extends object>(\n  query: FbQueryDesc<T>,\n  docToValue?: (doc: firebase.firestore.DocumentData) => T): FirebaseStreamQueryResult<T & { id: string }>;\nexport function useFirebaseStreamQuery<T extends object>(\n  query: FbQueryDesc<T>,\n  docToValue?: (doc: firebase.firestore.DocumentData) => T):\n  FirebaseStreamQueryResult<T & { id: string }> {\n  const [docs, setDocs] = React.useState<null | firebase.firestore.QueryDocumentSnapshot[]>(null);\n  useFirebaseStreamQueryTo(query, React.useCallback(snapshot => setDocs(snapshot.docs), []));\n  if (!docs) {\n    return { status: 'loading' };\n  } else {\n    if (docToValue) {\n      return { status: 'loaded', values: docs.map(d => ({ id: d.id, ...docToValue(d) })) };\n    } else {\n      return { status: 'loaded', values: docs.map(d => ({ id: d.id, ...d.data() as T })) };\n    }\n  }\n}\n\n\nexport type FirebaseStreamDocumentResult<T> =\n  { status: 'loading' } | { status: 'no-such-document' } | { status: 'loaded', value: T & { id: string } };\n\nexport function useFirebaseStreamDocumentTo(\n  collection: Db, id: string | undefined, onSnapshot: (doc: firebase.firestore.DocumentSnapshot) => void) {\n  React.useEffect(() => {\n    if (!id) {\n      return;\n    }\n    return db.collection(collection).doc(id).onSnapshot(onSnapshot);\n  }, [collection, id, onSnapshot]);\n}\n\nexport function useFirebaseStreamDocument<T extends object>(\n  collection: Db, id: string | undefined, { docToValue, fallbackDoc }: {\n    docToValue?: (doc: firebase.firestore.DocumentSnapshot) => T,\n    fallbackDoc?: T\n  } = {}):\n  FirebaseStreamDocumentResult<T> {\n  const [doc, setDoc] = React.useState<null | firebase.firestore.DocumentSnapshot>(null);\n  useFirebaseStreamDocumentTo(collection, id, setDoc);\n  if (!id) {\n    if (fallbackDoc) {\n      return { status: 'loaded', value: {...fallbackDoc, id: '' } };\n    } else {\n      return { status: 'no-such-document' };\n    }\n  } else if (!doc) {\n    return { status: 'loading' };\n  } else {\n    if (!doc.exists) {\n      if (fallbackDoc) {\n        return { status: 'loaded', value: {...fallbackDoc, id } };\n      } else {\n        return { status: 'no-such-document' };\n      }\n    }\n    return {\n      status: 'loaded',\n      value: {...(docToValue ? docToValue(doc) : doc.data() as T), id }\n    };\n  }\n}\n\nexport type FirebaseStreamDocumentsResult<T> =\n  { status: 'loading' } | { status: 'loaded', values: Array<T & { id: string } | undefined> };\n\nexport function useFirebaseStreamDocuments<T extends object>(\n  collection: string, ids: string[], { docToValue }: {\n    docToValue?: (doc: firebase.firestore.DocumentSnapshot) => T\n  } = {}):\n  FirebaseStreamDocumentsResult<T> {\n  const [docs, setDocs] = React.useState<null | firebase.firestore.DocumentSnapshot[]>(null);\n  const idsString = ids.join(',');\n  React.useEffect(() => {\n    const idsList = idsString.length > 0 ? idsString.split(',') : [];\n    if (idsList.length === 0) {\n      setDocs([]);\n      return;\n    }\n    const unsubs: Array<() => void> = [];\n    const docsArray: firebase.firestore.DocumentSnapshot[] = new Array(idsList.length).fill(undefined);\n    for (let i=0; i < idsList.length; i++) {\n      unsubs.push(db.collection(collection).doc(idsList[i]).onSnapshot(snapshot => {\n        docsArray[i] = snapshot;\n        if (docsArray.filter(x => x === undefined).length === 0) {\n          setDocs([...docsArray]);\n        }\n      }));\n    }\n    return () => {\n      unsubs.forEach(unsub => unsub());\n    };\n  }, [collection, idsString]);\n  if (docs === null) {\n    return { status: 'loading' };\n  } else {\n    return {\n      status: 'loaded',\n      values: docs.map(d => d.exists ? {...(docToValue ? docToValue(d) : (d.data() as T)), id: d.id } : undefined)\n    };\n  }\n}\n\nexport function FirebaseLoading({ pending }: { pending: Array<FirebaseStreamDocumentResult<any> | FirebaseStreamQueryResult<any>> }) {\n  const hasError = pending.find(x => x.status !== 'loading' && x.status !== 'loaded');\n  if (hasError) {\n    return <span>Error</span>;\n  } else {\n    return <span>Loading...</span>;\n  }\n}\n","import * as React from 'react';\nimport './index.css';\nimport * as ReactDOM from 'react-dom';\n\nexport type PopdownAttachment = 'horizontal' | 'vertical';\n\nexport function PopdownsContainer() {\n  return <div id=\"PopdownsContainer\" />\n}\n\ninterface PopdownProps {\n  onClickFader?: () => void;\n  popdown: () => React.ReactNode;\n  showPopdown: boolean;\n  className?: string;\n  fader?: boolean;\n  attachment?: PopdownAttachment;\n  onMouseOver?: (event: React.MouseEvent<HTMLDivElement>) => void;\n  onMouseOut?: (event: React.MouseEvent<HTMLDivElement>) => void;\n  onClick?: (event: React.MouseEvent<HTMLDivElement>) => void;\n  onContextMenu?: (event: React.MouseEvent<HTMLDivElement>) => void;\n}\n\nexport class Popdown extends React.Component<PopdownProps> {\n  root: HTMLDivElement | null = null;\n\n  render() {\n    const { fader = true } = this.props;\n    let popupPopdown = (\n      <div className=\"PopdownPopup\" style={this.popupStyle} onClick={e => e.stopPropagation()}>\n        {this.props.popdown()}\n      </div>\n    );\n    if (fader) {\n      popupPopdown = <div className=\"PopdownPopupBackground\" onClick={this.props.onClickFader}>{popupPopdown}</div>;\n    }\n    const portal = this.props.showPopdown ?\n      ReactDOM.createPortal(\n        popupPopdown\n      , document.getElementById('PopdownsContainer') || document.documentElement!)\n      : undefined;\n    return (\n      <div\n        className={'Popdown' + (this.props.className ? ' ' + this.props.className : '')}\n        onMouseOver={this.props.onMouseOver}\n        onMouseOut={this.props.onMouseOut}\n        onClick={this.props.onClick}\n        onContextMenu={this.props.onContextMenu}\n        ref={e => this.root = e}\n        >\n        {this.props.children}\n        {portal}\n      </div>\n    );\n  }\n\n  private get popupStyle(): React.CSSProperties {\n    if (this.root) {\n      const { attachment = 'vertical' } = this.props;\n      const bounding = this.root.getBoundingClientRect();\n      const style: React.CSSProperties = {};\n      if (attachment === 'vertical') {\n        if (bounding.left < window.innerWidth / 2) {\n          style.left = bounding.left + 'px';\n        } else {\n          style.right = (window.innerWidth - bounding.right) + 'px';\n        }\n        if (bounding.bottom < window.innerHeight / 2) {\n          return {\n            ...style,\n            top: bounding.bottom + 'px',\n            maxHeight: (window.innerHeight - bounding.bottom - 3) + 'px'\n          };\n        } else {\n          return {\n            ...style,\n            bottom: (window.innerHeight - bounding.top) + 'px',\n            maxHeight: (bounding.top - 3) + 'px'\n          };\n        }\n      } else {\n        if (bounding.left < window.innerWidth / 2) {\n          style.left = bounding.right + 'px';\n          style.maxWidth = (window.innerWidth - bounding.left) + 'px';\n        } else {\n          style.right = (window.innerWidth - bounding.left) + 'px';\n          style.maxWidth = (bounding.left - 3) + 'px';\n        }\n        if (bounding.bottom < window.innerHeight / 2) {\n          return {\n            ...style,\n            top: bounding.top + 'px'\n          };\n        } else {\n          return {\n            ...style,\n            bottom: (window.innerHeight - bounding.bottom) + 'px'\n          };\n        }\n      }\n    } else {\n      return {};\n    }\n  }\n}","import * as React from 'react';\nimport './index.css';\nimport { Popdown } from '../Popdown';\nimport { notNullOrUndefined } from '../../Util';\n\nexport function Menu({ children }: { children?: any }) {\n  return <div className=\"Menu\">{children}</div>;\n}\nexport interface MenuItemProps {\n  title: string;\n  checked?: boolean;\n  highlighted?: boolean;\n  disabled?: boolean;\n  onClick?: () => void;\n  onMouseDown?: () => void;\n  className?: string;\n}\nexport function MenuItem({ onClick, onMouseDown, title, checked, highlighted, disabled, className }: MenuItemProps) {\n  return <div\n    className={`MenuItem ${onClick ? 'MenuItemClickable' : ''} ${disabled === true ? 'MenuItemDisabled' : ''} ${highlighted === true ? 'MenuItemHighlighted' : ''} ${className ?? ''}`}\n    onClick={() => {\n      if (!disabled && onClick) {\n        onClick();\n      }\n    }}\n    onMouseDown={() => {\n      if (!disabled && onMouseDown) {\n        onMouseDown();\n      }\n    }}\n    >\n    {checked !== undefined && <span><i className={`far fa-${checked === true ? 'check-' : ''}square`} />&nbsp;</span>}{title}\n  </div>\n}\n\nexport type ActionMenuItem = MenuItemProps;\n\nexport function ActionMenu({ actions, disabled, children }: { actions: Array<ActionMenuItem | undefined> | (() => Array<ActionMenuItem | undefined>), disabled?: boolean, children?: any }) {\n  const [showMenu, setShowMenu] = React.useState<boolean>(false);\n  if (disabled) {\n    return children || null;\n  }\n  return <Popdown\n    className=\"ActionMenu\"\n    showPopdown={showMenu}\n    onClickFader={() => setShowMenu(false)}\n    popdown={() => {\n      const acts = (typeof actions === 'function' ? actions() : actions).filter(notNullOrUndefined);\n      return <Menu>\n        {acts.map(({ onClick, ...rest}, i) =>\n          <MenuItem key={i} onClick={onClick ? () => {\n            onClick();\n            setShowMenu(false);\n          } : undefined} {...rest} />\n          )}\n      </Menu>\n    }}\n  >\n    <div className=\"ActionMenuAction\" onClick={() => setShowMenu(true)}>\n      {children || <i className=\"material-icons\">more_vert</i>}\n    </div>\n  </Popdown>\n}\n","import * as React from 'react';\nimport './index.css';\nimport { EditorProps, NonNullEditorDispatch } from '../Editors/EditorProps';\n\ninterface CheckboxProps extends EditorProps<boolean>, NonNullEditorDispatch<boolean> {\n  style?: React.CSSProperties;\n  children?: any;\n}\n\nexport function Checkbox({ className, style, onChange, readOnly, value, children }: CheckboxProps) {\n  return <label\n    className={`Checkbox ${className || ''} ${value ? 'CheckboxChecked' : ''}`}\n    style={style}\n    onClick={e => { e.stopPropagation(); }}\n    >\n    {!readOnly && <input className={className} type=\"checkbox\" checked={value} onChange={() => onChange(!value)} />}\n    <i className={`fas ${value ? 'fa-check-square' : 'fa-square'}`} />\n    {children && <span>{children}</span>}\n  </label>;\n}\n","import * as _ from 'lodash';\nimport * as React from 'react';\nimport { Checkbox } from '../Checkbox';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { EditorEnumVariants } from './EditorTypedefs';\nimport { withDefaultValue } from './WithDefaultValue';\nimport './Editors.css';\nimport { keysOfEnum } from '../../Util';\nimport { Popdown } from '../Popdown';\nimport { Menu, MenuItem } from '../Menu';\nimport { ScrollVertical } from '../Layout';\n\nexport const CheckboxEditor = Checkbox;\n\ninterface EnumEditorProps extends EditorProps<any> {\n  variants: EditorEnumVariants | (() => EditorEnumVariants);\n  searchable?: boolean;\n}\n\nexport function enumEnumVariants(e: any) {\n  return keysOfEnum(e).map(k => ({ value: e[k], displayName: k }));\n}\n\nfunction normalizeEnumVariants(variants: EditorEnumVariants | (() => EditorEnumVariants)): Array<{ value: any, displayName: string, description?: string, className?: string }> {\n  if (_.isFunction(variants)) {\n    variants = variants();\n  }\n  if (!Array.isArray(variants)) {\n    return Object.keys(variants).map(displayName => ({\n      displayName, value: (variants as { [displayName: string]: any })[displayName]\n    }));\n  } else {\n    return variants.map(v => {\n      if (typeof v === 'string') {\n        return { value: v, displayName: v };\n      } else {\n        return { value: v.value, displayName: v.displayName || v.value, description: v.description, className: v.className };\n      }\n    }) as Array<{ value: any, displayName: string, description?: string, className?: string }>;\n  }\n}\n\nexport const EnumEditor = withDefaultValue(({ className, onChange, readOnly = false, value, variants, searchable }: EnumEditorProps & EditorDispatch<any>) => {\n  const [showPopdown, setShowPopdown] = React.useState<boolean>(false);\n  const [filter, setFilter] = React.useState<string>('');\n  let vars = normalizeEnumVariants(variants);\n  if (filter) {\n    const filterLower = filter.toLowerCase();\n    vars = vars.filter(x => x.displayName.toLowerCase().indexOf(filterLower) !== -1);\n  }\n  let displayValue = '' + value;\n  for (const v of vars) {\n    if (_.isEqual(v.value, value)) {\n      displayValue = v.displayName || v.value;\n    }\n  }\n  return (\n    <Popdown\n      className={className}\n      showPopdown={showPopdown}\n      onClickFader={() => setShowPopdown(false)}\n      popdown={() => <div className=\"EnumEditorPopdown\">\n          <Menu>\n            {searchable && <input type=\"text\" value={filter} onChange={e => setFilter(e.target.value)} placeholder=\"Filter\" />}\n            <ScrollVertical>\n              {vars.map((v, i) => <MenuItem\n                key={i}\n                onClick={() => { setShowPopdown(false); onChange(v.value); }}\n                title={v.displayName}\n                className={v.className}\n                />)}\n            </ScrollVertical>\n          </Menu>\n      </div>}\n      >\n      <div className=\"EnumEditor\" onClick={() => !readOnly && setShowPopdown(true)}>\n        {displayValue} <i className=\"material-icons\">arrow_drop_down</i>\n      </div>\n    </Popdown>\n  );\n});\n","import * as React from 'react';\nimport './Editors.css';\nimport { Button } from '../Button';\nimport { EditorProps, EditorDispatch } from './EditorProps';\n\nexport interface WithDefaultProps<T> {\n  defaultValue?: T;\n}\n\nexport function withDefaultValue<T, PropsType extends EditorProps<T> & EditorDispatch<T>>(WrappedComponent: React.ComponentClass<PropsType> | React.StatelessComponent<PropsType>)\n  : React.ComponentClass<PropsType & WithDefaultProps<T>> {\n  return class extends React.Component<PropsType & WithDefaultProps<T>, {}> {\n    render() {\n      const defaultValue = this.props.defaultValue as T | undefined;\n      if (defaultValue !== undefined) {\n        return (\n          <div className={`EditorWithDefault ${this.props.value === undefined ? 'IsDefault' : ''}`}>\n            <div className=\"EditorWithDefaultValue\">\n              <WrappedComponent {...this.props} value={this.props.value !== undefined ? this.props.value : defaultValue} />\n            </div>\n            <Button\n              className=\"ResetToDefault EditorActionButton\"\n              onClick={() => this.props.onChange(undefined)}\n              disabled={this.props.value === undefined}\n              purpose=\"ResetToDefault\"\n              >\n              <i className=\"material-icons\">settings_backup_restore</i>\n            </Button>\n          </div>\n        );\n      } else {\n        return <WrappedComponent {...this.props} />;\n      }\n    }\n  };\n}\n","import * as React from 'react';\nimport './Editors.css';\n\nexport interface LineListLayoutItemProps {\n  action?: React.ReactNode,\n  item?: React.ReactNode,\n  isLast?: boolean;\n  isFirst?: boolean;\n};\n\nexport function LineListLayoutItem({ isLast, isFirst, action, item }: LineListLayoutItemProps) {\n  return <div \n      className={`LineListLayoutItem`}\n      >\n      <div className={`LineListLayoutItemVerticalLine ${isLast ? 'LineListLast' : (isFirst ? 'LineListFirst' : '')}`} />\n      <div className=\"LineListLayoutItemLine\" />\n      {action}\n      {action && item && (\n        <div className=\"LineListLayoutItemLine\" />\n      )}\n      {item && (\n        <div className=\"LineListLayoutItemValue\">\n          {item}\n        </div>\n      )}\n    </div>;\n}\n\ninterface LineListLayoutProps {\n  className?: string;\n  children?: any;\n}\n\nexport function LineListLayout({ className, children }: LineListLayoutProps) {\n  return (\n    <div className={'LineListLayout ' + (className || '')}>\n      {children}\n    </div>\n  );\n}\n","import * as React from 'react';\nimport './index.css';\nimport * as _ from 'lodash';\n\n// Due to a bug in Chrome/FF/(more?) modifier keys are not available in the dragend event: https://stackoverflow.com/questions/24016457/html5-image-drag-event-ctrlkey-remains-false-in-firefox-29\nconst globalIsCopy = { copy: false };\n\ntype DragAndDropItemRenderer<T> = (item: T, onItemChange: (item: T) => void, index: number) => React.ReactNode;\n\ninterface DragAndDropListProps<T> {\n  value: T[];\n  onChange: (value: T[]) => void;\n  itemRenderer: DragAndDropItemRenderer<T>;\n  keyFromItem?: (item: T) => string;\n  onItemRemoved?: (index: number) => void;\n  onItemInserted?: (index: number) => void;\n  acceptItem?: (item: any) => boolean;\n  filter?: (item: T) => boolean;\n}\n\nconst DragAndDropItemContext = React.createContext<{\n  item?: any,\n  onDragRemove?: () => void,\n  onDragChange?: (dragging: boolean) => void,\n}>({});\n\ninterface DragAndDropListState {\n  over: false;\n  queuedUpdates: Array<{ key: any, item: any }>;\n}\n\nexport class DragAndDropList<T> extends React.Component<DragAndDropListProps<T>, DragAndDropListState> {\n  state: DragAndDropListState = {\n    over: false,\n    queuedUpdates: []\n  }\n  queuedInsert?: { key?: any, mode: 'top' | 'bottom', item: any };\n  queuedRemove?: { key: any };\n  performChange = _.debounce(() => {\n    const { keyFromItem } = this.props;\n    const nextValue = [...this.props.value];\n    for (const queuedUpdate of this.state.queuedUpdates) {\n      const index = keyFromItem ? this.props.value.findIndex(x => keyFromItem(x) === queuedUpdate.key) : queuedUpdate.key;\n      nextValue.splice(index, 1, queuedUpdate.item);\n    }\n    const queuedRemove = this.queuedRemove;\n    const queuedInsert = this.queuedInsert;\n    if (queuedRemove && queuedInsert && queuedRemove.key === queuedInsert.key) {\n      // Do nothing, we're moving to ourselves\n    } else {\n      if (queuedRemove) {\n        const index = keyFromItem ? nextValue.findIndex(x => keyFromItem(x) === queuedRemove.key) : queuedRemove.key;\n        nextValue.splice(index, 1);\n        if (this.props.onItemRemoved) {\n          this.props.onItemRemoved(index);\n        }\n      }\n      if (queuedInsert) {\n        let index = 0;\n        if (queuedInsert.key) {\n          index = keyFromItem ? nextValue.findIndex(x => keyFromItem(x) === queuedInsert.key) : queuedInsert.key;\n          if (queuedInsert.mode === 'bottom') {\n            index++;\n          }\n          if (!keyFromItem && this.queuedRemove && this.queuedRemove.key < index) {\n            index--;\n          }\n        } else {\n          if (queuedInsert.mode === 'bottom') {\n            index = nextValue.length;\n          }\n        }\n        nextValue.splice(index, 0, queuedInsert.item);\n        if (this.props.onItemInserted) {\n          this.props.onItemInserted(index);\n        }\n      }\n    }\n    this.queuedInsert = undefined;\n    this.queuedRemove = undefined;\n    this.props.onChange(nextValue);\n    this.setState({ queuedUpdates: [] });\n  }, 50);\n  render() {\n    const { value, itemRenderer, keyFromItem, filter } = this.props;\n    return <DragAndDropArea\n      className=\"DragAndDropList\"\n      onDrop={(drop, item) => {\n        this.queuedInsert = { mode: drop, item };\n        this.performChange();\n      }}\n      acceptItem={this.props.acceptItem}\n      >\n      {value.map((item, i) => {\n        if (filter && !filter(item)) {\n          return null;\n        }\n        const key = keyFromItem ? keyFromItem(item) : i;\n        let pendingValue = item;\n        for (const update of this.state.queuedUpdates) {\n          if (update.key === key) {\n            pendingValue = update.item;\n          }\n        }\n        return <DragAndDropItem\n          key={i}\n          item={pendingValue}\n          onDrop={(drop, dropItem) => {\n            this.queuedInsert = { key, mode: drop, item: dropItem };\n            this.performChange();\n          }}\n          onDragRemove={() => {\n            this.queuedRemove = { key };\n            this.performChange();\n          }}\n          acceptItem={this.props.acceptItem}\n          >\n          {itemRenderer(\n            pendingValue, \n            (newItem) => {\n              this.setState(s => ({ queuedUpdates: [...s.queuedUpdates, { key, item: newItem }] }));\n              this.performChange();\n            },\n            i\n          )}\n        </DragAndDropItem>\n      })}\n    </DragAndDropArea>;\n  }\n}\n\nfunction isCopy(event: React.DragEvent<HTMLDivElement>) {\n  return (event.altKey || event.ctrlKey || event.metaKey);\n}\n\ninterface DragAndDropAreaProps {\n  className?: string;\n  onDrop: (drop: 'top' | 'bottom', value: any) => void;\n  acceptItem?: (item: any) => boolean;\n}\ninterface DragAndDropAreaState {\n  over: 'none' | 'top' | 'bottom';\n}\n\nclass DragAndDropArea extends React.Component<DragAndDropAreaProps, DragAndDropAreaState> {\n  state: DragAndDropAreaState = {\n    over: 'none'\n  }\n  handleDragEnter = (event: React.DragEvent<HTMLDivElement>) => {\n    event.stopPropagation();\n    event.dataTransfer.dropEffect = isCopy(event) ? 'copy' : 'move';\n    this.setState({ over: 'top' });\n  }\n  handleDragOver = (event: React.DragEvent<HTMLDivElement>) => {\n    event.preventDefault();\n    event.stopPropagation();\n    event.dataTransfer.dropEffect = isCopy(event) ? 'copy' : 'move';\n    if (!this.div) {\n      return;\n    }\n    const bound = this.div.getBoundingClientRect();\n    if (event.clientY <= bound.top + bound.height / 2) {\n      this.setState({ over: 'top' });\n    } else {\n      this.setState({ over: 'bottom' });\n    }\n  }\n  handleDrop = (event: React.DragEvent<HTMLDivElement>) => {\n    event.preventDefault();\n    event.stopPropagation();\n    globalIsCopy.copy = isCopy(event);\n    if (this.state.over === 'none') {\n      return;\n    }\n    let data;\n    try {\n      data = JSON.parse(event.dataTransfer.getData('text/plain'));\n    } catch {\n      alert('Invalid JSON data!');\n      return;\n    }\n    if (!this.props.acceptItem || this.props.acceptItem(data)) {\n      this.props.onDrop(this.state.over, data);\n    }\n    this.setState({ over: 'none' });\n  }\n  div: HTMLDivElement | null = null;\n  render() {\n    const className = [\n      'DragAndDropArea',\n      this.state.over === 'top' ? 'DragAndDropAreaOverTop' : '',\n      this.state.over === 'bottom' ? 'DragAndDropAreaOverBottom' : '',\n      this.props.className || ''\n    ].join(' ');\n    return <div\n      ref={e => this.div = e}\n      className={className}\n      onDragEnter={this.handleDragEnter}\n      onDragLeave={() => this.setState({ over: 'none' })}\n      onDragOver={this.handleDragOver}\n      onDrop={this.handleDrop}\n      >\n      {this.props.children}\n    </div>\n  }\n}\n\ninterface DragAndDropItemProps {\n  item: any;\n  onDrop: (drop: 'top' | 'bottom', value: any) => void;\n  onDragRemove: () => void;\n  acceptItem?: (item: any) => boolean;\n}\ninterface DragAndDropItemState {\n  dragging: boolean;\n}\n\nclass DragAndDropItem extends React.Component<DragAndDropItemProps, DragAndDropItemState> {\n  state: DragAndDropItemState = {\n    dragging: false\n  }\n  render() {\n    const className = [\n      'DragAndDropItem',\n      this.state.dragging ? 'DragAndDropItemDragging' : ''\n    ].join(' ');\n    return <DragAndDropArea\n      className={className}\n      onDrop={this.props.onDrop}\n      acceptItem={this.props.acceptItem}\n      >\n      <DragAndDropItemContext.Provider value={{ \n        item: this.props.item, \n        onDragRemove: this.props.onDragRemove, \n        onDragChange: dragging => this.setState({ dragging })\n        }}>\n        {this.props.children}\n      </DragAndDropItemContext.Provider>\n    </DragAndDropArea>;\n  }\n}\n\nexport class DragAndDropHandle extends React.Component {\n  render() {\n    return <DragAndDropItemContext.Consumer>\n      {({ item, onDragRemove, onDragChange }) => \n        <span\n          className={`DragAndDropHandle`}\n          onDragStart={event => {\n            event.stopPropagation();\n            event.dataTransfer.effectAllowed = 'copyMove';\n            event.dataTransfer.setData('text/plain', JSON.stringify(item, null, 2));\n            if (onDragChange) {\n              onDragChange(true);\n            }\n          }}\n          onDragEnd={event => {\n            if (onDragChange) {\n              onDragChange(false);\n            }\n            if (!globalIsCopy.copy && onDragRemove) {\n              onDragRemove();\n            }\n          }}\n          draggable={true}\n          >\n          {this.props.children}\n        </span>\n      }\n    </DragAndDropItemContext.Consumer>\n  }\n}","import * as React from 'react';\nimport { EditorDispatch, EditorProps, NonNullEditorDispatch } from './EditorProps';\nimport { LineListLayout, LineListLayoutItem } from './LineListLayout';\nimport './Editors.css';\nimport { DragAndDropList } from '../DragAndDropList';\n\ninterface ListEditorItemProps<T> extends EditorProps<T>, NonNullEditorDispatch<T> {\n  selected: boolean;\n}\n\ninterface ListEditorProps<T> extends EditorProps<T[]> {\n  itemFactory: () => (T | Promise<T>);\n  itemRenderer: (props: ListEditorItemProps<T>) => React.ReactNode;\n  keyFromItem?: (item: T) => any;\n  filter?: (item: T) => boolean;\n\n  className?: string;\n  onSelect?: (selected: number | undefined, totalCount: number) => void;\n  selected?: number;\n  renderReverse?: boolean;\n  showInsertTop?: boolean;\n  showInsertBottom?: boolean;\n  acceptItemDrop?: (item: any) => boolean;\n}\n\n\nfunction ReverseListEditor<T>({ value = [], onChange, selected, onSelect, ...rest }: ListEditorProps<T> & EditorDispatch<T[]>) {\n  return <ListEditor<T>\n    value={[...value].reverse()}\n    onChange={newValue => onChange(newValue !== undefined ? newValue.reverse() : undefined)}\n    selected={selected !== undefined ? value.length - 1 - selected : undefined}\n    onSelect={onSelect && ((index, totalCount) => onSelect(index !== undefined ? totalCount - 1 - index : undefined, totalCount))}\n    {...rest}\n    />\n}\n\nexport class ListEditor<T> extends React.Component<ListEditorProps<T> & EditorDispatch<T[]>> {\n  render() {\n    const { onChange, readOnly, selected, renderReverse, showInsertTop = false, showInsertBottom = true } = this.props;\n    if (renderReverse) {\n      const { renderReverse: rr, ...props } = this.props;\n      return <ReverseListEditor  {...props} />;\n    }\n    const list = this.props.value || [];\n    return (\n      <LineListLayout className={this.props.className}>\n        {!readOnly && showInsertTop && <LineListLayoutItem\n          isFirst={true}\n          action={<button\n            className=\"EditorActionButton ListEditorItemAction\"\n            onClick={async e => {\n              e.preventDefault();\n              const item = await this.props.itemFactory();\n              if (!item) {\n                return;\n              }\n              this.insertItems(0, true, item);\n            }}>\n            <i className=\"material-icons\">add</i>\n          </button>}\n          />}\n        <DragAndDropList\n          value={this.props.value || []}\n          onChange={onChange}\n          keyFromItem={this.props.keyFromItem}\n          onItemRemoved={this.handleItemRemoved}\n          onItemInserted={this.handleItemInserted}\n          acceptItem={this.props.acceptItemDrop}\n          filter={this.props.filter}\n          itemRenderer={(item, onItemChange, i) => (\n            <LineListLayoutItem\n              isFirst={!(!readOnly && showInsertTop) && i === 0}\n              isLast={!(!readOnly && showInsertBottom) && i === list.length - 1}\n              action={null}\n              item={this.props.itemRenderer({\n                readOnly,\n                value: item,\n                onChange: onItemChange,\n                selected: selected === i,\n              })}\n              />\n          )}\n          />\n        {!readOnly && showInsertBottom && <LineListLayoutItem\n          isLast={true}\n          action={<button\n            className=\"EditorActionButton ListEditorItemAction\"\n            onClick={async e => {\n              e.preventDefault();\n              const item = await this.props.itemFactory();\n              if (!item) {\n                return;\n              }\n              this.insertItems(-1, true, item);\n            }}>\n            <i className=\"material-icons\">add</i>\n          </button>}\n          />}\n      </LineListLayout>\n    );\n  }\n\n  handleItemRemoved = (index: number) => {\n    const { onSelect, selected, value = [] } = this.props;\n    if (selected && onSelect) {\n      if (selected === index) {\n        onSelect(undefined, value.length - 1);\n      } else if (selected > index) {\n        onSelect(selected - 1, value.length - 1);\n      }\n    }\n  }\n\n  handleItemInserted = (index: number) => {\n    const { onSelect, selected, value = [] } = this.props;\n    if (selected && onSelect) {\n      if (selected >= index) {\n        onSelect(selected + 1, value.length + 1);\n      }\n    }\n  }\n\n  private insertItems(i: number, selectNew: boolean, ...items: T[]) {\n    if (items.length === 0) {\n      return;\n    }\n    const list = this.props.value || [];\n    if (i < 0) {\n      i = list.length;\n    }\n    const newList = [...list.slice(0, i), ...items, ...list.slice(i)];\n    this.props.onChange(newList);\n    if (!this.props.onSelect) {\n      return;\n    }\n    if (selectNew) {\n      this.props.onSelect(i, newList.length);\n    } else {\n      this.handleItemInserted(i);\n    }\n  }\n\n}\n","import * as React from 'react';\nimport './Editors.css';\nimport { EditorStructProperties, EditorTypedefResolver } from './EditorTypedefs';\nimport { AnyEditor } from './AnyEditor';\nimport { LineListLayout, LineListLayoutItem } from './LineListLayout';\nimport { ListEditor } from './ListEditor';\nimport { EditorProps } from './EditorProps';\n\nexport interface StructEditorChange {\n  property: string;\n  value: any;\n}\n\ninterface StructEditorType {\n  [key: string]: any;\n}\n\nexport type StructEditorLayout = 'linelist' | 'table';\n\ninterface StructEditorProps extends EditorProps<StructEditorType> {\n  onChange: (change: StructEditorChange) => void;\n  properties: EditorStructProperties;\n  layout?: StructEditorLayout;\n  value: StructEditorType;\n\n  typedefResolver?: EditorTypedefResolver;\n}\n\nconst verticalEditors = [\n  ListEditor,\n  StructEditor,\n];\n\nexport function StructEditor({ className, onChange, properties, readOnly, typedefResolver, value, layout }: StructEditorProps): any {\n  let props;\n  if (!Array.isArray(properties)) {\n    props = Object.keys(properties)\n      .filter(name => properties[name])\n      .map((name: string) => ({ name, type: properties[name] }));\n  } else {\n    props = properties;\n  }\n  props = props.map(p => ({\n    ...p,\n    editor: AnyEditor({\n      typedef: p.type,\n      readOnly,\n      value: value && value[p.name as string],\n      onChange: (newValue: any) => onChange({ property: p.name as string, value: newValue }),\n      typedefResolver,\n    })\n  }));\n  if (layout === 'table') {\n    return <table className=\"StructEditor\"><tbody>\n      {props.map(({ name, label, title, editor, visible }, i) => visible !== false && <tr key={i}>\n        <td title={title} className=\"StructEditorKey\">{label !== undefined ? label : name}</td>\n        <td className=\"StructEditorValue\">{editor}</td>\n      </tr>)}\n    </tbody></table>;\n  } else {\n    return <LineListLayout className={className}>\n      {props.map(({ name, label, title, editor, visible }, i) => {\n          return visible !== false && <LineListLayoutItem key={i} \n            isFirst={i === 0}\n            isLast={i === props.length - 1}\n            item={\n                <div key={name} className={'StructEditorProperty' + (verticalEditors.indexOf(editor.type) === -1 ? ' Inline' : '')}>\n                  <div className=\"StructEditorKey\" title={title}>\n                    {label !== undefined ? label : name}:&nbsp;\n                  </div>\n                  <div className=\"StructEditorValue\">\n                    {editor}\n                  </div>\n                </div>\n            }\n            />;\n        })\n      }\n    </LineListLayout>;\n  }\n}\n","import * as React from 'react';\nimport './Editors.css';\nimport { EditorTypedefResolver, EditorEnumStructVariants } from './EditorTypedefs';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { StructEditor, StructEditorChange } from './StructEditor';\nimport { EnumEditor } from './PrimitiveEditors';\n\ninterface EnumStructEditorProps extends EditorProps<any> {\n  variants: EditorEnumStructVariants;\n  typedefResolver?: EditorTypedefResolver;\n}\n\nexport function EnumStructEditor({ className, onChange, readOnly, value, variants }: EnumStructEditorProps & EditorDispatch<any>): any {\n  const typeVariants = Object.keys(variants).map(typeName => \n    ({ value: typeName, displayName: variants[typeName].displayName || typeName, description: variants[typeName].description }));\n  return (\n    <div className={'EnumStructEditor ' + (className || '')}>\n      <EnumEditor\n        variants={typeVariants}\n        readOnly={readOnly}\n        value={value ? value.type : undefined}\n        onChange={type => {\n          if (!type) {\n            onChange(null);\n          } else {\n            const obj = variants[type].default(type);\n            onChange({ ...obj, ...value, type });\n          }\n        }}\n        />\n      <div className=\"EnumStructEditorProperties\">\n        {value && value.type && variants[value.type] && (\n          <StructEditor\n            properties={variants[value.type].properties}\n            readOnly={readOnly}\n            value={value}\n            onChange={(change: StructEditorChange) => {\n              onChange({...value, [change.property]: change.value });\n            }}\n            />\n        )}\n      </div>\n    </div>\n  );\n}\n","import * as React from 'react';\nimport './Editors.css';\nimport { EditorTypedefResolver, EditorObnumVariants } from './EditorTypedefs';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { AnyEditor } from './AnyEditor';\nimport { EnumEditor } from './PrimitiveEditors';\n\ninterface ObnumEditorProps extends EditorProps<any> {\n  variants: EditorObnumVariants;\n  typedefResolver?: EditorTypedefResolver;\n}\n\nexport function ObnumEditor({ className, onChange, readOnly, typedefResolver, value, variants }: ObnumEditorProps & EditorDispatch<any>): any {\n  const key = value ? Object.keys(value)[0] : undefined;\n  return (\n    <div className={'ObnumEditor ' + (className || '')}>\n      <EnumEditor\n        readOnly={readOnly}\n        value={key}\n        variants={Object.keys(variants)}\n        onChange={newKey => onChange({ [newKey]: variants[newKey].default })} />\n      {value && key && variants[key] && (\n        <AnyEditor\n          readOnly={readOnly}\n          value={value[key]}\n          onChange={(v: any) => onChange({ [key]: v })}\n          typedef={variants[key].itemType}\n          typedefResolver={typedefResolver}\n          />\n      )}\n    </div>\n  );\n}\n","import * as React from 'react';\nimport './Editors.css';\nimport { EditorTypedef, EditorTypedefRef, EditorTypedefResolver } from './EditorTypedefs';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { AnyEditor } from './AnyEditor';\n\ninterface TupleEditorProps extends EditorProps<any[]> {\n  itemTypes: Array<EditorTypedef | EditorTypedefRef>;\n  typedefResolver?: EditorTypedefResolver;\n}\n\nexport const TupleEditor = ({ className, onChange, itemTypes, readOnly, value, typedefResolver }: TupleEditorProps & EditorDispatch<any[]>) => {\n  const tuple = value || [];\n  return (\n    <div className={'TupleEditor ' + (className || '')}>\n      {itemTypes.map((type, i) => (\n        <div key={i} className=\"TupleEditorItem\">\n          <AnyEditor\n            readOnly={readOnly}\n            value={tuple[i]}\n            onChange={(newValue: any) => {\n              const newTuple = [...tuple];\n              newTuple[i] = newValue;\n              onChange(newTuple);\n            }}\n            typedef={itemTypes[i]}\n            typedefResolver={typedefResolver}\n            />\n        </div>\n      ))}\n    </div>\n  );\n}\n","import * as React from 'react';\nimport { EditorProps, NonNullEditorDispatch } from './EditorProps';\nimport { Popdown } from '../Popdown';\n\nexport function getSizeOfInput(text: string, className: string | undefined) {\n  const tmp = document.createElement(\"span\");\n  tmp.className = className || '';\n  tmp.innerHTML = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n  document.body.appendChild(tmp);\n  const size = tmp.getBoundingClientRect();\n  document.body.removeChild(tmp);\n  return size;\n}\n\nexport type WidthMode = 'fit-content' | 'fill' | 'fixed';\n\nexport interface StringEditorProps extends EditorProps<string> {\n  multiline?: boolean;\n  rows?: number;\n  className?: string;\n  placeholder?: string;\n  widthMode?: WidthMode;\n  spellCheck?: boolean;\n  onClick?: (event: React.MouseEvent<HTMLElement>) => void;\n  validate?: (value: string) => string | undefined;\n}\n\nexport function useStringValidation(value: string | undefined, validate: ((value: string) => string | undefined) | undefined, onChange: (value: string) => void) {\n  const [editValue, setEditValue] = React.useState<string>('');\n  const [validationError, setValidationError] = React.useState<string | undefined>();\n  const [committed, setCommitted] = React.useState<boolean>(true);\n  React.useEffect(() => {\n    if (committed) {\n      setEditValue(value || '');\n      setCommitted(true);\n      setValidationError(validate ? validate(value || '') : undefined);\n    }\n  }, [value, validate, committed]);\n\n  const handleChange = (event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    setEditValue(event.target.value);\n    setCommitted(false);\n    setValidationError(validate ? validate(event.target.value) : undefined);\n  }\n  const tryCommit = () => {\n    if (validationError === undefined && !committed) {\n      onChange(editValue);\n      setCommitted(true);\n    }\n  }\n  const handleKeyDown = (event: React.KeyboardEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    if (event.key === 'Enter') {\n      tryCommit();\n    } else if (event.key === 'Escape') {\n      setEditValue(value || '');\n      setCommitted(true);\n      setValidationError(validate ? validate(value || '') : undefined);\n    }\n  }\n  const handleBlur = () => {\n    tryCommit();\n  }\n  return {\n    props: {\n      value: editValue || '',\n      onChange: handleChange,\n      onKeyDown: handleKeyDown,\n      onBlur: handleBlur,\n      className: `${!validationError ? '' : 'InvalidInput'} ${committed ? '' : 'StringEditorUncommited'}`\n    },\n    validationError,\n    editValue,\n    setEditValue: value => {\n      setEditValue(value);\n      setCommitted(false);\n      setValidationError(validate ? validate(value || '') : undefined);\n    }\n  }\n}\n\nexport function ValidationErrorPopdown({ validationError, children }: { validationError: string | undefined, children?: any }) {\n  return <Popdown\n    showPopdown={!!validationError}\n    popdown={() => <div className=\"StringEditorValidationError\">{validationError}</div>}\n    fader={false}\n    >{children}</Popdown>;\n}\n\nexport function StringEditor({ className = '', multiline, readOnly, rows = 1,\n    value, widthMode, onChange, validate, placeholder, spellCheck }: StringEditorProps & NonNullEditorDispatch<string>) {\n  const { props, validationError, editValue } = useStringValidation(value, validate, onChange);\n\n  const cn = `StringEditor ${props.className} ${className}`;\n  let input;\n  if (multiline) {\n    input = (\n      <textarea\n        {...props}\n        className={cn}\n        rows={rows}\n        spellCheck={spellCheck}\n      />\n    );\n  } else {\n    input = (\n      <input\n        {...props}\n        className={cn}\n        type=\"text\"\n        style={{\n          width: widthMode === 'fill' ? '100%' :\n          widthMode === 'fit-content' ? (getSizeOfInput(editValue || placeholder || '', className).width + 20) :\n          '120px' }}\n        readOnly={readOnly}\n        placeholder={placeholder}\n        spellCheck={spellCheck}\n      />\n    );\n  }\n  return <ValidationErrorPopdown validationError={validationError}>{input}</ValidationErrorPopdown>;\n}\n","import * as React from 'react';\nimport './Editors.css';\nimport { EditorTypedef, EditorTypedefRef, EditorTypedefResolver } from './EditorTypedefs';\nimport { StringEditor } from './StringEditor';\nimport { AnyEditor } from './AnyEditor';\nimport { EditorProps } from './EditorProps';\n\nexport function KeyValueLayout({ children, stack, className }: { className?: string, stack?: boolean, children?: any }) {\n  return (\n    <div className={`KeyValueLayout ${stack ? 'KeyValueLayoutStack' : ''} ${className ? className : ''}`}>\n      {children}\n    </div>\n  );\n}\n\nexport function KeyValueLayoutRow({ children, className, keyName, keyElement }: { className?: string, keyName: string, keyElement: any, children?: any }) {\n  return (\n    <div className={`KeyValueLayoutRow ${className ? className : ''}`}>\n      <div className=\"KeyValueLayoutKey\" title={keyName}>\n        {keyElement}\n      </div>\n      <div className=\"KeyValueLayoutValue\">\n        {children}\n      </div>\n    </div>\n  );\n}\n\nexport interface KeyValueEditorChange {\n  oldKey: string;\n  key: string;\n  entryValue: any;\n}\n\ninterface KeyValueType {\n  [key: string]: any\n}\n\ninterface KeyValueEditorProps extends EditorProps<KeyValueType> {\n  onChange: (value: KeyValueType, change: KeyValueEditorChange) => void;\n  value: KeyValueType;\n  valueType: EditorTypedef | EditorTypedefRef;\n\n  stack?: boolean;\n  typedefResolver?: EditorTypedefResolver;\n  valueDefault?: any;\n}\n\nexport function KeyValueEditor({ className, onChange, readOnly, stack, typedefResolver, value, valueType, valueDefault }: KeyValueEditorProps): any {\n  value = value || {};\n  const keys = Object.keys(value);\n  if (keys.indexOf('') === -1) {\n    keys.push('');\n  }\n  return (\n    <KeyValueLayout className={'KeyValueEditor ' + (className || '')} stack={stack}>\n      {keys.map((key, i) => (\n          <KeyValueLayoutRow\n            keyName={key || ''}\n            key={i}\n            keyElement={(\n              <StringEditor\n                readOnly={readOnly}\n                value={key}\n                onChange={newKey => {\n                  newKey = newKey === undefined ? '' : newKey;\n                  const entryValue = value[key] !== undefined ? value[key] : valueDefault;\n                  const newValue = {...value, [newKey]: entryValue };\n                  delete newValue[key];\n                  onChange(newValue, { oldKey: key, key: newKey, entryValue });\n                }}\n                multiline={false}\n                widthMode=\"fit-content\"\n                />\n            )}\n            >\n            <AnyEditor\n              typedef={valueType}\n              value={value[key]}\n              onChange={(entryValue: any) =>\n                onChange({...value, [key]: entryValue }, { oldKey: key, key, entryValue })\n              }\n              typedefResolver={typedefResolver}\n              />\n          </KeyValueLayoutRow>\n      ))}\n    </KeyValueLayout>\n  );\n}\n","import * as React from 'react';\nimport { SketchPicker } from 'react-color';\nimport { Button } from '../Button';\nimport { Popdown } from '../Popdown';\nimport { EditorProps, NonNullEditorDispatch } from './EditorProps';\nimport { RGBA } from '../../Util';\nimport color from 'color';\n\ninterface ColorEditorProps extends EditorProps<RGBA> {\n  title?: string;\n}\ninterface ColorEditorState {\n  showColorEditor: boolean;\n}\n\nexport class ColorEditor extends React.Component<ColorEditorProps & NonNullEditorDispatch<RGBA>, ColorEditorState> {\n  state: ColorEditorState = { showColorEditor: false };\n  render() {\n    const { title } = this.props;\n    const fill = this.props.value ? color({ r: this.props.value.r, g: this.props.value.g, b: this.props.value.b }).toString() : undefined;\n    return (\n      <Popdown\n        className=\"ColorEditor\"\n        showPopdown={this.state.showColorEditor}\n        onClickFader={() => setTimeout(() => this.setState({ showColorEditor: false }), 10)}\n        popdown={() => (\n          <SketchPicker\n            color={this.props.value}\n            onChangeComplete={col => {\n              this.props.onChange(col.rgb);\n            }} />\n        )}>\n        <Button\n          className={this.props.className}\n          fill={fill}\n          onClick={() => !this.props.readOnly && this.setState({ showColorEditor: true })}\n          purpose=\"OpenColorEditor\">\n          {title !== undefined ? title : 'color'}\n        </Button>\n      </Popdown>\n    );\n  }\n}","import * as React from 'react';\nimport { EditorProps, EditorDispatch } from './EditorProps';\n\ninterface FileEditorProps extends EditorProps<File> {\n}\n\nexport class FileEditor extends React.Component<FileEditorProps & EditorDispatch<File>> {\n  render() {\n    return (\n      <input type=\"file\" onChange={e => this.props.onChange(e.target.files![0])} />\n    );\n  }\n}","import * as React from 'react';\nimport { EditorProps, NonNullEditorDispatch } from './EditorProps';\nimport { getSizeOfInput } from './StringEditor';\nimport { Result, isErr, err, ok } from '../../Result';\n\nexport interface SliderEditorOptions {\n  min?: number;\n  max?: number;\n  step?: number;\n  suffix?: string;\n}\n\nexport enum NumberEditorType {\n  INT,\n  FLOAT\n}\nexport interface NumberEditorOptions extends SliderEditorOptions {\n  clamp?: boolean;\n  slider?: boolean;\n  factor?: number;\n  title?: string;\n}\ninterface NumberEditorProps extends EditorProps<number>, NumberEditorOptions {\n  type?: NumberEditorType;\n  onErrorChange?: (error: boolean) => void;\n  formatter?: (value: number) => string;\n  onBlur?: () => void;\n}\ninterface NumberEditorState {\n  error?: boolean;\n  editValue?: string;\n  focused: boolean;\n  committed: boolean;\n}\n\nexport class NumberEditor extends React.Component<NumberEditorProps & NonNullEditorDispatch<number>, NumberEditorState> {\n  constructor(props: NumberEditorProps & NonNullEditorDispatch<number>) {\n    super(props);\n    this.state = { error: false, editValue: this.stringify(), focused: false, committed: true };\n  }\n  get factor() {\n    return this.props.factor !== undefined ? this.props.factor : 1;\n  }\n  parse(text: string) {\n    if (this.props.type === NumberEditorType.INT) {\n      return parseInt(text, 10);\n    } else {\n      return parseFloat(text);\n    }\n  }\n  stringify() {\n    if (this.props.value === undefined) {\n      return '';\n    } else {\n      const value = this.props.value * this.factor;\n      if (this.props.formatter) {\n        return this.props.formatter(value);\n      } else {\n        return '' + value;\n      }\n    }\n  }\n  handleRef = (el: HTMLInputElement | null) => {\n    this.inputRef = el;\n    if (el && document.activeElement === el) {\n      this.setState({ editValue: this.stringify(), focused: true });\n    }\n  }\n  inputRef: HTMLInputElement | null = null;\n  handleFocus = () => {\n    this.setState({ editValue: this.stringify(), focused: true });\n  }\n  handleBlur = () => {\n    this.tryCommit();\n    this.setState({ editValue: undefined, focused: false, error: false, committed: true });\n    if (this.props.onBlur) {\n      this.props.onBlur();\n    }\n  }\n  tryCommit() {\n    const v = this.getValue();\n    if (!isErr(v)) {\n      this.props.onChange(v.value);\n      this.setState({ committed: true });\n    }\n  }\n  getValue = (): Result<number, boolean> => {\n    if (!this.inputRef || this.inputRef.validity.badInput) {\n      return err(true);\n    } else {\n      let val = this.parse(this.inputRef.value) / this.factor;\n      if (this.props.min !== undefined && this.props.clamp !== false) {\n        val = Math.max(this.props.min, val);\n      }\n      if (this.props.max !== undefined && this.props.clamp !== false) {\n        val = Math.min(this.props.max, val);\n      }\n      const error = isNaN(val);\n      if (error) {\n        return err(true);\n      } else {\n        return ok(val);\n      }\n    }\n  }\n  handleChange = (event: React.FormEvent<HTMLInputElement>) => {\n    this.setState({ editValue: (event.target as HTMLInputElement).value, committed: false });\n    const v = this.getValue();\n    if (isErr(v) !== this.state.error && this.props.onErrorChange) {\n      this.props.onErrorChange(isErr(v));\n    }\n    this.setState({ error: isErr(v) });\n  }\n  handleKeyDown = (event: React.KeyboardEvent<HTMLInputElement>) => {\n    if (event.key === 'Enter') {\n      this.tryCommit();\n    } else if (event.key === 'Escape') {\n      this.setState({ editValue: this.stringify(), committed: true, error: false });\n    }\n  }\n  handleSlider = (event: React.FormEvent<HTMLInputElement>) => {\n    this.props.onChange((event.target as HTMLInputElement).valueAsNumber);\n    this.setState({ editValue: this.stringify(), committed: true, error: false });\n  }\n  render() {\n    const { className, slider } = this.props;\n    const value = this.state.focused ? this.state.editValue : this.stringify();\n    const width = this.props.slider ? 80 : // Make fixed with because otherwise the slider moves around when you drag it\n      this.state.error ? undefined :\n      (getSizeOfInput(value || '', undefined).width + 30);\n    const inp = (\n      <input\n        className={`${className && !slider ? className : ''} ${this.state.error ? ' InvalidInput' : ''} ${!this.state.committed ? 'NumberEditorUncommitted' : ''}`}\n        type=\"number\"\n        min={this.props.clamp !== false ? this.props.min : undefined}\n        max={this.props.clamp !== false ? this.props.max : undefined}\n        step={this.props.step}\n        value={value}\n        onChange={this.handleChange}\n        onKeyDown={this.handleKeyDown}\n        style={{ width }}\n        readOnly={this.props.readOnly}\n        onFocus={this.handleFocus}\n        onBlur={this.handleBlur}\n        ref={this.handleRef}\n      />\n    );\n    if (slider) {\n      return (\n        <div className={'NumberRangeEditor ' + (className || '')}>\n          {inp}\n          {this.props.suffix}\n          <input\n            type=\"range\"\n            min={this.props.min}\n            max={this.props.max}\n            step={this.props.step}\n            value={value}\n            onChange={this.handleSlider}\n            readOnly={this.props.readOnly}\n          />\n        </div>\n      );\n    } else {\n      return <span>{inp}{this.props.suffix}</span>;\n    }\n  }\n}\n\nexport function PercentageEditor(props: NumberEditorProps & NonNullEditorDispatch<number>) {\n  return (\n    <NumberEditor\n        factor={100}\n        suffix=\"%\"\n        {...props}\n      />\n  );\n}\n\n\nexport function SliderEditor({ value, onChange, min, max, step, suffix }: EditorProps<number> & NonNullEditorDispatch<number> & SliderEditorOptions) {\n  return <span><input\n    type=\"range\"\n    min={min}\n    max={max}\n    step={step}\n    value={value}\n    onChange={e => onChange(parseFloat(e.target.value))}\n    />{suffix}</span>;\n}","import * as React from 'react';\nimport './Editors.css';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { EditorStructProperties } from './EditorTypedefs';\nimport { arrayReplaceIndex, arrayRemoveIndex } from '../../Util';\nimport { AnyEditor } from '.';\nimport { MaterialIconButton } from '../Button';\n\ninterface TableEditorProps<T> extends EditorProps<T[]> {\n  itemProperties: EditorStructProperties;\n  itemPropertiesLabels?: { [key: string]: string };\n  newItem: () => T;\n}\n\nexport class TableEditor<T> extends React.Component<TableEditorProps<T> & EditorDispatch<T[]>> {\n  render() {\n    const { value = [], onChange, itemProperties, itemPropertiesLabels, newItem } = this.props;\n    return <table className=\"TableEditor\">\n      <tbody>\n        <tr>\n          {Object.keys(itemProperties).map((key, i) => (\n            <th key={i}>{itemPropertiesLabels && itemPropertiesLabels[key] ? itemPropertiesLabels[key] : key}</th>\n          ))}\n        </tr>\n        {value.map((v, i) => (\n          <tr key={i}>\n            {Object.keys(itemProperties).map((key, j) => (\n              <td key={j}>\n                <AnyEditor \n                  typedef={itemProperties[key]}\n                  value={v[key]}\n                  onChange={newValue => onChange(arrayReplaceIndex(value, i, {...(v as any), [key]: newValue}))}\n                  />\n              </td>\n            ))}\n            <td><MaterialIconButton flat={true} icon=\"delete\" purpose=\"Delete\" onClick={() => onChange(arrayRemoveIndex(value, i))} /></td>\n          </tr>\n        ))}\n        <tr>\n          <td><MaterialIconButton flat={true} icon=\"add\" purpose=\"Add\" onClick={() => onChange([...value, newItem()])} /></td>\n        </tr>\n      </tbody>\n    </table>\n  }\n}\n","import * as React from 'react';\nimport { EditorProps, NonNullEditorDispatch } from './EditorProps';\nimport { PixlingTimespanDef, PixlingTimespanDefUnits } from '../../Time';\nimport { NumberEditor } from './NumberEditor';\nimport { EnumEditor, enumEnumVariants } from './PrimitiveEditors';\n\nexport function PixlingTimespanDefEditor({ value, onChange }: EditorProps<PixlingTimespanDef> & NonNullEditorDispatch<PixlingTimespanDef>) {\n  value = value || { value: 1, unit: PixlingTimespanDefUnits.Days };\n  return <span>\n    <NumberEditor value={value.value} onChange={v => onChange({ value: v, unit: value!.unit })} />\n    <EnumEditor \n      value={value.unit} \n      onChange={v => onChange({ value: value!.value, unit: v })} \n      variants={enumEnumVariants(PixlingTimespanDefUnits)}\n      />\n  </span>\n}","import * as React from 'react';\nimport './Editors.css';\nimport { EditorTypedefResolver, EditorTypedefConvertible } from './EditorTypedefs';\nimport { EditorProps, EditorDispatch } from './EditorProps';\nimport { CheckboxEditor, EnumEditor } from './PrimitiveEditors';\nimport { EnumStructEditor } from './EnumStructEditor';\nimport { ObnumEditor } from './ObnumEditor';\nimport { StructEditor, StructEditorChange } from './StructEditor';\nimport { ListEditor } from './ListEditor';\nimport { TupleEditor } from './TupleEditor';\nimport { KeyValueEditor } from './KeyValueEditor';\nimport { ColorEditor } from './ColorEditor';\nimport { editorTypedefConvertibleToTypedef } from './EditorTypedefConvertible';\nimport { FileEditor } from './FileEditor';\nimport { TableEditor } from './TableEditor';\nimport { NumberEditor, NumberEditorType, PercentageEditor, SliderEditor } from './NumberEditor';\nimport { PixlingTimespanDefEditor } from './PixlingTimespanDefEditor';\nimport { StringEditor } from '.';\n\nexport interface AnyEditorProps extends EditorProps<any> {\n  typedef: EditorTypedefConvertible;\n\n  className?: string;\n  typedefResolver?: EditorTypedefResolver;\n}\n\nexport function AnyEditor({ className, onChange, readOnly, typedef, typedefResolver, value }: AnyEditorProps & EditorDispatch<any>): any {\n  typedef = editorTypedefConvertibleToTypedef(typedef, typedefResolver);\n  switch (typedef.metatype) {\n    case 'boolean':\n      if (typedef.asDropDown) {\n        return <EnumEditor\n          className={className}\n          value={value}\n          readOnly={readOnly}\n          variants={[{ value: true, displayName: typedef.asDropDown.true }, { value: false, displayName: typedef.asDropDown.false }]}\n          onChange={onChange}\n          />;\n      } else {\n        return <CheckboxEditor className={className} readOnly={readOnly} value={value || false} onChange={onChange} />;\n      }\n    case 'float':\n      return <NumberEditor className={className} readOnly={readOnly} value={value} onChange={onChange} type={NumberEditorType.FLOAT} {...typedef} />;\n    case 'int':\n      return <NumberEditor className={className} readOnly={readOnly} value={value} onChange={onChange} type={NumberEditorType.INT} {...typedef} />;\n    case 'slider':\n      return <SliderEditor className={className} readOnly={readOnly} value={value} onChange={onChange} {...typedef} />;\n    case 'percentage':\n      return <PercentageEditor className={className} readOnly={readOnly} value={value} onChange={onChange} type={NumberEditorType.FLOAT} min={typedef.min} max={typedef.max} step={typedef.step} slider={typedef.slider} />;\n    case 'string':\n      return <StringEditor className={className} readOnly={readOnly || typedef.readOnly} value={value} onChange={onChange} multiline={!!typedef.multiline} widthMode=\"fit-content\" />;\n    case 'enum': {\n      return <EnumEditor className={className} readOnly={readOnly} value={value} onChange={onChange} defaultValue={typedef.default} variants={typedef.variants} />;\n    }\n    case 'enumstruct':\n      return (\n        <EnumStructEditor\n          className={className}\n          readOnly={readOnly}\n          value={value}\n          variants={typedef.variants}\n          onChange={onChange}\n          typedefResolver={typedefResolver}\n          />\n      );\n    case 'obnum':\n      return (\n        <ObnumEditor className={className} readOnly={readOnly} value={value} onChange={onChange} variants={typedef.variants} typedefResolver={typedefResolver} />\n      );\n    case 'struct':\n      return (\n        <StructEditor\n          className={className}\n          readOnly={readOnly}\n          value={value}\n          properties={typedef.properties}\n          onChange={(change: StructEditorChange) => onChange({...value, [change.property]: change.value})}\n          typedefResolver={typedefResolver}\n          layout={typedef.layout}\n          />\n      );\n    case 'list': {\n      const itemType = typedef.itemType;\n      return <ListEditor\n        className={className}\n        readOnly={readOnly || typedef.readOnly}\n        value={value}\n        onChange={onChange}\n        itemFactory={typedef.newItem}\n        keyFromItem={typedef.keyFromItem}\n        acceptItemDrop={typedef.acceptItemDrop}\n        itemRenderer={props => (\n          <AnyEditor {...props} readOnly={readOnly} typedef={itemType} typedefResolver={typedefResolver} />\n        )}\n        />;\n    }\n    case 'table':\n      return <TableEditor\n        value={value}\n        onChange={onChange}\n        itemProperties={typedef.itemProperties}\n        itemPropertiesLabels={typedef.itemPropertiesLabels}\n        newItem={typedef.newItem}\n        />;\n    case 'tuple':\n      return <TupleEditor className={className} readOnly={readOnly} value={value} onChange={onChange} itemTypes={typedef.itemTypes} typedefResolver={typedefResolver} />;\n    case 'keyvalue':\n      return <KeyValueEditor className={className} readOnly={readOnly} value={value} onChange={onChange} valueType={typedef.valueType} valueDefault={typedef.valueDefault} typedefResolver={typedefResolver} />;\n    case 'select':\n      const key = typedef.propertyKey;\n      return (\n        <AnyEditor\n          className={className}\n          readOnly={readOnly}\n          typedef={typedef.propertyType}\n          value={value !== undefined ? value[key] : undefined}\n          onChange={(newValue: any) => onChange({...value, [key]: newValue })}\n          />\n      );\n    case 'map':\n      return (\n        <AnyEditor\n          className={className}\n          readOnly={readOnly}\n          typedef={typedef.mappedType}\n          value={typedef.map(value)}\n          onChange={onChange}\n          />\n      );\n    case 'color':\n      return <ColorEditor className={className} readOnly={readOnly} value={value} onChange={onChange}  />;\n    case 'file':\n      return <FileEditor onChange={onChange}  />;\n    case 'pixlingTimespanDef':\n      return <PixlingTimespanDefEditor value={value} onChange={onChange} />;\n    default: {\n      return <i>Unrecognized meta type</i>;\n    }\n  }\n}\n","import { EditorTypedefConvertible, EditorTypedefResolver, EditorTypedef } from \"./EditorTypedefs\";\n\nexport function editorTypedefConvertibleToTypedef(typedef: EditorTypedefConvertible, typedefResolver?: EditorTypedefResolver): EditorTypedef {\n  if (typeof typedef === 'string') {\n    if (!typedefResolver) {\n      throw new Error('Cannot resolve type reference without typedefResolver');\n    }\n    const res = typedefResolver(typedef);\n    if (!res) {\n      throw new Error('Unrecognized type: ' + typedef);\n    }\n    return res;\n  } else if (typeof typedef === 'function') {\n    return typedef();\n  } else {\n    return typedef;\n  }\n}\n","import * as React from \"react\";\nimport './Admin.css';\nimport { useFirebaseStreamDocument, useFirebaseStreamQuery, FirebaseLoading } from \"../Components/Firebase\";\nimport firebase from 'firebase/app';\nimport moment from 'moment';\nimport { DbUser, DbFeedback, DbItemInstance, full, ItemKeys, CurrentSeason, Db, DbUserProfile, DbSession, DbCreature, DbCreatureBrain, DbBattle, DbTrainingStats, DbId, DbTrainingStatsTeam, DbBattleground, parseTeamId, DbTeam, getTeamId } from 'db';\nimport { BarChart, XAxis, YAxis, Bar, Tooltip } from 'recharts';\nimport { Button } from \"../Components/Button\";\nimport { ActionMenu } from \"../Components/Menu\";\nimport { version } from \"../version\";\nimport { FormatNumberPrecision } from \"../Components/FormatNumberPrecision\";\nimport { getBrowser, keysOfEnum, stringToRGBHex } from \"../Util\";\nimport { EnumEditor, StringEditor } from \"../Components/Editors\";\nimport { ProgressBar } from \"../Components/ProgressBar\";\nimport { Checkbox } from \"../Components/Checkbox\";\nimport { Column, Row, Block, ItemsRow, Section } from \"../Components/Layout\";\nimport { Link, RoutingHistory } from \"../Components/Routing\";\nimport { Plot } from \"../Components/Plot\";\nimport { clamp } from \"../Math/Math\";\n\nexport function AdminUserNameComponent({ userId }: { userId: string }) {\n  const user = useFirebaseStreamDocument<DbUser>(Db.users, userId);\n  const userProfile = useFirebaseStreamDocument<DbUserProfile>(Db.userProfiles, userId);\n  if (user.status === 'loading' || userProfile.status === 'loading') {\n    return <span>Loading...</span>;\n  }\n  if (user.status === 'no-such-document' || userProfile.status === 'no-such-document') {\n    return <span>User doesn't exist</span>;\n  }\n  const ageDays = moment().diff(user.value.created.toDate(), 'days');\n  return <span title={`User signed up ${moment(user.value.created.toDate()).fromNow()}`}>\n    <Link to={`/admin/user/${userId}`}>{userProfile.value.displayName}</Link>{ageDays <= 1 ? '' : ageDays < 3 ? '' : ageDays < 14 ? '' : ''}{user.value.stripeSubscription && ''}{user.value.vip && ''}{user.value.alphaTester && ''}{user.value.steamIsOwner && ''}\n    <ActionMenu actions={[\n      { title: 'User page', onClick: () => RoutingHistory.push(`/user/${userId}`) },\n      { title: 'Copy user id', onClick: () => navigator.clipboard.writeText(userId) },\n    ]} />\n  </span>;\n}\n\nexport function AdminUser({ userId }: { userId: string }) {\n  const user = useFirebaseStreamDocument<DbUser>(Db.users, userId);\n  const items = useFirebaseStreamQuery<DbItemInstance>({\n    collection: Db.items,\n    where: [['ownerId', '==', userId], ['deleted', '==', false], ['season', '==', CurrentSeason]]\n  });\n  const creatures = useFirebaseStreamQuery<DbCreature>({\n    collection: Db.creatures,\n    where: [['ownerId', '==', userId], ['deleted', '==', false], ['season', '==', CurrentSeason]]\n  });\n  if (user.status !== 'loaded' || items.status !== 'loaded' || creatures.status !== 'loaded') {\n    return <FirebaseLoading pending={[user]} />;\n  }\n  return <div className=\"Page AdminPage\"><Column>\n    <h1><AdminUserNameComponent userId={userId} /></h1>\n    <Section>\n      <Link to={`/admin/user/${userId}/battles`}>Battles</Link>\n    </Section>\n    {items.values.map((item, i) => <Row>\n      {item.item}\n    </Row>)}\n    <Block>Add: {ItemKeys.map(itemKey => <Button key={itemKey} onClick={() => {\n      firebase.firestore().collection(Db.items).add(full<DbItemInstance>({\n        ownerId: userId,\n        season: CurrentSeason,\n        created: firebase.firestore.Timestamp.now(),\n        item: itemKey,\n        creatureId: '',\n        deleted: false,\n      }))\n    }}>{itemKey}</Button>\n      )}</Block>\n    <pre>{JSON.stringify(user, null, 2)}</pre>\n    <b>Creatures</b>\n    {creatures.values.map(creature => <Block key={creature.id}>\n      <Link to={`/admin/creature/${creature.id}`}>{creature.name}</Link> <Button onPerform={async () => {\n        const brain = (await firebase.firestore().collection(Db.creatureBrains).doc(creature.id).get()).data() as DbCreatureBrain;\n        window.navigator.clipboard.writeText(JSON.stringify({\n          hiddenLayerBiases: new Float32Array(brain.hiddenLayerBiases.toUint8Array().buffer),\n          hiddenLayerWeights: new Float32Array(brain.hiddenLayerWeights.toUint8Array().buffer),\n          memoryLayerBiases: new Float32Array(brain.memoryLayerBiases.toUint8Array().buffer),\n          memoryLayerWeights: new Float32Array(brain.memoryLayerWeights.toUint8Array().buffer),\n          outputLayerBiases: new Float32Array(brain.outputLayerBiases.toUint8Array().buffer),\n          outputLayerWeights: new Float32Array(brain.outputLayerWeights.toUint8Array().buffer),\n        }, null, 2));\n      }}>Copy brain</Button>\n    </Block>)}\n    <AdminUserBattleGroup userId={userId} battleground={DbBattleground.Solo} />\n    <AdminUserBattleGroup userId={userId} battleground={DbBattleground.Duo} />\n    <AdminUserBattleGroup userId={userId} battleground={DbBattleground.Team} />\n  </Column></div>;\n}\nfunction AdminUserBattleGroup({ userId, battleground }: { userId: string, battleground: DbBattleground }) {\n  const team = useFirebaseStreamDocument<DbTeam>(Db.teams, getTeamId(userId, CurrentSeason, battleground));\n  if (team.status !== 'loaded') {\n    return null;\n  }\n  return <Block>\n    <h3>{battleground}</h3>\n    <pre>{JSON.stringify(team.value, null, 2)}</pre>\n  </Block>;\n}\nexport function AdminUserBattleHistory({ userId }: { userId: string }) {\n  const battles = useFirebaseStreamQuery<DbBattle>({\n    collection: Db.battles,\n    where: [['userId', '==', userId], ['season', '==', CurrentSeason]]\n  });\n  if (battles.status !== 'loaded') {\n    return <FirebaseLoading pending={[battles]} />;\n  }\n  return <div className=\"Page AdminPage\"><Column>\n    <b>Battles</b>\n    <Block>\n      <table>\n        <tbody>\n          {battles.values.sort((a, b) => b.created.toMillis() - a.created.toMillis()).map(battle => <tr key={battle.id}>\n            <td><AdminUserNameComponent userId={parseTeamId(battle.awayTeamId).userId} /></td>\n            <td>{moment(battle.created.toDate()).fromNow()}</td>\n            <td>{battle.battleground}</td>\n          </tr>)}\n        </tbody>\n      </table>\n    </Block>\n  </Column></div>;\n}\n\nfunction buildSessionsByUser(simulations: DbSession[]) {\n  const simsByUser: { [key: string]: { sims: DbSession[] } } = {};\n  for (const simulation of simulations) {\n    if (!simsByUser[simulation.userId]) {\n      simsByUser[simulation.userId] = { sims: [] }\n    }\n    simsByUser[simulation.userId].sims.push(simulation);\n  }\n  return simsByUser;\n}\nfunction buildFeedbackByUser(feedbacks: DbFeedback[]) {\n  const feedbackByUser: { [key: string]: DbFeedback[] } = {};\n  for (const feedback of feedbacks) {\n    if (!feedbackByUser[feedback.userId]) {\n      feedbackByUser[feedback.userId] = [];\n    }\n    feedbackByUser[feedback.userId].push(feedback);\n  }\n  return feedbackByUser;\n}\n\nconst DerkStartDate = new Date('2019-11-12');\n\nexport function AdminUsers() {\n  const sessions = useFirebaseStreamQuery<DbSession>({\n    collection: Db.sessions,\n    where: []\n  });\n  const users = useFirebaseStreamQuery<DbUser>({\n    collection: Db.users,\n    where: []\n  });\n  const [sort, setSort] = React.useState<boolean>(false);\n  const [lastSeason, setLastSeason] = React.useState<boolean>(false);\n  if (sessions.status !== 'loaded' || users.status !== 'loaded') {\n    return <FirebaseLoading pending={[sessions, users]} />\n  }\n  const simsByUser = buildSessionsByUser(sessions.values\n    .filter(x => x.started.toDate() > DerkStartDate &&\n    (!lastSeason || x.season === CurrentSeason)));\n  const userById = {};\n  for (const user of users.values) {\n    userById[user.id] = user;\n  }\n  const data = Object.keys(simsByUser)\n    .filter(uid => userById[uid])\n    .sort((uida, uidb) => userById[uida].created < userById[uidb].created ? 1 : -1)\n    .map(uid => ({\n      uid,\n      interacting: simsByUser[uid].sims.reduce((p, x) => p + x.minutesInteracting, 0) / 60,\n      running: simsByUser[uid].sims.reduce((p, x) => p + (x.lastActive.toMillis() - x.started.toMillis()) / (1000*60), 0) / 60,\n    }));\n  const maxInteracting = data.reduce((p, x) => Math.max(p, x.interacting), 0);\n  const maxRunning = data.reduce((p, x) => Math.max(p, x.running), 0);\n  if (sort) {\n    data.sort((a, b) => b.interacting - a.interacting);\n  }\n  return <div className=\"Page\">\n    <Checkbox value={sort} onChange={setSort}>Sort</Checkbox>\n    <Checkbox value={lastSeason} onChange={setLastSeason}>Last season</Checkbox>\n    <table>\n    <tbody>\n      <tr>\n        <th>Name</th>\n        <th>h interacting</th>\n        <th>h running</th>\n      </tr>\n    {data\n      .map(({ uid, interacting, running }) => <tr>\n        <td><AdminUserNameComponent userId={uid} /></td>\n        <td><ProgressBar progress={interacting / maxInteracting}><FormatNumberPrecision value={interacting} /></ProgressBar></td>\n        <td><ProgressBar progress={running / maxRunning}><FormatNumberPrecision value={running} /></ProgressBar></td>\n      </tr>)}\n    </tbody>\n  </table></div>\n}\n\n\nexport function AdminCreature({ creatureId }: { creatureId: string }) {\n  const creature = useFirebaseStreamDocument<DbCreature>(Db.creatures, creatureId);\n  if (creature.status !== 'loaded') {\n    return <FirebaseLoading pending={[creature]} />;\n  }\n  return <div className=\"Page AdminPage\"><Column>\n    <pre>{JSON.stringify(creature, null, 2)}</pre>\n  </Column></div>;\n}\n\nenum PeriodType {\n  _7Day,\n  _28Day,\n  Daily,\n  Weekly,\n  Monthly\n}\nconst PeriodTypeVariants = keysOfEnum(PeriodType).map((k) => ({ value: PeriodType[k], displayName: k }));\n\nfunction groupPeriod(date: Date, type: PeriodType) {\n  if (type === PeriodType._7Day || type === PeriodType._28Day) {\n    const daysSinceNow = moment().diff(date, 'days');\n    const periodNum = Math.floor(daysSinceNow / (type === PeriodType._7Day ? 7 : 28));\n    return {\n      period: '' + periodNum,\n      startDate: moment().subtract((periodNum + 1) * (type === PeriodType._7Day ? 7 : 28), 'days')\n    }\n  } else {\n    const format = type === PeriodType.Daily ? 'YYYY-MM-DD'\n      : type === PeriodType.Weekly ? 'YYYY-WW'\n      : 'YYYY-MM';\n    const period = moment(date).format(format);\n    return {\n      period,\n      startDate: moment(period, format),\n    }\n  }\n}\n\nexport function AdminFunnel() {\n  const [periodSel, setPeriodSel] = React.useState<PeriodType>(PeriodType._7Day);\n  const [fromFirstSim, setFromFirstSim] = React.useState<boolean>(false);\n  const sessions = useFirebaseStreamQuery<DbSession>({\n    collection: Db.sessions,\n    where: []\n  });\n  const users = useFirebaseStreamQuery<DbUser>({\n    collection: Db.users,\n    where: []\n  });\n  const feedbacks = useFirebaseStreamQuery<DbFeedback>({\n    collection: Db.feedback,\n    where: []\n  });\n  if (sessions.status !== 'loaded' || users.status !== 'loaded' || feedbacks.status !== 'loaded') {\n    return <FirebaseLoading pending={[sessions, users, feedbacks]} />\n  }\n  const simsByUser = buildSessionsByUser(sessions.values\n    .sort((a, b) => a.started < b.started ? -1 : 1)\n    .filter(x => x.started.toDate() > DerkStartDate));\n  const feedbackByUser = buildFeedbackByUser(feedbacks.values\n    .filter(x => x.time.toDate() > DerkStartDate));\n  const periods = {};\n  for (const user of users.values) {\n    let userStartDate = user.created.toDate();\n    if (fromFirstSim && simsByUser[user.id] && simsByUser[user.id].sims.length > 0) {\n      userStartDate = simsByUser[user.id].sims[0].started.toDate();\n    }\n    if (userStartDate > DerkStartDate) {\n      const { period, startDate } = groupPeriod(userStartDate, periodSel);\n      if (!periods[period]) {\n        periods[period] = {\n          startDate: startDate.format('YYYY-MM-DD'),\n          newUsers: 0,\n          newUsersWithSim: 0,\n          playtimeWeekOne: 0,\n          playtimeDayOne: 0,\n          confused: 0,\n          loveThis: 0\n        };\n      }\n      periods[period].newUsers++;\n      if (simsByUser[user.id]) {\n        periods[period].newUsersWithSim++;\n        const weekOne = moment(userStartDate).add(7, 'days').toDate();\n        periods[period].playtimeWeekOne += simsByUser[user.id].sims.reduce((p, x) => p +\n          (x.started.toDate() < weekOne ? x.minutesInteracting : 0), 0) / 60;\n\n        const dayOne = moment(userStartDate).add(1, 'days').toDate();\n        periods[period].playtimeDayOne += simsByUser[user.id].sims.reduce((p, x) => p +\n          (x.started.toDate() < dayOne ? x.minutesInteracting : 0), 0) / 60;\n      }\n      if (feedbackByUser[user.id]) {\n        periods[period].confused += feedbackByUser[user.id].reduce((p, x) => p ||\n          x.category === 'confused', false) ? 1 : 0;\n        periods[period].loveThis += feedbackByUser[user.id].reduce((p, x) => p ||\n          x.category === 'love-this', false) ? 1 : 0;\n      }\n    }\n  }\n  const data = Object.keys(periods)\n    .sort((a, b) => periods[a].startDate < periods[b].startDate ? 1 : -1)\n    .map(k => periods[k])\n    .map(({ startDate, newUsers, newUsersWithSim, playtimeDayOne, playtimeWeekOne, confused, loveThis }) => ({\n      startDate,\n      newUsers,\n      startConv: newUsersWithSim / newUsers,\n      newUsersWithSim,\n      avgPlaytimeDayOne: playtimeDayOne / newUsersWithSim,\n      playtimeDayOne,\n      avgPlaytimeWeekOne: playtimeWeekOne / newUsersWithSim,\n      playtimeWeekOne,\n      confused: confused / newUsersWithSim,\n      loveThis: loveThis / newUsersWithSim\n    }));\n  const maxNewUsers = data.reduce((p, x) => Math.max(p, x.newUsers), 0);\n  const maxStartConv = data.reduce((p, x) => Math.max(p, x.startConv), 0);\n  const maxNewUsersWithSim = data.reduce((p, x) => Math.max(p, x.newUsersWithSim), 0);\n  const maxAvgPlaytimeDayOne = data.reduce((p, x) => Math.max(p, x.avgPlaytimeDayOne), 0);\n  const maxPlaytimeDayOne = data.reduce((p, x) => Math.max(p, x.playtimeDayOne), 0);\n  const maxAvgPlaytimeWeekOne = data.reduce((p, x) => Math.max(p, x.avgPlaytimeWeekOne), 0);\n  const maxPlaytimeWeekOne = data.reduce((p, x) => Math.max(p, x.playtimeWeekOne), 0);\n  const maxConfused = data.reduce((p, x) => Math.max(p, x.confused), 0);\n  const maxLoveThis = data.reduce((p, x) => Math.max(p, x.loveThis), 0);\n  return <div className=\"Page\">\n    <Checkbox value={fromFirstSim} onChange={setFromFirstSim}>From first sim</Checkbox>&nbsp;&nbsp;\n    <EnumEditor value={periodSel} onChange={setPeriodSel} variants={PeriodTypeVariants} />\n    <table>\n    <tbody>\n      <tr>\n        <th>{periodSel}</th>\n        <th>New users</th>\n        <th>Start sim rate</th>\n        <th>New users with sim</th>\n        <th>Avg D1 playtime [h]</th>\n        <th>D1 Playtime [h]</th>\n        <th>Avg W1 playtime [h]</th>\n        <th>W1 Playtime [h]</th>\n        <th>Feedback confused</th>\n        <th>Feedback love-this</th>\n      </tr>\n    {data.map(period => <tr>\n        <td>{period.startDate}</td>\n        <td><ProgressBar progress={period.newUsers / maxNewUsers}><FormatNumberPrecision value={period.newUsers} /></ProgressBar></td>\n        <td><ProgressBar progress={period.startConv / maxStartConv}><FormatNumberPrecision value={100 * period.startConv} />%</ProgressBar></td>\n        <td><ProgressBar progress={period.newUsersWithSim / maxNewUsersWithSim}><FormatNumberPrecision value={period.newUsersWithSim} /></ProgressBar></td>\n        <td><ProgressBar progress={period.avgPlaytimeDayOne / maxAvgPlaytimeDayOne}><FormatNumberPrecision value={period.avgPlaytimeDayOne} /></ProgressBar></td>\n        <td><ProgressBar progress={period.playtimeDayOne / maxPlaytimeDayOne}><FormatNumberPrecision value={period.playtimeDayOne} /></ProgressBar></td>\n        <td><ProgressBar progress={period.avgPlaytimeWeekOne / maxAvgPlaytimeWeekOne}><FormatNumberPrecision value={period.avgPlaytimeWeekOne} /></ProgressBar></td>\n        <td><ProgressBar progress={period.playtimeWeekOne / maxPlaytimeWeekOne}><FormatNumberPrecision value={period.playtimeWeekOne} /></ProgressBar></td>\n        <td><ProgressBar progress={period.confused / maxConfused}><FormatNumberPrecision value={100*period.confused} />%</ProgressBar></td>\n        <td><ProgressBar progress={period.loveThis / maxLoveThis}><FormatNumberPrecision value={100*period.loveThis} />%</ProgressBar></td>\n      </tr>)}\n    </tbody>\n  </table></div>\n}\n\nexport function AdminSessionListContainer() {\n  const sessions = useFirebaseStreamQuery<DbSession>({\n    collection: Db.sessions,\n    where: [],\n    orderBy: [{ field: 'lastActive', desc: true }],\n    limit: 100\n  });\n  if (sessions.status !== 'loaded') {\n    return <FirebaseLoading pending={[sessions]} />;\n  }\n  return <div className=\"Page AdminPage\">\n    <div className=\"PageContent\">\n      <RerenderInterval><table className=\"AdminWorldListContainer\">\n        <tr>\n          <th>Owner</th>\n          <th>Last updated</th>\n          <th>Age</th>\n          <th>Trainings</th>\n          <th>Battles</th>\n          <th>Interacting</th>\n          <th>Version</th>\n          <th />\n        </tr>\n        {sessions.values.map(session => (\n          <tr key={session.id} className={session.userId === 'Y3nwMHlcaHRa2sLfGI3OgIhsDK53' ? 'AdminWorldListContainerMinimize' : ''}>\n            <td><AdminUserNameComponent userId={session.userId} /></td>\n            <td>{moment(session.lastActive.toDate()).fromNow()}</td>\n            <td>{(moment.duration(moment(session.lastActive.toDate()).diff(session.started.toDate())) as any).format()}</td>\n            <td>{session.trainings}</td>\n            <td>{session.battles}</td>\n            <td>{session.minutesInteracting} min</td>\n            <td>\n              <small style={{ color: session.appVersion !== version.build ? 'yellow' : undefined }}>{session.appVersion}</small>\n            </td>\n            <td>\n              <BrowserIcon browser={session.browser as ReturnType<typeof getBrowser>} />\n              {session.isMobile && <i className=\"fas fa-mobile-alt\" />}\n            </td>\n          </tr>\n        ))}\n      </table></RerenderInterval>\n    </div>\n  </div>;\n}\n\nfunction BrowserIcon({ browser }: { browser: ReturnType<typeof getBrowser> | undefined }) {\n  switch (browser) {\n    case 'Chrome': return <i className=\"fab fa-chrome\" />;\n    case 'Edge': return <i className=\"fab fa-edge\" />;\n    case 'Firefox': return <i className=\"fab fa-firefox\" />;\n    case 'Safari': return <i className=\"fab fa-safari\" />;\n    default: return <span>?</span>;\n  }\n}\n\nexport function AdminLatestStoredPixlings() {\n  return null;\n  // return <table><tbody>\n  //   <tr>\n  //     <th>Time</th>\n  //     <th>Owner</th>\n  //     <th>Version</th>\n  //   </tr>\n  //   <FirebaseStreamQuery<DbStoredPixling>\n  //     loadKey=\"\"\n  //     onLoad={() => db.collection('pixlings').where('autoUploaded', '==', true).orderBy('created', 'desc')}\n  //     docToValue={doc => doc.data() as DbStoredPixling}\n  //     >\n  //     {docs => docs.map(doc => <tr key={doc.id}>\n  //       <td>{moment(doc.created.toDate()).fromNow()}</td>\n  //       <td><AdminUserNameComponent userId={doc.ownerId} /></td>\n  //       <td>{doc.compabilityVersion}</td>\n  //     </tr>)}\n  //   </FirebaseStreamQuery>\n  // </tbody></table>;\n}\n\nexport function AdminGraphs() {\n  const users = useFirebaseStreamQuery<DbUser>({\n    collection: Db.users,\n    where: []\n  });\n  const sessions = useFirebaseStreamQuery<DbSession>({\n    collection: Db.sessions,\n    where: []\n  });\n  const [showAll, setShowAll] = React.useState<boolean>(false);\n  const [periodSel, setPeriodSel] = React.useState<PeriodType>(PeriodType._7Day);\n  if (users.status !== 'loaded' || sessions.status !== 'loaded') {\n    return <FirebaseLoading pending={[users, sessions]} />;\n  }\n\n  return <div className=\"Page\">\n    <div className=\"PageContent\">\n      <h1>Graphs</h1>\n      <EnumEditor value={periodSel} onChange={setPeriodSel} variants={PeriodTypeVariants} />\n      <Button toggled={showAll} onClick={() => setShowAll(!showAll)}>Show all</Button>\n      <h3>Active users</h3>\n      <DateGraph data={activeUsersFromSims(sessions.values, showAll, periodSel)} />\n      <h3>Minutes interacting</h3>\n      <DateGraph data={minutesInteractingFromSims(sessions.values, showAll, periodSel)} />\n      <h3>New users</h3>\n      <DateGraph data={newUsersFromUsers(users.values, showAll, periodSel)} />\n    </div>\n  </div>;\n}\n\nfunction activeUsersFromSims(sessions: DbSession[], all: boolean, period: PeriodType): Array<{ date: string, value: number }> {\n  if (!all) {\n    sessions = sessions.filter(x => x.started.toDate() >= DerkStartDate);\n  }\n  sessions = sessions.filter(x => x.minutesInteracting > 1);\n  const data: { [key: string]: { date: moment.Moment, users: { [id: string]: boolean } } } = {};\n  for (const sim of sessions) {\n    const g = groupPeriod(sim.started.toDate(), period);\n    if (!data[g.period]) {\n      data[g.period] = {\n        date: g.startDate,\n        users: {}\n      }\n    }\n    data[g.period].users[sim.userId] = true;\n  }\n  return Object.keys(data)\n    .map(k => ({ date: data[k].date, value: Object.keys(data[k].users).length }))\n    .sort((a, b) => a.date.toDate() < b.date.toDate() ? -1 : 1)\n    .map(x => ({ date: x.date.format('YYYY-MM-DD'), value: x.value }));\n}\n\nfunction minutesInteractingFromSims(sessions: DbSession[], all: boolean, period: PeriodType): Array<{ date: string, value: number }> {\n  if (!all) {\n    sessions = sessions.filter(x => x.started.toDate() >= DerkStartDate);\n  }\n  const data: { [key: string]: { date: moment.Moment, value } } = {};\n  for (const sim of sessions) {\n    const g = groupPeriod(sim.started.toDate(), period);\n    if (!data[g.period]) {\n      data[g.period] = {\n        date: g.startDate,\n        value: 0\n      }\n    }\n    data[g.period].value += sim.minutesInteracting;\n  }\n  return Object.keys(data)\n    .map(k => ({ date: data[k].date, value: data[k].value }))\n    .sort((a, b) => a.date.toDate() < b.date.toDate() ? -1 : 1)\n    .map(x => ({ date: x.date.format('YYYY-MM-DD'), value: x.value }));\n}\n\nfunction newUsersFromUsers(users: DbUser[], all: boolean, period: PeriodType): Array<{ date: string, value: number }> {\n  if (!all) {\n    users = users.filter(x => x.created.toDate() >= DerkStartDate);\n  }\n  const data: { [key: string]: { date: moment.Moment, value: number } } = {};\n  for (const user of users) {\n    const g = groupPeriod(user.created.toDate(), period);\n    if (!data[g.period]) {\n      data[g.period] = {\n        date: g.startDate,\n        value: 0\n      }\n    }\n    data[g.period].value++;\n  }\n  return Object.keys(data)\n    .map(k => ({ date: data[k].date, value: data[k].value }))\n    .sort((a, b) => a.date.toDate() < b.date.toDate() ? -1 : 1)\n    .map(x => ({ date: x.date.format('YYYY-MM-DD'), value: x.value }));\n}\n\nfunction DateGraph({ data }: { data: Array<{ date: string, value: number }> }) {\n  return <BarChart width={800} height={300} data={data}>\n    <XAxis dataKey=\"date\" />\n    <YAxis yAxisId={0} dataKey=\"value\" orientation=\"right\" />\n    <Bar yAxisId={0} type=\"monotone\" dataKey=\"value\" fill=\"#8884d8\" />\n    <Tooltip content={({ payload }) => payload && payload.length > 0 ?\n      <span>\n        {moment(payload[0].payload.date).format('D MMM YYYY')}<br />\n        Value: {payload[0].payload.value}<br/>\n      </span> : null} />\n  </BarChart>\n}\n\nexport function AdminFeedbackQueue() {\n  return null;\n  // return <div className=\"Page AdminFeedbackQueue\">\n  //   <div className=\"PageContent\">\n  //     <h1>Feedback</h1>\n  //     <FirebaseStreamQuery<DbFeedback & { id: string }>\n  //       loadKey={''}\n  //       onLoad={() => db.collection(Db.feedback).where('resolved', '==', false).orderBy('time', 'desc')}\n  //       docToValue={doc => ({...doc.data(), id: doc.id })}\n  //       >\n  //       {feedbacks => feedbacks.map(feedback => <div key={feedback.id} className=\"AdminFeedback\">\n  //         <div><AdminUserNameComponent userId={feedback.userId} />  {feedback.category} &nbsp;\n  //           {moment(feedback.time.toDate()).fromNow()} &nbsp;\n  //           <Button flat={true} onClick={() => updateDbFeedback(feedback.id, { resolved: true, resolution: 'ignore' })} purpose=\"IgnoreFeedback\">Ignore</Button> &nbsp;\n  //           <Button flat={true} onClick={() => updateDbFeedback(feedback.id, { resolved: true, resolution: 'fixed' })} purpose=\"FixedFeedback\">Fixed</Button>\n  //         </div>\n  //         {feedback.comment}\n  //       </div>)}\n  //     </FirebaseStreamQuery>\n  //   </div>\n  // </div>;\n}\n\n\nclass RerenderInterval extends React.Component {\n  componentDidMount() {\n    this.timer = window.setInterval(() => this.forceUpdate(), 1000);\n  }\n  timer?: number;\n  componentWillUnmount() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = undefined;\n    }\n  }\n  render() {\n    return this.props.children;\n  }\n}\n\nfunction normalizeTrainStatsTeam(team: DbTrainingStatsTeam) {\n  const nCreatures = team.creatures.length;\n  return {\n    ...team,\n    nCreatures,\n    nUnits: team.crabs + team.ducks + team.scarecrows + team.turtles + nCreatures,\n    minGeneration: (team.creatures.length > 0 ? team.creatures.map(x => x.generation).reduce((p, x) => Math.min(p, x)) : 0),\n    maxGeneration: (team.creatures.length > 0 ? team.creatures.map(x => x.generation).reduce((p, x) => Math.max(p, x)) : 0),\n  }\n}\n\nfunction trainingStatsTeamSummary(team: DbTrainingStatsTeam, specificGeneration = true, includeItems = true) {\n  const t = normalizeTrainStatsTeam(team);\n  return [\n    ...t.creatures.map(c => `${includeItems ? c.items.join('/') : ''}:${specificGeneration ? c.generation : (c.generation === 0 ? '0' : '>')}`),\n    t.scarecrows > 0 ? `${t.scarecrows} scarecrows` : undefined,\n    t.crabs > 0 ? `${t.crabs} crabs` : undefined,\n    t.turtles > 0 ? `${t.turtles} turtles` : undefined,\n    t.ducks > 0 ? `${t.ducks} ducks` : undefined,\n  ].filter(x => x).join(', ');\n}\n\nfunction derivedTrainingStats(stat: DbTrainingStats) {\n  const lastRounds = stat.winPercs.slice(-5);\n  return {\n    ...stat,\n    rounds: stat.winPercs.length,\n    startWins: stat.winPercs[0],\n    endWins: lastRounds.length > 0 ? (lastRounds.reduce((p, x) => p + x) / lastRounds.length) : 0\n  }\n}\n\nfunction seriesAvgSmoothed(data: number[], count = 5) {\n  return data.map((_, i) => {\n    const slice = data.slice(Math.max(0, i + 1 - count), i + 1);\n    return slice.reduce((p, x) => p + x) / slice.length;\n  })\n}\n\nfunction seriesTrailingSmoothed(data: number[], strength = 0.9) {\n  const res = [data[0]];\n  for (let i=1; i < data.length; i++) {\n    res.push(res[i - 1] * strength + data[i] * (1 - strength));\n  }\n  return res;\n}\n\nfunction TrainingStatsSummary({ stat }: { stat: DbTrainingStats & DbId }) {\n  const { startWins, endWins, winPercs, tiePercs } = derivedTrainingStats(stat);\n  return <Row>\n    <Column>\n      <Block>From {Math.round(100 * startWins)}% win to {Math.round(100 * endWins)}%</Block>\n      <Block>Rounds: {winPercs.length}</Block>\n      <Block>Home: {trainingStatsTeamSummary(stat.home)}</Block>\n      <Block>Away: {trainingStatsTeamSummary(stat.away)}</Block>\n      <Block>{stat.appBuild}</Block>\n      <Block><AdminUserNameComponent userId={stat.userId} /></Block>\n      <Plot lines={[\n        { data: winPercs, label: 'Wins', color: 'green', yMin: 0, yMax: 1 },\n        { data: seriesAvgSmoothed(winPercs), label: 'Wins 5', color: 'yellow', yMin: 0, yMax: 1 },\n        { data: seriesAvgSmoothed(winPercs, 20), label: 'Wins 20', color: 'blue', yMin: 0, yMax: 1 },\n        { data: seriesTrailingSmoothed(winPercs), label: 'Wins trailing 0.9', color: 'pink', yMin: 0, yMax: 1 },\n        { data: seriesTrailingSmoothed(winPercs, 0.95), label: 'Wins trailing 0.95', color: 'cyan', yMin: 0, yMax: 1 },\n        { data: tiePercs, label: 'Ties', color: 'grey', yMin: 0, yMax: 1 },\n      ]} />\n    </Column>\n    <Block><pre>{stat.experiment ?? ''}</pre></Block>\n  </Row>\n}\n\nenum TrainStatsScatterPlotKind {\n  StartWinEndWin = 'StartWinEndWin',\n  RoundsEndWin = 'RoundsEndWin'\n}\n\nfunction TrainStatsScatterPlot({ stats, kind = TrainStatsScatterPlotKind.StartWinEndWin }: { stats: Array<DbTrainingStats & DbId>, kind?: TrainStatsScatterPlotKind }) {\n  const [hover, setHover] = React.useState<DbTrainingStats & DbId>();\n  const [selected, setSelected] = React.useState<DbTrainingStats & DbId>();\n  const summary = (hover ?? selected);\n  return <Row>\n    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox={`-0.1 -0.1 1.2 1.2 `} width={300} height={300}>\n      <line x1={0} x2={1} y1={1} y2={1} stroke=\"rgba(255, 255, 255, 0.1)\" strokeWidth={0.01} />\n      <line x1={0} x2={0} y1={0} y2={1} stroke=\"rgba(255, 255, 255, 0.1)\" strokeWidth={0.01} />\n      {kind === TrainStatsScatterPlotKind.RoundsEndWin ?\n        <line x1={0} x2={1} y1={0.5} y2={0.5} stroke=\"rgba(255, 255, 255, 0.1)\" strokeWidth={0.01} /> :\n        <line x1={0} x2={1} y1={1} y2={0} stroke=\"rgba(255, 255, 255, 0.1)\" strokeWidth={0.01} />}\n      {stats.slice().sort((a, b) => a.created.toMillis() - b.created.toMillis()).map(stat => {\n        const { startWins, endWins, rounds } = derivedTrainingStats(stat);\n        const x = kind === TrainStatsScatterPlotKind.StartWinEndWin ? startWins : clamp(rounds / 200, 0, 1);\n        const [, currentMinor, ] = version.version.split('.');\n        const color = stat.appVersion.minor === parseInt(currentMinor) ? (\n          stat.experiment ? stringToRGBHex(`${stat.appVersion.minor} ${stat.experiment} lejwwjkehrksdkjfwejkhwekjrhdsf`) : 'yellow')\n          : 'red';\n        // const color = (stat.experiment === 'softmax-cast-and-focus') ? 'yellow' : 'red';\n        return <g key={stat.id}>\n          <circle\n            cx={x} cy={1 - endWins} r={0.01}\n            fill={color}\n            stroke={selected && selected.id === stat.id ? 'yellow' : undefined} strokeWidth={0.01}\n            onClick={() => setSelected(stat)}\n            onMouseOver={() => setHover(stat)} onMouseOut={() => setHover(undefined)} />\n          {kind === TrainStatsScatterPlotKind.RoundsEndWin && <line x1={x} y1={1 - endWins} x2={x} y2={1 - startWins}\n            stroke={`rgba(${endWins > startWins ? '100, 255, 100' : '255, 100, 100'}, 0.1)`} strokeWidth={0.005} />}\n        </g>;\n      })}\n    </svg>\n    <Column>\n      <Row>\n        {kind}\n        <Button onClick={() => setSelected(stats[Math.floor(Math.random() * stats.length)])}>\n          Random\n        </Button>\n      </Row>\n      {summary && <TrainingStatsSummary stat={summary} />}\n    </Column>\n  </Row>\n}\n\n\nfunction trainingStatsDescription(stats: DbTrainingStats, includeItems: boolean) {\n  return `${trainingStatsTeamSummary(stats.home, false, includeItems)} vs ${trainingStatsTeamSummary(stats.away, false, includeItems) || 'statue'}`;\n}\n\nfunction groupAndSortTrainingStats(stats: Array<DbTrainingStats & DbId>, includeItems: boolean) {\n  const groups = {};\n  for (const stat of stats) {\n    const desc = trainingStatsDescription(stat, includeItems);\n    if (!groups[desc]) {\n      groups[desc] = {\n        stats: [stat]\n      }\n    } else {\n      groups[desc].stats.push(stat);\n    }\n  }\n  const res = Object.keys(groups).map(key => ({\n    desc: key,\n    stats: groups[key].stats\n  }));\n  res.sort((a, b) => b.stats.length - a.stats.length);\n  return res;\n}\n\nenum TrainStatsBattleground {\n  Any = 'Any',\n  Solo = 'Solo',\n  Duo = 'Duo',\n  Trio = 'Trio'\n}\n\nexport function AdminTrainingStats() {\n  const [reqItems, setReqItems] = React.useState(true);\n  const [plotKind, setPlotKind] = React.useState(TrainStatsScatterPlotKind.RoundsEndWin);\n  const [battleground, setBatttleground] = React.useState(TrainStatsBattleground.Any);\n  const [userId, setUserId] = React.useState<string>();\n  const stats = useFirebaseStreamQuery<DbTrainingStats>({\n    collection: Db.trainingStats,\n    where: []\n  });\n  if (stats.status !== 'loaded') {\n    return <FirebaseLoading pending={[stats]} />;\n  }\n  const filteredStats = stats.values.filter(x => {\n    const teamSize = Math.max(normalizeTrainStatsTeam(x.home).nUnits, normalizeTrainStatsTeam(x.away).nUnits);\n    if (userId && x.userId !== userId) {\n      return false;\n    }\n    switch (battleground) {\n      case TrainStatsBattleground.Any: return true;\n      case TrainStatsBattleground.Solo: return teamSize === 1;\n      case TrainStatsBattleground.Duo: return teamSize === 2;\n      case TrainStatsBattleground.Trio: return teamSize === 3;\n    }\n    return false;\n  })\n  const groups = groupAndSortTrainingStats(filteredStats, reqItems);\n  return <Block className=\"AdminTrainingStats\">\n    <ItemsRow>\n      <Checkbox value={reqItems} onChange={setReqItems}>Items</Checkbox>\n      <EnumEditor value={plotKind} onChange={setPlotKind} variants={keysOfEnum(TrainStatsScatterPlotKind)} />\n      <Block>\n        Battleground: <EnumEditor value={battleground} onChange={setBatttleground} variants={keysOfEnum(TrainStatsBattleground)} />\n      </Block>\n      <StringEditor value={userId} onChange={setUserId} placeholder=\"User id\" />\n    </ItemsRow>\n    <table>\n      <tbody>\n        <tr>\n          <td className=\"AdminTrainingStatsGroup\">all</td>\n          <td className=\"AdminTrainingStatsGroupSize\">{filteredStats.length}</td>\n          <td><TrainStatsScatterPlot stats={filteredStats} kind={plotKind} /></td>\n        </tr>\n        {groups.slice(0, 20).map((group, i) => <tr key={i}>\n          <td className=\"AdminTrainingStatsGroup\">{group.desc}</td>\n          <td className=\"AdminTrainingStatsGroupSize\">{group.stats.length}</td>\n          <td><TrainStatsScatterPlot stats={group.stats} kind={plotKind} /></td>\n        </tr>)}\n      </tbody>\n    </table>\n    Total {groups.length} groups (20 shown)\n  </Block>\n}\n","export default __webpack_public_path__ + \"static/media/Changelog.1c364693.md\";","export default __webpack_public_path__ + \"static/media/EnergyModel05.c24d9b5b.png\";","export default __webpack_public_path__ + \"static/media/EnergyModel052.dcd0ffd0.png\";","export default __webpack_public_path__ + \"static/media/Logo.94664e68.png\";","import * as React from 'react';\nimport './index.css';\nimport { Button } from '../Button';\nimport { capitalizeFirstLetter } from '../../Util';\n\nexport interface TabTitleProps {\n  title: any;\n  isActive: boolean;\n  onClick: () => void;\n}\nexport interface TabBodyProps {\n  children: any;\n  isActive: boolean;\n}\n\ninterface CommonTabsProps {\n  titleComponent?: ((props: TabTitleProps) => any);\n  bodyComponent?: ((props: TabBodyProps) => any);\n  tab?: number;\n  onTabChange?: (tab: number) => void | boolean;\n  showTabBar?: boolean;\n}\n\ninterface TabsProps extends CommonTabsProps {\n  orientation?: 'left' | 'right' | 'top' | 'bottom';\n  className?: string;\n  style?: React.CSSProperties;\n}\ninterface TabsContainerState {\n  selectedTab: number;\n}\n\nexport class TabsContainer extends React.Component<TabsProps, TabsContainerState> {\n  constructor(props: TabsProps) {\n    super(props);\n    this.state = {\n      selectedTab: props.tab !== undefined ? props.tab : 0\n    };\n  }\n  handleTabChange = (tab: number) => {\n    if (this.props.onTabChange) {\n      if (this.props.onTabChange(tab) === false) {\n        return;\n      }\n    }\n    this.setState({ selectedTab: tab });\n  }\n  render() {\n    const { tab, onTabChange, ...rest } = this.props;\n    return <Tabs tab={this.state.selectedTab} onTabChange={this.handleTabChange} {...rest}>{this.props.children}</Tabs>;\n  }\n}\n\nexport class Tabs extends React.Component<TabsProps> {\n  public static defaultProps: TabsProps = {\n    titleComponent: TabTitle,\n    bodyComponent: TabBody,\n    orientation: 'top'\n  };\n  render() {\n    const TitleComponent = this.props.titleComponent!;\n    const BodyComponent = this.props.bodyComponent!;\n    const selectedTab = this.props.tab !== undefined ? this.props.tab : 0;\n    return (\n      <div className={`Tabs Tabs${capitalizeFirstLetter(this.props.orientation || 'top')} ${this.props.className || ''}`} style={this.props.style}>\n        {this.props.showTabBar !== false && <div className=\"TabsBar\">\n          {React.Children.map(this.props.children, (tab, i) => (\n            tab ?\n              <TitleComponent\n                title={(tab as any as Tab).props.title}\n                isActive={i === this.props.tab}\n                onClick={() => { if (this.props.onTabChange) { this.props.onTabChange(i); } }}\n                />\n              : null\n          ))}\n        </div>}\n        <BodyComponent\n          key={selectedTab}\n          isActive={true}\n          children={(this.props.children as any[])[selectedTab]}\n        />\n      </div>\n    );\n  }\n}\nexport function TabTitle({ isActive, onClick, title }: TabTitleProps) {\n  return (\n    <Button className={`TabTitle`} flat={true} toggled={isActive} onClick={onClick} purpose=\"SwitchTab\">\n      {title}\n    </Button>\n  );\n}\nexport function TabBody({ isActive, children }: TabBodyProps) {\n  return (\n    <div className=\"TabBody\">\n      {children}\n    </div>\n  );\n}\ninterface AccordionState {\n  expandedIndex: number;\n}\nexport class Accordion extends React.Component<CommonTabsProps, AccordionState> {\n  public static defaultProps: CommonTabsProps = {\n    titleComponent: AccordionTabTitle,\n    bodyComponent: TabBody\n  };\n  constructor(props: CommonTabsProps) {\n    super(props);\n    this.state = {\n      expandedIndex: props.tab !== undefined ? props.tab : -1\n    };\n  }\n  handleClickTitle(titleIndex: number) {\n    if (this.state.expandedIndex === titleIndex) {\n      this.setState({ expandedIndex: -1 });\n    } else {\n      this.setState({ expandedIndex: titleIndex });\n    }\n  }\n  render() {\n    const children = React.Children.toArray(this.props.children) as any as Tab[];\n    let counter = 0;\n    const grouped = children.reduce((p, tab) => {\n      const group = tab.props.group || '';\n      p[group] = (p[group] || []);\n      p[group].push({ tab, i: counter++ });\n      return p;\n    }, {} as { [group: string]: Array<{ tab: Tab, i: number }> });\n    const TitleComponent = this.props.titleComponent!;\n    const BodyComponent = this.props.bodyComponent!;\n    return (\n      <div className=\"Accordion\">\n        {Object.keys(grouped).map(groupName => (\n          <div key={groupName} className=\"AccordionGroup\">\n            {groupName && <div className=\"AccordionGroupName\">{groupName}</div>}\n            {grouped[groupName].map(({ tab, i }) => (\n              <div className=\"AccordionTab\" key={i}>\n                <TitleComponent\n                  title={(tab as any as Tab).props.title}\n                  isActive={i === this.state.expandedIndex}\n                  onClick={() => this.handleClickTitle(i)}\n                  />\n                {i === this.state.expandedIndex && (\n                  <BodyComponent isActive={true} children={(tab as any as Tab).props.children} />\n                )}\n              </div>\n            ))}\n          </div>\n        ))}\n      </div>\n    );\n  }\n}\nexport function AccordionTabTitle({ isActive, onClick, title }: TabTitleProps) {\n  return (\n    <div className=\"AccordionTabTitle\" onClick={onClick}>\n      {title} {\n        isActive ?\n          <i className=\"Chevron fa fa-chevron-up\" aria-hidden=\"true\" /> :\n          <i className=\"Chevron fa fa-chevron-down\" aria-hidden=\"true\" />\n      }\n    </div>\n  );\n}\nexport interface TabProps {\n  title: any;\n  group?: string;\n  className?: string;\n}\nexport class Tab extends React.Component<TabProps> {\n  render() {\n    return (\n      <div className={`Tab ${this.props.className !== undefined ? this.props.className : ''}`}>\n        {this.props.children}\n      </div>\n    );\n  }\n}","import * as React from 'react';\nimport { Store, useStoreSelect, useStore } from '../Components/Store';\nimport { FirebaseStreamQueryResult, FirebaseStreamDocumentResult } from '../Components/Firebase';\nimport { DbCreature, DbItemInstance, DbUserSettings } from 'db';\nimport { GameInstance } from '../GpuWorld/StateData';\nimport { ChangelogEntry } from './App';\n\nexport class AppState {\n  loggedInUserId?: string;\n  userSettings: FirebaseStreamDocumentResult<DbUserSettings> = { status: 'loading' };\n  draggingUrl = '';\n  hideUI = false;\n  creatures: FirebaseStreamQueryResult<DbCreature> = { status: 'loading' };\n  items: FirebaseStreamQueryResult<DbItemInstance> = { status: 'loading' };\n  gameInstance: GameInstance = { type: 'none' };\n  scheduledTrainingIndex = -1;\n  scheduledEnd = -1;\n  changelog: ChangelogEntry[] = [];\n}\nexport const AppStateContext = React.createContext(new Store(new AppState()));\nexport function useAppState<T>(map: (state: AppState) => T): T {\n  return useStore(AppStateContext, map);\n}\nexport function useAppStateSelect(...keys: Array<keyof AppState>): AppState {\n  return useStoreSelect(AppStateContext, ...keys);\n}\n","export default __webpack_public_path__ + \"static/media/Items.feaa4ed0.png\";","export default __webpack_public_path__ + \"static/media/Training.c6f2887e.md\";","import * as React from 'react';\nimport ReactMarkdown from 'react-markdown';\n\ninterface BundledMarkdownProps {\n  path: string;\n}\n\n// Bundled, as in the markdown file is in the src folder\nexport class BundledMarkdown extends React.Component<BundledMarkdownProps> {\n  state = { text: '' };\n  static sources = {};\n  async componentDidMount() {\n    this.setState({ text: await this.loadSource() });\n  }\n  loadSource() {\n    if (BundledMarkdown.sources[this.props.path]) {\n      return BundledMarkdown.sources[this.props.path];\n    } else {\n      const source = fetch(this.props.path).then(response => response.text());\n      return BundledMarkdown.sources[this.props.path] = source;\n    }\n  }\n  render() {\n    return <ReactMarkdown source={this.state.text} linkTarget=\"_blank\" />;\n  }\n}\n","export default __webpack_public_path__ + \"static/media/Gold.fd9993fb.png\";","import * as React from 'react';\nimport './index.css';\nimport { WorldStateContext } from '../../../GameComponents/WorldDataConsumer';\nimport { EntitiesQuery } from '../../../GpuUtil/ECS/Query';\nimport { Unit } from '../../../GpuWorld/ECS/UnitComponents';\nimport { ArenaInstance, ArenaMemberIndex } from '../../../GpuWorld/ECS/Components';\nimport { shaderModule, uniformDef, funcDef } from '../../../GpuUtil/ShaderModule';\nimport { Position } from '../../../GpuWorld/ECS/Transform';\nimport * as Vector2 from '../../../Math/Vector2';\nimport * as Vector3 from '../../../Math/Vector3';\nimport * as Vector4 from '../../../Math/Vector4';\nimport lodash from 'lodash';\nimport { Popup } from '../../../Components/Popup';\nimport { InGameUnitBountyEditor } from '../../BountyEditor';\nimport { Gold } from '../../../GpuWorld/ECS/UnitComponents';\nimport { SideSize, SoundEffect } from '../../../GpuWorld/StateLayout';\nimport { AudioPlayerInstance } from '../../../GpuWorld/Audio';\nimport { Lazy } from '../../../Util';\n\n\ninterface UnitLayoverData {\n  position: Vector3.Vector3;\n  screenPosition: Vector2.Vector2;\n  gold: number;\n  arenaMemberIndex: number;\n}\n\nexport function UnitsLayover() {\n  const worldState = React.useContext(WorldStateContext);\n  const [units, setUnits] = React.useState<UnitLayoverData[]>([]);\n  React.useEffect(() => {\n\n    if (!worldState) {\n      return;\n    }\n\n    const unitsQuery = new EntitiesQuery([Unit.component])\n      .filterValue(ArenaInstance.cpuComponent, (v, state) => v[0] === state.data.renderArena, d => [d.data.renderArena])\n      .filterValue(ArenaMemberIndex.cpuComponent, (v, d) => (v[0] > 0 && v[0] < SideSize && d.derived.trainingSetup.trainHome) || (v[0] > SideSize && d.derived.trainingSetup.trainAway), d => [d.derived.trainingSetup])\n      .toGpu(worldState.gls)\n      .mapToTemp(shaderModule([Position.sm, Gold.sm, ArenaMemberIndex.sm], {\n        viewProjection: uniformDef('mat4', d => d.derived.cameraProjectionView),\n        map: funcDef('vec4[2]', [['ivec2', 'entityCell']], `\n          vec3 position = ${Position.sm.value}(entityCell);\n          vec4 screenPos = Self.viewProjection * vec4(position + vec3(0, 0, 1), 1);\n          screenPos /= screenPos.w;\n          return vec4[](\n            vec4(position, 0),\n            vec4(screenPos.xy, ${Gold.sm.value}(entityCell), ${ArenaMemberIndex.sm.value}(entityCell))\n          );\n        `)\n      }))\n      .toCpuQueuing(state => state.data.round);\n\n    let prevUnits: UnitLayoverData[];\n\n    const update = () => {\n      const readResults = unitsQuery.queueRead(worldState);\n      const unitData = lodash.last(readResults());\n\n      const newUnits: UnitLayoverData[] = [];\n      let unitsChanged = false;\n      if (unitData && unitData.length > 0) {\n        for (let i=0; i < unitData.length; i++) {\n          const unit: UnitLayoverData = {\n            position: unitData[i].value[0],\n            screenPosition: Vector2.interpolate(\n              Vector4.xy(unitData[i].value[1]),\n              Vector2.create(-1, 1),\n              Vector2.create(1, -1),\n              Vector2.create(0),\n              Vector2.create(worldState.data.canvasRect.width, worldState.data.canvasRect.height)),\n            gold: unitData[i].value[1].z,\n            arenaMemberIndex: unitData[i].value[1].w,\n          }\n          newUnits.push(unit);\n          unitsChanged = unitsChanged || !prevUnits || unit.gold !== prevUnits[i]?.gold;\n        }\n        if (unitsChanged) {\n          setUnits(newUnits);\n        }\n      }\n    }\n    worldState.events.render.attach(update);\n    return () => {\n      worldState.events.render.detach(update);\n      unitsQuery.destroy();\n    }\n\n  }, [worldState]);\n\n  return <div className=\"UnitsLayover\">\n    {units?.map((unit, i) => <UnitLayover key={i} unit={unit} />)}\n  </div>\n}\n\nconst throttledPlaySoundEffect = new Lazy(() => lodash.throttle(AudioPlayerInstance!.playSoundEffect.bind(AudioPlayerInstance), 300, { leading: true }));\n\nfunction UnitLayover({ unit }: { unit: UnitLayoverData }) {\n  const worldState = React.useContext(WorldStateContext);\n  const pausedState = React.useRef<boolean>(false);\n  const [goldInfo, setGoldInfo] = React.useState({ prevGold: 0, round: -1, renderArena: -2, worldState });\n  const [goldTicker, setGoldTicker] = React.useState(0);\n  const [showBountyConfig, setShowBountyConfig] = React.useState(false);\n  const showGold = (unit.arenaMemberIndex < SideSize && worldState?.data.teams.home.train) ||\n    (unit.arenaMemberIndex >= SideSize && worldState?.data.teams.away.train);\n  React.useEffect(() => {\n    setGoldInfo({\n      prevGold: unit.gold,\n      round: worldState?.data.round!,\n      renderArena: worldState?.data.renderArena!,\n      worldState\n    });\n    if (!showGold || worldState?.data.round !== goldInfo.round || worldState?.data.renderArena !== goldInfo.renderArena ||\n        worldState !== goldInfo.worldState) {\n      setGoldTicker(0);\n    } else {\n      const inc = unit.gold - goldInfo.prevGold;\n      if (inc > 0) {\n        throttledPlaySoundEffect.value(SoundEffect.Coins, 0.3, unit.position);\n      }\n      setGoldTicker(goldTicker + inc);\n    }\n    const t = setTimeout(() => setGoldTicker(0), 1000);\n    return () => {\n      clearTimeout(t);\n    }\n  }, [unit.gold, worldState, showGold, goldInfo.prevGold, goldInfo.renderArena, goldInfo.round, goldInfo.worldState, goldTicker, unit.position]);\n\n  return <div className=\"UnitLayover\" style={{ left: unit.screenPosition.x, top: unit.screenPosition.y }}>\n    <div className=\"UnitLayoverClickarea\" onClick={() => {\n      pausedState.current = !!worldState?.data.simulationPaused;\n      worldState?.setData({ simulationPaused: true });\n      setShowBountyConfig(true);\n    }} >\n      {showGold && <div className={`UnitLayoverGold ${unit.gold < 0 ? 'UnitLayoverGoldNegative' : ''}`}>{Math.round(unit.gold)}</div>}\n    </div>\n    {goldTicker !== 0 && <div key={goldTicker} className={`UnitLayoverGoldTicker UnitLayoverGold ${goldTicker > 0 ? '' : 'UnitLayoverGoldNegative'}`}>{goldTicker > 0 ? '+' : ''}{Math.round(goldTicker)}</div>}\n    {showBountyConfig && <Popup onClose={() => {\n      worldState?.setData({ simulationPaused: pausedState.current });\n      setShowBountyConfig(false);\n    }}>\n      <InGameUnitBountyEditor arenaMemberIndex={unit.arenaMemberIndex} />\n    </Popup>}\n  </div>\n}\n","export default __webpack_public_path__ + \"static/media/BountyPoster.7a4a3d6a.svg\";","import * as React from 'react';\nimport './index.css';\nimport { DbUser, DbItemInstance, DbTeam, Db, DbUserProfile, MinGamesRanked } from 'db';\nimport { WorldStateContext, useWorldDataSelect } from '../../../GameComponents/WorldDataConsumer';\nimport { GpuWorldRendererOptionsTypedef } from '../../../GpuWorld/Renderer/Configuration';\nimport { MaterialIconButton, FontAwesomeButton, Button } from '../../../Components/Button';\nimport { useFirebaseStreamDocument } from '../../../Components/Firebase';\nimport { Panel, PanelMode } from '../../../Components/Panel';\nimport { Row, Column, Block, ItemsColumn, ScrollableColumn, ItemsRow } from '../../../Components/Layout';\nimport { AnyEditor, EnumEditor } from '../../../Components/Editors';\nimport { BattleWinner } from 'db';\nimport { TabsContainer, Tab } from '../../../Components/Tabs';\nimport { TeamSettings } from '../../../GpuWorld/StateData';\nimport { useInterval } from \"../../../Components/Interval\";\nimport { PixlingTimespan } from '../../../Time';\nimport { stringToRGBHex, wait, keysOfEnum, isNullOrUndefined } from '../../../Util';\nimport { ArenaMinimaps } from '../ArenaMinimaps';\nimport { ECSInspector } from '../../../Components/ECSInspector';\nimport { ItemIcon } from '../../Items';\nimport { RoundClock } from '../../../GameComponents/RoundClock';\nimport { version } from '../../../version';\nimport { WeightsHistogram } from '../WeightsHistogram';\nimport { Plot } from '../../../Components/Plot';\nimport { Size } from '../../../Math/Math';\nimport { HomeHealthColor, AwayHealthColor, BrainOutputsKeys } from '../../../GpuWorld/StateLayout';\nimport { Tooltip } from '../../../Components/Tooltip';\nimport lodash from 'lodash';\nimport { Popup } from '../../../Components/Popup';\nimport { MeasuredDiv } from '../../../Components/MeasureSize';\nimport { Sense } from '../../../GpuWorld/Brain/SensesDef';\nimport TrainingFaqMd from './Training.md';\nimport { BundledMarkdown } from '../../../Components/BundledMarkdown';\nimport { useDialog, Dialog } from '../../../Components/Dialog';\nimport { UnitsLayover } from '../UnitsLayover';\nimport { WonkyPanel, evenPadding } from '../../../Components/WonkyPanel';\nimport BountyPosterSvg from '../../../Images/BountyPoster.svg';\nimport { CameraEditor } from '../CameraEditor';\nimport { WorldProgramContext } from '../../../Components/WorldCanvas';\nimport { AppStateContext, useAppStateSelect } from '../../AppState';\nimport { Gold, BountyComponents } from '../../../GpuWorld/ECS/UnitComponents';\nimport { GpuWorldState } from '../../../GpuWorld/State';\nimport { useHotkey } from '../../../Components/Hotkeys';\nimport { BattleScore, BattleScoreChangeFlash } from '../../../GameComponents/BattleScore';\nimport { divisionColor, divisionName } from '../../Leaderboard';\n\ninterface GameUIProps {\n  loggedInUserData: DbUser;\n  onExit: () => Promise<void>;\n}\n\nexport function GameUI({ loggedInUserData, onExit }: GameUIProps) {\n  const worldState = React.useContext(WorldStateContext);\n  const [showDebugOptions, setShowDebugOptions] = React.useState<boolean>(false);\n  const [showViewOptions, setShowViewOptions] = React.useState<boolean>(false);\n  const [showBrainConfig, setShowBrainConfig] = React.useState<boolean>(false);\n  const { gameInstance, showDecisionsHistogram, showSensesHistogram, cameraMode } = useWorldDataSelect('gameInstance', 'showDecisionsHistogram', 'showSensesHistogram', 'cameraMode');\n\n  const showUIStyle = { opacity: undefined };\n\n  return <div className=\"GameUI\">\n    {gameInstance?.type === 'train' && <UnitsLayover />}\n    <Column className=\"GameHUD\">\n      <Row className=\"GameHUDTop\" style={showUIStyle}>\n        <Column>\n          <FPSCounter />\n          {version.isDevelopment && <Row>\n            <FontAwesomeButton flat={true} onClick={() => setShowViewOptions(!showViewOptions)} toggled={showViewOptions} icon=\"palette\" title=\"Show view options\" />\n            <MaterialIconButton flat={true} onClick={() => setShowDebugOptions(!showDebugOptions)} toggled={showDebugOptions} icon=\"bug_report\" title=\"Open debug\" purpose=\"OpenDebug\" />\n            {gameInstance?.type === 'train' && <FontAwesomeButton flat={true} onClick={() => setShowBrainConfig(!showBrainConfig)} toggled={showBrainConfig} icon=\"brain\" title=\"Show brain config\" />}\n            <FontAwesomeButton flat={true} icon=\"camera\" toggled={cameraMode === 'free'}\n              onClick={() => worldState?.setData({ cameraMode: cameraMode === 'rts' ? 'free' : 'rts' })}\n              title=\"Toggle camera mode\" />\n          </Row>}\n        </Column>\n      </Row>\n\n      <Row className=\"GameHUDMiddle\" style={showUIStyle}>\n        <div className=\"GameHUDLeft\">\n          {showDebugOptions && worldState && <WorldPageDebugPanel />}\n          {showDecisionsHistogram && <BrainHistogramView keys={BrainOutputsKeys} writeRectTo=\"decisionHistogramView\" />}\n          {showSensesHistogram && <BrainHistogramView keys={keysOfEnum(Sense)} writeRectTo=\"sensesHistogramView\" />}\n        </div>\n        {gameInstance?.type === 'train' && <Block className=\"ArenaMinimapsContainer\"><ArenaMinimaps /></Block>}\n      </Row>\n\n      {gameInstance?.type === 'train' && <TrainingHUD onExit={onExit} />}\n      {gameInstance?.type === 'replay' && <ReplayHUD onExit={onExit} />}\n      {gameInstance?.type === 'battle' && <BattleHUD />}\n      {gameInstance?.type === 'battle' && <BattleScoreChangeFlash />}\n\n    </Column>\n\n    <BattleResultComponent onExit={onExit} />\n\n  </div>;\n}\n\nfunction BattleResultComponent({ onExit }: { onExit: () => Promise<void> }) {\n  const { battleResult, completeBattleRes, teams, battlePostUpdateDone } = useWorldDataSelect('battleResult', 'completeBattleRes', 'creaturesById', 'teams', 'battlePostUpdateDone');\n  const team = useFirebaseStreamDocument<DbTeam>(Db.teams, teams?.home.id);\n  const worldState = React.useContext(WorldStateContext);\n  const dialog = useDialog();\n  const appState = React.useContext(AppStateContext);\n  if (battleResult === undefined || battleResult === BattleWinner.Undecided || !worldState) {\n    return null;\n  }\n\n  // const onSaveReplay = async () => {\n  //   const title = await dialog.prompt('Replay title');\n  //   if (!title) {\n  //     return;\n  //   }\n  //   await saveReplay(worldState, title);\n  // }\n\n  return <Column className=\"BattleResultContainer\">\n    <Dialog state={dialog.current} />\n    <Panel mode={PanelMode.Floating}>\n      <ItemsColumn className={`BattleResult ${battleResult === BattleWinner.HomeWin ? 'BattleResultWinner' : 'BattleResultLoser'}`}>\n        <div className={`BattleResultHeader animated zoomIn`}>{\n          battleResult === BattleWinner.HomeWin ? 'VICTORY!' :\n          battleResult === BattleWinner.AwayWin ? 'Defeat' :\n          'Tie'}</div>\n        {completeBattleRes && team.status === 'loaded' ? <ItemsColumn>\n          {/* {completeBattleRes.status === 'ok' && completeBattleRes.newDivision !== completeBattleRes.oldDivision && <Row>\n            <b>Congratulations, you've advanced to the next division!</b>\n          </Row>} */}\n          {battlePostUpdateDone ?\n            <TeamName team={team.value} /> : <Row>Loading team stats...</Row>\n          }\n          {completeBattleRes.status === 'ok' && completeBattleRes.rewardItemIds.length > 0 && <ItemsColumn>\n            <Row><small>New item:</small></Row>\n            {completeBattleRes.rewardItemIds.map((itemId, i) => <RewardItem key={i} itemId={itemId} />)}\n          </ItemsColumn>}\n          {completeBattleRes.status === 'err' && <span><i>There was an error completing the battle</i></span>}\n        </ItemsColumn> : <Row>Loading...</Row>}\n\n        <ItemsRow>\n          {/* <FontAwesomeButton icon=\"video\" flat={true} className=\"BattleResultSaveReplay\" onPerform={onSaveReplay}>Publish replay</FontAwesomeButton> */}\n          <Button className=\"BattleResultBattleAgain\" autoFocus={true} onPerform={async () => {\n            const next = {...appState.state.gameInstance}\n            appState.update({ gameInstance: { type: 'none' } });\n            await wait(100);\n            appState.update({ gameInstance: next });\n          }} primary={true}>Battle again</Button>\n          <Button className=\"BattleResultExit\" onClick={onExit}>Home</Button>\n        </ItemsRow>\n      </ItemsColumn>\n    </Panel>\n  </Column>\n}\n\nfunction plotTrainingStat(ctx: CanvasRenderingContext2D, size: Size, data: number[], color: string, yMin: number, yMax: number) {\n  if (data.length <= 1) {\n    return;\n  }\n  ctx.beginPath();\n  const xStep = size.width / (data.length - 1);\n  const getPoint = (i: number): [number, number] => [i * xStep, size.height - 1 - (data[i] - yMin) * (size.height - 2) / (yMax - yMin)]\n  ctx.moveTo(...getPoint(0));\n  for (let i=1; i < data.length; i++) {\n    ctx.lineTo(...getPoint(i));\n  }\n  ctx.strokeStyle = color;\n  ctx.stroke();\n}\n\nconst EmptyTeamSettings = new TeamSettings();\nconst HitpointsGraphColor = '#ebe575';\n// const HitpointsTimeColor = '#8dbdd6';\nfunction TeamTrainingStats({ team }: { team: 'home' | 'away' }) {\n  const { teams, gameInstance } = useWorldDataSelect('teams', 'gameInstance');\n  const canvas = React.useRef<HTMLCanvasElement>(null);\n  const teamData = teams?.[team] ?? EmptyTeamSettings;\n  const maxPoints = teamData.maxPossiblePoints;\n  React.useEffect(() => {\n    if (canvas.current) {\n      const ctx = canvas.current.getContext('2d')!;\n      ctx.clearRect(0, 0, canvas.current.width, canvas.current.height);\n      const size: Size = canvas.current;\n      ctx.lineWidth = 3;\n      plotTrainingStat(ctx, size, teamData.trainingStats.points, team === 'home' ? HomeHealthColor : AwayHealthColor, 0, maxPoints);\n      if (gameInstance && gameInstance.type === 'train') {\n        if ((team === 'home' && gameInstance.trainHome) || (team === 'away' && gameInstance.trainAway)) {\n          ctx.lineWidth = 1;\n          const minGold = teamData.trainingStats.gold.reduce((p, x) => Math.min(p, x), 0);\n          const maxGold = teamData.trainingStats.gold.reduce((p, x) => Math.max(p, x), 0);\n          plotTrainingStat(ctx, size, teamData.trainingStats.gold, HitpointsGraphColor, minGold, maxGold);\n        }\n      }\n      // plotTrainingStat(ctx, size, teamData.trainingStats.cumulativeHitpoints, HitpointsTimeColor, 1);\n    }\n  }, [teamData, gameInstance, maxPoints, team]);\n  return <Tooltip className=\"TeamTrainingStats\" tooltip={() => <Column>\n    <Block><b>{team === 'home' ? 'Trainees' : 'Opponents'}</b></Block>\n    <Block style={{ color: team === 'home' ? HomeHealthColor : AwayHealthColor }}>Points: {(lodash.last(teamData.trainingStats.points) ?? 0).toFixed(1)} / {maxPoints}</Block>\n    {team === 'home' && <Block style={{ color: HitpointsGraphColor }}>Gold: {Math.round((lodash.last(teamData.trainingStats.gold) ?? 0))}</Block>}\n    {/* <Block style={{ color: HitpointsGraphColor }}>Ending hitpoints: {Math.round(100 * (lodash.last(teamData.trainingStats.hitpoints) ?? 0))}%</Block> */}\n    {/* <Block style={{ color: HitpointsTimeColor }}>Cumulative hitpoints: {Math.round(100 * (lodash.last(teamData.trainingStats.cumulativeHitpoints) ?? 0))}%</Block> */}\n  </Column>}>\n    <canvas width={160} height={70} ref={canvas} />\n  </Tooltip>\n}\n\nfunction TrainingWinTieLoss() {\n  const nRounds = 5;\n  const { trainingStats } = useWorldDataSelect('trainingStats');\n  if (!trainingStats || trainingStats.win5Percs.length === 0) {\n    return <div className=\"TrainingWinTieLoss\" />;\n  }\n  const wins = lodash.last(trainingStats.win5Percs)!;\n  const ties = lodash.last(trainingStats.tie5Percs)!;\n  const losses = lodash.last(trainingStats.losses5Percs)!;\n  return <Tooltip tooltip={() => <Column>\n    <Block><small><i>Average over last {nRounds} rounds</i></small></Block>\n    <Block>Wins: {Math.round(100 * wins)}%</Block>\n    <Block>Ties: {Math.round(100 * ties)}%</Block>\n    <Block>Losses: {Math.round(100 * losses)}%</Block>\n  </Column>}>\n      <div className=\"TrainingWinTieLoss\">\n      <div className=\"TrainingWins\" style={{ flex: wins, background: HomeHealthColor }} />\n      <div className=\"TrainingTies\" style={{ flex: ties }} />\n      <div className=\"TrainingLosses\" style={{ flex: losses, background: AwayHealthColor }} />\n    </div>\n  </Tooltip>\n}\n\n// function AdvancedTrainingSettings() {\n//   const { breedAggressiveness, breedSurvival } = useWorldDataSelect('breedAggressiveness', 'breedSurvival');\n//   const worldState = React.useContext(WorldStateContext);\n//   if (!worldState) {\n//     return null;\n//   }\n//   return <Column>\n//     <h3>Advanced training settings</h3>\n//     <Checkbox value={breedAggressiveness} onChange={v => worldState.setData({ breedAggressiveness: v })}>Breed for attack</Checkbox>\n//     <Checkbox value={breedSurvival} onChange={v => worldState.setData({ breedSurvival: v })}>Breed for survival</Checkbox>\n//   </Column>\n// }\n\nfunction NoBountiesWarning() {\n  const { unitBountiesEmpty } = useWorldDataSelect('unitBountiesEmpty');\n\n  if (unitBountiesEmpty) {\n    return <WonkyPanel fill=\"none\" stroke=\"#fff\" strokeWidth={2} shadowPx={0} borderPx={evenPadding(10)} className=\"NoBountiesWarning\">\n      <img src={BountyPosterSvg} alt=\"BountyPoster\" />\n      The Derklings love gold, and you can use this to train them! Click one of them to get started.\n    </WonkyPanel>\n  } else {\n    return null;\n  }\n}\n\nconst ManualGoldButtonTooltip = `Manual gold bonus.\n\nSee a behaviour you'd like to reward a bit extra? Press this button to give the Derklings in the current arena a bonus! The amount can be configured under \"bonus gold\" in the misc bounty editors.\n\nHotkeys:\n[1-3] Give gold to trainees 1 through 3\n[4] Give gold to all trainees\n[5-7] Give gold to opponents 1 through 3\n[8] Give gold to all opponents\n`;\n\nfunction TrainingHUD({ onExit }: { onExit: () => Promise<void> }) {\n  const { round, trainingRounds, turboMode, renderAllArenas, renderGazes, showDecisionsHistogram, showSensesHistogram, showDecisionsViz, simulationPaused, cameraMode, gameInstance } = useWorldDataSelect(\n    'round', 'trainingRounds', 'turboMode', 'renderAllArenas', 'renderGazes', 'showDecisionsHistogram', 'showSensesHistogram', 'showDecisionsViz', 'simulationPaused', 'cameraMode', 'gameInstance');\n  const { userSettings } = useAppStateSelect('userSettings');\n  const worldState = React.useContext(WorldStateContext);\n  // const [showSetting, setShowSettings] = React.useState(false);\n  const [showFAQ, setShowFAQ] = React.useState(false);\n  const dialog = useDialog();\n  useHotkey('Digit1', () => worldState && yieldBonusGold(worldState, 1, 1));\n  useHotkey('Digit2', () => worldState && yieldBonusGold(worldState, 2, 1));\n  useHotkey('Digit3', () => worldState && yieldBonusGold(worldState, 3, 1));\n  useHotkey('Digit4', () => worldState && yieldBonusGold(worldState, 1, 3));\n  useHotkey('Digit5', () => worldState && yieldBonusGold(worldState, 5, 1));\n  useHotkey('Digit6', () => worldState && yieldBonusGold(worldState, 6, 1));\n  useHotkey('Digit7', () => worldState && yieldBonusGold(worldState, 7, 1));\n  useHotkey('Digit8', () => worldState && yieldBonusGold(worldState, 5, 3));\n  if (!worldState || userSettings.status !== 'loaded' || !gameInstance) {\n    return null;\n  }\n\n  // const onSaveReplay = async () => {\n  //   const simulationPaused = worldState.data.simulationPaused;\n  //   worldState.setData({ simulationPaused: true });\n  //   const title = await dialog.prompt('Replay title');\n  //   if (!title) {\n  //     worldState.setData({ simulationPaused });\n  //     return;\n  //   }\n  //   await saveReplay(worldState, title);\n  //   worldState.setData({ simulationPaused });\n  // }\n\n  const hasGoldBonus = true;\n\n  return <ItemsColumn className=\"TrainingHUD\">\n    <Dialog state={dialog.current} />\n    <NoBountiesWarning />\n    <ItemsRow>\n      <TeamTrainingStats team=\"home\" />\n      <ItemsColumn>\n        <Row>Training round {(round ?? 0) + 1} {trainingRounds !== Number.POSITIVE_INFINITY && <span> / {trainingRounds}</span>}</Row>\n        <RoundClock />\n        <TrainingWinTieLoss />\n        <ItemsRow>\n          <FontAwesomeButton flat={true} toggled={!simulationPaused && !turboMode} onClick={() => worldState?.setData({ simulationPaused: false, turboMode: false })} icon=\"play\" title=\"Play\" />\n          <FontAwesomeButton flat={true} toggled={!simulationPaused && turboMode} onClick={() => worldState.setData({ simulationPaused: false, turboMode: true })} className=\"TrainingHUDTurbo\" icon=\"fast-forward\" title=\"Turbo mode\" />\n          <FontAwesomeButton flat={true} toggled={simulationPaused} onClick={() => worldState?.setData({ simulationPaused: true })} icon=\"pause\" title=\"Pause\" />\n          <FontAwesomeButton flat={true} icon=\"camera\" toggled={cameraMode === 'follow'}\n            onClick={() => worldState?.setData({ cameraMode: cameraMode === 'rts' ? 'follow' : 'rts' })}\n            title=\"Toggle camera mode\" />\n          {/* {userSettings.advancedTrainingSettings && <FontAwesomeButton icon=\"video\" flat={true} disabled={round === 0} onPerform={onSaveReplay} title=\"Save replay\" />} */}\n          <FontAwesomeButton flat={true} onClick={() => { setShowFAQ(true); worldState?.setData({ simulationPaused: true }); }} icon=\"question-circle\" title=\"Help\" />\n          {/* {userSettings.advancedTrainingSettings && <FontAwesomeButton flat={true} onClick={() => setShowSettings(true)} icon=\"cog\" title=\"Advanced training settings\" />} */}\n          <FontAwesomeButton flat={true} toggled={renderAllArenas} onClick={() => worldState.setData({ renderAllArenas: !renderAllArenas })} icon=\"location-arrow\" title=\"Show ghost images of all arenas\" />\n          {hasGoldBonus && <FontAwesomeButton flat={true} icon=\"hand-holding-usd\" onClick={() => yieldBonusGold(worldState, 1, 3)} title={ManualGoldButtonTooltip} />}\n          {userSettings.value.advancedTrainingSettings && <FontAwesomeButton flat={true} toggled={renderGazes} onClick={() => worldState.setData({ renderGazes: !renderGazes })} icon=\"eye\" title=\"Show gazes\" />}\n          {userSettings.value.advancedTrainingSettings && <FontAwesomeButton flat={true} toggled={showSensesHistogram} onClick={() => worldState.setData({ showSensesHistogram: !showSensesHistogram })} icon=\"assistive-listening-systems\" title=\"Show senses histogram\" />}\n          {userSettings.value.advancedTrainingSettings && <FontAwesomeButton flat={true} toggled={showDecisionsHistogram} onClick={() => worldState.setData({ showDecisionsHistogram: !showDecisionsHistogram })} icon=\"chart-bar\" title=\"Show decisions histogram\" />}\n          {userSettings.value.advancedTrainingSettings && <FontAwesomeButton flat={true} toggled={showDecisionsViz} onClick={() => worldState.setData({ showDecisionsViz: !showDecisionsViz })} icon=\"brain\" title=\"Show decisions\" />}\n          <FontAwesomeButton flat={true} icon=\"door-open\" onPerform={async () => {\n            await onExit();\n          }} title=\"Exit training\" />\n        </ItemsRow>\n      </ItemsColumn>\n      <TeamTrainingStats team=\"away\" />\n    </ItemsRow>\n    {/* {showSetting && <Popup onClose={() => setShowSettings(false)}>\n      <AdvancedTrainingSettings />\n    </Popup>} */}\n    {showFAQ && <Popup onClose={() => { setShowFAQ(false); worldState?.setData({ simulationPaused: false }) }}>\n      <ScrollableColumn className=\"TrainingFAQ\">\n        <BundledMarkdown path={TrainingFaqMd} />\n      </ScrollableColumn>\n    </Popup>}\n  </ItemsColumn>\n}\n\nfunction yieldBonusGold(worldState: GpuWorldState, startArenaMemberIndex: number, count: number) {\n  if (worldState.data.renderArena < 0) {\n    return;\n  }\n  const unitsInArena = worldState.unitsInArena.get(worldState);\n  for (let i=0; i < count; i++) {\n    const index = i + startArenaMemberIndex;\n    const unit = unitsInArena.rows[worldState.data.renderArena].entities[index];\n    const gold = worldState.ecs.getComponentData(Gold.component, unit, false);\n    const manualBonus = worldState.ecs.getComponentData(BountyComponents.manualBonus.component, unit, false);\n    if (gold && manualBonus) {\n      worldState.ecs.setComponentData(Gold.component, unit, new Float32Array([gold[0] + manualBonus[0]]));\n    }\n  }\n}\n\nfunction ReplayHUD({ onExit }: { onExit: () => Promise<void> }) {\n  const { teams, simulationPaused, simulationSpeed, cameraMode } = useWorldDataSelect('teams', 'simulationPaused', 'simulationSpeed', 'cameraMode');\n  const worldState = React.useContext(WorldStateContext);\n  const worldProgram = React.useContext(WorldProgramContext);\n  if (!teams) {\n    return null;\n  }\n  return <ItemsColumn className=\"ReplayHUD\">\n    {cameraMode === 'free' && <CameraEditor />}\n    <BattleScore />\n    <Block>\n      {teams.home.dbTeam && <TeamName team={teams.home.dbTeam} />}\n      &nbsp;vs&nbsp;\n      {teams.away.dbTeam && <TeamName team={teams.away.dbTeam} />}\n    </Block>\n    <RoundClock />\n    <ItemsRow>\n      <FontAwesomeButton flat={true} toggled={!simulationPaused} onClick={() => worldState?.setData({ simulationPaused: false })} icon=\"play\" title=\"Play\" />\n      <FontAwesomeButton flat={true} toggled={simulationPaused} onClick={() => worldState?.setData({ simulationPaused: true })} icon=\"pause\" title=\"Pause\" />\n      <FontAwesomeButton flat={true} disabled={!simulationPaused} onClick={() => worldState?.gameLoop?.step()} icon=\"step-forward\" title=\"Step\" />\n      <FontAwesomeButton flat={true} icon=\"redo\" onPerform={async () => {\n        worldProgram!.resetForNextRound(worldState!, true);\n        worldState?.setData({ stepCounter: 0, round: 0, battleStartStep: 0, simulationEnded: false });\n      }} title=\"Restart\" />\n      <FontAwesomeButton flat={true} icon=\"camera\" toggled={cameraMode === 'free'}\n        onClick={() => worldState?.setData({ cameraMode: cameraMode === 'rts' ? 'free' : 'rts' })}\n        title=\"Toggle camera mode\" />\n      <EnumEditor\n        value={simulationSpeed}\n        onChange={simulationSpeed => worldState?.setData({ simulationSpeed })}\n        variants={[\n          { displayName: '1x', value: 1 },\n          { displayName: '1/2x', value: 1/2 },\n          { displayName: '1/4x', value: 1/4 },\n          { displayName: '1/8x', value: 1/8 },\n        ]}\n        />\n      <FontAwesomeButton flat={true} icon=\"door-open\" onPerform={async () => {\n        await onExit();\n      }} title=\"Exit replay\" />\n    </ItemsRow>\n  </ItemsColumn>\n}\n\nfunction BattleHUD() {\n  const { teams } = useWorldDataSelect('teams');\n  if (!teams) {\n    return null;\n  }\n  return <ItemsColumn className=\"BattleHUD\">\n    <BattleScore />\n    <Row className=\"BattleHUDTeams\">\n      <div className=\"BattleHUDTeamsLeft\">\n        {teams.home.dbTeam && <TeamName team={teams.home.dbTeam} />}\n      </div>\n      &nbsp;vs&nbsp;\n      <div className=\"BattleHUDTeamsRight\">\n        {teams.away.dbTeam && <TeamName team={teams.away.dbTeam} />}\n      </div>\n    </Row>\n    <RoundClock />\n  </ItemsColumn>\n}\n\nexport function TeamName({ team }: { team: DbTeam }) {\n  const user = useFirebaseStreamDocument<DbUserProfile>(Db.userProfiles, team.ownerId);\n  if (team.matches < MinGamesRanked) {\n    return <WonkyPanel className=\"TeamName\" shadowPx={0} fill=\"#000\">\n      {user.status === 'loaded' ? user.value.displayName : ''}&nbsp;<small>Unranked</small>\n    </WonkyPanel>;\n  }\n  return <WonkyPanel className=\"TeamName\" shadowPx={0} fill={divisionColor(team.division!)}>\n    {user.status === 'loaded' ? user.value.displayName : ''}&nbsp;\n    <small>{!isNullOrUndefined(team.rank) && <span>#{team.rank + 1} in </span>}{divisionName(team.division!)}</small>\n  </WonkyPanel>;\n}\n\nfunction RewardItem({ itemId }: { itemId: string }) {\n  const item = useFirebaseStreamDocument<DbItemInstance>(Db.items, itemId);\n  if (item.status !== 'loaded') {\n    return null;\n  }\n  return <ItemIcon item={item.value.item} />\n}\n\nfunction ThrowTestException(): React.ReactElement {\n  throw new Error('TestErrorRender');\n}\n\nfunction WorldPageDebugPanel() {\n  const { rendererConfig } = useWorldDataSelect('rendererConfig');\n  const worldState = React.useContext(WorldStateContext);\n  const [showTestError, setShowTestError] = React.useState<boolean>(false);\n  if (!worldState) {\n    return null;\n  }\n  return <Panel mode={PanelMode.Floating} title=\"Renderer\">\n    <TabsContainer>\n      <Tab title=\"ECS\">\n        <ECSInspector />\n      </Tab>\n      <Tab title=\"Weights histogram\">\n        <ScrollableColumn>\n          <WeightsHistogram />\n        </ScrollableColumn>\n      </Tab>\n      <Tab title=\"Training stats\">\n        <ScrollableColumn>\n          <TrainingStats />\n        </ScrollableColumn>\n      </Tab>\n      <Tab title=\"Tools\">\n        <Button onClick={() => { throw new Error('TestErrorTrigger') }}>Trigger an onClick exception</Button>\n        <Button onClick={() => setShowTestError(true)}>Trigger an exception during rendering</Button>\n        {showTestError && <ThrowTestException />}\n      </Tab>\n      <Tab title=\"Renderer\">\n        <ScrollableColumn>\n          <AnyEditor\n            typedef={GpuWorldRendererOptionsTypedef()}\n            value={rendererConfig}\n            onChange={r => { worldState.setData({ rendererConfig: r }); worldState.ensureRendered(); }} />\n        </ScrollableColumn>\n      </Tab>\n      <Tab title=\"JSON renderer\">\n        <textarea>{JSON.stringify(rendererConfig, null, 2)}</textarea>\n      </Tab>\n    </TabsContainer>\n  </Panel>;\n}\nfunction TrainingStats() {\n  const { trainingStats } = useWorldDataSelect('trainingStats');\n  if (!trainingStats) {\n    return null;\n  }\n  return <Column>\n    <Plot lines={Object.keys(trainingStats).map(key => ({\n      label: key,\n      data: trainingStats[key]\n    }))}/>\n  </Column>\n}\n\nfunction BrainHistogramView({ keys, writeRectTo }: { keys: string[], writeRectTo: string }) {\n  const worldState = React.useContext(WorldStateContext);\n  const [rect, setRect] = React.useState<ClientRect>();\n  React.useEffect(() => {\n    if (worldState && rect) {\n      worldState.setData({ [writeRectTo]: rect });\n    }\n  }, [worldState, rect, writeRectTo]);\n  if (!worldState) {\n    return null;\n  }\n  return <Block className=\"BrainHistogram\">\n    <Row>\n      <Column className=\"BrainHistogramKeys\">\n        {keys.map((key, i) => <Row key={i}>{key}</Row>)}\n      </Column>\n      <MeasuredDiv className=\"BrainHistogramView\" onSize={setRect}>\n      </MeasuredDiv>\n    </Row>\n  </Block>\n}\n\n\nfunction FPSCounter() {\n  const { gameLoopStats } = useWorldDataSelect('gameLoopStats');\n  if (!gameLoopStats) {\n    return null;\n  }\n  const perfString = `${Math.round(1000 / gameLoopStats.msPerFrame)} fps - ${Math.round(gameLoopStats.stepsPerSecond)} sps`;\n  return <small className=\"FPSCounter\">{perfString}</small>;\n}\n\nconst WorldLogCategoryColors = {};\nfunction getWorldLogCategoryColor(category: string) {\n  if (WorldLogCategoryColors[category]) {\n    return WorldLogCategoryColors[category];\n  }\n  return WorldLogCategoryColors[category] = stringToRGBHex(category);\n}\nexport function WorldLog() {\n  const { log } = useWorldDataSelect('log');\n  const [userScroll, setUserScroll] = React.useState<boolean>(false);\n  const logDiv = React.useRef<HTMLDivElement | null>(null);\n  React.useEffect(() => {\n    if (!userScroll) {\n      setTimeout(() => {\n        if (logDiv.current) {\n          logDiv.current.scrollTo(0, logDiv.current.scrollHeight)\n        }\n      }, 1);\n    }\n  }, [log, userScroll]);\n  // Just to make sure the time updates/outdate entries\n  const [, refresh] = React.useState<{}>();\n  useInterval(() => refresh({}), 1000);\n  if (!log) {\n    return null;\n  }\n  const outdated = new Date(Date.now() - 1000 * 10);\n  return <div className=\"WorldLog\"\n      onScroll={e => {\n        const d = (e.target as HTMLDivElement);\n        setUserScroll(d.scrollTop + d.getBoundingClientRect().height < d.scrollHeight);\n      }}\n      ref={logDiv}>\n    {log.slice(log.length - 100, log.length).map((entry, i) => <div\n      key={i}\n      className={`WorldLogEntry ${entry.time < outdated ? `WorldLogEntryOld` : ''}`}\n      title={new PixlingTimespan(entry.step).toString()}\n      >\n      <span style={{ color: getWorldLogCategoryColor(entry.category) }}>[{entry.category}]&nbsp;</span>\n      {entry.message.join('')}\n    </div>)}\n  </div>\n}\n","import * as React from 'react';\nimport * as Sentry from '@sentry/browser';\nimport { Button } from './Button';\n\nexport interface ErrorBoundaryProps {\n  title?: string;\n}\n\nexport class ErrorBoundary extends React.Component<ErrorBoundaryProps> {\n  state = { hasError: false };\n\n  static getDerivedStateFromError(error) {\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    Sentry.captureException(error);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      const { title = 'Something went wrong' } = this.props;\n      return <div className=\"ErrorBoundary\">\n        <h1>{title}</h1>\n        <Button onClick={() => this.setState({ hasError: false })}>\n          Retry\n        </Button>\n      </div>;\n    }\n\n    return this.props.children;\n  }\n}","import { base62uuid, getBrowser, isMobile } from \"../Util\";\nimport firebase from 'firebase/app';\nimport { Db, full, DbSession, CurrentSeason } from \"db\";\nimport { version } from \"../version\";\n\nexport class SessionRecorder {\n  constructor(public user: firebase.User) {\n    if (user) {\n      this.doc.set(full<DbSession>({\n        id: this.id,\n        season: CurrentSeason,\n        userId: user.uid,\n\n        started: firebase.firestore.Timestamp.now(),\n        lastActive: firebase.firestore.Timestamp.now(),\n        minutesInteracting: 0,\n\n        appVersion: version.build,\n        browser: getBrowser(),\n        screenSize: { width: window.screen.width, height: window.screen.height },\n        isMobile: isMobile(),\n\n        battles: 0,\n        trainings: 0,\n      }));\n    }\n  }\n  static Current?: SessionRecorder;\n  static init() {\n    if (!version.isDevelopment) {\n      firebase.auth().onAuthStateChanged(user => {\n        SessionRecorder.Current = user ? new SessionRecorder(user) : undefined;\n      });\n    }\n    document.addEventListener('click', () => SessionRecorder.Current?.onDocumentClick());\n    window.setInterval(() => SessionRecorder.Current?.onMinuteTicker(), 60*1000);\n  }\n  id = base62uuid();\n  private doc = firebase.firestore().collection(Db.sessions).doc(this.id);\n  private clicksLastMinute = 0;\n  onDocumentClick() {\n    this.clicksLastMinute++;\n  }\n  onMinuteTicker() {\n    const wasActive = this.clicksLastMinute > 0;\n    if (wasActive) {\n      this.doc.update({\n        lastActive: firebase.firestore.Timestamp.now(),\n        minutesInteracting: firebase.firestore.FieldValue.increment(1)\n      });\n    }\n    this.clicksLastMinute = 0;\n  }\n  onClickTrain() {\n    this.doc.update({\n      trainings: firebase.firestore.FieldValue.increment(1)\n    });\n  }\n  onClickBattle() {\n    this.doc.update({\n      battles: firebase.firestore.FieldValue.increment(1)\n    });\n  }\n}\n","import * as glMatrix from \"gl-matrix\";\n\ndeclare module 'gl-matrix' {\n  module vec2 {\n    function fromPolarCoordinates(angle: number, radius: number): vec2;\n  }\n  module vec3 {\n    function fromPolarCoordinates(angle: number, radius: number): vec3;\n    function fromSphericalCoordinates(theta: number, phi: number, radius: number): vec3;\n    function mix(out: vec3, a: vec3, b: vec3, p: number): vec3;\n  }\n}\n\nglMatrix.vec2.fromPolarCoordinates = (angle: number, radius: number): glMatrix.vec2 => {\n  return glMatrix.vec2.fromValues(Math.cos(angle) * radius, Math.sin(angle) * radius);\n}\nglMatrix.vec3.fromPolarCoordinates = (angle: number, radius: number): glMatrix.vec3 => {\n  return glMatrix.vec3.fromValues(Math.cos(angle) * radius, Math.sin(angle) * radius, 0);\n}\nglMatrix.vec3.fromSphericalCoordinates = (theta: number, phi: number, radius: number): glMatrix.vec3 => {\n  return glMatrix.vec3.fromValues(\n    Math.sin(theta) * Math.cos(phi) * radius,\n    Math.sin(theta) * Math.sin(phi) * radius,\n    Math.cos(theta) * radius\n  );\n}\n\nglMatrix.vec3.mix = (out: glMatrix.vec3, a: glMatrix.vec3, b: glMatrix.vec3, p: number): glMatrix.vec3 => {\n  return glMatrix.vec3.add(out,\n    glMatrix.vec3.scale(glMatrix.vec3.create(), a, 1 - p),\n    glMatrix.vec3.scale(glMatrix.vec3.create(), b, p));\n}\n","import firebase from 'firebase/app';\n\nconst Cookies = document.cookie.split(';').reduce((p, x) => {\n  const [key, value] = x.trim().split('=');\n  return {...p, [key]: value };\n}, {});\nexport const ElectronInfo: undefined | {\n  platform: string;\n  isDevelopment: boolean\n} = Cookies['electronInfo'] ? JSON.parse(Cookies['electronInfo']) : undefined;\nexport const IsInElectron = !!ElectronInfo;\nif (IsInElectron) {\n  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);\n}\n","import * as React from 'react';\nimport { useFirebaseStreamDocument, FirebaseLoading, FirebaseStreamDocumentResult } from '../../Components/Firebase';\nimport { DbUserSettings, Db, getTeamId, CurrentSeason, partial, DbCreature, DbItemInstance, DbUserProfile, DbBattleground } from 'db';\nimport { MaterialIconButton, Button } from '../../Components/Button';\nimport { Popup } from '../../Components/Popup';\nimport { ScrollVertical, VerticalLeft, Column, Row } from '../../Components/Layout';\nimport { AnyEditor } from '../../Components/Editors';\nimport firebase from 'firebase/app';\nimport { editorStructTypedef } from '../../Components/Editors/EditorTypedefs';\nimport { AudioPlayerInstance } from '../../GpuWorld/Audio';\nimport { useDialog, Dialog } from '../../Components/Dialog';\n\nexport function UserSettingsButton({ loggedInUser }: { loggedInUser: firebase.User }) {\n  const [showPopup, setShowPopup] = React.useState(false);\n  return <span className=\"UserSettings\">\n    <MaterialIconButton flat={true} onClick={() => setShowPopup(!showPopup)}\n      icon=\"settings\" purpose=\"OpenUserSettings\" title=\"User settings\" />\n    {showPopup && <Popup fullscreen={true} onClose={() => setShowPopup(false)}>\n      <UserSettings loggedInUser={loggedInUser} />\n    </Popup>}\n  </span>\n}\n\nconst UserSettingsTypedef = editorStructTypedef<DbUserSettings>({\n  properties: {\n    sound: { metatype: 'boolean' },\n    volume: { metatype: 'float', suffix: '%' },\n    musicVolume: { metatype: 'float', suffix: '%' },\n    environmentVolume: { metatype: 'float', suffix: '%' },\n    soundEffectsVolume: { metatype: 'float', suffix: '%' },\n    mouseWheelSensitivity: { metatype: 'float' },\n    advancedTrainingSettings: { metatype: 'boolean' }\n  }\n});\n\nfunction UserSettings({ loggedInUser }: { loggedInUser: firebase.User }) {\n  const userSettings = useFirebaseStreamDocument<DbUserSettings>(Db.userSettings, loggedInUser.uid);\n  const userProfile = useFirebaseStreamDocument<DbUserProfile>(Db.userProfiles, loggedInUser.uid);\n  const dialog = useDialog();\n  if (userSettings.status !== 'loaded' || userProfile.status !== 'loaded') {\n    return <FirebaseLoading pending={[userSettings]} />;\n  }\n  return <Column>\n    <Dialog state={dialog.current} />\n    <h3>Settings</h3>\n    <Row>\n      <Button onPerform={async () => {\n          if (!loggedInUser.email) {\n            await dialog.alert('No email associated with this account, cannot reset password.');\n          } else if (await dialog.confirm('Send password reset email?')) {\n            await firebase.auth().sendPasswordResetEmail(loggedInUser.email);\n          }\n        }}>\n          Reset password\n      </Button>\n      <Button onPerform={async () => {\n        const newName = await dialog.prompt('New name', userProfile.value.displayName);\n          if (newName) {\n            await firebase.firestore().collection(Db.userProfiles).doc(loggedInUser.uid).update(partial<DbUserProfile>({\n              displayName: newName\n            }));\n          }\n        }}>\n        Change name ({userProfile.value.displayName})\n      </Button>\n      <Button onPerform={async () => {\n        if (await dialog.confirm('Are you sure? This will reset the game for you completely; it will remove all creatures, items and team points.')) {\n          const items = await firebase.firestore().collection(Db.items)\n            .where('ownerId', '==', loggedInUser.uid)\n            .where('season', '==', CurrentSeason)\n            .get();\n          const batch = firebase.firestore().batch();\n          for (const item of items.docs) {\n            batch.update(item.ref, partial<DbItemInstance>({\n              deleted: true\n            }));\n          }\n          const creatures = await firebase.firestore().collection(Db.creatures)\n            .where('ownerId', '==', loggedInUser.uid)\n            .where('season', '==', CurrentSeason)\n            .get();\n          for (const creature of creatures.docs) {\n            batch.update(creature.ref, partial<DbCreature>({\n              deleted: true\n            }));\n          }\n          const soloTeam = firebase.firestore().collection(Db.teams).doc(getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Solo));\n          const duoTeam = firebase.firestore().collection(Db.teams).doc(getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Duo));\n          const squadTeam = firebase.firestore().collection(Db.teams).doc(getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Team));\n          batch.delete(soloTeam);\n          batch.delete(duoTeam);\n          batch.delete(squadTeam);\n          await batch.commit();\n          window.location.reload();\n        }\n      }}>\n        Factory reset game\n      </Button>\n    </Row>\n    <ScrollVertical>\n      <VerticalLeft>\n        <AnyEditor\n          typedef={UserSettingsTypedef}\n          value={userSettings.value}\n          onChange={settings => {\n            firebase.firestore().collection(Db.userSettings).doc(loggedInUser.uid)\n              .update(settings);\n          }}\n          />\n      </VerticalLeft>\n    </ScrollVertical>\n  </Column>\n}\n\nexport function useUserSettingsAudioSync(userSettings: FirebaseStreamDocumentResult<DbUserSettings>) {\n  React.useEffect(() => {\n    if (userSettings.status === 'loaded' && AudioPlayerInstance) {\n      if (userSettings.value.sound) {\n        AudioPlayerInstance.audioContext.resume();\n      } else {\n        AudioPlayerInstance.audioContext.suspend();\n      }\n      AudioPlayerInstance.masterGain.gain.setValueAtTime(userSettings.value.volume / 100, AudioPlayerInstance.audioContext.currentTime);\n      AudioPlayerInstance.musicGain.gain.setValueAtTime(userSettings.value.musicVolume / 100, AudioPlayerInstance.audioContext.currentTime);\n      AudioPlayerInstance.environmentGain.gain.setValueAtTime(userSettings.value.environmentVolume / 100, AudioPlayerInstance.audioContext.currentTime);\n      AudioPlayerInstance.effectsGain.gain.setValueAtTime(userSettings.value.soundEffectsVolume / 100, AudioPlayerInstance.audioContext.currentTime);\n    }\n  }, [userSettings]);\n}\n","import * as React from 'react';\nimport './index.css';\nimport { Column, Row, ScrollableColumn, ItemsRow, ItemsColumn, BlockSection } from \"../../Components/Layout\";\nimport { Button, MaterialIconButton, FontAwesomeButton } from \"../../Components/Button\";\nimport firebase from 'firebase/app';\nimport { version } from '../../version';\nimport { WonkyPanel, evenPadding } from '../../Components/WonkyPanel';\nimport { FloatingPanelColor } from '../../Components/Panel';\nimport { Seasons, CurrentSeason, partial, teamSize, getTeamId, DbUser, Db, DbUserSettings, DbBattleground, MaxTeamSize, BattlesToUnlockDuo, BattlesToUnlockTeam, emptyTrainingSetup, TrainingSetup, MinGamesRanked } from 'db';\nimport { FirebaseLoading, useFirebaseStreamDocument, FirebaseStreamDocumentResult, useFirebaseStreamQueryTo } from '../../Components/Firebase';\nimport { DbTeam, DbCreature, DbItemInstance } from 'db';\nimport { useDialog, Dialog } from '../../Components/Dialog';\nimport { ActionMenu } from '../../Components/Menu';\nimport { CreaturePortrait } from '../CreaturePortrait';\nimport { Popup } from '../../Components/Popup';\nimport { arrayReplaceIndex, wait, arrayRemoveIndex } from '../../Util';\nimport { WorldCanvas } from '../../Components/WorldCanvas';\nimport { GameComponent } from '../WorldPage';\nimport LogoPng from '../../Images/Logo.png';\nimport { AudioPlayerInstance } from '../../GpuWorld/Audio';\nimport { SoundEffect } from '../../GpuWorld/StateLayout';\nimport { useIsFullscreen, exitFullscreen, enterFullscreen } from '../../Components/Fullscreen';\nimport { IsInElectron } from '../Electron';\nimport { SessionRecorder } from '../SessionRecorder';\nimport { RoutingHistory } from '../../Components/Routing';\nimport { UserSettingsButton, useUserSettingsAudioSync } from '../UserSettings';\nimport { UnitDef } from '../../GpuWorld/UnitDef';\nimport { ReplaysBrowser } from '../ReplaysBrowser';\nimport { AppStateContext, useAppStateSelect, AppState } from '../AppState';\nimport { EnumEditor, NumberEditor } from '../../Components/Editors';\nimport { Store } from '../../Components/Store';\nimport { CreaturesBrowser, unitsFromUrls } from '../Creatures';\nimport { Inventory } from '../Items';\nimport { stringifyDerkUrl, parseDerkUrl, DerkUrlDropTarget, DraggableDerkUrl } from '../DerkUrl';\nimport { Leaderboard } from '../Leaderboard';\nimport { TeamName } from '../WorldPage/GameUI';\n// import BattleIconPng from './BattleIcon.png';\n\nconst SeasonEndTime = Seasons[CurrentSeason].end;\nconst SeasonEnded = SeasonEndTime && new Date() > SeasonEndTime;\n\nfunction useSeasonEnded() {\n  const [seasonEnded, setSeasonEnded] = React.useState(SeasonEnded);\n  React.useEffect(() => {\n    if (!SeasonEnded) {\n      if (SeasonEndTime) {\n        const dtime = SeasonEndTime.getTime() - Date.now();\n        window.setTimeout(() => setSeasonEnded(true), dtime);\n      }\n    }\n  }, []);\n  return seasonEnded;\n}\n\nexport function MainMenu({ loggedInUser, loggedInUserData }: { loggedInUser: firebase.User, loggedInUserData: DbUser }) {\n  const userSettings = useFirebaseStreamDocument<DbUserSettings>(Db.userSettings, loggedInUser.uid);\n  const userSettingsDoc = firebase.firestore().collection(Db.userSettings).doc(loggedInUser.uid);\n  useUserSettingsAudioSync(userSettings);\n  AudioPlayerInstance?.ensureWindStarted();\n  const seasonEnded = useSeasonEnded();\n  const appState = React.useContext(AppStateContext);\n\n  useFirebaseStreamQueryTo({\n    collection: Db.creatures,\n    where: [['ownerId', '==', loggedInUser.uid], ['season', '==', CurrentSeason], ['deleted', '==', false]],\n    orderBy: [{ field: 'created' }]\n  }, snapshot => appState.update({ creatures: { status: 'loaded', values: snapshot.docs.map(d => ({ id: d.id, ...d.data() as DbCreature})) } }));\n\n  useFirebaseStreamQueryTo({\n    collection: Db.items,\n    where: [['ownerId', '==', loggedInUser.uid], ['season', '==', CurrentSeason], ['deleted', '==', false]],\n    orderBy: [{ field: 'created' }]\n  }, snapshot => appState.update({ items: { status: 'loaded', values: snapshot.docs.map(d => ({ id: d.id, ...d.data() as DbItemInstance})) } }));\n\n  const { creatures, items, gameInstance } = useAppStateSelect('creatures', 'items', 'gameInstance');\n\n  const battleground = (userSettings.status === 'loaded' ? userSettings.value.battleground : null) ?? DbBattleground.Solo;\n  const soloTeam = useFirebaseStreamDocument<DbTeam>(Db.teams, getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Solo));\n  const duoTeam = useFirebaseStreamDocument<DbTeam>(Db.teams, getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Duo));\n  const squadTeam = useFirebaseStreamDocument<DbTeam>(Db.teams, getTeamId(loggedInUser.uid, CurrentSeason, DbBattleground.Team));\n  const [showReplays, setShowReplays] = React.useState(false);\n\n  React.useEffect(() => { AudioPlayerInstance?.startMusic(); }, []);\n  const dialog = useDialog();\n  const isFullscreen = useIsFullscreen();\n  const { hideUI } = useAppStateSelect('hideUI');\n  const [hasEntered, setHasEntered] = React.useState(false);\n  if (creatures.status !== 'loaded' || soloTeam.status === 'loading' || duoTeam.status === 'loading' || squadTeam.status === 'loading' || items.status === 'loading') {\n    return <FirebaseLoading pending={[creatures, soloTeam, duoTeam, squadTeam, items]} />;\n  }\n  if (seasonEnded) {\n    return <Column className=\"MainMenu\">\n      Season {CurrentSeason} has ended. Please stand by while the next season is starting.\n    </Column>\n  }\n  const enter = async () => {\n    if (userSettings.status === 'loaded' && userSettings.value.sound) {\n      AudioPlayerInstance?.audioContext.resume();\n    }\n    AudioPlayerInstance?.playSoundEffect(SoundEffect.Gunshot);\n    await wait(10);\n    if (soloTeam.status === 'no-such-document') {\n      await firebase.functions().httpsCallable('createTeam')({ battleground: DbBattleground.Solo });\n    }\n    if (duoTeam.status === 'no-such-document') {\n      await firebase.functions().httpsCallable('createTeam')({ battleground: DbBattleground.Duo });\n    }\n    if (squadTeam.status === 'no-such-document') {\n      await firebase.functions().httpsCallable('createTeam')({ battleground: DbBattleground.Team });\n    }\n    setHasEntered(true);\n  }\n  const toggleFullscreen = () => {\n    if (isFullscreen) {\n      exitFullscreen();\n    } else {\n      enterFullscreen();\n    }\n  }\n\n  const duoEnabled = (soloTeam.status === 'loaded' && soloTeam.value.matches >= BattlesToUnlockDuo) || version.isDevelopment;\n  const squadEnabled = (duoTeam.status === 'loaded' && duoTeam.value.matches >= BattlesToUnlockTeam) || version.isDevelopment;\n  return <div className=\"MainMenuContainer\">\n    <Dialog state={dialog.current} />\n    <WorldCanvas>\n      <GameComponent\n        loggedInUser={loggedInUser}\n        loggedInUserData={loggedInUserData}\n        />\n    </WorldCanvas>\n    <div className={`MainMenu ${gameInstance.type !== 'none' ? 'MainMenuPlaying' : ''}`}>\n      {!hasEntered ? <div className=\"MainMenuEnter\">\n        <img src={LogoPng} alt=\"Logo\" />\n        <Button onPerform={enter} disabled={hasEntered} className=\"MainMenuEnterBattlegrounds\" primary={true}>Enter</Button>\n      </div> : <WonkyPanel\n        className=\"MainMenuPanel\"\n        shadowPx={5}\n        borderPx={evenPadding(10)}\n        paddingPx={evenPadding(5)}\n        fill={FloatingPanelColor}\n        >\n        <Row>\n          <Column className=\"MainMenuLeft\">\n            <CreaturesBrowser />\n            <Inventory />\n            <MainMenuTraining />\n          </Column>\n          <Column className=\"MainMenuRight\">\n            <Row className=\"MainMenuLogo\">\n              <img src={LogoPng} alt=\"Logo\" />\n            </Row>\n            <ItemsColumn>\n              {/* <FontAwesomeButton icon=\"video\" flat={true} onClick={() => setShowReplays(true)}>\n                View replays\n              </FontAwesomeButton> */}\n              <ItemsRow>\n                <Button flat={true}\n                  toggled={battleground === DbBattleground.Solo}\n                  title=\"1v1\"\n                  className={`MainMenuBattle${DbBattleground.Solo}`}\n                  onClick={() => userSettingsDoc.update(partial<DbUserSettings>({ battleground: DbBattleground.Solo }))}>\n                  Solo\n                </Button>\n                <Button flat={true}\n                  toggled={battleground === DbBattleground.Duo}\n                  disabled={!duoEnabled}\n                  title={duoEnabled ? '2v2' : `You must play at least ${BattlesToUnlockDuo} solo battles to enter the duo battleground`}\n                  className={`MainMenuBattle${DbBattleground.Duo}`}\n                  onClick={() => userSettingsDoc.update(partial<DbUserSettings>({ battleground: DbBattleground.Duo }))}>\n                  Duo\n                </Button>\n                <Button flat={true}\n                  toggled={battleground === DbBattleground.Team}\n                  disabled={!squadEnabled}\n                  title={squadEnabled ? '4v4' : `You must play at least ${BattlesToUnlockTeam} duo battles to enter the team battleground`}\n                  className={`MainMenuBattle${DbBattleground.Team}`}\n                  onClick={() => userSettingsDoc.update(partial<DbUserSettings>({ battleground: DbBattleground.Team }))}>\n                  Team\n                </Button>\n              </ItemsRow>\n            </ItemsColumn>\n            <MainMenuBattle\n              team={battleground === DbBattleground.Solo ? soloTeam\n                : battleground === DbBattleground.Duo ? duoTeam\n                : squadTeam}\n              battleground={battleground} />\n          </Column>\n        </Row>\n      </WonkyPanel>}\n    </div>\n\n    <ItemsRow className=\"MainMenuTopRight\">\n      {version.backend !== 'production' && <span>DERK TEST SERVER</span>}\n      <MaterialIconButton flat={true} onClick={toggleFullscreen} icon={isFullscreen ? 'fullscreen_exit' : 'fullscreen'} title=\"Fullscreen\" purpose=\"Fullscreen\" />\n      <MaterialIconButton icon=\"web\" flat={true} toggled={hideUI} title=\"Show/hide UI\" onClick={() => appState.update({ hideUI: !hideUI })} />\n      {userSettings.status === 'loaded' && <FontAwesomeButton icon={userSettings.value.sound  ? 'volume-up' : 'volume-off'} flat={true} title=\"Toggle audio\" onClick={() => userSettingsDoc.update(partial<DbUserSettings>({ sound: !userSettings.value.sound }))} />}\n      <UserSettingsButton loggedInUser={loggedInUser} />\n      <a href=\"https://discord.gg/ZBRwc5b\" target=\"_blank\" rel=\"noopener noreferrer\">\n        <FontAwesomeButton icon=\"discord\" iconStyle=\"brand\" flat={true} title=\"Open discord\" />\n      </a>\n      <a href=\"https://gym.derkgame.com\" target=\"_blank\" rel=\"noopener noreferrer\">\n        <FontAwesomeButton icon=\"python\" iconStyle=\"brand\" flat={true} title=\"Go to Derk's Gym: Python RL Environment\" />\n      </a>\n      {version.deployment === 'production' ?\n        <FontAwesomeButton icon=\"vial\" flat={true} onPerform={async () => {\n          const result = await firebase.functions().httpsCallable('getTestingLoginToken')();\n          window.location.href = `https://test.derkgame.com/login/${result.data.token}`;\n        }} title=\"Switch to test server\" /> :\n        <FontAwesomeButton icon=\"vial\" toggled={true} flat={true}\n          onClick={() => window.location.href = 'https://app.derkgame.com'}\n          title=\"Switch to live server\" />\n      }\n      {IsInElectron ?\n        <FontAwesomeButton icon=\"times\" flat={true}\n            onPerform={async () => {\n              if (await dialog.confirm('Exit game?')) {\n                RoutingHistory.push('/exit');\n              }\n            }} title=\"Exit\">Exit</FontAwesomeButton>\n        : <FontAwesomeButton  icon=\"sign-out-alt\" flat={true} className=\"Signout\" title=\"Sign out\"\n          onPerform={async () => {\n            if (await dialog.confirm('Sign out?')) {\n              firebase.auth().signOut();\n            }\n          }} />\n      }\n    </ItemsRow>\n    {showReplays && <Popup onClose={() => setShowReplays(false)}>\n      <ReplaysBrowser onPlayReplay={replayId => {\n        appState.update({ gameInstance: { type: 'replay', replayId } });\n        setShowReplays(false);\n      }} />\n    </Popup>}\n  </div>;\n}\n\nfunction MainMenuBattle({ team, battleground }: { team: FirebaseStreamDocumentResult<DbTeam>, battleground: DbBattleground }) {\n  const { creatures = { status: 'loading' }, items = { status: 'loading' } } = useAppStateSelect('creatures', 'items');\n  const maxTeamSize = teamSize(battleground);\n  const battleTeamUrls: Array<string | null> = new Array(maxTeamSize).fill(null).map((_, i) => {\n    if (team.status === 'loaded') {\n      const id = team.value.creatureIds[i];\n      if (id) {\n        return stringifyDerkUrl({ collection: 'creatures', id });\n      }\n    }\n    return null;\n  });\n  const battleTeam = unitsFromUrls(creatures, items, battleTeamUrls);\n  const battleDisabled = battleTeam.filter(x => x).length === 0;\n  const dialog = useDialog();\n  const appState = React.useContext(AppStateContext);\n  if (team.status !== 'loaded') {\n    return <FirebaseLoading pending={[team]} />;\n  }\n  return <Column className=\"MainMenuBattle\">\n    <Dialog state={dialog.current} />\n    <ScrollableColumn className=\"MainMenuBattleBattleGroup\">\n      <Leaderboard season={CurrentSeason} battleground={battleground} />\n    </ScrollableColumn>\n    {team.status === 'loaded' && <TeamStats team={team.value} />}\n    <ItemsColumn className=\"MainMenuStartBattleContainer\">\n      <Button\n        className={`MainMenuStartBattle ${battleDisabled ? '' : 'MainMenuStartBattleEnabled'}`}\n        primary={true}\n        disabled={battleDisabled}\n        onPerform={async () => {\n          if (AudioPlayerInstance) {\n            AudioPlayerInstance.playSoundEffect(SoundEffect.HeavyDoorClose);\n            AudioPlayerInstance.highpassMusic();\n          }\n          await wait(1500);\n          appState.update({ gameInstance: { type: 'battle', battleground, homeTeam: battleTeam } });\n          SessionRecorder.Current?.onClickBattle();\n        }}>\n          Battle\n      </Button>\n    </ItemsColumn>\n    <Column className=\"MainMenuBattleTeam\">\n      <Row>\n        {new Array(MaxTeamSize).fill(0).map((_, i) => <UnitSlot\n          key={i}\n          slotUrl={battleTeamUrls[i]}\n          unit={battleTeam[i]}\n          enabled={i < maxTeamSize}\n          onSlotUrlChange={async newUrlString => {\n            const newBattleTeamUrls = arrayReplaceIndex(battleTeamUrls.map(x => x === newUrlString ? null : x), i, newUrlString);\n            const creatureIds = newBattleTeamUrls.map(urlString => {\n              if (urlString) {\n                const url = parseDerkUrl(urlString);\n                if (url.collection === 'creatures') {\n                  return url.id;\n                }\n              }\n              return null;\n            });\n            if (creatureIds.filter(x => x).length > teamSize(battleground)) {\n              await dialog.alert(`This team is full`);\n              return;\n            }\n            console.log('Drop battle team', { newBattleTeamUrls, creatureIds });\n            await firebase.firestore().collection(Db.teams).doc(team.value.id).update(partial<DbTeam>({\n              activated: creatureIds.filter(x => x).length > 0,\n              creatureIds\n            }));\n          }}\n          />)}\n      </Row>\n      <Column className=\"MainMenuBattleTeamTitle\">\n        <small>Battle team</small>\n      </Column>\n    </Column>\n  </Column>\n}\n\nfunction TeamStats({ team }: { team: DbTeam }) {\n  return <Column>\n    {team.matches < MinGamesRanked && <BlockSection>\n      <i><small>Play {MinGamesRanked - team.matches} more games to show up in rankings</small></i>\n    </BlockSection>}\n    <TeamName team={team} />\n  </Column>\n}\n\nexport function runNextScheduledTraining(appState: Store<AppState>) {\n  const { creatures, items, userSettings, scheduledTrainingIndex, scheduledEnd } = appState.state;\n  if (userSettings.status !== 'loaded') {\n    throw new Error(`User settings not loaded`);\n  }\n  const index = (scheduledTrainingIndex + 1) % userSettings.value.trainingSchedule.length;\n  const trainingEpoch = Math.floor((scheduledTrainingIndex + 1) / userSettings.value.trainingSchedule.length);\n  if (scheduledEnd >= 0) {\n    if (trainingEpoch >= scheduledEnd) {\n      return;\n    }\n  }\n  const schedule = userSettings.value.trainingSchedule[index];\n  const trainingSetup = userSettings.value.trainingSetups[schedule.setup];\n  const homeTrainTeam = unitsFromUrls(creatures, items, trainingSetup.homeTeamUrls);\n  const awayTrainTeam = unitsFromUrls(creatures, items, trainingSetup.awayTeamUrls);\n  const maxTeamSize = teamSize(trainingSetup.battleground);\n  appState.update({\n    gameInstance: {\n      type: 'train',\n      battleground: trainingSetup.battleground,\n      setupIndex: schedule.setup,\n      homeTeam: homeTrainTeam.slice(0, maxTeamSize),\n      awayTeam: awayTrainTeam.slice(0, maxTeamSize),\n      trainHome: true,\n      trainAway: false,\n      arenas: 128,\n      rounds: schedule.rounds,\n      turbo: true\n    },\n    scheduledTrainingIndex: scheduledTrainingIndex + 1\n  });\n}\n\nfunction TrainingSchedule({ onRun }: { onRun: () => void }) {\n  const { userSettings, loggedInUserId, scheduledEnd } = useAppStateSelect('loggedInUserId', 'userSettings', 'scheduledEnd');\n  const userSettingsDoc = firebase.firestore().collection(Db.userSettings).doc(loggedInUserId);\n  const appState = React.useContext(AppStateContext);\n  if (userSettings.status !== 'loaded') {\n    return <FirebaseLoading pending={[userSettings]} />;\n  }\n  const scheduleOk = userSettings.value.trainingSchedule.length > 0 &&\n    userSettings.value.trainingSchedule.reduce((p, x) => p && !!userSettings.value.trainingSetups[x.setup], true);\n  return <Column>\n    <h3>Scheduled training</h3>\n    <table>\n      <tbody>\n        <tr>\n          <td />\n          <td>Rounds</td>\n          <td />\n        </tr>\n        {userSettings.value.trainingSchedule.map((item, i) => <tr key={i}>\n          <td>\n            <EnumEditor\n              value={item.setup}\n              onChange={s => userSettingsDoc.update(partial<DbUserSettings>({\n                trainingSchedule: arrayReplaceIndex(userSettings.value.trainingSchedule, i, {\n                  ...item,\n                  setup: s\n                })\n              }))}\n              variants={userSettings.value.trainingSetups.map((s, l) => ({ displayName: s.name, value: l }))}\n              />\n          </td>\n          <td>\n            <NumberEditor\n              value={item.rounds}\n              onChange={s => userSettingsDoc.update(partial<DbUserSettings>({\n                trainingSchedule: arrayReplaceIndex(userSettings.value.trainingSchedule, i, {\n                  ...item,\n                  rounds: s\n                })\n              }))}\n              />\n          </td>\n          <td>\n            <FontAwesomeButton icon=\"trash\" flat={true} onClick={() => {\n              userSettingsDoc.update(partial<DbUserSettings>({\n                trainingSchedule: arrayRemoveIndex(userSettings.value.trainingSchedule, i)\n              }))\n            }} />\n          </td>\n        </tr>)}\n        <tr>\n          <td colSpan={2}>\n            <FontAwesomeButton icon=\"plus\" flat={true} onClick={() => {\n              userSettingsDoc.update(partial<DbUserSettings>({\n                trainingSchedule: [...userSettings.value.trainingSchedule, {\n                  setup: 0,\n                  rounds: 500\n                }]\n              }))\n            }}>Add</FontAwesomeButton>\n          </td>\n        </tr>\n      </tbody>\n    </table>\n    <Button primary={true} disabled={!scheduleOk} onClick={() => {\n      appState.update({ scheduledTrainingIndex: -1 });\n      runNextScheduledTraining(appState);\n      onRun();\n    }}>\n      Run schedule\n    </Button>\n    {scheduledEnd < 0 ? <small><Button flat={true} onClick={() => appState.update({ scheduledEnd: 1 })}>\n      Set fixed number of runs\n    </Button></small> : <Column>\n      <small>Max number of runs:</small>\n      <NumberEditor value={scheduledEnd} onChange={v => appState.update({ scheduledEnd: v })} />\n      <small><Button flat={true} onClick={() => appState.update({ scheduledEnd: -1 })}>\n        Remove\n      </Button></small>\n    </Column>}\n  </Column>\n}\n\nfunction MainMenuTraining() {\n  const { userSettings, loggedInUserId } = useAppStateSelect('loggedInUserId', 'userSettings');\n  const userSettingsDoc = firebase.firestore().collection(Db.userSettings).doc(loggedInUserId);\n  const [showSchedule, setShowSchedule] = React.useState(false);\n  const dialog = useDialog();\n  if (userSettings.status !== 'loaded') {\n    return <FirebaseLoading pending={[userSettings]} />;\n  }\n\n  const trainingSetup = userSettings.value.trainingSetups[userSettings.value.activeTrainingSetup];\n  return <Column className=\"MainMenuTraining\">\n    <Dialog state={dialog.current} />\n    <ItemsRow className=\"MainMenuTrainingSets\">\n      {userSettings.value.trainingSetups.map((ts, i) => <div key={i}>\n        <small>\n          <Button\n            flat={true}\n            toggled={userSettings.value.activeTrainingSetup === i}\n            onClick={() => userSettingsDoc.update(partial<DbUserSettings>({ activeTrainingSetup: i }))}\n            >{ts.name}</Button>\n          <ActionMenu actions={[\n            {\n              title: 'Rename',\n              onClick: async () => {\n                const newName = await dialog.prompt('New name', ts.name);\n                if (newName) {\n                  userSettingsDoc.update(partial<DbUserSettings>({\n                    trainingSetups: arrayReplaceIndex(userSettings.value.trainingSetups, i, {\n                      ...ts,\n                      name: newName\n                    })\n                  }))\n                }\n              }\n            },\n            {\n              title: 'Duplicate',\n              onClick: async () => {\n                userSettingsDoc.update(partial<DbUserSettings>({\n                  trainingSetups: [...userSettings.value.trainingSetups, {...trainingSetup, name: trainingSetup.name + ' copy'}],\n                  activeTrainingSetup: userSettings.value.trainingSetups.length\n                }));\n              }\n            },\n            {\n              title: 'Delete',\n              onClick: async () => {\n                if (await dialog.confirm('Delete?')) {\n                  userSettingsDoc.update(partial<DbUserSettings>({\n                    trainingSetups: arrayRemoveIndex(userSettings.value.trainingSetups, i),\n                    activeTrainingSetup: userSettings.value.activeTrainingSetup === i ? 0 : userSettings.value.activeTrainingSetup\n                  }));\n                }\n              }\n            }\n          ]} />\n          </small>\n      </div>)}\n      <small><FontAwesomeButton\n          flat={true}\n          icon=\"plus-circle\"\n          onClick={() => userSettingsDoc.update(partial<DbUserSettings>({\n            activeTrainingSetup: userSettings.value.trainingSetups.length,\n            trainingSetups: [...userSettings.value.trainingSetups, {\n              ...emptyTrainingSetup(),\n              name: 'Training ' + userSettings.value.trainingSetups.length,\n            }]\n          }))}\n          /></small>\n        <FontAwesomeButton flat={true} icon=\"calendar-alt\" onClick={() => setShowSchedule(true)} />\n    </ItemsRow>\n    {trainingSetup && <TrainingSetupEditor\n      value={trainingSetup}\n      onChange={async ts => {\n        await userSettingsDoc.update(partial<DbUserSettings>({\n          trainingSetups: arrayReplaceIndex(userSettings.value.trainingSetups, userSettings.value.activeTrainingSetup, ts)\n        }));\n      }}\n      trainingSetupIndex={userSettings.value.activeTrainingSetup}\n      />}\n    {showSchedule && <Popup onClose={() => setShowSchedule(false)}>\n      <TrainingSchedule onRun={() => setShowSchedule(false)} />\n    </Popup>}\n  </Column>\n}\n\nfunction TrainingSetupEditor({ value, onChange, trainingSetupIndex }: { value: TrainingSetup, onChange: (value: TrainingSetup) => void, trainingSetupIndex: number }) {\n  const { creatures, items } = useAppStateSelect('creatures', 'items');\n  const homeTrainTeam = unitsFromUrls(creatures, items, value.homeTeamUrls);\n  const awayTrainTeam = unitsFromUrls(creatures, items, value.awayTeamUrls);\n  const [arenaCount] = React.useState(128);\n  const [rounds, ] = React.useState(window.localStorage.puppeteerRounds ? parseInt(window.localStorage.puppeteerRounds) : Number.POSITIVE_INFINITY);\n  const dialog = useDialog();\n  const appState = React.useContext(AppStateContext);\n  const trainEnabled = (homeTrainTeam.filter(x => x && x.type === 'creature').length > 0 && value.trainHome) ||\n    (awayTrainTeam.filter(x => x && x.type === 'creature').length > 0 && value.trainAway);\n  const maxTeamSize = teamSize(value.battleground);\n\n  return <ItemsRow className=\"MainMenuTrainingTeams\">\n    <Dialog state={dialog.current} />\n    <Column className=\"MainMenuTrainingTeam MainMenuTrainingHome\">\n      <Row>\n        {new Array(MaxTeamSize).fill(0).map((_, i) => <Column key={i} className=\"TrainingSetupEditorHomeUnit\">\n          <UnitSlot\n            slotUrl={value.homeTeamUrls[i]}\n            unit={homeTrainTeam[i]}\n            enabled={i < maxTeamSize}\n            onSlotUrlChange={newId => {\n              onChange({\n                ...value,\n                homeTeamUrls: arrayReplaceIndex(value.homeTeamUrls.map(x => x === newId ? null : x), i, newId),\n                awayTeamUrls: value.awayTeamUrls.map(x => x === newId ? null : x)\n              });\n            }}\n            />\n          </Column>)}\n      </Row>\n      <ItemsRow>\n        <small>Trainees</small>\n        <FontAwesomeButton\n          icon=\"dumbbell\"\n          title={`Training is ${value.trainHome ? 'enabled' : 'disabled'} for this side`}\n          flat={true}\n          toggled={value.trainHome}\n          onClick={() => onChange({...value, trainHome: !value.trainHome})}\n          />\n      </ItemsRow>\n    </Column>\n    <ItemsColumn>\n      <EnumEditor\n        value={value.battleground}\n        onChange={bg => onChange({\n          ...value,\n          battleground: bg\n        })}\n        variants={[\n          { displayName: 'Solo', value: DbBattleground.Solo, className: 'Battleground' + DbBattleground.Solo },\n          { displayName: 'Duo', value: DbBattleground.Duo, className: 'Battleground' + DbBattleground.Duo },\n          { displayName: 'Team', value: DbBattleground.Team, className: 'Battleground' + DbBattleground.Team },\n        ]}\n        />\n      <Button\n        className={`MainMenuTrain ${trainEnabled ? 'MainMenuTrainEnabled' : ''}`}\n        primary={true}\n        onPerform={async () => {\n          if (trainEnabled || await dialog.confirm(`Nothing will be trained. Continue anyway?`)) {\n            if (AudioPlayerInstance) {\n              AudioPlayerInstance.playSoundEffect(SoundEffect.HeavyDoorClose);\n              AudioPlayerInstance.highpassMusic();\n            }\n            await wait(1500);\n            appState.update({\n              gameInstance: {\n                type: 'train',\n                battleground: value.battleground,\n                setupIndex: trainingSetupIndex,\n                homeTeam: homeTrainTeam.slice(0, maxTeamSize),\n                awayTeam: awayTrainTeam.slice(0, maxTeamSize),\n                trainHome: value.trainHome,\n                trainAway: value.trainAway,\n                arenas: arenaCount,\n                rounds,\n              }\n            });\n            SessionRecorder.Current?.onClickTrain();\n          }\n        }}\n        >\n        Train\n      </Button>\n      <ItemsRow>\n        <FontAwesomeButton\n          icon=\"exchange-alt\"\n          flat={true}\n          title=\"Swap training teams\"\n          onClick={() => {\n            onChange({\n              ...value,\n              homeTeamUrls: value.awayTeamUrls.slice(0, maxTeamSize),\n              awayTeamUrls: value.homeTeamUrls.slice(0, maxTeamSize)\n            });\n          }}\n          />\n      </ItemsRow>\n    </ItemsColumn>\n    <Column className=\"MainMenuTrainingTeam MainMenuTrainingAway\">\n      <Row>\n        {new Array(MaxTeamSize).fill(0).map((_, i) => <UnitSlot\n          key={i}\n          slotUrl={value.awayTeamUrls[i]}\n          unit={awayTrainTeam[i]}\n          enabled={i < maxTeamSize}\n          onSlotUrlChange={newId => {\n            onChange({\n              ...value,\n              homeTeamUrls: value.homeTeamUrls.map(x => x === newId ? null : x),\n              awayTeamUrls: arrayReplaceIndex(value.awayTeamUrls.map(x => x === newId ? null : x), i, newId)\n            });\n          }}\n          />)}\n      </Row>\n      <ItemsRow>\n        <small>Opponents</small>\n        <FontAwesomeButton\n          icon=\"dumbbell\"\n          title={`Training is ${value.trainAway ? 'enabled' : 'disabled'} for this side`}\n          flat={true}\n          toggled={value.trainAway}\n          onClick={() => onChange({...value, trainAway: !value.trainAway})}\n          />\n      </ItemsRow>\n    </Column>\n  </ItemsRow>\n}\n\nfunction UnitSlot({ slotUrl, unit, enabled, onSlotUrlChange }: { slotUrl: string | null, unit: UnitDef | undefined, enabled: boolean, onSlotUrlChange: (url: string | null) => void }) {\n  if (!enabled) {\n    return <WonkyPanel shadowPx={2} className=\"TrainTeamSlot TrainTeamSlotDisabled\">\n      <div className=\"TrainTeamSlotEmpty\" />\n    </WonkyPanel>\n  }\n  return <DerkUrlDropTarget\n    className=\"TeamSlot\"\n    accepts={url => {\n      if (url.collection === 'creatures') {\n        return true;\n      } else if (url.collection === 'items') {\n        return url.itemType === 'dummy-unit';\n      }\n      return false;\n    }}\n    onDrop={(url, urlString) => {\n      AudioPlayerInstance?.playSoundEffect(SoundEffect.StoneTick);\n      onSlotUrlChange(urlString);\n    }}\n  >\n    <WonkyPanel shadowPx={2} className=\"TrainTeamSlot\">\n      {slotUrl && unit ? <DraggableDerkUrl\n          url={slotUrl}\n          onDragStart={() => {\n            setTimeout(() => onSlotUrlChange(null), 10);\n          }}\n          >\n        <CreaturePortrait unit={unit} />\n      </DraggableDerkUrl> : <div className=\"TrainTeamSlotEmpty\" />}\n    </WonkyPanel>\n  </DerkUrlDropTarget>\n}\n\n","export default __webpack_public_path__ + \"static/media/MountRoukeLogo.de7f432f.svg\";","import firebase from 'firebase/app';\nimport * as React from 'react';\nimport moment from 'moment';\nimport { Button, FontAwesomeButton } from '../Components/Button';\nimport { FirebaseLogin } from '../Components/FirebaseLogin';\nimport { Panel, PanelMode } from '../Components/Panel';\nimport { Popup, PopupsContainer } from '../Components/Popup';\nimport { DbUser, DbBattle, Db, DbUserProfile, DbUserSettings, partial, dbUserHasGameAccess, parseTeamId, DbNotification } from 'db';\nimport { firebaseAuthUI } from '../firebase';\nimport './App.css';\nimport { useInterval } from \"../Components/Interval\";\nimport { useFirebaseStreamQuery, useFirebaseStreamDocument, FirebaseLoading, useFirebaseStreamDocumentTo } from '../Components/Firebase';\nimport { AdminUser, AdminGraphs, AdminFeedbackQueue, AdminLatestStoredPixlings, AdminUsers, AdminFunnel, AdminSessionListContainer, AdminTrainingStats, AdminUserBattleHistory, AdminCreature } from './Admin';\nimport ChangelogMdPath from '../Changelog.md';\nimport { ScrollVertical, Section, VerticalCentered, Column, Block } from '../Components/Layout';\nimport ReactMarkdown from 'react-markdown';\nimport EnergyModel05 from '../Images/EnergyModel05.png';\nimport EnergyModel052 from '../Images/EnergyModel052.png';\nimport LogoPng from '../Images/Logo.png';\nimport { BattleWinner } from 'db';\nimport { version } from '../version';\nimport * as Sentry from '@sentry/browser';\nimport { MainMenu } from './MainMenu';\nimport { RunGlUnitTests } from './Test/GlUnitTests';\nimport { TestArena } from './Test/TestArena';\nimport { IsInElectron } from './Electron';\nimport { Router, RoutingHistory } from '../Components/Routing';\nimport { Issues, NewIssue } from '../Components/Issues';\nimport { Store } from '../Components/Store';\nimport MountRoukeLogo from '../Images/MountRoukeLogo.svg';\nimport { createBatches } from '../GpuUtil/Computation';\nimport { useAppStateSelect, AppState, AppStateContext } from './AppState';\nimport { capitalizeFirstLetter } from '../Util';\nimport { SessionRecorder } from './SessionRecorder';\nimport { PopdownsContainer } from '../Components/Popdown';\n\nconst db = firebase.firestore();\n\nexport const LoggedInUserDataContext = React.createContext<DbUser | undefined>(undefined);\nexport const LoggedInUserContext = React.createContext<firebase.User | null>(null);\n\nexport function UserNameComponent({ userId, children }: { userId: string, children?: (name) => any }) {\n  const user = useFirebaseStreamDocument<DbUserProfile>(Db.userProfiles, userId);\n  if (user.status === 'loaded') {\n      return <span>{user.value.cpu && <span><i className=\"fas fa-desktop\" title=\"Cpu player\"/>&nbsp;</span>}{user.value.displayName}</span>\n  } else {\n    return null;\n  }\n}\n\n\n// interface UserPageProps {\n//   userId: string;\n// }\n// function UserPage({ userId }: UserPageProps) {\n//   const loggedInUser = React.useContext(LoggedInUserContext);\n//   // const loggedInUserData = React.useContext(LoggedInUserDataContext);\n//   const isOwnPage = loggedInUser && userId === loggedInUser.uid;\n//   const dialog = useDialog();\n//   return (\n//     <div className=\"User Page\">\n//       <Dialog state={dialog.current} />\n//       <div className=\"PageContent\">\n//         <LinkButton to=\"/\">Home</LinkButton>\n//         <h1><UserNameComponent userId={userId} /></h1>\n//         <Section>\n//           <div style={{ userSelect: 'text' }}>User id: {userId}</div>\n//           {/* {isOwnPage && loggedInUserData && loggedInUser && <Button onPerform={async () => {\n//               const name = await dialog.prompt('New name', loggedInUserData.displayName);\n//               if (name) {\n//                 await firebase.firestore().collection(Db.users).doc(loggedInUser.uid).update({ displayName: name });\n//               }\n//             }}>\n//               Change my name\n//           </Button>} */}\n//           {isOwnPage && loggedInUser && <Button onPerform={async () => {\n//               if (!loggedInUser.email) {\n//                 await dialog.alert('No email associated with this account');\n//               } else if (await dialog.confirm('Send password reset email?')) {\n//                 await firebase.auth().sendPasswordResetEmail(loggedInUser.email);\n//               }\n//             }}>\n//               Reset password\n//           </Button>}\n//         </Section>\n//         <Section>\n//           <Panel title=\"Teams\" mode={PanelMode.Floating}>\n//             <UserTeams userId={userId} />\n//           </Panel>\n//         </Section>\n//         {/* <Section>\n//           <Panel title=\"Speices\" mode={PanelMode.Floating}>\n//             <ScrollBoth>\n//               <UserSpecies userId={userId} />\n//             </ScrollBoth>\n//           </Panel>\n//         </Section> */}\n//       </div>\n//     </div>\n//   );\n// }\n\n// function Team({ team, selected, onSelect }: { team: DbTeam & { id: string }, selected?: boolean, onSelect?: () => void }) {\n//   const dialog = useDialog();\n//   const loggedInUser = React.useContext(LoggedInUserContext);\n//   const isOwner = loggedInUser ? loggedInUser.uid === team.ownerId : false;\n//   return <WonkyPanel className=\"Team\" shadowPx={5} strokeWidth={3} stroke={selected ? '#fff' : 'transparent'}>\n//     <Dialog state={dialog.current} />\n//     <Column>\n//       <ItemsRow>\n//         <div className=\"TeamName\" onClick={onSelect}>{team.name}</div>\n//         <small>#{team.groupRank + 1} in division {team.division}</small>\n//         <ActionMenu disabled={!isOwner} actions={[\n//           { title: 'Change name', onClick: async () => {\n//             const name = await dialog.prompt('New name');\n//             if (name) {\n//               await updateDbTeam(team.id, { name });\n//             }\n//           } },\n//         ]} />\n//       </ItemsRow>\n//       <ItemsRow>\n//         {/* {new Array(TeamSize).fill(0).map((_, i) => <TeamPixling\n//           key={i}\n//           swapable={isOwner}\n//           pixlingId={team.pixlingIds[i]}\n//           onPixlingIdChange={id => firebase.firestore().collection(Db.teams).doc(team.id).update(partial<DbTeam>({\n//             pixlingIds: arrayReplaceIndex(team.pixlingIds, i, id)\n//           }))}\n//           />)} */}\n//       </ItemsRow>\n//     </Column>\n//   </WonkyPanel>\n// }\n\n// function UserTeams({ userId }: { userId: string }) {\n//   const teams = useFirebaseStreamQuery<DbTeam>({\n//     collection: Db.teams,\n//     where: [['ownerId', '==', userId], ['deleted', '==', false], ['round', '==', CurrentSeason]]\n//   });\n//   if (teams.status !== 'loaded') {\n//     return <FirebaseLoading pending={[teams]} />;\n//   }\n//   return <FloatList>\n//     {teams.values.map(team => <Team key={team.id} team={team} />)}\n//   </FloatList>\n// }\n\n// function UserSpecies({ userId }: { userId: string }) {\n//   const species = useFirebaseStreamQuery<DbCreature>({\n//     collection: 'species',\n//     where: [['ownerId', '==', userId], ['season', '==', CurrentSeason], ['deleted', '==', false]]\n//   });\n//   if (species.status !== 'loaded') {\n//     return <FirebaseLoading pending={[species]} />;\n//   }\n//   return <FloatList>\n//     {species.values.map(species => <Creature key={species.id} draggable={false} creature={species} />)}\n//   </FloatList>;\n// }\n\n// function TeamPageBattle({ battle, side }: { battle: DbBattle, side: 'home' | 'away' }) {\n//   const homeTeam = useFirebaseStreamDocument<DbTeam>(Db.teams, battle.homeTeamId);\n//   const awayTeam = useFirebaseStreamDocument<DbTeam>(Db.teams, battle.awayTeamId);\n//   if (homeTeam.status !== 'loaded' || awayTeam.status !== 'loaded') {\n//     return <FirebaseLoading pending={[homeTeam, awayTeam]} />;\n//   }\n//   const opposingSide = side === 'home' ? 'away' : 'home';\n//   const homeName = battle.winner === 'home' ? <u>{homeTeam.value.name}</u> : <span>{homeTeam.value.name}</span>;\n//   const awayName = battle.winner === 'away' ? <u>{awayTeam.value.name}</u> : <span>{awayTeam.value.name}</span>;\n//   return <tr>\n//     <td>{\n//       battle.winner === side ? 'Winner' :\n//       battle.winner === opposingSide ? 'Loser' :\n//       battle.winner}</td>\n//     <td><small>{moment(battle.created.toDate()).fromNow()}</small></td>\n//     <td>{homeName} vs {awayName}</td>\n//     {battle.autoForfeit && <td><small title=\"This game was undecided for over one hour\">Auto-forfeited</small></td>}\n//   </tr>\n// }\n// function TeamPage({ teamId }: { teamId: string }) {\n//   const team = useFirebaseStreamDocument<DbTeam>(Db.teams, teamId);\n//   const homeBattles = useFirebaseStreamQuery<DbBattle>({\n//     collection: Db.battles,\n//     where: [['homeTeamId', '==', teamId]]\n//   });\n//   const awayBattles = useFirebaseStreamQuery<DbBattle>({\n//     collection: Db.battles,\n//     where: [['awayTeamId', '==', teamId]]\n//   });\n//   if (team.status !== 'loaded' || homeBattles.status !== 'loaded' || awayBattles.status !== 'loaded') {\n//     return <FirebaseLoading pending={[team, homeBattles]} />;\n//   }\n//   const battles = [\n//     ...homeBattles.values.map(battle => ({...battle, side: 'home' as 'home' | 'away' })),\n//     ...awayBattles.values.map(battle => ({...battle, side: 'away' as 'home' | 'away' })),\n//   ];\n//   battles.sort((a, b) => a.created.toDate() > b.created.toDate() ? -1 : 1);\n//   return <div className=\"Page\">\n//     <div className=\"PageContent\">\n//       <LinkButton to=\"/\">Home</LinkButton>\n//       <Panel mode={PanelMode.Floating} title=\"Team\">\n//         <Team team={{...team.value, id: teamId }} />\n//       </Panel>\n//       <Panel mode={PanelMode.Floating} title=\"Battle group\">\n//         <BattleGroup selfTeam={{...team.value, id: teamId }}  />\n//       </Panel>\n//       <Panel mode={PanelMode.Floating} title=\"Battles\">\n//         <div>\n//           <table>\n//             <tbody>\n//             {battles.map((battle, i) => <TeamPageBattle key={i} battle={battle} side={battle.side} />)}\n//             </tbody>\n//           </table>\n//         </div>\n//       </Panel>\n//     </div>\n//   </div>\n// }\n\nexport function BattleHistoryShort({ homeTeamId, awayTeamId, homeTeamName, awayTeamName }: { homeTeamId: string, awayTeamId: string, homeTeamName: string, awayTeamName: string }) {\n  const homeBattles = useFirebaseStreamQuery<DbBattle>({\n    collection: Db.battles,\n    where: [['homeTeamId', '==', homeTeamId], ['awayTeamId', '==', awayTeamId]],\n  });\n  const awayBattles = useFirebaseStreamQuery<DbBattle>({\n    collection: Db.battles,\n    where: [['homeTeamId', '==', awayTeamId], ['awayTeamId', '==', homeTeamId]],\n  });\n  if (homeBattles.status !== 'loaded' || awayBattles.status !== 'loaded') {\n    return <FirebaseLoading pending={[homeBattles, awayBattles]} />;\n  }\n  const homeHistory = homeBattles.values.map(x => ({\n    result: x.winner === BattleWinner.HomeWin ? 'Win' :\n      x.winner === BattleWinner.AwayWin ? 'Loss' :\n      x.winner === BattleWinner.Tie ? 'Tie' :\n      'Undecided',\n    created: x.created.toDate()\n  }));\n  const awayHistory = awayBattles.values.map(x => ({\n    result: x.winner === BattleWinner.AwayWin ? 'Win' :\n      x.winner === BattleWinner.HomeWin ? 'Loss' :\n      x.winner === BattleWinner.Tie ? 'Tie' :\n      'Undecided',\n    created: x.created.toDate()\n  }));\n  const history = [...homeHistory, ...awayHistory].sort((a, b) => a.created > b.created ? -1 : 1);\n  const homeWins = homeBattles.values.reduce((p, x) => p + (x.winner === BattleWinner.HomeWin ? 1 : 0), 0);\n  const awayWins = awayBattles.values.reduce((p, x) => p + (x.winner === BattleWinner.AwayWin ? 1 : 0), 0);\n  const homeLosses = homeBattles.values.reduce((p, x) => p + (x.winner === BattleWinner.AwayWin ? 1 : 0), 0);\n  const awayLosses = awayBattles.values.reduce((p, x) => p + (x.winner === BattleWinner.HomeWin ? 1 : 0), 0);\n  return <div>\n    <div>{homeTeamName} vs {awayTeamName}: {homeWins + awayWins} wins, {homeLosses + awayLosses} losses</div>\n    <div><small>{history.map(x => x.result).join('  ')}</small></div>\n  </div>;\n}\n\nexport function FormatRating({ value }: { value: number }) {\n  return <span title={'' + value}>{Math.round(value)}</span>;\n}\n\n// function Leaderboard({ round }: { round: number }) {\n//   if (round < 4) {\n//     return <LeaderboardELO round={round} />;\n//   } else {\n//     return <LeaderboardDivisions round={round} />;\n//   }\n// }\n// export function LeaderboardDivisions({ round }: { round: number }) {\n//   const teams = useFirebaseStreamQuery<DbTeam>({\n//     collection: Db.teams,\n//     where: [['deleted', '==', false], ['round', '==', round], ['activated', '==', true]],\n//     orderBy: [{ field: 'division', desc: false }, { field: 'points', desc: true }, { field: 'groupRank' }],\n//     limit: 100\n//   });\n//   if (teams.status !== 'loaded') {\n//     return <FirebaseLoading pending={[teams]} />;\n//   }\n//   const divisions: Array<Array<DbTeam & { id: string }>> = [];\n//   for (const team of teams.values) {\n//     divisions[team.division] = divisions[team.division] || [];\n//     divisions[team.division].push(team);\n//   }\n\n//   let placement = 1;\n//   return <Panel mode={PanelMode.Floating} title={`Leaderboard Season ${round}`} style={{ overflow: 'hidden' }}>\n//     <Column style={{ overflow: 'hidden' }}>\n//       {/* <BlockSection><small>Season {round} ending: {moment(Seasons[round].end).fromNow()} ({moment(Seasons[round].start).format('MMM Do YYYY')} to {moment(Seasons[round].end).format('MMM Do YYYY')})</small></BlockSection> */}\n//       <ScrollableColumn>\n//         {divisions.map((divTeams, division) => <div key={division} className=\"LeaderboardDivision\">\n//           <VerticalLeft className=\"LeaderboardDivisionLeft\">\n//             <div className=\"LeaderboardDivisionBorder\" />\n//             <div className=\"LeaderboardDivisionHeader\">\n//               Division\n//             </div>\n//             <div className=\"LeaderboardDivisionTitle\">\n//               {division}\n//             </div>\n//             <div className=\"LeaderboardDivisionBorder\" />\n//           </VerticalLeft>\n//           <VerticalLeft>\n//             {divTeams.map((team, i) =>\n//               <LeaderboardTeam key={team.id} placement={placement++} teamId={team.id} team={team} />\n//             )}\n//           </VerticalLeft>\n//         </div>)}\n//       </ScrollableColumn>\n//     </Column>\n//   </Panel>;\n// }\n\n// function LeaderboardsPage() {\n//   const rounds = new Array(CurrentSeason).fill(0).map((x, i) => CurrentSeason - i);\n//   return <div className=\"Page MainMenuPage\">\n//     <div className=\"PageContent\">\n//       <LinkButton to=\"/\">Home</LinkButton>\n//       <h2>All rounds</h2>\n//       {rounds.map((round) => <Leaderboard key={round} round={round} />)}\n//     </div>\n//   </div>\n// }\n\nfunction SignupSigninButton() {\n  const [showSignInPopup, setShowSignInPopup] = React.useState<boolean>(false);\n  return <>\n    <Button onClick={() => {\n      if (version.backend === 'production') {\n        setShowSignInPopup(true);\n      } else {\n        const ret = `https://${window.location.host}/login/`;\n        window.location.href = `https://app.derkgame.com/gettesttoken?redirect=${encodeURIComponent(ret)}`;\n      }\n    }}>Sign up / sign in</Button>\n    {showSignInPopup && (\n      <Popup onClose={() => setShowSignInPopup(false)}>\n        <h1>Sign in</h1>\n        <FirebaseLogin onSignedIn={user => setShowSignInPopup(false)} />\n      </Popup>\n    )}\n  </>\n}\n\nfunction LandingPage({ children }: { children?: any }) {\n  return <div className=\"Page MainMenuPage\">\n    <div className=\"PageContent\">\n      <VerticalCentered>\n        <img src={LogoPng} alt=\"Logo\" className=\"HomePageLogo\" />\n        <Section className=\"HomeAbout\">\n          <div className=\"HomeTagline\">Train a team of creatures with real brains and battle them against other players!</div>\n          <p>\n            <a href=\"https://www.youtube.com/channel/UC8ZuJCgnZMCmz3WZoEM_czA\">YouTube</a> &nbsp;\n            <a href=\"http://twitter.com/DrDerkGame\">Twitter</a> &nbsp;\n            <a href=\"https://discord.gg/ZBRwc5b\">Discord</a> &nbsp;\n            {!IsInElectron && <a href=\"https://www.patreon.com/fredriknoren\">Patreon</a>}\n          </p>\n        </Section>\n        <Section>\n          {children}\n        </Section>\n        <Section>\n          <a href=\"https://store.steampowered.com/app/1102370/Dr_Derks_Mutant_Battlegrounds\">\n            <Button>\n              Wishlist Dr. Derk's Mutant Battlegrounds on Steam\n            </Button>\n          </a>\n        </Section>\n        <Section>\n          <NewsletterSignup />\n        </Section>\n        <a href=\"http://mountrouke.com\"><img src={MountRoukeLogo} alt=\"Mount Rouke Studios\" className=\"MountRoukeLogo\" /></a>\n      </VerticalCentered>\n    </div>\n  </div>;\n}\nfunction LogoHomePage({ children }: { children?: any }) {\n  return <div className=\"Page MainMenuPage\">\n    <div className=\"PageContent\">\n      <VerticalCentered>\n        <img src={LogoPng} alt=\"Logo\" className=\"HomePageLogo\" />\n        <Section>\n          {children}\n        </Section>\n      </VerticalCentered>\n    </div>\n  </div>;\n}\n\n\nfunction LoginWithTokenPage({ token }: { token: string }) {\n  const [status, setStatus] = React.useState<string>('Logging in...');\n  React.useEffect(() => {\n    (async () => {\n      await firebase.auth().signInWithCustomToken(token);\n      setStatus('Logged in, redirecting....');\n      RoutingHistory.replace('/');\n    })()\n  }, [token]);\n  return <div>\n    {status}\n  </div>\n}\n\nfunction LoginWithEmailPassword({ email, password }: { email: string, password: string }) {\n  const [status, setStatus] = React.useState<string>('Logging in...');\n  React.useEffect(() => {\n    (async () => {\n      await firebase.auth().signInWithEmailAndPassword(email, password);\n      setStatus('Logged in, redirecting....');\n      RoutingHistory.replace('/');\n    })();\n  }, [email, password]);\n  return <div>\n    {status}\n  </div>\n}\n\nfunction GetTestServerTokenPage({ redirect }: { redirect: string }) {\n  const loggedInUser = React.useContext(LoggedInUserContext);\n  React.useEffect(() => {\n    (async () => {\n      if (loggedInUser) {\n        const result = await firebase.functions().httpsCallable('getTestingLoginToken')();\n        window.location.href = `${redirect}${result.data.token}`;\n      }\n    })();\n  }, [redirect, loggedInUser]);\n  if (!loggedInUser) {\n    return <div>\n      <FirebaseLogin />\n    </div>\n  }\n  return <div>\n    Getting test server token...\n  </div>\n}\n\nclass SteamOverlayRefresher extends React.Component {\n  canvas1 = React.createRef<HTMLCanvasElement>();\n  canvas2 = React.createRef<HTMLCanvasElement>();\n  stop = false;\n  componentDidMount() {\n    requestAnimationFrame(this.tick);\n  }\n  componentWillUnmount() {\n    this.stop = true;\n  }\n  tick = () => {\n    if (this.canvas1.current) {\n      this.canvas1.current.getContext('2d')!.clearRect(0, 0, 1, 1);\n    }\n    if (this.canvas2.current) {\n      this.canvas2.current.getContext('2d')!.clearRect(0, 0, 1, 1);\n    }\n    if (!this.stop) {\n      requestAnimationFrame(this.tick);\n    }\n  }\n  render() {\n    return <div className=\"SteamOverlayRefresher\">\n      <canvas ref={this.canvas1} width={1} height={1} style={{ position: 'fixed', left: 0, top: 0 }} />\n      <canvas ref={this.canvas2} width={1} height={1} style={{ position: 'fixed', bottom: 0, right: 0 }} />\n    </div>;\n  }\n}\n\nexport interface ChangelogEntry {\n  version: string;\n  date: Date;\n  link: string;\n  title: string;\n  body: string;\n}\nasync function getChangelog(path: string) {\n  const resp = await fetch(path);\n  let content = await resp.text();\n  content = content.replace('/Images/EnergyModel05.png', EnergyModel05);\n  content = content.replace('/Images/EnergyModel052.png', EnergyModel052);\n  content = content.replace(/\\r\\n|\\r|\\n/g, '\\n');\n  const re = /\\$\\$[ ]+([^ ]+)[ ]+([^ ^\\n]+)([ ]+[^ ^\\n].+)?\\n(.*)?\\n([^$]*)?/g;\n  let match;\n\n  const entries: ChangelogEntry[] = [];\n  // eslint-disable-next-line no-cond-assign\n  while (match = re.exec(content)) {\n    entries.push({\n      version: match[1],\n      date: new Date(Date.parse(match[2])),\n      link: match[3],\n      title: match[4],\n      body: match[5],\n    });\n  }\n  return entries;\n}\nexport function WhatsNewPopup() {\n  const { changelog } = useAppStateSelect('changelog');\n  const loggedInUser = React.useContext(LoggedInUserContext);\n  const userSettings = useFirebaseStreamDocument<DbUserSettings>(Db.userSettings, loggedInUser?.uid);\n  const [show, setShow] = React.useState(false);\n  React.useEffect(() => {\n    (async () => {\n      if (!version.isDevelopment && userSettings.status === 'loaded') {\n        const last = changelog[0];\n        const doShow = last && last.date > userSettings.value.whatsNewDate.toDate();\n        console.log(`[WhatsNewPopup] changelog=${last?.date} userSettings=${userSettings.value.whatsNewDate.toDate()} show=${doShow}`);\n        setShow(!!doShow);\n      }\n    })()\n  }, [userSettings, changelog]);\n  if (!show || !loggedInUser) {\n    return null;\n  }\n  return <Popup fullscreen={false} onClose={() => {\n    firebase.firestore().collection(Db.userSettings).doc(loggedInUser.uid)\n      .update(partial<DbUserSettings>({ whatsNewDate: firebase.firestore.Timestamp.now() }));\n    }}>\n    <ScrollVertical className=\"WhatsNew\">\n      <h2>What's new</h2>\n      <Changelog />\n    </ScrollVertical>\n  </Popup>;\n}\n\nexport function Changelog() {\n  const { changelog } = useAppStateSelect('changelog');\n  return <div className=\"Changelog\">{changelog.map((entry, i) => <div className=\"ChangelogEntry\" key={i}>\n    {entry.version !== '-' ? <span className=\"ChangelogVersion\">{entry.version}</span> : ''}\n    {entry.link ? <a href={entry.link} target=\"_blank\" rel=\"noopener noreferrer\"><i className=\"fab fa-youtube\" /> {entry.title}</a> : entry.title} <small>{moment(entry.date).fromNow()}</small>\n    <ReactMarkdown source={entry.body} className=\"ChangelogBody\" />\n  </div>)}</div>;\n}\n\n\n// function ChangelogPage() {\n//   return <div className=\"Page\">\n//     <div className=\"PageContent\">\n//     <h1>Changelog</h1>\n//     <LinkButton to=\"/\">Home</LinkButton>\n//     <Changelog />\n//     </div>\n//   </div>;\n// }\n\nfunction SteamLoading({ msg }: { msg: string }) {\n  return <div className=\"Page SteamLoading\">\n    <VerticalCentered>\n      <img src={MountRoukeLogo} alt=\"Mount Rouke Studios\" className=\"MountRoukeLogoSteam\" />\n      <small>{msg}</small>\n    </VerticalCentered>\n  </div>\n}\nfunction SteamLandingPage({ ticket, appid }: { ticket: string, appid: string }) {\n  const [status, setStatus] = React.useState('Logging in (Waiting for ticket)...');\n  React.useEffect(() => {\n    (async () => {\n      if (ticket) {\n        setStatus('Logging in (Fetching token)...');\n        let result;\n        try {\n          result = await firebase.functions().httpsCallable('steamLogin')({\n            steamTicket: ticket,\n            appid\n          });\n        } catch (err) {\n          Sentry.captureException(err);\n          setStatus(`Steam login call failed`);\n          return;\n        }\n        if (result.data.status !== 'ok') {\n          setStatus(result.data.error);\n          return;\n        }\n        setStatus(`Logging in (Signing in)...`);\n        await firebase.auth().signInWithCustomToken(result.data.firebaseToken);\n        setStatus(`Logged in! Redirecting...`);\n        RoutingHistory.replace('/');\n      }\n    })()\n  }, [ticket, appid]);\n  return <SteamLoading msg={status} />;\n}\n\n\nexport function BattleNotifTime({ time }: { time: Date }) {\n  const [, forceUpdate] = React.useState();\n  useInterval(() => forceUpdate({} as any), 60*1000);\n  if (Date.now() - time.getTime() < (60*1000)) {\n    return <span>now</span>;\n  } else {\n    return <span>{moment(time).fromNow()}</span>;\n  }\n}\n\nfunction BattleNotifContent({ battleId }: { battleId: string }) {\n  const battle = useFirebaseStreamDocument<DbBattle>(Db.battles, battleId);\n  if (battle.status !== 'loaded') {\n    return <FirebaseLoading pending={[battle]} />;\n  }\n  return <Column className=\"BattleNotifContent\">\n    <small><BattleNotifTime time={battle.value.created.toDate()} />  {capitalizeFirstLetter(battle.value.battleground)}</small>\n    <Block><b><UserNameComponent userId={parseTeamId(battle.value.homeTeamId).userId} /></b></Block>\n    <Block>{battle.value.homeScore} - {battle.value.awayScore}</Block>\n    {battle.value.winner === BattleWinner.Undecided && <Block><i className=\"fas fa-hourglass-half\" /> In progress...</Block>}\n    {battle.value.winner === BattleWinner.AwayWin && <Block><b><i className=\"fas fa-trophy\" /> You won!</b></Block>}\n    {battle.value.winner === BattleWinner.HomeWin && <Block><i className=\"fas fa-frown\" /> You lost</Block>}\n    {battle.value.winner === BattleWinner.Tie && <Block><i className=\"fas fa-times\" /> Tied match</Block>}\n  </Column>\n}\n\nasync function getLatestAppBuild() {\n  const r = await fetch('/index.html');\n  const content = await r.text();\n  const buildRegex = /<meta name=\"pixling-world-build\" content=\"([^\"]*)\">/g;\n  const buildMatch = buildRegex.exec(content);\n  if (buildMatch) {\n    return buildMatch[1];\n  } else {\n    return undefined;\n  }\n}\n\nfunction Notifications() {\n  const loggedInUser = React.useContext(LoggedInUserContext);\n  const [newVersion, setNewVersion] = React.useState<string | undefined>();\n  const notifs = useFirebaseStreamQuery<DbNotification>({\n    collection: Db.notifications,\n    where: [['userId', '==', loggedInUser ? loggedInUser.uid : 'no-user']]\n  });\n  useInterval(() => {\n    if (version.isDevelopment) {\n      return;\n    }\n    (async () => {\n      console.log('Checking for new build...');\n      const build = await getLatestAppBuild();\n      console.log('Latest build: ', build);\n      if (build && build !== version.build) {\n        // Sometimes the server respondes with a cached file\n        const s = build.split('_');\n        const newDate = new Date(s[1] + ' ' + s[2]);\n        const olds = version.date.split('_');\n        const oldDate = new Date(olds[0] + ' ' + olds[1]);\n        if (newDate > oldDate) {\n          setNewVersion(build);\n        }\n      }\n    })();\n  }, 1000 * 60 * 10);\n  if (notifs.status !== 'loaded') {\n    return null;\n  }\n  return <div className=\"Notifications\">\n    {notifs.values.map(notif => {\n      if (notif.type === 'battle') {\n        return <Panel key={notif.id} className=\"BattleNotif\"\n            title=\"Battle!\" onDelete={() => db.collection(Db.notifications).doc(notif.id).delete()}>\n          <BattleNotifContent battleId={notif.battleId} />\n        </Panel>;\n      } else {\n        return <Panel key={notif.id} className=\"BattleNotif\"\n            onDelete={() => db.collection(Db.notifications).doc(notif.id).delete()}>\n          {notif.value}\n        </Panel>;\n      }\n    })}\n    {newVersion && <Panel title=\"Update\" className=\"NewBuildNotif\" onDelete={() => setNewVersion(undefined)}>\n      <h3>New version available!</h3>\n      <div><small>{newVersion}</small></div>\n      <div><small><i className=\"fas fa-arrow-alt-circle-up\" /></small></div>\n      <div><small>{version.build}</small></div>\n      <Section>\n        <Button primary={true} onClick={() => window.location.reload()}>Reload</Button>\n      </Section>\n    </Panel>}\n    {notifs.values.length > 0 && <Button onPerform={async () => {\n      for (const { l, count } of createBatches(notifs.values.length, 500)) {\n        const batch = firebase.firestore().batch();\n        for (let i=0; i < count; i++) {\n          batch.delete(db.collection(Db.notifications).doc(notifs.values[i + l].id));\n        }\n        batch.commit();\n      }\n    }}>Close all notifications ({notifs.values.length})</Button>}\n  </div>\n}\n\nfunction useFirebaseLoggedInUser() {\n  const [user, setUser] = React.useState<firebase.User | null>(null);\n  const [loadingUser, setLoadingUser] = React.useState(true);\n  const appState = React.useContext(AppStateContext);\n  React.useEffect(() => {\n    const updateUser = (usr: firebase.User | null) => {\n      console.log('Logged in user changed to:', usr?.uid);\n      setLoadingUser(false);\n      if (usr) {\n        Sentry.setUser({\n          email: usr.email || undefined,\n          id: usr.uid\n        });\n        // Because of https://github.com/firebase/firebase-functions/issues/95\n        const profileDoc = firebase.firestore().collection(Db.userProfiles).doc(usr.uid);\n        profileDoc.get().then(p => {\n          if (!p.exists) {\n            return;\n          }\n          const profile = p.data() as DbUserProfile;\n          if (!profile.displayName && usr.displayName) {\n            profileDoc.update(partial<DbUserProfile>({\n              displayName: usr.displayName\n            }));\n          }\n        });\n      }\n      setUser(usr);\n      appState.update({ loggedInUserId: usr ? usr.uid : undefined });\n    };\n    const unsub = firebase.auth().onAuthStateChanged(updateUser);\n    return () => {\n      unsub();\n    }\n  }, [appState]);\n  return { user, loadingUser };\n}\n\nfunction NewsletterSignup() {\n  const [email, setEmail] = React.useState('');\n  return <div>\n    <input type=\"text\" value={email} onChange={e => setEmail(e.target.value)} placeholder=\"your@email.com\"/>\n    <Button\n      onPerform={async () => {\n        await firebase.functions().httpsCallable('subscribeToNewsletter')({ email });\n        setEmail('');\n      }}\n      disabled={!email}\n      primary={true}>\n        Subscribe to newsletter\n    </Button>\n  </div>\n}\n\nexport function IssuesPanel({ loggedInUser }: { loggedInUser: firebase.User }) {\n  const [show, setShow] = React.useState(false); // version.commit !== 'development'\n  return <Panel mode={PanelMode.Floating} className={`IssuesPanel ${show ? 'IssuesPanelShow' : 'IssuesPanelMinimized'}`} title=\"Issues\" onDelete={!show ? undefined : () => setShow(false)}>\n    {show ? <Issues loggedInUser={loggedInUser} tag=\"steam\" /> : <Column>\n      <FontAwesomeButton className=\"IssuePanelShowAll\"\n        icon=\"book-open\"\n        title=\"Show all issues\"\n        flat={true} onClick={() => setShow(true)}><span className=\"IssuesPanelShowAllTitle\">View issues</span></FontAwesomeButton>\n    </Column>}\n    <Column className=\"IssuesNew\">\n      <small className=\"IssuesPanelNewTitle\">New issue</small>\n      <NewIssue loggedInUser={loggedInUser} tags={['steam']} onStartNewIssue={() => setShow(true)} />\n    </Column>\n  </Panel>;\n}\n\n\n// function DemoPostSignup() {\n//   return <ItemsColumn>\n//     <p>\n//       <a href=\"https://www.youtube.com/channel/UC8ZuJCgnZMCmz3WZoEM_czA\">YouTube</a> &nbsp;\n//       <a href=\"http://twitter.com/DrDerkGame\">Twitter</a> &nbsp;\n//       <a href=\"https://discord.gg/ZBRwc5b\">Discord</a> &nbsp;\n//       {!IsInElectron && <a href=\"https://www.patreon.com/fredriknoren\">Patreon</a>}\n//     </p>\n//     <Panel>\n//       <p><small>That's the end of the demo. Thank you for playing!</small></p>\n//       <p>Get notified when the full game releases:</p>\n//       <p>\n//         <NewsletterSignup />\n//       </p>\n//     </Panel>\n//   </ItemsColumn>\n// }\n\n// function DemoTimer() {\n//   const loggedInUserData = React.useContext(LoggedInUserDataContext);\n//   const [remaining, setRemaining] = React.useState<number>();\n//   useInterval(() => {\n//     const demoStart = loggedInUserData?.demoStarted?.toMillis() ?? Date.now();\n//     const demoEnd = demoStart + DemoDuration;\n//     const rem = demoEnd - Date.now();\n//     setRemaining(rem);\n//   }, loggedInUserData?.demoStarted ? 1000 : undefined);\n//   if (!loggedInUserData || !loggedInUserData.demoStarted || remaining === undefined || remaining <= -10*1000) {\n//     return null;\n//   }\n//   return <div className=\"DemoTimer\">\n//     {remaining <= 0 ? <Column>\n//       <div>The demo has now ended.</div>\n//     </Column> : <Column>\n//       <div>Demo ending in:</div>\n//       <div>{(moment.duration(remaining, 'milliseconds') as any).format()}</div>\n//     </Column>}\n//   </div>\n// }\n\nconst HomePage = React.memo(() => {\n  const loggedInUser = React.useContext(LoggedInUserContext);\n  const loggedInUserData = React.useContext(LoggedInUserDataContext);\n  const [hasGameAccess, setHasGameAccess] = React.useState(loggedInUserData && loggedInUser && dbUserHasGameAccess(loggedInUserData));\n  useInterval(() => {\n    setHasGameAccess(loggedInUserData && loggedInUser && dbUserHasGameAccess(loggedInUserData));\n  }, 10*1000);\n  if (loggedInUserData && loggedInUser) {\n    if (hasGameAccess) {\n      return <MainMenu\n        loggedInUser={loggedInUser}\n        loggedInUserData={loggedInUserData}\n        />\n    } else {\n      if (IsInElectron) {\n        return <LogoHomePage>\n          <i>Account is activating...</i>\n        </LogoHomePage>;\n        // if (!loggedInUserData.demoStarted) {\n        //   return <LogoHomePage>\n        //     <Button primary={true} onPerform={async () => {\n        //       await firebase.functions().httpsCallable('startDemo')();\n        //     }}>Launch demo!</Button>\n        //     <i><small>You will have one hour of gameplay once the demo is started</small></i>\n        //   </LogoHomePage>\n        // } else {\n        //   return <LogoHomePage>\n        //     <DemoPostSignup />\n        //   </LogoHomePage>\n        // }\n      } else {\n        return <LandingPage>\n          <i>The doors to the battlegrounds are currently closed, but check back soon!</i>\n        </LandingPage>\n      }\n    }\n  } else {\n    return <LandingPage>\n      <SignupSigninButton />\n    </LandingPage>;\n  }\n});\n\nconst AppInner = React.memo(() => {\n  const { user: loggedInUser, loadingUser } = useFirebaseLoggedInUser();\n  const loggedInUserData = useFirebaseStreamDocument<DbUser>(Db.users, loggedInUser?.uid);\n  const [showPendingRedirect, setShowPendingRedirect] = React.useState(firebaseAuthUI.isPendingRedirect());\n  const { hideUI } = useAppStateSelect('hideUI');\n  const appState = React.useContext(AppStateContext);\n  useFirebaseStreamDocumentTo(Db.userSettings, loggedInUser?.uid, doc =>\n    appState.update({ userSettings: { status: 'loaded', value: {...doc.data() as DbUserSettings, id: doc.id } } }));\n\n  React.useEffect(() => { SessionRecorder.init(); }, []);\n\n  React.useEffect(() => {\n    const changelogEntries = getChangelog(ChangelogMdPath);\n    changelogEntries.then(changelog => appState.update({ changelog }));\n    if (version.isDevelopment) {\n      changelogEntries.then(entries => {\n        if (entries.length > 0) {\n          version.version = entries[0].version;\n          console.log(`[VersionFromChangelog] Updated version from changelog: ${version.version}`);\n        } else {\n          console.log(`[VersionFromChangelog] No entries in changelog`);\n        }\n      })\n    }\n  }, [appState]);\n\n  if (showPendingRedirect) {\n    return <div className=\"App\">\n      Logging in...\n      <FirebaseLogin onSignedIn={() => setShowPendingRedirect(false)} />\n    </div>;\n  }\n  if (loadingUser) {\n    return <div>Loading...</div>;\n  }\n  if (loggedInUser && loggedInUserData.status === 'loading') {\n    return <div>Loading...</div>;\n  }\n  if (loggedInUserData.status === 'loaded' && loggedInUserData.value.created === undefined) {\n    return <div>Creating user...</div>;\n  }\n  return (\n    <LoggedInUserContext.Provider value={loggedInUser}><LoggedInUserDataContext.Provider value={loggedInUserData.status === 'loaded' ? loggedInUserData.value : undefined}>\n      <div className={`App SteamApp FullscreenApp ${hideUI ? 'HideUI' : ''}`}>\n        <Router routes={{\n          '/steam/loading?msg=:msg': match => <SteamLoading msg={match.msg ?? 'Waiting for Steam...'} />,\n          '/steam/landing?ticket=:ticket&appid=:appid': match => <SteamLandingPage ticket={match.ticket} appid={match.appid} />,\n          '/admin/sessions': () => <AdminSessionListContainer />,\n          '/admin/graphs': () => <AdminGraphs />,\n          '/admin/users': () => <AdminUsers />,\n          '/admin/funnel': () => <AdminFunnel />,\n          '/admin/feedback': () => <AdminFeedbackQueue />,\n          '/admin/pixlings': () => <AdminLatestStoredPixlings />,\n          '/admin/user/:id': match => <AdminUser userId={match.id} />,\n          '/admin/user/:id/battles': match => <AdminUserBattleHistory userId={match.id} />,\n          '/admin/creature/:id': match => <AdminCreature creatureId={match.id} />,\n          '/admin/trainingstats': () => <AdminTrainingStats />,\n          '/test/glunit': () => <RunGlUnitTests />,\n          '/test/arena': () => <TestArena />,\n          '/exit': () => <div>Exiting...</div>,\n          '/gettesttoken?redirect=:redirect': match => <GetTestServerTokenPage redirect={match.redirect} />,\n          '/loginemail?email=:email&password=:password': match => <LoginWithEmailPassword email={match.email} password={match.password} />,\n          '/login/:token': match => <LoginWithTokenPage token={match.token} />,\n          '/': () => <HomePage />\n        }} />\n        {loggedInUser && <IssuesPanel loggedInUser={loggedInUser} />}\n        <Notifications />\n        <PopupsContainer />\n        <PopdownsContainer />\n        <WhatsNewPopup />\n        {IsInElectron && <SteamOverlayRefresher />}\n      </div>\n    </LoggedInUserDataContext.Provider></LoggedInUserContext.Provider>\n  );\n});\n\nexport default function App() {\n  const [appStateStore] = React.useState(new Store(new AppState()));\n  return <AppStateContext.Provider value={appStateStore}>\n    <AppInner />\n  </AppStateContext.Provider>\n}\n","import * as React from 'react';\nimport './index.css';\nimport { Button } from '../../Components/Button';\nimport firebase from 'firebase/app';\nimport { DbCreature, full, DbItemInstance, DbId, Db } from 'db';\nimport { LoggedInUserContext } from '../App';\nimport { ItemsColumn } from '../../Components/Layout';\nimport { base62uuid, randomRGB, rgbToHex } from '../../Util';\nimport { CurrentSeason } from 'db';\nimport { CreaturePortrait } from '../CreaturePortrait';\nimport { AudioPlayerInstance } from '../../GpuWorld/Audio';\nimport { SoundEffect } from '../../GpuWorld/StateLayout';\n\nexport function newRandomCreature(): DbCreature {\n  return {\n    season: CurrentSeason,\n    created: firebase.firestore.Timestamp.now(),\n    deleted: false,\n    ownerId: '',\n    generation: 0,\n    tags: [],\n    bounties: {},\n\n    primaryColor: randomRGB(),\n    secondaryColor: randomRGB(),\n    ears: 1 + Math.floor(Math.random() * 4),\n    eyes: 1 + Math.floor(Math.random() * 5),\n    backSpikes: 1 + Math.floor(Math.random() * 7),\n  }\n}\nexport function createDefStyleFromBase(base: DbCreature) {\n  return {\n    primaryColor: rgbToHex(base.primaryColor),\n    secondaryColor: rgbToHex(base.secondaryColor),\n    ears: base.ears,\n    eyes: base.eyes,\n    backSpikes: base.backSpikes,\n  }\n}\n\nexport function NewCreatureDialog({ onCreate, eggItem }: { onCreate: () => void, eggItem: DbItemInstance & DbId }) {\n  const speciesId = React.useRef(base62uuid());\n  const [name, setName] = React.useState<string>('');\n  const [creature] = React.useState(newRandomCreature());\n  const loggedInUser = React.useContext(LoggedInUserContext);\n  if (!loggedInUser) {\n    return null;\n  }\n  return <ItemsColumn className=\"CreatePixlingDialog\">\n    <CreaturePortrait\n      unit={{ type: 'creature', slots: [], ...createDefStyleFromBase(creature) }}\n      />\n    <input type=\"text\" value={name} onChange={e => setName(e.target.value)} placeholder=\"Name\" />\n\n    <Button className=\"CreateCreature\" primary={true} disabled={!name} onPerform={async () => {\n      await firebase.firestore().runTransaction(async t => {\n        t.set(firebase.firestore().collection(Db.creatures).doc(speciesId.current), full<DbCreature>({\n          ...creature,\n          ownerId: loggedInUser!.uid,\n          created: firebase.firestore.Timestamp.now(),\n          name,\n        }));\n        t.update(firebase.firestore().collection(Db.items).doc(eggItem.id), {\n          deleted: true,\n          hatchTime: firebase.firestore.Timestamp.now()\n        });\n        AudioPlayerInstance?.playSoundEffect(SoundEffect.Bite);\n      });\n      onCreate();\n    }}>\n      Hatch egg!\n    </Button>\n  </ItemsColumn>\n}\n","import { UnitDef } from \"../GpuWorld/UnitDef\";\nimport { UnitBounties, DbBattleground, ItemKeys, Items } from \"db\";\nimport { GpuWorldProgram } from \"../GpuWorld\";\nimport { Store } from \"../Components/Store\";\nimport { GymState } from \".\";\nimport { SensesSlices, GymExtraSensesSlices, Senses, GymExtraSenses } from \"../GpuWorld/Brain/Components\";\nimport { wait, base62uuid, RandomSeedable, SimpleProfiler, keysOfEnum, arrayBufferToBase64 } from \"../Util\";\nimport { createDefStyleFromBase, newRandomCreature } from \"../SteamApp/CreateSpecies\";\nimport { EntityRef } from \"../GpuWorld/StateData\";\nimport { GpuWorldState, GpuWorldStateEventDataChanged } from \"../GpuWorld/State\";\nimport { StatuePoints, TeamPoints, Teams, SideSize } from \"../GpuWorld/StateLayout\";\nimport { setCanvasSizeToElementSize } from \"../GpuWorld/Renderer\";\nimport { createPlayerUnits, CreateUnitDef } from \"../GpuWorld/CreateUnit\";\nimport { createUnitModelsForArena } from \"../GpuWorld/CreateUnitModel\";\nimport { GpuBufferFormats } from \"../GpuUtil/ECS\";\nimport { GlState, GL } from \"../GpuUtil/GlState\";\nimport { GpuComponentModule } from \"../GpuUtil/ECS/ComponentModules\";\nimport { CompiledShaderModule, shaderModule, outDef, funcDef, uniformDef } from \"../GpuUtil/ShaderModule\";\nimport { Program } from \"../GpuUtil/Program\";\nimport { RenderTarget } from \"../GpuUtil/RenderTarget\";\nimport { TextureSlicing, Texture } from \"../GpuUtil/Texture\";\nimport { Gold, Creature, GymIndex } from \"../GpuWorld/ECS/UnitComponents\";\nimport { ArchetypesQuery } from \"../GpuUtil/ECS/Query\";\nimport { DecisionsCMs, Decisions } from \"../GpuWorld/Brain/Decisions\";\nimport { Image } from '../GpuUtil/Image';\nimport lodash from 'lodash';\nimport semver from 'semver';\nimport { version } from \"../version\";\nimport { Rect } from \"../Math/Math\";\nimport { WebSocketAsync } from \"./WebSocketAsync\";\nimport { GymExtraSense, Sense } from \"../GpuWorld/Brain/SensesDef\";\nimport { TeamStats } from \"../GpuWorld/ECS/ArenaStats\";\n\ninterface ArenaRegion {\n  sides: 'home' | 'away' | 'both';\n  start_arena: number;\n  n_arenas: number;\n}\ntype DerkAgentHostConfig = { uri: string, regions: ArenaRegion[] };\n\nexport interface GymConfig {\n  agentHosts: DerkAgentHostConfig[]\n  home?: Array<Partial<UnitDef>>;\n  away?: Array<Partial<UnitDef>>;\n  rewardFunction: Partial<UnitBounties>;\n  nArenas: number;\n  substeps: number;\n  randomSeed: string;\n  turboMode: boolean;\n  interleaved: boolean;\n  debugNoObservations: boolean;\n  debugNoActionsWrite: boolean;\n  webWorkerSocket: boolean;\n  aiCrowdLogo: boolean;\n  gameState: boolean;\n}\n\nconst DecisionKeys = Object.keys(Decisions);\nconst NAgentsPerTeam = 3;\n\nenum GymTeamStats {\n  Reward,\n  OpponentReward,\n  Hitpoints,\n  AliveTime,\n  CumulativeHitpoints,\n}\n\nclass RemoteClosedError extends Error {}\n\nclass RemoteHost {\n  constructor(public host: string, public regions: ArenaRegion[], public totalNArenas: number, public runInWebWorker: boolean) {\n\n    this.teamRects = regions.map(({ sides, start_arena, n_arenas }) => ({\n      x: (start_arena ?? 0),\n      y: sides === 'away' ? 1 : 0,\n      width: ((n_arenas !== undefined && n_arenas >= 0) ? n_arenas : totalNArenas),\n      height: sides === 'both' ? 2 : 1\n    }));\n    this.agentRects = this.teamRects.map(rect => ({\n      x: rect.x * NAgentsPerTeam,\n      y: rect.y,\n      width: rect.width * NAgentsPerTeam,\n      height: rect.height\n    }));\n    this.nTeams = this.teamRects.reduce((p, x) => p + x.width * x.height, 0);\n\n    this.socket.binaryType = 'arraybuffer';\n    this.socket.addEventListener('message', event => {\n      // console.log('Got message', event.data.length, event.data);\n      if (this.waiting) {\n        this.waiting.resolve(event.data);\n        this.waiting = undefined;\n      } else {\n        this.messageQueue.push(event.data);\n      }\n    });\n    this.socket.addEventListener('close', () => {\n      if (this.waiting) {\n        this.waiting.reject(new RemoteClosedError());\n        this.waiting = undefined;\n      }\n    });\n  }\n  send(data: string | ArrayBuffer) {\n    if (this.socket.readyState === WebSocket.CLOSED || this.socket.readyState === WebSocket.CLOSING) {\n      throw new RemoteClosedError();\n    }\n    this.socket.send(data);\n  }\n  close() {\n    this.socket.close();\n  }\n  agentRects: Rect[];\n  teamRects: Rect[];\n  nTeams: number;\n  private socket = this.runInWebWorker ? new WebSocketAsync(this.host) : new WebSocket(this.host);\n  connected = new Promise<void>(resolve => {\n    const handle = () => {\n      resolve();\n      this.socket.removeEventListener('open', handle);\n    }\n    this.socket.addEventListener('open', handle);\n  });\n  error = new Promise<void>(resolve => {\n    const handle = () => {\n      resolve();\n      this.socket.removeEventListener('error', handle);\n    }\n    this.socket.addEventListener('error', handle);\n  });\n  private messageQueue: any[] = [];\n  private waiting?: { resolve: (value: any) => void, reject: (error: any) => void };\n  async message(): Promise<any> {\n    if (this.socket.readyState === WebSocket.CLOSED || this.socket.readyState === WebSocket.CLOSING) {\n      throw new RemoteClosedError();\n    }\n    if (this.messageQueue.length > 0) {\n      return this.messageQueue.shift();\n    } else {\n      return await new Promise((resolve, reject) => { this.waiting = { resolve, reject } });\n    }\n  }\n}\n\nfunction getRectsData(image: Image, rects: Rect[]): Float32Array {\n  const res = new Float32Array(rects.reduce((p, x) => p + x.width * x.height * image.size.depth * image.channels, 0));\n  let offset = 0;\n  for (const rect of rects) {\n    const size = rect.width * rect.height * image.size.depth * image.channels;\n    image.select(rect).toArray(res.subarray(offset, offset + size));\n    offset += size;\n  }\n  return res;\n}\n\nfunction padSenses(keys: string[], padKey: string) {\n  keys = [...keys];\n  while (keys.length % 4 !== 0) {\n    keys.push(padKey + keys.length);\n  }\n  return keys;\n}\nconst AllObservationKeys = [\n  ...padSenses(keysOfEnum(Sense), 'UnusedSense'),\n  ...padSenses(keysOfEnum(GymExtraSense), 'UnusedExtraSense')\n];\n\nclass GymTools {\n  constructor(private gls: GlState) {}\n  readRewards = new ReadRewards(this.gls);\n  readSenses = new ReadSenses(this.gls);\n  readTeamStats = new ReadTeamStats(this.gls);\n  writeActions = new WriteActions(this.gls);\n}\n\nenum RemoteConnectionState {\n  Connected,\n  Error\n}\n\nfunction defaultRewardFunction(): Partial<UnitBounties> {\n  return {\n    killEnemyStatue: 4,\n    killEnemyUnit: 1,\n    timeScaling: 1\n  }\n}\n\nclass DerkSession {\n  constructor(private program: GpuWorldProgram, public appState: Store<GymState>, public tools: GymTools, config: Partial<GymConfig>) {\n    const rewardFunction = {...defaultRewardFunction(), ...config.rewardFunction };\n    this.config = {\n      agentHosts: config.agentHosts!,\n      home: config.home,\n      away: config.away,\n      rewardFunction,\n      nArenas: config.nArenas ?? 1,\n      substeps: config.substeps ?? 8,\n      randomSeed: config.randomSeed ?? base62uuid(),\n      turboMode: config.turboMode ?? false,\n      interleaved: config.interleaved ?? true,\n      debugNoObservations: config.debugNoObservations ?? false,\n      debugNoActionsWrite: config.debugNoActionsWrite ?? false,\n      webWorkerSocket: config.webWorkerSocket ?? false,\n      aiCrowdLogo: config.aiCrowdLogo ?? false,\n      gameState: config.gameState ?? false,\n    };\n    this.creaturesTexture = this.creaturesTexture = Texture.create(this.program.gls, GL.RG32I, {\n      width: this.config.nArenas * NAgentsPerTeam,\n      height: 2\n    }).init();\n    this.teamStatsTexture = Texture.create(this.program.gls, GL.R32F,\n      { width: this.config.nArenas, height: 2 }, keysOfEnum(GymTeamStats).length).init();\n    console.log(`[DerkSession] Created with config:`, this.config);\n  }\n  destroy() {\n    this.disconnectAllRemotes();\n    this.destroyWorldState();\n    this.creaturesTexture.destroy();\n    this.teamStatsTexture.destroy();\n    this.actionsTexture?.destroy();\n    this.destroyedResolve!();\n  }\n  disconnectAllRemotes() {\n    for (const remoteHost of this.remoteHosts) {\n      remoteHost.close();\n    }\n    this.remoteHosts = [];\n  }\n  destroyWorldState() {\n    this.state?.gameLoop?.destroy();\n    this.state?.destroy();\n  }\n\n  config: GymConfig;\n  destroyedResolve?: () => void;\n  destroyed = new Promise<void>((resolve) => { this.destroyedResolve = resolve; });\n  state?: GpuWorldState;\n  lastReward?: Image;\n  pendingStep?: Promise<boolean>;\n\n  creaturesTexture: Texture;\n  teamStatsTexture: Texture;\n\n  actionsTexture?: Texture;\n  profiler = new SimpleProfiler();\n  remoteHosts: RemoteHost[] = [];\n\n  setRewardFunction(reward: UnitBounties) {\n    this.config.rewardFunction = {...defaultRewardFunction(), ...reward };\n  }\n\n  async connectToAgentHosts() {\n    console.log(`[DerkSession.connectToAgentHosts] Connecting to ${this.config.agentHosts.length} hosts`);\n    const res = await Promise.all(this.config.agentHosts.map(async ({ uri: host, regions }, i): Promise<RemoteConnectionState> => {\n      if (this.remoteHosts[i]) {\n        console.log(`[DerkSession.connectToAgentHosts] ${host} already connected`);\n        return RemoteConnectionState.Connected;\n      } else {\n        console.log(`[DerkSession.connectToAgentHosts] Connecting to ${host}`);\n        const remoteHost = new RemoteHost(host, regions, this.config.nArenas, this.config.webWorkerSocket);\n        const res = await Promise.race([\n          remoteHost.connected.then(() => RemoteConnectionState.Connected),\n          remoteHost.error.then(() => RemoteConnectionState.Error)\n        ]);\n        console.log(`[DerkSession.connectToAgentHosts] ${host} connection:`, RemoteConnectionState[res]);\n        if (res === RemoteConnectionState.Connected) {\n          console.log(`[DerkSession.connectToAgentHosts] Sending config to ${host}`);\n          remoteHost.send(JSON.stringify({\n            nTeams: remoteHost.nTeams,\n          }));\n          this.remoteHosts[i] = remoteHost;\n        }\n        return res;\n      }\n    }));\n    console.log(`[DerkSession.connectToAgentHosts] Done`);\n    return res.reduce((p, x) => p && (x === RemoteConnectionState.Connected), true);\n  }\n\n  async reset() {\n    this.profiler.enter('reset');\n    await wait(0);\n    // Let any running step finish\n    if (this.pendingStep) {\n      await this.pendingStep;\n      this.pendingStep = undefined;\n    }\n    await this.createNewWorldState(this.config);\n\n    if (this.actionsTexture) {\n      this.actionsTexture.destroy();\n    }\n    this.actionsTexture = Texture.create(this.program.gls, GL.R32F, {\n      width: this.config.nArenas * 3 * DecisionKeys.length,\n      height: 2\n    }, 1).init();\n\n    this.profiler.enter('resetForNextRound');\n    this.program.resetForNextRound(this.state!, true);\n    this.profiler.exit();\n    const round = this.state!.data.round + 1;\n    this.state!.setData({\n      simulationEnded: false,\n      battleStartStep: this.state!.data.stepCounter,\n      round,\n    });\n    this.profiler.enter('getRewardAndObservations');\n\n    let [reward, observations] = await Promise.all([\n      this.readTotalReward(this.creaturesTexture),\n      this.getObservations(this.creaturesTexture),\n    ]);\n    this.profiler.exit();\n    this.lastReward = reward!;\n    for (const remoteHost of this.remoteHosts) {\n      console.log(`[reset] Sending observations to ${remoteHost.host}`);\n      remoteHost.send(getRectsData(observations, remoteHost.agentRects).buffer);\n    }\n    if (this.config!.interleaved) {\n      this.pendingStep = this.stepInternal();\n    }\n\n    this.profiler.exit();\n  }\n\n  normalizeUnit(unit: any) {\n    const base = newRandomCreature();\n    return {\n      type: 'creature',\n      slots: randomCreatureItems(),\n      ...createDefStyleFromBase(base),\n      bounties: unit.rewardFunction,\n      ...unit,\n    }\n  }\n\n\n  async createNewWorldState(config: GymConfig) {\n    this.profiler.enter('createNewWorldState');\n    this.destroyWorldState();\n    this.state = await GpuWorldState.createWithMap(this.program.gls, { arenaCount: config.nArenas, });\n    this.state.setData({\n      renderGazes: true,\n      battleground: DbBattleground.Team,\n      gameInstance: { type: 'gym' },\n      simulationPaused: false,\n      aiCrowdLogo: config.aiCrowdLogo\n    });\n    this.state.random = new RandomSeedable(config.randomSeed);\n    this.state.setData({ randomSeed: this.state.random.random() });\n    setCanvasSizeToElementSize(this.state);\n    const homeUnits = config.home ?? [];\n    const awayUnits = config.away ?? [];\n    const homeUnitCount = 4;\n    const awayUnitCount = 4;\n    this.state.updateTeam('home', { unitCount: homeUnitCount, battleUnitsAlive: homeUnitCount - 1, maxPossiblePoints: StatuePoints + (awayUnitCount > 1 ? TeamPoints : 0) });\n    this.state.updateTeam('away', { unitCount: awayUnitCount, battleUnitsAlive: awayUnitCount - 1, maxPossiblePoints: StatuePoints + (homeUnitCount > 1 ? TeamPoints : 0) });\n\n    await wait(0);\n    const toCreate: { [type: string]: CreateUnitDef[] } = {};\n    for (let a=0; a < config.nArenas; a++) {\n      for (let i=0; i < homeUnitCount; i++) {\n        const gymIndex: [number, number] = [a * 3 + i - 1, 0];\n        const unit = i === 0 ? { type: 'statue' } : this.normalizeUnit(homeUnits[gymIndex[0] % homeUnits.length] ?? {});\n        if (!toCreate[unit.type]) {\n          toCreate[unit.type] = [];\n        }\n        toCreate[unit.type].push({\n          unit,\n          gymIndex,\n          team: Teams.HomeTeam,\n          arenaIndex: a,\n          arenaMemberIndex: i\n        });\n      }\n    }\n    for (let a=0; a < config.nArenas; a++) {\n      for (let i=0; i < awayUnitCount; i++) {\n        const gymIndex: [number, number] = [a * 3 + i - 1, 1];\n        const unit = i === 0 ? { type: 'statue' } : this.normalizeUnit(awayUnits[gymIndex[0] % awayUnits.length] ?? {});\n        if (!toCreate[unit.type]) {\n          toCreate[unit.type] = [];\n        }\n        toCreate[unit.type].push({\n          unit,\n          gymIndex,\n          team: Teams.AwayTeam,\n          arenaIndex: a,\n          arenaMemberIndex: SideSize + i\n        });\n      }\n    }\n    this.profiler.enter('createUnits');\n    const creatures: EntityRef[] = [];\n    for (const type of Object.keys(toCreate)) {\n      const entities = await createPlayerUnits(this.state, toCreate[type], {\n        createAbilities: true, createBrain: false, profiler: this.profiler, bounties: this.config?.rewardFunction });\n      for (let i=0; i < entities.count; i++) {\n        const unit = toCreate[type][i];\n        if (unit.unit.type !== 'statue') {\n          creatures.push(entities.getIndex(i));\n        }\n      }\n    }\n    this.profiler.exit();\n    this.creaturesTexture.sliceAll().upload(new Int32Array(lodash.flatMap(creatures, v => [v.x, v.y])));\n    this.profiler.enter('createModels');\n    await wait(0);\n    createUnitModelsForArena(this.state, this.state.data.renderArena);\n    this.profiler.exit();\n\n    this.appState.update({\n      worldState: this.state\n    });\n    this.profiler.exit();\n  }\n\n  playPromise() {\n    return new Promise<void>(resolve => {\n      const handler = (event: GpuWorldStateEventDataChanged) => {\n        if (!event.after.simulationPaused) {\n          this.state?.events.dataChanged.detach(handler);\n          resolve();\n        }\n      };\n      this.state?.events.dataChanged.attach(handler);\n    })\n  }\n\n  async step() {\n    if (this.state?.data.simulationPaused) {\n      await this.playPromise();\n    }\n    if (this.config.interleaved) {\n      console.log('[step] Running interleaved');\n      const prevStep = this.pendingStep!;\n      const actions = await this.readStepActions();\n      this.pendingStep = prevStep.then(done => {\n        if (!done) {\n          return this.stepInternal(actions);\n        } else {\n          return done;\n        }\n      });\n      const res = await prevStep;\n      console.log('[step] Done interleaved');\n      return res;\n    } else {\n      console.log('[step] Running');\n      const actions = await this.readStepActions();\n      const res = await this.stepInternal(actions);\n      console.log('[step] Done');\n      return res;\n    }\n  }\n\n  async readStepActions() {\n    console.log(`[readStepActions] Waiting for away actions from ${this.remoteHosts.length} hosts`);\n    const actions = await Promise.all(this.remoteHosts.map(async host => {\n      const m = await host.message();\n      const actions = new Float32Array(m);\n      return { actions, rects: host.agentRects }\n    }));\n    if (!this.config?.debugNoActionsWrite) {\n      this.tools.writeActions.writeActionsToTexture(actions, this.actionsTexture!.sliceAll());\n    }\n    console.log(`[readStepActions] Got actions ${actions.length}`);\n    return this.actionsTexture!\n  }\n\n  private async stepInternal(actions?: Texture): Promise<boolean> {\n\n    if (actions) {\n      console.log(`[stepInternal] Write actions`);\n      this.tools.writeActions.write(this.state!, actions);\n    }\n\n    let nextAnimFrame = waitAnimationFrame();\n    for (let i=0; i < this.config!.substeps; i++) {\n      if (i > 0 && !this.config?.turboMode) {\n        await nextAnimFrame;\n        nextAnimFrame = waitAnimationFrame();\n        this.program.render(this.state!);\n      }\n\n      await this.program.step(this.state!);\n    }\n    this.program.render(this.state!);\n    let [reward, observations] = await Promise.all([\n      this.readTotalReward(this.creaturesTexture),\n      this.getObservations(this.creaturesTexture),\n    ]);\n    let rewardDiff = reward!.map((r, p) => r - this.lastReward!.read(p.x, p.y, p.z, p.w));\n    this.lastReward = reward!;\n\n    let teamStats: Image | undefined;\n    if (this.state!.data.simulationEnded) {\n      this.tools.readTeamStats.run(this.state!, this.teamStatsTexture.sliceAll());\n      teamStats = await this.teamStatsTexture.readAsync();\n    }\n\n    for (const remoteHost of this.remoteHosts) {\n      remoteHost.send(getRectsData(observations, remoteHost.agentRects).buffer);\n      remoteHost.send(getRectsData(rewardDiff, remoteHost.agentRects).buffer);\n      remoteHost.send(JSON.stringify({\n        done: [this.state!.data.simulationEnded],\n        info: {\n          gameState: this.config.gameState ? this.state!.ecs.dumpJSON(this.state!) : undefined\n        }\n      }));\n      if (teamStats) {\n        remoteHost.send(getRectsData(teamStats, remoteHost.teamRects).buffer);\n      }\n    }\n\n    return this.state!.data.simulationEnded;\n  }\n\n  private readTotalReward(entities: Texture) {\n    return this.tools.readRewards.run(this.state!, entities);\n  }\n\n  public async readTeamStatsBase64() {\n    return arrayBufferToBase64((await this.teamStatsTexture.readAsync()).data.buffer);\n  }\n\n  private async getObservations(entities: Texture) {\n    this.program.updateNeuralNetwork.senses.run(this.state!);\n    this.program.updateNeuralNetwork.gymExtraSenses.run(this.state!);\n\n    let observations = (await this.tools.readSenses.run(this.state!, entities));\n\n    if (this.config?.debugNoObservations) {\n      observations = Image.zeroesF32({ width: 0, height: 0, depth: 0 }, 1);\n    }\n\n    console.log(`[getObservations] Returning observations (${observations.data.length}) ${Array.from(observations.data.slice(0, 5))}...`);\n\n    return observations;\n  }\n\n}\n\nexport class DerkGymAPI {\n  constructor(public program: GpuWorldProgram, public appState: Store<GymState>) {\n    this.getLatestVersion();\n  }\n\n  async getLatestVersion() {\n    const res = await (await fetch('http://pypi.org/pypi/gym_derk/json')).json();\n    const latestVersion = res.info.version;\n    console.log(`Got gym_derk latest version: ${latestVersion}`);\n    if (semver.gt(latestVersion, version.version)) {\n      console.warn(`New gym_derk version available: ${latestVersion}`);\n      this.appState.update({ newVersion: latestVersion });\n    }\n  }\n\n  tools = new GymTools(this.program.gls);\n  session?: DerkSession;\n\n  async createSession(config: GymConfig) {\n    if (this.session) {\n      this.session.destroy();\n    }\n    this.session = new DerkSession(this.program, this.appState, this.tools, config);\n  }\n\n  public getEnums() {\n    return {\n      observationKeys: AllObservationKeys,\n      teamStatsKeys: keysOfEnum(GymTeamStats)\n    }\n  }\n\n  public getWebGLRenderer() {\n    const gl = this.program.gls.gl;\n    var dbgRenderInfo = gl.getExtension('WEBGL_debug_renderer_info');\n    if (dbgRenderInfo) {\n      const renderer = gl.getParameter(dbgRenderInfo.UNMASKED_RENDERER_WEBGL);\n      const vendor = gl.getParameter(dbgRenderInfo.UNMASKED_VENDOR_WEBGL);\n      return `Renderer=${renderer} Vendor=${vendor}`;\n    } else {\n      return 'Failed to get extension WEBGL_debug_renderer_info';\n    }\n  }\n\n}\n\nfunction waitAnimationFrame() {\n  return new Promise(resolve => {\n    requestAnimationFrame(resolve);\n  })\n}\n\nclass CopyEntityComponents<F extends GpuBufferFormats> {\n  constructor(private gls: GlState, private component: GpuComponentModule<F>,\n    private outSlices: number) {}\n  shader = new CompiledShaderModule(shaderModule([this.component.sm], {\n    entities: uniformDef('isampler2D'),\n    outValues: outDef(`${this.component.component.format}[${this.outSlices}]`),\n    main: funcDef('void', [], `\n      ivec2 entity = texelFetch(Self.entities, ivec2(gl_FragCoord), 0).xy;\n      ${\n        new Array(this.outSlices).fill(0).map((x, i) => `\n          outValues[${i}] = ${this.component.component.depth !== undefined ? `${this.component.sm.value}(entity, ${i})` : `${this.component.sm.value}(entity)`};\n        `).join('\\n')\n      }\n    `)\n  }));\n  program = new Program(this.gls, this.shader.source);\n  renderTarget = new RenderTarget(this.gls);\n  run(state: GpuWorldState, entities: Texture, target: TextureSlicing) {\n    this.shader.updateUniformValues(state);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.program.setUniform('entities', 'isampler2D', entities);\n    this.renderTarget.set(target);\n    this.gls.prepareForComputation(target.rect);\n    this.gls.drawQuad(this.program);\n  }\n}\nclass ReadSenses {\n  constructor(private gls: GlState) {}\n  senses = new CopyEntityComponents(this.gls, Senses, SensesSlices);\n  gymExtraSenses = new CopyEntityComponents(this.gls, GymExtraSenses, GymExtraSensesSlices);\n  run(state: GpuWorldState, entities: Texture) {\n    const tmp = this.gls.getTmpTextureSlice(GL.RGBA32F, entities.size, SensesSlices + GymExtraSensesSlices);\n    this.senses.run(state, entities, tmp.sliceRange(0, SensesSlices));\n    this.gymExtraSenses.run(state, entities, tmp.sliceRange(SensesSlices, GymExtraSensesSlices));\n    return tmp.readAsync();\n  }\n}\nclass ReadRewards {\n  constructor(private gls: GlState) {}\n  gold = new CopyEntityComponents(this.gls, Gold, 1);\n  run(state: GpuWorldState, entities: Texture) {\n    const tmp = this.gls.getTmpTextureSlice(GL.R32F, entities.size, 1);\n    this.gold.run(state, entities, tmp);\n    return tmp.readAsync();\n  }\n}\nclass ReadTeamStats {\n  constructor(private gls: GlState) {}\n  shader = new CompiledShaderModule(shaderModule([TeamStats], {\n    outValues: outDef(`float[${keysOfEnum(GymTeamStats).length}]`),\n    main: funcDef('void', [], `\n      ivec2 cell = ivec2(gl_FragCoord.xy);\n      TeamStats_Stats selfStats = ${TeamStats.stats}(cell.x, cell.y == 0 ? ${Teams.HomeTeam} : ${Teams.AwayTeam});\n      TeamStats_Stats opponentStats = ${TeamStats.stats}(cell.x, cell.y == 0 ? ${Teams.AwayTeam} : ${Teams.HomeTeam});\n      outValues[${GymTeamStats.Reward}] = float(selfStats.gold);\n      outValues[${GymTeamStats.OpponentReward}] = float(opponentStats.gold);\n      outValues[${GymTeamStats.Hitpoints}] = selfStats.hitpoints;\n      outValues[${GymTeamStats.AliveTime}] = selfStats.aliveTime;\n      outValues[${GymTeamStats.CumulativeHitpoints}] = selfStats.cumulativeHitpoints;\n    `)\n  }));\n  program = new Program(this.gls, this.shader.source);\n  renderTarget = new RenderTarget(this.gls);\n  run(state: GpuWorldState, target: TextureSlicing) {\n    this.shader.updateUniformValues(state);\n    this.program.prepare();\n    this.shader.writeUniforms(this.program);\n    this.renderTarget.set(target);\n    this.gls.prepareForComputation(target.rect);\n    this.gls.drawQuad(this.program);\n  }\n}\nclass WriteActions {\n  constructor(private gls: GlState) {}\n\n  query = new ArchetypesQuery([Creature.component])\n    .updateGpu(this.gls, DecisionsCMs.map(x => x.component), shaderModule(\n      [\n        ...DecisionsCMs.map(x => x.writer),\n        GymIndex.sm\n      ],\n      {\n        actions: uniformDef('sampler2DArray'),\n        update: funcDef('void', [['ivec2', 'entityCell']], `\n          ivec2 index = ${GymIndex.sm.value}(entityCell) * ivec2(${DecisionsCMs.length}, 1);\n          ${Decisions.MoveX.writer.write}(          texelFetch(actions, ivec3(index + ivec2(0, 0), 0), 0).x);\n          ${Decisions.Rotate.writer.write}(         texelFetch(actions, ivec3(index + ivec2(1, 0), 0), 0).x);\n          ${Decisions.ChaseFocus.writer.write}(     texelFetch(actions, ivec3(index + ivec2(2, 0), 0), 0).x);\n          ${Decisions.CastingSlot.writer.write}(int(texelFetch(actions, ivec3(index + ivec2(3, 0), 0), 0).x));\n          ${Decisions.ChangeFocus.writer.write}(int(texelFetch(actions, ivec3(index + ivec2(4, 0), 0), 0).x));\n        `)\n      }\n    ));\n\n  writeActionsToTexture(actions: Array<{ actions: Float32Array, rects: Rect[] }>, texture: TextureSlicing) {\n    texture.clear();\n    for (const acts of actions) {\n      let offset = 0;\n      for (const rect of acts.rects) {\n        const size = rect.width * DecisionKeys.length * rect.height;\n        const target = texture.selectAbsolute({\n          x: rect.x * DecisionKeys.length,\n          y: rect.y,\n          width: rect.width * DecisionKeys.length,\n          height: rect.height\n        });\n        target.upload(acts.actions.subarray(offset, offset + size));\n        offset += size;\n      }\n    }\n  }\n\n  write(state: GpuWorldState, actions: Texture) {\n    this.query.run(state, [{ name: 'actions', type: 'sampler2DArray', value: actions }]);\n  }\n}\n\nconst ArmItems = ItemKeys.filter(key => { const it = Items[key]; return it?.type === 'attachment' && it.slot === 'arms' });\nconst TailItems = ItemKeys.filter(key => { const it = Items[key]; return it?.type === 'attachment' && it.slot === 'tail' });\nconst MiscItems = ItemKeys.filter(key => { const it = Items[key]; return it?.type === 'attachment' && it.slot === 'misc' });\nfunction randomCreatureItems(): string[] {\n  const items: string[] = [];\n  if (Math.random() > 0.7) {\n    items[0] = ArmItems[Math.floor(Math.random() * ArmItems.length)];\n  }\n  if (Math.random() > 0.7) {\n    items[1] = TailItems[Math.floor(Math.random() * TailItems.length)];\n  }\n  if (Math.random() > 0.7) {\n    items[2] = MiscItems[Math.floor(Math.random() * MiscItems.length)];\n  }\n  return items;\n}\n","\nconst WorkerSource = `\n  let socket;\n\n  self.onmessage = (e) => {\n    console.log('webworker', e);\n    switch (e.data.type) {\n      case 'init': {\n        socket = new WebSocket(e.data.host);\n        socket.binaryType = 'arraybuffer';\n        socket.addEventListener('open', () => {\n          postMessage({ type: 'open' })\n        });\n        socket.addEventListener('close', () => {\n          postMessage({ type: 'close' })\n        });\n        socket.addEventListener('message', (msg) => {\n          if (msg.data instanceof ArrayBuffer) {\n            postMessage({ type: 'message', data: msg.data }, [msg.data]);\n          } else {\n            postMessage({ type: 'message', data: msg.data });\n          }\n        });\n        break;\n      };\n      case 'send': {\n        socket.send(e.data.data);\n        break;\n      }\n      case 'close': {\n        socket.close();\n        break;\n      }\n    }\n  }\n`;\nlet code = WorkerSource; // .toString();\n// code = code.substring(code.indexOf(\"{\")+1, code.lastIndexOf(\"}\"));\nconst blob = new Blob([code], {type: \"application/javascript\"});\n\nexport class WebSocketAsync extends EventTarget {\n  constructor(host: string) {\n    super();\n    this.worker.addEventListener('message', event => {\n      switch (event.data.type) {\n        case 'open': {\n          this.readyState = WebSocket.OPEN;\n          this.dispatchEvent(new Event('open'));\n          return;\n        }\n        case 'close': {\n          this.readyState = WebSocket.CLOSED;\n          this.dispatchEvent(new CloseEvent('close'));\n          return;\n        }\n        case 'message': {\n          this.dispatchEvent(new MessageEvent('message', { data: event.data.data }));\n          return;\n        }\n      }\n    });\n    this.worker.postMessage({ type: 'init', host });\n  }\n  readyState = WebSocket.CONNECTING;\n  set binaryType(value: WebSocket['binaryType']) {\n    if (value !== 'arraybuffer') {\n      throw new Error(`Only arraybuffer supported`);\n    }\n  }\n  worker = new Worker(URL.createObjectURL(blob));\n  send(data: string | ArrayBuffer) {\n    if (data instanceof ArrayBuffer) {\n      this.worker.postMessage({ type: 'send', data }, [data]);\n    } else {\n      this.worker.postMessage({ type: 'send', data });\n    }\n  }\n  close() {\n    this.worker.postMessage({ type: 'close' });\n  }\n}\nexport interface WebSocketAsync {\n  addEventListener<K extends keyof WebSocketEventMap>(type: K, listener: (this: WebSocket, ev: WebSocketEventMap[K]) => any, options?: boolean | AddEventListenerOptions): void;\n  addEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | AddEventListenerOptions): void;\n  removeEventListener<K extends keyof WebSocketEventMap>(type: K, listener: (this: WebSocket, ev: WebSocketEventMap[K]) => any, options?: boolean | EventListenerOptions): void;\n  removeEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | EventListenerOptions): void;\n}\n","import * as React from 'react';\nimport './index.css';\nimport { GlState } from '../GpuUtil/GlState';\nimport { GpuWorldState } from '../GpuWorld/State';\nimport { GpuWorldProgram } from '../GpuWorld';\nimport { WorldProgramContext } from '../Components/WorldCanvas';\nimport { Store, useStore, useStoreSelect } from '../Components/Store';\nimport { ItemsRow, Column, ItemsColumn } from '../Components/Layout';\nimport { FontAwesomeButton } from '../Components/Button';\nimport { ECSInspector } from '../Components/ECSInspector';\nimport { wait } from '../Util';\nimport { useWorldDataSelect, WorldStateContext } from '../GameComponents/WorldDataConsumer';\nimport { defaultRTSCameraConf, RTSCameraController } from '../SteamApp/WorldPage/RTSCamera';\nimport { ShaderDebugger } from '../Components/WorldCanvas/ShaderDebugger';\nimport { ArenaMinimaps } from '../SteamApp/WorldPage/ArenaMinimaps';\nimport { BattleScore, BattleScoreChangeFlash } from '../GameComponents/BattleScore';\nimport { RoundClock } from '../GameComponents/RoundClock';\nimport { DerkGymAPI } from './GymApi';\n\n\nexport class GymState {\n  worldState?: GpuWorldState;\n  status?: string = 'Initializing...';\n  newVersion?: string;\n}\nexport const GymStateContext = React.createContext(new Store(new GymState()));\nexport function useGymState<T>(map: (state: GymState) => T): T {\n  return useStore(GymStateContext, map);\n}\nexport function useGymStateSelect(...keys: Array<keyof GymState>): GymState {\n  return useStoreSelect(GymStateContext, ...keys);\n}\n\nfunction StatusBar() {\n  const { status } = useStoreSelect(GymStateContext, 'status');\n  return <div>{status}</div>\n}\n\nfunction GymUI() {\n  const [showECS, setShowECS] = React.useState(false);\n  const { newVersion, worldState } = useStoreSelect(GymStateContext, 'newVersion', 'worldState');\n  const { simulationPaused } = useWorldDataSelect('simulationPaused');\n  return <div className=\"GymUI\">\n    <Column>\n      <ItemsRow className=\"GymActionBar\">\n        <FontAwesomeButton\n          icon=\"play\"\n          title=\"Play\"\n          flat={true}\n          disabled={!simulationPaused}\n          onClick={() => worldState?.setData({ simulationPaused: false })}\n          />\n        <FontAwesomeButton\n          icon=\"pause\"\n          title=\"Pause\"\n          flat={true}\n          disabled={simulationPaused}\n          onClick={() => worldState?.setData({ simulationPaused: true })}\n          />\n        <FontAwesomeButton\n          icon=\"eye\"\n          title=\"ECS inspector\"\n          flat={true}\n          onClick={() => setShowECS(!showECS)}\n          />\n      </ItemsRow>\n      <StatusBar />\n      {newVersion && <div>New version available: {newVersion}</div>}\n    </Column>\n    <ArenaMinimaps />\n    <ItemsColumn className=\"GymUIBottom\">\n      <BattleScore />\n      <RoundClock />\n    </ItemsColumn>\n    {showECS && <ECSInspector />}\n    <BattleScoreChangeFlash />\n  </div>\n}\n\nexport function GymAppInner() {\n  const canvas = React.useRef<HTMLCanvasElement>(null);\n  const [worldProgram, setWorldProgram] = React.useState<GpuWorldProgram>();\n  const appState = React.useContext(GymStateContext);\n  const { worldState } = useGymStateSelect('worldState');\n  const [loaded, setLoaded] = React.useState(false);\n  React.useEffect(() => {\n    (async () => {\n      await wait(100);\n      if (canvas.current) {\n        const b = canvas.current.getBoundingClientRect();\n        canvas.current.width = b.width;\n        canvas.current.height = b.height;\n        const gl = canvas.current.getContext('webgl2', { desynchronized: true }) as any as WebGL2RenderingContext;\n        if (!gl) {\n          console.log('Failed to create WebGL2 context');\n          return;\n        }\n        const gls = new GlState(canvas.current, gl);\n        const program = new GpuWorldProgram(gls);\n\n        setWorldProgram(program);\n        (window as any).derk = new DerkGymAPI(program, appState);\n        setLoaded(true);\n      }\n    })();\n  }, [appState]);\n  return <WorldProgramContext.Provider value={worldProgram}>\n    <WorldStateContext.Provider value={worldState}>\n      <RTSCameraController conf={{...defaultRTSCameraConf(), fovy: (35 / 360) * Math.PI * 2 }} />\n      <div className=\"Gym\">\n        <canvas ref={canvas} />\n        <GymUI />\n        {loaded && <div className=\"GymLoaded\" />}\n      </div>\n      {(worldProgram?.gls.shaderCache.errors.length ?? 0) > 0 &&\n        <ShaderDebugger shaderErrors={worldProgram?.gls.shaderCache.errors ?? []} />}\n    </WorldStateContext.Provider>\n  </WorldProgramContext.Provider>;\n}\n\nexport default function GymApp() {\n  const [gymStateStore] = React.useState(new Store(new GymState()));\n  return <GymStateContext.Provider value={gymStateStore}>\n    <GymAppInner />\n  </GymStateContext.Provider>\n}\n","import uuid from 'uuid/v4';\nimport basex from 'base-x';\nimport { Vector3 } from './Math/Vector3';\nimport { Vector4 } from './Math/Vector4';\nimport color from 'color';\nimport * as _ from 'lodash';\nimport * as arbit from 'arbit';\nimport { mix } from './Math/Math';\nexport const base62 = basex('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');\n\nexport function assertNever(x: never): never {\n  throw new Error('Unexpected: ' + x);\n}\n\nexport function base62uuid() {\n  return base62.encode(uuid(null, new Buffer(16)));\n}\n\n// From: https://gist.github.com/hyamamoto/fd435505d29ebfa3d9716fd2be8d42f0\nexport function hashCode(s: string): number {\n  let h = 0;\n  for(let i = 0; i < s.length; i++) {\n    // tslint:disable-next-line:no-bitwise\n    h = Math.imul(31, h) + s.charCodeAt(i) | 0;\n  }\n\n  return h;\n}\n\nexport function intToRGBHex(i: number) {\n  // tslint:disable-next-line: no-bitwise\n  const c = (i & 0x00FFFFFF)\n      .toString(16)\n      .toUpperCase();\n\n  return \"00000\".substring(0, 6 - c.length) + c;\n}\nexport function stringToRGBHex(s: string) {\n  return '#' + intToRGBHex(hashCode(s));\n}\nexport function stringToHSL(string: string, saturation: number, light: number) {\n  return `hsl(${hashCode(string) % 360}, ${100*saturation}%, ${100*light}%)`;\n}\nexport function rgbFromStringHash(s: string) {\n  return rgbFromHex(stringToRGBHex(s));\n}\n\nexport function arrayReplaceIndex<T>(array: T[], index: number, value: T): T[] {\n  const a2 = [...array];\n  a2[index] = value;\n  return a2;\n}\nexport function arrayInsertIndex<T>(array: T[], index: number, value: T): T[] {\n  return [...array.slice(0, index), value, ...array.slice(index)];\n}\nexport function arrayRemoveIndex<T>(array: T[], index: number): T[] {\n  return [...array.slice(0, index), ...array.slice(index + 1)];\n}\nexport function arrayMove<T>(array: T[], fromIndex: number, toIndex: number): T[] {\n  const arr = array.slice();\n  const [el] = arr.splice(fromIndex, 1);\n  arr.splice(Math.max(toIndex, 0), 0, el);\n  return arr;\n}\nexport function objectDeleteKey<T extends object>(obj: T, key: keyof T): Partial<T> {\n  const o = {...obj as any};\n  delete o[key];\n  return o;\n}\n\n// Conservative object update, will return the same object if the updated values are the same\nexport function objectSetKeys<T extends object>(obj: T, update: Partial<T>): T {\n  let shouldUpdate = false;\n  for (const k of Object.keys(update)) {\n    if (obj[k] !== update[k]) {\n      shouldUpdate = true;\n    }\n  }\n  if (shouldUpdate) {\n    return {...obj, ...update};\n  } else {\n    return obj;\n  }\n}\n\nexport function objdiff(a: any, b: any) {\n  const d = {};\n  for (const k of [...Object.keys(a), ...Object.keys(b)]) {\n    if (a[k] !== b[k]) {\n      d[k] = { a: a[k], b: b[k] };\n    }\n  }\n  return d;\n}\n\nexport function formatNumberPrecision(value: number, precision = 2, sign = false): string {\n  if (value === 0 || isNaN(value) || !isFinite(value)) {\n    return '' + value;\n  }\n  const s = Math.sign(value);\n  value = Math.abs(value);\n  const l = Math.ceil(Math.log10(value));\n  const p = Math.pow(10, l - precision);\n  const v = s * Math.floor(value / p) * p;\n  return (v !== value ? '~' : '') + ((sign && v > 0) ? '+' : '') + v.toLocaleString('en-EN');\n}\n\nexport enum MassUnits {\n  kg = 'kg',\n  g = 'g',\n  mg = 'mg'\n}\nexport function unitFromMass(value: number): MassUnits {\n  return MassUnits.kg;\n  // if (value >= 1) {\n  //   return MassUnits.kg;\n  // } else if (value >= Math.pow(10, -3)) {\n  //   return MassUnits.g;\n  // } else {\n  //   return MassUnits.mg;\n  // }\n}\nexport function massToUnit(value: number, unit: MassUnits): number {\n  switch (unit) {\n    case MassUnits.kg:\n      return value;\n    case MassUnits.g:\n      return value * Math.pow(10, 3);\n    case MassUnits.mg:\n      return value * Math.pow(10, 6);\n  }\n}\nexport enum EnergyUnits {\n  MJ = 'MJ',\n  kJ = 'kJ',\n  J = 'J',\n}\nexport function unitFromEnergy(value: number): EnergyUnits {\n  return EnergyUnits.MJ;\n  // if (value >= Math.pow(10, 3)) {\n  //   return EnergyUnits.kJ;\n  // } else if (value >= 1) {\n  //   return EnergyUnits.J;\n  // } else if (value >= Math.pow(10, -3)) {\n  //   return EnergyUnits.mJ;\n  // } else {\n  //   return EnergyUnits.nJ;\n  // }\n}\nexport function energyToUnit(value: number, unit: EnergyUnits): number {\n  switch (unit) {\n    case EnergyUnits.MJ:\n      return value;\n    case EnergyUnits.kJ:\n      return value * Math.pow(10, 3);\n    case EnergyUnits.J:\n      return value * Math.pow(10, 6);\n  }\n}\nexport enum HealthUnits {\n  kHP = 'kHP',\n  HP = 'HP',\n  mHP = 'mHP',\n  nHP = 'nHP'\n}\nexport function unitFromHealth(value: number): HealthUnits {\n  return HealthUnits.HP;\n  // if (value >= Math.pow(10, 3)) {\n  //   return HealthUnits.kHP;\n  // } else if (value >= 1) {\n  //   return HealthUnits.HP;\n  // } else if (value >= Math.pow(10, -3)) {\n  //   return HealthUnits.mHP;\n  // } else {\n  //   return HealthUnits.nHP;\n  // }\n}\nexport function healthToUnit(value: number, unit: HealthUnits): number {\n  switch (unit) {\n    case HealthUnits.kHP:\n      return value * Math.pow(10, -3);\n    case HealthUnits.HP:\n      return value;\n    case HealthUnits.mHP:\n      return value * Math.pow(10, 3);\n    case HealthUnits.nHP:\n      return value * Math.pow(10, 6);\n  }\n}\n\nexport function endSlash(str: string): string {\n  if (!str.endsWith('/')) {\n    return str + '/';\n  } else {\n    return str;\n  }\n}\n\nexport function percentage(value: number, min: number, max: number, fractionDigits: number = 1): string {\n  return ((value - min) / (max - min) * 100).toFixed(fractionDigits) + '%';\n}\n\nexport const IndexToColor: RGB[] = [\n  { r: 255, g: 0, b: 0 },\n  { r: 0, g: 255, b: 0 },\n  { r: 0, g: 0, b: 255 },\n  { r: 255, g: 0, b: 255 },\n  { r: 255, g: 255, b: 0 },\n  { r: 0, g: 255, b: 255 },\n  { r: 0, g: 0, b: 0 },\n];\nexport function indexToColor(index: number): RGB {\n  if (index < IndexToColor.length) {\n    return IndexToColor[index];\n  } else {\n    return IndexToColor[IndexToColor.length - 1];\n  }\n}\n\nexport interface RGB {\n  r: number;\n  g: number;\n  b: number;\n}\nexport interface RGBA {\n  r: number;\n  g: number;\n  b: number;\n  a: number;\n}\nexport function rgba01ToVec401({ r, g, b, a }: RGBA): Vector4 {\n  return { x: r, y: g, z: b, w: a };\n}\nexport function rgba255ToVec401({ r, g, b, a }: RGBA): Vector4 {\n  return { x: r / 255, y: g / 255, z: b / 255, w: a };\n}\nexport function rgb255ToVec401({ r, g, b }: RGB): Vector4 {\n  return { x: r / 255, y: g / 255, z: b / 255, w: 1 };\n}\nexport function rgb01ToVec3({ r, g, b }: RGB): Vector3 {\n  return { x: r, y: g, z: b };\n}\nexport function rgb255ToVec3({ r, g, b }: RGB): Vector3 {\n  return { x: r / 255, y: g / 255, z: b / 255 };\n}\nexport function vec301ToRgba255({ x, y, z }: Vector3): RGBA {\n  return { r: x * 255, g: y * 255, b: z * 255, a: 1 };\n}\nexport function rgbToHex({ r, g, b }: RGB): string {\n  return color({ r, g, b }).toString();\n}\nexport function rgbFromHex(hex: string): RGB {\n  return color(hex).rgb().object() as any as RGB;\n}\nexport function randomRGB(): RGB {\n  return { r: Math.random() * 255, g: Math.random() * 255, b: Math.random() * 255 };\n}\nexport function mixRGB(a: RGB, b: RGB, p: number) {\n  return { r: mix(a.r, b.r, p), g: mix(a.g, b.g, p), b: mix(a.b, b.b, p) };\n}\nexport function mixRGBA(a: RGBA, b: RGBA, p: number) {\n  return { r: mix(a.r, b.r, p), g: mix(a.g, b.g, p), b: mix(a.b, b.b, p), a: mix(a.a, b.a, p) };\n}\n\nexport type EventListener<T extends Array<any>> = (...event: T) => void;\nexport class EventDispatcher<T extends Array<any>> {\n  listeners: Array<EventListener<T>> = [];\n  dispatch(...event: T) {\n    for (const listener of this.listeners) {\n      listener(...event);\n    }\n  }\n  attach(listener: EventListener<T>) {\n    this.listeners.push(listener);\n  }\n  detach(listener: EventListener<T>) {\n    this.listeners.splice(this.listeners.indexOf(listener), 1);\n  }\n  transform<T2 extends Array<any>>(map: (...event: T) => T2) {\n    const dispatcher = new EventDispatcher<T2>();\n    this.attach((...event) => dispatcher.dispatch(...map(...event)));\n    return dispatcher;\n  }\n}\n\nexport function visitJSON<T>(userdata: T, obj: any, visitor: (userdata: T, obj: any) => T): T {\n  userdata = visitor(userdata, obj);\n  if (Array.isArray(obj)) {\n    for (const v of obj) {\n      userdata = visitJSON(userdata, v, visitor);\n    }\n  } else if (_.isObject(obj)) {\n    for (const k of Object.keys(obj)) {\n      userdata = visitJSON(userdata, obj[k], visitor);\n    }\n  }\n  return userdata;\n}\n\nexport function mapJSON(obj: any, mapObj: (obj: any) => any): any {\n  if (Array.isArray(obj)) {\n    return obj.map(e => mapJSON(e, mapObj));\n  } else if (_.isObject(obj)) {\n    obj = mapObj(obj);\n    return Object.keys(obj).reduce((p, k) => ({...p, [k]: mapJSON(obj[k], mapObj)}), {});\n  } else {\n    return obj;\n  }\n}\n\nexport function keysOfEnum(EnumType: any): string[] {\n  return Object.keys(EnumType).filter(x => isNaN(parseInt(x, 10)))\n}\n\nexport function umap<T, R>(value: T | undefined, ok: (value: T) => R, undef?: () => R): R | undefined {\n  if (value) {\n    return ok(value);\n  } else {\n    return undef?.();\n  }\n}\n\nexport function removeProps<T extends {}>(obj: T, props: Array<keyof T>): T {\n  const res = {...(obj as any)};\n  for (const prop of props) {\n    delete res[prop];\n  }\n  return res;\n}\n\nexport class RandomSeedable {\n  constructor(seed?: string) {\n    this.generator = arbit(seed);\n  }\n  generator: any;\n  random(): number {\n    return this.generator();\n  }\n}\nexport class SeedGenerator {\n  cached: { [id: string]: number } = {};\n  get(id: string) {\n    if (this.cached[id] !== undefined) {\n      return this.cached[id];\n    } else {\n      return this.cached[id] = new RandomSeedable(id).random();\n    }\n  }\n}\n\nexport const Seeds = new SeedGenerator(); // Seeds from ids are always the same\n\n\nexport function wait(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport type Gradient<T> = Array<{ time: number, value: T }>;\nexport function getGradientValue<T>(gradient: Gradient<T>, time: number, mixer: (a: T, b: T, p: number) => T) {\n  for (let i=0; i < gradient.length - 1; i++) {\n    const left = gradient[i];\n    const right = gradient[i + 1];\n    if (left.time <= time && right.time >= time) {\n      const d = right.time - left.time;\n      const p = (time - left.time) / d;\n      return mixer(left.value, right.value, p);\n    }\n  }\n  return mixer(gradient[0].value, gradient[0].value, 0);\n  // throw new Error(`Time ${time} was outside of gradient: ${JSON.stringify(gradient)}`);\n}\n\n// export const RGBGradientTypedef: EditorTypedef = {\n//   metatype: 'list',\n//   itemType: {\n//     metatype: 'struct',\n//     properties: {\n//       time: { metatype: 'float' },\n//       value: { metatype: 'color' }\n//     }\n//   },\n//   newItem: () => ({ time: 0, value: { r: 0, g: 0, b: 0 } })\n// }\n\n\nexport function capitalizeFirstLetter(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\nexport function lowercaseFirstLetter(str: string): string {\n  return str.charAt(0).toLowerCase() + str.slice(1);\n}\n\nexport class Lazy<T> {\n  constructor(private get: () => T) {\n  }\n  private cached?: { value: T };\n  get value() {\n    if (this.cached === undefined) {\n      this.cached = { value: this.get() };\n    }\n    return this.cached.value;\n  }\n}\n\nexport function blobToUint8Array(blob: Blob) {\n  return new Promise<Uint8Array>((resolve) => {\n    const fileReader = new FileReader();\n    fileReader.onload = (event) => {\n      resolve(new Uint8Array(fileReader.result as ArrayBuffer));\n    };\n    fileReader.readAsArrayBuffer(blob);\n  });\n}\n\n// Slow but effective... Turns anything into JSON\nexport function declassify(obj: any) {\n  return JSON.parse(JSON.stringify(obj));\n}\n\nexport function nanToZero(value: number) {\n  if (Number.isNaN(value)) {\n    return 0;\n  } else {\n    return value;\n  }\n}\n\n\n// From: https://developer.mozilla.org/en-US/docs/Web/API/Window/navigator\nexport function getBrowser() {\n  if (navigator.userAgent.indexOf(\"Firefox\") > -1) {\n    return \"Firefox\";\n    // \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n  } else if (navigator.userAgent.indexOf(\"SamsungBrowser\") > -1) {\n    return \"SamsungInternet\";\n    // \"Mozilla/5.0 (Linux; Android 9; SAMSUNG SM-G955F Build/PPR1.180610.011) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/9.4 Chrome/67.0.3396.87 Mobile Safari/537.36\n  } else if (navigator.userAgent.indexOf(\"Opera\") > -1 || navigator.userAgent.indexOf(\"OPR\") > -1) {\n    return \"Opera\";\n    // \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36 OPR/57.0.3098.106\"\n  } else if (navigator.userAgent.indexOf(\"Trident\") > -1) {\n    return \"InternetExplorer\";\n    // \"Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; Zoom 3.6.0; wbx 1.0.0; rv:11.0) like Gecko\"\n  } else if (navigator.userAgent.indexOf(\"Edge\") > -1) {\n    return \"Edge\";\n    // \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299\"\n  } else if (navigator.userAgent.indexOf(\"Chrome\") > -1) {\n    return \"Chrome\";\n    // \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/66.0.3359.181 Chrome/66.0.3359.181 Safari/537.36\"\n  } else if (navigator.userAgent.indexOf(\"Safari\") > -1) {\n    return \"Safari\";\n    // \"Mozilla/5.0 (iPhone; CPU iPhone OS 11_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.0 Mobile/15E148 Safari/604.1 980x1306\"\n  } else {\n    return \"Unknown\";\n  }\n}\n\nexport function isMobile() {\n  var check = false;\n  // eslint-disable-next-line\n  (function(a){if(/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||(window as any).opera);\n  return check;\n}\n\nexport function isNullOrUndefined<T>(v: T | undefined | null): v is undefined | null {\n  return v === undefined || v === null;\n}\n\n// https://github.com/microsoft/TypeScript/issues/20707\nexport function notNullOrUndefined<T>(x: T | undefined | null): x is T {\n  return x !== undefined && x !== null;\n}\nexport function notFalsy<T>(x: T | undefined | null | '' | false): x is T {\n  return !!x;\n}\n\n// // https://stackoverflow.com/questions/21797299/convert-base64-string-to-arraybuffer/21797381\nexport function base64ToArrayBuffer(base64: string) {\n  var binary_string = window.atob(base64);\n  var len = binary_string.length;\n  var bytes = new Uint8Array(len);\n  for (var i = 0; i < len; i++) {\n      bytes[i] = binary_string.charCodeAt(i);\n  }\n  return bytes.buffer;\n}\n// https://stackoverflow.com/questions/9267899/arraybuffer-to-base64-encoded-string\nexport function arrayBufferToBase64(buffer: ArrayBuffer) {\n  var binary = '';\n  var bytes = new Uint8Array( buffer );\n  var len = bytes.byteLength;\n  for (var i = 0; i < len; i++) {\n      binary += String.fromCharCode( bytes[ i ] );\n  }\n  return window.btoa( binary );\n}\n\nexport class SimpleProfiler {\n  private stack: Array<{ title: string, start: number, childrenTime: number }> = [];\n  enter(title: string) {\n    this.stack.push({ start: window.performance.now(), title, childrenTime: 0 });\n    console.log(' ' + this.stack.map(s => s.title).join('/') + '...');\n  }\n  exit() {\n    const now = window.performance.now();\n    const title = this.stack.map(s => s.title).join('/');\n    const s = this.stack.pop()!;\n    const total = now - s.start;\n    if (this.stack.length > 0) {\n      this.stack[this.stack.length - 1].childrenTime += total;\n    }\n    let childrenPerc = '';\n    if (s.childrenTime !== 0) {\n      childrenPerc = `${Math.round(10000 * s.childrenTime / total) / 100}% in children`;\n    }\n    console.log(` ${title} ${this.msToString(total)}ms ${childrenPerc}`);\n  }\n  private msToString(ms: number) {\n    return (Math.round(ms * 100) / 100).toLocaleString('en');\n  }\n}","import * as Vector3 from './Vector3';\nimport * as Vector2 from './Vector2';\nimport { mat4 } from 'gl-matrix';\nimport { Vector4 } from './Vector4';\n\n// See http://stackoverflow.com/questions/4467539/javascript-modulo-not-behaving\nexport function mod(m: number, n: number) {\n  return ((m%n)+n)%n;\n}\n\nexport interface Size {\n  width: number;\n  height: number;\n}\nexport interface Size3 {\n  width: number;\n  height: number;\n  depth: number;\n}\nexport interface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nexport function vec2FromSize(size: Size): Vector2.Vector2 {\n  return { x: size.width, y: size.height };\n}\nexport function sizeFromVec2(vec: Vector2.Vector2): Size {\n  return { width: vec.x, height: vec.y };\n}\nexport function vec4FromRect(rect: Rect): Vector4 {\n  return { x: rect.x, y: rect.y, z: rect.width, w: rect.height };\n}\nexport function closestPow2(value: number) {\n  return Math.pow(2, Math.ceil(Math.log2(value)));\n}\nexport function sizeClosestPow2(size: Size) {\n  const s = closestPow2(Math.max(size.width, size.height));\n  return { width: s, height: s };\n}\n\nexport function indexToCell(size: Size, index: number) {\n  return index < 0 ? { x: -1, y: -1 } : { x: index % size.width, y: Math.floor(index / size.width) };\n}\nexport function cellToIndex(size: Size, cell: Vector2.Vector2);\nexport function cellToIndex(width: number, cell: Vector2.Vector2);\nexport function cellToIndex(sizeOrWidth: Size | number, cell: Vector2.Vector2) {\n  if (typeof sizeOrWidth === 'number') {\n    return cell.y * sizeOrWidth + cell.x;\n  } else {\n    return cell.y * sizeOrWidth.width + cell.x;\n  }\n}\n\nexport function clamp(value: number, min: number, max: number): number {\n  return Math.min(Math.max(value, min), max);\n}\nexport function mix(a: number, b: number, p: number) {\n  return a * (1 - p) + b * p;\n}\nexport function interpolate(x: number, x0: number, x1: number, y0: number, y1: number): number {\n  const p = (x - x0) / (x1 - x0);\n  return y0 + p * (y1 - y0);\n}\nexport function interpolateClamped(x: number, x0: number, x1: number, y0: number, y1: number): number {\n  const p = clamp((x - x0) / (x1 - x0), 0, 1);\n  return y0 + p * (y1 - y0);\n}\n\nexport function gaussianBlurKernel3x3(sigma: number): number[] {\n  const kernel: number[] = [];\n  const euler = 1 / (2 * Math.PI * sigma * sigma);\n  for (let y=-1; y <= 1; y++) {\n    for (let x=-1; x <= 1; x++) {\n      kernel.push(euler * Math.exp(- (x * x + y * y) / (2 * sigma * sigma)));\n    }\n  }\n  const sum = kernel.reduce((p, x) => p + x, 0);\n  return kernel.map(x => x / sum);\n}\n\n\n// From: https://gist.github.com/kchapelier/b1fd7e71f5378b871e3d6daa5ae193dc\n// based on https://warpycode.wordpress.com/2009/04/13/computing-a-1d-gaussian-kernel/\n// see http://www.stat.wisc.edu/~mchung/teaching/MIA/reading/diffusion.gaussian.kernel.pdf.pdf for more info\nconst sqr2pi = Math.sqrt(2 * Math.PI);\nexport function gaussianKernel1d (size: number, sigma: number) {\n  // ensure size is even and prepare variables\n  // tslint:disable-next-line:no-bitwise\n  const width = (size / 2) | 0;\n  const kernel = new Array(width * 2 + 1);\n  const norm = 1.0 / (sqr2pi * sigma);\n  const coefficient = 2 * sigma * sigma;\n  let total = 0;\n  let x;\n\n  // set values and increment total\n  for (x = -width; x <= width; x++) {\n      total += kernel[width + x] = norm * Math.exp(-x * x / coefficient);\n  }\n\n  // divide by total to make sure the sum of all the values is equal to 1\n  for (x = 0; x < kernel.length; x++) {\n      kernel[x] /= total;\n  }\n\n  return kernel;\n}\n\n// This gives you a sigma to plug into gaussianKernel1d (only when size=2).\n// For example, if I want 50% decay for each cell after 10 steps I do findGaussianKernel1dSize1Sigma(10, 0.5)\n// NOTE: assumes the gaussian blur is run in two passes!\nexport function findGaussianKernel1dSize1Sigma(steps: number, percentile: number) {\n  // Derivation:\n  // sqr2pi = sqrt(2 * PI);\n  // norm = 1.0 / (sqr2pi * sigma);\n  // coefficient = 2 * sigma * sigma;\n  // left = norm * e^(-1 / coefficient)\n  // centerPrel = norm;\n  // total = norm + left * 2;\n  // center = centerPrel / total;\n  // decayRate = center;\n  // percentile = 0.5;\n  // stepsUntil50perc = ln(percentile) / ln(decayRate);\n  // Plugged into a solver to get bellow:\n  steps *= 2; // Assume we run the gaussian blur in two passes\n  const a = 1 - Math.exp(Math.log(percentile) / steps);\n  const b = 2 * Math.exp(Math.log(percentile) / steps);\n  return Math.sqrt(-1/(2 * Math.log(a/b)));\n}\n\n\n\nexport function screenToWorld(invViewProjection: mat4, viewport: Rect, point: Vector3.Vector3) {\n  return clipSpaceToWorld(invViewProjection, {\n    x: 2.0 * (point.x - viewport.x) / viewport.width - 1.0,\n    y: -(2.0 * (point.y - viewport.y) / viewport.height - 1.0),\n    z: point.z\n  });\n}\nexport function clipSpaceToWorld(invViewProjection: mat4, point: Vector3.Vector3) {\n  return Vector3.transform(point, invViewProjection);\n}\nexport function worldToScreen(view: mat4, point: Vector3.Vector3) {\n  return Vector3.transform(point, view);\n}\n\ninterface Ray {\n  origin: Vector3.Vector3;\n  direction: Vector3.Vector3;\n}\nexport function screenRay(invViewProjection: mat4, viewport: Rect, screenPosition: Vector2.Vector2): Ray {\n  const p1 = screenToWorld(invViewProjection, viewport, {...screenPosition, z: 1 });\n  const p2 = screenToWorld(invViewProjection, viewport, {...screenPosition, z: -1 });\n  return {\n    origin: p2,\n    direction: Vector3.normalize(Vector3.sub(p1, p2))\n  }\n}\n\nexport interface Plane {\n  normal: Vector3.Vector3;\n  distance: number;\n}\n// From https://github.com/mattdesl/ray-plane-intersection/blob/master/index.js\nexport function rayPlaneIntersection(ray: Ray, plane: Plane): null | Vector3.Vector3 {\n  const denom = Vector3.dot(ray.direction, plane.normal);\n  if (denom  !== 0) {\n    const t = -(Vector3.dot(ray.origin, plane.normal) + plane.distance) / denom;\n    if (t < 0) {\n      return null;\n    }\n    return Vector3.add(ray.origin, Vector3.mul(ray.direction, t));\n  } else if (Vector3.dot(plane.normal, ray.origin) + plane.distance === 0) {\n    return ray.origin;\n  } else {\n    return null;\n  }\n}\n\nexport function pickingMatrix(screenSize: Size, screenPosition: Vector2.Vector2) {\n  const select = mat4.identity(mat4.create());\n  mat4.translate(select, select, [screenSize.width - screenPosition.x * 2, -(screenSize.height - screenPosition.y * 2), 0]);\n  mat4.scale(select, select, [screenSize.width, screenSize.height, 1]);\n  return select;\n}\n\nexport function volumeOfBox(box: Vector3.Vector3) {\n  return Vector3.boxVolume(box);\n}\n\nexport function surfaceAreaOfBox(box: Vector3.Vector3) {\n  return Vector3.boxSurfaceArea(box);\n}\n\nexport function mindimOfBox(box: Vector3.Vector3) {\n  return Math.min(Math.min(box.x, box.y), box.z);\n}\nexport function maxdimOfBox(box: Vector3.Vector3) {\n  return Math.max(Math.max(box.x, box.y), box.z);\n}\n\nexport function triangleWave(i: number, m = 1) {\n  return m - Math.abs(mod(i, 2 * m) - m);\n}\n\nexport function withoutNaNInf(v: number) {\n  if (Number.isNaN(v) || !Number.isFinite(v)) {\n    return 0;\n  } else {\n    return v;\n  }\n}\n\nexport function shortestAngleDist(a0: number, a1: number) {\n  const max = Math.PI * 2.0;\n  const da = mod((a1 - a0), max);\n  return mod(2.0 * da, max) - da;\n}\n\nexport function angleLerp(a0: number, a1: number, t: number) {\n  return a0 + shortestAngleDist(a0, a1) * t;\n}\n\nexport function fract(value: number) {\n  return value - Math.floor(value);\n}\n\nexport function snoise2d(p: Vector2.Vector2): number {\n  throw new Error('Not implemented yet');\n}\n\n// This is not exactly the same as \"normal\" exponential decay (https://en.wikipedia.org/wiki/Exponential_decay)\n// because the time steps are discrete.\nexport function discreteExponentialDecayHalftime(decayRate: number, percentile: number) {\n  return Math.log(percentile) / Math.log(1 - decayRate);\n}\n\nexport function floatBitsToUint(f: number) {\n  var buf = new ArrayBuffer(4);\n  (new Float32Array(buf))[0] = f;\n  return (new Uint32Array(buf))[0];\n}\n\nexport function uintBitsToFloat(f: number) {\n  var buf = new ArrayBuffer(4);\n  (new Uint32Array(buf))[0] = f;\n  return (new Uint32Array(buf))[0];\n}\n\n\nexport function bitCheckedUInt32(value: number, bitIndex: number) {\n  return !!((value & ((1 << bitIndex) >>> 0)) >>> 0);\n}\n\nexport function flipBitUInt32(value: number, bitIndex: number) {\n  return (value ^ ((1 << bitIndex) >>> 0)) >>> 0;\n}\n\nexport function softmax(values: Float32Array | number[]) {\n  const res: number[] = [];\n  let sum = 0;\n  for (let i=0; i < values.length; i++) {\n    const v = Math.exp(values[i]);\n    sum += v;\n    res.push(v);\n  }\n  return res.map(v => v / sum);\n}\n\nexport function sampleSoftmax(p: number, ...values: number[]) {\n  const s = softmax(values);\n  let cummulative = 0;\n  for (let i=0; i < values.length; i++) {\n    cummulative += s[i];\n    if (cummulative < p) {\n      return i;\n    }\n  }\n  return 0;\n}\n\n// From: https://stackoverflow.com/questions/25582882/javascript-math-random-normal-distribution-gaussian-bell-curve\n// Random number from a gausssian distribution, mean=0, variance=1\n// Standard Normal variate using Box-Muller transform.\nexport function randomBoxMuller() {\n  let u = 0, v = 0;\n  while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)\n  while(v === 0) v = Math.random();\n  return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );\n}","import { RandomSeedable } from \"../Util\";\nimport { vec3, mat4, quat } from 'gl-matrix';\nimport * as Math2 from './Math';\nimport { EditorTypedef } from \"../Components/Editors/EditorTypedefs\";\nimport { SphericalCoordinate } from \"./SphericalCoordinate\";\nimport * as Vector2 from \"./Vector2\";\n\nexport interface Vector3 {\n  x: number;\n  y: number;\n  z: number;\n}\nexport const Vector3Typedef: EditorTypedef = {\n  metatype: 'struct',\n  properties: {\n    x: { metatype: 'float' },\n    y: { metatype: 'float' },\n    z: { metatype: 'float' },\n  }\n}\n\n\nexport function create(x: number, y: number, z: number): Vector3;\nexport function create(v: Vector2.Vector2, z: number): Vector3;\nexport function create(v: number | Vector3): Vector3;\nexport function create(...args: any[]): Vector3 {\n  if (args.length === 1) {\n    if (typeof args[0] === 'number') {\n      return { x: args[0], y: args[0], z: args[0] };\n    } else {\n      return {...args[0]};\n    }\n  } else if (args.length === 2) {\n    return { ...args[0], z: args[1] };\n  } else {\n    return { x: args[0], y: args[1], z: args[2] };\n  }\n}\n\nexport function xy(v: Vector3): Vector2.Vector2 {\n  return { x: v.x, y: v.y };\n}\n\nexport function zero(): Vector3 {\n  return { x: 0, y: 0, z: 0 };\n}\n\nexport function random(rand: RandomSeedable): Vector3 {\n  return { x: rand.random(), y: rand.random(), z: rand.random() };\n}\n\nexport function fromSphericalCoordinates(theta: number, phi: number, radius: number): Vector3;\nexport function fromSphericalCoordinates({ theta, phi, radius }: SphericalCoordinate): Vector3;\nexport function fromSphericalCoordinates(...args: any[]): Vector3 {\n  if (typeof args[0] === 'object') {\n    return fromSphericalCoordinates(args[0].theta, args[0].phi, args[0].radius);\n  } else {\n    const theta = args[0];\n    const phi = args[1];\n    const radius = args[2];\n    return {\n      x: Math.sin(theta) * Math.cos(phi) * radius,\n      y: Math.sin(theta) * Math.sin(phi) * radius,\n      z: Math.cos(theta) * radius\n    };\n  }\n}\n\nexport function toSphericalCoordinates({ x, y, z }: Vector3): SphericalCoordinate {\n  const radius = Math.sqrt(x*x + y*y + z*z);\n  const theta = Math.acos(z / radius);\n  const phi = Math.atan2(y, x);\n  return {\n    radius,\n    theta,\n    phi\n  };\n}\n\nexport function length2(vec: Vector3): number {\n  return vec.x * vec.x + vec.y * vec.y + vec.z * vec.z;\n}\n\nexport function length(vec: Vector3): number {\n  return Math.sqrt(length2(vec));\n}\nexport function distance(a: Vector3, b: Vector3): number {\n  return length(sub(a, b));\n}\n\nexport function normalize(vec: Vector3): Vector3 {\n  const l = length(vec);\n  return { x: vec.x / l, y: vec.y / l, z: vec.z / l };\n}\n\nexport function invert(vec: Vector3): Vector3 {\n  return { x: -vec.x, y: -vec.y, z: -vec.z };\n}\n\nexport function add(a: Vector3, b: Vector3 | number): Vector3 {\n  if (typeof b === 'number') {\n    return { x: a.x + b, y: a.y + b, z: a.z + b };\n  } else {\n    return { x: a.x + b.x, y: a.y + b.y, z: a.z + b.z };\n  }\n}\n\nexport function sub(a: Vector3, b: Vector3): Vector3 {\n  return { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z };\n}\n\nexport function abs(a: Vector3): Vector3 {\n  return { x: Math.abs(a.x), y: Math.abs(a.y), z: Math.abs(a.z) };\n}\n\nexport function fract(a: Vector3): Vector3 {\n  return { x: Math2.fract(a.x), y: Math2.fract(a.y), z: Math2.fract(a.z) };\n}\n\nexport function mul(a: Vector3, b: number | Vector3): Vector3 {\n  if (typeof b === 'number') {\n    return { x: a.x * b, y: a.y * b, z: a.z * b };\n  } else {\n    return { x: a.x * b.x, y: a.y * b.y, z: a.z * b.z };\n  }\n}\nexport function div(vec: Vector3, f: number | Vector3): Vector3 {\n  if (typeof f === 'number') {\n    return mul(vec, 1 / f);\n  } else {\n    return { x: vec.x / f.x, y: vec.y / f.y, z: vec.z / f.z };\n  }\n}\n\nexport function floor(vec: Vector3): Vector3 {\n  return { x: Math.floor(vec.x), y: Math.floor(vec.y), z: Math.floor(vec.z) };\n}\n\nexport function toGlVec3({ x, y, z }: Vector3): vec3 {\n  return vec3.fromValues(x, y, z);\n}\nexport function fromGlVec3(vec: vec3): Vector3 {\n  return { x: vec[0], y: vec[1], z: vec[2] };\n}\n\nexport function transform(vec: Vector3, mat: mat4): Vector3 {\n  return fromGlVec3(vec3.transformMat4(vec3.create(), toGlVec3(vec), mat));\n}\nexport function transformQuat(vec: Vector3, q: quat): Vector3 {\n  return fromGlVec3(vec3.transformQuat(vec3.create(), toGlVec3(vec), q));\n}\n\nexport function dot(a: Vector3, b: Vector3) {\n  return a.x * b.x + a.y * b.y + a.z * b.z;\n}\nexport function cross(a: Vector3, b: Vector3): Vector3 {\n  return { x: a.y * b.z - a.z * b.y, y: a.z * b.x - a.x * b.z, z: a.x * b.y - a.y * b.x };\n}\n\nexport function clamp({ x, y, z }: Vector3, min: number, max: number): Vector3 {\n  return {\n    x: Math2.clamp(x, min, max),\n    y: Math2.clamp(y, min, max),\n    z: Math2.clamp(z, min, max)\n  };\n}\n\nexport function mix(a: Vector3, b: Vector3, p: number | Vector3): Vector3 {\n  if (typeof p === 'number') {\n    return {\n      x: Math2.mix(a.x, b.x, p),\n      y: Math2.mix(a.y, b.y, p),\n      z: Math2.mix(a.z, b.z, p),\n    }\n  } else {\n    return {\n      x: Math2.mix(a.x, b.x, p.x),\n      y: Math2.mix(a.y, b.y, p.y),\n      z: Math2.mix(a.z, b.z, p.z),\n    }\n  }\n}\n\nexport function interpolate(x: number, x0: number, x1: number, y0: Vector3, y1: Vector3): Vector3;\nexport function interpolate(x: Vector3, x0: number, x1: number, y0: number, y1: number): Vector3;\nexport function interpolate(x: Vector3, x0: Vector3, x1: Vector3, y0: Vector3, y1: Vector3): Vector3;\nexport function interpolate(x: any, x0: any, x1: any, y0: any, y1: any): Vector3 {\n  if (typeof x === 'number') {\n    const p = (x - x0) / (x1 - x0);\n    return mix(y0, y1, p);\n  } else {\n    if (typeof x0 === 'number') {\n      return {\n        x: Math2.interpolate(x.x, x0, x1, y0, y1),\n        y: Math2.interpolate(x.y, x0, x1, y0, y1),\n        z: Math2.interpolate(x.z, x0, x1, y0, y1),\n      };\n    } else {\n      const p = div(sub(x, x0), sub(x1, x0));\n      return mix(y0, y1, p);\n    }\n  }\n}\n\nexport function interpolateClamped(x: number, x0: number, x1: number, y0: Vector3, y1: Vector3): Vector3;\nexport function interpolateClamped(x: Vector3, x0: Vector3, x1: Vector3, y0: Vector3, y1: Vector3): Vector3;\nexport function interpolateClamped(x: any, x0: any, x1: any, y0: Vector3, y1: Vector3): Vector3 {\n  if (typeof x === 'number') {\n    const p = Math2.clamp((x - x0) / (x1 - x0), 0, 1);\n    return mix(y0, y1, p);\n  } else {\n    const p = clamp(div(sub(x, x0), sub(x1, x0)), 0, 1);\n    return mix(y0, y1, p);\n  }\n}\n\nexport function isNaNorInf({ x, y, z }: Vector3): boolean {\n  return isNaN(x) || isNaN(y) || isNaN(z) || !isFinite(x) || !isFinite(y) || !isFinite(z);\n}\n\nexport function isEqual(a: Vector3, b: Vector3): boolean {\n  return a.x === b.x && a.y === b.y && a.z === b.z;\n}\n\nexport function boxVolume(box: Vector3) {\n  return box.x * box.y * box.z;\n}\n\nexport function boxSurfaceArea(box: Vector3) {\n  return 2 * box.x * box.y + 2 * box.y * box.z + 2 * box.z * box.x;\n}\n\nexport function triangleWave(vec: Vector3) {\n  return {\n    x: Math2.triangleWave(vec.x),\n    y: Math2.triangleWave(vec.y),\n    z: Math2.triangleWave(vec.z),\n  }\n}"],"sourceRoot":""}